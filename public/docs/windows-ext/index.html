<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>Windows EXT – C65mael</title>
  <meta name="description" content="保护模式 保护模式概述 ‍保护模式分为段机制和页机制。
理解：想象一下你家的电脑就像一个大厨房，里面有很多小帮手在做不同的事情，比如煮汤、炒菜等等。保护模式就是为了保证这个大厨房的秩序和安全。首先，保护模式就像是给每个小帮手配了一套专属的工具，他们不能随便用别人的工具，也不能乱碰别人的食材。这样做的好处是，即使其中一个小帮手犯错了，也不会影响到其他小帮手(防止一个进程访问或修改另一个进程的内存数据)。其次，保护模式给了每个小帮手一个身份证，分成两类：一类是高级厨师，一类是普通厨师。高级厨师有更多的权限，可以做更多的事情，比如烧开水等。而普通厨师的权限就少一些，不能做一些危险的事情。这样可以防止有人乱来，比如一个不懂规矩的小帮手想烧开水，但是他只是个普通厨师，就不能执行这个操作(内核模式具有更高的特权级别，可以执行更多的操作，而用户模式受到更多的限制)。再来，保护模式还给了每个小帮手一个梦幻厨房，虽然实际上只有一个大厨房，但是每个小帮手都觉得自己有一个属于自己的梦幻厨房。这样就不会出现争抢厨房的情况，大家都可以安心做自己的事情(操作系统可以为每个进程提供虚拟内存，使得每个进程都认为自己拥有连续的内存空间)。最后，保护模式还让这些小帮手轮流工作，每个人都有自己的时间段做事情，不会出现一个人霸占厨房不肯给别人机会的情况，这样大家都有机会工作，效率也更高(操作系统可以同时运行多个进程，并实现进程之间的时间片轮转调度，使得多个程序可以并发执行)。
段寄存器结构 段寄存器一共有CS SS DS ES FS GS LDTR TR 共8个。
当我们用汇编读写某一个地址时：
mov dword ptr ds:[0x123456],eax 我们真正读写的地址是：
ds.base&#43;0x123456 段寄存器结构体如下：" /><link rel="canonical" href="http://localhost:1313/docs/windows-ext/" itemprop="url" />

<meta property="og:title" content="Windows EXT" />
<meta property="og:description" content="保护模式
    保护模式概述
    ‍保护模式分为段机制和页机制。
理解：想象一下你家的电脑就像一个大厨房，里面有很多小帮手在做不同的事情，比如煮汤、炒菜等等。保护模式就是为了保证这个大厨房的秩序和安全。首先，保护模式就像是给每个小帮手配了一套专属的工具，他们不能随便用别人的工具，也不能乱碰别人的食材。这样做的好处是，即使其中一个小帮手犯错了，也不会影响到其他小帮手(防止一个进程访问或修改另一个进程的内存数据)。其次，保护模式给了每个小帮手一个身份证，分成两类：一类是高级厨师，一类是普通厨师。高级厨师有更多的权限，可以做更多的事情，比如烧开水等。而普通厨师的权限就少一些，不能做一些危险的事情。这样可以防止有人乱来，比如一个不懂规矩的小帮手想烧开水，但是他只是个普通厨师，就不能执行这个操作(内核模式具有更高的特权级别，可以执行更多的操作，而用户模式受到更多的限制)。再来，保护模式还给了每个小帮手一个梦幻厨房，虽然实际上只有一个大厨房，但是每个小帮手都觉得自己有一个属于自己的梦幻厨房。这样就不会出现争抢厨房的情况，大家都可以安心做自己的事情(操作系统可以为每个进程提供虚拟内存，使得每个进程都认为自己拥有连续的内存空间)。最后，保护模式还让这些小帮手轮流工作，每个人都有自己的时间段做事情，不会出现一个人霸占厨房不肯给别人机会的情况，这样大家都有机会工作，效率也更高(操作系统可以同时运行多个进程，并实现进程之间的时间片轮转调度，使得多个程序可以并发执行)。
段寄存器结构
    段寄存器一共有CS SS DS ES FS GS LDTR TR 共8个。
当我们用汇编读写某一个地址时：


mov dword ptr ds:[0x123456],eax
  
    
    
  


我们真正读写的地址是：


ds.base&#43;0x123456
  
    
    
  


段寄存器结构体如下：" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/docs/windows-ext/" /><meta property="article:section" content="docs" />



  <meta itemprop="name" content="Windows EXT">
  <meta itemprop="description" content="保护模式 保护模式概述 ‍保护模式分为段机制和页机制。
理解：想象一下你家的电脑就像一个大厨房，里面有很多小帮手在做不同的事情，比如煮汤、炒菜等等。保护模式就是为了保证这个大厨房的秩序和安全。首先，保护模式就像是给每个小帮手配了一套专属的工具，他们不能随便用别人的工具，也不能乱碰别人的食材。这样做的好处是，即使其中一个小帮手犯错了，也不会影响到其他小帮手(防止一个进程访问或修改另一个进程的内存数据)。其次，保护模式给了每个小帮手一个身份证，分成两类：一类是高级厨师，一类是普通厨师。高级厨师有更多的权限，可以做更多的事情，比如烧开水等。而普通厨师的权限就少一些，不能做一些危险的事情。这样可以防止有人乱来，比如一个不懂规矩的小帮手想烧开水，但是他只是个普通厨师，就不能执行这个操作(内核模式具有更高的特权级别，可以执行更多的操作，而用户模式受到更多的限制)。再来，保护模式还给了每个小帮手一个梦幻厨房，虽然实际上只有一个大厨房，但是每个小帮手都觉得自己有一个属于自己的梦幻厨房。这样就不会出现争抢厨房的情况，大家都可以安心做自己的事情(操作系统可以为每个进程提供虚拟内存，使得每个进程都认为自己拥有连续的内存空间)。最后，保护模式还让这些小帮手轮流工作，每个人都有自己的时间段做事情，不会出现一个人霸占厨房不肯给别人机会的情况，这样大家都有机会工作，效率也更高(操作系统可以同时运行多个进程，并实现进程之间的时间片轮转调度，使得多个程序可以并发执行)。
段寄存器结构 段寄存器一共有CS SS DS ES FS GS LDTR TR 共8个。
当我们用汇编读写某一个地址时：
mov dword ptr ds:[0x123456],eax 我们真正读写的地址是：
ds.base&#43;0x123456 段寄存器结构体如下：">
  <meta itemprop="wordCount" content="7680">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Windows EXT">
  <meta name="twitter:description" content="保护模式 保护模式概述 ‍保护模式分为段机制和页机制。
理解：想象一下你家的电脑就像一个大厨房，里面有很多小帮手在做不同的事情，比如煮汤、炒菜等等。保护模式就是为了保证这个大厨房的秩序和安全。首先，保护模式就像是给每个小帮手配了一套专属的工具，他们不能随便用别人的工具，也不能乱碰别人的食材。这样做的好处是，即使其中一个小帮手犯错了，也不会影响到其他小帮手(防止一个进程访问或修改另一个进程的内存数据)。其次，保护模式给了每个小帮手一个身份证，分成两类：一类是高级厨师，一类是普通厨师。高级厨师有更多的权限，可以做更多的事情，比如烧开水等。而普通厨师的权限就少一些，不能做一些危险的事情。这样可以防止有人乱来，比如一个不懂规矩的小帮手想烧开水，但是他只是个普通厨师，就不能执行这个操作(内核模式具有更高的特权级别，可以执行更多的操作，而用户模式受到更多的限制)。再来，保护模式还给了每个小帮手一个梦幻厨房，虽然实际上只有一个大厨房，但是每个小帮手都觉得自己有一个属于自己的梦幻厨房。这样就不会出现争抢厨房的情况，大家都可以安心做自己的事情(操作系统可以为每个进程提供虚拟内存，使得每个进程都认为自己拥有连续的内存空间)。最后，保护模式还让这些小帮手轮流工作，每个人都有自己的时间段做事情，不会出现一个人霸占厨房不肯给别人机会的情况，这样大家都有机会工作，效率也更高(操作系统可以同时运行多个进程，并实现进程之间的时间片轮转调度，使得多个程序可以并发执行)。
段寄存器结构 段寄存器一共有CS SS DS ES FS GS LDTR TR 共8个。
当我们用汇编读写某一个地址时：
mov dword ptr ds:[0x123456],eax 我们真正读写的地址是：
ds.base&#43;0x123456 段寄存器结构体如下：">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <img class="hx-mr-2 hx-block dark:hx-hidden" src="/images/logo.svg" alt="C65mael" height="20" width="20" />
        <img class="hx-mr-2 hx-hidden dark:hx-block" src="/images/logo.svg" alt="C65mael" height="20" width="20" />
        <span class="hx-mr-2 hx-font-extrabold hx-inline hx-select-none" title="C65mael">C65mael</span>
    </a><a
            title="文档"
            href="/docs"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-font-medium"
          >
            <span class="hx-text-center">文档</span>
          </a><a
            title="博客"
            href="/blog"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">博客</span>
          </a><a
            title="关于"
            href="/about"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">关于</span>
          </a><div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://github.com/imfing/hextra" title="GitHub"><svg height=24 fill="currentColor" viewBox="3 3 18 18">
  <path d="M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z"></path>
</svg>
<span class="hx-sr-only">GitHub</span>
          </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class='hx-mx-auto hx-flex hx-max-w-screen-xl'>
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-sticky">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about/"
    
  >About
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/"
    
  >Blog
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/"
    
  >Docs
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a><div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows-bas/"
    
  >Windows BAS
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows-beg/"
    
  >Windows BEG
    </a>
              
            </li><li class="hx-flex hx-flex-col open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/docs/windows-ext/"
    
  >Windows EXT
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              ></a>
            </li>
          </ul>
  
              
            </li></ul>
      </div></li>
    </ul>

    <ul class="hx-flex hx-flex-col hx-gap-1 max-md:hx-hidden">
        
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows-bas/"
    
  >Windows BAS
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows-beg/"
    
  >Windows BEG
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/docs/windows-ext/"
    
  >Windows EXT
    </a></li>
        
      </ul>
    </div>
  
  
    <div class="  hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-grow hx-flex-col"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div></div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f">保护模式
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f%e6%a6%82%e8%bf%b0">保护模式概述
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e5%af%84%e5%ad%98%e5%99%a8%e7%bb%93%e6%9e%84">段寄存器结构
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%8e%e6%ae%b5%e9%80%89%e6%8b%a9%e5%ad%90">段描述符与段选择子
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e7%9a%84%e5%b1%9e%e6%80%a7">段描述符的属性
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%9d%83%e9%99%90%e6%a3%80%e6%9f%a5">段权限检查
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%a3%e7%a0%81%e7%9a%84%e8%b7%a8%e6%ae%b5%e8%b7%b3%e8%bd%ac%e6%b5%81%e7%a8%8b">代码的跨段跳转流程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%95%bf%e8%b0%83%e7%94%a8%e4%b8%8e%e7%9f%ad%e8%b0%83%e7%94%a8">长调用与短调用
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%b0%83%e7%94%a8%e9%97%a8">调用门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%ad%e6%96%ad%e9%97%a8">中断门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%99%b7%e9%98%b1%e9%97%a8">陷阱门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%bb%e5%8a%a1%e6%ae%b5">任务段
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%bb%e5%8a%a1%e9%97%a8">任务门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#10-10-12%e5%88%86%e9%a1%b5">10-10-12分页
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pde%e4%b8%8epte">PDE与PTE
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pde%e4%b8%8epte%e5%b1%9e%e6%80%a7">PDE与PTE属性
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%a1%b5%e7%9b%ae%e5%bd%95%e8%a1%a8%e5%9f%ba%e5%9d%80">页目录表基址
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%a1%b5%e8%a1%a8%e5%9f%ba%e5%9d%80">页表基址
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#2-9-9-12%e5%88%86%e9%a1%b5pae%e5%88%86%e9%a1%b5">2-9-9-12分页（PAE分页）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#tlb">TLB
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%ad%e6%96%ad%e4%b8%8e%e5%bc%82%e5%b8%b8">中断与异常
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%8e%a7%e5%88%b6%e5%af%84%e5%ad%98%e5%99%a8">控制寄存器
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pwt-%e4%b8%8e-pcd">PWT 与 PCD
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%a9%b1%e5%8a%a8">驱动
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%8e%af%e5%a2%83">环境
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%86%85%e6%a0%b8%e7%bc%96%e7%a8%8b%e5%9f%ba%e7%a1%80">内核编程基础
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4%e4%b8%8e%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97">内核空间与内核模块
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#0%e7%8e%af%e4%b8%8e3%e7%8e%af%e9%80%9a%e4%bf%a1%e5%b8%b8%e8%a7%84%e6%96%b9%e5%bc%8f">0环与3环通信（常规方式）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%a9%b1%e5%8a%a8%e5%b8%b8%e7%94%a8%e5%8a%a0%e8%bd%bd%e6%96%b9%e5%bc%8f">驱动常用加载方式
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%86%99%e6%8b%b7%e8%b4%9d">写拷贝
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8">系统调用
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%bf%9b0%e7%8e%af%e5%89%8d">进0环前
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%bf%9b0%e7%8e%af%e5%90%8e%e4%bf%9d%e5%ad%98%e7%8e%b0%e5%9c%ba">进0环后（保存现场）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#systemservicetable%e7%b3%bb%e7%bb%9f%e6%9c%8d%e5%8a%a1%e8%a1%a8">SystemServiceTable（系统服务表）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#ssdt">SSDT
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b">进程与线程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%bf%9b%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93">进程结构体
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ba%bf%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93">线程结构体
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#kpcr">KPCR
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ad%89%e5%be%85%e7%ba%bf%e7%a8%8b_%e8%b0%83%e5%ba%a6%e7%ba%bf%e7%a8%8b">等待线程_调度线程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%bb%e5%8a%a8%e5%88%87%e6%8d%a2">主动切换
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%97%b6%e9%92%9f%e4%b8%ad%e6%96%ad%e5%88%87%e6%8d%a2">时钟中断切换
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%97%b6%e9%97%b4%e7%89%87%e7%ae%a1%e7%90%86">时间片管理
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2tss">线程切换TSS
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2fs">线程切换FS
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ba%bf%e7%a8%8b%e4%bc%98%e5%85%88%e7%ba%a7">线程优先级
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%bf%9b%e7%a8%8b%e6%8c%82%e9%9d%a0">进程挂靠
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%b7%a8%e8%bf%9b%e7%a8%8b%e8%af%bb%e5%86%99%e5%86%85%e5%ad%98">跨进程读写内存
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%8f%a5%e6%9f%84%e8%a1%a8">句柄表
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8">全局句柄表
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%a4%9a%e6%a0%b8%e5%90%8c%e6%ad%a5">多核同步
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%b4%e7%95%8c%e5%8c%ba">临界区
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%87%aa%e6%97%8b%e9%94%81">自旋锁
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ba%bf%e7%a8%8b%e7%ad%89%e5%be%85%e4%b8%8e%e5%94%a4%e9%86%92">线程等待与唤醒
        </a>
      </li></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400">
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        
  <div class="hx-mt-1.5 hx-flex hx-items-center hx-gap-1 hx-overflow-hidden hx-text-sm hx-text-gray-500 dark:hx-text-gray-400 contrast-more:hx-text-current">
        <div class="hx-whitespace-nowrap hx-transition-colors hx-min-w-[24px] hx-overflow-hidden hx-text-ellipsis hover:hx-text-gray-900 dark:hover:hx-text-gray-100">
          <a href="/docs/">Docs</a>
        </div><svg class="hx-w-3.5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg><div class="hx-whitespace-nowrap hx-transition-colors hx-font-medium hx-text-gray-700 contrast-more:hx-font-bold contrast-more:hx-text-current dark:hx-text-gray-100 contrast-more:dark:hx-text-current">Windows EXT</div>
  </div>

        <div class="content">
          <h1>Windows EXT</h1>
          <h3>保护模式<span class="hx-absolute -hx-mt-20" id="保护模式"></span>
    <a href="#%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>保护模式概述<span class="hx-absolute -hx-mt-20" id="保护模式概述"></span>
    <a href="#%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f%e6%a6%82%e8%bf%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>‍保护模式分为段机制和页机制。</p>
<p>理解：想象一下你家的电脑就像一个大厨房，里面有很多小帮手在做不同的事情，比如煮汤、炒菜等等。保护模式就是为了保证这个大厨房的秩序和安全。首先，保护模式就像是给每个小帮手配了一套专属的工具，他们不能随便用别人的工具，也不能乱碰别人的食材。这样做的好处是，即使其中一个小帮手犯错了，也不会影响到其他小帮手(<strong>防止一个进程访问或修改另一个进程的内存数据</strong>)。其次，保护模式给了每个小帮手一个身份证，分成两类：一类是高级厨师，一类是普通厨师。高级厨师有更多的权限，可以做更多的事情，比如烧开水等。而普通厨师的权限就少一些，不能做一些危险的事情。这样可以防止有人乱来，比如一个不懂规矩的小帮手想烧开水，但是他只是个普通厨师，就不能执行这个操作(<strong>内核模式具有更高的特权级别，可以执行更多的操作，而用户模式受到更多的限制</strong>)。再来，保护模式还给了每个小帮手一个梦幻厨房，虽然实际上只有一个大厨房，但是每个小帮手都觉得自己有一个属于自己的梦幻厨房。这样就不会出现争抢厨房的情况，大家都可以安心做自己的事情(<strong>操作系统可以为每个进程提供虚拟内存，使得每个进程都认为自己拥有连续的内存空间</strong>)。最后，保护模式还让这些小帮手轮流工作，每个人都有自己的时间段做事情，不会出现一个人霸占厨房不肯给别人机会的情况，这样大家都有机会工作，效率也更高(<strong>操作系统可以同时运行多个进程，并实现进程之间的时间片轮转调度，使得多个程序可以并发执行</strong>)。</p>
<h6>段寄存器结构<span class="hx-absolute -hx-mt-20" id="段寄存器结构"></span>
    <a href="#%e6%ae%b5%e5%af%84%e5%ad%98%e5%99%a8%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>段寄存器一共有<code>CS SS DS ES FS GS LDTR TR</code> 共8个。</p>
<p>当我们用汇编读写某一个地址时：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>mov dword ptr ds:[0x123456],eax</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>我们真正读写的地址是：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>ds.base&#43;0x123456</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>段寄存器结构体如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> Segment
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  WORD Selecter;  <span style="color:#75715e">//16位段选择子           可见部分.  使用OD 或者X64dbg看段寄存器只会显示16位的段选择子可见部分.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  WORD Attribute; <span style="color:#75715e">//16位表示的段属性, 表示了当前段寄存器是可读的可写的还是可执行的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DWORD Base;     <span style="color:#75715e">//32位表示的基址,表示段从哪里开始
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  DWORD limit;    <span style="color:#75715e">//32位表示,表示的是基址的长度. base + limit 可以确定一个段的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>结构如下图：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>[---------------------------------&gt; 可见部分 &lt;-----------------------------------------] [--&gt;不可见部分&lt;---]
&#43;--------------------------------------------------------------------------------------------------------&#43;
|								|								|				|				|
|								|								|				|				|
|								|								|				|				|
|								|								|				|				|
&#43;--------------------------------------------------------------------------------------------------------&#43;
				^								^						^				^
				|								|						|				|
				|								|						|				|
			32位Base							32位limit				16位Attribute	16位Selecter</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>段寄存器属性如下：</p>
<table>
  <thead>
      <tr>
          <th>寄存器名称</th>
          <th>段选择子(Select)</th>
          <th>段属性(Attributes)</th>
          <th>段基址(Base)</th>
          <th>段长(Limit)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>ES(附加扩展段)</td>
          <td><strong>0x0023</strong></td>
          <td>可读,可写</td>
          <td>0x0000000</td>
          <td>0xFFFFFFFF</td>
      </tr>
      <tr>
          <td>CS(代码段)</td>
          <td><strong>0x001B</strong></td>
          <td>可读,可执行</td>
          <td>0x00000000</td>
          <td>0xFFFFFFFF</td>
      </tr>
      <tr>
          <td>SS(堆栈段)</td>
          <td><strong>0x0023</strong></td>
          <td>可读,可写</td>
          <td>0x00000000</td>
          <td>0xFFFFFFFF</td>
      </tr>
      <tr>
          <td>DS(数据段)</td>
          <td><strong>0x0023</strong></td>
          <td>可读,可写</td>
          <td>0x00000000</td>
          <td>0xFFFFFFFF</td>
      </tr>
      <tr>
          <td>FS(分段机制)</td>
          <td><strong>0x003B</strong></td>
          <td>可读,可写</td>
          <td><strong>0x7FFDF000</strong></td>
          <td>0xFFF</td>
      </tr>
      <tr>
          <td>GS(额，64位系统好像使用吧)</td>
          <td>未使用</td>
          <td>未使用</td>
          <td>未使用</td>
          <td>未使用</td>
      </tr>
  </tbody>
</table>
<h6>段描述符与段选择子<span class="hx-absolute -hx-mt-20" id="段描述符与段选择子"></span>
    <a href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%8e%e6%ae%b5%e9%80%89%e6%8b%a9%e5%ad%90" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>GDT(全局描述符表) LDT(局部描述符表)</p>
<p>当我们执行类似<code>MOV DS,AX</code>指令时，CPU会查表，根据AX的值来决定查找GDT还是LDT，查找表的什么位置，查出多少数据。(AX就是可见的<code>Selector段选择子</code>的内容)</p>
<p>GDTR(48位寄存器，表中存放了GDT表 的起始地址(32位)，外加存放GDT表的大小(16位))</p>
</li>
<li>
<p>段描述符(8字节一组，64位)结构（记住结构）</p>
<p><img src="https://c65mael.github.io/myassets/xuanzazi.png" alt="image" loading="lazy" /></p>
<ul>
<li><strong>AVL</strong>: 该位是用户位，可以被用户自由使用</li>
<li><strong>BASE</strong>: 段基址，由上图中的两部分(BASE 31-24 和 BASE 23-0(图错了))组成</li>
<li><strong>D/B</strong>: 该位为 0 表示这是一个 16 位的段，1 表示这是一个 32 位段</li>
<li><strong>DPL</strong>：段权限</li>
<li><strong>G</strong>：LIMIT的单位，该位 0 表示单位是字节(0xfffff)，1表示单位是 4KB(0xffffffff)</li>
<li><strong>LIMIT</strong>: 段的界限，单位由 G 位决定。数值上（经过单位换算后的值）等于段的长度（字节）- 1。</li>
<li><strong>P</strong>: 段存在位，该位为 0 表示该段不存在，为 1 表示存在。</li>
<li><strong>S</strong>: 该位为 1 表示这是一个数据段或者代码段。为 0 表示这是一个系统段（比如调用门，中断门等）</li>
<li><strong>TYPE</strong>: 根据 S 位的结果，再次对段类型进行细分。</li>
</ul>
</li>
<li>
<p>段选择子（2字节，16位）</p>
<p>段选择子是一个16位的段描述符，该描述符指向了定义该段的段描述符。</p>
<p><img src="https://c65mael.github.io/myassets/xz.png" alt="image" loading="lazy" /></p>
<p><code>说明：</code>
<code>MOV DS，AX</code>指令时，
假如AX=1B，即001B，拆分为0000 0000 0001 1011</p>
<p>去掉TI和RPL值，后剩下Index值为11，即3，则查GDT表索引值为3 （GDT表中索引值从0开始，索引值为0处的段描述符为0）的段描述符。</p>
</li>
<li>
<p>加载段描述符至段寄存器</p>
<p>除了MOV指令,我们还可以使用LES、LSS、LDS、LFS、 LGS指令修改寄存器。(L是Load的意思)</p>
<p>CS不能通过上述的指令进行修改，CS为代码段，CS的改变会导致EIP的改变，要改CS，必须要保证CS与EIP一起改。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">6</span>]; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">asm</span>{
</span></span><span style="display:flex;"><span>    les ecx,fword ptr ds:[buffer] <span style="color:#75715e">//高2个字节给es,低四个字节给ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//es也就是上面的段选择子，用00补全成4位，然后拆分……
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>注意: RPL&lt;=DPL(在数值上)	(以什么样的权限去访问段)</p>
</li>
</ol>
<h6>段描述符的属性<span class="hx-absolute -hx-mt-20" id="段描述符的属性"></span>
    <a href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e7%9a%84%e5%b1%9e%e6%80%a7" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p><strong>P</strong>: 段存在位，该位为 0 表示该段不存在，为 1 表示存在。(<strong>CPU后面就不检查别的位了</strong>)</p>
<p><strong>LIMIT</strong>: 段的界限，单位由 G 位决定。数值上（经过单位换算后的值）等于段的长度（字节）- 1。</p>
<p><img src="https://c65mael.github.io/myassets/xuanzazi.png" alt="image" loading="lazy" /></p>
<ul>
<li>
<p><strong>Attribute</strong> //16位 对应段描述符（高四字节） 第8位~第23位</p>
</li>
<li>
<p><strong>Base</strong> //32位 （高四字节）第24位 ~ 第31位 + （高四字节）第0位 ~ 第7位+（低四字节）第16位 ~ 第31位</p>
</li>
<li>
<p><strong>Limit</strong> //32位 （高四字节）第16位 ~ 第19位 +（低四字节）第0位 ~ 第15位 总共20位 最大值也就是FFFFF，此时分情况
1.如果G位为0，那么Limit单位是字节，此时高位填0,即最大值也就是0x000fffff
2.如果G位为1，那么Limit单位是4KB，4x1024=4096,4096代表有多少个，但是地址计算都是从0开始的，那么需要减1，即上限为4096-1=4095,刚好转为0xfff，如果此时Limit界限为1的话，那么此时为0x1FFF，则最大可以为0xffffffff</p>
</li>
<li>
<p>不理解：如果粒度 <code>G=0，LIMIT= 0x3ff</code>，这意味着该段的大小是 <code>0x3ff+1=0x400</code> 字节。如果 <code>G=1</code>，那意味着该段的大小是<code>(0x3ff+1)*4KB=0x400000</code>字节，所以换算后的 <code>limit = 0x400000-1=0x003fffff</code>.</p>
<p>再举个例子。<code>LIMIT=0xfffff, G=1</code>,则该段的大小是 <code>(0xfffff+1)*4KB=0x100000*0x1000=0x100000000</code>字节，所以换算后的 <code>limit=0x100000000-1=0xffffffff</code></p>
</li>
<li>
<p><code>狗多半零安，乐，破地皮两树，停</code></p>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>总结：
如果 G = 0，把段描述符中的 20 bit LIMIT取出来，比如 0x003ff，然后在前面补 0 至32bit，即 limit = 0x000003ff
如果 G = 1，把段描述符中的 20 bit LIMIT取出来，比如 0x003ff，然后在后面补 f 至 32bit, 即 LIMIT = 0x003fffff</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>S</strong>: 该位为 1 表示这是一个<strong>数据段</strong>或者<strong>代码段</strong>。为 0 表示这是一个系统段（比如调用门，中断门等）</p>
<p>额我们先找<strong>数据段</strong>或者<strong>代码段</strong>，s位的不同会导致TYPE域发生变化。这张图是TYPE域满足什么条件下是数据段或代码段：</p>
<p><img src="https://c65mael.github.io/myassets/type.png" alt="image" loading="lazy" /></p>
<ol>
<li>因为DPL的值只可能是全1或全0，所以16~12位如果是数据段或代码段的话只能为f(1111)或9(1001)。<code>那么在段描述符中找第五位，如果是f或9就是数据段或代码段</code>。</li>
<li>因为TYPE域的第11位只可能是1或0，而且全为1是代码段；全为0是数据段。<code>那么第六位大于8就是代码段，小于8就是数据段</code>。</li>
</ol>
<p>来看数据段的标志位：</p>
<ul>
<li>E：如果为1，表示向下扩展(右图)；E=0，表示向上扩展(左图)，windows只使用向上扩展，也就是E为0</li>
<li>W：如果为1，代表该数据段描述符是可写的</li>
<li>A：如果为1，代表该数据段描述符已经被访问过了</li>
</ul>
<p><img src="https://c65mael.github.io/myassets/ewei.png" alt="image" loading="lazy" /></p>
<p>来看代码段的标志位：</p>
<ul>
<li>C：如果为1，表示一致代码段；如果为0，表示非一致代码段</li>
<li>R：如果为1，表示可读；如果为0，表示不可读</li>
<li>A：如果为1，表示段曾被访问；如果为0，表示段未被访问</li>
</ul>
<p>系统段描述符(就是s为0的情况)如下图：</p>
<p><img src="https://c65mael.github.io/myassets/xtmsf.png" alt="image" loading="lazy" /></p>
<p>DB位的影响大致如下：</p>
<p>情况一：对CS段的影响</p>
<ul>
<li>
<p>D=1 采用32位寻址方式</p>
</li>
<li>
<p>D =0 采用16位寻址方式</p>
<p>前缀67 改变寻址方式</p>
</li>
</ul>
<p>情况二：对SS段的影响(这个隐式大概就是间接操作栈的指令，不像mov指令这样直接控制esp或ebp)</p>
<ul>
<li>D=1 隐式堆栈访问指令(如: PUSH POP CALL)使用32位堆栈指针寄存器ESP</li>
<li>D=0 隐式堆栈访问指令(如:PUSH POP CALL)使用16位堆栈指针寄存器SP</li>
</ul>
<p>情况三：向下拓展的数据段</p>
<ul>
<li>D=1段上线为4GB</li>
<li>D=0段上线为64KB</li>
</ul>
<p><img src="https://c65mael.github.io/myassets/db.png" alt="image" loading="lazy" /></p>
<h6>段权限检查<span class="hx-absolute -hx-mt-20" id="段权限检查"></span>
    <a href="#%e6%ae%b5%e6%9d%83%e9%99%90%e6%a3%80%e6%9f%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>cpu的分级：</p>
<p><img src="https://c65mael.github.io/myassets/cupqx.png" alt="image" loading="lazy" /></p>
<p>如何查看程序处于几环：</p>
<ul>
<li><code>CPL</code>(<code>Current Privilege Level</code>)：当前特权级(是几程序就在几环)</li>
<li><code>CS</code>和<code>SS</code>中存储的段选择子后2位.(二者相同的都是<code>CPL</code>)</li>
</ul>
<p><code>DPL</code>(<code>Descriptor Privilege Level</code>)描述符特权级别：</p>
<ul>
<li>
<p>DPL存储在段描述符中，规定了访问该段所需要的特权级别是什么。</p>
</li>
<li>
<p>通俗的理解：如果你想访问我，那么你应该具备什么特权。</p>
</li>
<li>
<p>举例说明：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>mov DS,AX</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>如果AX指向的段<code>DPL=0</code>但当前程序的<code>CPL=3</code>这行指令是不会成功的!</p>
</li>
</ul>
<p>RPL(Request Privilege Level)请求特权级别举例说明：</p>
<ul>
<li>
<p>通俗的理解：当前段选择子的权限</p>
</li>
<li>
<p>比较<code>mov ax,0008</code>与<code>mov ax,000B</code>并且之后均执行<code>mov ds,ax</code>的区别</p>
<p>(区别是8的二进制为<code>1000</code>，B的二进制为<code>1011</code>，无别就在于最后的两位所代表的RPL不同)</p>
<p>将段描述指向的是同一个段描述符，但RPL是不一样的.</p>
</li>
</ul>
<p><strong>数据段的权限检查参考如下代码:</strong></p>
<ul>
<li>
<p>比如当前程序处于0环,也就是说CPL=0</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>mov ax,000B		//1011也就是RPL = 3 
mov ds,ax		//ax指向的段描述符的DPL = 0</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<p>数据段的权限检查：</p>
<p><code>CPL &lt;= DPL</code> 并且 <code>RPL &lt;= DPL</code> (数值E8比较)</p>
<p>注意：代码段和系统段描述符中的检查方式并不一样。</p>
<p>总结一下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>CPL -&gt; CPU当前的权限级别
DPL -&gt; 如果你想访问我,你应该具备什么样的权限
RPL -&gt; 用什么权限去访问一个段(比如高权限可以用低权限访问)
为啥要有RPL?
我们本可以用“读 写”的权限去打开一个文件，但为了避免出错，有些时候我们使用“只读”的权限去打开。就是限制程序权限的使用，尽量规避提权漏洞(吧)。</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h6>代码的跨段跳转流程<span class="hx-absolute -hx-mt-20" id="代码的跨段跳转流程"></span>
    <a href="#%e4%bb%a3%e7%a0%81%e7%9a%84%e8%b7%a8%e6%ae%b5%e8%b7%b3%e8%bd%ac%e6%b5%81%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>本质就是修改<code>cs</code>寄存器</p>
<p>代码间的跳转(段间跳转 非调用门之类的)</p>
<ul>
<li>
<p>段间跳转有<code>2</code>种情况,即要跳转的段是一致代码段还是非一致代码段。</p>
</li>
<li>
<p>同时修改<code>CS</code>与<code>EIP</code>的指令<code>JMP FAR / CALL FAR / RETF / INT / IRETED</code></p>
<p>注意：只改变<code>EIP</code>的指令<code>JMP / CALL / JCC / RET</code></p>
</li>
</ul>
<p>远跳(<code>jmp far</code>)的执行流程</p>
<p><code>jmp 0x20:0x004183D</code></p>
<ol>
<li>
<p>将前面的段寄存器拆成段选择子：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0x20对应二进制形式 0000 0000 0010 0000
RPL=00
TI=0
Index=4</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>因为<code>TI=0</code>，所以要查<code>GDT</code>表，找对应<code>Index</code>的段描述符</p>
<p>这四种情况可以跳转：代码段、调用门、TSS任务段、任务门</p>
</li>
<li>
<p>权限检查</p>
<p>如果是非一致代码段，要求：<code>CPL == DPL</code> 并且 <code>RPL &lt;= DPL</code></p>
<p>如果是一致代码段，要求：<code>CPL&gt;= DPL</code></p>
<p>解释一下：假设我可以用不同的权力去控制别人，我自己的权力和我所使用的权力会有区别。(权限越高越小)</p>
<ul>
<li><code>CPL == DPL</code>：我可以控制与自己的权力一样的人。</li>
<li><code>RPL &lt;= DPL</code>：我所使用大的权力，自然的可以控制权力比我小的人。</li>
<li><code>CPL &gt;= DPL</code>：我自己的权力小于别人的权力。</li>
</ul>
<p><strong>总结</strong>：</p>
<p>对于一致代码段:也就是共享的段</p>
<ul>
<li>特权级高的程序不允许访问特权级低的数据:核心态不允许访问用户态的数据</li>
<li>特权级低的程序可以访问到特权级高的数据,但特权级不会改变：用户态还是用户态</li>
</ul>
<p>对于普通代码段:也就是非一致代码段</p>
<ul>
<li>只允许同级访问</li>
<li>绝对禁止不同级别的访问:核心态不是用户态,用户态也不是核心态.</li>
</ul>
<p><strong>直接对代码段进行JMP或者CALL的操作，无论目标是一致代码段还是非一致代码段, CPL都不会发生改变。如果要提升CPL的权限，只能通过调用门。</strong></p>
</li>
<li>
<p>加载段描述符</p>
<p>通过上面的权限检查后，CPU会将段描述符加载到CS段寄存器中。</p>
</li>
<li>
<p>代码执行</p>
<p>CPU将 <code>CS.Base + Offset</code> (就是冒号后面的值)的值写入EIP 然后执行CS:EIP处的代码，段间跳转结束。</p>
</li>
</ol>
<p>总结：</p>
<ol>
<li>为了对数据进行保护,普通代码段是禁止不同级别进行访问的。用户态的代码不能访问内核的数据,同样,内核态的代码也不能访问用户态的数据。</li>
<li>如果想提供一些通用的功能，而且这些功能并不会破坏内核数据，那么可以选择一致代码段,这样低级别的程序可以在不提升CPL权限等级的情况下即可以访问。</li>
<li>如果想访问普通代码段,只有通过&rsquo;调用门&rsquo;等提示CPL权限,才能访问。</li>
</ol>
<h6>长调用与短调用<span class="hx-absolute -hx-mt-20" id="长调用与短调用"></span>
    <a href="#%e9%95%bf%e8%b0%83%e7%94%a8%e4%b8%8e%e7%9f%ad%e8%b0%83%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>短调用：</p>
<ul>
<li>指令格式：call 立即数 / 寄存器 / 内存</li>
<li>把call当前地址的下一个地址入栈，然后将eip跳到call后面跟的地址。执行到ret后返回(到入栈的地址)</li>
<li>发生改变的寄存器: esp eip</li>
</ul>
<p>长调用(跨段不提权)：</p>
<ul>
<li>
<p>指令格式: CALL CS:EIP (EIP是废弃的)</p>
</li>
<li>
<p>先入栈调用者的CS段选择子，再把当前地址的下一个地址入栈(返回地址)</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">执行前</th>
          <th style="text-align: center"></th>
          <th style="text-align: center">执行后</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center">返回地址</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center">调用者的CS段选择子</td>
      </tr>
      <tr>
          <td style="text-align: center">xxxxxxxx</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">xxxxxxxx</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>发生改变的寄存器: ESP EIP CS</p>
</li>
</ul>
<p>长调用(跨段提权)：</p>
<ul>
<li>
<p>指令格式: CALL CS:EIP (EIP是废弃的)</p>
</li>
<li>
<p>执行前的栈是3环的栈，执行后是0环的栈(CPL)，所以是在0环的栈里面压入的一系列参数。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">执行前(在3环)</th>
          <th style="text-align: center"></th>
          <th style="text-align: center">执行后(在0环)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center">返回地址</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center">调用者CS</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center">调用者ESP</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center">调用者SS</td>
      </tr>
      <tr>
          <td style="text-align: center">xxxxxxxx</td>
          <td style="text-align: center"></td>
          <td style="text-align: center">xxxxxxxx</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
<p>总结：</p>
<ol>
<li>跨段调用时，一旦有权限切换，就会切换堆栈。</li>
<li>CS的权限一旦改变，SS的权限也要随着改变，CS与SS的等级必须一样。</li>
<li><code>JMP FAR</code>只能跳转到同级非一致代码段，但<code>CALL FAR</code>可以通过调用门提权，提升CPL的权限。</li>
</ol>
<h6>调用门<span class="hx-absolute -hx-mt-20" id="调用门"></span>
    <a href="#%e8%b0%83%e7%94%a8%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>门描述符是系统段描述符的一类。所以门描述符<code>S=0</code>，<code>TYPE=1100</code></p>
<p><img src="https://c65mael.github.io/myassets/dym.png" alt="image" loading="lazy" /></p>
<p>所以如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0000 0000 0000 0000 -&gt; Offset
1110 -&gt; P、DPL、S
1100 -&gt; Type
0000 0000 -&gt; 0 - 7位
0x0000EC00

低32位段选择子可以设为0x0008（对应0环代码段）、0x001B（对应3环代码段）
0x00080000

加上偏移就可以使用了</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>调用门执行流程</p>
<ul>
<li>
<p>指令格式：CALL CS:EIP(EIP是废弃的)</p>
</li>
<li>
<p>执行步骤：</p>
<ol>
<li>根据CS的值查GDT表，找到对应的段描述符这个描述符是一个调用门。</li>
<li>在调用门描述符中存储另一个代码段的选择子。</li>
<li>选择子指向的段 <code>段.Base+ 偏移地址</code> 就是真正要执行的地址。、</li>
</ol>
</li>
<li>
<p>结构说明：</p>
<table>
  <thead>
      <tr>
          <th>字段</th>
          <th>内容</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>offset in segment</td>
          <td>要跳转的函数的地址，或者是要跳转的地址  (两段组成了32位的地址，前高位后低位)</td>
      </tr>
      <tr>
          <td>segment selector</td>
          <td>段选择子，要变成的段选择子（提权的关键）</td>
      </tr>
      <tr>
          <td>Param Count</td>
          <td>函数参数个数</td>
      </tr>
      <tr>
          <td>高位5-7</td>
          <td>固定的三个0</td>
      </tr>
      <tr>
          <td>Type</td>
          <td>系统段只能是1100（10进制的12）</td>
      </tr>
      <tr>
          <td>高12地址</td>
          <td>就是段描述符的S字段，就系统调用的必须是0</td>
      </tr>
      <tr>
          <td>DPL</td>
          <td>肯定赋值为3呀，这样ring3才能。</td>
      </tr>
      <tr>
          <td>p</td>
          <td>和段描述符一样表示该段是否有效，当P为0时无效，1时有效。</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
<p>调用门总结：</p>
<ol>
<li>当通过门，权限不变的时候，只会PUSH两个值: CS返回地址新的CS的值由调用门决定。</li>
<li>当通过门，权限改变的时候，会PUSH四个值：<code>SS ESP CS 返回地址</code> 新的CS的值由调用门决定 新的SS和ESP由TSS提供。</li>
<li>通过门调用时，要执行哪行代码有调用门决定，但使用<code>RETF</code>返回时，由堆栈中压人的值决定，这就是说，进门时只能按指定路线走，出门时可以翻墙（只要改变堆栈里面的值就可以想去哪去哪）。</li>
<li>可不可以再建个门出去呢？也就是用Call 当然可以了 <code>前门进 后门出</code>。</li>
</ol>
<h6>中断门<span class="hx-absolute -hx-mt-20" id="中断门"></span>
    <a href="#%e4%b8%ad%e6%96%ad%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>Windows没有使用调用门，但是使用了中断门：&lt;1&gt; 系统调用	&lt;2&gt; 调试</p>
</li>
<li>
<p>调用门会去查GDT表，中断门却回去查IDT表(中断描述符表)。</p>
<p><strong>IDT即中断描述符表，同GDT一样，IDT也是由一系列描述符组成的，每个描述符占8个字节。但要注意的是，IDT表中的第一个元素不是NULL。</strong></p>
<ul>
<li>
<p>IDT表可以包含3种门描述符:	任务门描述符	中断门描述符	陷阱门描述符</p>
</li>
<li>
<p>指令格式：<code>INT N (N为中断门索引号)</code></p>
</li>
<li>
<p>中断门如下：（图中的<code>D</code>表示是否为<code>32位</code>，如果是则为<code>1</code>）</p>
<p><img src="https://c65mael.github.io/myassets/zdm.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p>与调用门类似会产生如下的情况：</p>
<ol>
<li>在没有权限切换时，会向堆栈顺次压入<code>EFLAG</code>、<code>CS</code>和<code>EIP</code>；如果有权限切换，会向堆栈顺次压入<code>SS</code>、<code>ESP</code>、<code>EFLAG</code>、<code>CS</code>和<code>EIP</code>。</li>
<li><code>CPU</code>会索引到<code>IDT</code>表。后面的<code>N</code>表示查<code>IDT表</code>项的下标。对比调用门，中断门没有了<code>RPL</code>，故<code>CPU</code>只会校验<code>CPL</code>。</li>
<li>在中断门中,不能通过<code>RETF</code>返回，而应该通过<code>IRET</code>/<code>IRETD</code>指令返回。</li>
</ol>
</li>
</ul>
</li>
</ul>
<h6>陷阱门<span class="hx-absolute -hx-mt-20" id="陷阱门"></span>
    <a href="#%e9%99%b7%e9%98%b1%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>陷阱门的结构和中断门结构几乎一样，只是Type域不同而已（图中的<code>D</code>表示是否为<code>32位</code>，如果是则为<code>1</code>）</p>
<p><img src="https://c65mael.github.io/myassets/xjm.png" alt="image" loading="lazy" /></p>
<p>与中断门的区别，中断门执行时，将<code>IF位</code>清零,但陷阱门不会。</p>
<p>解释：<strong>如果IF位为零，则不再接收可屏蔽中断。</strong></p>
<ol>
<li><strong>可屏蔽中断</strong>就像是你房间里的门铃，你可以选择要不要打开门去接待访客。</li>
<li><strong>不可屏蔽中断</strong>就像是火警响了，这是一个紧急情况，你不能选择不管它。</li>
</ol>
<h6>任务段<span class="hx-absolute -hx-mt-20" id="任务段"></span>
    <a href="#%e4%bb%bb%e5%8a%a1%e6%ae%b5" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>我们回顾一下之前所学内容，在调用门、中断门与陷阱门中，一旦出现权限切换，那么就会有堆栈的切换。而且，由于<code>CS</code>的<code>CPL</code>发生改变，也导致了<code>SS</code>也必须要切换。切换时，会有新的<code>ESP</code>和<code>SS</code>从哪里来的呢？那就是任务状态段提供的。任务状态段简称任务段，英文缩写为<code>TSS</code>，<code>Task-state segment</code>。</p>
<p>  <code>TSS</code>是一块内存，大小为<code>104</code>字节，内存结构如下图所示：</p>
<p><img src="https://c65mael.github.io/myassets/rwd.png" alt="image" loading="lazy" /></p>
<p>TSS 的作用</p>
<p>  <code>Intel</code>的设计<code>TSS</code>目的，用官方的话说就是实现所谓的任务切换。<code>CPU</code>的任务在操作系统的方面就是线程。任务一切换，执行需要的环境就变了，即所有寄存器里面的值，需要保存供下一次切换到该任务的时候再换回去重新执行。
  说到底，<strong><code>TSS</code>的意义就在于可以同时换掉一堆寄存器</strong>。本质上和所谓的任务切换没啥根本联系。而操作系统嫌弃<code>Intel</code>的设计过于麻烦，自己实现了所谓的任务切换，即线程切换。(应该有点像srop的感觉吧)</p>
<p>CPU 如何找到 TSS</p>
<p>  <code>TSS</code>是一个内存块，并不在<code>CPU</code>中，那么它是怎样找到正确的<code>TSS</code>呢？那就是之前提到的<code>TR</code>段寄存器，而<code>TR</code>寄存器里面的值是从段描述符里面加载的，也就是从<code>GDT</code>表里面的<code>TSS</code>段描述符加载的。<code>CPU</code>通过<code>TR</code>寄存器索引<code>TSS</code>是示意图如下图所示：</p>
<p><img src="https://c65mael.github.io/myassets/tr.png" alt="image" loading="lazy" /></p>
<p>TSS段描述符</p>
<p>  <code>TSS段描述符</code>的结构和普通的段描述符没啥区别，就是系统段描述符，如果<code>Type</code>为9(B=0 <code>1001</code>)，则这个<code>TSS段描述符</code>没有加载到<code>TR</code>寄存器中，如果<code>Type</code>为B(B=1 <code>1011</code>)，就是加载了，如下图所示：</p>
<p><img src="https://c65mael.github.io/myassets/tss.png" alt="image" loading="lazy" /></p>
<p>TR寄存器读写</p>
<ol>
<li>加载TSS
<ul>
<li>指令：<code>LTR</code></li>
<li>说明：用<code>LTR</code>指令去装载，仅仅是改变<code>TR</code>寄存器的值（96位），并没有真正改变<code>TSS</code>。<code>LTR</code>指令只能在系统层使用，加载后<code>TSS</code>段描述符会状态位会发生改变。</li>
</ul>
</li>
<li>读取TR寄存器
<ul>
<li>指令：<code>STR</code></li>
<li>说明：如果用<code>STR</code>去读的话，只读了<code>TR</code>的16位，即选择子。</li>
</ul>
</li>
</ol>
<p>修改TR寄存器途径</p>
<ol>
<li>在0环可以通过LTR指令去修改TR寄存器。</li>
<li>在3环可以通过CALL FAR或者JMP FAR指令来修改。用JMP去访问一个任务段的时候，如果是TSS段描述符，先修改TR寄存器，在用TR.Base指向的TSS中的值修改当前的寄存器。</li>
</ol>
<h6>任务门<span class="hx-absolute -hx-mt-20" id="任务门"></span>
    <a href="#%e4%bb%bb%e5%8a%a1%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>IDT 中断描述符表:</p>
<p>IDT表可以包含3种门描述符：任务门描述符	中断门描述符	陷阱门描述符</p>
<p>任务门结构:</p>
<p><img src="https://c65mael.github.io/myassets/rwm.png" alt="image" loading="lazy" /></p>
<p>执行过程：</p>
<ol>
<li>通过<code>INT N</code>的指令进行触发任务门</li>
<li>查<code>IDT</code>表，找到任务门描述符</li>
<li>通过任务门描述符，查<code>GDT</code>表，找到<code>TSS</code>段描述符</li>
<li>使用<code>TSS</code>段中的值修改<code>TR</code>寄存器</li>
<li><code>IRETD</code>返回</li>
</ol>
<h6>10-10-12分页<span class="hx-absolute -hx-mt-20" id="10-10-12分页"></span>
    <a href="#10-10-12%e5%88%86%e9%a1%b5" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>虚拟地址空间是什么？</p>
<p>每个进程都有一个“假想的”内存空间，大小是4GB。这并不是说每个进程都真的占用了4GB的内存，而是操作系统为每个进程提供了一个这样的“地址地图”。可以把它看作是一个巨大的图书馆目录，这个目录告诉进程可以在这些地址上“存放”数据。</p>
</li>
<li>
<p>这些虚拟地址就像地图上的标记，它们并不直接对应计算机硬件中的实际内存位置。实际的物理内存地址是计算机真正用来存储数据的地方。可以把物理地址想象成图书馆中的实际书架位置。</p>
</li>
</ul>
<p>一个进程都有4GB的虚拟地址空间，它们并不是真正的地址，而是个索引。它通过某种方式进行转换，从而指向真正的物理地址：</p>
<p><img src="https://c65mael.github.io/myassets/nc.png" alt="image" loading="lazy" /></p>
<p>如下指令：</p>
<p><code>MOV eax,dword ptr ds:[0x12345678]</code></p>
<p>其中，<code>0x12345678</code> 是有效地址，<code>ds.Base + 0x12345678</code>是线性地址</p>
<p>解释：这个<code>线性地址</code>实际上是不存在的，在执行时<code>CPU</code>会将<code>线性地址</code>转化为<code>物理地址</code></p>
<p><img src="https://c65mael.github.io/myassets/nclz.png" alt="image" loading="lazy" /></p>
<p>10-10-12拆分：假设我们有一个32位的虚拟地址。10-10-12拆分是把这个32位的地址分成三个部分，前10位中间10位和后12位</p>
<p><code>CPU</code>得到线性地址之后经过<code>10-10-12</code>拆分成三份去找物理地址，<code>CPU</code>会去找<code>CR3</code>寄存器，<code>CR3</code>寄存器里面存的地址指向一个<code>4kb</code>的页这就是它的第一级，拆分的第一个<code>10</code>位决定了在第一级中的什么位置；这个位置里面的值又指向一个<code>4kb</code>的页这就是它的第二级，拆分的第二个<code>10</code>位决定了在第二级中的什么位置，而第三个<code>12</code>位决定了在物理页中的什么位置。</p>
<p>每个进程都有一个<code>CR3</code>，准确的说是都一个<code>CR3</code>的值。<code>CR3</code>本身是个寄存器，一核一套寄存器。<code>CR3</code>里面放的是一个真正的物理地址，指向一个物理页，一共<code>4096字节</code>，如下图所示：</p>
<p><img src="https://c65mael.github.io/myassets/cr3.png" alt="image" loading="lazy" /></p>
<p>对于<code>10-10-12</code>分页来说，线性地址对应的物理地址是有对应关系的，它被分成了三个部分，每个部分都有它具体的含义。线性地址分配的结构如下图所示：</p>
<p><img src="https://c65mael.github.io/myassets/101012.png" alt="image" loading="lazy" /></p>
<p>第一个部分指的是<code>PDE</code>在<code>PDT</code>的索引，第二部分是<code>PTE</code>在<code>PTT</code>的索引，第三个部分是在PTE指向的物理页的偏移。<code>PDT</code>被称为页目录表，<code>PTT</code>被称为页表。<code>PDE</code>和<code>PTE</code>分别是它们的成员，大小为4个字节。接下来将详细介绍每一个部分是咋用的。</p>
<h6>PDE与PTE<span class="hx-absolute -hx-mt-20" id="pde与pte"></span>
    <a href="#pde%e4%b8%8epte" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p><img src="https://c65mael.github.io/myassets/pdepte.png" alt="image" loading="lazy" /></p>
<p>分页并不是由操作系统决定的，而是由<code>CPU</code>决定的。只是操作系统遵守了<code>CPU</code>的约定来实现的。物理页是什么？物理页是操作系统对可用的物理内存的抽象，按照<code>4KB</code>的大小进行管理（<code>Intel</code>是按照这个值做的，别的<code>CPU</code>就不清楚了），和真实硬件层面上的内存有一层的映射关系，这个不是保护模式的范畴，故不介绍。</p>
<h6>PDE与PTE属性<span class="hx-absolute -hx-mt-20" id="pde与pte属性"></span>
    <a href="#pde%e4%b8%8epte%e5%b1%9e%e6%80%a7" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p><img src="https://c65mael.github.io/myassets/pdeptejg.png" alt="image" loading="lazy" /></p>
<p><code>物理页的属性 = PDE属性 &amp; PTE属性</code></p>
<p>9~12位（缺页异常）</p>
<p><img src="https://c65mael.github.io/myassets/wuxiaoPTE.png" alt="image" loading="lazy" /></p>
<ul>
<li>内存紧张时，当CPU发现某一线性地址访问频率不是特别高时，操作系统就会把这个地址的内容存到文件里面，并且将P位置0。</li>
<li>当CPU访问一个地址，如果其PTE的P位为0，此时会产生缺页异常。（此时走<code>e</code>号中断）</li>
</ul>
<p>G位</p>
<p>​	如果G位为1刷新<code>TLB</code>时将不会刷新<code>PDE/PTE</code>的G位为1的页，G=1切换进程该<code>PTE</code>扔然有效(这里学完<code>TLB</code>才能明白)</p>
<p>(PDE)PS位</p>
<p>  这个位只对<code>PDE</code>有意义。如果<code>PS == 1</code>，则<code>PDE</code>直接指向物理页（高20位就是物理页），不再指向<code>PTE</code>，<code>10-10-12</code>的低22位是页内偏移。它的大小为<code>4MB</code>，俗称“大页”。</p>
<p>(PTE)D 位</p>
<p>  脏位，指示是否被写过。若没有被写过为<code>0</code>，被写过为<code>1</code>。</p>
<p>A 位</p>
<p>  是否被访问，即是否被读或者写过，如果被访问过则置<code>1</code>。即使访问了一字节也是1。</p>
<p>R/W 位</p>
<p>  如果<code>R/W = 0</code>，表示是只读的，反之为可读可写。</p>
<p>U/S 位</p>
<p>  如果<code>U/S = 0</code>，则为特权用户（super user），即非3环权限。反之，则为普通用户，即为3环权限。</p>
<p>P 位</p>
<p>  表示<code>PDE</code>或者<code>PTE</code>是否有效，如果有效为<code>1</code>，反之为<code>0</code>。</p>
<h6>页目录表基址<span class="hx-absolute -hx-mt-20" id="页目录表基址"></span>
    <a href="#%e9%a1%b5%e7%9b%ae%e5%bd%95%e8%a1%a8%e5%9f%ba%e5%9d%80" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>如果系统要保证某个线性地址是有效的，必须为其填充正确的<code>PDE</code>与<code>PTE</code>，如果我们想填充<code>PDE</code>与<code>PTE</code>那么必须能够访问。有的人会想，直接拿<code>CR3</code>去填写就行了，还需要页目录表基址干嘛？操作系统只能用线性地址，不能用物理地址。<code>CR3</code>存储的是物理地址，这个是给<code>CPU</code>看的，不是给操作系统看的。操作系统访问它就必须知道它的线性地址才行。<code>CPU</code>可不帮我们挂物理页，它做不到这点，只能提供要求标准，而操作系统按照标准进行办事。于是乎页目录表基址与页表基址这两个东西就出现了。</p>
<p>通过页目录表基址，操作系统可以帮我们程序挂上正确的<code>PDE</code>，通过页表基址挂上正确的<code>PTE</code>，然后指向正确的物理页。</p>
<ol>
<li>通过<code>0xC0300000</code>找到的物理页就是页目录表，这个物理页即是页目录表本身也是页表</li>
<li>页目录表是一张特殊的页表，每一项<code>PTE</code>指向的不是普通的物理页，而是指向其他的页表</li>
<li>结论：<code>0xC0300000</code>存储的值就是<code>PDT</code>，如果我们要访问第N个<code>PDE</code>，那么有如下公式:<code>0xC0300000 +N*4</code></li>
</ol>
<p><img src="https://c65mael.github.io/myassets/ymlbjz.png" alt="image" loading="lazy" /></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0xC0300000
1100 0000 00|11 0000 0000 000
1：1100 0000 00 == 300*4
2：1100 0000 00 == 300*4
3：0</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h6>页表基址<span class="hx-absolute -hx-mt-20" id="页表基址"></span>
    <a href="#%e9%a1%b5%e8%a1%a8%e5%9f%ba%e5%9d%80" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>仅仅知道页目录表基址只能访问一个线性地址的<code>PDE</code>。但是<code>PTE</code>我们没办法知道（因为如果程序使用页目录表基址是没办法访<code>PTE</code>的）。与页目录表基址类似，通过页表基址就可以访问<code>PTT</code>，也就是地址<code>0xC0000000</code>。</p>
<ol>
<li>页表被映射到了从<code>0xC0000000</code>到<code>0xC03FFFFF</code>的<code>4M</code>地址空间</li>
<li>在这1024个表中有一张特殊的表：页目录表</li>
<li>页目录被映射到了<code>0xC0300000</code>开始处的<code>4K</code>地址空间</li>
</ol>
<p><strong>PDI与PTI</strong></p>
<p>因为<code>PDE</code>是页目录表项，<code>PTE</code>是页表项。那么<code>PDI</code>就是页目录表索引，而<code>PTI</code>就是页表索引（<code>Index</code>）。在我们的<code>10-10-12</code>分页中，第一个10就是<code>PDI</code>，第二个10就是<code>PTI</code>，12就是物理页的页内偏移。</p>
<ul>
<li>访问页目录表的公式：<code>0xC0300000 + PDI * 4</code></li>
<li>访问页表的公式：<code>0xC0000000 + PDI * 4096 + PTI * 4</code>（就是挨个差一个页<code>0x1000</code>）</li>
</ul>
<p><img src="https://c65mael.github.io/myassets/ybjz.png" alt="image" loading="lazy" /></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>!vtop Cr3 线性地址
通过这个指令可以直接得到PDE和PTE😊</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h6>2-9-9-12分页（PAE分页）<span class="hx-absolute -hx-mt-20" id="2-9-9-12分页pae分页"></span>
    <a href="#2-9-9-12%e5%88%86%e9%a1%b5pae%e5%88%86%e9%a1%b5" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>先回顾一下10-10-12分页：</p>
<ul>
<li>为什么是12：因为最后要找的物理页大小为<code>4kb</code>，所以需要<code>2^12</code>来覆盖所有的地址，也就是所谓的页内偏移。</li>
<li><code>PTT</code>里面的<code>PTE</code>指向物理页，<code>PTE</code>一共有<code>1024</code>个所以需要<code>2^10</code>来找全<code>1024</code>个成员，也就是所谓的<code>PDI</code>。</li>
<li><code>PDT</code>里面的<code>PDE</code>指向<code>PTT</code>，与<code>PTE</code>类似，所以也需要<code>2^10</code>来找全<code>1024</code>个成员，也就是所谓的<code>PTI</code>。</li>
<li>通过以上，<code>CPU</code>通过<code>10-10-12</code>分页可以找到的内存一共有<code>4GB</code>，这个通过<code>CPU</code>识别的内存可不是通过上面的表乘起来的，是因为一个内存地址最多只有<code>32</code>位，所以可以找到的内存为<code>2^32 = 4GB</code>。</li>
</ul>
<p>为什么要有<code>2-9-9-12</code>分页，其实还是物理页不够用了，需要扩展。主要就是将地址的长度变长了，物理地址由<code>32</code>位改为了<code>36</code>位。那么<code>PDE</code>与<code>PTE</code>也要将<code>base</code>增加<code>4</code>位，<code>4</code>字节对齐之后就是<code>8</code>字节。对<code>PTT</code>来说成员数量从<code>1024</code>个变为了<code>512</code>个，所以需要<code>2^9</code>来索引；与<code>PDT</code>一样，所以也需要<code>2^9</code>来索引。这就是两个<code>9</code>的来源。通过之前的改变应该可以算出来一个<code>PDT</code>就代表能够索引<code>1GB</code>的内存，所以在前面又有叫<code>PDPTE</code>的结构来指向<code>PDT</code>，这个<code>PDPTE</code>结构有<code>8</code>个字节，所以这个结构一共有<code>4</code>个。这就是<code>2</code>的来源。这样就可以索引一个<code>4GB</code>的内存啦！</p>
<p><img src="https://c65mael.github.io/myassets/29912.png" alt="image" loading="lazy" /></p>
<p><strong>PDPTT结构：</strong></p>
<p><img src="https://c65mael.github.io/myassets/pdpte.png" alt="image" loading="lazy" /></p>
<ul>
<li><code>PDPTE</code>共有四项（第一个<code>2</code>）</li>
<li><code>35~12</code>存储的是页目录表的基址，低<code>12</code>位补<code>0</code>，共<code>36</code>位，即页目录基址。</li>
<li>其中，<code>Avali</code>位是给操作系统使用的。</li>
</ul>
<p><strong>PDE结构：</strong></p>
<p><img src="https://c65mael.github.io/myassets/29912pdes.png" alt="image" loading="lazy" /></p>
<p>↑是一般页</p>
<p><img src="https://c65mael.github.io/myassets/29912pdel.png" alt="image" loading="lazy" /></p>
<p>↑是大页</p>
<p>注意：</p>
<ul>
<li>当<code>PS=1</code>时是大页， <code>35-21</code>位是大页的物理地址，这样<code>36</code>位的物理地址的低<code>21</code>位为<code>0</code>，这就意味着页的大小为<code>2MB</code>，且都是<code>2MB</code>对齐。</li>
<li>当<code>PS=0</code>时，<code>35-12</code>位是页表基址，低<code>12</code>位补<code>0</code>，共<code>36</code>位。</li>
</ul>
<p><strong>PTE结构：</strong></p>
<p><img src="https://c65mael.github.io/myassets/29912pte.png" alt="image" loading="lazy" /></p>
<p>注意：</p>
<ul>
<li>
<p><code>PTE</code>中<code>35-12</code>是物理页基址，<code>24</code>位，低<code>12</code>位补<code>0</code></p>
<p><code>物理页基址+12位</code>的页内偏移指向具体数据</p>
</li>
</ul>
<p><strong>XD位：</strong></p>
<p>它是一个位，处于<code>PDE</code>和<code>PTE</code>的最高位。其实就是<code>linux</code>保护机制里面的<code>NX</code>(禁止执行)，<code>NX</code>是栈上的内容不可执行；而<code>XD</code>是数据区不可执行，如果最高位是<code>1</code>，说明被保护。如果这个是数据区，且这个<code>X</code>位被置为<code>1</code>，则会被报出异常不能执行。</p>
<p><img src="https://c65mael.github.io/myassets/xd.png" alt="image" loading="lazy" /></p>
<p><strong>公式总结：</strong></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ae81ff">2</span>(PDPTI)<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>(PDI)<span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>(PTI)<span style="color:#f92672">-</span><span style="color:#ae81ff">12</span>(OFFSET)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pPDE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xc0600000</span> <span style="color:#f92672">+</span> (PDPTI<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>KB) <span style="color:#f92672">+</span> (PDI<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>)
</span></span><span style="display:flex;"><span>pPTE <span style="color:#f92672">=</span> <span style="color:#ae81ff">0xc0000000</span> <span style="color:#f92672">+</span> (PDPTI<span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>MB) <span style="color:#f92672">+</span> (PDI<span style="color:#f92672">*</span><span style="color:#ae81ff">4</span>KB) <span style="color:#f92672">+</span> (PTI<span style="color:#f92672">*</span><span style="color:#ae81ff">8</span>)</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>针对MmIsAddressValid的公式如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pPDE <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0xc0600000</span> <span style="color:#f92672">+</span> ((addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">18</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x3ff8</span>))
</span></span><span style="display:flex;"><span>pPTE <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0xc0000000</span> <span style="color:#f92672">+</span> ((addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">9</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x7ffff8</span>))</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h6>TLB<span class="hx-absolute -hx-mt-20" id="tlb"></span>
    <a href="#tlb" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p><code>TLB(Translation Lookaside Buffer)</code>其实就是实现了一个物理地址对线性地址的映射关系，提供缓存提高读写效率。</p>
</li>
<li>
<p>结构如下：</p>
<table>
  <thead>
      <tr>
          <th>LA（线性地址）</th>
          <th>PA（物理地址）</th>
          <th>ATTR（属性）</th>
          <th>LRU（统计）</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0x81010111</td>
          <td>……</td>
          <td>……</td>
          <td>1</td>
      </tr>
  </tbody>
</table>
<p>其中：</p>
<ol>
<li>ATTR（属性）：如果是<code>2-9-9-12</code>分页，属性是<code>PDPE</code>、<code>PDE</code>、<code>PTE</code>三个属性相**&amp;&amp;<strong>。如果是<code>10-10-12</code>分页就是<code>PDE</code>和<code>PTE</code>两个属性相</strong>&amp;&amp;**。</li>
<li>不同的<code>CPU</code>这个表的大小不一样。</li>
<li>只要<code>Cr3</code>变了，<code>TLB</code>立马刷新，一核一套<code>TLB</code>。</li>
</ol>
<p>操作系统的高2G映射基本不变，如果<code>Cr3</code>改了，<code>TLB</code>刷新重建高<code>2G</code>以上很浪费。所以<code>PDE</code>和<code>PTE</code>中有个<code>G</code>标志位，如果<code>G</code>位为1刷新<code>TLB</code>时将不会刷新<code>PDE/PTE</code>的<code>G</code>位为1的页，当<code>TLB</code>满了，根据统计信息将不常用的地址废弃，最近最常用的保留。</p>
</li>
<li>
<p><code>TLB</code>有不同的种类，用于不同的缓存目的，它在<code>X86</code>体系里的实际应用最早是从<code>Intel</code>的<code>486CPU</code>开始的，在<code>X86</code>体系的<code>CPU</code>里边，一般都设有如下<code>4</code>组<code>TLB</code>：</p>
<ul>
<li>第一组：缓存一般页表（<code>4K</code>字节页面）的指令页表缓存：<code>Instruction-TLB</code></li>
<li>第二组：缓存一般页表（<code>4K</code>字节页面）的数据页表缓存：<code>Data-TLB</code></li>
<li>第三组：缓存大尺寸页表（<code>2M/4M</code>字节页面）的指令页表缓存：<code>Instruction-TLB</code></li>
<li>第四组：缓存大尺寸页表（<code>2M/4M</code>字节页面）的数据页表缓存：<code>Data-TLB</code></li>
</ul>
</li>
</ul>
<h6>中断与异常<span class="hx-absolute -hx-mt-20" id="中断与异常"></span>
    <a href="#%e4%b8%ad%e6%96%ad%e4%b8%8e%e5%bc%82%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p><strong>什么是中断？</strong></p>
<ol>
<li>中断通常是由<code>CPU</code>外部的输入输出设备（硬件）所触发的，供外部设备通知<code>CPU</code> &ldquo;有事情需要处理&rdquo; ，因此又叫中断请求（<code>Interrupt Request</code>）</li>
<li>中断请求的目的是希望<code>CPU</code>暂时停止执行当前正在执行的程序，转去执行中断请求所对应的中断处理例程（中断处理程序在哪由<code>IDT</code>表决定）</li>
<li><code>80×86</code>有两条中断请求线：
<ul>
<li>非屏蔽中断线，称为<code>NMI</code> (<code>NonMaskable Interrupt</code>)</li>
<li>可屏蔽中断线，称为<code>INTR</code>（<code>Interrupt Require</code>）</li>
</ul>
</li>
</ol>
<p><strong>非屏蔽中断如何处理？</strong></p>
<ul>
<li>
<p><code>CPU</code>会查<code>IDT</code>表中的<code>2</code>号中断：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">（IDT表）中断号</th>
          <th style="text-align: center">NMI</th>
          <th style="text-align: center">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><code>0x2</code></td>
          <td style="text-align: center">不可屏蔽中断</td>
          <td style="text-align: center"><code>80x86</code>中固定为<code>0x2</code></td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>解释：当非可屏蔽中断产生时，<code>CPU</code>在执行完当前指令后会里面进入中断处理程序。非可屏蔽中断不受<code>EFLAG</code>寄存器中<code>IF</code>位的影响，一旦发生，<code>CPU</code><strong>必须</strong>处理非可屏蔽中断处理程序位于<code>IDT</code>表中的<code>2</code>号位置</p>
</li>
</ul>
<p><strong>可屏蔽中断</strong></p>
<ul>
<li>在硬件级，可屏蔽中断是由一块专门的芯片来管理的，通常称为中断控制器。它负责分配中断资源和管理各个中断源发出的中断请求为了便于标识各个中断请求，中断管理器通常用<code>IRQ</code>（<code>Interrupt Request</code>）后面加上数字来表示不同的中断。</li>
<li>比如：在<code>Windows</code>中时钟中断的<code>IRQ</code>编号为<code>0</code>也就是：<code>IRQ0</code></li>
</ul>
<p><strong>可屏蔽中断如何处理？</strong></p>
<ul>
<li>
<p>中断号如下：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">（IDT表）中断号</th>
          <th style="text-align: center">IRQ</th>
          <th style="text-align: center">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center"><code>0x30</code></td>
          <td style="text-align: center"><code>IRQ0</code></td>
          <td style="text-align: center">时钟中断</td>
      </tr>
      <tr>
          <td style="text-align: center"><code>0x31~0x3F</code></td>
          <td style="text-align: center"><code>IRQ1~IRQ15</code></td>
          <td style="text-align: center">其他硬件设备的中断</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p>解释：</p>
<ol>
<li>
<p>如果自己的程序执行时不希望<code>CPU</code>去处理这些中断，可以</p>
<p>用<code>CLI</code>指令清空<code>EFLAG</code>寄存器中的<code>IF</code>位</p>
<p>用<code>STI</code>指令设置<code>EFLAG</code>寄存器中的<code>IF</code>位</p>
</li>
<li>
<p>硬件中断与<code>IDT</code>表中的对应关系并非固定不变的，参见：<code>APIC</code>（高级可编程中断控制器）</p>
</li>
</ol>
</li>
</ul>
<p><strong>异常</strong></p>
<ul>
<li>
<p>异常通常是<code>CPU</code>在执行指令时检测到的某些错误，比如除<code>0</code>、访问无效页面等。中断与异常的区别：</p>
<ol>
<li>中断来自于外部设备，是中断源（比如键盘）发起的，<code>CPU</code>是被动的</li>
<li>异常来自于<code>CPU</code>本身，是<code>CPU</code>主动产生的</li>
<li><code>INT N</code>虽然被称为 &ldquo;软件中断&rdquo; ，但其本质是异常。<code>EFLAG</code>的<code>IF</code>位对<code>INT N</code>无效</li>
</ol>
</li>
<li>
<p>无论是由硬件设备触发的中断请求还是由<code>CPU</code>产生的异常，处理程序都在<code>IDT</code>表。</p>
<p>常见异常处理的对应调用号：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">错误类型</th>
          <th style="text-align: center">（IDT表）中断号</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">页错误</td>
          <td style="text-align: center"><code>0xE</code></td>
      </tr>
      <tr>
          <td style="text-align: center">段错误</td>
          <td style="text-align: center"><code>0xD</code></td>
      </tr>
      <tr>
          <td style="text-align: center">除零错误</td>
          <td style="text-align: center"><code>0x0</code></td>
      </tr>
      <tr>
          <td style="text-align: center">双重错误</td>
          <td style="text-align: center"><code>0x8</code></td>
      </tr>
  </tbody>
</table>
</li>
</ul>
<h6>控制寄存器<span class="hx-absolute -hx-mt-20" id="控制寄存器"></span>
    <a href="#%e6%8e%a7%e5%88%b6%e5%af%84%e5%ad%98%e5%99%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>控制寄存器用于控制和确定<code>CPU</code>的操作模式</p>
<p>一共有<code>5</code>个控制寄存器：<code>Cr0，Cr1，Cr2，Cr3，Cr4</code></p>
<p>其中<code>Cr1</code>保留，<code>Cr3</code>为页目录表基址</p>
<ul>
<li>
<p><strong>Cr0寄存器</strong></p>
<p><img src="https://c65mael.github.io/myassets/cr0.png" alt="image" loading="lazy" /></p>
<ul>
<li>
<p><code>PE</code>位是启用保护模式（<code>Protection Enable</code>）标志。</p>
<p>若<code>PE = 1</code>是开启保护模式，反之为实地址模式。这个标志仅开启段级保护，而并没有启用分页机制。若要启用分页机制，那么<code>PE</code>和<code>PG</code>标志都要置位。</p>
</li>
<li>
<p><code>PG</code>位是启用分页机制。在开启这个标志之前必须已经或者同时开启<code>PE</code>标志。</p>
<p><code>PG = 0</code>且<code>PE = 0</code>，处理器工作在实地址模式下。</p>
<p><code>PG = 0</code>且<code>PE = 1</code>，处理器工作在没有开启分页机制的保护模式下。</p>
<p><code>PG = 1</code>且<code>PE = 0</code>，在<code>PE</code>没有开启的情况下无法开启<code>PG</code>。</p>
<p><code>PG = 1</code>且<code>PE = 1</code>，处理器工作在开启了分页机制的保护模式下。</p>
</li>
<li>
<p><code>WP</code>位对于<code>Intel 80486</code>或以上的<code>CPU</code>，是写保护（<code>Write Proctect</code>）标志。当设置该标志时，处理器会禁止超级用户程序（例如特权级0的程序）向用户级只读页面执行写操作；</p>
<p>当<code>CPL &lt; 3</code>的时候：</p>
<p>如果<code>WP = 0</code>可以读写任意用户级物理页，只要线性地址有效。</p>
<p>如果<code>WP = 1</code>可以读取任意用户级物理页，但对于只读的物理页，则不能写。</p>
</li>
</ul>
</li>
<li>
<p><strong>Cr2寄存器</strong></p>
<p><img src="https://c65mael.github.io/myassets/cr2.png" alt="image" loading="lazy" /></p>
<p>当<code>CPU</code>访问某个无效页面时，会产生缺页异常，此时，<code>CPU</code>会将引起异常的线性地址存放在<code>Cr2</code>中。</p>
</li>
<li>
<p><strong>Cr4寄存器</strong></p>
<p><img src="https://c65mael.github.io/myassets/cr4.png" alt="image" loading="lazy" /></p>
<ul>
<li>
<p><code>PAE = 1</code>是<code>2-9-9-12</code>分页<code>PAE = 0</code>是<code>10-10-12</code>分页。其实就是那个<code>boot.ini</code>文件里面我们修改的那个来判断的，操作系统希望我们用什么样的分页来启动操作系统。</p>
</li>
<li>
<p><code>PSE</code>是大页是否开启的总开关，如果置<code>0</code>，就算<code>PDE</code>中设置了大页你也得是普通的页。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">PSE</th>
          <th style="text-align: center">PS</th>
          <th style="text-align: center">分页类型</th>
          <th style="text-align: center">页大小</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">1</td>
          <td style="text-align: center">1</td>
          <td style="text-align: center">2-9-9-12</td>
          <td style="text-align: center">2M</td>
      </tr>
      <tr>
          <td style="text-align: center">1</td>
          <td style="text-align: center">0</td>
          <td style="text-align: center">2-9-9-12</td>
          <td style="text-align: center">4K</td>
      </tr>
      <tr>
          <td style="text-align: center">1</td>
          <td style="text-align: center">1</td>
          <td style="text-align: center">10-10-12</td>
          <td style="text-align: center">4M</td>
      </tr>
      <tr>
          <td style="text-align: center">1</td>
          <td style="text-align: center">0</td>
          <td style="text-align: center">10-10-12</td>
          <td style="text-align: center">4K</td>
      </tr>
      <tr>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
          <td style="text-align: center"></td>
      </tr>
      <tr>
          <td style="text-align: center">0</td>
          <td style="text-align: center">1</td>
          <td style="text-align: center">2-9-9-12</td>
          <td style="text-align: center">4K</td>
      </tr>
      <tr>
          <td style="text-align: center">0</td>
          <td style="text-align: center">0</td>
          <td style="text-align: center">2-9-9-12</td>
          <td style="text-align: center">4K</td>
      </tr>
      <tr>
          <td style="text-align: center">0</td>
          <td style="text-align: center">1</td>
          <td style="text-align: center">10-10-12</td>
          <td style="text-align: center">4K</td>
      </tr>
      <tr>
          <td style="text-align: center">0</td>
          <td style="text-align: center">0</td>
          <td style="text-align: center">10-10-12</td>
          <td style="text-align: center">4K</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h6>PWT 与 PCD<span class="hx-absolute -hx-mt-20" id="pwt-与-pcd"></span>
    <a href="#pwt-%e4%b8%8e-pcd" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p><strong>CPU缓存</strong></p>
<ul>
<li>
<p><code>CPU</code>缓存是位于<code>CPU</code>与物理内存之间的临时存储器，它的容量比内存小的多但是交换速度却比内存要快得多。它可以做的很大。</p>
</li>
<li>
<p><code>CPU</code>缓存与<code>TLB</code>类似但有所不同，<code>TLB</code>存的是线性地址与物理地址的对应关系，<code>CPU</code>缓存存的是物理地址与内容对应关系。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">CPU缓存的对应关系</th>
          <th style="text-align: center">TLB的对应关系</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">物理地址</td>
          <td style="text-align: center">线性地址</td>
      </tr>
      <tr>
          <td style="text-align: center">内容</td>
          <td style="text-align: center">物理地址</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p><code>PWT_PCD</code>:</p>
<p><code>PWT</code>全称为<code>Page Write Through</code>，<code>PWT = 1</code>时，写<code>Cache</code>的时候也要将数据写入内存中。</p>
<p><code>PCD</code>全称为<code>Page Cache Disable</code>，<code>PCD = 1</code>时，禁止某个页写入缓存，直接写内存。比如，做页表用的页，已经存储在<code>TLB</code>中了，可能不需要再缓存了。</p>
</li>
</ul>
<h3>驱动<span class="hx-absolute -hx-mt-20" id="驱动"></span>
    <a href="#%e9%a9%b1%e5%8a%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>环境<span class="hx-absolute -hx-mt-20" id="环境"></span>
    <a href="#%e7%8e%af%e5%a2%83" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>先从32位的系统开始学习，安装一下<code>VS2010</code>+<code>WDK7600</code>，远古版本。</p>
</li>
<li>
<p>里面设置属性表的代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span><span style="color:#75715e">&lt;?xml version=&#34;1.0&#34; encoding=&#34;utf-8&#34;?&gt;</span>
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">Project</span> <span style="color:#a6e22e">ToolsVersion</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;4.0&#34;</span> <span style="color:#a6e22e">xmlns</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://schemas.microsoft.com/developer/msbuild/2003&#34;</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">ImportGroup</span> <span style="color:#a6e22e">Label</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;PropertySheets&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">PropertyGroup</span> <span style="color:#a6e22e">Label</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;UserMacros&#34;</span> /&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">PropertyGroup</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">ExecutablePath</span>&gt;C:\WinDDK\7600.16385.1\bin\x86;$(ExecutablePath)&lt;/<span style="color:#f92672">ExecutablePath</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">PropertyGroup</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">PropertyGroup</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">IncludePath</span>&gt;C:\WinDDK\7600.16385.1\inc\api;C:\WinDDK\7600.16385.1\inc\ddk;C:\WinDDK\7600.16385.1\inc\crt;$(IncludePath)&lt;/<span style="color:#f92672">IncludePath</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">PropertyGroup</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">PropertyGroup</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">LibraryPath</span>&gt;C:\WinDDK\7600.16385.1\lib\win7\i386;$(LibraryPath)&lt;/<span style="color:#f92672">LibraryPath</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">TargetExt</span>&gt;.sys&lt;/<span style="color:#f92672">TargetExt</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">LinkIncremental</span>&gt;false&lt;/<span style="color:#f92672">LinkIncremental</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">GenerateManifest</span>&gt;false&lt;/<span style="color:#f92672">GenerateManifest</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">PropertyGroup</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">ItemDefinitionGroup</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">ClCompile</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">PreprocessorDefinitions</span>&gt;_X86_;DBG&lt;/<span style="color:#f92672">PreprocessorDefinitions</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">CallingConvention</span>&gt;StdCall&lt;/<span style="color:#f92672">CallingConvention</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">ExceptionHandling</span>&gt;false&lt;/<span style="color:#f92672">ExceptionHandling</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">BasicRuntimeChecks</span>&gt;Default&lt;/<span style="color:#f92672">BasicRuntimeChecks</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">BufferSecurityCheck</span>&gt;false&lt;/<span style="color:#f92672">BufferSecurityCheck</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">CompileAs</span>&gt;Default&lt;/<span style="color:#f92672">CompileAs</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DebugInformationFormat</span>&gt;ProgramDatabase&lt;/<span style="color:#f92672">DebugInformationFormat</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">ClCompile</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">Link</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">AdditionalDependencies</span>&gt;ntoskrnl.lib;wdm.lib;wdmsec.lib;wmilib.lib;ndis.lib;Hal.lib;MSVCRT.LIB;LIBCMT.LIB;%(AdditionalDependencies)&lt;/<span style="color:#f92672">AdditionalDependencies</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">Link</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;<span style="color:#f92672">Link</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">IgnoreAllDefaultLibraries</span>&gt;true&lt;/<span style="color:#f92672">IgnoreAllDefaultLibraries</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">EnableUAC</span>&gt;false&lt;/<span style="color:#f92672">EnableUAC</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">SubSystem</span>&gt;Native&lt;/<span style="color:#f92672">SubSystem</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">EntryPointSymbol</span>&gt;DriverEntry&lt;/<span style="color:#f92672">EntryPointSymbol</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">BaseAddress</span>&gt;0x10000&lt;/<span style="color:#f92672">BaseAddress</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">RandomizedBaseAddress</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">RandomizedBaseAddress</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">DataExecutionPrevention</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;/<span style="color:#f92672">DataExecutionPrevention</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">GenerateDebugInformation</span>&gt;true&lt;/<span style="color:#f92672">GenerateDebugInformation</span>&gt;
</span></span><span style="display:flex;"><span>      &lt;<span style="color:#f92672">Driver</span>&gt;Driver&lt;/<span style="color:#f92672">Driver</span>&gt;
</span></span><span style="display:flex;"><span>    &lt;/<span style="color:#f92672">Link</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;/<span style="color:#f92672">ItemDefinitionGroup</span>&gt;
</span></span><span style="display:flex;"><span>  &lt;<span style="color:#f92672">ItemGroup</span> /&gt;
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">Project</span>&gt;</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>记住要修改<code>C:\WinDDK\7600.16385.1</code>这个为<code>WDK</code>的路径。</p>
<p><a href="https://www.cnblogs.com/weekbo/p/10783218.html" target="_blank" rel="noopener">文章</a></p>
<p>上面的，属性管理器在视图&mdash;-&gt;其他窗口</p>
</li>
</ul>
<h6>内核编程基础<span class="hx-absolute -hx-mt-20" id="内核编程基础"></span>
    <a href="#%e5%86%85%e6%a0%b8%e7%bc%96%e7%a8%8b%e5%9f%ba%e7%a1%80" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>在应用层编程我们可以使用<code>WINDOWS</code>提供的各种<code>API</code>函数，只要导入头文件<code>windows.h</code>就可以了。但是在内核编程的时候，微软为内核程序提供了专用的<code>API</code>，只要在程序中包含相应的头文件就可以使用了，如：<code>#include &lt;ntddk.h&gt;</code>，假设你安装了<code>WDK</code>。</p>
<p>为什么要用两个头文件：为了安全，因为内核很脆弱，用<code>3</code>环的头文件就压力大了；而且一个没进<code>0</code>环一个进<code>0</code>环了，不一样。</p>
</li>
<li>
<p>在应用层编程的时候，我们通过<code>MSDN</code>来了解函数的详细信息，在内核编程的时候，要使用<code>WDK</code>自己的帮助文档。</p>
</li>
<li>
<p><code>WDK</code>说明文档中只包含了内核模块导出的函数，对于未导出的函数，则不能直接使用。如果要德用未导出的函数，只要自己定义一个函数指针，并且为函数指针提供正确的函数地址就可以使用了。有两种办法都可以获取为导出的函数地址：</p>
<ol>
<li>特征码搜索</li>
<li>解析内核<code>PDB</code>文件（就是<code>windbg</code>中可以使用<code>u 函数名</code>来获取函数的反汇编的原因）</li>
</ol>
<blockquote>
  <table>
  <thead>
      <tr>
          <th style="text-align: center">补充</th>
          <th style="text-align: center">解释</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">未导出函数</td>
          <td style="text-align: center">导出表里面没有该函数，文档里面自然没有该函数</td>
      </tr>
      <tr>
          <td style="text-align: center">未文档化函数</td>
          <td style="text-align: center">文档里面没有写该函数，但在导出表里面有该函数</td>
      </tr>
  </tbody>
</table>
</blockquote>
</li>
<li>
<p><strong>基本数据类型</strong></p>
<ol>
<li>
<p>在内核编程的时候，强烈建议大家遵守<code>WDK</code>的编码习惯，建议不要这样写：<code>unsigned long length;</code>，建议这样写：<code>ULONG length</code>。</p>
</li>
<li>
<p>习惯使用WDK自己的类型：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">WDK 习惯</th>
          <th style="text-align: center">SDK 习惯</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">ULONG</td>
          <td style="text-align: center">unsigned long</td>
      </tr>
      <tr>
          <td style="text-align: center">PULONG</td>
          <td style="text-align: center">unsigned long*</td>
      </tr>
      <tr>
          <td style="text-align: center">UCHAR</td>
          <td style="text-align: center">unsigned char</td>
      </tr>
      <tr>
          <td style="text-align: center">PUCHAR</td>
          <td style="text-align: center">unsigned char*</td>
      </tr>
      <tr>
          <td style="text-align: center">UINT</td>
          <td style="text-align: center">unsigned int</td>
      </tr>
      <tr>
          <td style="text-align: center">PUNIT</td>
          <td style="text-align: center">unsigned int*</td>
      </tr>
      <tr>
          <td style="text-align: center">VOID</td>
          <td style="text-align: center">void</td>
      </tr>
      <tr>
          <td style="text-align: center">PVOID</td>
          <td style="text-align: center">void*</td>
      </tr>
  </tbody>
</table>
</li>
</ol>
</li>
<li>
<p><strong>返回值</strong></p>
<p>大部分内核函数的返回值都是<code>NTSTATUS</code>类型，如：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">PsCreateSystemThread</span>();
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">ZwOpenProcess</span>();
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">ZwOpenEvent</span>();</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这个值能说明函数执行的结果，比如：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#define STATUS_SUCCESS 0x00000000    </span><span style="color:#75715e">//成功
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define STATUS_INVALID_PARAMETER 0xC000000D    </span><span style="color:#75715e">//参数无效
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define STATUS_BUFFER_OVERFLOW 0x80000005    </span><span style="color:#75715e">//缓冲区长度不够
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//这里每一个值都有一个对应的宏，那么在执行一个内核函数后可以判断返回值为STATUS_XXXXXX，就可以判断函数的执行状态了，可读性好一些
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>当你调用的内核函数，如果返回的结果不是<code>STATUS_SUCCESS</code>，就说明函数执行中遇到了问题，具体是什么问题，可以在<code>ntstatus.h</code>文件中查看。</p>
</li>
<li>
<p><strong>异常处理</strong></p>
<p>在内核中，一个小小的错误就可能导致蓝屏，比如：读写一个无效的内存地址。为了让自己的内核程序更加健壮，强烈建议大家在编写内核程序时，使用异常处理。</p>
<p><code>Windows</code>提供了结构化异常处理机制，一般的编译器都是支持的，如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">__try</span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//可能出错的代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__except</span>(filter_value) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//出错时要执行的代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>出现异常时，可根据<code>filter_value</code>的值来决定程序该如果执行，当<code>filter_value</code>的值为：</p>
<ol>
<li><code>EXCEPTION_EXECUTE_HANDLER(1)</code>：代码进入<code>except</code>块</li>
<li><code>EXCEPTION_CONTINUE_SEARCH(0)</code>：不处理异常，由上一层调用函数处理</li>
<li><code>EXCEPTION_CONTINUE_EXECUTION(-1)</code>：回去继续执行错误处的代码</li>
</ol>
</li>
<li>
<p><strong>常用的内核内存函数</strong></p>
<p>对内存的使用，主要就是：申请、设置、拷贝以及释放。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">c语言</th>
          <th style="text-align: center">内核中</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">malloc</td>
          <td style="text-align: center">ExAllocatePoolWithTag</td>
      </tr>
      <tr>
          <td style="text-align: center">memset</td>
          <td style="text-align: center">RtlFillMemory</td>
      </tr>
      <tr>
          <td style="text-align: center">memcpy</td>
          <td style="text-align: center">RtlMoveMemory</td>
      </tr>
      <tr>
          <td style="text-align: center">free</td>
          <td style="text-align: center">ExFreePool</td>
      </tr>
  </tbody>
</table>
<blockquote>
  <p>请注意<code>ExAllocatePoolWithTag</code>函数的<code>POOL_TYPE PoolType</code>参数：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">enum</span> _POOL_TYPE {
</span></span><span style="display:flex;"><span>  NonPagedPool,
</span></span><span style="display:flex;"><span>  PagedPool,
</span></span><span style="display:flex;"><span>  NonPagedPoolMustSucceed,
</span></span><span style="display:flex;"><span>  DontUseThisType,
</span></span><span style="display:flex;"><span>  NonPagedPoolCacheAligned,
</span></span><span style="display:flex;"><span>  PagedPoolCacheAligned,
</span></span><span style="display:flex;"><span>  NonPagedPoolCacheAlignedMustS
</span></span><span style="display:flex;"><span>} POOL_TYPE;</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>NonPagedPool</code>代表非分页内存，<code>PagedPool</code>代表分页内存</p>
<p>非分页内存：物理页很重要，系统不会放到硬盘上的内存（常驻，存代码）</p>
<p>分页内存：物理页没那么重要，允许把物理页写到硬盘上的内存（存数据）</p>
</blockquote>
</li>
<li>
<p><strong>IRQL</strong></p>
<ul>
<li>什么是中断请求级别：就是<code>CPU</code>在执行时会遇到中断时会执行中断程序，但是如果在执行时又遇到了中断，这时该执行哪个中断程序呢？此时就需要看两个中断的中断级别了（中断是分等级的！），如果现在<code>CPU</code>执行中断的等级高于又遇到的中断，那么就忽略这个新来的中断；否则就会终止当前的中断程序，转去执行新来的中断程序（被打断了）。</li>
<li><code>IRQL</code>是<code>Windows</code>自己定义的一套优先级方案，与<code>CPU</code>无关，<strong>数值越大权限越高，相同权限无法互相打断，只有更高的权限才能打断</strong>。</li>
<li><code>CPU</code>任何时刻必须必须在<code>IRQL</code>中处于某一等级。</li>
</ul>
<p><img src="https://c65mael.github.io/myassets/IRQL.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p><strong>内核字符串种类</strong></p>
<p>在编写3环程序我们经常用：<code>CHAR(char)</code>/<code>WCHAR(wchar_t)</code>来分别表示宅字符串和宽字符串，用0表示结尾。但是在内核中，我们常用：<code>ANSI_STRING</code>/<code>UNICODE_STRING</code>来分别表示宅字符串和宽字符串。它们的结构如下：</p>
<p><code>ANSI_STRING</code>字符串：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _STRING
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    USHORT Length;
</span></span><span style="display:flex;"><span>    USHORT MaximumLength;
</span></span><span style="display:flex;"><span>    PCHAR Buffer;
</span></span><span style="display:flex;"><span>}STRING;</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>UNICODE_STRING</code>字符串：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> _UNICODE_STRING
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    USHORT Length;
</span></span><span style="display:flex;"><span>    USHORT MaxmumLength;
</span></span><span style="display:flex;"><span>    PWSTR Buffer;
</span></span><span style="display:flex;"><span>} UNICODE_STRING;</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><strong>内核字符串常用函数</strong></p>
<p>符串常用的功能无非就是：创建、复制、比较以及转换等等。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">操作</th>
          <th style="text-align: center">ANSI_STRING字符串</th>
          <th style="text-align: center">UNICODE_STRING字符串</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">初始化</td>
          <td style="text-align: center">RtlInitAnsiString</td>
          <td style="text-align: center">RtlInitUnicodeString</td>
      </tr>
      <tr>
          <td style="text-align: center">拷贝</td>
          <td style="text-align: center">RtlCopyString</td>
          <td style="text-align: center">RtlCopyUnicodeString</td>
      </tr>
      <tr>
          <td style="text-align: center">比较</td>
          <td style="text-align: center">RtlCompareString</td>
          <td style="text-align: center">RtlCompareUnicodeString</td>
      </tr>
      <tr>
          <td style="text-align: center">转换</td>
          <td style="text-align: center">RtlAnsiStringToUnicodeString</td>
          <td style="text-align: center">RtlUnicodeStringToAnsiString</td>
      </tr>
  </tbody>
</table>
</li>
</ul>
<h6>内核空间与内核模块<span class="hx-absolute -hx-mt-20" id="内核空间与内核模块"></span>
    <a href="#%e5%86%85%e6%a0%b8%e7%a9%ba%e9%97%b4%e4%b8%8e%e5%86%85%e6%a0%b8%e6%a8%a1%e5%9d%97" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>之前了解到，每个进程都有<code>4GB</code>虚拟空间，而且低<code>2GB</code>所对应的物理页基本不同；高<code>2GB</code>内存所对应的物理页基本相同（共用）</p>
<p><img src="https://c65mael.github.io/myassets/kerkj.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p>硬件种类繁多，不可能做一个兼容所有硬件的内核，所以，微软提供规定的接口格式，让硬件驱动人员安装规定的格式编写<strong>驱动程序</strong> 。</p>
<p>在内核中，这些驱动程序每一个都是一个模块，称为<strong>内核模块</strong>，都可以加载到内核中，都遵守<code>PE</code>结构。但本质上讲，任意一个<code>sys</code>文件与内核文件没有区别。每个驱动都是一个模块。就和在<code>3</code>环的程序加载<code>dll</code>一样，加载一个贴上一个。</p>
<p><img src="https://c65mael.github.io/myassets/kermk.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p>做练习可以了解到入口函数为<code>NTSTATUS DriverEntry(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)</code>，需要注意它的第一个参数：</p>
<ul>
<li>
<p><code>DRIVER_OBJECT</code>（驱动对象）描述了当前该模块的一些重要信息</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _DRIVER_OBJECT
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_DRIVER_OBJECT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Type             : Int2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x002</span> Size             : Int2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> DeviceObject     : Ptr32 _DEVICE_OBJECT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> Flags            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> DriverStart      : Ptr32 Void    <span style="color:#75715e">//驱动从哪里开始的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> DriverSize       : Uint4B    <span style="color:#75715e">//部署的驱动有多大
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> DriverSection    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> DriverExtension  : Ptr32 _DRIVER_EXTENSION
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> DriverName       : _UNICODE_STRING    <span style="color:#75715e">//驱动叫什么名字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> HardwareDatabase : Ptr32 _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> DriverInit       : Ptr32     <span style="color:#66d9ef">long</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> DriverStartIo    : Ptr32     <span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> DriverUnload     : Ptr32     <span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> MajorFunction    : [<span style="color:#ae81ff">28</span>] Ptr32     <span style="color:#66d9ef">long</span> 
</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>请注意里面的成员<code>DriverSection</code>，一个指针对应结构体的双向循环链表<code>LDR_DATA_TABLE_ENTRY</code>，它圈着内核里面的所有模块（就是查看成员<code>InLoadOrderLinks</code>就行了）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _LDR_DATA_TABLE_ENTRY
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_LDR_DATA_TABLE_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> InLoadOrderLinks : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> InMemoryOrderLinks : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> InInitializationOrderLinks : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> DllBase          : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> EntryPoint       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> SizeOfImage      : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> FullDllName      : _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> BaseDllName      : _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> Flags            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> LoadCount        : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03a</span> TlsIndex         : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> HashLinks        : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> SectionPointer   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> CheckSum         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> TimeDateStamp    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> LoadedImports    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x048</span> EntryPointActivationContext : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> PatchInformation : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>我们使用工具将驱动加载的第一步就是先注册驱动，就是在注册表里面写上驱动，第二个参数<code>reg_path</code>就是将驱动写在注册表里面的什么地方</p>
</li>
<li>
<blockquote>
  <p>在<code>3</code>环里面，有一块内存描述线程的信息，就是<code>TEB</code>。<code>FS:[0]</code>就指向这个结构体：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _TEB
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_TEB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> NtTib            : _NT_TIB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> EnvironmentPointer : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> ClientId         : _CLIENT_ID
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> ActiveRpcHandle  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> ThreadLocalStoragePointer : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> ProcessEnvironmentBlock : Ptr32 _PEB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> LastErrorValue   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> CountOfOwnedCriticalSections : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> CsrClientThread  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> Win32ThreadInfo  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> User32Reserved   : [<span style="color:#ae81ff">26</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0ac</span> UserReserved     : [<span style="color:#ae81ff">5</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c0</span> WOW32Reserved    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c4</span> CurrentLocale    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c8</span> FpSoftwareStatusRegister : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0cc</span> SystemReserved1  : [<span style="color:#ae81ff">54</span>] Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a4</span> ExceptionCode    : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a8</span> ActivationContextStack : _ACTIVATION_CONTEXT_STACK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1bc</span> SpareBytes1      : [<span style="color:#ae81ff">24</span>] UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d4</span> GdiTebBatch      : _GDI_TEB_BATCH
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6b4</span> RealClientId     : _CLIENT_ID
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6bc</span> GdiCachedProcessHandle : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6c0</span> GdiClientPID     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6c4</span> GdiClientTID     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6c8</span> GdiThreadLocalInfo : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6cc</span> Win32ClientInfo  : [<span style="color:#ae81ff">62</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x7c4</span> glDispatchTable  : [<span style="color:#ae81ff">233</span>] Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xb68</span> glReserved1      : [<span style="color:#ae81ff">29</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbdc</span> glReserved2      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbe0</span> glSectionInfo    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbe4</span> glSection        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbe8</span> glTable          : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbec</span> glCurrentRC      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbf0</span> glContext        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbf4</span> LastStatusValue  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbf8</span> StaticUnicodeString : _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xc00</span> StaticUnicodeBuffer : [<span style="color:#ae81ff">261</span>] Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xe0c</span> DeallocationStack : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xe10</span> TlsSlots         : [<span style="color:#ae81ff">64</span>] Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf10</span> TlsLinks         : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf18</span> Vdm              : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf1c</span> ReservedForNtRpc : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf20</span> DbgSsReserved    : [<span style="color:#ae81ff">2</span>] Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf28</span> HardErrorsAreDisabled : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf2c</span> Instrumentation  : [<span style="color:#ae81ff">16</span>] Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf6c</span> WinSockData      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf70</span> GdiBatchCount    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf74</span> InDbgPrint       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf75</span> FreeStackOnTermination : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf76</span> HasFiberData     : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf77</span> IdealProcessor   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf78</span> Spare3           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf7c</span> ReservedForPerf  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf80</span> ReservedForOle   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf84</span> WaitingOnLoaderLock : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf88</span> Wx86Thread       : _Wx86ThreadState
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf94</span> TlsExpansionSlots : Ptr32 Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf98</span> ImpersonationLocale : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xf9c</span> IsImpersonating  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfa0</span> NlsCache         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfa4</span> pShimData        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfa8</span> HeapVirtualAffinity : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfac</span> CurrentTransactionHandle : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfb0</span> ActiveFrame      : Ptr32 _TEB_ACTIVE_FRAME
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfb4</span> SafeThunkCall    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0xfb5</span> BooleanSpare     : [<span style="color:#ae81ff">3</span>] UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>可以看到，在<code>TEB</code>的成员中的<code>0x30</code>，存储着进程环境块（<code>PEB</code>）。它描述着进程里面的信息：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _PEB
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_PEB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> InheritedAddressSpace : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x001</span> ReadImageFileExecOptions : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x002</span> BeingDebugged    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x003</span> SpareBool        : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Mutant           : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> ImageBaseAddress : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> Ldr              : Ptr32 _PEB_LDR_DATA
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> ProcessParameters : Ptr32 _RTL_USER_PROCESS_PARAMETERS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> SubSystemData    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> ProcessHeap      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> FastPebLock      : Ptr32 _RTL_CRITICAL_SECTION
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> FastPebLockRoutine : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> FastPebUnlockRoutine : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> EnvironmentUpdateCount : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> KernelCallbackTable : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> SystemReserved   : [<span style="color:#ae81ff">1</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> AtlThunkSListPtr32 : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> FreeList         : Ptr32 _PEB_FREE_BLOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> TlsExpansionCounter : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> TlsBitmap        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> TlsBitmapBits    : [<span style="color:#ae81ff">2</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> ReadOnlySharedMemoryBase : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> ReadOnlySharedMemoryHeap : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> ReadOnlyStaticServerData : Ptr32 Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> AnsiCodePageData : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05c</span> OemCodePageData  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> UnicodeCaseTableData : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x064</span> NumberOfProcessors : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x068</span> NtGlobalFlag     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x070</span> CriticalSectionTimeout : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x078</span> HeapSegmentReserve : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x07c</span> HeapSegmentCommit : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x080</span> HeapDeCommitTotalFreeThreshold : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x084</span> HeapDeCommitFreeBlockThreshold : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x088</span> NumberOfHeaps    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x08c</span> MaximumNumberOfHeaps : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x090</span> ProcessHeaps     : Ptr32 Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x094</span> GdiSharedHandleTable : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x098</span> ProcessStarterHelper : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x09c</span> GdiDCAttributeList : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a0</span> LoaderLock       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a4</span> OSMajorVersion   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a8</span> OSMinorVersion   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0ac</span> OSBuildNumber    : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0ae</span> OSCSDVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b0</span> OSPlatformId     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b4</span> ImageSubsystem   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b8</span> ImageSubsystemMajorVersion : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0bc</span> ImageSubsystemMinorVersion : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c0</span> ImageProcessAffinityMask : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c4</span> GdiHandleBuffer  : [<span style="color:#ae81ff">34</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x14c</span> PostProcessInitRoutine : Ptr32     <span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x150</span> TlsExpansionBitmap : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x154</span> TlsExpansionBitmapBits : [<span style="color:#ae81ff">32</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d4</span> SessionId        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d8</span> AppCompatFlags   : _ULARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e0</span> AppCompatFlagsUser : _ULARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e8</span> pShimData        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ec</span> AppCompatInfo    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f0</span> CSDVersion       : _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f8</span> ActivationContextData : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1fc</span> ProcessAssemblyStorageMap : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x200</span> SystemDefaultActivationContextData : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x204</span> SystemAssemblyStorageMap : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x208</span> MinimumStackCommit : Uint4B</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>看<code>PEB</code>，里面<code>0x00c</code>处的<code>Ldr</code>，里面存放着<code>3</code>个链表：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _PEB_LDR_DATA
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_PEB_LDR_DATA
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Length           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Initialized      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> SsHandle         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> InLoadOrderModuleList : _LIST_ENTRY    <span style="color:#75715e">//&lt;=第一个（加载顺序）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> InMemoryOrderModuleList : _LIST_ENTRY    <span style="color:#75715e">//&lt;=第二个（内存顺序）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> InInitializationOrderModuleList : _LIST_ENTRY    <span style="color:#75715e">//&lt;=第三个（初始化顺序）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> EntryInProgress  : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这三个链表记录了当前进程有哪些模块，与<code>0</code>环的<code>LDR_DATA_TABLE_ENTRY</code>类似</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<h6>0环与3环通信（常规方式）<span class="hx-absolute -hx-mt-20" id="0环与3环通信常规方式"></span>
    <a href="#0%e7%8e%af%e4%b8%8e3%e7%8e%af%e9%80%9a%e4%bf%a1%e5%b8%b8%e8%a7%84%e6%96%b9%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p><strong>设备对象</strong></p>
<p>我们在开发窗口程序的时候，消息被封装成一个结构体：<code>MSG</code>。在内核开发时，消息被封装成另外一个结构体：<code>IRP</code>（<code>I/O Request Package</code>）。</p>
<p>在窗口程序中，能够接收消息的只能是窗口对象。在内核中，能够接收<code>IRP</code>消息的只能是设备对象。</p>
<p><img src="https://c65mael.github.io/myassets/shebeiduixiang.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p>通信流程</p>
<ol>
<li>
<p><strong>创建设备对象</strong></p>
<p>如何理解：正常来说一个设备对象对应一个硬件，但是也可以什么都不对应，就是一个抽象的概念：只有结构体没有硬件</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//创建设备名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>UNICODE_STRING Devicename;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RtlInitUnicodeString</span>(<span style="color:#f92672">&amp;</span>Devicename,<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Device</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">MyDevice&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//创建设备
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">IoCreateDevice</span>(
</span></span><span style="display:flex;"><span>    pDriver,    <span style="color:#75715e">//当前设备所属的驱动对象，一个设备对象必须属于某一个驱动对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0</span>,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&amp;</span>Devicename,    <span style="color:#75715e">//设备对象的名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    FILE_DEVICE_UNKNOWN,    <span style="color:#75715e">//没有对应的设备就是这个UNKNOWN
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    FILE_DEVICE_SECURE_OPEN,
</span></span><span style="display:flex;"><span>    FALSE,
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&amp;</span>pDeviceObj    <span style="color:#75715e">//设备对象指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>);</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><strong>设置交互数据的方式</strong></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>pDeviceObj<span style="color:#f92672">-&gt;</span>Flags <span style="color:#f92672">|=</span> DO_BUFFERED_IO;</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>
<p>缓冲区方式读写(<code>DO_BUFFERED_IO</code>) ：操作系统将应用程序提供缓冲区的数据复制到内核模式下的地址中。</p>
</li>
<li>
<p>直接方式读写(<code>DO_DIRECT_IO</code>) ：操作系统会将用户模式下的缓冲区锁住。然后操作系统将这段缓冲区在内核模式地址再次映射一遍。这样，用户模式的缓冲区和内核模式的缓冲区指向的是同一区域的物理内存。缺点就是要单独占用物理页面。</p>
</li>
<li>
<p>其他方式读写（在调用<code>IoCreateDevice</code>创建设备后对<code>pDevObj-&gt;Flags</code>即不设置<code>DO_BUFFERED_IO</code>也不设置<code>DO_DIRECT_IO</code>此时就是其他方式。）</p>
<p>在使用其他方式读写设备时，派遣函数直接读写应用程序提供的缓冲区地址。在驱动程序中，直接操作应用程序的缓冲区地址是很危险的。只有驱动程序与应用程序运行在相同线程上下文的情况下，才能使用这种方式。如果<code>CPU</code>中的任务切换了，即<code>CR3</code>切换掉了，在高<code>2GB</code>的驱动仍在使用该方式读取低<code>2GB</code>内存，导致读到的数据和实际不符，导致错误，故强烈不推荐此方式。</p>
</li>
</ul>
</li>
<li>
<p><strong>创建符号链接</strong></p>
<ul>
<li>
<p>就是让3环的程序找到你的驱动对象。设备名称的作用是给内核对象用的，如果要在3环访问，必须要有符号链接。其实就是一个别名，没有这个别名，在3环不可见。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//创建符号链接名称
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">RtlInitUnicodeString</span>(<span style="color:#f92672">&amp;</span>SymbolicLinkName,<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">??</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">MyTestDriver&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//创建符号链接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">IoCreateSymbolicLink</span>(<span style="color:#f92672">&amp;</span>SymbolicLinkName,<span style="color:#f92672">&amp;</span>Devicename);</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>内核模式下，符号链接是以<code>\??\</code>开头的，如C盘就是<code>\??\C:</code>。而在用户模式下，则是以<code>\\.\</code>开头的，如C盘就是<code>\\.\C:</code></p>
</li>
</ul>
</li>
<li>
<p><strong>IRP</strong></p>
<p>类比一下，在图形界面上是通过鼠标单击或双机来调用回调函数，而在内核里面则是通过调用对应的函数来执行派遣函数的</p>
<p><img src="https://c65mael.github.io/myassets/cksbduixiang.png" alt="image" loading="lazy" /></p>
<p>在3环调用<code>CreateFile</code>函数，操作系统就会封装一个<code>IRP</code>派发给设备对象，设备对象通过<code>IRP</code>的类型调用对应的派发函数。</p>
<p>当应用层通过<code>CreateFile</code>、<code>ReadFile</code>、<code>WriteFile</code>、<code>CloseHandle</code>等函数打开、从设备读取数据、向设备写入数据、关闭设备的时候，会使操作系统分别产生出<code>IRP_MJ_CREATE</code>、<code>IRP_MJ_READ</code>、<code>IRP_MJ_WRITE</code>、<code>IRP_MJ_CLOSE</code>等不同的<code>IRP</code>。</p>
<p>其他类型的<code>IRP</code>：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">IRP类型</th>
          <th style="text-align: center">来源</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">IRP_MJ_DEVICE_CONTROL</td>
          <td style="text-align: center">使用 DeviceControl 函数时产生（最多的方式）</td>
      </tr>
      <tr>
          <td style="text-align: center">IRP_MJ_POWER</td>
          <td style="text-align: center">在操作系统处理电源消息时产生</td>
      </tr>
      <tr>
          <td style="text-align: center">IRP_MJ_SHUTDOWN</td>
          <td style="text-align: center">关闭系统前时产生</td>
      </tr>
  </tbody>
</table>
</li>
<li>
<p><strong>派遣函数</strong></p>
<p>如何注册派遣函数：其实每一个<code>IRP</code>都对应一个值，那么你提供的派遣函数就应该写在成员<code>MajorFunction</code>下标对应的位置。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _DRIVER_OBJECT
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_DRIVER_OBJECT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Type             : Int2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x002</span> Size             : Int2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> DeviceObject     : Ptr32 _DEVICE_OBJECT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> Flags            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> DriverStart      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> DriverSize       : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> DriverSection    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> DriverExtension  : Ptr32 _DRIVER_EXTENSION
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> DriverName       : _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> HardwareDatabase : Ptr32 _UNICODE_STRING
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> FastIoDispatch   : Ptr32 _FAST_IO_DISPATCH
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> DriverInit       : Ptr32     <span style="color:#66d9ef">long</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> DriverStartIo    : Ptr32     <span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> DriverUnload     : Ptr32     <span style="color:#66d9ef">void</span> 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> MajorFunction    : [<span style="color:#ae81ff">28</span>] Ptr32     <span style="color:#66d9ef">long</span> 
</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>代码形式：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//设置卸载函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pDriverObject<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">卸载函数</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//设置派遣函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_CREATE] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_CLOSE] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_WRITE] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_READ] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_CLEANUP] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">5</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_SET_INFORMATION] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">6</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_DEVICE_CONTROL] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">7</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_SHUTDOWN] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">8</span>;
</span></span><span style="display:flex;"><span>pDriverObject<span style="color:#f92672">-&gt;</span>MajorFunction[IRP_MJ_SYSTEM_CONTROL] <span style="color:#f92672">=</span> <span style="color:#960050;background-color:#1e0010">派遣函数</span><span style="color:#ae81ff">9</span>;</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><strong>派遣函数的格式</strong></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">MyDispatchFunction</span>(PDEVICE_OBJECT pDevObj, PIRP pIrp)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//处理自己的业务……
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//设置返回状态
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pIrp<span style="color:#f92672">-&gt;</span>IoStatus.Status <span style="color:#f92672">=</span> STATUS_SUCCESS;    <span style="color:#75715e">//GetLastError() 函数得到的就是该值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pIrp<span style="color:#f92672">-&gt;</span>IoStatus.Information <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;    <span style="color:#75715e">//返回给3环多少数据 没有填0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">IoCompleteRequest</span>(pIrp, IO_NO_INCREMENT);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
</li>
</ul>
<h6>驱动常用加载方式<span class="hx-absolute -hx-mt-20" id="驱动常用加载方式"></span>
    <a href="#%e9%a9%b1%e5%8a%a8%e5%b8%b8%e7%94%a8%e5%8a%a0%e8%bd%bd%e6%96%b9%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>注册驱动</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CDriverLoadDlg<span style="color:#f92672">::</span>OnBnRegister()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  CString path <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFilePath();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger <span style="color:#f92672">=</span> OpenSCManager(NULL, NULL, SC_MANAGER_ALL_ACCESS);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(__T(<span style="color:#e6db74">&#34;提示&#34;</span>), __T(<span style="color:#e6db74">&#34;服务管理打开失败&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (path.IsEmpty())
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;没有选择文件&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CString fileName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFileName();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  SC_HANDLE serviceHandle <span style="color:#f92672">=</span> CreateService(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger, fileName, fileName, SERVICE_ALL_ACCESS,
</span></span><span style="display:flex;"><span>    SERVICE_KERNEL_DRIVER, SERVICE_DEMAND_START, SERVICE_ERROR_NORMAL, path, NULL, NULL, NULL, NULL, NULL);    <span style="color:#75715e">//创建一个服务对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (serviceHandle <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> ERROR_SERVICE_EXISTS)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      MessageBox(_T(<span style="color:#e6db74">&#34;服务已经存在不需要创建了&#34;</span>), _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      CString str;
</span></span><span style="display:flex;"><span>      str.Format(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;错误号为:%d&#34;</span>, error);
</span></span><span style="display:flex;"><span>      MessageBox(str, _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>      OutputDebugString(str);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  CloseServiceHandle(serviceHandle);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>其中<code>OpenSCManager</code>是建立与本地计算机上的服务控制管理器的连接，<code>CreateService</code>是创建一个服务对象。</p>
</li>
<li>
<p>运行驱动</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CDriverLoadDlg<span style="color:#f92672">::</span>OnBnRun()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  CString path <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFilePath();;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (path.IsEmpty())
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;没有选择文件&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;请重新启动，服务器打开失败&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CString fileName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFileName();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  SC_HANDLE serviceHandle <span style="color:#f92672">=</span>  OpenService(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger, fileName, SERVICE_ALL_ACCESS);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (serviceHandle <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> ERROR_SERVICE_DOES_NOT_EXIST)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      MessageBox( _T(<span style="color:#e6db74">&#34;服务已经不存在&#34;</span>),_T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      CString <span style="color:#a6e22e">str</span>(<span style="color:#e6db74">&#34;错误号为:&#34;</span><span style="color:#f92672">+</span>error);
</span></span><span style="display:flex;"><span>      MessageBox(str, _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> StartService(serviceHandle, <span style="color:#ae81ff">0</span>, NULL); 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> ERROR_SERVICE_ALREADY_RUNNING)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      MessageBox(_T(<span style="color:#e6db74">&#34;已经运行&#34;</span>),_T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  CloseServiceHandle(serviceHandle);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>打开服务之后开始服务就正常运行了。</p>
</li>
<li>
<p>停止驱动</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CDriverLoadDlg<span style="color:#f92672">::</span>OnBnStop()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  CString path <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFilePath();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (path.IsEmpty())
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;没有选择文件&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;请重新启动，服务器打开失败&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CString fileName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFileName();
</span></span><span style="display:flex;"><span>  SC_HANDLE serviceHandle <span style="color:#f92672">=</span> OpenService(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger, fileName, SERVICE_ALL_ACCESS);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (serviceHandle <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> ERROR_SERVICE_DOES_NOT_EXIST)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      MessageBox(_T(<span style="color:#e6db74">&#34;服务不存在&#34;</span>), _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      MessageBox(_T(<span style="color:#e6db74">&#34;未知错误&#34;</span>), _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  SERVICE_STATUS error <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> ControlService(serviceHandle, SERVICE_CONTROL_STOP, <span style="color:#f92672">&amp;</span>error);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (result <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> ERROR_SERVICE_NOT_ACTIVE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;服务没有在运行&#34;</span>), _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      CString <span style="color:#a6e22e">str</span>(<span style="color:#e6db74">&#34;错误号为:&#34;</span> <span style="color:#f92672">+</span> error);
</span></span><span style="display:flex;"><span>      MessageBox(str, _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  CloseServiceHandle(serviceHandle);
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>打开服务之后用<code>ControlService</code>将驱动停止。</p>
</li>
<li>
<p>卸载驱动</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> CDriverLoadDlg<span style="color:#f92672">::</span>OnBnUnload()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  CString path <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFilePath();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (path.IsEmpty())
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;没有选择文件&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    MessageBox(_T(<span style="color:#e6db74">&#34;请重新启动，服务器打开失败&#34;</span>), _T(<span style="color:#e6db74">&#34;你要干什么&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CString fileName <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>getFileName();
</span></span><span style="display:flex;"><span>  SC_HANDLE serviceHandle <span style="color:#f92672">=</span> OpenService(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger, fileName, SERVICE_ALL_ACCESS);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (serviceHandle <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (error <span style="color:#f92672">==</span> ERROR_SERVICE_DOES_NOT_EXIST)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      MessageBox( _T(<span style="color:#e6db74">&#34;服务已经不存在&#34;</span>),_T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>      CString <span style="color:#a6e22e">str</span>(<span style="color:#e6db74">&#34;错误号为:&#34;</span> <span style="color:#f92672">+</span> error);
</span></span><span style="display:flex;"><span>      MessageBox(str, _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>DeleteService(serviceHandle))
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>    DWORD error <span style="color:#f92672">=</span> GetLastError();
</span></span><span style="display:flex;"><span>    CString str;
</span></span><span style="display:flex;"><span>    str.Format(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;错误号为:%d&#34;</span>, error);
</span></span><span style="display:flex;"><span>    MessageBox(str, _T(<span style="color:#e6db74">&#34;提示&#34;</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  CloseServiceHandle(serviceHandle);
</span></span><span style="display:flex;"><span>  CloseServiceHandle(<span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">this</span><span style="color:#f92672">-&gt;</span>scMageger <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>打开服务后调用<code>DeleteService</code>删除服务。</p>
</li>
</ul>
<h6>写拷贝<span class="hx-absolute -hx-mt-20" id="写拷贝"></span>
    <a href="#%e5%86%99%e6%8b%b7%e8%b4%9d" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>首先两个进程加载同一个<code>DLL</code>时，那么他们都使用同一个物理页（也就是<code>DLL</code>的物理页）。</p>
</li>
<li>
<p>之后如果想让这个<code>DLL</code>进行写拷贝，则必须让这个<code>DLL</code>的物理页变为只读的。</p>
</li>
<li>
<p>这时如果要写的话就会产生异常，<code>CPU</code>就会判断是写拷贝的只读异常还是普通的只读异常。</p>
</li>
<li>
<p>那么<code>CPU</code>如何判断呢？</p>
<p>我们知道使用<code>VirtualAlloc</code>函数可以指定地址进行内存的分配，那么肯定有一个位置记录这块地址是否被占用。</p>
<ol>
<li>
<p>在<code>windbg</code>中使用指令<code>dt _EPROCESS 地址</code>可以看到一个结构体，在这个结构体中有一个成员是<code>VadRoot</code>。这个成员是一个二叉树的地址，这个二叉树的每个节点都记录着占用内存的开始位置、结束位置以及什么类型。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x11c</span> VadRoot          : <span style="color:#ae81ff">0x895f5ac0</span> Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>虚拟地址使用情况查看（单位<code>4kb</code>）：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> <span style="color:#f92672">!</span>vad <span style="color:#ae81ff">0x895f5ac0</span>
</span></span><span style="display:flex;"><span>VAD   Level     Start       End Commit
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89887650</span>  <span style="color:#ae81ff">3</span>        <span style="color:#ae81ff">10</span>        <span style="color:#ae81ff">10</span>      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8957e138</span>  <span style="color:#ae81ff">4</span>        <span style="color:#ae81ff">20</span>        <span style="color:#ae81ff">20</span>      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89504</span>ea8  <span style="color:#ae81ff">2</span>        <span style="color:#ae81ff">30</span>       <span style="color:#ae81ff">12f</span>      <span style="color:#ae81ff">6</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8964</span>b9c0  <span style="color:#ae81ff">4</span>       <span style="color:#ae81ff">130</span>       <span style="color:#ae81ff">132</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>eb90  <span style="color:#ae81ff">3</span>       <span style="color:#ae81ff">140</span>       <span style="color:#ae81ff">141</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898</span>db370  <span style="color:#ae81ff">5</span>       <span style="color:#ae81ff">150</span>       <span style="color:#ae81ff">24f</span>     <span style="color:#ae81ff">26</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898</span>a4c98  <span style="color:#ae81ff">4</span>       <span style="color:#ae81ff">250</span>       <span style="color:#ae81ff">25f</span>      <span style="color:#ae81ff">6</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89849768</span>  <span style="color:#ae81ff">6</span>       <span style="color:#ae81ff">260</span>       <span style="color:#ae81ff">26f</span>      <span style="color:#ae81ff">0</span> Mapped       READWRITE          Pagefile section, shared commit <span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89958180</span>  <span style="color:#ae81ff">5</span>       <span style="color:#ae81ff">270</span>       <span style="color:#ae81ff">285</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>unicode.nls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89439</span>b78  <span style="color:#ae81ff">7</span>       <span style="color:#ae81ff">290</span>       <span style="color:#ae81ff">2</span>d0      <span style="color:#ae81ff">0</span> Mapped       READONLY           <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>locale.nls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89439</span>b48  <span style="color:#ae81ff">6</span>       <span style="color:#ae81ff">2e0</span>       <span style="color:#ae81ff">320</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>sortkey.nls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8982e460</span>  <span style="color:#ae81ff">8</span>       <span style="color:#ae81ff">330</span>       <span style="color:#ae81ff">335</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>sorttbls.nls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8982e430</span>  <span style="color:#ae81ff">7</span>       <span style="color:#ae81ff">340</span>       <span style="color:#ae81ff">380</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x41</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">895829</span>d0  <span style="color:#ae81ff">8</span>       <span style="color:#ae81ff">390</span>       <span style="color:#ae81ff">39f</span>      <span style="color:#ae81ff">5</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89657368</span>  <span style="color:#ae81ff">9</span>       <span style="color:#ae81ff">3</span>a0       <span style="color:#ae81ff">3</span>a2      <span style="color:#ae81ff">0</span> Mapped       READONLY           <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>ctype.nls
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89932958</span> <span style="color:#ae81ff">10</span>       <span style="color:#ae81ff">3</span>b0       <span style="color:#ae81ff">3</span>bf      <span style="color:#ae81ff">8</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">894</span>cf498 <span style="color:#ae81ff">11</span>       <span style="color:#ae81ff">3</span>c0       <span style="color:#ae81ff">3</span>c0      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>ec58 <span style="color:#ae81ff">12</span>       <span style="color:#ae81ff">3</span>d0       <span style="color:#ae81ff">3</span>d0      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898</span>a6af0 <span style="color:#ae81ff">14</span>       <span style="color:#ae81ff">3e0</span>       <span style="color:#ae81ff">3e1</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898</span>a6ac0 <span style="color:#ae81ff">13</span>       <span style="color:#ae81ff">3f</span><span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">3f</span><span style="color:#ae81ff">1</span>      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x2</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8964</span>bae0  <span style="color:#ae81ff">1</span>       <span style="color:#ae81ff">400</span>       <span style="color:#ae81ff">4</span>ec     <span style="color:#ae81ff">23</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>Documents and Settings<span style="color:#960050;background-color:#1e0010">\</span>Administrator<span style="color:#960050;background-color:#1e0010">\桌面\</span>DebugView<span style="color:#960050;background-color:#1e0010">\</span>Dbgview86_汉化.exe
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89657338</span>  <span style="color:#ae81ff">3</span>       <span style="color:#ae81ff">4f</span><span style="color:#ae81ff">0</span>       <span style="color:#ae81ff">5</span>b7      <span style="color:#ae81ff">0</span> Mapped       EXECUTE_READ       Pagefile section, shared commit <span style="color:#ae81ff">0x3</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">896572</span>d8  <span style="color:#ae81ff">2</span>       <span style="color:#ae81ff">5</span>c0       <span style="color:#ae81ff">6</span>c2      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x103</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8953</span>b368  <span style="color:#ae81ff">4</span>       <span style="color:#ae81ff">6</span>d0       <span style="color:#ae81ff">9</span>cf      <span style="color:#ae81ff">0</span> Mapped       EXECUTE_READ       Pagefile section, shared commit <span style="color:#ae81ff">0x1b</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89649838</span>  <span style="color:#ae81ff">5</span>       <span style="color:#ae81ff">9</span>d0       a1f      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x50</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8955</span>c3f0  <span style="color:#ae81ff">6</span>       a20       a20      <span style="color:#ae81ff">0</span> Mapped       READWRITE          Pagefile section, shared commit <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89656f</span>d8  <span style="color:#ae81ff">3</span>       a30       a6f      <span style="color:#ae81ff">0</span> Mapped       READWRITE          Pagefile section, shared commit <span style="color:#ae81ff">0x10</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89656f</span>a8  <span style="color:#ae81ff">4</span>       a70       a7d      <span style="color:#ae81ff">0</span> Mapped       READWRITE          Pagefile section, shared commit <span style="color:#ae81ff">0xe</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">894e3</span>ea8  <span style="color:#ae81ff">5</span>       a80       b7f    <span style="color:#ae81ff">167</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">895f</span><span style="color:#ae81ff">5</span>ac0  <span style="color:#ae81ff">0</span>       b80       b80      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>eeb0  <span style="color:#ae81ff">7</span>       b90       b90      <span style="color:#ae81ff">0</span> Private Phys READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898740</span>d8  <span style="color:#ae81ff">6</span>       ba0       ba0      <span style="color:#ae81ff">0</span> Mapped       READWRITE          Pagefile section, shared commit <span style="color:#ae81ff">0x1</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89578590</span>  <span style="color:#ae81ff">5</span>       bd0       c4f      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">895353</span>a0  <span style="color:#ae81ff">7</span>       c50       d4f      <span style="color:#ae81ff">2</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89441280</span>  <span style="color:#ae81ff">6</span>       d60       d67      <span style="color:#ae81ff">8</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8993</span>afd8  <span style="color:#ae81ff">7</span>       d70       def      <span style="color:#ae81ff">0</span> Mapped       READWRITE          Pagefile section, shared commit <span style="color:#ae81ff">0x7</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89649808</span>  <span style="color:#ae81ff">4</span>     <span style="color:#ae81ff">5</span>adc0     <span style="color:#ae81ff">5</span>adf6      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>uxtheme.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8953</span>b338  <span style="color:#ae81ff">3</span>     <span style="color:#ae81ff">62</span>c20     <span style="color:#ae81ff">62</span>c28      <span style="color:#ae81ff">1</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>lpk.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89876308</span>  <span style="color:#ae81ff">2</span>     <span style="color:#ae81ff">71</span>a10     <span style="color:#ae81ff">71</span>a17      <span style="color:#ae81ff">1</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>ws2help.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8982e400</span>  <span style="color:#ae81ff">3</span>     <span style="color:#ae81ff">71</span>a20     <span style="color:#ae81ff">71</span>a36      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>ws2_32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898762</span>d8  <span style="color:#ae81ff">6</span>     <span style="color:#ae81ff">71</span>a90     <span style="color:#ae81ff">71</span>aa1      <span style="color:#ae81ff">1</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>mpr.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89656f</span><span style="color:#ae81ff">78</span> <span style="color:#ae81ff">11</span>     <span style="color:#ae81ff">73640</span>     <span style="color:#ae81ff">7366</span>d      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>MSCTFIME.IME
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8953</span>b308 <span style="color:#ae81ff">10</span>     <span style="color:#ae81ff">73f</span>a0     <span style="color:#ae81ff">7400</span>a     <span style="color:#ae81ff">16</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>usp10.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89828008</span> <span style="color:#ae81ff">11</span>     <span style="color:#ae81ff">74680</span>     <span style="color:#ae81ff">746</span>cb      <span style="color:#ae81ff">3</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>MSCTF.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89657308</span>  <span style="color:#ae81ff">9</span>     <span style="color:#ae81ff">76300</span>     <span style="color:#ae81ff">7631</span>c      <span style="color:#ae81ff">1</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>imm32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89874078</span>  <span style="color:#ae81ff">8</span>     <span style="color:#ae81ff">76320</span>     <span style="color:#ae81ff">76366</span>      <span style="color:#ae81ff">4</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>comdlg32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89656f</span><span style="color:#ae81ff">48</span>  <span style="color:#ae81ff">9</span>     <span style="color:#ae81ff">76990</span>     <span style="color:#ae81ff">76</span>acc      <span style="color:#ae81ff">8</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>ole32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">895f</span><span style="color:#ae81ff">5900</span>  <span style="color:#ae81ff">7</span>     <span style="color:#ae81ff">77180</span>     <span style="color:#ae81ff">77282</span>      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>WinSxS<span style="color:#960050;background-color:#1e0010">\</span>x86_Microsoft.Windows.Common<span style="color:#f92672">-</span>Controls_6595b64144ccf1df_6<span style="color:#ae81ff">.0.2600.5512</span>_x<span style="color:#f92672">-</span>ww_35d4ce83<span style="color:#960050;background-color:#1e0010">\</span>comctl32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89876338</span>  <span style="color:#ae81ff">5</span>     <span style="color:#ae81ff">77</span>be0     <span style="color:#ae81ff">77</span>c37      <span style="color:#ae81ff">7</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>msvcrt.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8964</span>b960  <span style="color:#ae81ff">6</span>     <span style="color:#ae81ff">77</span>d10     <span style="color:#ae81ff">77</span>d9f      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>user32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8982e3</span>d0  <span style="color:#ae81ff">4</span>     <span style="color:#ae81ff">77</span>da0     <span style="color:#ae81ff">77e48</span>      <span style="color:#ae81ff">5</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>advapi32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8982e3</span>a0  <span style="color:#ae81ff">5</span>     <span style="color:#ae81ff">77e50</span>     <span style="color:#ae81ff">77</span>ee1      <span style="color:#ae81ff">1</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>rpcrt4.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89874008</span>  <span style="color:#ae81ff">7</span>     <span style="color:#ae81ff">77</span>ef0     <span style="color:#ae81ff">77f</span><span style="color:#ae81ff">38</span>      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>gdi32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">898740</span>a8  <span style="color:#ae81ff">8</span>     <span style="color:#ae81ff">77f</span><span style="color:#ae81ff">40</span>     <span style="color:#ae81ff">77f</span>b5      <span style="color:#ae81ff">2</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>shlwapi.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89876368</span>  <span style="color:#ae81ff">6</span>     <span style="color:#ae81ff">77f</span>c0     <span style="color:#ae81ff">77f</span>d0      <span style="color:#ae81ff">1</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>secur32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">894</span>b5238  <span style="color:#ae81ff">1</span>     <span style="color:#ae81ff">7</span>c800     <span style="color:#ae81ff">7</span>c91d      <span style="color:#ae81ff">5</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>kernel32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>ed28  <span style="color:#ae81ff">2</span>     <span style="color:#ae81ff">7</span>c920     <span style="color:#ae81ff">7</span>c9b2      <span style="color:#ae81ff">5</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>ntdll.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">89874048</span>  <span style="color:#ae81ff">5</span>     <span style="color:#ae81ff">7</span>d590     <span style="color:#ae81ff">7</span>dd83     <span style="color:#ae81ff">30</span> Mapped  Exe  EXECUTE_WRITECOPY  <span style="color:#960050;background-color:#1e0010">\</span>WINDOWS<span style="color:#960050;background-color:#1e0010">\</span>system32<span style="color:#960050;background-color:#1e0010">\</span>shell32.dll
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>eb60  <span style="color:#ae81ff">4</span>     <span style="color:#ae81ff">7f6f</span><span style="color:#ae81ff">0</span>     <span style="color:#ae81ff">7f</span><span style="color:#ae81ff">7</span>ef      <span style="color:#ae81ff">0</span> Mapped       EXECUTE_READ       Pagefile section, shared commit <span style="color:#ae81ff">0x7</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8964</span>b9f0  <span style="color:#ae81ff">3</span>     <span style="color:#ae81ff">7ff</span>a0     <span style="color:#ae81ff">7ff</span>d2      <span style="color:#ae81ff">0</span> Mapped       READONLY           Pagefile section, shared commit <span style="color:#ae81ff">0x33</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>ea98  <span style="color:#ae81ff">4</span>     <span style="color:#ae81ff">7ff</span>d4     <span style="color:#ae81ff">7ff</span>d4      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">895f</span><span style="color:#ae81ff">5</span>a80  <span style="color:#ae81ff">6</span>     <span style="color:#ae81ff">7ff</span>de     <span style="color:#ae81ff">7ff</span>de      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">8996</span>eb00  <span style="color:#ae81ff">5</span>     <span style="color:#ae81ff">7ff</span>df     <span style="color:#ae81ff">7ff</span>df      <span style="color:#ae81ff">1</span> Private      READWRITE          
</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>申请内存只有两个函数：<code>VirtualAlloc</code>与<code>FileMapping</code>（共享内存）。之前的<code>malloc</code>函数只是在上面的那一堆内存中划一块来使用</p>
</li>
</ol>
</li>
<li>
<p>其实就是产生异常，<code>CPU</code>判断是不是写拷贝，如果是的话就分配一个新的物理页，拷贝过去并使用新物理页。如果没有异常自然就不会有后面的操作了。</p>
</li>
</ol>
<h3>系统调用<span class="hx-absolute -hx-mt-20" id="系统调用"></span>
    <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>进0环前<span class="hx-absolute -hx-mt-20" id="进0环前"></span>
    <a href="#%e8%bf%9b0%e7%8e%af%e5%89%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p><code>_KUSER_SHARED_DATA</code></p>
<ul>
<li><code>User</code>层和<code>Kernel</code>层分别定义了一个<code>_KUSER_SHARED_DATA</code>结构区域，用于<code>User</code>层和<code>Kernel</code>层共享某些数据。（共享区域有多大取决于这个结构体有多大）</li>
<li>它们使用固定的地址值映射，<code>_KUSER_SHARED_DATA</code>结构区域在<code>User</code>和<code>Kernel</code>层地址分别为：
<ul>
<li><code>User</code>层地址为：<code>0x7ffe0000</code></li>
<li><code>Kernnel</code>层地址为：<code>0xffdf0000</code></li>
</ul>
</li>
<li>虽然指向的是同一个物理页，但在<code>User</code>层是只读的，在<code>Kernnel</code>层是可写的。</li>
</ul>
</li>
<li>
<p><code>NtReadVirtualMemory</code></p>
<ul>
<li>
<p>在<code>ntdll</code>中如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9E0</span>                 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">ZwReadVirtualMemory</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9E0</span> <span style="color:#66d9ef">ZwReadVirtualMemory</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>           <span style="color:#75715e">; CODE XREF: LdrFindCreateProcessManifest+1CC↓p
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9E0</span>                                         <span style="color:#75715e">; LdrCreateOutOfProcessImage+7C↓p ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9E0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">0</span><span style="color:#66d9ef">BAh</span>       <span style="color:#75715e">; NtReadVirtualMemory（服务号）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9E5</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">7</span><span style="color:#66d9ef">FFE0300h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9EA</span>                 <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">edx</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9EC</span>                 <span style="color:#66d9ef">retn</span>    <span style="color:#ae81ff">14</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92D9EC</span> <span style="color:#66d9ef">ZwReadVirtualMemory</span> <span style="color:#66d9ef">endp</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>可以看到是<code>call</code>了<code>0x7FFE0300</code>地址的代码，这个位置就是<code>_KUSER_SHARED_DATA</code>结构体第<code>0x300</code>偏移。</p>
</li>
<li>
<p>使用<code>dt _KUSER_SHARED_DATA 0x7ffe0000</code>找<code>0x300</code>偏移处为：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x300</span> SystemCall       : <span style="color:#ae81ff">0x7c92e4f0</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>使用<code>u 0x7c92e4f0</code>应该可以找到如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F0</span>                 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">KiFastSystemCall</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F0</span> <span style="color:#66d9ef">KiFastSystemCall</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>              <span style="color:#75715e">; DATA XREF: .text:off_7C923428↑o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">esp</span>    <span style="color:#75715e">;保存esp寄存器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F2</span>                 <span style="color:#66d9ef">sysenter</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F2</span> <span style="color:#66d9ef">KiFastSystemCall</span> <span style="color:#66d9ef">endp</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>或者：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E500</span>                 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">KiIntSystemCall</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E500</span> <span style="color:#66d9ef">KiIntSystemCall</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>               <span style="color:#75715e">; DATA XREF: .text:off_7C923428↑o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E500</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E500</span> <span style="color:#66d9ef">arg_4</span>           <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span>  <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E500</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E500</span>                 <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">edx</span>, [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">arg_4</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E504</span>                 <span style="color:#66d9ef">int</span>     <span style="color:#ae81ff">2</span><span style="color:#66d9ef">Eh</span>             <span style="color:#75715e">; DOS 2+ internal - EXECUTE COMMAND
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E504</span>                                         <span style="color:#75715e">; DS:SI -&gt; counted CR-terminated command string
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E506</span>                 <span style="color:#66d9ef">retn</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E506</span> <span style="color:#66d9ef">KiIntSystemCall</span> <span style="color:#66d9ef">endp</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>CPU</code>会判断系统支不支持<code>sysenter</code>指令，支持就在之前<code>0x300</code>偏移处写入<code>KiFastSystemCall</code>；不支持就会填入<code>KiIntSystemCall</code></p>
<ul>
<li>当通过<code>eax=1</code>来执行<code>cpuid</code>指令时，处理器的特征信息被放在<code>ecx</code>和<code>edx</code>寄存器中，其中<code>edx</code>包含了一个<code>SEP</code>位（<code>11</code>位），该位指明了当前处理器知否支持<code>sysenter/sysexit</code>指令。</li>
</ul>
</li>
<li>
<p>如果是<code>KiIntSystemCall</code>的形式进<code>R0</code>的话，需要查<code>IDT</code>表。在<code>0x2E*8</code>处为<code>KiSystemService</code>（用中断门拆段选择子）。</p>
</li>
</ul>
</li>
<li>
<p>快速调用</p>
<ul>
<li>
<p>中断门进<code>0</code>环，需要的<code>CS</code>、<code>EIP</code>在<code>IDT</code>表中，需要查内存（<code>SS</code>与<code>ESP</code>由<code>TSS</code>提供，参数在栈里面）而<code>CPU</code>如果支持<code>sysenter</code>指令时，操作系统会提前将<code>CS/SS/ESP/EIP</code>的值存储在<code>MSR</code>寄存器中，<code>sysenter</code>指令执行时，<code>CPU</code>会将<code>MSR</code>寄存器中的值直接写入相关寄存器，没有读内存的过程，所以叫快速调用，本质是一样的！</p>
</li>
<li>
<p>在执行<code>sysenter</code>指令之前，操作系统必须指定<code>0</code>环的<code>CS</code>段、<code>SS</code>段、<code>EIP</code>以及<code>ESP</code>。而在未公开的<code>MSR</code>寄存器中就存着这些值：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: center">MSR</th>
          <th style="text-align: center">Index</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">IA32_SYSENTER_CS</td>
          <td style="text-align: center">174H</td>
      </tr>
      <tr>
          <td style="text-align: center">IA32_SYSENTER_ESP</td>
          <td style="text-align: center">175H</td>
      </tr>
      <tr>
          <td style="text-align: center">IA32_SYSENTER_EIP</td>
          <td style="text-align: center">176H</td>
      </tr>
  </tbody>
</table>
<p>然后<code>SS</code>是经过计算得到：<code>CS</code>的值+8</p>
</li>
<li>
<p>在<code>windbg</code>中可以使用<code>rdmsr xxx</code>指令查看对应的<code>MSR</code>寄存器，通过这种方式进内核的函数为<code>KiFastCallEntry</code></p>
</li>
</ul>
</li>
<li>
<p>总结：</p>
<ul>
<li>通过中断门进<code>0</code>环：
<ul>
<li>固定中断号为<code>0x2E</code></li>
<li><code>CS/EIP</code>由门描述符提供，<code>ESP/SS</code>由<code>TSS</code>提供</li>
<li>进<code>0</code>环后执行的内核函数：<code>NT!KiSystemService</code></li>
</ul>
</li>
<li>通过<code>sysenter</code>进<code>0</code>环：
<ul>
<li><code>CS/ESP/EIP</code>由<code>MSR</code>寄存器提供（<code>SS</code>是算出来的）</li>
<li>进入<code>0</code>环后执行的内核函数：<code>NT!KiFastCallEntry</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<h6>进0环后（保存现场）<span class="hx-absolute -hx-mt-20" id="进0环后保存现场"></span>
    <a href="#%e8%bf%9b0%e7%8e%af%e5%90%8e%e4%bf%9d%e5%ad%98%e7%8e%b0%e5%9c%ba" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>几个重要的结构体：</p>
<ul>
<li>
<p><code>Trap_Frame</code></p>
<p>无论使用这两种方式的哪一种进<code>0</code>环，在三环的寄存器都会存到这个结构体中。由<code>windows</code>操作系统维护的。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _KTrap_Frame
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_KTRAP_FRAME
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> DbgEbp           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> DbgEip           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> DbgArgMark       : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> DbgArgPointer    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> TempSegCs        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> TempEsp          : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> Dr0              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> Dr1              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Dr2              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> Dr3              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> Dr6              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> Dr7              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> SegGs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> SegEs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> SegDs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> Edx              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> Ecx              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> Eax              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x048</span> PreviousMode : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> SegFs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> Edi              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> Esi              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05c</span> Ebx              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> Ebp              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x064</span> ErrCode          : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x068</span> Eip              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06c</span> SegCs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x070</span> EFlags           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x074</span> HardwareEsp      : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x078</span> HardwareSegSs    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x07c</span> V86Es            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x080</span> V86Ds            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x084</span> V86Fs            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x088</span> V86Gs            : Uint4B</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>_ETHREAD</code></p>
<p>线程相关的结构体。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _ETHREAD
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_ETHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Tcb              : _KTHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> CreateTime       : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> NestedFaultCount : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span> Bits
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> ApcNeeded        : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> ExitTime         : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> LpcReplyChain    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> KeyedWaitChain   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d0</span> ExitStatus       : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d0</span> OfsChain         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d4</span> PostBlockList    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1dc</span> TerminationPort  : Ptr32 _TERMINATION_PORT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1dc</span> ReaperLink       : Ptr32 _ETHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1dc</span> KeyedWaitValue   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e0</span> ActiveTimerListLock : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e4</span> ActiveTimerListHead : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ec</span> Cid              : _CLIENT_ID
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f4</span> LpcReplySemaphore : _KSEMAPHORE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f4</span> KeyedWaitSemaphore : _KSEMAPHORE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x208</span> LpcReplyMessage  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x208</span> LpcWaitingOnPort : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x20c</span> ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x210</span> IrpList          : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x218</span> TopLevelIrp      : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x21c</span> DeviceToVerify   : Ptr32 _DEVICE_OBJECT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x220</span> ThreadsProcess   : Ptr32 _EPROCESS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x224</span> StartAddress     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x228</span> Win32StartAddress : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x228</span> LpcReceivedMessageId : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x22c</span> ThreadListEntry  : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x234</span> RundownProtect   : _EX_RUNDOWN_REF
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x238</span> ThreadLock       : _EX_PUSH_LOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x23c</span> LpcReplyMessageId : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x240</span> ReadClusterSize  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x244</span> GrantedAccess    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> CrossThreadFlags : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Terminated       : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> DeadThread       : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> HideFromDebugger : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> ActiveImpersonationInfo : Pos <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SystemThread     : Pos <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> HardErrorsAreDisabled : Pos <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> BreakOnTermination : Pos <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SkipCreationMsg  : Pos <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SkipTerminationMsg : Pos <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> SameThreadPassiveFlags : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> ActiveExWorker   : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> ExWorkerCanWaitUser : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> MemoryMaker      : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> SameThreadApcFlags : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> LpcReceivedMsgIdValid : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> LpcExitThreadCalled : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> AddressSpaceOwner : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x254</span> ForwardClusterOnly : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x255</span> DisablePageFaultClustering : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x258</span> KernelStackReference : Uint4B</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>其中，<code>Tcb</code>成员又是一个子结构体：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _KTHREAD
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_KTHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Header           : _DISPATCHER_HEADER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> MutantListHead   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> InitialStack     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> StackLimit       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Teb              : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> TlsArray         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> KernelStack      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> DebugActive      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02d</span> State            : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02e</span> Alerted          : [<span style="color:#ae81ff">2</span>] UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> Iopl             : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x031</span> NpxState         : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x032</span> Saturation       : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x033</span> Priority         : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> ApcState         : _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> ContextSwitches  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> IdleSwapBlock    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x051</span> VdmSafe          : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x052</span> Spare0           : [<span style="color:#ae81ff">2</span>] UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> WaitStatus       : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> WaitIrql         : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x059</span> WaitMode         : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05a</span> WaitNext         : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05b</span> WaitReason       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05c</span> WaitBlockList    : Ptr32 _KWAIT_BLOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> WaitListEntry    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> SwapListEntry    : _SINGLE_LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x068</span> WaitTime         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06c</span> BasePriority     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06d</span> DecrementCount   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06e</span> PriorityDecrement : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06f</span> Quantum          : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x070</span> WaitBlock        : [<span style="color:#ae81ff">4</span>] _KWAIT_BLOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d0</span> LegoData         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d4</span> KernelApcDisable : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d8</span> UserAffinity     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dc</span> SystemAffinityActive : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dd</span> PowerState       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0de</span> NpxIrql          : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0df</span> InitialNode      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e0</span> ServiceTable     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e4</span> Queue            : Ptr32 _KQUEUE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e8</span> ApcQueueLock     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0f0</span> Timer            : _KTIMER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x118</span> QueueListEntry   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> SoftAffinity     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x124</span> Affinity         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x128</span> Preempted        : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x129</span> ProcessReadyQueue : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12a</span> KernelStackResident : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12b</span> NextProcessor    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12c</span> CallbackStack    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x130</span> Win32Thread      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x134</span> TrapFrame        : Ptr32 _KTRAP_FRAME
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x138</span> ApcStatePointer  : [<span style="color:#ae81ff">2</span>] Ptr32 _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x140</span> PreviousMode     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x141</span> EnableStackSwap  : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x142</span> LargeStack       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x143</span> ResourceIndex    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x144</span> KernelTime       : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x148</span> UserTime         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x14c</span> SavedApcState    : _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x164</span> Alertable        : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x165</span> ApcStateIndex    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x166</span> ApcQueueable     : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x167</span> AutoAlignment    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x168</span> StackBase        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x16c</span> SuspendApc       : _KAPC
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x19c</span> SuspendSemaphore : _KSEMAPHORE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b0</span> ThreadListEntry  : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b8</span> FreezeCount      : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b9</span> SuspendCount     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ba</span> IdealProcessor   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1bb</span> DisableBoost     : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>KPCR</code></p>
<p><code>CPU</code>控制区（<code>Processor Control Region</code>），描述当前<code>CPU</code>的各种状态</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _KPCR
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_KPCR
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> NtTib            : _NT_TIB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> SelfPcr          : Ptr32 _KPCR
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Prcb             : Ptr32 _KPRCB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> Irql             : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> IRR              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> IrrActive        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> IDR              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> KdVersionBlock   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> IDT              : Ptr32 _KIDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> GDT              : Ptr32 _KGDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> TSS              : Ptr32 _KTSS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> MajorVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x046</span> MinorVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x048</span> SetMember        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> StallScaleFactor : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> DebugActive      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x051</span> Number           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x052</span> Spare0           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x053</span> SecondLevelCacheAssociativity : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> VdmAlert         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> KernelReserved   : [<span style="color:#ae81ff">14</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x090</span> SecondLevelCacheSize : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x094</span> HalReserved      : [<span style="color:#ae81ff">16</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d4</span> InterruptMode    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d8</span> Spare1           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dc</span> KernelReserved2  : [<span style="color:#ae81ff">17</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> PrcbData         : _KPRCB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p><code>_KiSystemServise</code></p>
<p>可以对比下面的这张图（紫色的成员在保护模式下没有被使用）：</p>
<p><img src="https://c65mael.github.io/myassets/TF.png" alt="image" loading="lazy" /></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407631</span> <span style="color:#a6e22e">_KiSystemService</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>              <span style="color:#75715e">; CODE XREF: ZwAcceptConnectPort(x,x,x,x,x,x)+C↑p
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407631</span>                                         <span style="color:#75715e">; ZwAccessCheck(x,x,x,x,x,x,x,x)+C↑p ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407631</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407631</span> <span style="color:#a6e22e">arg_0</span>           <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span>  <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407631</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407631</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; 在执行这一行时0x68~0x78已经压入栈中了，所以这个0是压入ErrCode
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407633</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407634</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407635</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407636</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407637</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">fs</span>              <span style="color:#75715e">; 到这里是压入图中绿色的寄存器（到0x50）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407639</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">30</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040763</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">fs</span>, <span style="color:#66d9ef">ebx</span>         <span style="color:#75715e">; 将0x30作为段选择子加载到FS段寄存器中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040763</span><span style="color:#a6e22e">E</span>                                         <span style="color:#75715e">; 0x30 =&gt; 0011 0 0 00
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040763</span><span style="color:#a6e22e">E</span>                                         <span style="color:#75715e">; 是查GDT表索引为6的段描述符：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040763</span><span style="color:#a6e22e">E</span>                                         <span style="color:#75715e">; ffc093df`f0000001
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040763</span><span style="color:#a6e22e">E</span>                                         <span style="color:#75715e">; addr = ffdff000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040763</span><span style="color:#a6e22e">E</span>                                         <span style="color:#75715e">; addr指向cpu的_KPCR结构
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407640</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF000h</span> <span style="color:#75715e">; 压入旧的ExecptionList(图中的0x4c)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407640</span>                                         <span style="color:#75715e">; 就是第一个子成员的第一个成员（_KPCR[0] =&gt; _TIB[0] =&gt; ExecptionList）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407646</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF000h</span>, -<span style="color:#ae81ff">1</span> <span style="color:#75715e">; 将新的ExecptionList置为-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407650</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF124h</span> <span style="color:#75715e">; _KPCR[0x120] =&gt; _KPCB[0x4] =&gt; CurrentThread(当前CPU所执行线程的_ETHREAD)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407656</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">140</span><span style="color:#66d9ef">h</span>] <span style="color:#75715e">; _ETHREAD[0x140] =&gt; _KTHREAD[0x140] =&gt; PreviousMode(先前模式)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040765</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">48</span><span style="color:#66d9ef">h</span>        <span style="color:#75715e">; 提升堆栈到图中的0x00的位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040765</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">arg_0</span>] <span style="color:#75715e">; 就是0x6c的位置，是之前CS的值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407663</span>                 <span style="color:#a6e22e">and</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">1</span>          <span style="color:#75715e">; 0环最低位为0，3环最低位为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407666</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">140</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">bl</span>  <span style="color:#75715e">; 存入新的&#34;先前模式&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040766</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>        <span style="color:#75715e">; 将ebp也改为指向图中0x00的位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040766</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">134</span><span style="color:#66d9ef">h</span>] <span style="color:#75715e">; ebx指向_KTHREAD[0x134] =&gt; TrapFrame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407674</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>], <span style="color:#66d9ef">ebx</span>  <span style="color:#75715e">; 将TrapFrame临时存在edx（_Trap_Frame[0x3c] =&gt; edx）中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407677</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">134</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">ebp</span> <span style="color:#75715e">; 将新的TrapFrame写回
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040767</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">cld</span>                     <span style="color:#75715e">; Clear Direction Flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040767</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">60</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; ebx = ebp（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407681</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; edi = eip（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407684</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span>], <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407687</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">BADB0D00h</span> <span style="color:#75715e">; 存入标志
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040768</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">ebx</span>    <span style="color:#75715e">; 存入调试ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407691</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>], <span style="color:#66d9ef">edi</span>    <span style="color:#75715e">; 存入调试eip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407694</span>                 <span style="color:#a6e22e">test</span>    <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFh</span> <span style="color:#75715e">; 判断是否是调试状态（DebugActive == -1）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407698</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">Dr_kss_a</span>        <span style="color:#75715e">; 是，跳过去的流程主要是将调试寄存器dr0~dr7赋值（0x18~0x2c）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040769</span><span style="color:#a6e22e">E</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040769</span><span style="color:#a6e22e">E</span> <span style="color:#66d9ef">loc_40769E</span>:                             <span style="color:#75715e">; CODE XREF: Dr_kss_a+10↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040769</span><span style="color:#a6e22e">E</span>                                         <span style="color:#75715e">; Dr_kss_a+7C↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040769</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">sti</span>                     <span style="color:#75715e">; Set Interrupt Flag
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040769</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">loc_407781</span>      <span style="color:#75715e">; _KiFastCallEntry的后面
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040769</span><span style="color:#a6e22e">F</span> <span style="color:#66d9ef">_KiSystemService</span> <span style="color:#66d9ef">endp</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>_KiFastCallEntry</code></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#66d9ef">_KiFastCallEntry</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>              <span style="color:#75715e">; DATA XREF: _KiTrap01+6F↓o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>                                         <span style="color:#75715e">; KiLoadFastSyscallMachineSpecificRegisters(x)+24↓o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#66d9ef">var_B</span>           <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> -<span style="color:#ae81ff">0</span><span style="color:#66d9ef">Bh</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#75715e">; FUNCTION CHUNK AT .text:004076C8 SIZE 00000023 BYTES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#75715e">; FUNCTION CHUNK AT .text:00407990 SIZE 00000014 BYTES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">23</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;#&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F5</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">30</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F7</span>                 <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">fs</span>              <span style="color:#75715e">; 一样将fs置为0x30
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F9</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ds</span>, <span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">FB</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">es</span>, <span style="color:#66d9ef">ecx</span>         <span style="color:#75715e">; 将ds和es都置为0x23
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">FD</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF040h</span> <span style="color:#75715e">; 将ecx置为_KPCR[0x40] =&gt; TSS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407703</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">esp</span>, [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>]    <span style="color:#75715e">; 将esp置为TSS[0x4] =&gt; esp0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407706</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">23</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;#&#39;       ; 存入0x23作为ss（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407708</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">edx</span>             <span style="color:#75715e">; 存入edx作为esp（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407709</span>                 <span style="color:#a6e22e">pushf</span>                   <span style="color:#75715e">; Push Flags Register onto the Stack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">A</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">A</span> <span style="color:#66d9ef">loc_40770A</span>:                             <span style="color:#75715e">; CODE XREF: _KiFastCallEntry2+22↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">2</span>               <span style="color:#75715e">; 存入cs（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">add</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">8</span>          <span style="color:#75715e">; Add
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">popf</span>                    <span style="color:#75715e">; eflag = 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407710</span>                 <span style="color:#a6e22e">or</span>      [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">var_B</span>], <span style="color:#ae81ff">2</span> <span style="color:#75715e">; 设置存入的eflag的第二个位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407715</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">1</span><span style="color:#66d9ef">Bh</span>             <span style="color:#75715e">; cs = 0x1b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407717</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDF0304h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040771</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; ErrCode = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040771</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407720</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407721</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407722</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">edi</span>             <span style="color:#75715e">; 对应存入直到图中的0x54
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407723</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF01Ch</span> <span style="color:#75715e">; ebx = _KPCR.SelfPcr（就是_KPCR自己的起始地址）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407729</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">3</span><span style="color:#66d9ef">Bh</span> <span style="color:#75715e">; &#39;;&#39;       ; fs = 0x3b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040772</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">esi</span>, [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">124</span><span style="color:#66d9ef">h</span>] <span style="color:#75715e">; esi = _KPCRB.CurrentThread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407731</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebx</span>] <span style="color:#75715e">; 保存旧ExceptionList
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407733</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebx</span>], -<span style="color:#ae81ff">1</span> <span style="color:#75715e">; 将新的ExceptionList置为-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407739</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebp</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; ebp = _KTHREAD.InitialStack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040773</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">1</span>               <span style="color:#75715e">; 将先前模式位置为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040773</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">48</span><span style="color:#66d9ef">h</span>        <span style="color:#75715e">; esp指向TrapFrame开始位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407741</span>                 <span style="color:#a6e22e">sub</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#ae81ff">29</span><span style="color:#66d9ef">Ch</span>       <span style="color:#75715e">; Integer Subtraction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407747</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">140</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">1</span> <span style="color:#75715e">; 将先前模式置为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040774</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>        <span style="color:#75715e">; Compare Two Operands
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407750</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">loc_4076C8</span>      <span style="color:#75715e">; Jump if Not Zero (ZF=0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407756</span>                 <span style="color:#a6e22e">and</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">0</span> <span style="color:#75715e">; Logical AND
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040775</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFh</span> <span style="color:#75715e">; DebugActive == -1 ？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040775</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">134</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">ebp</span> <span style="color:#75715e">; 替换TrapFrame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407764</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">Dr_FastCallDrSave</span> <span style="color:#75715e">; 是，跳过去的流程主要是将调试寄存器dr0~dr7赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span> <span style="color:#66d9ef">loc_40776A</span>:                             <span style="color:#75715e">; CODE XREF: Dr_FastCallDrSave+10↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span>                                         <span style="color:#75715e">; Dr_FastCallDrSave+7C↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">60</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; ebx = TrapFrame.Ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; edi = TrapFrame.Eip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407770</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span>], <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407773</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">BADB0D00h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040777</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040777</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>], <span style="color:#66d9ef">edi</span>    <span style="color:#75715e">; 赋值调试的寄存器0x00~0xc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407780</span>                 <span style="color:#a6e22e">sti</span>                     <span style="color:#960050;background-color:#1e0010">;</span> <span style="color:#66d9ef">Set</span> <span style="color:#66d9ef">Interrupt</span> <span style="color:#66d9ef">Flag</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h6>SystemServiceTable（系统服务表）<span class="hx-absolute -hx-mt-20" id="systemservicetable系统服务表"></span>
    <a href="#systemservicetable%e7%b3%bb%e7%bb%9f%e6%9c%8d%e5%8a%a1%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>如何根据系统服务号（<code>eax</code>中存储）找到要执行的内核函数？调用时参数是存储到<code>3</code>环的堆栈，如何传递给内核函数？</p>
<ul>
<li>
<p>结构如下：</p>
<p><img src="https://c65mael.github.io/myassets/SystemServiceTable.png" alt="image" loading="lazy" /></p>
<ol>
<li><code>ServiceTable</code>：存储了一个指针，指向函数地址表（存储函数的地址，<code>4</code>字节）。</li>
<li><code>Count</code>： 当前系统服务表调用了多少次。</li>
<li><code>ServiceLimit</code>：系统服务表中一共有多少个函数。</li>
<li><code>ArgmentTable</code>：存储了一个指针，指向函数参数表（函数有几个字节参数，<code>1</code>字节）。</li>
</ol>
<p>图上两个颜色是因为一个是<code>Ntoskrl.exe</code>导出的函数，一个是<code>Win32k.sys</code>导出的函数。可以通过<code>_KTHREAD[0xe0]</code>找到。</p>
</li>
<li>
<p>如何使用：</p>
<p><img src="https://c65mael.github.io/myassets/sstuse.png" alt="image" loading="lazy" /></p>
<ol>
<li>先看第<code>12</code>位是<code>0</code>还是<code>1</code>，<code>0</code>则用<code>Ntoskrl.exe</code>模块查，否则用<code>Win32k.sys</code>模块查。</li>
<li>后面的第<code>12</code>位则是对应函数地址表与函数参数表的索引（两个索引相同）。</li>
</ol>
<p><code>_KiFastCallEntry</code>：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#66d9ef">_KiFastCallEntry</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>              <span style="color:#75715e">; DATA XREF: _KiTrap01+6F↓o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>                                         <span style="color:#75715e">; KiLoadFastSyscallMachineSpecificRegisters(x)+24↓o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#66d9ef">var_B</span>           <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> -<span style="color:#ae81ff">0</span><span style="color:#66d9ef">Bh</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#75715e">; FUNCTION CHUNK AT .text:004076C8 SIZE 00000023 BYTES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span> <span style="color:#75715e">; FUNCTION CHUNK AT .text:00407990 SIZE 00000014 BYTES
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">23</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;#&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F5</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">30</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;0&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F7</span>                 <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">fs</span>              <span style="color:#75715e">; 一样将fs置为0x30
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">F9</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ds</span>, <span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">FB</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">es</span>, <span style="color:#66d9ef">ecx</span>         <span style="color:#75715e">; 将ds和es都置为0x23
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004076</span><span style="color:#a6e22e">FD</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF040h</span> <span style="color:#75715e">; 将ecx置为_KPCR[0x40] =&gt; TSS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407703</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">esp</span>, [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>]    <span style="color:#75715e">; 将esp置为TSS[0x4] =&gt; esp0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407706</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">23</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;#&#39;       ; 存入0x23作为ss（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407708</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">edx</span>             <span style="color:#75715e">; 存入edx作为esp（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407709</span>                 <span style="color:#a6e22e">pushf</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">A</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">A</span> <span style="color:#66d9ef">loc_40770A</span>:                             <span style="color:#75715e">; CODE XREF: _KiFastCallEntry2+22↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">2</span>               <span style="color:#75715e">; 存入cs（三环）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">add</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040770</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">popf</span>                    <span style="color:#75715e">; eflag = 2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407710</span>                 <span style="color:#a6e22e">or</span>      [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">var_B</span>], <span style="color:#ae81ff">2</span> <span style="color:#75715e">; 设置存入的eflag的第二个位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407715</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">1</span><span style="color:#66d9ef">Bh</span>             <span style="color:#75715e">; cs = 0x1b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407717</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDF0304h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040771</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; ErrCode = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040771</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407720</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407721</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407722</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">edi</span>             <span style="color:#75715e">; 对应存入直到图中的0x54
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407723</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF01Ch</span> <span style="color:#75715e">; ebx = _KPCR.SelfPcr（就是_KPCR自己的起始地址）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407729</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">3</span><span style="color:#66d9ef">Bh</span> <span style="color:#75715e">; &#39;;&#39;       ; fs = 0x3b
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040772</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">esi</span>, [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">124</span><span style="color:#66d9ef">h</span>] <span style="color:#75715e">; esi = _KPCRB.CurrentThread
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407731</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebx</span>] <span style="color:#75715e">; 保存旧ExceptionList
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407733</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebx</span>], -<span style="color:#ae81ff">1</span> <span style="color:#75715e">; 将新的ExceptionList置为-1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407739</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebp</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; ebp = _KTHREAD.InitialStack
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040773</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">1</span>               <span style="color:#75715e">; 将先前模式位置为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040773</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">48</span><span style="color:#66d9ef">h</span>        <span style="color:#75715e">; esp指向TrapFrame开始位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407741</span>                 <span style="color:#a6e22e">sub</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#ae81ff">29</span><span style="color:#66d9ef">Ch</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407747</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">140</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">1</span> <span style="color:#75715e">; 将先前模式置为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040774</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407750</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">loc_4076C8</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407756</span>                 <span style="color:#a6e22e">and</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040775</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFh</span> <span style="color:#75715e">; DebugActive == -1 ？
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040775</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">134</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">ebp</span> <span style="color:#75715e">; 替换TrapFrame
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407764</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">Dr_FastCallDrSave</span> <span style="color:#75715e">; 是，跳过去的流程主要是将调试寄存器dr0~dr7赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span> <span style="color:#66d9ef">loc_40776A</span>:                             <span style="color:#75715e">; CODE XREF: Dr_FastCallDrSave+10↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span>                                         <span style="color:#75715e">; Dr_FastCallDrSave+7C↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">60</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; ebx = TrapFrame.Ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040776</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; edi = TrapFrame.Eip
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407770</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span>], <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407773</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">BADB0D00h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040777</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span>], <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040777</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>], <span style="color:#66d9ef">edi</span>    <span style="color:#75715e">; 赋值调试的寄存器0x00~0xc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407780</span>                 <span style="color:#a6e22e">sti</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407781</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00407781</span> loc_407781:                             <span style="color:#75715e">; CODE XREF: _KiBBTUnexpectedRange+18↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407781</span>                                         <span style="color:#75715e">; _KiSystemService+6E↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407781</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">eax</span>        <span style="color:#75715e">; 取服务号赋值给edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407783</span>                 <span style="color:#a6e22e">shr</span>     <span style="color:#66d9ef">edi</span>, <span style="color:#ae81ff">8</span>          <span style="color:#75715e">; 右移8位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407786</span>                 <span style="color:#a6e22e">and</span>     <span style="color:#66d9ef">edi</span>, <span style="color:#ae81ff">110000</span><span style="color:#66d9ef">b</span>    <span style="color:#75715e">; 取第13和12位（从0开始），如果第12位为1，edi才是0x10（01 0000），否则是00（00 0000）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407786</span>                                         <span style="color:#75715e">; 通过这个偏移可以实现使用的是哪张服务表（一个服务表4*4=0x10）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407789</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">edi</span>        <span style="color:#75715e">; ecx = edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040778</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">add</span>     <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">E0h</span>] <span style="color:#75715e">; edi = _KTHREAD.ServiceTable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407791</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">eax</span>        <span style="color:#75715e">; eax = ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407793</span>                 <span style="color:#a6e22e">and</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">111111111111</span><span style="color:#66d9ef">b</span> <span style="color:#75715e">; 只要系统调用号的后12位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00407798</span>                 <span style="color:#a6e22e">cmp</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]    <span style="color:#75715e">; 比较这个服务号是否在_SYSTEM_SERVICE_TABLE.ServiceLimit（有多少个函数）中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040779</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">jnb</span>     <span style="color:#66d9ef">_KiBBTUnexpectedRange</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">A1</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">10000</span><span style="color:#66d9ef">b</span>     <span style="color:#75715e">; 比较之前的那个第12位是否是1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">A4</span>                 <span style="color:#66d9ef">jnz</span>     <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_4077C0</span> <span style="color:#75715e">; 查找第一个系统服务表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">A6</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF018h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">AC</span>                 <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">AE</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">AE</span> <span style="color:#66d9ef">loc_4077AE</span>:                             <span style="color:#75715e">; DATA XREF: _KiTrap0E+110↓o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">AE</span>                 <span style="color:#66d9ef">or</span>      <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">F70h</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">B4</span>                 <span style="color:#66d9ef">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_4077C0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">B6</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">B7</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">B8</span>                 <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ds</span>:<span style="color:#66d9ef">_KeGdiFlushUserBatch</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">BE</span>                 <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">BF</span>                 <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C0</span> <span style="color:#66d9ef">loc_4077C0</span>:                             <span style="color:#75715e">; CODE XREF: _KiFastCallEntry+B4↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C0</span>                                         <span style="color:#75715e">; _KiFastCallEntry+C4↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C0</span>                 <span style="color:#66d9ef">inc</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF638h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C6</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">edx</span>        <span style="color:#75715e">; esi = edx（三环参数的指针（lea edx, [esp+arg_4]））
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C8</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span>]  <span style="color:#75715e">; ebx = _SYSTEM_SERVICE_TABLE.ArgmentTable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">CB</span>                 <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ecx</span>        <span style="color:#75715e">; 清空ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">CD</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">cl</span>, [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">ebx</span>]   <span style="color:#75715e">; cl = 这个系统调用对应的参数的字节大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">edi</span>]      <span style="color:#75715e">; edi = _SYSTEM_SERVICE_TABLE.ServiecTable（函数地址表）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D2</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">eax</span>*<span style="color:#ae81ff">4</span>] <span style="color:#75715e">; ebx = 0环函数的地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D5</span>                 <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">ecx</span>        <span style="color:#75715e">; 提升对应的参数个数个堆栈（这里的ecx是要执行的参数的字节大小）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D7</span>                 <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">2</span>          <span style="color:#75715e">; 参数长度/4 = 参数个数（四字节），一次拷贝4字节，这是拷贝的次数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">DA</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">esp</span>        <span style="color:#75715e">; edi指向函数参数的位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">DC</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#66d9ef">_MmUserProbeAddress</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">E2</span>                 <span style="color:#66d9ef">jnb</span>     <span style="color:#66d9ef">loc_407990</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">E8</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">E8</span> <span style="color:#66d9ef">loc_4077E8</span>:                             <span style="color:#75715e">; CODE XREF: _KiFastCallEntry+2A4↓j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">E8</span>                                         <span style="color:#75715e">; DATA XREF: _KiTrap0E+106↓o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">E8</span>                 <span style="color:#66d9ef">rep</span> <span style="color:#66d9ef">movsd</span>               <span style="color:#75715e">; 循环拷贝
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">EA</span>                 <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ebx</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h6>SSDT<span class="hx-absolute -hx-mt-20" id="ssdt"></span>
    <a href="#ssdt" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>除了可以用<code>_KTHREAD[0xe0]</code>可以访问，还可以使用<code>SSDT</code>访问（<code>System Services Descriptor Table</code>，系统服务描述表）。它是<code>ntoskrnl.exe</code>导出的一个全局变量</p>
<ul>
<li>
<p>查看：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">dd</span> <span style="color:#66d9ef">KeServiceDescriptorTable</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">fa0</span>  <span style="color:#ae81ff">80502</span><span style="color:#66d9ef">b8c</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">0000011</span><span style="color:#66d9ef">c</span> <span style="color:#ae81ff">80503000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">fb0</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">fc0</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">fd0</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>SSDT</code>的每一个成员都是系统服务表，一共有四个成员（也就是四个系统服务表，但后两个未使用）。通过上面的指令我们只能看到一张表（<code>ntoskrnl.exe</code>的）</p>
<p>查看完整的<code>SSDT</code>：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">dd</span> <span style="color:#66d9ef">KeServiceDescriptorTableShadow</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">f60</span>  <span style="color:#ae81ff">80502</span><span style="color:#66d9ef">b8c</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">0000011</span><span style="color:#66d9ef">c</span> <span style="color:#ae81ff">80503000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">f70</span>  <span style="color:#66d9ef">bf999b80</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">0000029</span><span style="color:#66d9ef">b</span> <span style="color:#66d9ef">bf99a890</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">f80</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80553</span><span style="color:#a6e22e">f90</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>SSDT Shadow</code>是未导出的，所以要通过其他的方法获取。</p>
<ul>
<li>第一个成员（<code>80502b8c</code>）：函数地址表</li>
<li>第二个成员（<code>00000000</code>）：这个服务表被访问了多少次</li>
<li>第三个成员（<code>0000011c</code>）：这个服务表一共有多少个函数</li>
<li>第四个函数（<code>80503000</code>）：函数参数表</li>
</ul>
</li>
</ul>
<h3>进程与线程<span class="hx-absolute -hx-mt-20" id="进程与线程"></span>
    <a href="#%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>进程结构体<span class="hx-absolute -hx-mt-20" id="进程结构体"></span>
    <a href="#%e8%bf%9b%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p><code>EPROCESS</code></p>
<p>每个<code>windows</code>进程在<code>0</code>环都有一个对应的结构体（<code>EPROCESS</code>），这个结构体包含了进程所有重要的信息。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _EPROCESS
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_EPROCESS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Pcb              : _KPROCESS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06c</span> ProcessLock      : _EX_PUSH_LOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x070</span> CreateTime       : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x078</span> ExitTime         : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x080</span> RundownProtect   : _EX_RUNDOWN_REF
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x084</span> UniqueProcessId  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x088</span> ActiveProcessLinks : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x090</span> QuotaUsage       : [<span style="color:#ae81ff">3</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x09c</span> QuotaPeak        : [<span style="color:#ae81ff">3</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0a8</span> CommitCharge     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0ac</span> PeakVirtualSize  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b0</span> VirtualSize      : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0b4</span> SessionProcessLinks : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0bc</span> DebugPort        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c0</span> ExceptionPort    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c4</span> ObjectTable      : Ptr32 _HANDLE_TABLE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c8</span> Token            : _EX_FAST_REF
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0cc</span> WorkingSetLock   : _FAST_MUTEX
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0ec</span> WorkingSetPage   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0f0</span> AddressCreationLock : _FAST_MUTEX
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x110</span> HyperSpaceLock   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x114</span> ForkInProgress   : Ptr32 _ETHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x118</span> HardwareTrigger  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x11c</span> VadRoot          : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> VadHint          : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x124</span> CloneRoot        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x128</span> NumberOfPrivatePages : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12c</span> NumberOfLockedPages : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x130</span> Win32Process     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x134</span> Job              : Ptr32 _EJOB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x138</span> SectionObject    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x13c</span> SectionBaseAddress : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x140</span> QuotaBlock       : Ptr32 _EPROCESS_QUOTA_BLOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x144</span> WorkingSetWatch  : Ptr32 _PAGEFAULT_HISTORY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x148</span> Win32WindowStation : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x14c</span> InheritedFromUniqueProcessId : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x150</span> LdtInformation   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x154</span> VadFreeHint      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x158</span> VdmObjects       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x15c</span> DeviceMap        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x160</span> PhysicalVadList  : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x168</span> PageDirectoryPte : _HARDWARE_PTE_X86
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x168</span> Filler           : Uint8B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x170</span> Session          : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x174</span> ImageFileName    : [<span style="color:#ae81ff">16</span>] UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x184</span> JobLinks         : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x18c</span> LockedPagesList  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x190</span> ThreadListHead   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x198</span> SecurityPort     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x19c</span> PaeTop           : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a0</span> ActiveThreads    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a4</span> GrantedAccess    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a8</span> DefaultHardErrorProcessing : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ac</span> LastThreadExitStatus : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b0</span> Peb              : Ptr32 _PEB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b4</span> PrefetchTrace    : _EX_FAST_REF
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b8</span> ReadOperationCount : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> WriteOperationCount : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> OtherOperationCount : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d0</span> ReadTransferCount : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d8</span> WriteTransferCount : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e0</span> OtherTransferCount : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e8</span> CommitChargeLimit : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ec</span> CommitChargePeak : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f0</span> AweInfo          : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f4</span> SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f8</span> Vm               : _MMSUPPORT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x238</span> LastFaultCount   : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x23c</span> ModifiedPageCount : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x240</span> NumberOfVads     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x244</span> JobStatus        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Flags            : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> CreateReported   : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> NoDebugInherit   : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> ProcessExiting   : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> ProcessDelete    : Pos <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Wow64SplitPages  : Pos <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> VmDeleted        : Pos <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> OutswapEnabled   : Pos <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Outswapped       : Pos <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> ForkFailed       : Pos <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> HasPhysicalVad   : Pos <span style="color:#ae81ff">9</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> AddressSpaceInitialized : Pos <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">2</span> Bits
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SetTimerResolution : Pos <span style="color:#ae81ff">12</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> BreakOnTermination : Pos <span style="color:#ae81ff">13</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SessionCreationUnderway : Pos <span style="color:#ae81ff">14</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> WriteWatch       : Pos <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> ProcessInSession : Pos <span style="color:#ae81ff">16</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> OverrideAddressSpace : Pos <span style="color:#ae81ff">17</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> HasAddressSpace  : Pos <span style="color:#ae81ff">18</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> LaunchPrefetched : Pos <span style="color:#ae81ff">19</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> InjectInpageErrors : Pos <span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> VmTopDown        : Pos <span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Unused3          : Pos <span style="color:#ae81ff">22</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Unused4          : Pos <span style="color:#ae81ff">23</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> VdmAllowed       : Pos <span style="color:#ae81ff">24</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Unused           : Pos <span style="color:#ae81ff">25</span>, <span style="color:#ae81ff">5</span> Bits
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Unused1          : Pos <span style="color:#ae81ff">30</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Unused2          : Pos <span style="color:#ae81ff">31</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> ExitStatus       : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> NextPageColor    : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x252</span> SubSystemMinorVersion : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x253</span> SubSystemMajorVersion : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x252</span> SubSystemVersion : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x254</span> PriorityClass    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x255</span> WorkingSetAcquiredUnsafe : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x258</span> Cookie           : Uint4B</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>第一个子成员为<code>KPROCESS</code>：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _KPROCESS
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_KPROCESS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Header           : _DISPATCHER_HEADER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> ProfileListHead  : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> DirectoryTableBase : [<span style="color:#ae81ff">2</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> LdtDescriptor    : _KGDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> Int21Descriptor  : _KIDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> IopmOffset       : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x032</span> Iopl             : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x033</span> Unused           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> ActiveProcessors : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> KernelTime       : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> UserTime         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> ReadyListHead    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x048</span> SwapListEntry    : _SINGLE_LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> VdmTrapcHandler  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> ThreadListHead   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> ProcessLock      : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05c</span> Affinity         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> StackCount       : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x062</span> BasePriority     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x063</span> ThreadQuantum    : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x064</span> AutoAlignment    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x065</span> State            : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x066</span> ThreadSeed       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x067</span> DisableBoost     : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x068</span> PowerState       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x069</span> DisableQuantum   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06a</span> IdealNode        : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06b</span> Flags            : _KEXECUTE_OPTIONS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06b</span> ExecuteOptions   : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>KPROCESS</code>中一些重要的成员：</p>
<ul>
<li>
<p><code>Header</code></p>
<p><code>KPROCESS</code>的第一个成员，以它开头的内核对象可以被<code>WaitForSingleObject</code>函数所等待（比如<code>Mutex</code>互斥体，<code>Event</code>事件等）</p>
</li>
<li>
<p><code>DirectoryTableBase</code></p>
<p><code>KPROCESS[0x18]</code>，为页目录表基址。</p>
</li>
<li>
<p><code>KernelTime | UserTime</code></p>
<p><code>KPROCESS[0x38~0x3c]</code>，在<code>0</code>环和在<code>3</code>环的运行时间。</p>
</li>
<li>
<p><code>Affinity</code></p>
<p><code>KPROCESS[0x5c]</code>，规定进程里面的所有线程能在哪个<code>CPU</code>上跑。</p>
<p>如果为<code>1</code>（<code>00000001</code>），只能在<code>0</code>号<code>CPU</code>上跑。</p>
<p>如果为<code>3</code>（<code>00000011</code>），只能在<code>0、1</code>号<code>CPU</code>上跑。</p>
<p>如果为<code>5</code>（<code>00000101</code>），只能在<code>0、2</code>号<code>CPU</code>上跑。</p>
<p><code>32</code>位下这个成员为<code>4</code>字节，共<code>32</code>位，<code>32</code>个核；<code>64</code>位下这个成员为<code>8</code>字节，也就是<code>64</code>个核。</p>
</li>
<li>
<p><code>BasePriority</code></p>
<p><code>KPROCESS[0x62]</code>，基础优先级或最低优先级，该进程中最起始创建的优先级。</p>
</li>
</ul>
</li>
<li>
<p><code>EPROCESS</code>中一些重要的成员：</p>
<ul>
<li>
<p><code>CreateTime | ExitTime</code></p>
<p><code>EPROCESS[0x70~0x78]</code>，进程何时创建的和何时退出的。</p>
</li>
<li>
<p><code>UniqueProcessId</code></p>
<p><code>EPROCESS[0x84]</code>，进程的<code>PID</code>。</p>
</li>
<li>
<p><code>ActiveProcessLinks</code></p>
<p><code>EPROCESS[0x88]</code>，所有的活动进程都连接在一起，构成的双向链表。全局变量<code>PsActiveProcessHead</code>指向这个全局链的表头。</p>
<p><img src="https://c65mael.github.io/myassets/APL.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p><code>QuotaUsage | QuotaPeak</code></p>
<p><code>EPROCESS[0x90~0x9c]</code>，物理页相关的统计信息。</p>
</li>
<li>
<p><code>CommitCharge | PeakVirtualSize | VirtualSize</code></p>
<p><code>EPROCESS[0xa8~0xb0]</code>，虚拟内存相关的统计信息。</p>
</li>
<li>
<p><code>VadRoot</code></p>
<p><code>EPROCESS[0x11c]</code>，进程的线性地址的使用情况和记录（<code>0~2G</code>哪些地址没有占用）。</p>
</li>
<li>
<p><code>DebugPort | ExceptionPort</code></p>
<p><code>EPROCESS[0xbc~0xc0]</code>，调试相关，<code>DebugPort</code>清零实现反调试。</p>
</li>
<li>
<p><code>ObjectTable</code></p>
<p><code>EPROCESS[0xc4]</code>，句柄表，会存储这个进程中所有内核对象的地址。</p>
</li>
<li>
<p><code>ImageFileName</code></p>
<p><code>EPROCESS[0x174]</code>，进程镜像文件名，最多<code>16</code>个字节。</p>
</li>
<li>
<p><code>ActiveThreads</code></p>
<p><code>EPROCESS[0x1a0]</code>，活动线程的数量。</p>
</li>
<li>
<p><code>Peb</code></p>
<p><code>EPROCESS[0x1b0]</code>，进程环境块，是进程在<code>3</code>环的一个结构体，里面包含了进程的模块列表、是否处于调试状态等信息。</p>
<p>在<code>PEB[0xc]</code>处为<code>+0x00c Ldr              : Ptr32 _PEB_LDR_DATA</code></p>
<p>看一下这个结构，有三个双向链表：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _PEB_LDR_DATA
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_PEB_LDR_DATA
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Length           : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> Initialized      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> SsHandle         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> InLoadOrderModuleList : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> InMemoryOrderModuleList : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> InInitializationOrderModuleList : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> EntryInProgress  : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>InLoadOrderModuleList</code>：该模块加载的顺序</p>
<p><code>InMemoryOrderModuleList</code>：该模块在内存中的顺序</p>
<p><code>InInitializationOrderModuleList</code>：该模块初始化的顺序</p>
</li>
</ul>
</li>
</ul>
<h6>线程结构体<span class="hx-absolute -hx-mt-20" id="线程结构体"></span>
    <a href="#%e7%ba%bf%e7%a8%8b%e7%bb%93%e6%9e%84%e4%bd%93" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p><code>ETHREAD</code></p>
<p>每个线程对于的结构体：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _ETHREAD
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_ETHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Tcb              : _KTHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> CreateTime       : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> NestedFaultCount : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">2</span> Bits
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c0</span> ApcNeeded        : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> ExitTime         : _LARGE_INTEGER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> LpcReplyChain    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1c8</span> KeyedWaitChain   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d0</span> ExitStatus       : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d0</span> OfsChain         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1d4</span> PostBlockList    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1dc</span> TerminationPort  : Ptr32 _TERMINATION_PORT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1dc</span> ReaperLink       : Ptr32 _ETHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1dc</span> KeyedWaitValue   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e0</span> ActiveTimerListLock : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1e4</span> ActiveTimerListHead : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ec</span> Cid              : _CLIENT_ID
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f4</span> LpcReplySemaphore : _KSEMAPHORE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1f4</span> KeyedWaitSemaphore : _KSEMAPHORE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x208</span> LpcReplyMessage  : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x208</span> LpcWaitingOnPort : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x20c</span> ImpersonationInfo : Ptr32 _PS_IMPERSONATION_INFORMATION
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x210</span> IrpList          : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x218</span> TopLevelIrp      : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x21c</span> DeviceToVerify   : Ptr32 _DEVICE_OBJECT
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x220</span> ThreadsProcess   : Ptr32 _EPROCESS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x224</span> StartAddress     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x228</span> Win32StartAddress : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x228</span> LpcReceivedMessageId : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x22c</span> ThreadListEntry  : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x234</span> RundownProtect   : _EX_RUNDOWN_REF
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x238</span> ThreadLock       : _EX_PUSH_LOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x23c</span> LpcReplyMessageId : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x240</span> ReadClusterSize  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x244</span> GrantedAccess    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> CrossThreadFlags : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> Terminated       : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> DeadThread       : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> HideFromDebugger : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> ActiveImpersonationInfo : Pos <span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SystemThread     : Pos <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> HardErrorsAreDisabled : Pos <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> BreakOnTermination : Pos <span style="color:#ae81ff">6</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SkipCreationMsg  : Pos <span style="color:#ae81ff">7</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x248</span> SkipTerminationMsg : Pos <span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> SameThreadPassiveFlags : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> ActiveExWorker   : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> ExWorkerCanWaitUser : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x24c</span> MemoryMaker      : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> SameThreadApcFlags : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> LpcReceivedMsgIdValid : Pos <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> LpcExitThreadCalled : Pos <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x250</span> AddressSpaceOwner : Pos <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span> Bit
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x254</span> ForwardClusterOnly : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x255</span> DisablePageFaultClustering : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>第一个子成员为<code>KTHREAD</code>：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _KTHREAD
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_KTHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> Header           : _DISPATCHER_HEADER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> MutantListHead   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> InitialStack     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> StackLimit       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Teb              : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> TlsArray         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> KernelStack      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> DebugActive      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02d</span> State            : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02e</span> Alerted          : [<span style="color:#ae81ff">2</span>] UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> Iopl             : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x031</span> NpxState         : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x032</span> Saturation       : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x033</span> Priority         : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> ApcState         : _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> ContextSwitches  : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> IdleSwapBlock    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x051</span> Spare0           : [<span style="color:#ae81ff">3</span>] UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> WaitStatus       : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> WaitIrql         : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x059</span> WaitMode         : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05a</span> WaitNext         : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05b</span> WaitReason       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x05c</span> WaitBlockList    : Ptr32 _KWAIT_BLOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> WaitListEntry    : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> SwapListEntry    : _SINGLE_LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x068</span> WaitTime         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06c</span> BasePriority     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06d</span> DecrementCount   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06e</span> PriorityDecrement : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06f</span> Quantum          : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x070</span> WaitBlock        : [<span style="color:#ae81ff">4</span>] _KWAIT_BLOCK
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d0</span> LegoData         : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d4</span> KernelApcDisable : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d8</span> UserAffinity     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dc</span> SystemAffinityActive : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dd</span> PowerState       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0de</span> NpxIrql          : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0df</span> InitialNode      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e0</span> ServiceTable     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e4</span> Queue            : Ptr32 _KQUEUE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e8</span> ApcQueueLock     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0f0</span> Timer            : _KTIMER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x118</span> QueueListEntry   : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> SoftAffinity     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x124</span> Affinity         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x128</span> Preempted        : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x129</span> ProcessReadyQueue : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12a</span> KernelStackResident : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12b</span> NextProcessor    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x12c</span> CallbackStack    : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x130</span> Win32Thread      : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x134</span> TrapFrame        : Ptr32 _KTRAP_FRAME
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x138</span> ApcStatePointer  : [<span style="color:#ae81ff">2</span>] Ptr32 _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x140</span> PreviousMode     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x141</span> EnableStackSwap  : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x142</span> LargeStack       : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x143</span> ResourceIndex    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x144</span> KernelTime       : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x148</span> UserTime         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x14c</span> SavedApcState    : _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x164</span> Alertable        : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x165</span> ApcStateIndex    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x166</span> ApcQueueable     : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x167</span> AutoAlignment    : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x168</span> StackBase        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x16c</span> SuspendApc       : _KAPC
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x19c</span> SuspendSemaphore : _KSEMAPHORE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b0</span> ThreadListEntry  : _LIST_ENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b8</span> FreezeCount      : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b9</span> SuspendCount     : Char
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ba</span> IdealProcessor   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1bb</span> DisableBoost     : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>KTHREAD</code>中一些重要的成员：</p>
<ul>
<li>
<p><code>Header</code></p>
<p><code>KPROCESS</code>的第一个成员，以它开头的内核对象可以被<code>WaitForSingleObject</code>函数所等待（比如<code>Mutex</code>互斥体，<code>Event</code>事件等）</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> InitialStack     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> StackLimit       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> KernelStack      : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>与线程切换相关</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Teb              : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>线程环境块，大小<code>4KB</code>，位于用户地址空间。<code>FS:[0] -&gt; TEB</code>（三环时，零环时为<code>KPCR</code>）</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> DebugActive      : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>如果值为<code>-1</code>，就不能使用调试寄存器：<code>Dr0~Dr7</code></p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> ApcState         : _KAPC_STATE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e8</span> ApcQueueLock     : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x14c</span> SavedApcState    : _KAPC_STATE</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>APC</code>相关。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02d</span> State            : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>线程状态，就绪、等待还是运行。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x06c</span> BasePriority     : Char</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>其初始值所属进程的<code>KPROCESS -&gt; BasePriority</code>值，以后可以通过<code>KeSetBasePriorityThread()</code>函数重新设定。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x070</span> WaitBlock        : [<span style="color:#ae81ff">4</span>] _KWAIT_BLOCK</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>WaitForSingleObject()</code>等待哪个对象。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0e0</span> ServiceTable     : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向系统服务表基地址。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x134</span> TrapFrame        : Ptr32 _KTRAP_FRAME</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>进<code>0</code>环时保存环境。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x140</span> PreviousMode     : Char</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>先前模式。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1b0</span> ThreadListEntry  : _LIST_ENTRY</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>双向链表一个进程所有的线程，都挂在一个链表中，挂的就是这个位置，一共有两个这样的链表。</p>
<p>结构如下：</p>
<p><img src="https://c65mael.github.io/myassets/ET.png" alt="image" loading="lazy" /></p>
</li>
</ul>
</li>
<li>
<p><code>ETHREAD</code>中一些重要的成员：</p>
<ul>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1ec</span> Cid              : _CLIENT_ID
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   ntdll<span style="color:#f92672">!</span>_CLIENT_ID
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> UniqueProcess    : Ptr32 Void		<span style="color:#75715e">//这个线程属于哪个进程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> UniqueThread     : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>进程<code>ID</code>，线程<code>ID</code></p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x220</span> ThreadsProcess   : Ptr32 _EPROCESS</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向自己所属的进程。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x22c</span> ThreadListEntry  : _LIST_ENTRY</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>双向链表一个进程所有的线程，都挂在一个链表中，挂的就是这个位置，一共有两个这样的链表。</p>
</li>
</ul>
</li>
</ul>
<h6>KPCR<span class="hx-absolute -hx-mt-20" id="kpcr"></span>
    <a href="#kpcr" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>当运行的<code>CPU</code>需要一些结构体来存储数据</p>
<ul>
<li>
<p>属性：</p>
<ol>
<li>当进入<code>0</code>环时，<code>FS[0] -&gt; KPCR</code>（<code>3</code>环指向<code>TEB</code>）</li>
<li>一个<code>CPU</code>一个<code>KPCR</code>。</li>
<li><code>KPCR</code>存储了<code>CPU</code>需要的一些重要的数据：<code>GDT</code>、<code>IDT</code>和线程相关的一些信息。</li>
</ol>
</li>
<li>
<p>结构：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _KPCR
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_KPCR
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> NtTib            : _NT_TIB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> SelfPcr          : Ptr32 _KPCR
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Prcb             : Ptr32 _KPRCB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> Irql             : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> IRR              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> IrrActive        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> IDR              : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> KdVersionBlock   : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> IDT              : Ptr32 _KIDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> GDT              : Ptr32 _KGDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> TSS              : Ptr32 _KTSS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> MajorVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x046</span> MinorVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x048</span> SetMember        : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> StallScaleFactor : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> DebugActive      : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x051</span> Number           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x052</span> Spare0           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x053</span> SecondLevelCacheAssociativity : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> VdmAlert         : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> KernelReserved   : [<span style="color:#ae81ff">14</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x090</span> SecondLevelCacheSize : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x094</span> HalReserved      : [<span style="color:#ae81ff">16</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d4</span> InterruptMode    : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d8</span> Spare1           : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dc</span> KernelReserved2  : [<span style="color:#ae81ff">17</span>] Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> PrcbData         : _KPRCB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>第一个子成员为<code>NT_TIB</code>：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _NT_TIB
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_NT_TIB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> StackBase        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> StackLimit       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> SubSystemTib     : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> FiberData        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> Version          : Uint4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> ArbitraryUserPointer : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> Self             : Ptr32 _NT_TIB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>NT_TIB</code>中一些重要的成员：</p>
<ul>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> ExceptionList    : Ptr32 _EXCEPTION_REGISTRATION_RECORD</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>当前线程内核异常处理的链表。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> StackBase        : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> StackLimit       : Ptr32 Void</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>当前线程内核的栈基址与大小。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> Self             : Ptr32 _NT_TIB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向自己，方便查找。</p>
</li>
</ul>
</li>
<li>
<p><code>KPCR</code>中一些重要的成员：</p>
<ul>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> SelfPcr          : Ptr32 _KPCR</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向自己，方便查找。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Prcb             : Ptr32 _KPRCB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向扩展结构<code>PRCB</code>。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> IDT              : Ptr32 _KIDTENTRY</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向<code>IDT</code>表。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> GDT              : Ptr32 _KGDTENTRY</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向<code>GDT</code>表。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> TSS              : Ptr32 _KTSS</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>指向<code>TSS</code>，每个<code>CPU</code>都有一个<code>TSS</code>。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x051</span> Number           : UChar</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>CPU</code>编号。</p>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> PrcbData         : _KPRCB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>扩展结构体。</p>
</li>
</ul>
</li>
</ul>
<h6>等待线程_调度线程<span class="hx-absolute -hx-mt-20" id="等待线程_调度线程"></span>
    <a href="#%e7%ad%89%e5%be%85%e7%ba%bf%e7%a8%8b_%e8%b0%83%e5%ba%a6%e7%ba%bf%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p><code>CPU</code>如何调度线程</p>
<ul>
<li>
<p>等待链表</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dd KiWaitListHead</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>线程调用了<code>Sleep()</code>或者<code>WaitForSingleObject()</code>时，就挂到这个链表。</p>
<p>线程有<code>3</code>种状态：就绪、等待、运行。</p>
<p>正在运行种的线程存储在<code>KPCR</code>中，就绪和等待的线程全部在另外的<code>33</code>个链表中。一个等待链表，<code>32</code>个就绪链表。</p>
</li>
<li>
<p>调度链表</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dd KiDispatcherReadyListHead L70</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这其中每一个链表都存储不同级别的线程。（<code>0~31</code>级）</p>
<p>（如果<code>fd = bk = 当前地址</code>，那么这个链表为空。我们看的时候处于调试状态，全部的线程都会挂起，所以都是空的。）</p>
</li>
<li>
<p><code>32</code>位系统有<code>32</code>个就绪链表，<code>64</code>位系统就有<code>64</code>个就绪链表。</p>
</li>
<li>
<p>正在运行的线程在<code>KPCR</code>中。</p>
</li>
<li>
<p>这两个结构挂载在<code>_KTHREAD[0x60]</code></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> WaitListEntry    : _LIST_ENTRY    <span style="color:#75715e">//等待
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x060</span> SwapListEntry    : _SINGLE_LIST_ENTRY    <span style="color:#75715e">//挂起
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h6>主动切换<span class="hx-absolute -hx-mt-20" id="主动切换"></span>
    <a href="#%e4%b8%bb%e5%8a%a8%e5%88%87%e6%8d%a2" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li><code>windows</code>中绝大部分<code>API</code>都调用了<code>SwapContext</code>函数，当线程只要调用了<code>API</code>，就会导致线程切换。</li>
<li>线程切换时会比较是否属于同一进程，如果不是，切换<code>Cr3</code>，<code>Cr3</code>换了，进程也就切换了。</li>
</ul>
<h6>时钟中断切换<span class="hx-absolute -hx-mt-20" id="时钟中断切换"></span>
    <a href="#%e6%97%b6%e9%92%9f%e4%b8%ad%e6%96%ad%e5%88%87%e6%8d%a2" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>如何中断一个正在执行的程序：</p>
<ul>
<li>异常（缺页与<code>int n</code>）</li>
<li>中断（时钟中断）</li>
</ul>
</li>
<li>
<p>系统时钟</p>
<ul>
<li>
<table>
  <thead>
      <tr>
          <th style="text-align: center">（IDT）中断号</th>
          <th style="text-align: center">IRQ</th>
          <th style="text-align: center">说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: center">0x30</td>
          <td style="text-align: center">IRQ0</td>
          <td style="text-align: center">时钟中断</td>
      </tr>
  </tbody>
</table>
<p>操作系统每隔<code>10~20</code>毫秒会触发一次时钟中断，可以通过<code>GetSystemTimeAdjustment</code>获取当前操作系统的时钟间隔值。</p>
</li>
</ul>
</li>
<li>
<p>时钟中断的执行流程</p>
<p><code>KiStartUnexpectedRange</code> &ndash;&gt; <code>KiEndUnexpectedRange</code> &ndash;&gt; <code>KiUnexpectedInterruptTail</code> &ndash;&gt; <code>HalBeginSystemInterrupt</code> &ndash;&gt; <code>HalEndSystemInterrupt</code> &ndash;&gt; <code>KiDispatchInterrupt</code> &ndash;&gt; <code>SwapContext</code></p>
</li>
<li>
<p>总结</p>
<ul>
<li>
<p>线程切换的几种方式：</p>
<ul>
<li>主动调用<code>API</code>函数</li>
<li>时钟中断</li>
<li>异常处理</li>
</ul>
<p>如果一个线程不调用<code>API</code>，在代码中屏蔽中断（<code>CLI</code>指令），并且不会出现异常，那么该线程将永久占有<code>CPU</code>，单核占有率为<code>100%</code>，双核占有率为<code>50%</code>。</p>
</li>
</ul>
</li>
</ol>
<h6>时间片管理<span class="hx-absolute -hx-mt-20" id="时间片管理"></span>
    <a href="#%e6%97%b6%e9%97%b4%e7%89%87%e7%ae%a1%e7%90%86" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>时钟中断时有两种情况会导致线程切换：</p>
<ul>
<li>当前的<code>CPU</code>时间片到期</li>
<li>有备用线程（<code>KPCR.PrcbData.NextThread</code>）</li>
</ul>
</li>
<li>
<p>什么是<code>CPU</code>时间片？</p>
<ol>
<li>当一个新线程开始执行时，初始化程序会在<code>_KTHREAD.Quantum</code>赋初始值，该值大小由<code>_KPROCESS.ThreadQuantum</code>决定。</li>
<li>每次时钟中断会调用<code>KeUpdateRunTime</code>函数，该函数每次将当前线程的<code>Quantum</code>减少<code>3</code>个单位。如果减到<code>0</code>，就将<code>KPCR.PrcbData.QuantumEnd</code>（标志当前<code>CPU</code>时间片是否用完，没用完是<code>0</code>）的值设置为非<code>0</code>。</li>
<li>每次系统时钟执行完毕后都会执行<code>KiDispatchInterrupt</code>，来判断时间片是否到期。</li>
<li>时间片到期后会调用<code>KiQuantumEnd</code>重新设置时间片，找到要运行的线程</li>
</ol>
<pre class="mermaid hx-mt-6">
  graph TB
    A[KeUpdateRunTime] --&gt; B[KiDispatchInterrupt（时间片是否到期?）];
    B --否--&gt; A
    B --是--&gt; D[KiQuantumEnd]
</pre></li>
<li>
<p>线程切换的几种方式：</p>
<ul>
<li>
<p>当前线程主动调用<code>API</code>函数</p>
<p><code>API</code>函数 &ndash;&gt; <code>KiSwapThread</code> &ndash;&gt; <code>KiSwapContext</code> &ndash;&gt; <code>SwapContext</code></p>
</li>
<li>
<p>当前的<code>CPU</code>时间片到期</p>
<p><code>KiDispatchInterrupt</code> &ndash;&gt; <code>KiQuantumEnd</code> &ndash;&gt; <code>KiSwapContext</code> &ndash;&gt; <code>SwapContext</code></p>
</li>
<li>
<p>有备用线程（<code>KPCR.PrcbData.NextThread</code>）</p>
<p><code>KiDispatchInterrupt</code> &ndash;&gt; <code>SwapContext</code></p>
</li>
</ul>
</li>
</ul>
<h6>线程切换TSS<span class="hx-absolute -hx-mt-20" id="线程切换tss"></span>
    <a href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2tss" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>内核堆栈</p>
<p>在<code>_KTHREAD</code>结构体中存在内核堆栈的三个成员：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_KTHREAD
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> InitialStack     : Ptr32 Void    <span style="color:#75715e">//栈底
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> StackLimit       : Ptr32 Void    <span style="color:#75715e">//栈的边界
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> KernelStack      : Ptr32 Void    <span style="color:#75715e">//栈顶
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>在内存中如下：</p>
<p><img src="https://c65mael.github.io/myassets/kstack.png" alt="image" loading="lazy" /></p>
</li>
<li>
<p>调用<code>API</code>进<code>0</code>环</p>
<p>普通调用：通过<code>TSS.ESP0</code>得到<code>0</code>环堆栈</p>
<p>快速调用：从<code>MSR</code>得到一个临时<code>0</code>环栈，代码执行后仍然通过<code>TSS.ESP0</code>得到当前线程<code>0</code>环堆栈</p>
</li>
</ol>
<h6>线程切换FS<span class="hx-absolute -hx-mt-20" id="线程切换fs"></span>
    <a href="#%e7%ba%bf%e7%a8%8b%e5%88%87%e6%8d%a2fs" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>系统中存在着许多的线程，这就意味着<code>FS:[0]</code>在<code>3</code>环时指向的<code>TEB</code>要有多个（每个线程一份），<code>FS</code>的段选择子都相同，如何实现使用一个<code>FS</code>寄存器指向多个<code>TEB</code>？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">D7</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span><span style="color:#66d9ef">h</span>]  <span style="color:#75715e">; TEB
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">DA</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>]  <span style="color:#75715e">; GDT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">DD</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ah</span>], <span style="color:#66d9ef">ax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">E1</span>                 <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">10</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">E4</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>], <span style="color:#66d9ef">al</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">E7</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Fh</span>], <span style="color:#66d9ef">ah</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>相当于改了对应段描述符的<code>base</code>（三部分），使它指向不同的<code>TEB</code>。</p>
</li>
</ul>
<h6>线程优先级<span class="hx-absolute -hx-mt-20" id="线程优先级"></span>
    <a href="#%e7%ba%bf%e7%a8%8b%e4%bc%98%e5%85%88%e7%ba%a7" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>在<code>KiSwapThread</code>与<code>KiQuantumEnd</code>函数中，都是通过<code>KiFindReadyThread</code>来找下一个要切换的线程的，<code>KiFindReadyThread</code>是根据什么条件来选择下一个要执行的线程的？</p>
<ul>
<li>
<p><code>KiFindReadyThread</code>查找方式：</p>
<p>按照优先级来查找：<code>31 -&gt; 30 -&gt; 29 -&gt; ……</code></p>
<p>如果<code>31</code>级别的链表中有线程，那么就不会查找比它级别低的链表的。（每一次只查找最高的）</p>
</li>
<li>
<p>优化</p>
<p>调度链表有<code>32</code>个，每次从头开始找效率太低，<code>Windows</code>通过一个<code>DWORD</code>类型的变量来记录。</p>
<p>当向调度链表中挂入或摘除某个进程时，会判断当前链表是否为空（<code>fd = bk = 当前地址</code>），如果为空就将<code>DWORD</code>变量的对应位置0，否则置1。</p>
<p><img src="https://c65mael.github.io/myassets/diaodu.png" alt="image" loading="lazy" /></p>
<p>变量名：<code>_KiReadySummary</code></p>
</li>
<li>
<p>没有就绪线程怎么办？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">//PrcbData
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>kd<span style="color:#f92672">&gt;</span> dt _KPRCB
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_KPRCB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> MinorVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x002</span> MajorVersion     : Uint2B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> CurrentThread    : Ptr32 _KTHREAD    <span style="color:#75715e">//当前线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> NextThread       : Ptr32 _KTHREAD    <span style="color:#75715e">//下一次要运行的线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> IdleThread       : Ptr32 _KTHREAD    <span style="color:#75715e">//空闲线程
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>就会执行<code>IdleThread</code>。</p>
</li>
</ul>
<h6>进程挂靠<span class="hx-absolute -hx-mt-20" id="进程挂靠"></span>
    <a href="#%e8%bf%9b%e7%a8%8b%e6%8c%82%e9%9d%a0" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>进程与线程的关系</p>
<p>线程代码：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">0x12345678</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><code>CPU</code>如何解析<code>0x12345678</code>这个地址？</p>
<ul>
<li><code>CPU</code>解析线性地址会通过页目录表来找对应的物理页，页目录表基址在<code>cr3</code>寄存器中。</li>
<li>当前<code>cr3</code>寄存器的值来源于当前的进程（<code>_KPROCESS.DirectoryTableBase(+0x18)</code>）</li>
</ul>
</li>
<li>
<p>两个指向当前进程的指针</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_ETHREAD
</span></span><span style="display:flex;"><span>       <span style="color:#f92672">+</span><span style="color:#ae81ff">0x220</span> ThreadsProcess   : Ptr32 _EPROCESS
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ntdll<span style="color:#f92672">!</span>_KTHREAD
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> ApcState         : _KAPC_STATE
</span></span><span style="display:flex;"><span>    ntdll<span style="color:#f92672">!</span>_KAPC_STATE
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> Process          : Ptr32 _KPROCESS</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>养父母负责提供<code>cr3</code></p>
<p>在线程切换时，会比较<code>_KTHREAD</code>结构体<code>0x044</code>处指定的<code>EPROCESS</code>是否是同一个，如果不同，会将<code>0x044</code>处指定的<code>EPROCESS</code>的<code>DirectoryTableBase</code>值取出，赋值给<code>cr3</code></p>
<p>线程所需<code>cr3</code>的值来源于<code>0x044</code>处指定的<code>EPROCESS</code>。</p>
<p><code>0x220</code>：这个线程是谁创建的。（亲身父母）</p>
<p><code>0x044</code>：谁在为这个线程提供资源。（养父母）</p>
<p>一般情况下，这两个指向同一个进程。</p>
</li>
<li>
<p>更改<code>cr3</code>（进程挂靠）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">cr3</span>,<span style="color:#66d9ef">A.DirectoryTableBase</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">0x12345678</span>]    <span style="color:#75715e">;访问A进程0x12345678地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">cr3</span>,<span style="color:#66d9ef">B.DirectoryTableBase</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">0x12345678</span>]    <span style="color:#960050;background-color:#1e0010">;访问</span><span style="color:#66d9ef">B进程0x12345678地址</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h6>跨进程读写内存<span class="hx-absolute -hx-mt-20" id="跨进程读写内存"></span>
    <a href="#%e8%b7%a8%e8%bf%9b%e7%a8%8b%e8%af%bb%e5%86%99%e5%86%85%e5%ad%98" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>需要解决的主要的是如果切换了<code>cr3</code>，那么我们就在新线程的内存了，可以读数据，但是写的话还是写到的新线程内。</p>
<ul>
<li>
<p>读数据：</p>
<p><img src="https://c65mael.github.io/myassets/kuaread.png" alt="image" loading="lazy" /></p>
<ol>
<li>切换<code>cr3</code></li>
<li>将数据复制到高<code>2G</code></li>
<li>切换<code>cr3</code></li>
<li>从高<code>2G</code>的数据复制到对应位置</li>
</ol>
</li>
<li>
<p>写数据：</p>
<p><img src="https://c65mael.github.io/myassets/kuawrite.png" alt="image" loading="lazy" /></p>
<ol>
<li>将数据从目标位置复制到高<code>2G</code></li>
<li>切换<code>cr3</code></li>
<li>从高<code>2G</code>的数据复制到对应位置</li>
<li>切换<code>cr3</code></li>
</ol>
</li>
</ul>
<h6>句柄表<span class="hx-absolute -hx-mt-20" id="句柄表"></span>
    <a href="#%e5%8f%a5%e6%9f%84%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>当进程打开或创建一个内核对象时，会获取一个句柄，提供这个句柄可以访问内核对象。</p>
<ul>
<li>
<p>为什么要有句柄？</p>
<p>隐藏内核对象指针，句柄其实就是一个索引。</p>
<p>句柄存在的意义就是避免在应用层直接修改内核对象。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>HANDLE g_hEvent <span style="color:#f92672">=</span> CreateEvent(NULL,TRUE,FALSE,NULL);</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>之所以不将<code>g_hEvent</code>存<code>EVENT</code>的内核对象的地址，是害怕我们修改访问其他的内核对象导致蓝屏。</p>
<p>句柄表如下：</p>
</li>
<li>
<p>句柄表在哪里？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _EPROCESS       
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0c4</span> ObjectTable      : _HANDLE_TABLE   
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _HANDLE_TABLE 
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_HANDLE_TABLE     
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> TableCode    <span style="color:#75715e">//句柄表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> QuotaProcess 
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> UniqueProcessId
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> HandleTableLock
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> HandleTableList   
</span></span><span style="display:flex;"><span>   ...</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>句柄表结构</p>
<p><img src="https://c65mael.github.io/myassets/jbbjg.png" alt="image" loading="lazy" /></p>
<p> ①：这一块共计两个字节，低字节保留（一直都是<code>0</code>），高位字节是给<code>SetHandleInformation</code>这个函数用的，比如写成如下形式，那么这个位置将被写入<code>0x02</code>：<code>SetHandleInformation(Handle,HANDLE_FLAG_PROTECT_FROM_CLOSE,HANDLE_FLAG_PROTECT_FROM_CLOSE);</code></p>
<p><code>HANDLE_FLAG_PROTECT_FROM_CLOSE</code>宏的值为<code>0x00000002</code>，取最低字节，最终 ① 这块是<code>0x0200</code>。</p>
<p> ②：这块是访问掩码，是给<code>OpenProcess</code>这个函数用的，具体的存的值就是这个函数的第一个参数的值。
 ③ 和 ④ 这两个块共计四个字节，其中<code>bit0-bit2</code>存的是这个句柄的属性，其中<code>bit2</code>和<code>bit0</code>默认为<code>0</code>和<code>1</code>; <code>bit1</code>表示的函数是该句柄是否可继承，<code>OpenProcess</code>的第二个参数与<code>bit1</code>有关，<code>bit31-bit3</code>则是存放的该内核对象在内核中的具体的地址。（后三位清零，就是<code>0xb</code>变<code>8</code>）</p>
<p>这个地址也不是该内核对象的首地址，因为每一个内核对象都是以<code>_OBJECT_HEADER</code>开头的：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>kd<span style="color:#f92672">&gt;</span> dt _OBJECT_HEADER
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_OBJECT_HEADER
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> PointerCount     : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> HandleCount      : Int4B
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x004</span> NextToFree       : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x008</span> Type             : Ptr32 _OBJECT_TYPE
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00c</span> NameInfoOffset   : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00d</span> HandleInfoOffset : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00e</span> QuotaInfoOffset  : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x00f</span> Flags            : UChar
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> ObjectCreateInfo : Ptr32 _OBJECT_CREATE_INFORMATION
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x010</span> QuotaBlockCharged : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x014</span> SecurityDescriptor : Ptr32 Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x018</span> Body             : _QUAD    <span style="color:#75715e">//EPROCESS是从这里开始的
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>所以加<code>0x18</code>偏移才可以。</p>
</li>
<li>
<p>如果在别人句柄表中找到了我的进程结构体对象的地址，可能是它打开了我或在调试我。</p>
</li>
</ul>
<h6>全局句柄表<span class="hx-absolute -hx-mt-20" id="全局句柄表"></span>
    <a href="#%e5%85%a8%e5%b1%80%e5%8f%a5%e6%9f%84%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>全局句柄表</p>
<p>所有进程与线程，无论打开与否，都在这个表中。</p>
<p>每个进程与线程都有唯一的编号：<code>PID</code>与<code>CID</code>，这两个值就是全局句柄表的索引。</p>
<p>进程和线程的查询，主要是以下三个函数，按照给定的<code>PID</code>或<code>TID</code>从<code>PspCidTable</code>从查找相应的进线程对象：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>PsLookupProcessThreadByCid(x, x, x);
</span></span><span style="display:flex;"><span>PsLookupProcessByProcessId(HANDLE ProcessId, PEPROCESS <span style="color:#f92672">*</span>Process);
</span></span><span style="display:flex;"><span>PsLookupThreadByThreadId(HANDLE ThreadId, PETHREAD <span style="color:#f92672">*</span>Thread);  
</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>全局句柄表结构</p>
<p><img src="https://c65mael.github.io/myassets/qjjbbjg.png" alt="image" loading="lazy" /></p>
</li>
</ol>
<h3>多核同步<span class="hx-absolute -hx-mt-20" id="多核同步"></span>
    <a href="#%e5%a4%9a%e6%a0%b8%e5%90%8c%e6%ad%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>临界区<span class="hx-absolute -hx-mt-20" id="临界区"></span>
    <a href="#%e4%b8%b4%e7%95%8c%e5%8c%ba" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ol>
<li>
<p>并发是指多个线程同时执行：</p>
<p>单核（分时执行，不会真正的同时执行）</p>
<p>多核（是指在某一时刻，有多个线程在执行）</p>
<p>同步是保证在并发的环境中各个线程可以有序的执行。</p>
</li>
<li>
<p>其实就是保证代码的原子操作（执行的时候不要被其他线程打扰）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">inc</span> <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">0x12345678</span>]    <span style="color:#75715e">;多核情况下，可能其他线程同时会执行这个代码
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">inc</span> <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">0x12345678</span>]    <span style="color:#960050;background-color:#1e0010">;在某个时刻只能有一个</span><span style="color:#66d9ef">CPU读这个内存</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>临界区：一次只允许一个线程进入直到离开。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#75715e">;全局变量 Flag = 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;进入临界区:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>Lab:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">xadd</span> [<span style="color:#66d9ef">Flag</span>],<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cmp</span> <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">jz</span> <span style="color:#66d9ef">endLab</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dec</span> [<span style="color:#66d9ef">Flag</span>]
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">;线程等待Sleep
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>endLab:
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ret</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;离开临界区:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">dec</span> [<span style="color:#66d9ef">Flag</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h6>自旋锁<span class="hx-absolute -hx-mt-20" id="自旋锁"></span>
    <a href="#%e8%87%aa%e6%97%8b%e9%94%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><p>在多核的情况下，查看<code>SwapContext</code>函数会出现许多<code>SpinLock</code>的函数。</p>
<ul>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>KeAcquireSpinLockAtDpcLevel:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">ecx</span>, [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LockAcquired:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">lock</span> <span style="color:#a6e22e">bts</span> <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ecx</span>], <span style="color:#ae81ff">0</span>    <span style="color:#75715e">;设置并检测
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">jb</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">LockAcquired</span>    <span style="color:#75715e">;[ecx] != 0则跳转
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">ret</span>     <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>SpinWaitLoop:
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">test</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ecx</span>], <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">LockAcquired</span>    <span style="color:#75715e">;[ecx] = 0则跳转
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">pause</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">jmp</span>     <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">SpinWaitLoop</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>总结</p>
<ol>
<li>自旋锁只对多核有意义</li>
<li>自旋锁与临界区、事件、互斥体一样，都是一种同步机制，可以让当前线程处于等待状态。区别在于自旋锁不用却换线程。</li>
</ol>
</li>
</ul>
<h6>线程等待与唤醒<span class="hx-absolute -hx-mt-20" id="线程等待与唤醒"></span>
    <a href="#%e7%ba%bf%e7%a8%8b%e7%ad%89%e5%be%85%e4%b8%8e%e5%94%a4%e9%86%92" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>目前有两种方式让无法进入临界区的线程来等待（只有一个厕所，一个人在里面上厕所）：</p>
<ol>
<li>通过<code>Sleep</code>函数进行等待，但等待的时间无法确定。（如果在厕所外面的这个人回去睡了一段时间，发现厕所里面还有人；如果等待的这个人刚睡，厕所里面的人就出来了）</li>
<li>通过&quot;空转&quot;的方式进行等待，只有在等待时间极短的情况下才有意义，而且是多核的情况下。</li>
</ol>
</li>
<li>
<p>等待与唤醒机制</p>
<p>在<code>Windows</code>中，一个线程可以通过等待一个或者多个可等待对象，从而进入可等待状态，另一个线程可以在某些时刻唤醒等待这些对象的其他线程。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">//线程A
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>WaitForSingleObject
</span></span><span style="display:flex;"><span>WaitForMultipleObjects</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>

        </div>
        <div class="hx-mt-16"></div>
        <div class="hx-mb-8 hx-flex hx-items-center hx-border-t hx-pt-8 dark:hx-border-neutral-800 contrast-more:hx-border-neutral-400 dark:contrast-more:hx-border-neutral-400 print:hx-hidden"><a
        href="/docs/windows-beg/"
        title="Windows BEG"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-pr-4 rtl:hx-pl-4"
      ><svg class="hx-inline hx-h-5 hx-shrink-0 ltr:hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>Windows BEG</a></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>
<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/en.search.js" integrity=""></script><script defer src="/lib/mermaid/mermaid.min.0d2b6f2361e7e0ce466a6ed458e03daa5584b42ef6926c3beb62eb64670ca261.js" integrity="sha256-DStvI2Hn4M5Gam7UWOA9qlWEtC72kmw762LrZGcMomE="></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    
    document.querySelectorAll(".mermaid").forEach(el => {
      el.dataset.original = el.innerHTML;
    });

    const theme = document.documentElement.classList.contains("dark") ? "dark" : "default";
    mermaid.initialize({ startOnLoad: true, theme: theme });

    let timeout;
    new MutationObserver(() => {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        const theme = document.documentElement.classList.contains("dark") ? "dark" : "default";
        document.querySelectorAll(".mermaid").forEach(el => {
          
          el.innerHTML = el.dataset.original;
          el.removeAttribute("data-processed");
        });
        mermaid.initialize({ startOnLoad: true, theme: theme });
        mermaid.init();
      }, 150);
    }).observe(document.documentElement, {
      attributes: true,
      attributeFilter: ["class"]
    });
  });
</script>

  </body>
</html>
