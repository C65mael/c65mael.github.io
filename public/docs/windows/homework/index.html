<!DOCTYPE html>
<html lang="en"><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <link rel="icon shortcut" href="/favicon.ico" sizes="32x32" />
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="icon" href="/favicon-dark.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)" />
<link rel="icon" href="/favicon-16x16.png" type="image/png" sizes="16x16" />
<link rel="icon" href="/favicon-32x32.png" type="image/png" sizes="32x32" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" sizes="180x180" />
<link fetchpriority="low" href="/site.webmanifest" rel="manifest" />
<title>Homework – C65mael</title>
  <meta name="description" content="PE结构 内存分配—文件读写 将记事本的.exe文件读取到内存，并返回读取后在内存中的地址
#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; void* load(const char* file_path, size_t* size) { FILE* file = fopen(file_path, &#34;rb&#34;); if (!file) { return NULL; } fseek(file, 0, SEEK_END); *size = ftell(file); fseek(file, 0, SEEK_SET); void* memory = malloc(*size); if (!memory) { fclose(file); return NULL; } size_t read_size = fread(memory, 1, *size, file); if (read_size != *size) { free(memory); fclose(file); return NULL; } fclose(file); return memory; } int main() { const char* path = &#34;C:\\Windows\\notepad.exe&#34;; size_t size = 0; void* file_memory = load(path, &amp;size); if (file_memory) { printf(&#34;address: %p\n&#34;, file_memory); printf(&#34;size: %zu bytes\n&#34;, size); } free(file_memory); } return 0; } 将内存中的数据存储到一个文件中，（.exe格式），然后双击打开，看是否能够使用" /><link rel="canonical" href="http://localhost:1313/docs/windows/homework/" itemprop="url" />

<meta property="og:title" content="Homework" />
<meta property="og:description" content="PE结构
    内存分配—文件读写
    

将记事本的.exe文件读取到内存，并返回读取后在内存中的地址


#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;

void* load(const char* file_path, size_t* size) {
    FILE* file = fopen(file_path, &#34;rb&#34;);
    if (!file) {
        return NULL;
    }

    fseek(file, 0, SEEK_END);
    *size = ftell(file);
    fseek(file, 0, SEEK_SET);

    void* memory = malloc(*size);
    if (!memory) {
        fclose(file);
        return NULL;
    }

    size_t read_size = fread(memory, 1, *size, file);
    if (read_size != *size) {
        free(memory);
        fclose(file);
        return NULL;
    }

    fclose(file);

    return memory;
}

int main() {
    const char* path = &#34;C:\\Windows\\notepad.exe&#34;;
    size_t size = 0;

    void* file_memory = load(path, &amp;size);

    if (file_memory) {
        printf(&#34;address: %p\n&#34;, file_memory);
        printf(&#34;size: %zu bytes\n&#34;, size);
        }
        free(file_memory);
    }

    return 0;
}
  
    
    
  




将内存中的数据存储到一个文件中，（.exe格式），然后双击打开，看是否能够使用" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/docs/windows/homework/" /><meta property="article:section" content="docs" />



  <meta itemprop="name" content="Homework">
  <meta itemprop="description" content="PE结构 内存分配—文件读写 将记事本的.exe文件读取到内存，并返回读取后在内存中的地址
#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; void* load(const char* file_path, size_t* size) { FILE* file = fopen(file_path, &#34;rb&#34;); if (!file) { return NULL; } fseek(file, 0, SEEK_END); *size = ftell(file); fseek(file, 0, SEEK_SET); void* memory = malloc(*size); if (!memory) { fclose(file); return NULL; } size_t read_size = fread(memory, 1, *size, file); if (read_size != *size) { free(memory); fclose(file); return NULL; } fclose(file); return memory; } int main() { const char* path = &#34;C:\\Windows\\notepad.exe&#34;; size_t size = 0; void* file_memory = load(path, &amp;size); if (file_memory) { printf(&#34;address: %p\n&#34;, file_memory); printf(&#34;size: %zu bytes\n&#34;, size); } free(file_memory); } return 0; } 将内存中的数据存储到一个文件中，（.exe格式），然后双击打开，看是否能够使用">
  <meta itemprop="wordCount" content="12549">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="Homework">
  <meta name="twitter:description" content="PE结构 内存分配—文件读写 将记事本的.exe文件读取到内存，并返回读取后在内存中的地址
#include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; void* load(const char* file_path, size_t* size) { FILE* file = fopen(file_path, &#34;rb&#34;); if (!file) { return NULL; } fseek(file, 0, SEEK_END); *size = ftell(file); fseek(file, 0, SEEK_SET); void* memory = malloc(*size); if (!memory) { fclose(file); return NULL; } size_t read_size = fread(memory, 1, *size, file); if (read_size != *size) { free(memory); fclose(file); return NULL; } fclose(file); return memory; } int main() { const char* path = &#34;C:\\Windows\\notepad.exe&#34;; size_t size = 0; void* file_memory = load(path, &amp;size); if (file_memory) { printf(&#34;address: %p\n&#34;, file_memory); printf(&#34;size: %zu bytes\n&#34;, size); } free(file_memory); } return 0; } 将内存中的数据存储到一个文件中，（.exe格式），然后双击打开，看是否能够使用">

    <link href="/css/compiled/main.css" rel="stylesheet" />



  <link href="/css/custom.css" rel="stylesheet" />


  <script>
     
    const defaultTheme = 'system';

    const setDarkTheme = () => {
      document.documentElement.classList.add("dark");
      document.documentElement.style.colorScheme = "dark";
    }
    const setLightTheme = () => {
      document.documentElement.classList.remove("dark");
      document.documentElement.style.colorScheme = "light";
    }

    if ("color-theme" in localStorage) {
      localStorage.getItem("color-theme") === "dark" ? setDarkTheme() : setLightTheme();
    } else {
      defaultTheme === "dark" ? setDarkTheme() : setLightTheme();
      if (defaultTheme === "system") {
        window.matchMedia("(prefers-color-scheme: dark)").matches ? setDarkTheme() : setLightTheme();
      }
    }
  </script>

  
</head>
<body dir="ltr"><div class="nav-container hx-sticky hx-top-0 hx-z-20 hx-w-full hx-bg-transparent print:hx-hidden">
  <div class="nav-container-blur hx-pointer-events-none hx-absolute hx-z-[-1] hx-h-full hx-w-full hx-bg-white dark:hx-bg-dark hx-shadow-[0_2px_4px_rgba(0,0,0,.02),0_1px_0_rgba(0,0,0,.06)] contrast-more:hx-shadow-[0_0_0_1px_#000] dark:hx-shadow-[0_-1px_0_rgba(255,255,255,.1)_inset] contrast-more:dark:hx-shadow-[0_0_0_1px_#fff]"></div>

  <nav class="hx-mx-auto hx-flex hx-items-center hx-justify-end hx-gap-2 hx-h-16 hx-px-6 hx-max-w-[90rem]">
    <a class="hx-flex hx-items-center hover:hx-opacity-75 ltr:hx-mr-auto rtl:hx-ml-auto" href="/">
        <img class="hx-mr-2 hx-block dark:hx-hidden" src="/images/logo.svg" alt="C65mael" height="20" width="20" />
        <img class="hx-mr-2 hx-hidden dark:hx-block" src="/images/logo.svg" alt="C65mael" height="20" width="20" />
        <span class="hx-mr-2 hx-font-extrabold hx-inline hx-select-none" title="C65mael">C65mael</span>
    </a><a
            title="文档"
            href="/docs"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-font-medium"
          >
            <span class="hx-text-center">文档</span>
          </a><a
            title="博客"
            href="/blog"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">博客</span>
          </a><a
            title="关于"
            href="/about"
            
            class="hx-text-sm contrast-more:hx-text-gray-700 contrast-more:dark:hx-text-gray-100 hx-relative -hx-ml-2 hx-hidden hx-whitespace-nowrap hx-p-2 md:hx-inline-block hx-text-gray-600 hover:hx-text-gray-800 dark:hx-text-gray-400 dark:hover:hx-text-gray-200"
          >
            <span class="hx-text-center">关于</span>
          </a><div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

          <a class="hx-p-2 hx-text-current" target="_blank" rel="noreferrer" href="https://github.com/imfing/hextra" title="GitHub"><svg height=24 fill="currentColor" viewBox="3 3 18 18">
  <path d="M12 3C7.0275 3 3 7.12937 3 12.2276C3 16.3109 5.57625 19.7597 9.15374 20.9824C9.60374 21.0631 9.77249 20.7863 9.77249 20.5441C9.77249 20.3249 9.76125 19.5982 9.76125 18.8254C7.5 19.2522 6.915 18.2602 6.735 17.7412C6.63375 17.4759 6.19499 16.6569 5.8125 16.4378C5.4975 16.2647 5.0475 15.838 5.80124 15.8264C6.51 15.8149 7.01625 16.4954 7.18499 16.7723C7.99499 18.1679 9.28875 17.7758 9.80625 17.5335C9.885 16.9337 10.1212 16.53 10.38 16.2993C8.3775 16.0687 6.285 15.2728 6.285 11.7432C6.285 10.7397 6.63375 9.9092 7.20749 9.26326C7.1175 9.03257 6.8025 8.08674 7.2975 6.81794C7.2975 6.81794 8.05125 6.57571 9.77249 7.76377C10.4925 7.55615 11.2575 7.45234 12.0225 7.45234C12.7875 7.45234 13.5525 7.55615 14.2725 7.76377C15.9937 6.56418 16.7475 6.81794 16.7475 6.81794C17.2424 8.08674 16.9275 9.03257 16.8375 9.26326C17.4113 9.9092 17.76 10.7281 17.76 11.7432C17.76 15.2843 15.6563 16.0687 13.6537 16.2993C13.98 16.5877 14.2613 17.1414 14.2613 18.0065C14.2613 19.2407 14.25 20.2326 14.25 20.5441C14.25 20.7863 14.4188 21.0746 14.8688 20.9824C16.6554 20.364 18.2079 19.1866 19.3078 17.6162C20.4077 16.0457 20.9995 14.1611 21 12.2276C21 7.12937 16.9725 3 12 3Z"></path>
</svg>
<span class="hx-sr-only">GitHub</span>
          </a><button type="button" aria-label="Menu" class="hamburger-menu -hx-mr-2 hx-rounded hx-p-2 active:hx-bg-gray-400/20 md:hx-hidden"><svg height=24 fill="none" viewBox="0 0 24 24" stroke="currentColor"><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8H20"></path></g><g><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16H20"></path></g></svg></button>
  </nav>
</div>

  <div class='hx-mx-auto hx-flex hx-max-w-screen-xl'>
    <div class="mobile-menu-overlay [transition:background-color_1.5s_ease] hx-fixed hx-inset-0 hx-z-10 hx-bg-black/80 dark:hx-bg-black/60 hx-hidden"></div>
<aside class="sidebar-container hx-flex hx-flex-col print:hx-hidden md:hx-top-16 md:hx-shrink-0 md:hx-w-64 md:hx-self-start max-md:[transform:translate3d(0,-100%,0)] md:hx-sticky">
  
  <div class="hx-px-4 hx-pt-4 md:hx-hidden">
    <div class="search-wrapper hx-relative md:hx-w-64">
  <div class="hx-relative hx-flex hx-items-center hx-text-gray-900 contrast-more:hx-text-gray-800 dark:hx-text-gray-300 contrast-more:dark:hx-text-gray-300">
    <input
      placeholder="Search..."
      class="search-input hx-block hx-w-full hx-appearance-none hx-rounded-lg hx-px-3 hx-py-2 hx-transition-colors hx-text-base hx-leading-tight md:hx-text-sm hx-bg-black/[.05] dark:hx-bg-gray-50/10 focus:hx-bg-white dark:focus:hx-bg-dark placeholder:hx-text-gray-500 dark:placeholder:hx-text-gray-400 contrast-more:hx-border contrast-more:hx-border-current"
      type="search"
      value=""
      spellcheck="false"
    />
    <kbd
      class="hx-absolute hx-my-1.5 hx-select-none ltr:hx-right-1.5 rtl:hx-left-1.5 hx-h-5 hx-rounded hx-bg-white hx-px-1.5 hx-font-mono hx-text-[10px] hx-font-medium hx-text-gray-500 hx-border dark:hx-border-gray-100/20 dark:hx-bg-dark/50 contrast-more:hx-border-current contrast-more:hx-text-current contrast-more:dark:hx-border-current hx-items-center hx-gap-1 hx-transition-opacity hx-pointer-events-none hx-hidden sm:hx-flex"
    >
      CTRL K
    </kbd>
  </div>

  <div>
    <ul
      class="search-results hextra-scrollbar hx-hidden hx-border hx-border-gray-200 hx-bg-white hx-text-gray-100 dark:hx-border-neutral-800 dark:hx-bg-neutral-900 hx-absolute hx-top-full hx-z-20 hx-mt-2 hx-overflow-auto hx-overscroll-contain hx-rounded-xl hx-py-2.5 hx-shadow-xl hx-max-h-[min(calc(50vh-11rem-env(safe-area-inset-bottom)),400px)] md:hx-max-h-[min(calc(100vh-5rem-env(safe-area-inset-bottom)),400px)] hx-inset-x-0 ltr:md:hx-left-auto rtl:md:hx-right-auto contrast-more:hx-border contrast-more:hx-border-gray-900 contrast-more:dark:hx-border-gray-50 hx-w-screen hx-min-h-[100px] hx-max-w-[min(calc(100vw-2rem),calc(100%+20rem))]"
      style="transition: max-height 0.2s ease 0s;"
    ></ul>
  </div>
</div>

  </div>
  <div class="hextra-scrollbar hx-overflow-y-auto hx-overflow-x-hidden hx-p-4 hx-grow md:hx-h-[calc(100vh-var(--navbar-height)-var(--menu-height))]">
    <ul class="hx-flex hx-flex-col hx-gap-1 md:hx-hidden">
      
      
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/about/"
    
  >About
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/blog/"
    
  >Blog
    </a></li>
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/"
    
  >Docs
        <span class="hextra-sidebar-collapsible-button"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" class="hx-h-[18px] hx-min-w-[18px] hx-rounded-sm hx-p-0.5 hover:hx-bg-gray-800/5 dark:hover:hx-bg-gray-100/5"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" class="hx-origin-center hx-transition-transform rtl:-hx-rotate-180"></path></svg></span>
    </a><div class="ltr:hx-pr-0 hx-overflow-hidden">
        <ul class='hx-relative hx-flex hx-flex-col hx-gap-1 before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] ltr:hx-ml-3 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-mr-3 rtl:hx-pr-3 rtl:before:hx-right-0 dark:before:hx-bg-neutral-800'><li class="hx-flex hx-flex-col open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/docs/windows/homework/"
    
  >Homework
    </a>
  
    <ul class='hx-flex hx-flex-col hx-gap-1 hx-relative before:hx-absolute before:hx-inset-y-1 before:hx-w-px before:hx-bg-gray-200 before:hx-content-[""] dark:before:hx-bg-neutral-800 ltr:hx-pl-3 ltr:before:hx-left-0 rtl:hx-pr-3 rtl:before:hx-right-0 ltr:hx-ml-3 rtl:hx-mr-3'><li>
              <a
                href="#"
                class="hx-flex hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [word-break:break-word] hx-cursor-pointer [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] contrast-more:hx-border hx-gap-2 before:hx-opacity-25 before:hx-content-['#'] hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:hx-text-gray-900 contrast-more:dark:hx-text-gray-50 contrast-more:hx-border-transparent contrast-more:hover:hx-border-gray-900 contrast-more:dark:hover:hx-border-gray-50"
              ></a>
            </li>
          </ul>
  
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/homeworkbas/"
    
  >HomeworkBAS
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/windows-bas/"
    
  >Windows BAS
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/windows-beg/"
    
  >Windows BEG
    </a>
              
            </li><li class="hx-flex hx-flex-col "><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/windows-ext/"
    
  >Windows EXT
    </a>
              
            </li></ul>
      </div></li>
    </ul>

    <ul class="hx-flex hx-flex-col hx-gap-1 max-md:hx-hidden">
        
          <li class="open"><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      sidebar-active-item hx-bg-primary-100 hx-font-semibold hx-text-primary-800 contrast-more:hx-border contrast-more:hx-border-primary-500 dark:hx-bg-primary-400/10 dark:hx-text-primary-600 contrast-more:dark:hx-border-primary-500"
    href="/docs/windows/homework/"
    
  >Homework
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/homeworkbas/"
    
  >HomeworkBAS
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/windows-bas/"
    
  >Windows BAS
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/windows-beg/"
    
  >Windows BEG
    </a></li>
          <li class=""><a
    class="hx-flex hx-items-center hx-justify-between hx-gap-2 hx-cursor-pointer hx-rounded hx-px-2 hx-py-1.5 hx-text-sm hx-transition-colors [-webkit-tap-highlight-color:transparent] [-webkit-touch-callout:none] [word-break:break-word]
      hx-text-gray-500 hover:hx-bg-gray-100 hover:hx-text-gray-900 contrast-more:hx-border contrast-more:hx-border-transparent contrast-more:hx-text-gray-900 contrast-more:hover:hx-border-gray-900 dark:hx-text-neutral-400 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50 contrast-more:dark:hx-text-gray-50 contrast-more:dark:hover:hx-border-gray-50"
    href="/docs/windows/windows-ext/"
    
  >Windows EXT
    </a></li>
        
      </ul>
    </div>
  
  
    <div class="  hx-sticky hx-bottom-0 hx-bg-white dark:hx-bg-dark hx-mx-4 hx-py-4 hx-shadow-[0_-12px_16px_#fff] hx-flex hx-items-center hx-gap-2 dark:hx-border-neutral-800 dark:hx-shadow-[0_-12px_16px_#111] contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-shadow-none hx-border-t" data-toggle-animation="show"><div class="hx-flex hx-grow hx-flex-col"><button
  title="Change theme"
  data-theme="light"
  class="theme-toggle hx-group hx-h-7 hx-rounded-md hx-px-2 hx-text-left hx-text-xs hx-font-medium hx-text-gray-600 hx-transition-colors dark:hx-text-gray-400 hover:hx-bg-gray-100 hover:hx-text-gray-900 dark:hover:hx-bg-primary-100/5 dark:hover:hx-text-gray-50"
  type="button"
  aria-label="Change theme"
>
  <div class="hx-flex hx-items-center hx-gap-2 hx-capitalize"><svg height=12 class="group-data-[theme=light]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"/></svg><span class="group-data-[theme=light]:hx-hidden">Light</span><svg height=12 class="group-data-[theme=dark]:hx-hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg><span class="group-data-[theme=dark]:hx-hidden">Dark</span></div>
</button>
</div></div></aside>
    
<nav class="hextra-toc hx-order-last hx-hidden hx-w-64 hx-shrink-0 xl:hx-block print:hx-hidden hx-px-4" aria-label="table of contents">
    <div class="hextra-scrollbar hx-sticky hx-top-16 hx-overflow-y-auto hx-pr-4 hx-pt-6 hx-text-sm [hyphens:auto] hx-max-h-[calc(100vh-var(--navbar-height)-env(safe-area-inset-bottom))] ltr:hx--mr-4 rtl:hx--ml-4"><p class="hx-mb-4 hx-font-semibold hx-tracking-tight">On this page</p><ul>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pe%e7%bb%93%e6%9e%84">PE结构
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d%e6%96%87%e4%bb%b6%e8%af%bb%e5%86%99">内存分配—文件读写
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pe%e5%a4%b4%e8%a7%a3%e6%9e%90">PE头解析
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#filebuffer-imagebuffer">FileBuffer-ImageBuffer
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%a3%e7%a0%81%e8%8a%82%e7%a9%ba%e7%99%bd%e5%8c%ba%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%a0%81">代码节空白区添加代码
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%bb%e6%84%8f%e4%bb%a3%e7%a0%81%e7%a9%ba%e7%99%bd%e5%8c%ba%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%a0%81">任意代码空白区添加代码
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%96%b0%e5%a2%9e%e8%8a%82-%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%a0%81">新增节-添加代码
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%89%a9%e5%a4%a7%e8%8a%82-%e5%90%88%e5%b9%b6%e8%8a%82-%e6%95%b0%e6%8d%ae%e7%9b%ae%e5%bd%95">扩大节-合并节-数据目录
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%9d%99%e6%80%81%e9%93%be%e6%8e%a5%e5%ba%93-%e5%8a%a8%e6%80%81%e9%93%be%e6%8e%a5%e5%ba%93">静态链接库-动态链接库
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%af%bc%e5%87%ba%e8%a1%a8">导出表
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8">重定位表
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%a7%bb%e5%8a%a8%e5%af%bc%e5%87%ba%e8%a1%a8-%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8">移动导出表-重定位表
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%af%bc%e5%85%a5%e8%a1%a8">导入表
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#win32">Win32
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%ae%bd%e5%ad%97%e7%ac%a6">宽字符
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%ba%8b%e4%bb%b6-%e6%b6%88%e6%81%af">事件-消息
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#esp%e5%af%bb%e5%9d%80-%e5%ae%9a%e4%bd%8d%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0">esp寻址-定位回调函数
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%ad%90%e7%aa%97%e5%8f%a3-%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86%e5%87%bd%e6%95%b0">子窗口-消息处理函数
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6-%e6%b6%88%e6%81%af%e6%96%ad%e7%82%b9">资源文件-消息断点
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%b5%84%e6%ba%90%e8%a1%a8pe">资源表（PE）
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%a1%b9%e7%9b%ae">项目
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e5%88%9b%e5%bb%ba%e7%ba%bf%e7%a8%8b">创建线程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%ba%bf%e7%a8%8b%e6%8e%a7%e5%88%b6">线程控制
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%b4%e7%95%8c%e5%8c%ba">临界区
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%ba%92%e6%96%a5%e4%bd%93">互斥体
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%bc%a0%e6%a0%87_%e9%94%ae%e7%9b%98">鼠标_键盘
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#ce">CE
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f">保护模式
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%8e%e6%ae%b5%e9%80%89%e6%8b%a9%e5%ad%90">段描述符与段选择子
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7p%e4%bd%8d_g%e4%bd%8d">段描述符属性P位_G位
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7s%e4%bd%8d_type%e5%9f%9f">段描述符属性S位_TYPE域
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%ae%b5%e6%9d%83%e9%99%90%e6%a3%80%e6%9f%a5">段权限检查
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%a3%e7%a0%81%e9%97%b4%e7%9a%84%e8%b7%b3%e8%bd%ac">代码间的跳转
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%b0%83%e7%94%a8%e9%97%a8">调用门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e6%b5%8b%e8%af%95">测试
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%ad%e6%96%ad%e9%97%a8">中断门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%99%b7%e9%98%b1%e9%97%a8">陷阱门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%bb%e5%8a%a1%e6%ae%b5">任务段
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%bb%bb%e5%8a%a1%e9%97%a8">任务门
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%80%83%e8%af%95">考试
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#10-10-12%e5%88%86%e9%a1%b5">10-10-12分页
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pde_pte">PDE_PTE
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pde_pte%e5%b1%9e%e6%80%a7">PDE_PTE属性
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#pdt_ptt%e5%9f%ba%e5%9d%80">PDT_PTT基址
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#2-9-9-12%e5%88%86%e9%a1%b5">2-9-9-12分页
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#tlb">TLB
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e4%b8%ad%e6%96%ad%e4%b8%8e%e5%bc%82%e5%b8%b8">中断与异常
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%98%b6%e6%ae%b5%e6%b5%8b%e8%af%95">阶段测试
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e9%a9%b1%e5%8a%a8">驱动
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#01">01
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-8 rtl:hx-pr-8 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#02">02
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8">系统调用
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#01-1">01
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#02-1">02
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#03">03
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#04">04
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-4 rtl:hx-pr-4 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b">进程与线程
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#01-2">01
        </a>
      </li>
      <li class="hx-my-2 hx-scroll-my-6 hx-scroll-py-6">
        <a class="ltr:hx-pl-16 rtl:hx-pr-16 hx-inline-block hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-300 contrast-more:hx-text-gray-900 contrast-more:hx-underline contrast-more:dark:hx-text-gray-50 hx-w-full hx-break-words" href="#05">05
        </a>
      </li></ul>
      <div class="hx-mt-8 hx-border-t hx-bg-white hx-pt-8 hx-shadow-[0_-12px_16px_white] dark:hx-bg-dark dark:hx-shadow-[0_-12px_16px_#111] hx-sticky hx-bottom-0 hx-flex hx-flex-col hx-items-start hx-gap-2 hx-pb-8 dark:hx-border-neutral-800 contrast-more:hx-border-t contrast-more:hx-border-neutral-400 contrast-more:hx-shadow-none contrast-more:dark:hx-border-neutral-400">
        <button aria-hidden="true" id="backToTop" onClick="scrollUp();" class="hx-transition-all hx-duration-75 hx-opacity-0 hx-text-xs hx-font-medium hx-text-gray-500 hover:hx-text-gray-900 dark:hx-text-gray-400 dark:hover:hx-text-gray-100 contrast-more:hx-text-gray-800 contrast-more:dark:hx-text-gray-50">
          <span>Scroll to top</span>
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="hx-inline ltr:hx-ml-1 rtl:hx-mr-1 hx-h-3.5 hx-w-3.5 hx-border hx-rounded-full hx-border-gray-500 hover:hx-border-gray-900 dark:hx-border-gray-400 dark:hover:hx-border-gray-100 contrast-more:hx-border-gray-800 contrast-more:dark:hx-border-gray-50">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>
  </nav>


    <article class="hx-w-full hx-break-words hx-flex hx-min-h-[calc(100vh-var(--navbar-height))] hx-min-w-0 hx-justify-center hx-pb-8 hx-pr-[calc(env(safe-area-inset-right)-1.5rem)]">
      <main class="hx-w-full hx-min-w-0 hx-max-w-6xl hx-px-6 hx-pt-4 md:hx-px-12">
        
  <div class="hx-mt-1.5 hx-flex hx-items-center hx-gap-1 hx-overflow-hidden hx-text-sm hx-text-gray-500 dark:hx-text-gray-400 contrast-more:hx-text-current">
        <div class="hx-whitespace-nowrap hx-transition-colors hx-min-w-[24px] hx-overflow-hidden hx-text-ellipsis hover:hx-text-gray-900 dark:hover:hx-text-gray-100">
          <a href="/docs/">Docs</a>
        </div><svg class="hx-w-3.5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg><div class="hx-whitespace-nowrap hx-transition-colors hx-font-medium hx-text-gray-700 contrast-more:hx-font-bold contrast-more:hx-text-current dark:hx-text-gray-100 contrast-more:dark:hx-text-current">Homework</div>
  </div>

        <div class="content">
          <h1>Homework</h1>
          <h3>PE结构<span class="hx-absolute -hx-mt-20" id="pe结构"></span>
    <a href="#pe%e7%bb%93%e6%9e%84" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h4>内存分配—文件读写<span class="hx-absolute -hx-mt-20" id="内存分配文件读写"></span>
    <a href="#%e5%86%85%e5%ad%98%e5%88%86%e9%85%8d%e6%96%87%e4%bb%b6%e8%af%bb%e5%86%99" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>将记事本的<code>.exe</code>文件读取到内存，并返回读取后在内存中的地址</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">load</span>(<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> file_path, <span style="color:#66d9ef">size_t</span><span style="color:#f92672">*</span> size) {
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> file <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(file_path, <span style="color:#e6db74">&#34;rb&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>file) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(file, <span style="color:#ae81ff">0</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>size <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(file);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(file, <span style="color:#ae81ff">0</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> memory <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(<span style="color:#f92672">*</span>size);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>memory) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(file);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> read_size <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(memory, <span style="color:#ae81ff">1</span>, <span style="color:#f92672">*</span>size, file);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (read_size <span style="color:#f92672">!=</span> <span style="color:#f92672">*</span>size) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(memory);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(file);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(file);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> memory;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> path <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Windows</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">notepad.exe&#34;</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> file_memory <span style="color:#f92672">=</span> <span style="color:#a6e22e">load</span>(path, <span style="color:#f92672">&amp;</span>size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (file_memory) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;address: %p</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, file_memory);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;size: %zu bytes</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, size);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(file_memory);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>将内存中的数据存储到一个文件中，（<code>.exe</code>格式），然后双击打开，看是否能够使用</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> lpszFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;output.exe&#34;</span>;
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>pFile <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> fpw <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen_s</span>(<span style="color:#f92672">&amp;</span>pFile, lpszFile, <span style="color:#e6db74">&#34;rb&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>fpw)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fwrite</span>(pMemBuffer, <span style="color:#ae81ff">1</span>, size, fpw) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fclose</span>(fpw);			
</span></span><span style="display:flex;"><span>	fpw <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> size;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>PE头解析<span class="hx-absolute -hx-mt-20" id="pe头解析"></span>
    <a href="#pe%e5%a4%b4%e8%a7%a3%e6%9e%90" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">4</span><span style="color:#a6e22e">D</span>  <span style="color:#ae81ff">5</span><span style="color:#66d9ef">A</span>  <span style="color:#ae81ff">90</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">FF</span>  <span style="color:#66d9ef">FF</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">B8</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">D8</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span><span style="color:#960050;background-color:#1e0010">|</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">1</span><span style="color:#66d9ef">F</span>  <span style="color:#66d9ef">BA</span>  <span style="color:#ae81ff">0</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">B4</span>  <span style="color:#ae81ff">09</span>  <span style="color:#66d9ef">CD</span>  <span style="color:#ae81ff">21</span>  <span style="color:#66d9ef">B8</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">4</span><span style="color:#66d9ef">C</span>  <span style="color:#66d9ef">CD</span>  <span style="color:#ae81ff">21</span>  <span style="color:#ae81ff">54</span>  <span style="color:#ae81ff">68</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">69</span>  <span style="color:#ae81ff">73</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">70</span>  <span style="color:#ae81ff">72</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">F</span>  <span style="color:#ae81ff">67</span>  <span style="color:#ae81ff">72</span>  <span style="color:#ae81ff">61</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">63</span>  <span style="color:#ae81ff">61</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">F</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">74</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">62</span>  <span style="color:#ae81ff">65</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">72</span>  <span style="color:#ae81ff">75</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">69</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">44</span>  <span style="color:#ae81ff">4</span><span style="color:#66d9ef">F</span>  <span style="color:#ae81ff">53</span>  <span style="color:#ae81ff">20</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">6</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">F</span>  <span style="color:#ae81ff">64</span>  <span style="color:#ae81ff">65</span>  <span style="color:#ae81ff">2</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">0</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">0</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">0</span><span style="color:#66d9ef">A</span>  <span style="color:#ae81ff">24</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">31</span>  <span style="color:#ae81ff">42</span>  <span style="color:#ae81ff">8</span><span style="color:#66d9ef">C</span>  <span style="color:#66d9ef">CE</span>  <span style="color:#ae81ff">75</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">75</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">75</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">F6</span>  <span style="color:#ae81ff">3</span><span style="color:#66d9ef">F</span>  <span style="color:#66d9ef">EC</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">7</span><span style="color:#66d9ef">B</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">43</span>  <span style="color:#ae81ff">05</span>  <span style="color:#66d9ef">E8</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">43</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">75</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E3</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">46</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">17</span>  <span style="color:#ae81ff">3</span><span style="color:#66d9ef">C</span>  <span style="color:#66d9ef">F1</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">76</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">43</span>  <span style="color:#ae81ff">05</span>  <span style="color:#66d9ef">E9</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">76</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">52</span>  <span style="color:#ae81ff">69</span>  <span style="color:#ae81ff">63</span>  <span style="color:#ae81ff">68</span>  <span style="color:#ae81ff">75</span>  <span style="color:#ae81ff">23</span>  <span style="color:#66d9ef">E2</span>  <span style="color:#ae81ff">9</span><span style="color:#66d9ef">D</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">50</span>  <span style="color:#ae81ff">45</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#960050;background-color:#1e0010">|</span><span style="color:#ae81ff">4</span><span style="color:#66d9ef">C</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">05</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">4</span><span style="color:#66d9ef">A</span>  <span style="color:#ae81ff">11</span>  <span style="color:#66d9ef">BE</span>  <span style="color:#ae81ff">54</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">E0</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">0</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">01</span><span style="color:#960050;background-color:#1e0010">|</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0</span><span style="color:#66d9ef">B</span>  <span style="color:#ae81ff">01</span>  <span style="color:#ae81ff">06</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">A0</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">10</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">10</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">04</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">04</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#960050;background-color:#1e0010">00</span>  <span style="color:#a6e22e">C0</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> </span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>以这个为例吧</p>
<ul>
<li>
<p>找出所有<code>DOC</code>头数据，并统计<code>DOC</code>头大小</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">e_magic</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">4</span><span style="color:#66d9ef">D</span>  <span style="color:#ae81ff">5</span><span style="color:#66d9ef">A</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_cblp</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">90</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_cp</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_crlc</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_cparhdr</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_minalloc</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_maxalloc</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">FF</span>  <span style="color:#66d9ef">FF</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_ss</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_sp</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">B8</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_csum</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_ip</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_cs</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_lfarlc</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_ovno</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_res</span>[<span style="color:#ae81ff">4</span>] <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_oemid</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_oeminfo</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_res2</span>[<span style="color:#ae81ff">10</span>] <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">e_lfanew</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">D8</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>找出所有标准PE头数据，并统计标准PE头大小</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Signature</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Machine</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">4</span><span style="color:#66d9ef">C</span>  <span style="color:#ae81ff">01</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NumberOfSection</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">05</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">TimeDateStamp</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">4</span><span style="color:#66d9ef">A</span>  <span style="color:#ae81ff">11</span>  <span style="color:#66d9ef">BE</span>  <span style="color:#ae81ff">54</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PointerToSymbolTable</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NumberOfSymbols</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfOptionalHeader</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">E0</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Characteristics</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">E</span>  <span style="color:#ae81ff">01</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>找出所有可选PE头数据，并统计可选PE头大小</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Magic</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">B</span>  <span style="color:#ae81ff">01</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MajorLinkerVersion</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">06</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MinorLinkerVersion</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfCode</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfInitializedData</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">A0</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfUninitializedData</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">AddressOfEntryPoint</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">20</span>  <span style="color:#ae81ff">12</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BaseOfCode</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">BaseOfData</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ImageBase</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">40</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SectionAlignment</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">FileAlignment</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MajorOperatingSystemVersion</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MinorOperatingSystemVersion</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MajorImgdeVersion</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MinorImgdeVersion</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MajorSubsystemVersin</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">04</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">MinorSubsystemVersin</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Win32VersionValue</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfImage</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#66d9ef">C0</span>  <span style="color:#ae81ff">02</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfHeaders</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">CheckSum</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Subsystem</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">03</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">DllCharacteristics</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfStackReserve</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfStackCommit</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">SizeOfHeapReserve</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SizeOfHeapCommit</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">LoadFlags</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">NumberOfRvaAndSizes</span> <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#ae81ff">10</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span>  <span style="color:#ae81ff">00</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>编写程序读取一个<code>.exe</code>文件，输出所有的PE头信息</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FILEPATH &#34;C:\\Users\\Administrator\\Desktop\\HelloWorld.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>LPVOID <span style="color:#a6e22e">ReadPEFile</span>(LPSTR lpszFile)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>pFile <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    DWORD fileSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    LPVOID pFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">size_t</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 fopen_s 来打开文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fopen_s</span>(<span style="color:#f92672">&amp;</span>pFile, lpszFile, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> pFile <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    fileSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pFileBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(fileSize);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 使用 size_t 类型的变量来存储 fread 的返回值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    n <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(pFileBuffer, <span style="color:#ae81ff">1</span>, fileSize, pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">!=</span> fileSize)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pFileBuffer;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">PrintNTHeaders</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LPVOID pFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pFileBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">ReadPEFile</span>(FILEPATH);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Error reading the file.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查 DOS 头签名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((PWORD)pFileBuffer) <span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Not a valid PE file (DOS header signature mismatch).</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;DOS Header</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;MZ: %X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pDosHeader<span style="color:#f92672">-&gt;</span>e_magic);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;PE Offset: %X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 检查 NT 头签名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((PDWORD)((DWORD)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Not a valid PE file (NT header signature mismatch).</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">NT Header</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;NT Signature: %X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pNTHeader<span style="color:#f92672">-&gt;</span>Signature);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pPEHeader <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader;  <span style="color:#75715e">// 获取 PE 文件头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">PE File Header</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Machine: %X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pPEHeader<span style="color:#f92672">-&gt;</span>Machine);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Number of Sections: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pPEHeader<span style="color:#f92672">-&gt;</span>NumberOfSections);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Size of Optional Header: %X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pPEHeader<span style="color:#f92672">-&gt;</span>SizeOfOptionalHeader);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_FILE_HEADER));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">Optional Header</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Magic: %X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, pOptionHeader<span style="color:#f92672">-&gt;</span>Magic);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(pFileBuffer);  <span style="color:#75715e">// 释放文件缓冲区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">ReadPEFile</span>(FILEPATH);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">PrintNTHeaders</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>编写程序打印节表中的信息</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>偏移如下：
&#43;-------------------------&#43;  &lt;-- 文件开始
|     IMAGE_DOS_HEADER    |
&#43;-------------------------&#43;
|   Padding (对齐数据)    |
&#43;-------------------------&#43;  &lt;-- e_lfanew 指向这里
|    IMAGE_NT_HEADERS     |  &lt;-- pNTHeader
|  - Signature (4B)       |
|  - IMAGE_FILE_HEADER    |
|  - IMAGE_OPTIONAL_HEADER|
&#43;-------------------------&#43;
|   IMAGE_SECTION_HEADER  |  &lt;-- 节表开始
|       Section[0]        |
|       Section[1]        |
|          ...            |
&#43;-------------------------&#43;

还有就是从pNTHeader开始找IMAGE_SECTION_HEADER的过程，其中注意sizeof(IMAGE_OPTIONAL_HEADER)是编译时定义的常量，就是理论大小;而pNTHeader-&gt;FileHeader.SizeOfOptionalHeader表示实际的 IMAGE_OPTIONAL_HEADER 大小</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define FILEPATH &#34;C:\\Users\\Administrator\\Desktop\\notepad.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>LPVOID <span style="color:#a6e22e">ReadPEFile</span>(LPSTR lpszFile)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>pFile <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    DWORD fileSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    LPVOID pFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fopen_s</span>(<span style="color:#f92672">&amp;</span>pFile, lpszFile, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> pFile <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    fileSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pFileBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(fileSize);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(pFileBuffer, <span style="color:#ae81ff">1</span>, fileSize, pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">!=</span> fileSize)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pFileBuffer;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">PrintNTSections</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LPVOID pFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> name[<span style="color:#ae81ff">9</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pFileBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">ReadPEFile</span>(FILEPATH);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Error reading the file.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((PWORD)pFileBuffer) <span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Not a valid PE file (DOS header signature mismatch).</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>((PDWORD)((DWORD_PTR)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Not a valid PE file (NT header signature mismatch).</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD_PTR)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_NT_HEADERS) <span style="color:#f92672">-</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_OPTIONAL_HEADER) <span style="color:#f92672">+</span> pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader.SizeOfOptionalHeader);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Section Headers:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Name</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Virtual Address</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Size</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">Raw Data Pointer</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (; i <span style="color:#f92672">&lt;</span> pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader.NumberOfSections; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">strncpy</span>(name, (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)pSectionHeader[i].Name, <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">0x%08X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,
</span></span><span style="display:flex;"><span>               name,
</span></span><span style="display:flex;"><span>               pSectionHeader[i].VirtualAddress,
</span></span><span style="display:flex;"><span>               pSectionHeader[i].Misc.VirtualSize,
</span></span><span style="display:flex;"><span>               pSectionHeader[i].PointerToRawData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">PrintNTSections</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>FileBuffer-ImageBuffer<span class="hx-absolute -hx-mt-20" id="filebuffer-imagebuffer"></span>
    <a href="#filebuffer-imagebuffer" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>实现如下功能:</p>
<p><img src="https://c65mael.github.io/homework/pe-h1.png" alt="image" loading="lazy" /></p>
<p>编写一个函数，能够将<code>RVA</code>的值转换成<code>FOA</code></p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//函数声明								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//ReadPEFile:将文件读取到缓冲区								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//参数说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//lpszFile 文件路径								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pFileBuffer 缓冲区指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//返回值说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//读取失败返回0  否则返回实际读取的大小								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DWORD <span style="color:#a6e22e">ReadPEFile</span>(IN LPSTR lpszFile,OUT LPVOID<span style="color:#f92672">*</span> pFileBuffer);								
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	FILE <span style="color:#f92672">*</span>pFile <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    DWORD fileSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">size_t</span> n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fopen_s</span>(<span style="color:#f92672">&amp;</span>pFile, lpszFile, <span style="color:#e6db74">&#34;rb&#34;</span>) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> pFile <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0</span>, SEEK_END);
</span></span><span style="display:flex;"><span>    fileSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile, <span style="color:#ae81ff">0</span>, SEEK_SET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pFileBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(fileSize);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    n <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(pFileBuffer, <span style="color:#ae81ff">1</span>, fileSize, pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (n <span style="color:#f92672">!=</span> fileSize)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> fileSize;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//CopyFileBufferToImageBuffer:将文件从FileBuffer复制到ImageBuffer								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//参数说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pFileBuffer  FileBuffer指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pImageBuffer ImageBuffer指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//返回值说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//读取失败返回0  否则返回复制的大小								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DWORD <span style="color:#a6e22e">CopyFileBufferToImageBuffer</span>(IN LPVOID pFileBuffer,OUT LPVOID<span style="color:#f92672">*</span> pImageBuffer);	
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (pFileBuffer <span style="color:#f92672">==</span> NULL <span style="color:#f92672">||</span> pImageBuffer <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pImageBuffer;
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>    pPEHeader <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader;
</span></span><span style="display:flex;"><span>    pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)<span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader;
</span></span><span style="display:flex;"><span>    pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_NT_HEADERS));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pImageBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(pOptionHeader <span style="color:#f92672">-&gt;</span> SizeOfImage);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>pImageBuffer <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">*</span>pImageBuffer, pFileBuffer, pOptionHeader <span style="color:#f92672">-&gt;</span> SizeOfImage);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(;i<span style="color:#f92672">&lt;</span>pFileHeader<span style="color:#f92672">-&gt;</span>NumberOfSections;i<span style="color:#f92672">++</span>,pSectionHeader<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>((LPVOID)((DWORD)<span style="color:#f92672">*</span>ppImageBuffer<span style="color:#f92672">+</span>pSectionHeader<span style="color:#f92672">-&gt;</span>VirtualAddress),(LPVOID)((DWORD)pFileBuffer<span style="color:#f92672">+</span>pSectionHeader<span style="color:#f92672">-&gt;</span>PointerToRawData),pSectionHeader<span style="color:#f92672">-&gt;</span>SizeOfRawData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pOptionHeader <span style="color:#f92672">-&gt;</span> SizeOfImage;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//CopyImageBufferToNewBuffer:将ImageBuffer中的数据复制到新的缓冲区								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//参数说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pImageBuffer ImageBuffer指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pNewBuffer NewBuffer指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//返回值说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//读取失败返回0  否则返回复制的大小								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DWORD <span style="color:#a6e22e">CopyImageBufferToNewBuffer</span>(IN LPVOID pImageBuffer,OUT LPVOID<span style="color:#f92672">*</span> pNewBuffer);
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pImageBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pImageBuffer;
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>    pPEHeader <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader;
</span></span><span style="display:flex;"><span>    pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)<span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader;
</span></span><span style="display:flex;"><span>    pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_NT_HEADERS));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">*</span>pImageBuffer, pNewBuffer, pOptionHeader <span style="color:#f92672">-&gt;</span> SizeOfImage);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(;i<span style="color:#f92672">&lt;</span>pFileHeader<span style="color:#f92672">-&gt;</span>NumberOfSections;i<span style="color:#f92672">++</span>,pSectionHeader<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>((LPVOID)((DWORD)<span style="color:#f92672">*</span>ppImageBuffer<span style="color:#f92672">+</span>pSectionHeader<span style="color:#f92672">-&gt;</span>VirtualAddress),(LPVOID)((DWORD)pNewBuffer<span style="color:#f92672">+</span>pSectionHeader<span style="color:#f92672">-&gt;</span>PointerToRawData),pSectionHeader<span style="color:#f92672">-&gt;</span>SizeOfRawData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pOptionHeader <span style="color:#f92672">-&gt;</span> SizeOfImage;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//MemeryTOFile:将内存中的数据复制到文件								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//参数说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pMemBuffer 内存中数据的指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//size 要复制的大小								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//lpszFile 要存储的文件路径								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//返回值说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//读取失败返回0  否则返回复制的大小								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>BOOL <span style="color:#a6e22e">MemeryTOFile</span>(IN LPVOID pMemBuffer,IN <span style="color:#66d9ef">size_t</span> size,OUT LPSTR lpszFile);
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE <span style="color:#f92672">*</span>pFile <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> fpw <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen_s</span>(<span style="color:#f92672">&amp;</span>pFile, lpszFile, <span style="color:#e6db74">&#34;rb&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>fpw)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">fwrite</span>(pMemBuffer, <span style="color:#ae81ff">1</span>, size, fpw) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fclose</span>(fpw);			
</span></span><span style="display:flex;"><span>	fpw <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> size;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//RvaToFileOffset:将内存偏移转换为文件偏移								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//参数说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//pFileBuffer FileBuffer指针								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//dwRva RVA的值								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//返回值说明：								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//返回转换后的FOA的值  如果失败返回0								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//**************************************************************************								
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DWORD <span style="color:#a6e22e">RvaToFileOffset</span>(IN LPVOID pFileBuffer,IN DWORD dwRva);
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    DWORD sectionCount <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    DWORD dwFoa <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (pFileBuffer <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pImageBuffer;
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>    pPEHeader <span style="color:#f92672">=</span> <span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader;
</span></span><span style="display:flex;"><span>    pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)<span style="color:#f92672">&amp;</span>pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader;
</span></span><span style="display:flex;"><span>    pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)((DWORD_PTR)pNTHeader <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_NT_HEADERS));
</span></span><span style="display:flex;"><span>    sectionCount <span style="color:#f92672">=</span> pNtHeaders<span style="color:#f92672">-&gt;</span>FileHeader.NumberOfSections;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(;i <span style="color:#f92672">&lt;</span> sectionCount;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(dwRva <span style="color:#f92672">&gt;=</span> pSectionHeader[i].VirtualAddress <span style="color:#f92672">&amp;&amp;</span> dwRva <span style="color:#f92672">&lt;</span> pSectionHeader[i].VirtualAddress <span style="color:#f92672">+</span> pSectionHeader[i].SizeOfRawData)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            dwFoa <span style="color:#f92672">=</span> dwRva <span style="color:#f92672">-</span> pSectionHeader[i].VirtualAddress <span style="color:#f92672">+</span> pSectionHeader[i].PointerToRawData;
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> dwFoa;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>自己不会写，把大佬的全部抄了一遍（自己真的写不出来😭）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// globlepdd.h: interface for the globlepdd class.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//////////////////////////////////////////////////////////////////////
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if !defined(AFX_GLOBLEPDD_H__DDA6AB97_A94D_41F9_B3B9_8426B6CB7934__INCLUDED_)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define AFX_GLOBLEPDD_H__DDA6AB97_A94D_41F9_B3B9_8426B6CB7934__INCLUDED_
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#if _MSC_VER &gt; 1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma once
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">// _MSC_VER &gt; 1000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//#define FILEPATH_IN         &#34;C:\\WINDOWS\\system32\\kernel32.dll&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//#define FilePath_In         &#34;C:\\Windows\\notepad.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define FilePath_In         &#34;C:\\Windows\\Input.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">//#define FilePath_Out        &#34;C:\\Windows\\notepadnewpes.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#define FilePath_Out        &#34;C:\\Windows\\Out.exe&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define MESSAGEBOXADDR      0x77D5050B
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#define SHELLCODELENGTH     0x12 </span><span style="color:#75715e">//16进制的，转换为十进制就是18
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> BYTE ShellCode[];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">ReadPEFile</span>(IN LPSTR lpszFile,OUT LPVOID<span style="color:#f92672">*</span> pFileBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">CopyFileBufferToImageBuffer</span>(IN LPVOID pFileBuffer,OUT LPVOID<span style="color:#f92672">*</span> pImageBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">CopyImageBufferToNewBuffer</span>(IN LPVOID pImageBuffer,OUT LPVOID<span style="color:#f92672">*</span> pNewBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">MemeryTOFile</span>(IN LPVOID pMemBuffer,IN <span style="color:#66d9ef">size_t</span> size,OUT LPSTR lpszFile);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//DWORD RvaToFileOffset(IN LPVOID pFileBuffer,IN DWORD dwRva);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">AddCodeInCodeSec</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#endif </span><span style="color:#75715e">// !defined(AFX_GLOBLEPDD_H__DDA6AB97_A94D_41F9_B3B9_8426B6CB7934__INCLUDED_)
</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// globlepdd.cpp: implementation of the globlepdd class.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//////////////////////////////////////////////////////////////////////
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;stdafx.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;globlepdd.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//////////////////////////////////////////////////////////////////////
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Construction/Destruction
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//////////////////////////////////////////////////////////////////////
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>BYTE ShellCode[] <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">0x6A</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">0x6A</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">0x6A</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">0x6A</span>,<span style="color:#ae81ff">00</span>, <span style="color:#75715e">//push 0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0xE8</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>,  <span style="color:#75715e">// call
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#ae81ff">0xE9</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>,<span style="color:#ae81ff">00</span>   <span style="color:#75715e">// jmp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">ReadPEFile</span>(IN LPSTR lpszFile, OUT LPVOID<span style="color:#f92672">*</span> pFileBuffer)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> pFile <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    DWORD fileSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    LPVOID pTempFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//open
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pFile <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(lpszFile,<span style="color:#e6db74">&#34;rb&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFile)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//size
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0</span>,SEEK_END);
</span></span><span style="display:flex;"><span>    fileSize <span style="color:#f92672">=</span> <span style="color:#a6e22e">ftell</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fseek</span>(pFile,<span style="color:#ae81ff">0</span>,SEEK_SET);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//malloc
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pTempFileBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(fileSize);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pTempFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//read memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">size_t</span> n <span style="color:#f92672">=</span> <span style="color:#a6e22e">fread</span>(pTempFileBuffer,fileSize,<span style="color:#ae81ff">1</span>,pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>n)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pTempFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//succeed close file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>pFileBuffer <span style="color:#f92672">=</span> pTempFileBuffer;
</span></span><span style="display:flex;"><span>    pTempFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(pFile);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> fileSize;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">CopyFileBufferToImageBuffer</span>(IN LPVOID pFileBuffer,OUT LPVOID<span style="color:#f92672">*</span> pImageBuffer)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTIOM_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    LPVOID pTempImageBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(pFileBuffer <span style="color:#f92672">==</span> NULL)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pFileBuffer)<span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PDWORD)((DOWRD)pFileBuffer<span style="color:#f92672">+</span>pDosHeader <span style="color:#f92672">-&gt;</span> e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//NT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADER)((DWORD)pFileBuffer<span style="color:#f92672">+</span>pDosHeader <span style="color:#f92672">-&gt;</span> e_lfanew);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//PE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader)<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//OPT PE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTION_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//SEC HEADER
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTIOM_HEADER)((DWORD)pOptionHeader <span style="color:#f92672">+</span> pPEHeader<span style="color:#f92672">-&gt;</span>SizeOfOptionalHeader);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pTempImageBuffer <span style="color:#f92672">=</span> <span style="color:#a6e22e">malloc</span>(pOptionHeader<span style="color:#f92672">-&gt;</span>SizeOfImage);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>pTempImageBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memset</span>(pTempImageBuffer,<span style="color:#ae81ff">0</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>SizeOfImage);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(pTempImageBuffer,pDosHeader,pOptionHeader<span style="color:#f92672">-&gt;</span>SizeOfheHeaders);
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pTempSectionHeader <span style="color:#f92672">=</span> pSectionHeader;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span>pPEHeader<span style="color:#f92672">-&gt;</span>NumberOfSections;i<span style="color:#f92672">++</span>,pTempSectionHeader<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">memcpy</span>((<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)((DWORD)pTempImageBuffer<span style="color:#f92672">+</span>pTempSectionHeader<span style="color:#f92672">-&gt;</span>VirtualAddress),(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span>)((DWORD)pFileBuffer<span style="color:#f92672">+</span>pTempSectionHeader<span style="color:#f92672">-&gt;</span>PointerToRawData),pTempSectionHeader<span style="color:#f92672">-&gt;</span>SizeOfRawData);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>pImageBuffer<span style="color:#f92672">=</span>pTempImageBuffer;
</span></span><span style="display:flex;"><span>    pTempImageBuffer<span style="color:#f92672">=</span>NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> pOptionHeader<span style="color:#f92672">-&gt;</span>SizeOfImage;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">MemeryTOFile</span>(IN LPVOID pMemBuffer,IN <span style="color:#66d9ef">size_t</span> size,OUT LPSTR lpszFile)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> fp <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    fp <span style="color:#f92672">=</span> <span style="color:#a6e22e">fopen</span>(lpFile,<span style="color:#e6db74">&#34;wb+&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>fp)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fwrite</span>(pMemBuffer,size,<span style="color:#ae81ff">1</span>,fp);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fclose</span>(fp);
</span></span><span style="display:flex;"><span>    fp <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">RvaToFileOffset</span>(IN LPVOID pFileBuffer,IN DWORD dwRva)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    DWORD dwFOAValue <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dwFOValue;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pFileBuffer)<span style="color:#f92672">!=</span>IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> dwFOValue;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer<span style="color:#f92672">+</span>pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>    pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader<span style="color:#f92672">+</span>IMAGE_SIZEOF_FILE_HEADER);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>解释：</p>
<blockquote>
  <p><code>fseek</code>通过使用二进制的方式打开文件，移动文件读写指针的位置，在<code>stdio.h</code>头文件里</p>
<p><code>int fseek(FILE * stream, long offset, int fromwhere);</code></p>
<p>上面是<code>fseek</code>的函数原型
第一个参数<code>stream</code>为文件指针
第二个参数<code>offset</code>为偏移量，整数表示正向偏移，负数表示负向偏移
第三个参数<code>fromwhere</code>为指针的起始位置,设定从文件的哪里开始偏移,可能取值为：<code>SEEK_CUR，SEEK_END，SEEK_SET</code>
<code>SEEK_SET</code> 0 文件开头
<code>SEEK_CUR</code> 1 当前读写的位置
<code>SEEK_END</code> 2 文件尾部</p>
<p><code>ftell()</code>用于返回文件当前指针指向的位置，与<code>fseek</code>配合可以算出文件元素数据总数。</p>
<p><code>ftell()</code>函数用来获取文件读写指针的当前位置，其原型为：<code>long ftell(FILE * stream)</code>; 同样在<code>stdio.h</code>头文件里</p>
<p><code>void* malloc (size_t size);</code>
<code>size_t</code> &mdash;&gt; <code>typedef unsigned int size_t</code>；无符号整型别名是<code>size_t</code>
<code>void*</code>  &mdash;&gt; 函数的返回值类型是<code>void*</code>；<code>void</code>并不是说没有返回值或者返回空指针，而是返回的指针类型未知;
所以在使用<code>malloc()</code>时通常需要进行强制类型转换，将 void 指针转换成我们希望的类型;
例如：<code>char *ptr = (char *)malloc(10);</code>  //分配10个字节的内存空间，用来存放字符
参数说明 &mdash;&gt; <code>size</code> 为需要分配的内存空间的大小，以字节（<code>Byte</code>）计。
函数说明 &mdash;&gt; <code>malloc()</code>在堆区分配一块指定大小的内存空间，用来存放数据。这块内存空间在函数执行完成后不会被初始化;
它们的值是未知的，所以分配完成内存之后需要初始化；
返回值:分配成功返回指向该内存的地址，失败则返回<code>NULL</code>。</p>
<p><code>LPVOID</code> &mdash;-&gt;  <code>typedef void far *LPVOID</code>；在<code>WINDEF.H</code>头文件里面；别名的<code>void</code>指针类型</p>
<p><code>PIMAGE_DOS_HEADER</code> &mdash;&gt; 指向结构体，别名为这两个<code>IMAGE_DOS_HEADER</code>, <code>*PIMAGE_DOS_HEADER</code>
<code>PIMAGE_NT_HEADERS</code> &mdash;&gt; 指向结构体，<code>typedef PIMAGE_NT_HEADERS32</code>    <code>PIMAGE_NT_HEADERS</code>;
<code>PIMAGE_FILE_HEADER</code> &mdash;&gt; 指向结构体，别名为这两个<code>IMAGE_FILE_HEADER</code>, <code>*PIMAGE_FILE_HEADER</code>;
<code>PIMAGE_OPTIONAL_HEADER32</code> &mdash;&gt; 指向结构体，别名为这两个 <code>IMAGE_OPTIONAL_HEADER32</code>，<code>*PIMAGE_OPTIONAL_HEADER32</code>;
<code>PIMAGE_SECTION_HEADER</code> &mdash;&gt; 指向结构体，别名为这两个<code>IMAGE_SECTION_HEADER</code>，<code>*PIMAGE_SECTION_HEADER</code>;</p>
<p><code>IMAGE_DOS_SIGNATURE</code>这个在头文件<code>WINNT.H</code>里面，对应是个无参数宏；
<code>#define IMAGE_DOS_SIGNATURE                 0x5A4D      // MZ</code>
在宏扩展的时候就会替换为<code>0x5A4D</code>，然后根据架构的不同进行排序存储，分大端和小端模式；
使用上面方式进行比对是否是有效的<code>MZ</code>头是非常有效；
而且<code>IMAGE_DOS_SIGNATURE</code>存储的值是两个字节，刚好就是<code>PWORD</code> &mdash;&gt; <code>typedef WORD near *PWORD</code>；
所以在进行比较的时候需要强制类型转换为相同的类型进行比较</p>
<p><code>IMAGE_NT_SIGNATURE</code>  &mdash;&gt; <code>#define IMAGE_NT_SIGNATURE   0x00004550  // PE00</code>
上述同样是个宏扩展，在头文件<code>WINNT.H</code>里面；
在进行比对的时候因为在<code>Dos</code>头里面有个值是<code>e_lfanew</code>对应的时候<code>DWORD</code>类型，所以在进行指针相加的时候
需要先进行强制类型转换，然后相加，即移动指针位置；然后最终需要比对的结果是<code>0x4550</code>站两个字节
所以又要强制转换类型为<code>PWORD</code>；</p>
<p><code>IMAGE_SIZEOF_FILE_HEADER</code>也是个宏扩展，里面字节描述了<code>PE</code>文件头的大小是20个字节；
<code>#define IMAGE_SIZEOF_FILE_HEADER  20</code>，所以只要在PE文件头的首地址偏移20个字节即可移动到可选<code>PE</code>头；
指针相加的时候，此处的类型依然是<code>DWORD</code></p>
<p>到了节表的首地址位置之后，因为需要将<code>FileBuffer</code>复制到<code>ImageBuffer</code>，这个过程中，节表之前的<code>Dos</code>头，<code>NT</code>头
<code>PE</code>文件头，可选<code>PE</code>头，它们的大小都是不变的，所以定位出来之后，到后面的操作中直接复制即可，而节表不一样
它在<code>FileBuffer</code>状态和<code>ImageBuffer</code>状态是不相同的，它们节表之间复制转换到<code>ImageBuffer</code>是需要拉长节表，所以
在操作的时候是需要确定<code>FileBuffer</code>到<code>ImageBuffer</code>之后<code>ImageBuffer</code>的大小是多少，而这个大小，已经在可选<code>PE</code>头
里面的某一个值中已经给出来了 &mdash;&gt; <code>SizeOfImage</code> ;</p>
<p><code>void* memset( void* ptr,int value,size_t num );</code>
<code>memset()</code>函数用来将指定内存的前n个字节设置为特定的值;</p>
<p>参数说明：
<code>ptr</code>：为要操作的内存的指针;
<code>value</code>：为要设置的值;既可以向value传递int类型的值,也可以传递<code>char</code>类型的值，<code>int</code>和<code>char</code>可以根据<code>ASCII</code>码相互转换;
<code>num</code>：为<code>ptr</code>的前<code>num</code>个字节，<code>size_t</code>就是<code>unsigned int</code>。
函数说明：<code>memset()</code>会将<code>ptr</code>所指的内存区域的前<code>num</code>个字节的值都设置为<code>value</code>，然后返回指向<code>ptr</code>的指针；</p>
<p><code>void* memcpy (void* dest,const void* src,size_t num);</code>
<code>memcpy()</code>函数功能用来复制内存的；她会复制<code>src</code>所指向内容的首地址，作为起始位置，然后偏移<code>num</code>个字节到<code>dest</code>所指的内存地址
的位置；此函数有个特征就是，她并不关心被复制的数据类型，只是逐字节地进行复制，这给函数的使用带来了很大的灵活性，
可以面向任何数据类型进行复制；</p>
<p>需要注意的是：
<code>dest</code>指针要分配足够的空间，也就是要大于等于<code>num</code>字节的空间，如果没有分配足够的空间会出现错误；
<code>dest</code>和<code>src</code>所指的内存空间不能重叠（如果发生了重叠，使用<code>memmove()</code>会更加安全）。</p>
</blockquote>
</li>
</ul>
<h4>代码节空白区添加代码<span class="hx-absolute -hx-mt-20" id="代码节空白区添加代码"></span>
    <a href="#%e4%bb%a3%e7%a0%81%e8%8a%82%e7%a9%ba%e7%99%bd%e5%8c%ba%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%a0%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>在代码空白区添加代码（手动）</p>
<p>我找的这个程序是之前的那个<code>crackme</code>，由于文件对齐和内存对齐不一样，所以要算一下。<code>CODE</code>节开头在文件中是<code>600h</code>，在内存中是<code>1000h</code>，换算关系为：<code>内存地址 = 文件地址 - 600 + 1000</code>。防止头晕所以全部转为内存地址计算就可以了，视频中说的那个<code>MessageboxA</code>地址就直接用<code>CODE</code>节那里面的函数地址是<code>CODE:0040143A</code>。加到第一个节的文件中的<code>B90</code>位置，仔细算一下要跳的地址就行，一定要按小端序来写：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>6A 00 6A 00 6A 00 6A 00 E8 9D FE FF FF E9 5E FA FF FF</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>再将<code>oep</code>改为<code>1590h</code>就好了。</p>
</li>
</ul>
<h4>任意代码空白区添加代码<span class="hx-absolute -hx-mt-20" id="任意代码空白区添加代码"></span>
    <a href="#%e4%bb%bb%e6%84%8f%e4%bb%a3%e7%a0%81%e7%a9%ba%e7%99%bd%e5%8c%ba%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%a0%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>向代码节添加代码编程实现</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>VOID <span style="color:#a6e22e">ADDCodeInCodeSec</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LPVOID pFileBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    LPVOID pImageBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    LPVOID pNewBuffer <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PBYTE codeBegin <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    BOOL isOK <span style="color:#f92672">=</span> FALSE;
</span></span><span style="display:flex;"><span>    DWORD size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ReadPEFile</span>(FilePath_In,<span style="color:#f92672">&amp;</span>pFileBuffer);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">CopyFileBufferToImageBuffer</span>(pFileBuffer,<span style="color:#f92672">&amp;</span>pImageBuffer);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pImageBuffer;
</span></span><span style="display:flex;"><span>    pOprionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)(((DWORD)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER);
</span></span><span style="display:flex;"><span>    pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)(((DWORD)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span> <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER <span style="color:#f92672">+</span> IMAGE_SIZEOF_NT_OPTIONAL32_HEADER);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (((pSectionHeader<span style="color:#f92672">-&gt;</span>SizeOfRawData) <span style="color:#f92672">-</span> (pSectionHeader<span style="color:#f92672">-&gt;</span>Misc.VirtualSize)) <span style="color:#f92672">&lt;</span> SHELLCODELENGTH)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pImageBuffer);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    codeBegin <span style="color:#f92672">=</span> (PBYTE)((DWORD)pImageBuffer <span style="color:#f92672">+</span> pSectionHeader<span style="color:#f92672">-&gt;</span>VirtualAddress <span style="color:#f92672">+</span> pSectionHeader<span style="color:#f92672">-&gt;</span>Misc.VirtualSize);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pSectionHeader-&gt;VirtualAddress: %#010X</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, pSectionHeader<span style="color:#f92672">-&gt;</span>VirtualAddress);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pSectionHeader-&gt;Misc.VirtualSize: %#010X</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, pSectionHeader<span style="color:#f92672">-&gt;</span>Misc.VirtualSize);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;codeBegin: %#010X</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>, codeBegin);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">memcpy</span>(codeBegin,ShellCode,SHELLCODELENGTH);
</span></span><span style="display:flex;"><span>    DWORD callAddr <span style="color:#f92672">=</span> (MESSAGEBOXADDR <span style="color:#f92672">-</span> (pOptionHeader<span style="color:#f92672">-&gt;</span>ImageBase <span style="color:#f92672">+</span> ((DWORD)(codeBegin <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xD</span>) <span style="color:#f92672">-</span> (DWORD)pImageBuffer)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;callAddr ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,callAddr);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(PDWORD)(codeBegin <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x09</span>) <span style="color:#f92672">=</span> callAddr;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;*(PWORD)(codeBegin + 0x09) ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">*</span>(PDWORD)(codeBegin <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x09</span>));
</span></span><span style="display:flex;"><span>    DWORD jmpAddr <span style="color:#f92672">=</span> ((pOptionHeader<span style="color:#f92672">-&gt;</span>ImageBase <span style="color:#f92672">+</span> pOptionHeader<span style="color:#f92672">-&gt;</span>AddressOfEntryPoint) <span style="color:#f92672">-</span> (pOptionHeader<span style="color:#f92672">-&gt;</span>ImageBase <span style="color:#f92672">+</span> ((DWORD)(codeBegin <span style="color:#f92672">+</span> SHELLCODELENGTH) <span style="color:#f92672">-</span> (DWORD)pImageBuffer)));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;jmpAddr ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,jmpAddr);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(PDWORD)(codeBegin <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0E</span>) <span style="color:#f92672">=</span> jmpAddr;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;*(PWORD)(codeBegin + 0x0E) ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">*</span>(PDWORD)(codeBegin <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x0E</span>));
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pOptionHeader-&gt;AddressOfEntryPoint ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>AddressOfEntryPoint);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;(DWORD)codeBegin ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,((DWORD)codeBegin <span style="color:#f92672">-</span> (DWORD)pImageBuffer));
</span></span><span style="display:flex;"><span>    pOptionHeader<span style="color:#f92672">-&gt;</span>AddressOfEntryPoint <span style="color:#f92672">=</span> (DWORD)codeBegin <span style="color:#f92672">-</span> (DWORD)pImageBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;pOptionHeader-&gt;AddressOfEntryPoint ---&gt; %#010X </span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>AddressOfEntryPoint);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    size <span style="color:#f92672">=</span> <span style="color:#a6e22e">CopyImageBufferToNewBuffer</span>(pImageBuffer,<span style="color:#f92672">&amp;</span>pNewBuffer);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (size <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>pNewBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">free</span>(pImageBuffer);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    isOK <span style="color:#f92672">=</span> <span style="color:#a6e22e">MemeryTOFile</span>(pNewBuffer,size,FilePath_Out);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (isOK)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(pFileBuffer);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(pImageBuffer);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">free</span>(pNewBuffer);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>向其他节空白区添加代码编程实现</p>
</li>
</ul>
<h4>新增节-添加代码<span class="hx-absolute -hx-mt-20" id="新增节-添加代码"></span>
    <a href="#%e6%96%b0%e5%a2%9e%e8%8a%82-%e6%b7%bb%e5%8a%a0%e4%bb%a3%e7%a0%81" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>手动新增一个节表和节，保证修改后的程序能正确执行</p>
<ol>
<li>改<code>SizeOfImage</code></li>
<li>改节的个数</li>
<li>加一个节表，并修正</li>
<li>到文件最后加对应大小的位置</li>
</ol>
</li>
<li>
<p>编程实现：新增一个节，并添加代码</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">AddFileBufferToSectionTable</span>(IN LPVOID pFileBuffer,OUT LPVOID<span style="color:#f92672">*</span> pNewBuffer,IN <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> sectionTable,IN <span style="color:#66d9ef">size_t</span> SsectionTableSize)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//NT头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pDosHeader <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//标准PE头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x4</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//可选PE头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//节表解析
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)((DWORD)pOptionHeader <span style="color:#f92672">+</span> pPEHeader<span style="color:#f92672">-&gt;</span>SizeOfOptionalHeader);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//计算空间是否足够
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD whiteSpaceSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    whiteSpaceSize <span style="color:#f92672">=</span> pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader.SizeOfHeaders <span style="color:#f92672">-</span> (pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(pNTHeader<span style="color:#f92672">-&gt;</span>Signature) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader) <span style="color:#f92672">+</span> pPEHeader<span style="color:#f92672">-&gt;</span>SizeOfOptionalHeader <span style="color:#f92672">+</span> ((pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader.NumberOfSections <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_SECTION_HEADER)));
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (whiteSpaceSize <span style="color:#f92672">&lt;</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_SECTION_HEADER))
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;数据缓冲区太小无法添加节表！&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//Copy一个新的节表 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> pTmpFile <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> pTmpFileCopy <span style="color:#f92672">=</span> (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer;
</span></span><span style="display:flex;"><span>	pTmpFile <span style="color:#f92672">=</span> pTmpFile <span style="color:#f92672">+</span> (pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(pNTHeader<span style="color:#f92672">-&gt;</span>Signature) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader) <span style="color:#f92672">+</span> pPEHeader<span style="color:#f92672">-&gt;</span>SizeOfOptionalHeader);
</span></span><span style="display:flex;"><span>	pTmpFileCopy <span style="color:#f92672">=</span> pTmpFileCopy <span style="color:#f92672">+</span> (pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(pNTHeader<span style="color:#f92672">-&gt;</span>Signature) <span style="color:#f92672">+</span> <span style="color:#66d9ef">sizeof</span>(pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader) <span style="color:#f92672">+</span> pPEHeader<span style="color:#f92672">-&gt;</span>SizeOfOptionalHeader <span style="color:#f92672">+</span> ((pNTHeader<span style="color:#f92672">-&gt;</span>FileHeader.NumberOfSections) <span style="color:#f92672">*</span> <span style="color:#66d9ef">sizeof</span>(IMAGE_SECTION_HEADER)));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memcpy</span>(pTmpFileCopy, pTmpFile, <span style="color:#66d9ef">sizeof</span>(IMAGE_SECTION_HEADER));
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//在新增节后面 填充一个节大小的000 (忽略)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//修改PE头中节的数量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pPEHeader<span style="color:#f92672">-&gt;</span>NumberOfSections <span style="color:#f92672">=</span> pPEHeader<span style="color:#f92672">-&gt;</span>NumberOfSections <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//修改sizeOfImage的大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pOptionHeader<span style="color:#f92672">-&gt;</span>SizeOfImage <span style="color:#f92672">=</span> pOptionHeader<span style="color:#f92672">-&gt;</span>SizeOfImage <span style="color:#f92672">+</span> SsectionTableSize;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//再原有数据的最后，新增一个节的数据(内存对齐的整数倍)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//使用PE结构计算文件大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_SECTION_HEADER pTempSectionHeaderTo <span style="color:#f92672">=</span> pSectionHeader;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (DWORD i <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>; i <span style="color:#f92672">&lt;</span> pPEHeader<span style="color:#f92672">-&gt;</span>NumberOfSections; i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>		pTempSectionHeaderTo<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>	DWORD fileSize <span style="color:#f92672">=</span> pTempSectionHeaderTo<span style="color:#f92672">-&gt;</span>SizeOfRawData <span style="color:#f92672">+</span> pTempSectionHeaderTo<span style="color:#f92672">-&gt;</span>PointerToRawData;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//申请File大小空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span>pNewBuffer <span style="color:#f92672">=</span> (PDWORD)<span style="color:#a6e22e">malloc</span>(fileSize <span style="color:#f92672">+</span> SsectionTableSize);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#f92672">!*</span>pNewBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>, <span style="color:#e6db74">&#34;申请ImageBuffer失败！&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">free</span>(<span style="color:#f92672">*</span>pNewBuffer);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> false;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memset</span>(<span style="color:#f92672">*</span>pNewBuffer, <span style="color:#ae81ff">0</span>, fileSize <span style="color:#f92672">+</span> SsectionTableSize);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//修正节表属性
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_SECTION_HEADER pTempSectionHeaderTo2 <span style="color:#f92672">=</span> (PIMAGE_SECTION_HEADER)pTmpFileCopy;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memcpy</span>(pTempSectionHeaderTo2<span style="color:#f92672">-&gt;</span>Name, sectionTable, <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>	pTempSectionHeaderTo2<span style="color:#f92672">-&gt;</span>Misc.VirtualSize <span style="color:#f92672">=</span> SsectionTableSize;
</span></span><span style="display:flex;"><span>	pTempSectionHeaderTo2<span style="color:#f92672">-&gt;</span>VirtualAddress <span style="color:#f92672">=</span> pTempSectionHeaderTo<span style="color:#f92672">-&gt;</span>VirtualAddress <span style="color:#f92672">+</span> <span style="color:#a6e22e">Align</span>(pTempSectionHeaderTo<span style="color:#f92672">-&gt;</span>Misc.VirtualSize, pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader.SectionAlignment);
</span></span><span style="display:flex;"><span>	pTempSectionHeaderTo2<span style="color:#f92672">-&gt;</span>SizeOfRawData <span style="color:#f92672">=</span> <span style="color:#a6e22e">Align</span>(SsectionTableSize, pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader.FileAlignment);
</span></span><span style="display:flex;"><span>	pTempSectionHeaderTo2<span style="color:#f92672">-&gt;</span>PointerToRawData <span style="color:#f92672">=</span> pTempSectionHeaderTo<span style="color:#f92672">-&gt;</span>PointerToRawData <span style="color:#f92672">+</span> <span style="color:#a6e22e">Align</span>(pTempSectionHeaderTo<span style="color:#f92672">-&gt;</span>SizeOfRawData, pNTHeader<span style="color:#f92672">-&gt;</span>OptionalHeader.FileAlignment);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">memcpy</span>(<span style="color:#f92672">*</span>pNewBuffer, pFileBuffer, fileSize);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> true;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>编程实现：扩大最后一个节，并添加代码</p>
</li>
</ul>
<h4>扩大节-合并节-数据目录<span class="hx-absolute -hx-mt-20" id="扩大节-合并节-数据目录"></span>
    <a href="#%e6%89%a9%e5%a4%a7%e8%8a%82-%e5%90%88%e5%b9%b6%e8%8a%82-%e6%95%b0%e6%8d%ae%e7%9b%ae%e5%bd%95" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>扩大最后一个节，保证程序正常运行</p>
<ol>
<li>改<code>SizeOfImage</code></li>
<li>改大<code>SizeOfRawData</code>和<code>VirtualSize</code></li>
<li>到文件最后加对应大小的位置</li>
</ol>
</li>
<li>
<p>将所有节合并，保证程序正常运行</p>
<ol>
<li>
<p>改节的个数为1</p>
</li>
<li>
<p>删去多余节表，并调整剩下这个节的<code>VirtualSize</code>和<code>SizeOfRawData</code>为：</p>
<p><code>Max = SizeOfRawData&gt;VirtualSize?SizeOfRawData:VirtualSize</code></p>
<p><code>SizeOfRawData = VirtualSize = 最后一个节的VirtualAddress + Max - SizeOfHeaders内存对齐后的大小</code></p>
<p>其实就是所有节对齐后的大小，就是<code>SizeOfImage - SizeOfHeaders</code>，值应该是一样的</p>
</li>
<li>
<p>改这一个节的属性为全部属性<code>E0000060</code></p>
</li>
</ol>
</li>
<li>
<p>定义一个函数，能够返回对齐后的大小<code>Align(int x,int y)</code>，<code>y</code>是对齐大小</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">Align</span>(<span style="color:#66d9ef">int</span> x, <span style="color:#66d9ef">int</span> y)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (x <span style="color:#f92672">&lt;=</span> y) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> y;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> (i <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>; i <span style="color:#f92672">&lt;=</span> x <span style="color:#f92672">/</span> y; i<span style="color:#f92672">++</span>) 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (x <span style="color:#f92672">-</span> y <span style="color:#f92672">*</span> (i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> x <span style="color:#f92672">-</span> y <span style="color:#f92672">*</span> i <span style="color:#f92672">&lt;=</span> <span style="color:#ae81ff">0</span>) 
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> y <span style="color:#f92672">*</span> i;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> y <span style="color:#f92672">*</span> i;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>编程输出全部目录项（16个）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">PrintDriectory</span>(LPVOID pImageBuffer){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//定义PE头的信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pImageBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//判断是不是exe文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pImageBuffer) <span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pImageBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PDWORD)((BYTE <span style="color:#f92672">*</span>)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//读取pFileBuffer 获取DOS头，PE头，节表等信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pDosHeader <span style="color:#f92672">=</span>(PIMAGE_DOS_HEADER)pImageBuffer;
</span></span><span style="display:flex;"><span>	pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pImageBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//打印NT头	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);  <span style="color:#75715e">//加4个字节到了标准PE头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER); <span style="color:#75715e">//标准PE头+标准PE头的大小 20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===导出表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===导入表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">1</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">1</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===资源表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">2</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">2</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===异常信息表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">3</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">3</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===安全证书表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">4</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">4</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===重定位表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">5</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">5</span>].Size);	
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===调试信息表证书表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">6</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">6</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===版权所有表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">7</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">7</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===全局指针表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">8</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">8</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===TLS表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">9</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">9</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===加载配置表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">10</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">10</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===绑定导入表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">11</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">11</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;====IAT表===</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">12</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">12</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;====延迟导入===</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">13</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">13</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;====COM===</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">14</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">14</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;====保留===</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">15</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">15</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>静态链接库-动态链接库<span class="hx-absolute -hx-mt-20" id="静态链接库-动态链接库"></span>
    <a href="#%e9%9d%99%e6%80%81%e9%93%be%e6%8e%a5%e5%ba%93-%e5%8a%a8%e6%80%81%e9%93%be%e6%8e%a5%e5%ba%93" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>创建一个静态链接库，并在代码中使用</p>
<p>完成，注意名称相同</p>
</li>
<li>
<p>创建一个动态链接库，使用两种方式进行导出(<code>_declspec(dllexport)</code>与<code>.def</code>文件)</p>
<p>完成</p>
</li>
<li>
<p>分别使用隐式链接和显示链接使用一个<code>DLL</code>文件</p>
<p>完成，注意显示链接要包含<code>windows.h</code>头文件</p>
</li>
</ul>
<h4>导出表<span class="hx-absolute -hx-mt-20" id="导出表"></span>
    <a href="#%e5%af%bc%e5%87%ba%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>编写程序打印所有的导出表信息</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">PrintExport</span>(LPVOID pFileBuffer){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//定义PE头的信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//判断是不是exe文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pFileBuffer) <span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PDWORD)((BYTE <span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//读取pFileBuffer 获取DOS头，PE头，节表等信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pDosHeader <span style="color:#f92672">=</span>(PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//打印NT头	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);  <span style="color:#75715e">//加4个字节到了标准PE头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER); <span style="color:#75715e">//标准PE头+标准PE头的大小 20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===导出表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===结构===</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    PIMAGE_EXPORT_DIRECTORY Export_Directory <span style="color:#f92672">=</span> (PIMAGE_EXPORT_DIRECTORY)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].VirtualAddress));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Name:%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,Export_Directory<span style="color:#f92672">-&gt;</span>Name));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Base:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,Export_Directory<span style="color:#f92672">-&gt;</span>Base);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;NumberOfFunctions:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,Export_Directory<span style="color:#f92672">-&gt;</span>NumberOfFunctions);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;NumberOfNames:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,Export_Directory<span style="color:#f92672">-&gt;</span>NumberOfNames);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;AddressOfFunctions: %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Export_Directory<span style="color:#f92672">-&gt;</span> AddressOfFunctions);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;AddressOfNames;: %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, Export_Directory<span style="color:#f92672">-&gt;</span> AddressOfNames);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;AddressOfNameOrdinals;: %x</span><span style="color:#ae81ff">\n\n</span><span style="color:#e6db74">&#34;</span>, Export_Directory<span style="color:#f92672">-&gt;</span> AddressOfNameOrdinals);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>GetFunctionAddrByName</code>(<code>FileBuffer</code>指针，函数名指针)</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">GetFunctionAddrByName</span>(PVOID pFileBuffer,<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> FuncName){
</span></span><span style="display:flex;"><span>    PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pFileBuffer)<span style="color:#f92672">!=</span>IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)((BYTE <span style="color:#f92672">*</span>)pFileBUffer<span style="color:#f92672">+</span>pDosHesder<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span>IMAGE_NT_SIGNATURE){
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBUffer;
</span></span><span style="display:flex;"><span>    pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pFileBUffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>    pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader)<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>    PIMAGE_EXPORT_DIRECTORY Export_Directory <span style="color:#f92672">=</span> (PIMAGE_EXPORT_DIRECTORY)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].VirtualAddress));
</span></span><span style="display:flex;"><span>    DWORD<span style="color:#f92672">*</span> AddressOfNamesFunctionsAddress <span style="color:#f92672">=</span> (DWORD<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,Export_Directory<span style="color:#f92672">-&gt;</span>AddressOfNames));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	WORD<span style="color:#f92672">*</span> AddressOfNameOrdinalsAddress <span style="color:#f92672">=</span>(WORD<span style="color:#f92672">*</span>)((DWORD)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,Export_Directory<span style="color:#f92672">-&gt;</span>AddressOfNameOrdinals));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DWORD<span style="color:#f92672">*</span> AddressOfFunctionsAddress <span style="color:#f92672">=</span> (DWORD<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,Export_Directory<span style="color:#f92672">-&gt;</span>AddressOfFunctions));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span>(<span style="color:#66d9ef">int</span> x <span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;x<span style="color:#f92672">&lt;</span>Export_Directory<span style="color:#f92672">-&gt;</span>NumberOfNames;x<span style="color:#f92672">++</span>,AddressOfNamesFunctionsAddress<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>FuncName <span style="color:#f92672">==</span> <span style="color:#f92672">*</span>((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer<span style="color:#f92672">+</span><span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,<span style="color:#f92672">*</span>AddressOfNamesFunctionsAddress)))
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;函数地址:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,AddressOfFunctionsAddress[AddressOfNameOrdinalsAddress[x]]);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p><code>GetFunctionAddrByOrdinals</code>(<code>FileBuffer</code>指针，函数名导出序号)</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">GetFunctionAddrByOrdinals</span>(LPVOID pFileBuffer,DWORD FunctionOrdinals){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//判断是不是exe文件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pFileBuffer) <span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PDWORD)((BYTE <span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;error&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//读取pFileBuffer 获取DOS头，PE头，节表等信息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pDosHeader <span style="color:#f92672">=</span>(PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//打印NT头	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);  <span style="color:#75715e">//加4个字节到了标准PE头
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER); <span style="color:#75715e">//标准PE头+标准PE头的大小 20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PIMAGE_EXPORT_DIRECTORY Export_Directory <span style="color:#f92672">=</span> (PIMAGE_EXPORT_DIRECTORY)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">0</span>].VirtualAddress));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	DWORD<span style="color:#f92672">*</span> AddressOfNamesFunctionsAddress <span style="color:#f92672">=</span> (DWORD<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,Export_Directory<span style="color:#f92672">-&gt;</span>AddressOfNames));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;函数地址为：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,AddressOfNamesFunctionsAddress[FunctionOrdinals<span style="color:#f92672">-</span>Export_Directory<span style="color:#f92672">-&gt;</span>Base]);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>重定位表<span class="hx-absolute -hx-mt-20" id="重定位表"></span>
    <a href="#%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>打印所有重定位信息</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>DWORD <span style="color:#a6e22e">PrintRelocation</span>(LPVOID pFileBuffer){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	PIMAGE_DOS_HEADER pDosHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_NT_HEADERS pNTHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_FILE_HEADER pPEHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_OPTIONAL_HEADER32 pOptionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>	PIMAGE_SECTION_HEADER pSectionHeader <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>pFileBuffer)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;读取到内存的pfilebuffer无效！</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PWORD)pFileBuffer) <span style="color:#f92672">!=</span> IMAGE_DOS_SIGNATURE)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;不含MZ标志，不是exe文件！</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pDosHeader <span style="color:#f92672">=</span> (PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(<span style="color:#f92672">*</span>((PDWORD)((BYTE <span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew)) <span style="color:#f92672">!=</span> IMAGE_NT_SIGNATURE){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;无有效的PE标志</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	pDosHeader <span style="color:#f92672">=</span>(PIMAGE_DOS_HEADER)pFileBuffer;
</span></span><span style="display:flex;"><span>	pNTHeader <span style="color:#f92672">=</span> (PIMAGE_NT_HEADERS)((DWORD)pFileBuffer <span style="color:#f92672">+</span> pDosHeader<span style="color:#f92672">-&gt;</span>e_lfanew);
</span></span><span style="display:flex;"><span>	pPEHeader <span style="color:#f92672">=</span> (PIMAGE_FILE_HEADER)(((DWORD)pNTHeader) <span style="color:#f92672">+</span> <span style="color:#ae81ff">4</span>);
</span></span><span style="display:flex;"><span>	pOptionHeader <span style="color:#f92672">=</span> (PIMAGE_OPTIONAL_HEADER32)((DWORD)pPEHeader <span style="color:#f92672">+</span> IMAGE_SIZEOF_FILE_HEADER); 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">5</span>].VirtualAddress <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,<span style="color:#e6db74">&#34;不存在重定位表...&#34;</span>);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;========1=========</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    PIMAGE_BASE_RELOCATION ReloCation <span style="color:#f92672">=</span> (_IAMGE_BASE_RELOCATION<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)pFileBuffer <span style="color:#f92672">+</span> <span style="color:#a6e22e">RvaToFileOffset</span>(pFileBuffer,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">5</span>].VirtualAddress));
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;===重定位表====</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存地址%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">5</span>].VirtualAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;内存大小%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,pOptionHeader<span style="color:#f92672">-&gt;</span>DataDirectory[<span style="color:#ae81ff">5</span>].Size);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> cnt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (true) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> (ReloCation<span style="color:#f92672">-&gt;</span>VirtualAddress <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> ReloCation<span style="color:#f92672">-&gt;</span>SizeOfBlock <span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;**********************************</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,ReloCation);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">int</span> num <span style="color:#f92672">=</span> (ReloCation<span style="color:#f92672">-&gt;</span>SizeOfBlock <span style="color:#f92672">-</span> <span style="color:#ae81ff">8</span>) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">for</span> (<span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span>num<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;i<span style="color:#f92672">++</span>) 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>			     WORD<span style="color:#f92672">*</span> offset <span style="color:#f92672">=</span> (WORD<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)ReloCation<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>i);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">if</span> (<span style="color:#f92672">*</span>offset <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0x3000</span>)
</span></span><span style="display:flex;"><span>				{
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>					   <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;第%x项</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">地址:%X</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">偏移:%X</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ReloCation<span style="color:#f92672">-&gt;</span>VirtualAddress, <span style="color:#f92672">*</span>offset<span style="color:#f92672">-</span><span style="color:#ae81ff">0x3000</span>);
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			ReloCation <span style="color:#f92672">=</span> (_IMAGE_BASE_RELOCATION<span style="color:#f92672">*</span>)((<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)ReloCation <span style="color:#f92672">+</span> ReloCation<span style="color:#f92672">-&gt;</span>SizeOfBlock);
</span></span><span style="display:flex;"><span>			  cnt<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>		}<span style="color:#66d9ef">else</span>{
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, cnt);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>重定位表这样设计有什么好处？</p>
<p>用最少的空间来记录要修改的地址</p>
</li>
</ul>
<h4>移动导出表-重定位表<span class="hx-absolute -hx-mt-20" id="移动导出表-重定位表"></span>
    <a href="#%e7%a7%bb%e5%8a%a8%e5%af%bc%e5%87%ba%e8%a1%a8-%e9%87%8d%e5%ae%9a%e4%bd%8d%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>在<code>DLL</code>新增一个节，并将导出表信息移动到这个新的节中</li>
<li>使用工具打开修改后的<code>DLL</code>看能否正常解析</li>
<li>在<code>DLL</code>中新增一个节，并将重定位表移动到这个新的节中</li>
<li>修改<code>DLL</code>的<code>ImageBase</code>,根据重定位表修正，然后存盘。看<code>DLL</code>是否可以使用</li>
</ul>
<h4>导入表<span class="hx-absolute -hx-mt-20" id="导入表"></span>
    <a href="#%e5%af%bc%e5%85%a5%e8%a1%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>打印<code>notepad.exe</code>导入表的全部信息</li>
</ul>
<h3>Win32<span class="hx-absolute -hx-mt-20" id="win32"></span>
    <a href="#win32" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h4>宽字符<span class="hx-absolute -hx-mt-20" id="宽字符"></span>
    <a href="#%e5%ae%bd%e5%ad%97%e7%ac%a6" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>分别使用<code>wchar_t / wprintf / wcslen / wcscpy / wcscat / wcscmp / wcsstr</code>写一个例子</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;main.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;locale.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> WINAPI <span style="color:#a6e22e">WinMain</span>(HINSTANCE hInstance, HINSTANCE hPrevInstance,LPSTR lpCmdLine, <span style="color:#66d9ef">int</span> nCmdShow) {
</span></span><span style="display:flex;"><span>	setlocale(LC_ALL,<span style="color:#e6db74">&#34;&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">wchar_t</span> str1[] <span style="color:#f92672">=</span> <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;你好&#34;</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">wchar_t</span> str2[] <span style="color:#f92672">=</span> <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;世界&#34;</span>;
</span></span><span style="display:flex;"><span>	wprintf(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;打印：%ls,%ls</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str1,str2);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> Len <span style="color:#f92672">=</span> wcslen(str1);
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,Len);
</span></span><span style="display:flex;"><span>	wcscpy(str1,str2);
</span></span><span style="display:flex;"><span>	wprintf(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;打印：%ls,%ls</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str1,str2);
</span></span><span style="display:flex;"><span>	wcscat(str1,str1);
</span></span><span style="display:flex;"><span>	wprintf(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;打印：%ls,%ls</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,str1,str2);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> dif <span style="color:#f92672">=</span> wcscmp(str1,str2);
</span></span><span style="display:flex;"><span>	printf(<span style="color:#e6db74">&#34;%d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,dif);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">wchar_t</span><span style="color:#f92672">*</span> search <span style="color:#f92672">=</span> wcsstr(str1,<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;世&#34;</span>);
</span></span><span style="display:flex;"><span>	wprintf(<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;%ls</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,search);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>查<code>MSDN</code>了解<code>WinMain</code>其他<code>3</code>个参数的意义</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> WINAPI <span style="color:#a6e22e">WinMain</span>(
</span></span><span style="display:flex;"><span>  HINSTANCE hInstance,      <span style="color:#75715e">// 应用程序当前实例的句柄
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  HINSTANCE hPrevInstance,  <span style="color:#f92672">//</span> <span style="color:#960050;background-color:#1e0010">应用程序先前实例的句柄</span> (<span style="color:#960050;background-color:#1e0010">现在通常为</span>NULL)
</span></span><span style="display:flex;"><span>  LPSTR     lpCmdLine,      <span style="color:#75715e">// 指向应用程序命令行字符串的指针 (就是命令行参数)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">int</span>       nCmdShow        <span style="color:#75715e">// 指定窗口应如何显示 (是否被最小化，最大化或正常显示)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>);</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>事件-消息<span class="hx-absolute -hx-mt-20" id="事件-消息"></span>
    <a href="#%e4%ba%8b%e4%bb%b6-%e6%b6%88%e6%81%af" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>创建一个窗口程序，学习如何查询文档</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>HINSTANCE hAppInstance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LRESULT CALLBACK <span style="color:#a6e22e">WindowProc</span>(  
</span></span><span style="display:flex;"><span>	IN  HWND hwnd,  
</span></span><span style="display:flex;"><span>	IN  UINT uMsg,  
</span></span><span style="display:flex;"><span>	IN  WPARAM wParam,  
</span></span><span style="display:flex;"><span>	IN  LPARAM lParam  
</span></span><span style="display:flex;"><span>	);  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> APIENTRY <span style="color:#a6e22e">WinMain</span>(HINSTANCE hInstance,
</span></span><span style="display:flex;"><span>                     HINSTANCE hPrevInstance,
</span></span><span style="display:flex;"><span>                     LPSTR     lpCmdLine,
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">int</span>       nCmdShow)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">// TODO: Place code here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	hAppInstance <span style="color:#f92672">=</span> hInstance;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//窗口的类名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PSTR className <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;My First Window&#34;</span>; 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建窗口类的对象 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	WNDCLASS wndclass <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};						<span style="color:#75715e">//一定要先将所有值赋值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	wndclass.hbrBackground <span style="color:#f92672">=</span> (HBRUSH)COLOR_MENU;	<span style="color:#75715e">//窗口的背景色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	wndclass.hCursor <span style="color:#f92672">=</span> LoadCursor(NULL,IDC_APPSTARTING);	
</span></span><span style="display:flex;"><span>	wndclass.lpfnWndProc <span style="color:#f92672">=</span> WindowProc;				<span style="color:#75715e">//窗口过程函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	wndclass.lpszClassName <span style="color:#f92672">=</span> className;				<span style="color:#75715e">//窗口类的名字	
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	wndclass.hInstance <span style="color:#f92672">=</span> hInstance;					<span style="color:#75715e">//定义窗口类的应用程序的实例句柄
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 注册窗口类  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// 参加MSDN文档RegisterClass-&gt;Parameters：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// You must fill the structure with the appropriate class attributes 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">// before passing it to the function. 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	RegisterClass(<span style="color:#f92672">&amp;</span>wndclass);  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 创建窗口  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	HWND hwnd <span style="color:#f92672">=</span> CreateWindow(  
</span></span><span style="display:flex;"><span>		className,				<span style="color:#75715e">//类名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#e6db74">&#34;我的第一个窗口&#34;</span>,		<span style="color:#75715e">//窗口标题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		WS_OVERLAPPEDWINDOW,	<span style="color:#75715e">//窗口外观样式  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#ae81ff">10</span>,						<span style="color:#75715e">//相对于父窗口的X坐标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#ae81ff">10</span>,						<span style="color:#75715e">//相对于父窗口的Y坐标
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#ae81ff">600</span>,					<span style="color:#75715e">//窗口的宽度  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#ae81ff">300</span>,					<span style="color:#75715e">//窗口的高度  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		NULL,					<span style="color:#75715e">//父窗口句柄，为NULL  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		NULL,					<span style="color:#75715e">//菜单句柄，为NULL  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		hInstance,				<span style="color:#75715e">//当前应用程序的句柄  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		NULL);					<span style="color:#75715e">//附加数据一般为NULL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span>(hwnd <span style="color:#f92672">==</span> NULL)			<span style="color:#75715e">//是否创建成功  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 显示窗口  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ShowWindow(hwnd, SW_SHOW);  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 更新窗口  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	UpdateWindow(hwnd);  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 消息循环  
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	MSG msg;  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span>(GetMessage(<span style="color:#f92672">&amp;</span>msg, NULL, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>))  
</span></span><span style="display:flex;"><span>	{  
</span></span><span style="display:flex;"><span>		TranslateMessage(<span style="color:#f92672">&amp;</span>msg);  
</span></span><span style="display:flex;"><span>		DispatchMessage(<span style="color:#f92672">&amp;</span>msg);  
</span></span><span style="display:flex;"><span>	}  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LRESULT CALLBACK <span style="color:#a6e22e">WindowProc</span>(  
</span></span><span style="display:flex;"><span>	IN  HWND hwnd,  
</span></span><span style="display:flex;"><span>	IN  UINT uMsg,  
</span></span><span style="display:flex;"><span>	IN  WPARAM wParam,  
</span></span><span style="display:flex;"><span>	IN  LPARAM lParam  
</span></span><span style="display:flex;"><span>	)  
</span></span><span style="display:flex;"><span>{  
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span>(uMsg)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//窗口消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> WM_CREATE: 
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_CREATE %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				CREATESTRUCT<span style="color:#f92672">*</span> createst <span style="color:#f92672">=</span> (CREATESTRUCT<span style="color:#f92672">*</span>)lParam;
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;CREATESTRUCT %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,createst<span style="color:#f92672">-&gt;</span>lpszClass);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_MOVE:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_MOVE %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				POINTS points <span style="color:#f92672">=</span> MAKEPOINTS(lParam);
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;X Y %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,points.x,points.y);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_SIZE:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_SIZE %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">int</span> newWidth  <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)(<span style="color:#66d9ef">short</span>) LOWORD(lParam);    
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">int</span> newHeight  <span style="color:#f92672">=</span> (<span style="color:#66d9ef">int</span>)(<span style="color:#66d9ef">short</span>) HIWORD(lParam);   
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_SIZE %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,newWidth,newHeight);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_DESTROY:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_DESTROY %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				PostQuitMessage(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//键盘消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> WM_KEYUP:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_KEYUP %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_KEYDOWN:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_KEYDOWN %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">//鼠标消息
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">case</span> WM_LBUTTONDOWN:
</span></span><span style="display:flex;"><span>			{
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_LBUTTONDOWN %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,wParam,lParam);
</span></span><span style="display:flex;"><span>				POINTS points <span style="color:#f92672">=</span> MAKEPOINTS(lParam);
</span></span><span style="display:flex;"><span>				printf(<span style="color:#e6db74">&#34;WM_LBUTTONDOWN %d %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,points.x,points.y);
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>  
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> DefWindowProc(hwnd,uMsg,wParam,lParam);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;  
</span></span><span style="display:flex;"><span>}  
</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>查一下<code>Windows</code>有多少种消息，概要了解一下每个消息的作用</p>
</li>
<li>
<p><code>WNDCLASS wndclass = {0};</code>与<code>WNDCLASS wndclass;</code>的区别是什么</p>
<p>要对里面的成员全面初始化</p>
</li>
</ul>
<h4>esp寻址-定位回调函数<span class="hx-absolute -hx-mt-20" id="esp寻址-定位回调函数"></span>
    <a href="#esp%e5%af%bb%e5%9d%80-%e5%ae%9a%e4%bd%8d%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>找到那三个字母</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401124</span>                 <span style="color:#a6e22e">cmp</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">41</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;A&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401127</span>                 <span style="color:#a6e22e">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_401172</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401129</span>                 <span style="color:#a6e22e">cmp</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">46</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;F&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040112</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_401161</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040112</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">67</span><span style="color:#66d9ef">h</span> <span style="color:#75715e">; &#39;g&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401131</span>                 <span style="color:#a6e22e">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_401150</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>根据<code>WndClass</code>里面的回调函数可以找到这个比较。不过这个<code>67h</code>好像是小键盘的<code>7</code>。</p>
</li>
</ul>
<h4>子窗口-消息处理函数<span class="hx-absolute -hx-mt-20" id="子窗口-消息处理函数"></span>
    <a href="#%e5%ad%90%e7%aa%97%e5%8f%a3-%e6%b6%88%e6%81%af%e5%a4%84%e7%90%86%e5%87%bd%e6%95%b0" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>找到按钮另外的操作</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040111</span><span style="color:#a6e22e">A</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">3</span><span style="color:#66d9ef">E9h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040111</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">jnz</span>     <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_401144</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401121</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; uType
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401123</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">offset</span> <span style="color:#66d9ef">Caption</span>  <span style="color:#75715e">; &#34;Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401128</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">offset</span> <span style="color:#66d9ef">Text</span>     <span style="color:#75715e">; &#34;Find Me 1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040112</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; hWnd
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040112</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword_408514</span>, <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401139</span>                 <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">ds</span>:<span style="color:#66d9ef">MessageBoxA</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040113</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401141</span>                 <span style="color:#a6e22e">retn</span>    <span style="color:#ae81ff">10</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401144</span> <span style="color:#75715e">; ---------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401144</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401144</span> loc_401144:                             <span style="color:#75715e">; CODE XREF: sub_401100+1F↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401144</span>                 <span style="color:#a6e22e">cmp</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">3</span><span style="color:#66d9ef">EAh</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401149</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_40116E</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040114</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; uType
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040114</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">offset</span> <span style="color:#66d9ef">Caption</span>  <span style="color:#75715e">; &#34;Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401152</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">offset</span> <span style="color:#66d9ef">aFindMe2</span> <span style="color:#75715e">; &#34;Find Me 2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401157</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; hWnd
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401159</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword_408514</span>, <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401163</span>                 <span style="color:#a6e22e">call</span>    <span style="color:#66d9ef">ds</span>:<span style="color:#66d9ef">MessageBoxA</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401169</span>                 <span style="color:#a6e22e">xor</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040116</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">retn</span>    <span style="color:#ae81ff">10</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040116</span><span style="color:#a6e22e">E</span> <span style="color:#75715e">; ---------------------------------------------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040116</span><span style="color:#a6e22e">E</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040116</span><span style="color:#a6e22e">E</span> <span style="color:#66d9ef">loc_40116E</span>:                             <span style="color:#75715e">; CODE XREF: sub_401100+49↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040116</span><span style="color:#a6e22e">E</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">3</span><span style="color:#66d9ef">EBh</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401173</span>                 <span style="color:#a6e22e">jnz</span>     <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_401198</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401175</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; uType
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401177</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">offset</span> <span style="color:#66d9ef">Caption</span>  <span style="color:#75715e">; &#34;Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040117</span><span style="color:#a6e22e">C</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">offset</span> <span style="color:#66d9ef">aFindMe3</span> <span style="color:#75715e">; &#34;Find Me 3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401181</span>                 <span style="color:#a6e22e">push</span>    <span style="color:#ae81ff">0</span>               <span style="color:#75715e">; hWnd
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">00401183</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">dword_408514</span>, <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040118</span><span style="color:#a6e22e">D</span>                 <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ds</span>:<span style="color:#66d9ef">MessageBoxA</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401193</span>                 <span style="color:#a6e22e">xor</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00401195</span>                 <span style="color:#a6e22e">retn</span>    <span style="color:#ae81ff">10</span><span style="color:#66d9ef">h</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>应该是向地址<code>0x408514</code>分别赋值<code>1，2，3</code></p>
<p>通过反汇编其实可以看到，因为这三个按钮是属于这个窗口类的所以这些按钮的回调函数也会在窗口的<code>WndProc</code>下。点击按钮的消息与点击窗口的消息会分开，似乎是因为<code>if…else…</code>隔开了。</p>
</li>
</ul>
<h4>资源文件-消息断点<span class="hx-absolute -hx-mt-20" id="资源文件-消息断点"></span>
    <a href="#%e8%b5%84%e6%ba%90%e6%96%87%e4%bb%b6-%e6%b6%88%e6%81%af%e6%96%ad%e7%82%b9" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>找回调1</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401060</span>   <span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#960050;background-color:#1e0010">\8</span><span style="color:#a6e22e">B4C24</span> <span style="color:#ae81ff">08</span>     <span style="color:#66d9ef">MOV</span> <span style="color:#66d9ef">ECX</span>,<span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">SS</span>:[<span style="color:#66d9ef">ESP</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]             <span style="color:#75715e">;  Case 3EA of switch 0040104D
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401064</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">6</span><span style="color:#a6e22e">A</span> <span style="color:#ae81ff">00</span>         <span style="color:#66d9ef">PUSH</span> <span style="color:#ae81ff">0</span>                                   <span style="color:#75715e">; /Style = MB_OK|MB_APPLMODAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401066</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">68</span> <span style="color:#960050;background-color:#1e0010">60604000</span>   <span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ReverseT.00406060</span>                   <span style="color:#75715e">; |Title = &#34;Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">0040106</span><span style="color:#a6e22e">B</span>   .  <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">48604000</span>   <span style="color:#66d9ef">PUSH</span> <span style="color:#66d9ef">ReverseT.00406048</span>                   <span style="color:#75715e">; |Text = &#34;Button 3&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401070</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">51</span>            <span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ECX</span>                                 <span style="color:#75715e">; |hOwner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401071</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#a6e22e">FF15</span> <span style="color:#66d9ef">A0504000</span> <span style="color:#66d9ef">CALL</span> <span style="color:#66d9ef">NEAR</span> <span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">DS</span>:[<span style="color:#ae81ff">4050</span><span style="color:#66d9ef">A0</span>]          <span style="color:#75715e">; \MessageBoxA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401077</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">BC6</span>          <span style="color:#66d9ef">MOV</span> <span style="color:#66d9ef">EAX</span>,<span style="color:#66d9ef">ESI</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401079</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">5</span><span style="color:#a6e22e">E</span>            <span style="color:#66d9ef">POP</span> <span style="color:#66d9ef">ESI</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040107</span><span style="color:#a6e22e">A</span>   .  <span style="color:#66d9ef">C2</span> <span style="color:#ae81ff">1000</span>       <span style="color:#66d9ef">RETN</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040107</span><span style="color:#a6e22e">D</span>   <span style="color:#960050;background-color:#1e0010">&gt;</span>  <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B5424</span> <span style="color:#ae81ff">08</span>     <span style="color:#66d9ef">MOV</span> <span style="color:#66d9ef">EDX</span>,<span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">SS</span>:[<span style="color:#66d9ef">ESP</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]             <span style="color:#75715e">;  Case 3E9 of switch 0040104D
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401081</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">6</span><span style="color:#a6e22e">A</span> <span style="color:#ae81ff">00</span>         <span style="color:#66d9ef">PUSH</span> <span style="color:#ae81ff">0</span>                                   <span style="color:#75715e">; /Style = MB_OK|MB_APPLMODAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401083</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">68</span> <span style="color:#960050;background-color:#1e0010">60604000</span>   <span style="color:#a6e22e">PUSH</span> <span style="color:#66d9ef">ReverseT.00406060</span>                   <span style="color:#75715e">; |Title = &#34;Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401088</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">68</span> <span style="color:#960050;background-color:#1e0010">3</span><span style="color:#a6e22e">C604000</span>   <span style="color:#66d9ef">PUSH</span> <span style="color:#66d9ef">ReverseT.0040603C</span>                   <span style="color:#75715e">; |Text = &#34;Button 2&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">0040108</span><span style="color:#a6e22e">D</span>   .  <span style="color:#ae81ff">52</span>            <span style="color:#66d9ef">PUSH</span> <span style="color:#66d9ef">EDX</span>                                 <span style="color:#75715e">; |hOwner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">0040108</span><span style="color:#a6e22e">E</span>   .  <span style="color:#66d9ef">FF15</span> <span style="color:#66d9ef">A0504000</span> <span style="color:#66d9ef">CALL</span> <span style="color:#66d9ef">NEAR</span> <span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">DS</span>:[<span style="color:#ae81ff">4050</span><span style="color:#66d9ef">A0</span>]          <span style="color:#75715e">; \MessageBoxA
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">00401094</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">BC6</span>          <span style="color:#66d9ef">MOV</span> <span style="color:#66d9ef">EAX</span>,<span style="color:#66d9ef">ESI</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401096</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#960050;background-color:#1e0010">5</span><span style="color:#a6e22e">E</span>            <span style="color:#66d9ef">POP</span> <span style="color:#66d9ef">ESI</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401097</span>   <span style="color:#960050;background-color:#1e0010">.</span>  <span style="color:#a6e22e">C2</span> <span style="color:#ae81ff">1000</span>       <span style="color:#66d9ef">RETN</span> <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040109</span><span style="color:#a6e22e">A</span>   <span style="color:#960050;background-color:#1e0010">&gt;</span>  <span style="color:#ae81ff">8</span><span style="color:#66d9ef">B4424</span> <span style="color:#ae81ff">08</span>     <span style="color:#66d9ef">MOV</span> <span style="color:#66d9ef">EAX</span>,<span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">SS</span>:[<span style="color:#66d9ef">ESP</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]             <span style="color:#75715e">;  Case 3E8 of switch 0040104D
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">0040109</span><span style="color:#a6e22e">E</span>   .  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">A</span> <span style="color:#ae81ff">00</span>         <span style="color:#66d9ef">PUSH</span> <span style="color:#ae81ff">0</span>                                   <span style="color:#75715e">; /Style = MB_OK|MB_APPLMODAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">A0</span>   .  <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">60604000</span>   <span style="color:#66d9ef">PUSH</span> <span style="color:#66d9ef">ReverseT.00406060</span>                   <span style="color:#75715e">; |Title = &#34;Demo&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">A5</span>   .  <span style="color:#ae81ff">68</span> <span style="color:#ae81ff">30604000</span>   <span style="color:#66d9ef">PUSH</span> <span style="color:#66d9ef">ReverseT.00406030</span>                   <span style="color:#75715e">; |Text = &#34;Button 1&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">AA</span>   .  <span style="color:#ae81ff">50</span>            <span style="color:#66d9ef">PUSH</span> <span style="color:#66d9ef">EAX</span>                                 <span style="color:#75715e">; |hOwner
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">AB</span>   .  <span style="color:#66d9ef">FF15</span> <span style="color:#66d9ef">A0504000</span> <span style="color:#66d9ef">CALL</span> <span style="color:#66d9ef">NEAR</span> <span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">DS</span>:[<span style="color:#ae81ff">4050</span><span style="color:#66d9ef">A0</span>]          <span style="color:#960050;background-color:#1e0010">;</span> <span style="color:#960050;background-color:#1e0010">\</span><span style="color:#66d9ef">MessageBoxA</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>找密码</p>
<p>首先是调了一个函数判断<code>EAX</code>，后面就是是否输入正确进行跳转：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">D3</span>   .  <span style="color:#66d9ef">E8</span> <span style="color:#ae81ff">28</span><span style="color:#66d9ef">FFFFFF</span>   <span style="color:#66d9ef">CALL</span> <span style="color:#66d9ef">ReverseT.00401000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">D8</span>   .  <span style="color:#ae81ff">83</span><span style="color:#66d9ef">C4</span> <span style="color:#ae81ff">04</span>       <span style="color:#66d9ef">ADD</span> <span style="color:#66d9ef">ESP</span>,<span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">DB</span>   .  <span style="color:#ae81ff">85</span><span style="color:#66d9ef">C0</span>          <span style="color:#66d9ef">TEST</span> <span style="color:#66d9ef">EAX</span>,<span style="color:#66d9ef">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">DD</span>   .  <span style="color:#ae81ff">6</span><span style="color:#66d9ef">A</span> <span style="color:#ae81ff">00</span>         <span style="color:#66d9ef">PUSH</span> <span style="color:#ae81ff">0</span>                                   <span style="color:#75715e">; /Style = MB_OK|MB_APPLMODAL
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">004010</span><span style="color:#a6e22e">DF</span>   .  <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">18</span>         <span style="color:#66d9ef">JE</span> <span style="color:#66d9ef">SHORT</span> <span style="color:#66d9ef">ReverseT.004010F9</span>               <span style="color:#960050;background-color:#1e0010">;</span> <span style="color:#960050;background-color:#1e0010">|</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>后面的比较的位置应该是下面的代码：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040105</span><span style="color:#a6e22e">C</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">8</span><span style="color:#66d9ef">D7C24</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">C</span>     <span style="color:#66d9ef">LEA</span> <span style="color:#66d9ef">EDI</span>,<span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">SS</span>:[<span style="color:#66d9ef">ESP</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">C</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401060</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  <span style="color:#960050;background-color:#1e0010">83</span><span style="color:#a6e22e">C9</span> <span style="color:#66d9ef">FF</span>       <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">ECX</span>,<span style="color:#66d9ef">FFFFFFFF</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401063</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  <span style="color:#960050;background-color:#1e0010">33</span><span style="color:#a6e22e">C0</span>          <span style="color:#66d9ef">XOR</span> <span style="color:#66d9ef">EAX</span>,<span style="color:#66d9ef">EAX</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401065</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  F2:<span style="color:#a6e22e">AE</span>         <span style="color:#66d9ef">REPNE</span> <span style="color:#66d9ef">SCAS</span> <span style="color:#66d9ef">BYTE</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">ES</span>:[<span style="color:#66d9ef">EDI</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401067</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  <span style="color:#a6e22e">F7D1</span>          <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401069</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  <span style="color:#960050;background-color:#1e0010">49</span>            <span style="color:#a6e22e">DEC</span> <span style="color:#66d9ef">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040106</span><span style="color:#a6e22e">A</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">83</span><span style="color:#66d9ef">F9</span> <span style="color:#ae81ff">03</span>       <span style="color:#66d9ef">CMP</span> <span style="color:#66d9ef">ECX</span>,<span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040106</span><span style="color:#a6e22e">D</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">20</span>         <span style="color:#66d9ef">JNZ</span> <span style="color:#66d9ef">SHORT</span> <span style="color:#66d9ef">ReverseT.0040108F</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040106</span><span style="color:#a6e22e">F</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">8</span><span style="color:#66d9ef">D7C24</span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">C</span>     <span style="color:#66d9ef">LEA</span> <span style="color:#66d9ef">EDI</span>,<span style="color:#66d9ef">DWORD</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">SS</span>:[<span style="color:#66d9ef">ESP</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span><span style="color:#66d9ef">C</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401073</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  <span style="color:#960050;background-color:#1e0010">83</span><span style="color:#a6e22e">C9</span> <span style="color:#66d9ef">FF</span>       <span style="color:#66d9ef">OR</span> <span style="color:#66d9ef">ECX</span>,<span style="color:#66d9ef">FFFFFFFF</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401076</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  F2:<span style="color:#a6e22e">AE</span>         <span style="color:#66d9ef">REPNE</span> <span style="color:#66d9ef">SCAS</span> <span style="color:#66d9ef">BYTE</span> <span style="color:#66d9ef">PTR</span> <span style="color:#66d9ef">ES</span>:[<span style="color:#66d9ef">EDI</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00401078</span>  <span style="color:#960050;background-color:#1e0010">|.</span>  <span style="color:#a6e22e">F7D1</span>          <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040107</span><span style="color:#a6e22e">A</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">49</span>            <span style="color:#66d9ef">DEC</span> <span style="color:#66d9ef">ECX</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040107</span><span style="color:#a6e22e">B</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">83</span><span style="color:#66d9ef">F9</span> <span style="color:#ae81ff">05</span>       <span style="color:#66d9ef">CMP</span> <span style="color:#66d9ef">ECX</span>,<span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0040107</span><span style="color:#a6e22e">E</span>  <span style="color:#960050;background-color:#1e0010">|</span>.  <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">F</span>         <span style="color:#66d9ef">JNZ</span> <span style="color:#66d9ef">SHORT</span> <span style="color:#66d9ef">ReverseT.0040108F</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>因为前面是两个<code>GetWindowTextA</code>函数，所以有理由说明上面的获取我输入的内容，后面进行比较。</p>
</li>
</ul>
<h4>资源表（PE）<span class="hx-absolute -hx-mt-20" id="资源表pe"></span>
    <a href="#%e8%b5%84%e6%ba%90%e8%a1%a8pe" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>编写程序，定位某个资源在<code>PE</code>文件中的位置</li>
<li>编写程序，提供程序图标资源</li>
<li>编写程序，修改对话框标题</li>
</ul>
<h4>项目<span class="hx-absolute -hx-mt-20" id="项目"></span>
    <a href="#%e9%a1%b9%e7%9b%ae" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>界面实现：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">// project.cpp : Defines the entry point for the application.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;stdafx.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;resource.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;CommCtrl.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#pragma comment(lib,&#34;comctl32.lib&#34;)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">EnumMoudles</span>(HWND hListProcess, WPARAM wParam, LPARAM lParam) {
</span></span><span style="display:flex;"><span>	DWORD dwRowId;
</span></span><span style="display:flex;"><span>	TCHAR szPid[<span style="color:#ae81ff">21</span>];
</span></span><span style="display:flex;"><span>	LV_ITEM lv;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	memset(<span style="color:#f92672">&amp;</span>lv, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(LV_ITEM));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//获取选择行
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	dwRowId <span style="color:#f92672">=</span> SendMessage(hListProcess, LVM_GETNEXTITEM,<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span> , LVNI_SELECTED);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (dwRowId <span style="color:#f92672">==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>		MessageBox(NULL, TEXT(<span style="color:#e6db74">&#34;请选择进程&#34;</span>), TEXT(<span style="color:#e6db74">&#34;出错啦&#34;</span>), MB_OK);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//获取PID
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	lv.pszText <span style="color:#f92672">=</span> szPid;
</span></span><span style="display:flex;"><span>	lv.cchTextMax <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>	SendMessage(hListProcess, LVM_GETITEMTEXT, dwRowId, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	MessageBox(NULL, szPid, TEXT(<span style="color:#e6db74">&#34;PID&#34;</span>), MB_OK);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">InitMoudleListView</span>(HWND hDlg) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//设置窗口风格需要调用结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	LV_COLUMN lv;
</span></span><span style="display:flex;"><span>	HWND hListMoudles;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	memset(<span style="color:#f92672">&amp;</span>lv, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(LV_COLUMN));
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//获取模块列表句柄
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	hListMoudles <span style="color:#f92672">=</span> GetDlgItem(hDlg, IDC_LIST_Down);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//设置整行选中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListMoudles, LVM_SETEXTENDEDLISTVIEWSTYLE, LVS_EX_FULLROWSELECT, LVS_EX_FULLROWSELECT);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第一列：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.mask <span style="color:#f92672">=</span> LVCF_TEXT <span style="color:#f92672">|</span> LVCF_WIDTH <span style="color:#f92672">|</span> LVCF_SUBITEM;
</span></span><span style="display:flex;"><span>	lv.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;模块名称&#34;</span>);
</span></span><span style="display:flex;"><span>	lv.cx <span style="color:#f92672">=</span> <span style="color:#ae81ff">330</span>;
</span></span><span style="display:flex;"><span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_Insertcolumn(hListMoudles,0,&amp;lv);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListMoudles, LVM_INSERTCOLUMN, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第二列：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;模块位置&#34;</span>);
</span></span><span style="display:flex;"><span>	lv.cx <span style="color:#f92672">=</span> <span style="color:#ae81ff">330</span>;
</span></span><span style="display:flex;"><span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	SendMessage(hListMoudles, LVM_INSERTCOLUMN, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">EnumProcess</span>(HWND hListProcess) {
</span></span><span style="display:flex;"><span>	LV_ITEM vitem;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化，第一个进程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	memset(<span style="color:#f92672">&amp;</span>vitem, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(LV_ITEM));
</span></span><span style="display:flex;"><span>	vitem.mask <span style="color:#f92672">=</span> LVIF_TEXT;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//假数据：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;csrss.exe&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_Insertem(hListProcess,*vitem);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListProcess, LVM_INSERTITEM, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;448&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	SendMessage(hListProcess, LVM_SETITEM, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_SetItem(hListProcess, &amp;vitem);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;56590000&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;000F0000&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第二个进程假数据：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;QQ.exe&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	SendMessage(hListProcess, LVM_INSERTITEM, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;153&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;65580000&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;001E0000&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第三个进程假数据：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;WeChat.exe&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	SendMessage(hListProcess, LVM_INSERTITEM, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;256&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;75960000&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	vitem.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;015B0000&#34;</span>);
</span></span><span style="display:flex;"><span>	vitem.iItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	vitem.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>	ListView_SetItem(hListProcess, <span style="color:#f92672">&amp;</span>vitem);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">InitProcessListView</span>(HWND hDlg) {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//设置窗口风格调用结构体
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	LV_COLUMN lv;
</span></span><span style="display:flex;"><span>	HWND hListProcess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	memset(<span style="color:#f92672">&amp;</span>lv, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(LV_COLUMN));
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//获取进程列表句柄
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	hListProcess <span style="color:#f92672">=</span> GetDlgItem(hDlg, IDC_LIST_Process);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//设置整行选中
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListProcess, LVM_SETEXTENDEDLISTVIEWSTYLE, LVS_EX_FULLROWSELECT, LVS_EX_FULLROWSELECT);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//出错代码：：：：：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//SendMessage(hListProcess, LVM_GETEXTENDEDLISTVIEWSTYLE, LVS_EX_FULLROWSELECT, LVS_EX_FULLROWSELECT);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第一列：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.mask <span style="color:#f92672">=</span> LVCF_TEXT <span style="color:#f92672">|</span> LVCF_WIDTH <span style="color:#f92672">|</span> LVCF_SUBITEM;
</span></span><span style="display:flex;"><span>	lv.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;进程&#34;</span>);           <span style="color:#75715e">//列标题
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.cx <span style="color:#f92672">=</span> <span style="color:#ae81ff">225</span>;             <span style="color:#75715e">//行宽
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_InsertColumn(hListProcess,0,&amp;lv);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListProcess, LVM_INSERTCOLUMN, <span style="color:#ae81ff">0</span>, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第二列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;PID&#34;</span>);
</span></span><span style="display:flex;"><span>	lv.cx <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>;
</span></span><span style="display:flex;"><span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_InsertColumn(hListProcess, 1, &amp;lv);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListProcess, LVM_INSERTCOLUMN, <span style="color:#ae81ff">1</span>, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第三列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;镜像基址&#34;</span>);
</span></span><span style="display:flex;"><span>	lv.cx <span style="color:#f92672">=</span> <span style="color:#ae81ff">134</span>;
</span></span><span style="display:flex;"><span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_InsertColumn(hListProcess, 2, &amp;lv);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListProcess, LVM_INSERTCOLUMN, <span style="color:#ae81ff">2</span>, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//第四列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	lv.pszText <span style="color:#f92672">=</span> TEXT(<span style="color:#e6db74">&#34;镜像大小&#34;</span>);
</span></span><span style="display:flex;"><span>	lv.cx <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>;
</span></span><span style="display:flex;"><span>	lv.iSubItem <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ListView_InsertColumn(hListProcess, 3, &amp;lv);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	SendMessage(hListProcess, LVM_INSERTCOLUMN, <span style="color:#ae81ff">3</span>, (DWORD)<span style="color:#f92672">&amp;</span>lv);
</span></span><span style="display:flex;"><span>	EnumProcess(hListProcess);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL CALLBACK <span style="color:#a6e22e">MainDlgProc</span>(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam) {
</span></span><span style="display:flex;"><span>	BOOL nRet <span style="color:#f92672">=</span> FALSE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">switch</span> (uMsg) {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_CLOSE: {
</span></span><span style="display:flex;"><span>			EndDialog(hDlg, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			PostQuitMessage(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_INITDIALOG: {
</span></span><span style="display:flex;"><span>			InitProcessListView(hDlg);         <span style="color:#75715e">//设置ProcessListView的风格，初始化进程列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			InitMoudleListView(hDlg);          <span style="color:#75715e">//设置MoudleListView的风格，初始化模块列表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_COMMAND: {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">switch</span> (LOWORD(wParam)) {
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> IDC_BUTTON_protect: {
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">//DialogBox(hIns, MAKEINTRESOURCE(IDD_ABOUTBOX), NULL, NULL);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> IDC_BUTTON_PE: {
</span></span><span style="display:flex;"><span>					<span style="color:#75715e">//打开新的对话框，PE查看器
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>				<span style="color:#66d9ef">case</span> IDC_BUTTON_logout: {
</span></span><span style="display:flex;"><span>					EndDialog(hDlg, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>					PostQuitMessage(<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>					<span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>				}
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">case</span> WM_NOTIFY: {
</span></span><span style="display:flex;"><span>			NMHDR<span style="color:#f92672">*</span> pNMHDR <span style="color:#f92672">=</span> (NMHDR<span style="color:#f92672">*</span>)lParam;
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> (wParam <span style="color:#f92672">==</span> IDC_LIST_Down <span style="color:#f92672">&amp;&amp;</span> pNMHDR<span style="color:#f92672">-&gt;</span>code <span style="color:#f92672">==</span> NM_CLICK) {
</span></span><span style="display:flex;"><span>				EnumMoudles(GetDlgItem(hDlg, IDC_LIST_Down), wParam, lParam);
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> nRet;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> APIENTRY <span style="color:#a6e22e">WinMain</span>(HINSTANCE hInstance,
</span></span><span style="display:flex;"><span>                     HINSTANCE hPrevInstance,
</span></span><span style="display:flex;"><span>                     LPSTR     lpCmdLine,
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">int</span>       nCmdShow)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">// TODO: Place code here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	DialogBox(hInstance, MAKEINTRESOURCE(IDD_DIALOG_MAIN), NULL, (DLGPROC)MainDlgProc);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>创建线程<span class="hx-absolute -hx-mt-20" id="创建线程"></span>
    <a href="#%e5%88%9b%e5%bb%ba%e7%ba%bf%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>一个加一个减</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">// qqqq.cpp : Defines the entry point for the application.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;stdafx.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;resource.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>HWND sub;
</span></span><span style="display:flex;"><span>HWND plus;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">doSub</span>(LPVOID lpParameter){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//获取文本框内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    TCHAR szBuffer[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    GetWindowText(sub, szBuffer, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//字符转数字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD time;
</span></span><span style="display:flex;"><span>    sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>time);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//计算并写回文本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(time <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>        Sleep(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        sprintf(szBuffer,<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">--</span>time);
</span></span><span style="display:flex;"><span>        SetWindowText(sub,szBuffer);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">doPlus</span>(LPVOID lpParameter){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//获取文本框内容
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    TCHAR szBuffer[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    GetWindowText(plus, szBuffer, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//字符转数字
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD time;
</span></span><span style="display:flex;"><span>    sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>time);
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//计算并写回文本
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">while</span>(time <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">1000</span>){
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>);
</span></span><span style="display:flex;"><span>        Sleep(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>        sprintf(szBuffer,<span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">++</span>time);
</span></span><span style="display:flex;"><span>        SetWindowText(plus,szBuffer);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL CALLBACK <span style="color:#a6e22e">DialogProc</span>(                                    
</span></span><span style="display:flex;"><span>                         HWND hwndDlg,  <span style="color:#75715e">// handle to dialog box            
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                         UINT uMsg,     <span style="color:#75715e">// message            
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                         WPARAM wParam, <span style="color:#75715e">// first message parameter            
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                         LPARAM lParam  <span style="color:#75715e">// second message parameter            
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>                         )            
</span></span><span style="display:flex;"><span>{    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span>(uMsg)                                
</span></span><span style="display:flex;"><span>    {    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> WM_INITDIALOG :
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//初始化文本框
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            sub <span style="color:#f92672">=</span> GetDlgItem(hwndDlg,IDC_EDIT_SUB);
</span></span><span style="display:flex;"><span>            SetWindowText(sub,TEXT(<span style="color:#e6db74">&#34;1000&#34;</span>));
</span></span><span style="display:flex;"><span>            plus <span style="color:#f92672">=</span> GetDlgItem(hwndDlg, IDC_EDIT_ADD);
</span></span><span style="display:flex;"><span>            SetWindowText(plus,TEXT(<span style="color:#e6db74">&#34;0&#34;</span>));
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TRUE;     
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span>  WM_COMMAND :                                
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (LOWORD (wParam))                            
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> IDC_BUTTON_START:  
</span></span><span style="display:flex;"><span>            HANDLE hThread <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, doSub, NULL, <span style="color:#ae81ff">0</span>, NULL);        
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">//如果不在其他的地方引用它 关闭句柄                
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#f92672">::</span>CloseHandle(hThread);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            HANDLE hThread2 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, doPlus, NULL, <span style="color:#ae81ff">0</span>, NULL);                     
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">::</span>CloseHandle(hThread2);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> TRUE;                       
</span></span><span style="display:flex;"><span>        }                            
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">break</span>;   
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> WM_CLOSE:
</span></span><span style="display:flex;"><span>        EndDialog(hwndDlg, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FALSE;                                
</span></span><span style="display:flex;"><span>}    
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> APIENTRY <span style="color:#a6e22e">WinMain</span>(HINSTANCE hInstance,
</span></span><span style="display:flex;"><span>                     HINSTANCE hPrevInstance,
</span></span><span style="display:flex;"><span>                     LPSTR     lpCmdLine,
</span></span><span style="display:flex;"><span>                     <span style="color:#66d9ef">int</span>       nCmdShow)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span> 	<span style="color:#75715e">// TODO: Place code here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	DialogBox(hInstance, MAKEINTRESOURCE(IDD_DIALOG1), NULL, DialogProc);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>线程控制<span class="hx-absolute -hx-mt-20" id="线程控制"></span>
    <a href="#%e7%ba%bf%e7%a8%8b%e6%8e%a7%e5%88%b6" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>值为什么不准确？</p>
<p>通俗易懂的解释：</p>
<p>假设有一个公共的白板，上面写着一个数字，比如 “<code>0</code>”。  现在有两个小朋友，小明和小红，他们都想轮流在这个白板上把数字加 1，并且每个人都要加 <code>10000</code> 次。  我们希望最终白板上的数字是 <code>20000</code>。</p>
<ol>
<li><strong>小明想加 <code>1</code>：</strong> 小明走到白板前，看到上面写着 “<code>0</code>”，心里记住了 “现在是 <code>0</code>”。</li>
<li><strong>小红也想加 <code>1</code>：</strong>  几乎同时，小红也走到白板前，也看到了上面写着 “<code>0</code>”，她也记住了 “现在是 <code>0</code>”。</li>
<li><strong>小明写下新数字：</strong> 小明心算了一下 <code>0 + 1 = 1</code>，然后拿起笔，把白板上的 “<code>0</code>” 擦掉，写上了 “<code>1</code>”。</li>
<li><strong>小红也写下新数字：</strong> 小红也心算了一下 <code>0 + 1 = 1</code> （注意，她看到的是之前的 &ldquo;<code>0</code>&quot;，而不是小明刚写的 &ldquo;<code>1</code>&quot;），然后她也拿起笔，把白板上的 &ldquo;<code>0</code>&rdquo; （如果还没被擦掉）或者 &ldquo;<code>1</code>&rdquo; （如果已经被小明写上了，但是小红没注意到）擦掉，也写上了 &ldquo;<code>1</code>&quot;。</li>
</ol>
<p><strong>结果：</strong>  本来我们希望小明和小红都加一次 <code>1</code>，白板上应该变成 &ldquo;<code>2</code>&quot;，但是由于他们几乎同时操作，并且没有“协调好”，结果白板上最终只显示了 &ldquo;<code>1</code>&quot;。 有一次加 <code>1</code> 的操作 “丢失” 了！</p>
</li>
</ul>
<h4>临界区<span class="hx-absolute -hx-mt-20" id="临界区"></span>
    <a href="#%e4%b8%b4%e7%95%8c%e5%8c%ba" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>通过使用临界区实现一个死锁程序</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>CRITICAL_SECTION cs1;
</span></span><span style="display:flex;"><span>CRITICAL_SECTION cs2;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">ThreadProc1</span>(LPVOID lpParameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    EnterCriticalSection(<span style="color:#f92672">&amp;</span>cs1);
</span></span><span style="display:flex;"><span>    Sleep(<span style="color:#ae81ff">10000</span>);
</span></span><span style="display:flex;"><span>    EnterCriticalSection(<span style="color:#f92672">&amp;</span>cs2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LeaveCriticalSection(<span style="color:#f92672">&amp;</span>cs2);
</span></span><span style="display:flex;"><span>    LeaveCriticalSection(<span style="color:#f92672">&amp;</span>cs1);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;1 1</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">ThreadProc2</span>(LPVOID lpParameter)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    EnterCriticalSection(<span style="color:#f92672">&amp;</span>cs2);
</span></span><span style="display:flex;"><span>    Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>    EnterCriticalSection(<span style="color:#f92672">&amp;</span>cs1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    LeaveCriticalSection(<span style="color:#f92672">&amp;</span>cs1);
</span></span><span style="display:flex;"><span>    LeaveCriticalSection(<span style="color:#f92672">&amp;</span>cs2);
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;2 2</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	InitializeCriticalSection(<span style="color:#f92672">&amp;</span>cs1);
</span></span><span style="display:flex;"><span>	InitializeCriticalSection(<span style="color:#f92672">&amp;</span>cs2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//创建一个新的线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	HANDLE hThread1 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, ThreadProc1,NULL, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//创建一个新的线程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	HANDLE hThread2 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, ThreadProc2,NULL, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//如果不在其他的地方引用它 关闭句柄
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">::</span>CloseHandle(hThread1);
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">::</span>CloseHandle(hThread2);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DeleteCriticalSection(<span style="color:#f92672">&amp;</span>cs1);
</span></span><span style="display:flex;"><span>    DeleteCriticalSection(<span style="color:#f92672">&amp;</span>cs2);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>会发现输出中没有<code>1 1</code>和<code>2 2</code>。</p>
</li>
</ul>
<h4>互斥体<span class="hx-absolute -hx-mt-20" id="互斥体"></span>
    <a href="#%e4%ba%92%e6%96%a5%e4%bd%93" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>第一步：在第一个文本框中输入一个值，比如<code>1000</code>。
第二步：点击抢红包，同时创建<code>3</code>个线程，每个线程循环进行抢红包的操作，每次抢<code>50</code>。
第三步：使用<code>Mutex</code>进行线程控制，当第一个文本框中的值<code>&lt;50</code>时，强红包线程结束。
特别说明：
1、四个文本框中的值总和应该为<code>1000</code>
2、强红包线程每次延时<code>50</code>毫秒。
3、使用<code>WaitForMultipleObjects</code>监听所有线程，当线程全部结束后调用<code>CloseHandle</code>关闭句柄。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">// test.cpp : Defines the entry point for the application.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;stdafx.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&#34;resource.h&#34;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>HWND main_hwnd;
</span></span><span style="display:flex;"><span>HWND hwnd_A;
</span></span><span style="display:flex;"><span>HWND hwnd_B;
</span></span><span style="display:flex;"><span>HWND hwnd_C;
</span></span><span style="display:flex;"><span>HANDLE g_hMutex;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew_thread1</span>(LPVOID lpParameter);
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew_thread2</span>(LPVOID lpParameter);
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew_thread3</span>(LPVOID lpParameter);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew_thread1</span>(LPVOID lpParameter) {
</span></span><span style="display:flex;"><span>    TCHAR szBuffer[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    DWORD total_amount;
</span></span><span style="display:flex;"><span>    DWORD thread_amount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (TRUE) {
</span></span><span style="display:flex;"><span>        WaitForSingleObject(g_hMutex, INFINITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(szBuffer));
</span></span><span style="display:flex;"><span>        GetWindowText(main_hwnd, szBuffer, <span style="color:#66d9ef">sizeof</span>(szBuffer) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(szBuffer[<span style="color:#ae81ff">0</span>]));
</span></span><span style="display:flex;"><span>        sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>total_amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (total_amount <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>) {
</span></span><span style="display:flex;"><span>            ReleaseMutex(g_hMutex);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sprintf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, total_amount <span style="color:#f92672">-</span> <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        SetWindowText(main_hwnd, szBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(szBuffer));
</span></span><span style="display:flex;"><span>        GetWindowText(hwnd_A, szBuffer, <span style="color:#66d9ef">sizeof</span>(szBuffer) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(szBuffer[<span style="color:#ae81ff">0</span>]));
</span></span><span style="display:flex;"><span>        sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>thread_amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sprintf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, thread_amount <span style="color:#f92672">+</span> <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        SetWindowText(hwnd_A, szBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ReleaseMutex(g_hMutex);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Sleep(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew_thread2</span>(LPVOID lpParameter) {
</span></span><span style="display:flex;"><span>    TCHAR szBuffer[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    DWORD total_amount;
</span></span><span style="display:flex;"><span>    DWORD thread_amount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (TRUE) {
</span></span><span style="display:flex;"><span>        WaitForSingleObject(g_hMutex, INFINITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(szBuffer));
</span></span><span style="display:flex;"><span>        GetWindowText(main_hwnd, szBuffer, <span style="color:#66d9ef">sizeof</span>(szBuffer) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(szBuffer[<span style="color:#ae81ff">0</span>]));
</span></span><span style="display:flex;"><span>        sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>total_amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (total_amount <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>) {
</span></span><span style="display:flex;"><span>            ReleaseMutex(g_hMutex);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sprintf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, total_amount <span style="color:#f92672">-</span> <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        SetWindowText(main_hwnd, szBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(szBuffer));
</span></span><span style="display:flex;"><span>        GetWindowText(hwnd_B, szBuffer, <span style="color:#66d9ef">sizeof</span>(szBuffer) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(szBuffer[<span style="color:#ae81ff">0</span>])); 
</span></span><span style="display:flex;"><span>        sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>thread_amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sprintf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, thread_amount <span style="color:#f92672">+</span> <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        SetWindowText(hwnd_B, szBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ReleaseMutex(g_hMutex);
</span></span><span style="display:flex;"><span>        Sleep(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew_thread3</span>(LPVOID lpParameter) {
</span></span><span style="display:flex;"><span>    TCHAR szBuffer[<span style="color:#ae81ff">10</span>];
</span></span><span style="display:flex;"><span>    DWORD total_amount;
</span></span><span style="display:flex;"><span>    DWORD thread_amount;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (TRUE) {
</span></span><span style="display:flex;"><span>        WaitForSingleObject(g_hMutex, INFINITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(szBuffer));
</span></span><span style="display:flex;"><span>        GetWindowText(main_hwnd, szBuffer, <span style="color:#66d9ef">sizeof</span>(szBuffer) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(szBuffer[<span style="color:#ae81ff">0</span>]));
</span></span><span style="display:flex;"><span>        sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>total_amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (total_amount <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">50</span>) {
</span></span><span style="display:flex;"><span>            ReleaseMutex(g_hMutex);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sprintf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, total_amount <span style="color:#f92672">-</span> <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        SetWindowText(main_hwnd, szBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        memset(szBuffer, <span style="color:#ae81ff">0</span>, <span style="color:#66d9ef">sizeof</span>(szBuffer));
</span></span><span style="display:flex;"><span>        GetWindowText(hwnd_C, szBuffer, <span style="color:#66d9ef">sizeof</span>(szBuffer) <span style="color:#f92672">/</span> <span style="color:#66d9ef">sizeof</span>(szBuffer[<span style="color:#ae81ff">0</span>]));
</span></span><span style="display:flex;"><span>        sscanf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, <span style="color:#f92672">&amp;</span>thread_amount);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        sprintf(szBuffer, <span style="color:#e6db74">&#34;%d&#34;</span>, thread_amount <span style="color:#f92672">+</span> <span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>        SetWindowText(hwnd_C, szBuffer);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ReleaseMutex(g_hMutex);
</span></span><span style="display:flex;"><span>        Sleep(<span style="color:#ae81ff">50</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD WINAPI <span style="color:#a6e22e">startnew</span>(LPVOID lpParameter) {
</span></span><span style="display:flex;"><span>    g_hMutex <span style="color:#f92672">=</span> CreateMutex(NULL, FALSE, <span style="color:#e6db74">&#34;XYZ&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (g_hMutex <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        MessageBox(NULL, TEXT(<span style="color:#e6db74">&#34;error&#34;</span>), TEXT(<span style="color:#e6db74">&#34;error&#34;</span>), MB_ICONERROR);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    HANDLE hThread1 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, startnew_thread1, NULL, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>    HANDLE hThread2 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, startnew_thread2, NULL, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>    HANDLE hThread3 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, startnew_thread3, NULL, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    HANDLE hThreads[<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> {hThread1, hThread2, hThread3};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    WaitForMultipleObjects(<span style="color:#ae81ff">3</span>, hThreads, TRUE, INFINITE);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">::</span>CloseHandle(hThread1);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">::</span>CloseHandle(hThread2);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">::</span>CloseHandle(hThread3);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">::</span>CloseHandle(g_hMutex);
</span></span><span style="display:flex;"><span>    g_hMutex <span style="color:#f92672">=</span> NULL;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BOOL CALLBACK <span style="color:#a6e22e">DialogProc</span>(
</span></span><span style="display:flex;"><span>    HWND hwndDlg,   <span style="color:#75715e">// handle to dialog box
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    UINT uMsg,      <span style="color:#75715e">// message
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    WPARAM wParam,  <span style="color:#75715e">// first message parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    LPARAM lParam   <span style="color:#75715e">// second message parameter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">switch</span> (uMsg)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> WM_INITDIALOG:
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        main_hwnd <span style="color:#f92672">=</span> GetDlgItem(hwndDlg, IDC_EDIT_total);
</span></span><span style="display:flex;"><span>        SetWindowText(main_hwnd, TEXT(<span style="color:#e6db74">&#34;1000&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        hwnd_A <span style="color:#f92672">=</span> GetDlgItem(hwndDlg, IDC_EDIT_1);        <span style="color:#75715e">// 线程1文本框
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SetWindowText(hwnd_A, TEXT(<span style="color:#e6db74">&#34;0&#34;</span>));
</span></span><span style="display:flex;"><span>        hwnd_B <span style="color:#f92672">=</span> GetDlgItem(hwndDlg, IDC_EDIT_2);        <span style="color:#75715e">// 线程2文本框
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SetWindowText(hwnd_B, TEXT(<span style="color:#e6db74">&#34;0&#34;</span>));
</span></span><span style="display:flex;"><span>        hwnd_C <span style="color:#f92672">=</span> GetDlgItem(hwndDlg, IDC_EDIT_3);        <span style="color:#75715e">// 线程3文本框
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        SetWindowText(hwnd_C, TEXT(<span style="color:#e6db74">&#34;0&#34;</span>));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> WM_COMMAND:
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (LOWORD(wParam))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> IDC_BUTTON: <span style="color:#75715e">// 按钮点击事件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            HANDLE hThreadButton <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>CreateThread(NULL, <span style="color:#ae81ff">0</span>, startnew, NULL, <span style="color:#ae81ff">0</span>, NULL);
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">::</span>CloseHandle(hThreadButton);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">case</span> WM_CLOSE:
</span></span><span style="display:flex;"><span>        EndDialog(hwndDlg, <span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> TRUE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> FALSE;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> APIENTRY <span style="color:#a6e22e">WinMain</span>(HINSTANCE hInstance,
</span></span><span style="display:flex;"><span>    HINSTANCE hPrevInstance,
</span></span><span style="display:flex;"><span>    LPSTR    lpCmdLine,
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span>      nCmdShow)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// TODO: Place code here.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DialogBox(hInstance, MAKEINTRESOURCE(IDD_DIALOG1), NULL, (DLGPROC)DialogProc);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>鼠标_键盘<span class="hx-absolute -hx-mt-20" id="鼠标_键盘"></span>
    <a href="#%e9%bc%a0%e6%a0%87_%e9%94%ae%e7%9b%98" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>练习：</p>
<ol>
<li>遍历所有打开窗口，等待</li>
<li>设置鼠标位置，点击</li>
<li>模拟键盘输入密码</li>
<li>设置鼠标位置，单击登录</li>
</ol>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//ShowWindow(GetConsoleWindow(), SW_HIDE);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	STARTUPINFO si <span style="color:#f92672">=</span> { <span style="color:#ae81ff">0</span> };
</span></span><span style="display:flex;"><span>	PROCESS_INFORMATION pi;
</span></span><span style="display:flex;"><span>	si.cb <span style="color:#f92672">=</span> <span style="color:#66d9ef">sizeof</span>(si);
</span></span><span style="display:flex;"><span>	RECT windowRect;
</span></span><span style="display:flex;"><span>	BOOL res <span style="color:#f92672">=</span> CreateProcess(
</span></span><span style="display:flex;"><span>			TEXT(<span style="color:#e6db74">&#34;C:</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Program Files</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">WindowsApps</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Microsoft.WindowsNotepad_11.2410.21.0_x64__8wekyb3d8bbwe</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Notepad</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">Notepad.exe&#34;</span>),
</span></span><span style="display:flex;"><span>			NULL,
</span></span><span style="display:flex;"><span>			NULL,
</span></span><span style="display:flex;"><span>			NULL,
</span></span><span style="display:flex;"><span>			FALSE,
</span></span><span style="display:flex;"><span>			CREATE_NEW_CONSOLE,
</span></span><span style="display:flex;"><span>			NULL,
</span></span><span style="display:flex;"><span>			NULL, <span style="color:#f92672">&amp;</span>si, <span style="color:#f92672">&amp;</span>pi);
</span></span><span style="display:flex;"><span>	HWND hwnd <span style="color:#f92672">=</span> FindWindow(NULL, TEXT(<span style="color:#e6db74">&#34;Notepad&#34;</span>));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (GetWindowRect(hwnd, <span style="color:#f92672">&amp;</span>windowRect)) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> centerX <span style="color:#f92672">=</span> windowRect.left <span style="color:#f92672">+</span> (windowRect.right <span style="color:#f92672">-</span> windowRect.left) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> centerY <span style="color:#f92672">=</span> windowRect.top <span style="color:#f92672">+</span> (windowRect.bottom <span style="color:#f92672">-</span> windowRect.top) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (SetCursorPos(centerX, centerY)) {
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    Sleep(<span style="color:#ae81ff">1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	mouse_event(MOUSEEVENTF_LEFTDOWN,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	mouse_event(MOUSEEVENTF_LEFTUP,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">67</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">67</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">16</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">54</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">54</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">53</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">53</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">77</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">77</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">65</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">69</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">69</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">76</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	keybd_event(<span style="color:#ae81ff">76</span>,<span style="color:#ae81ff">0</span>,KEYEVENTF_KEYUP,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">test</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (true)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		TCHAR szTitle[MAX_PATH] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>		HWND hwnd1 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;文件资源管理器&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd2 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;火绒安全分析工具&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd3 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;设置&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd4 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;Windows 安全中心&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd5 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;注册表编辑器&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd6 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;Windows PowerShell&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd7 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;命令提示符&#34;</span>));
</span></span><span style="display:flex;"><span>		HWND hwnd8 <span style="color:#f92672">=</span> <span style="color:#f92672">::</span>FindWindow(NULL,TEXT(<span style="color:#e6db74">&#34;任务管理器&#34;</span>));
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd1,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd2,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd3,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd4,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd5,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd6,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd7,false);
</span></span><span style="display:flex;"><span>		SwitchToThisWindow(hwnd8,false);
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span>(hwnd1 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd2 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd3 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd4 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd5 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd6 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd7 <span style="color:#f92672">!=</span> NULL <span style="color:#f92672">||</span> hwnd8 <span style="color:#f92672">!=</span> NULL)
</span></span><span style="display:flex;"><span>		{
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd1,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd2,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd3,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd4,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd5,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd6,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd7,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>			<span style="color:#f92672">::</span>SendMessage(hwnd8,WM_CLOSE,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		Sleep(<span style="color:#ae81ff">100</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h3>CE<span class="hx-absolute -hx-mt-20" id="ce"></span>
    <a href="#ce" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><ul>
<li>
<p>第八题</p>
<ol>
<li>
<p>首先找到是谁修改了这个值</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">RAX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">00000</span><span style="color:#66d9ef">DD5</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RCX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#66d9ef">E2A9C98E</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">066</span><span style="color:#66d9ef">FC98E</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">01632</span><span style="color:#66d9ef">ED0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">100290098</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FEE40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FED00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RIP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E94D</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">指针基址可能是</span> <span style="color:#960050;background-color:#1e0010">=01632</span><span style="color:#a6e22e">ED0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E940</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">ecx</span>,<span style="color:#ae81ff">00000</span><span style="color:#66d9ef">FA0</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E945</span> - <span style="color:#66d9ef">call</span> <span style="color:#ae81ff">10000</span><span style="color:#66d9ef">FC10</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E94A</span> - <span style="color:#66d9ef">mov</span> [<span style="color:#66d9ef">rsi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span>],<span style="color:#66d9ef">eax</span>   <span style="color:#960050;background-color:#1e0010">&lt;</span>----
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E94D</span> - <span style="color:#66d9ef">lea</span> <span style="color:#66d9ef">rcx</span>,[<span style="color:#66d9ef">rbp-08</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E951</span> - <span style="color:#66d9ef">call</span> <span style="color:#ae81ff">100008</span><span style="color:#66d9ef">F10</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>可以看到是<code>eax</code>向<code>[rsi+18]</code>赋值，为什么要找<code>rsi</code>而不是<code>eax</code>？</p>
<p>关注<code>rsi</code>是因为它指向存储数据的<strong>内存结构</strong>，其来源可通过指针链关联到静态基址；而<code>eax</code>仅是一个临时数值，无法用于基址定位。通过追踪<code>rsi</code>的赋值逻辑，才能找到稳定的基址表达式。</p>
</li>
<li>
<p>由于目前<code>rsi</code>里面的值有可能直接是基址，也有可能是新一级的偏移（比如<code>[基址 + 0x100]</code>）；是新一级的偏移的话就不能直接通过<code>0x1632ED0</code>去寻找了，而是要根据减去偏移后的值去寻找。</p>
<p>直接找谁修改了它发现没有人修改它，就看谁访问了它（这个它就是根据<code>0x1632ED0</code>进行新搜索的地址，判断它直接是基址还是偏移）：</p>
<p>这时有两条指令访问了它，其中一个是访问它进行比较，没有价值。我们看另外一个：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">RAX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">0164</span><span style="color:#66d9ef">AF60</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RCX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">0000185</span><span style="color:#66d9ef">A</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">01632</span><span style="color:#66d9ef">ED0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">100290098</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FEE40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FED00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RIP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E90B</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">指针基址可能是</span> <span style="color:#960050;background-color:#1e0010">=01632</span><span style="color:#a6e22e">ED0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E900</span> - <span style="color:#66d9ef">je</span> <span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E9A7</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E906</span> - <span style="color:#66d9ef">nop</span> <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E908</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rsi</span>,[<span style="color:#66d9ef">rsi</span>]    <span style="color:#960050;background-color:#1e0010">&lt;</span>----
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E90B</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">rsi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E90E</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">edx</span>,[<span style="color:#66d9ef">rax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">04</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这是将<code>rsi</code>地址的值赋给<code>rsi</code>。</p>
</li>
<li>
<p>发现它没有偏移，那么就直接用<code>0x1632ED0</code>地址的值（<code>0x164AF60</code>）再次进行搜索，同样先看一下谁访问了它：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">RAX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">0164</span><span style="color:#66d9ef">AEE0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RCX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">00011</span><span style="color:#66d9ef">DB9</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">0164</span><span style="color:#66d9ef">AF60</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">100290098</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FEE40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FED00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RIP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E8C0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">指针基址可能是</span> <span style="color:#960050;background-color:#1e0010">=0164</span><span style="color:#a6e22e">AEE0</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E8B5</span> - <span style="color:#66d9ef">je</span> <span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E9A7</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E8BB</span> - <span style="color:#66d9ef">nop</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E8BC</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rsi</span>,[<span style="color:#66d9ef">rsi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span>]    <span style="color:#960050;background-color:#1e0010">&lt;</span>----
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E8C0</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">rsi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E8C3</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">edx</span>,[<span style="color:#66d9ef">rax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">C</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这是将<code>rsi+0x18</code>地址的值赋给<code>rsi</code>。这时就不能用<code>0x164AF60</code>地址的值（<code>0x164AEF8</code>）直接搜索，因为有<code>0x18</code>的偏移。</p>
</li>
<li>
<p>所以用<code>0x164AEE0</code>再次进行搜索，同样先看一下谁访问了它：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">RAX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">01632</span><span style="color:#66d9ef">C50</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RCX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">00001</span><span style="color:#66d9ef">C5A</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">0164</span><span style="color:#66d9ef">AEE0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">100290098</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FEE40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FED00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RIP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E878</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">指针基址可能是</span> <span style="color:#960050;background-color:#1e0010">=01632</span><span style="color:#a6e22e">C50</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E86D</span> - <span style="color:#66d9ef">je</span> <span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E9A7</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E873</span> - <span style="color:#66d9ef">nop</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E874</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rsi</span>,[<span style="color:#66d9ef">rsi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">10</span>]    <span style="color:#960050;background-color:#1e0010">&lt;</span>----
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E878</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">rsi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E87B</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">edx</span>,[<span style="color:#66d9ef">rax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">04</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>同上，所以就直接用<code>0x1632C50</code>再次进行搜索，同样先看一下谁访问了它：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">RAX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">FBAB0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RCX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">F7270</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDX</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">015</span><span style="color:#66d9ef">FBAB0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">01632</span><span style="color:#66d9ef">C50</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RDI</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">100290098</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RBP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FEE40</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RSP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">013</span><span style="color:#66d9ef">FED00</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">RIP</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E82D</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">指针基址可能是</span> <span style="color:#960050;background-color:#1e0010">=100325</span><span style="color:#a6e22e">B00</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E81D</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">qword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">rbp-08</span>],<span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E825</span> - <span style="color:#66d9ef">nop</span> 
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10002</span><span style="color:#66d9ef">E826</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rsi</span>,[<span style="color:#ae81ff">100325</span><span style="color:#66d9ef">B00</span>]    <span style="color:#960050;background-color:#1e0010">&lt;</span>----
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E82D</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">rax</span>,<span style="color:#66d9ef">rsi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">10002</span><span style="color:#a6e22e">E830</span> - <span style="color:#66d9ef">mov</span> <span style="color:#66d9ef">edx</span>,[<span style="color:#66d9ef">rax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">04</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>这是可以看到已经不是偏移了，而是硬编码的地址，就是向这个地址进行赋值的。综上找到的结构为：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">[[[[[100325</span><span style="color:#a6e22e">B00</span>]<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">10</span>]<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span>]]<span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span>] <span style="color:#960050;background-color:#1e0010">=</span> <span style="color:#66d9ef">eax</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>我们需要构造这个结构去直接找到被赋值的位置，在<code>ce</code>中手动添加地址：</p>
<p><img src="https://c65mael.github.io/homework/ce.png" alt="image" loading="lazy" /></p>
<p>就可以看到正常显示数值了，即使改变指针也不怕了。</p>
</li>
</ol>
</li>
</ul>
<h3>保护模式<span class="hx-absolute -hx-mt-20" id="保护模式"></span>
    <a href="#%e4%bf%9d%e6%8a%a4%e6%a8%a1%e5%bc%8f" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h4>段描述符与段选择子<span class="hx-absolute -hx-mt-20" id="段描述符与段选择子"></span>
    <a href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e4%b8%8e%e6%ae%b5%e9%80%89%e6%8b%a9%e5%ad%90" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>在<code>windbg</code>中查看<code>GDT</code>表的基址和长度</p>
<p>查看<code>xp</code>的<code>GDT</code>表</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">0:</span> <span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">r</span> <span style="color:#66d9ef">gdtr</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gdtr</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">8003</span><span style="color:#66d9ef">f000</span>		<span style="color:#75715e">#基址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">0:</span> <span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">r</span> <span style="color:#66d9ef">gdtl</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">gdtl</span><span style="color:#960050;background-color:#1e0010">=</span><span style="color:#ae81ff">000003</span><span style="color:#66d9ef">ff</span>		<span style="color:#960050;background-color:#1e0010">#长度</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>分别使用<code>dd dq</code>指令查看<code>GDT</code>表</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0: kd&gt; dd 8003f000
ReadVirtual: 8003f000 not properly sign extended
8003f000  00000000 00000000 0000ffff 00cf9b00
8003f010  0000ffff 00cf9300 0000ffff 00cffb00
8003f020  0000ffff 00cff300 200020ab 80008b04
8003f030  f0000001 ffc093df 00000fff 0040f300
8003f040  0400ffff 0000f200 00000000 00000000
8003f050  27000068 80008955 27680068 80008955
8003f060  2f40ffff 00009302 80003fff 0000920b
8003f070  700003ff ff0092ff 0000ffff 80009a40
0: kd&gt; dq 8003f000
ReadVirtual: 8003f000 not properly sign extended
8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008955`27000068 80008955`27680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>段描述符查分实验：拆<code>5</code>个</p>
<p><img src="https://c65mael.github.io/myassets/xuanzazi.png" alt="image" loading="lazy" /></p>
<ul>
<li>
<p>00cf9b00`0000ffff</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>Base=00 00 
23~20 [c]= 1101
G=1
D/B=1
AVL=1
Limit=f ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=1011
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>00cf9300`0000ffff</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>Base=00 00
23~20 [c]= 1101
G=1
D/B=1
AVL=1
Limit=f ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=0011
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>00cffb00`0000ffff</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>Base=00 00
23~20 [c]= 1101
G=1
D/B=1
AVL=1
Limit=f ffff
16~12 [f]=1111
p=1
DPL=11(3)
s=1
Type=1011
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>00cff300`0000ffff</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>Base=00 00
23~20 [c]= 1101
G=1
D/B=1
AVL=1
Limit=f ffff
16~12 [f]=1111
p=1
DPL=11(3)
s=1
Type=0011
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>80008b04`200020ab</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>Base=80 04
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 20ab
16~12 [8]=1000
p=1
DPL=00
s=0
Type=1011
Address=2000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008954`af000068 80008954`af680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff
8003f080  80009240`0000ffff 00009200`00000000

00cf9b00`0000ffff
Base=00 00
23~20 [c]= 1100
G=1
D/B=1
AVL=0
Limit=f ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[b]=1011
Address=0000

00cf9300`0000ffff
Base=00 00
23~20 [c]= 1100
G=1
D/B=1
AVL=0
Limit=f ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[3]=0011
Address=0000

00cffb00`0000ffff
Base=00 00
23~20 [c]= 1100
G=1
D/B=1
AVL=0
Limit=f ffff
16~12 [f]=1111
p=1
DPL=11
s=1
Type=[b]=1011
Address=0000

00cff300`0000ffff
Base=00 00
23~20 [c]= 1100
G=1
D/B=1
AVL=0
Limit=f ffff
16~12 [f]=1111
p=1
DPL=11
s=1
Type=[3]=0011
Address=0000

80008b04`200020ab
Base=80 04
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 20ab
16~12 [8]=1000
p=1
DPL=00
s=0
Type=[b]=1011
Address=2000

ffc093df`f0000001
Base=ff df
23~20 [c]= 1100
G=1
D/B=1
AVL=0
Limit=0 0001
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[3]=0011
Address=f000

0040f300`00000fff
Base=00 00
23~20 [4]= 0100
G=0
D/B=1
AVL=0
Limit=0 0fff
16~12 [f]=1111
p=1
DPL=11
s=1
Type=[3]=0011
Address=0000

0000f200`0400ffff
Base=00 00
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 ffff
16~12 [f]=1111
p=1
DPL=11
s=1
Type=[2]=0010
Address=0400

80008954`af000068
Base=80 54
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 0068
16~12 [8]=1000
p=1
DPL=00
s=0
Type=[9]=1001
Address=af00

00009302`2f40ffff
Base=00 02
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[3]=0011
Address=2f40

ff0092ff`700003ff
Base=ff ff
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 03ff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[2]=0010
Address=7000

80009a40`0000ffff
Base=80 40
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[a]=1001
Address=0000

80009240`0000ffff
Base=80 40
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 ffff
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[2]=0011
Address=0000

00009200`00000000
Base=00 00
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 0000
16~12 [9]=1001
p=1
DPL=00
s=1
Type=[2]=0011
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>段选择子拆分实验：</p>
<p><img src="https://c65mael.github.io/myassets/xz.png" alt="image" loading="lazy" /></p>
<ul>
<li>
<p>23</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0010 0011
RPL=11(3)
TI=0
Index=0010 0(4)</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>2B</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0010 1011
RPL=11(3)
TI=0
Index=0010 1(5)</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>30</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0011 0000
RPL=00
TI=0
Index=0011 0(6)</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>3B</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0011 1011
RPL=11(3)
TI=0
Index=0011 1(7)</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>53</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0101 0011
RPL=11(3)
TI=0
Index=0101 0(10)</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>使用LES，LDS等指令修改段寄存器</p>
<p><code>LES ebx, [SI]</code>就是高两字节给es，低4字节给ebx</p>
</li>
</ol>
<h4>段描述符属性P位_G位<span class="hx-absolute -hx-mt-20" id="段描述符属性p位_g位"></span>
    <a href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7p%e4%bd%8d_g%e4%bd%8d" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>查GDT表，如何快速确定哪个描述符的P位为0或者为1</p>
<p>可以检测段描述符的第5位，如果大于等于8则P为1，否则P为0</p>
<p>比如：00cf<strong>9</strong>b00`0000ffff</p>
</li>
<li>
<p>查GDT表，如何快速确定哪个描述符的G位为0或者为1</p>
<p>可以检测段描述符的第3位，如果大于等于8则G为1，否则G为0</p>
<p>比如：00<strong>c</strong>f9b00`0000ffff</p>
</li>
<li>
<p>将段描述符填写到段寄存器结构体中（每人填一个）(段选择子：23 2B 30 3B 53)</p>
<p>比如我用xp的GDT表做一下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008955`27000068 80008955`27680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>23
0010 0011
Index=00100(4)    --&gt; 00cff300`0000ffff

00cff300`0000ffff
Base=00 00
23~20 [c]= 1101
G=1
D/B=1
AVL=1
Limit=f ffff
16~12 [f]=1111
p=1
DPL=11(3)
s=1
Type=0011
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
</ol>
<h4>段描述符属性S位_TYPE域<span class="hx-absolute -hx-mt-20" id="段描述符属性s位_type域"></span>
    <a href="#%e6%ae%b5%e6%8f%8f%e8%bf%b0%e7%ac%a6%e5%b1%9e%e6%80%a7s%e4%bd%8d_type%e5%9f%9f" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p><img src="https://c65mael.github.io/myassets/type.png" alt="image" loading="lazy" /></p>
<ol>
<li>
<p>判断哪些是系统段描述符?哪些是代码或者数据段描述符?</p>
<p>因为DPL的值只可能是全1或全0，所以16~12位如果是数据段或代码段的话只能为f(1111)或9(1001)。<strong>那么在段描述符中找第五位，如果是f或9就是数据段或代码段。</strong></p>
</li>
<li>
<p>判断哪些是代码段描述符？哪些是数据段描述符？</p>
<p>因为TYPE域的第11位只可能是1或0，而且全为1是代码段；全为0是数据段。<strong>那么在段描述符中第六位大于8就是代码段，小于8就是数据段。</strong></p>
</li>
<li>
<p>查分几个数据段: E W A</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>00009302`2f40ffff 
Base=00 02
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 ffff
16~12 [9]=1001
p=1
DPL=00(0)
s=1
Type=0011    --&gt;可读写，访问过
Address=2f40

0000920b`80003fff
Base=00 0b
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 3fff
16~12 [9]=1001
p=1
DPL=00(0)
s=1
Type=0010    --&gt;可读写
Address=8000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>查分几个代码段:C R A</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>80009a80`0000ffff
Base=80 80
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 ffff
16~12 [9]=1001
p=1
DPL=00(0)
s=1
Type=1010    --&gt;可读执行
Address=0000

00cffb00`0000ffff
Base=00 00
23~20 [c]= 1100
G=1
D/B=1
AVL=0
Limit=f ffff
16~12 [f]=1111
p=1
DPL=11(3)
s=1
Type=1011    --&gt;可读执行，访问过
Address=0000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>查分几个系统段描述符</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>80008955`27000068
Base=80 55
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 0068
16~12 [8]=1000
p=1
DPL=00(0)
s=0
Type=1001    --&gt;386以上CPU的TSS，type第3位为1
Address=2700

80008955`27680068
Base=80 55
23~20 [0]= 0000
G=0
D/B=0
AVL=0
Limit=0 0068
16~12 [8]=1000
p=1
DPL=00(0)
s=0
Type=1001    --&gt;386以上CPU的TSS，type第3位为1
Address=2768</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h4>段权限检查<span class="hx-absolute -hx-mt-20" id="段权限检查"></span>
    <a href="#%e6%ae%b5%e6%9d%83%e9%99%90%e6%a3%80%e6%9f%a5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>在3环能加载的数据段有哪些？</p>
<p><code>CPL=3</code>是最低权限，那么只能加载更低权限或相同权限的数据段，所以可以加载<code>DPL=3</code>的数据段</p>
</li>
<li>
<p>在0环能加载的数据段有哪些?</p>
<p><code>CPL=0</code>，和第一题一样，所以可以加载<code>DPL=0 / 1 / 2 / 3</code>的数据段</p>
</li>
<li>
<p>详细描述这下面代码的执行过程:</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">ax</span>,<span style="color:#ae81ff">0x23</span>    <span style="color:#75715e">#0x23=0010 0011那么rpl为11(3)，index=00100(4)，在GDT表中找索引为4，接着去检查该段描述符是否为有效，然后看S位是否是数据/代码段还是系统段，然后再看TYPE域，比如我找的为00cff300`0000ffff，dpl就为3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">ds</span>,<span style="color:#66d9ef">ax</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h4>代码间的跳转<span class="hx-absolute -hx-mt-20" id="代码间的跳转"></span>
    <a href="#%e4%bb%a3%e7%a0%81%e9%97%b4%e7%9a%84%e8%b7%b3%e8%bd%ac" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p><strong>后面的实验虚拟机一定要使用单核单处理器，不然实验会失败的！！！</strong></p>
<ol>
<li>
<p>记住代码段间跳转的执行流程</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>1、段选择子拆分
2、查表得到段描述符
3、权限检查
4、加载段描述符
5、代码执行</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>自己实现一致代码段的段间跳转。</p>
<p>要求：<code>CPL &gt;= DPL</code></p>
<ol>
<li>通过windbg的指令<code>eq 地址 内容</code>(<code>eq 8003f048 00c9fc00 0000ffff</code>)，构建段描述符<code>00C9FC00·0000FFFF</code>，并且记好索引位置</li>
<li>执行指令<code>jmp far xx:xxxxxxxx</code></li>
<li>如果成功就会修改<code>cs</code>和<code>eip</code></li>
</ol>
</li>
<li>
<p>自己实现非一致代码段的段间跳转。</p>
<p>要求： <code>CPL == DPL</code> 并且 <code>RPL &lt;= DPL</code></p>
</li>
</ol>
<h4>调用门<span class="hx-absolute -hx-mt-20" id="调用门"></span>
    <a href="#%e8%b0%83%e7%94%a8%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>自己实现调用门（提权、无参数、EAX、ECX。存不存？）</p>
<ul>
<li>
<p>调用门描述符为：<code>0000EC00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">GetRegister</span>() {
</span></span><span style="display:flex;"><span>	_asm {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>; <span style="color:#75715e">// EIP, 废弃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>; <span style="color:#75715e">// 段选择子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	_asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>在windbg中可以断下</p>
</li>
<li>
<p>发现SS、ESP、CS寄存器都发生了变化</p>
</li>
</ul>
</li>
<li>
<p>自己实现调用门（提权、有参数）</p>
<p>需要看一下调用门：</p>
<p><img src="https://c65mael.github.io/myassets/dym.png" alt="image" loading="lazy" /></p>
<ul>
<li>
<p>调用门描述符为：<code>0000EC03·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DWORD x;
</span></span><span style="display:flex;"><span>DWORD y;
</span></span><span style="display:flex;"><span>DWORD z;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">GetRegister</span>() {
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		pushad
</span></span><span style="display:flex;"><span>		pushfd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		mov eax,[esp<span style="color:#f92672">+</span><span style="color:#ae81ff">0x24</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0x8</span>]
</span></span><span style="display:flex;"><span>		mov dword ptr ds:[x],eax
</span></span><span style="display:flex;"><span>		mov eax,[esp<span style="color:#f92672">+</span><span style="color:#ae81ff">0x24</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>		mov dword ptr ds:[y],eax
</span></span><span style="display:flex;"><span>		mov eax,[esp<span style="color:#f92672">+</span><span style="color:#ae81ff">0x24</span><span style="color:#f92672">+</span><span style="color:#ae81ff">8</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>		mov dword ptr ds:[z],eax
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		popfd
</span></span><span style="display:flex;"><span>		popad
</span></span><span style="display:flex;"><span>		retf <span style="color:#ae81ff">0xC</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Printfall</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x %x %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,x,y,z);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>; <span style="color:#75715e">// EIP, 废弃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>; <span style="color:#75715e">// 段选择子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _asm {
</span></span><span style="display:flex;"><span>		push <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		push <span style="color:#ae81ff">2</span>
</span></span><span style="display:flex;"><span>		push <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Printfall</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>如何通过实验论证0环堆栈存储哪些数据，顺序是什么？</p>
</li>
<li>
<p>这几行代码有什么意义？是必须的吗？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">pushad</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">pushfd</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">……</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">popfd</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">popad</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>用于保存和恢复寄存器的状态，也就是保护现场，防止其他寄存器被修改。</p>
</li>
<li>
<p>这几行代码在做什么？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,[<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x24</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x8</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x8</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,[<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x24</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x8</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x8</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">mov</span> <span style="color:#66d9ef">eax</span>,[<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x24</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span>]</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>访问我在栈中存的参数，查看栈的内容如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">dd</span> <span style="color:#66d9ef">b1ba6da0</span>
</span></span><span style="display:flex;"><span>ReadVirtual: <span style="color:#a6e22e">b1ba6da0</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">properly</span> <span style="color:#66d9ef">sign</span> <span style="color:#66d9ef">extended</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6da0</span>  <span style="color:#ae81ff">00000212</span> <span style="color:#ae81ff">0012</span><span style="color:#66d9ef">ff80</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">0012</span><span style="color:#66d9ef">ff80</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6db0</span>  <span style="color:#66d9ef">b1ba6dc4</span> <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffde000</span> <span style="color:#ae81ff">00380</span><span style="color:#66d9ef">df8</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6dc0</span>  <span style="color:#66d9ef">cccccccc</span> <span style="color:#ae81ff">004010</span><span style="color:#66d9ef">ee</span> <span style="color:#ae81ff">0000001</span><span style="color:#66d9ef">b</span> <span style="color:#ae81ff">00000003</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6dd0</span>  <span style="color:#ae81ff">00000002</span> <span style="color:#ae81ff">00000001</span> <span style="color:#ae81ff">0012</span><span style="color:#66d9ef">ff1c</span> <span style="color:#ae81ff">00000023</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6de0</span>  <span style="color:#ae81ff">805470</span><span style="color:#66d9ef">de</span> <span style="color:#66d9ef">b12221f0</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a31b970</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6df0</span>  <span style="color:#ae81ff">0000027</span><span style="color:#66d9ef">f</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6e00</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#66d9ef">ffff0000</span> <span style="color:#ae81ff">00001</span><span style="color:#66d9ef">f80</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b1ba6e10</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>那么，<code>esp+0x24+8</code>就是<code>b1ba6dcc</code>的位置，就是访问参数3，2，1。</p>
<p>更直观一点，不加<code>pushad，pushfd</code>，如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> <span style="color:#66d9ef">dd</span> <span style="color:#66d9ef">bad7fdc4</span>
</span></span><span style="display:flex;"><span>ReadVirtual: <span style="color:#a6e22e">bad7fdc4</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">properly</span> <span style="color:#66d9ef">sign</span> <span style="color:#66d9ef">extended</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fdc4</span>  <span style="color:#ae81ff">004010</span><span style="color:#66d9ef">ee</span> <span style="color:#ae81ff">0000001</span><span style="color:#66d9ef">b</span> <span style="color:#ae81ff">00000003</span> <span style="color:#ae81ff">00000002</span>    <span style="color:#75715e">#004010ee是返回地址，0000001b是旧cs，0012ff1c是旧esp，23是旧ss
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">bad7fdd4</span>  <span style="color:#ae81ff">00000001</span> <span style="color:#ae81ff">0012</span><span style="color:#66d9ef">ff1c</span> <span style="color:#ae81ff">00000023</span> <span style="color:#ae81ff">805470</span><span style="color:#66d9ef">de</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fde4</span>  <span style="color:#66d9ef">ba60eb85</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a25cd00</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">0000027</span><span style="color:#66d9ef">f</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fdf4</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fe04</span>  <span style="color:#66d9ef">ffff0000</span> <span style="color:#ae81ff">00001</span><span style="color:#66d9ef">f80</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fe14</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fe24</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">bad7fe34</span>  <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h4>测试<span class="hx-absolute -hx-mt-20" id="测试"></span>
    <a href="#%e6%b5%8b%e8%af%95" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p><strong>要求：代码正常执行不蓝屏</strong></p>
<ol>
<li>
<p>构造一个调用门，实现3环读取高2G内存。</p>
<ul>
<li>
<p>调用门描述符为：<code>0000EC00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DWORD x;
</span></span><span style="display:flex;"><span>DWORD y;
</span></span><span style="display:flex;"><span>DWORD z;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">GetRegister</span>() {
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		pushad
</span></span><span style="display:flex;"><span>		pushfd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		mov eax,<span style="color:#ae81ff">0x8003f008</span>
</span></span><span style="display:flex;"><span>		mov ebx,[eax]
</span></span><span style="display:flex;"><span>         mov x,ebx
</span></span><span style="display:flex;"><span>         mov ecx,<span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>         add eax,ecx
</span></span><span style="display:flex;"><span>         mov ebx,[eax]
</span></span><span style="display:flex;"><span>         mov y,ebx
</span></span><span style="display:flex;"><span>         add eax,ecx
</span></span><span style="display:flex;"><span>         mov ebx,[eax]
</span></span><span style="display:flex;"><span>         mov z,ebx
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>		popfd
</span></span><span style="display:flex;"><span>		popad
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Printfall</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x %x %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,x,y,z);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>; <span style="color:#75715e">// EIP, 废弃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>; <span style="color:#75715e">// 段选择子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Printfall</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：ffff cf9b00 ffff</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>在第一题的基础上进行修改，实现通过翻墙的方式返回到其他地址。</p>
<ul>
<li>
<p>调用门描述符为：<code>0000EC00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">GetRegister</span>() {
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		pop eax
</span></span><span style="display:flex;"><span>         mov eax,<span style="color:#ae81ff">0x401070</span>     <span style="color:#75715e">//函数Printfall()的地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         push eax
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">Printfall</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;okokokokokokok&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>; <span style="color:#75715e">// EIP, 废弃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>; <span style="color:#75715e">// 段选择子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    _asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：okokokokokokok</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>在第一题的基础上进行修改，在门中再建一个门跳转到其他地址。</p>
<ul>
<li>
<p>调用门描述符为：<code>0000EC00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> x<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> y<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buff1[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x90</span>,<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">GetRegister</span>() {
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		mov x,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		mov eax,<span style="color:#ae81ff">0x00081070</span>
</span></span><span style="display:flex;"><span>		mov ebx,<span style="color:#ae81ff">0x8003f090</span>
</span></span><span style="display:flex;"><span>		mov [ebx],eax
</span></span><span style="display:flex;"><span>		mov eax,<span style="color:#ae81ff">0x0040ec00</span>
</span></span><span style="display:flex;"><span>		mov ebx,<span style="color:#ae81ff">0x8003f094</span>
</span></span><span style="display:flex;"><span>		mov [ebx],eax
</span></span><span style="display:flex;"><span>         call far fword ptr[buff1]
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">two</span>() {
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		mov y,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x %x&#34;</span>,x,y);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：1 1</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
</ol>
<h4>中断门<span class="hx-absolute -hx-mt-20" id="中断门"></span>
    <a href="#%e4%b8%ad%e6%96%ad%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>自己实现中断门</p>
<ul>
<li>
<p>中断门描述符为：<code>0000EE00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DWORD H
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">test</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>{
</span></span><span style="display:flex;"><span>		pushad
</span></span><span style="display:flex;"><span>		pushfd
</span></span><span style="display:flex;"><span>		mov eax,<span style="color:#ae81ff">0x8003f008</span>
</span></span><span style="display:flex;"><span>		mov ebx,[eax]
</span></span><span style="display:flex;"><span>        mov H,ebx
</span></span><span style="display:flex;"><span>		popfd
</span></span><span style="display:flex;"><span>		popad
</span></span><span style="display:flex;"><span>		iretd
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%X&#34;</span>, H);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：FFFF</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>在调用门中实现使用IRETD返回</p>
<ul>
<li>
<p>调用门描述符为：<code>0000EC00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>] <span style="color:#f92672">=</span> {<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">GetRegister</span>() {
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		pop eax
</span></span><span style="display:flex;"><span>         pop ebx
</span></span><span style="display:flex;"><span>         mov ecx,<span style="color:#ae81ff">0x11111111</span>
</span></span><span style="display:flex;"><span>         push ecx
</span></span><span style="display:flex;"><span>         push ebx
</span></span><span style="display:flex;"><span>         push eax
</span></span><span style="display:flex;"><span>		iretd
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;okokokokokokok&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：okokokokokokok</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>在中断门中实现用RETF返回</p>
<ul>
<li>
<p>中断门描述符为：<code>0000EE00·00080000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">test</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>{
</span></span><span style="display:flex;"><span>		pop eax
</span></span><span style="display:flex;"><span>		pop ebx
</span></span><span style="display:flex;"><span>		popfd
</span></span><span style="display:flex;"><span>		push ebx
</span></span><span style="display:flex;"><span>		push eax
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;okokokokokokok&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
</ol>
<h4>陷阱门<span class="hx-absolute -hx-mt-20" id="陷阱门"></span>
    <a href="#%e9%99%b7%e9%98%b1%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>构造陷阱门
<ul>
<li>
<p>陷阱门描述符为：<code>0000EF00·001b0000</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">test</span>(){
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>{
</span></span><span style="display:flex;"><span>		pop eax
</span></span><span style="display:flex;"><span>		pop ebx
</span></span><span style="display:flex;"><span>		popfd
</span></span><span style="display:flex;"><span>		push ebx
</span></span><span style="display:flex;"><span>		push eax
</span></span><span style="display:flex;"><span>		retf
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">int</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;okokokokokokok&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：okokokokokokok</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
</ul>
<h4>任务段<span class="hx-absolute -hx-mt-20" id="任务段"></span>
    <a href="#%e4%bb%bb%e5%8a%a1%e6%ae%b5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>找出GDT表中所有的TSS段描述符</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 0040f300`00000fff
8003f040  0000f200`0400ffff 00000000`00000000
8003f050  80008955`27000068 80008955`27680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff
8003f080  80009240`0000ffff 00009200`00000000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>结尾为68，<code>8003f050</code>与<code>8003f058</code></p>
</li>
<li>
<p>实现任务切换</p>
<p>注：使用指令<code>!process 0 0</code>获取<code>Cr3</code>的值（对应调试程序的<code>Cr3</code>，比如<code>DirBase: 0aac0380</code>）</p>
<ul>
<li>
<p>门描述符为：<code>0000e900·00000068</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DWORD dwOK;
</span></span><span style="display:flex;"><span>DWORD dwESP;
</span></span><span style="display:flex;"><span>DWORD dwCS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">test</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    dwOK<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mov eax,esp;
</span></span><span style="display:flex;"><span>        mov dwESP,eax;
</span></span><span style="display:flex;"><span>        mov word ptr [dwCS],ax;
</span></span><span style="display:flex;"><span>        iretd;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> stack[<span style="color:#ae81ff">100</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};    <span style="color:#75715e">//自己构造一个堆栈使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD cr3<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    DWORD addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};    <span style="color:#75715e">//构造任务段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    DWORD tss[<span style="color:#ae81ff">0x68</span>]<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//cr3 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        (DWORD)addr,        <span style="color:#75715e">//eip *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//eflags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ((DWORD)stack) <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>,        <span style="color:#75715e">//esp *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//esi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x23</span>,        <span style="color:#75715e">//es *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x08</span>,        <span style="color:#75715e">//cs *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x10</span>,        <span style="color:#75715e">//ss *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x23</span>,        <span style="color:#75715e">//ds *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x30</span>,        <span style="color:#75715e">//fs *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//gs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//idt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x20ac0000</span>        <span style="color:#75715e">//IO权限位图，VISTA之后不再用了，从其他结构体拷贝出来。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Target:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>addr);
</span></span><span style="display:flex;"><span>    tss[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">=</span>addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;tss：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,tss);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;CR3:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>cr3);    <span style="color:#75715e">//看准了DirBase:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    tss[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">=</span>cr3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>buffer[<span style="color:#ae81ff">4</span>])<span style="color:#f92672">=</span><span style="color:#ae81ff">0x93</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        call fword ptr [buffer];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;dwESP=%x</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">dwCS=%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,dwESP,dwCS);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：dwESP=12ff80      dwCS=ff80</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
</ol>
<h4>任务门<span class="hx-absolute -hx-mt-20" id="任务门"></span>
    <a href="#%e4%bb%bb%e5%8a%a1%e9%97%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ol>
<li>
<p>自己实现一个任务门。</p>
<ul>
<li>
<p>门描述符为：<code>0000e900·00000068</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">test</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        iretd;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> stack[<span style="color:#ae81ff">100</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};    <span style="color:#75715e">//自己构造一个堆栈使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD cr3<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    DWORD addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DWORD tss[<span style="color:#ae81ff">0x68</span>]<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//cr3 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        (DWORD)addr,        <span style="color:#75715e">//eip *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//eflags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ((DWORD)stack) <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>,        <span style="color:#75715e">//esp *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//esi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x23</span>,        <span style="color:#75715e">//es *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x08</span>,        <span style="color:#75715e">//cs *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x10</span>,        <span style="color:#75715e">//ss *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x23</span>,        <span style="color:#75715e">//ds *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x30</span>,        <span style="color:#75715e">//fs *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//gs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//idt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x20ac0000</span>        <span style="color:#75715e">//IO权限位图，VISTA之后不再用了，从其他结构体拷贝出来。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Target:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>addr);
</span></span><span style="display:flex;"><span>    tss[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">=</span>addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;tss：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,tss);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;CR3:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>cr3);    <span style="color:#75715e">//看准了DirBase:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    tss[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">=</span>cr3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> <span style="color:#ae81ff">20</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span><span style="color:#75715e">//kd &gt; eq 8003f048 0000e912·ff140068 写入TSS段描述符到GDT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//kd &gt; eq 8003f500 0000e500·004b0000 写入任务门到 IDT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>成功执行🥲</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
<li>
<p>在保护模式中，当CPU检测到异常的时候，会根据异常的类型来查找对应的异常处理函数，比如：当指令检测到除零异常时，将默认执行0号中断，请列出处理除零异常函数的地址。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>80548e00`000831a0    address:0x805431a0</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">a0</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>             <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">a2</span> <span style="color:#ae81ff">66</span><span style="color:#66d9ef">c74424020000</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">word</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span>], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">a9</span> <span style="color:#ae81ff">55</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">aa</span> <span style="color:#ae81ff">53</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">ab</span> <span style="color:#ae81ff">56</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">ac</span> <span style="color:#ae81ff">57</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">ad</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">fa0</span>             <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">fs</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">af</span> <span style="color:#66d9ef">bb30000000</span>       <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#ae81ff">30</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">b4</span> <span style="color:#ae81ff">668</span><span style="color:#66d9ef">ee3</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">fs</span>, <span style="color:#66d9ef">bx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">b7</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">b1d00000000</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">be</span> <span style="color:#ae81ff">53</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">bf</span> <span style="color:#ae81ff">83</span><span style="color:#66d9ef">ec04</span>           <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c2</span> <span style="color:#ae81ff">50</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c3</span> <span style="color:#ae81ff">51</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c4</span> <span style="color:#ae81ff">52</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c5</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">e</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ds</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c6</span> <span style="color:#ae81ff">06</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">es</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c7</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">fa8</span>             <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">gs</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">c9</span> <span style="color:#ae81ff">66</span><span style="color:#66d9ef">b82300</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ax</span>, <span style="color:#ae81ff">23</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">cd</span> <span style="color:#ae81ff">83</span><span style="color:#66d9ef">ec30</span>           <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">30</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">d0</span> <span style="color:#ae81ff">668</span><span style="color:#66d9ef">ed8</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ds</span>, <span style="color:#66d9ef">ax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">d3</span> <span style="color:#ae81ff">668</span><span style="color:#66d9ef">ec0</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">es</span>, <span style="color:#66d9ef">ax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">d6</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bec</span>             <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">d8</span> <span style="color:#66d9ef">f744247000000200</span> <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">70</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">20000</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">e0</span> <span style="color:#ae81ff">7596</span>             <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">V86_kit0_a</span> (<span style="color:#ae81ff">80543178</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">e2</span> <span style="color:#66d9ef">fc</span>               <span style="color:#66d9ef">cld</span>     
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">e3</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b5d60</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">60</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">e6</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b7d68</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">e9</span> <span style="color:#ae81ff">89550</span><span style="color:#66d9ef">c</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span>], <span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">ec</span> <span style="color:#66d9ef">c74508000ddbba</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">BADB0D00h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">f3</span> <span style="color:#ae81ff">895</span><span style="color:#66d9ef">d00</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span>], <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">f6</span> <span style="color:#ae81ff">897</span><span style="color:#66d9ef">d04</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>], <span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">805431</span><span style="color:#66d9ef">f9</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">f60550000000ff</span> <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">50</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543201</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f85edfeffff</span>     <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">Dr_kit0_a</span> (<span style="color:#ae81ff">805430</span><span style="color:#66d9ef">f4</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543207</span> <span style="color:#66d9ef">f7457000000200</span>   <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">70</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">20000</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054320</span><span style="color:#66d9ef">e</span> <span style="color:#ae81ff">753</span><span style="color:#66d9ef">d</span>             <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_KiTrap00</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xad</span> (<span style="color:#ae81ff">8054324</span><span style="color:#66d9ef">d</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543210</span> <span style="color:#66d9ef">f6456c01</span>         <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">6</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543214</span> <span style="color:#ae81ff">7407</span>             <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_KiTrap00</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x7d</span> (<span style="color:#ae81ff">8054321</span><span style="color:#66d9ef">d</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543216</span> <span style="color:#ae81ff">66837</span><span style="color:#66d9ef">d6c1b</span>       <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">word</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">6</span><span style="color:#66d9ef">Ch</span>], <span style="color:#ae81ff">1</span><span style="color:#66d9ef">Bh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054321</span><span style="color:#66d9ef">b</span> <span style="color:#ae81ff">751</span><span style="color:#66d9ef">d</span>             <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_KiTrap00</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x9a</span> (<span style="color:#ae81ff">8054323</span><span style="color:#66d9ef">a</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054321</span><span style="color:#66d9ef">d</span> <span style="color:#66d9ef">fb</span>               <span style="color:#66d9ef">sti</span>     
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054321</span><span style="color:#66d9ef">e</span> <span style="color:#ae81ff">55</span>               <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054321</span><span style="color:#66d9ef">f</span> <span style="color:#66d9ef">e87c040600</span>       <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_Ki386CheckDivideByZeroTrap@4</span> (<span style="color:#ae81ff">805</span><span style="color:#66d9ef">a36a0</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543224</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b5d68</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543227</span> <span style="color:#66d9ef">e9ebfdffff</span>       <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">Kei386EoiHelper@0</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x16b</span> (<span style="color:#ae81ff">80543017</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054322</span><span style="color:#66d9ef">c</span> <span style="color:#66d9ef">fb</span>               <span style="color:#66d9ef">sti</span>     
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054322</span><span style="color:#66d9ef">d</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b5d68</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543230</span> <span style="color:#66d9ef">b8940000c0</span>       <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">0</span><span style="color:#66d9ef">C0000094h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543235</span> <span style="color:#66d9ef">e9ddfdffff</span>       <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">Kei386EoiHelper@0</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x16b</span> (<span style="color:#ae81ff">80543017</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054323</span><span style="color:#66d9ef">a</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">b1d24010000</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">124</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543241</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b5b44</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543244</span> <span style="color:#ae81ff">83</span><span style="color:#66d9ef">bb5801000000</span>   <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">158</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054324</span><span style="color:#66d9ef">b</span> <span style="color:#ae81ff">74</span><span style="color:#66d9ef">df</span>             <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_KiTrap00</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x8c</span> (<span style="color:#ae81ff">8054322</span><span style="color:#66d9ef">c</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054324</span><span style="color:#66d9ef">d</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>             <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054324</span><span style="color:#66d9ef">f</span> <span style="color:#66d9ef">e8a42c0000</span>       <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_Ki386VdmReflectException_A@4</span> (<span style="color:#ae81ff">80545</span><span style="color:#66d9ef">ef8</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543254</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">ac0</span>             <span style="color:#66d9ef">or</span>      <span style="color:#66d9ef">al</span>, <span style="color:#66d9ef">al</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543256</span> <span style="color:#ae81ff">74</span><span style="color:#66d9ef">d4</span>             <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">_KiTrap00</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x8c</span> (<span style="color:#ae81ff">8054322</span><span style="color:#66d9ef">c</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543258</span> <span style="color:#66d9ef">e94ffcffff</span>       <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">Kei386EoiHelper@0</span> (<span style="color:#ae81ff">80542</span><span style="color:#66d9ef">eac</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054325</span><span style="color:#66d9ef">d</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">d4900</span>           <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">ecx</span>, [<span style="color:#66d9ef">ecx</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543260</span> <span style="color:#66d9ef">c74568c8245480</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">68</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">805424</span><span style="color:#66d9ef">C8h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">80543267</span> <span style="color:#ae81ff">806571</span><span style="color:#66d9ef">fe</span>         <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">71</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FEh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">8054326</span><span style="color:#66d9ef">b</span> <span style="color:#66d9ef">e93cfcffff</span>       <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrpamp</span>!<span style="color:#66d9ef">Kei386EoiHelper@0</span> (<span style="color:#ae81ff">80542</span><span style="color:#66d9ef">eac</span>)</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>在保护模式中，当CPU检测到异常的时候，会根据异常的类型来查找对应的异常处理函数，比如:当指令检测到除零异常时，将默认执行0号中断所指定的异常处理程序,但是,异常处理程序本身任然可能出现异常,如果异常处理程序出现异常时候（双重错误） ,CPU会默认执行8号中断，请分析8号中断是什么？做了什么事情？替换了哪些寄存器？替换后的值是多少？为什么这样设计？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>00008500`00501198    
50 = 0101 0  000
index = 10
门如下：
80008955`87000068    address=80558700
kd&gt; dd 80558700
ReadVirtual: 80558700 not properly sign extended
80558700  00000000 80555700 00000010 00000000
80558710  00000000 00000000 00000000 00039000
80558720  804e0891 00000000 00000000 00000000
80558730  00000000 00000000 80555700 00000000
80558740  00000000 00000000 00000023 00000008
80558750  00000010 00000023 00000030 00000000
80558760  00000000 20ac0000 00000028 80555700
80558770  00000010 00000000 00000000 00000000
可以看到，改了ESP0 = 80555700，SS0 = 10，EIP = 804e0891，ESP = 80555700，ES = 23，CS = 8，SS = 10，DS = 23，FS = 30
将eip放到反汇编窗口可以看到如下:
nt!KiTrap08:
ffffffff`804e0891 fa             cli     
ffffffff`804e0892 648b0d3c000000 mov     ecx, dword ptr fs:[3Ch]
……
这就是8号中断的执行的位置</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ol>
<h4>考试<span class="hx-absolute -hx-mt-20" id="考试"></span>
    <a href="#%e8%80%83%e8%af%95" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>将某一代码片运行到1环</p>
<ul>
<li>
<p>门描述符为：<code>0000e900·00000068</code></p>
</li>
<li>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//eq 8003f0d8 0040E912`FD6C0068    ;TSS描述符 D9，注意正确
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//eq 8003f0b0 00CFBB00`0000FFFF    ;cs:B1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//eq 8003f0b8 00CFB300`0000FFFF    ;ss:B9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">//eq 8003f0c0 FFC0B3DF`F0000001    ;fs:C1，这个东西是关键，运气不好容易因线程切换蓝屏
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>DWORD dwOK;
</span></span><span style="display:flex;"><span>DWORD dwESP;
</span></span><span style="display:flex;"><span>DWORD dwCS;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">test</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mov eax,esp;
</span></span><span style="display:flex;"><span>        mov dwESP,eax;
</span></span><span style="display:flex;"><span>        mov word ptr [dwCS],cs;
</span></span><span style="display:flex;"><span>        iretd;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc,<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> stack[<span style="color:#ae81ff">100</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};    <span style="color:#75715e">//自己构造一个堆栈使用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD cr3<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    DWORD addr<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buffer[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};    <span style="color:#75715e">//构造任务段
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    DWORD tss[<span style="color:#ae81ff">0x68</span>]<span style="color:#f92672">=</span>{
</span></span><span style="display:flex;"><span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//link
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//esp2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x0</span>,        <span style="color:#75715e">//ss2
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//cr3 *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        (DWORD)addr,        <span style="color:#75715e">//eip *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//eflags
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//edx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ebx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        ((DWORD)stack) <span style="color:#f92672">+</span> <span style="color:#ae81ff">100</span>,        <span style="color:#75715e">//esp *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//ebp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//esi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//edi
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x23</span>,        <span style="color:#75715e">//es *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0xB1</span>,        <span style="color:#75715e">//cs *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0xB9</span>,        <span style="color:#75715e">//ss *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x23</span>,        <span style="color:#75715e">//ds *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0xC1</span>,        <span style="color:#75715e">//fs *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//gs
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0</span>,        <span style="color:#75715e">//idt
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#ae81ff">0x20ac0000</span>        <span style="color:#75715e">//IO权限位图，VISTA之后不再用了，从其他结构体拷贝出来。
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        };
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Target:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>addr);
</span></span><span style="display:flex;"><span>    tss[<span style="color:#ae81ff">8</span>]<span style="color:#f92672">=</span>addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;tss：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,tss);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;CR3:</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">scanf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>cr3);    <span style="color:#75715e">//看准了DirBase:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    tss[<span style="color:#ae81ff">7</span>]<span style="color:#f92672">=</span>cr3;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)(<span style="color:#f92672">&amp;</span>buffer[<span style="color:#ae81ff">4</span>])<span style="color:#f92672">=</span><span style="color:#ae81ff">0xDB</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        call fword ptr [buffer];
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;dwESP=%x</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">dwCS=%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,dwESP,dwCS);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">system</span>(<span style="color:#e6db74">&#34;pause&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
</li>
</ul>
<h4>10-10-12分页<span class="hx-absolute -hx-mt-20" id="10-10-12分页"></span>
    <a href="#10-10-12%e5%88%86%e9%a1%b5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>找物理地址</p>
<ol>
<li>
<p>使用ce查找记事本进程中的字符串，修改记事本中的字符串以找到真正的字符串的地址。</p>
</li>
<li>
<p>先将这个地址进行10-10-12分页（比如我的地址是：000AB3A0）</p>
<ul>
<li>
<p>转成二进制：0000 0000 00|00 1010 1011 3A0</p>
</li>
<li>
<p>那么这两组的值为：0，AB 加上后面的 3A0</p>
</li>
<li>
<p>将第二组值×4：0，AB*4，3A0</p>
<p>这三组就是三个页的<code>offset</code></p>
</li>
</ul>
</li>
<li>
<p>在<code>windbg</code>中使用指令<code>！process 0 0</code>，查看notepad的<code>Cr3</code>，就是那个<code>DirBase</code>的值</p>
</li>
<li>
<p>使用指令<code>！dd [地址]</code> 读取线性地址，这个地址就是<code>Cr3</code>的值加上第一个<code>offset</code>，找到的是第二个页的地址（后三位067改为0才是地址，067是属性），第二个页的地址加上第二个<code>offset</code>，找到的是物理页的地址（后三位067改为0才是地址），物理页的地址加上第三个<code>offset</code>，找到的就是字符串的物理地址。</p>
</li>
</ol>
</li>
<li>
<p>创建两个进程，申请一个相同的内存地址，比如: 0x401234，并存储不同的内容，分别找到这2个进程相对应的物理地址，看内容是什么？说说你的理解</p>
</li>
</ul>
<h4>PDE_PTE<span class="hx-absolute -hx-mt-20" id="pde_pte"></span>
    <a href="#pde_pte" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>线性地址0为什么不能访问？将0地址设置为可读可写。</p>
<p>比如我观察一个进程的<code>Cr3</code>，<code>PDT</code>与<code>PTT</code>，如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">89</span><span style="color:#66d9ef">c25be0</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">0674</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffd9000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">05</span><span style="color:#66d9ef">c4</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">1</span><span style="color:#a6e22e">cd3e000</span>  <span style="color:#66d9ef">ObjectTable</span>: <span style="color:#66d9ef">e2848690</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">50</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#a6e22e">notepad.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">cd3e000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e000 1cdb0867 1d261867 1cfb1867 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e010 1cfe3867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e040 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cd3e070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">1</span><span style="color:#66d9ef">cdb0000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0000 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0010 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0040 1ce71867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#1cdb0060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#1</span><span style="color:#a6e22e">cdb0070</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p><img src="https://c65mael.github.io/myassets/pdeptejg.png" alt="image" loading="lazy" /></p>
<p>可以看到，进程中线性地址0的<code>PTT</code>为0，也就是<code>PTE</code>中的<code>P</code>位为0，表示<code>PTE</code>无效，所以不能被访问，但是<code>PDE</code>是有效的，所以可以重新改一个有效的<code>PTE</code>就可以访问了吧。</p>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> x<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>x);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//向0地址写入数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">123</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x地址数据:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>过程如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0012ff7c
0000 0000 0001 0010 1111 f7c
1：0
2：4BC
3：f7c</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">VadRoot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">89</span><span style="color:#66d9ef">b9f558</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">05</span><span style="color:#66d9ef">b8</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffdd000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">0180</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">27943000</span>  ObjectTable: <span style="color:#a6e22e">e1085490</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">12</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#960050;background-color:#1e0010">111</span><span style="color:#a6e22e">.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">27943000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#27943000 27872867 27971867 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943010 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943040 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27943070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">27872000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#27872000 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872010 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872040 279f3867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#27872070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">27872000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span><span style="color:#66d9ef">BC</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#278724bc 27877867 16360025 16361025 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#278724cc 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#278724dc 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#278724ec 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#278724fc 00000000 279fb867 27abc867 27c7d867
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2787250c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2787251c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2787252c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">27872000</span> <span style="color:#ae81ff">27877867</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>输出结果：x地址数据:7b</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>为变量x再映射一个线性地址，并通过这个新的地址读取x的值。</p>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> x<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> y[<span style="color:#ae81ff">1024</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>x);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;y：%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>y);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;x地址数据:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,x);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>x:0012ff7c
0000 0000 0001 0010 1111 f7c
1：0
2：4BC
3：f7c</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>y:0012ef7c
0000 0000 0001 0010 1110 f7c
1：0
2：4B8
3：f7c</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>将x的<code>PDE</code>改为y的，过程如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">VadRoot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">89</span><span style="color:#66d9ef">c1d7e8</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">052</span><span style="color:#66d9ef">c</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffd3000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">079</span><span style="color:#66d9ef">c</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">20</span><span style="color:#a6e22e">ff4000</span>  <span style="color:#66d9ef">ObjectTable</span>: <span style="color:#66d9ef">e28b0ad8</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">12</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#960050;background-color:#1e0010">111</span><span style="color:#a6e22e">.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">20</span><span style="color:#66d9ef">ff4000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4000 20e5d867 20d9c867 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4010 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4040 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20ff4070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">20</span><span style="color:#66d9ef">e5d000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span><span style="color:#66d9ef">b8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d4b8 210c8867 20ffb867 163df025 16420025
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d4c8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d4d8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d4e8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d4f8 00000000 00000000 20dff867 21300867
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d508 20f81867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d518 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#20e5d528 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">20</span><span style="color:#66d9ef">e5d4bc</span> <span style="color:#ae81ff">210</span><span style="color:#66d9ef">c8867</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>但是不知道为什么，修改完，执行后会蓝屏＞︿＜</p>
</li>
<li>
<p>10-10-12分页模式物理内存能够识别的最多范围是多少?</p>
<p>1024 *1024 *4096 ==一共4GB</p>
</li>
<li>
<p>如何判断2个线性地址是否在同一个物理页？</p>
<p>物理地址除了最后三位以外其他的位数都相等，就是同一物理页</p>
</li>
</ul>
<h4>PDE_PTE属性<span class="hx-absolute -hx-mt-20" id="pde_pte属性"></span>
    <a href="#pde_pte%e5%b1%9e%e6%80%a7" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>在VC6中定义一个字符串常量 通过另外一个线性地址修改这个常量的值</li>
</ul>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> a<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;c65mael&#34;</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argu[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,a); 
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	a[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;a&#39;</span>; 
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%s&#34;</span>,a);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>a:0042201c
0000 0000 0100 0010 0010 01c
1：1*4
2：22*4
3：01c</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>过程如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">VadRoot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">89</span><span style="color:#66d9ef">e63020</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">0520</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffd9000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">07</span><span style="color:#66d9ef">cc</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">2</span><span style="color:#a6e22e">ff55000</span>  <span style="color:#66d9ef">ObjectTable</span>: <span style="color:#66d9ef">e1babc00</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">12</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#960050;background-color:#1e0010">111</span><span style="color:#a6e22e">.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">ff55000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55004 2ffd9867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55014 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55024 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55034 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55044 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55054 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55064 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ff55074 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">ffd9000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">88</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd9088 30085025 00000000 301d2867 30488225
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd9098 00000000 3024b867 3040d867 30413867
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd90a8 303f2825 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd90b8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd90c8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd90d8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd90e8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2ffd90f8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">ffd9088</span> <span style="color:#ae81ff">30085027</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>
<p>修改0x8003F00C这个地址的PDE PTE属性使之可以在3环访问</p>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdlib.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argu[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> x<span style="color:#f92672">=</span><span style="color:#ae81ff">0x8003F00C</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)a); 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>8003F00C
1000 0000 0000 0011 1111 00c
1：200*4
2：3f*4
3：00c</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>过程如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">VadRoot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">897</span><span style="color:#66d9ef">b1518</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">032</span><span style="color:#66d9ef">c</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffd9000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">02</span><span style="color:#66d9ef">dc</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">227</span><span style="color:#a6e22e">cc000</span>  <span style="color:#66d9ef">ObjectTable</span>: <span style="color:#66d9ef">e28a8448</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">12</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#960050;background-color:#1e0010">111</span><span style="color:#a6e22e">.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">227</span><span style="color:#66d9ef">cc000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">800</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc800 0003b163 004009e3 0003e163 0003c163
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc810 010009e3 014009e3 018009e3 01c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc820 020009e3 024009e3 028009e3 02c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc830 030009e3 034009e3 038009e3 03c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc840 040009e3 044009e3 048009e3 04c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc850 050009e3 054009e3 058009e3 05c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc860 060009e3 064009e3 068009e3 06c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#227cc870 070009e3 074009e3 078009e3 07c009e3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">227</span><span style="color:#66d9ef">cc800</span> <span style="color:#ae81ff">0003</span><span style="color:#66d9ef">b167</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">0003</span><span style="color:#66d9ef">b0fc</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b0fc 0003f167 00040103 00041103 00042163
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b10c 00043163 00044163 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b11c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b12c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b13c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b14c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b15c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#   3b16c 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">3</span><span style="color:#66d9ef">b0fc</span> <span style="color:#ae81ff">0003</span><span style="color:#66d9ef">f867</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>思考题：一个线性地址如果可以访问，一定要填上正确的PDE和PTE，但PDE与PTE是物理地址，如果我们想填充，那又必须要通过线性地址才能去访问，谁为访问PDE与PTE的线性地址填充争取的PDE与PTE呢?</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>CPU通过“页表”来找到内存中的数据，而“页表”本身也放在内存里。你想访问页表时，也得先通过页表来找到页表的位置。这听起来像是“先有鸡还是先有蛋”的问题。
实际上，系统有个聪明的办法：它把“页表”自己也放到它管理的地址里面！就好像给“页表”留了一面镜子，这样你就可以通过这个镜子（一个特殊的地址）看到并访问页表本身。这样，CPU就可以通过这个自带的“镜子”来先找到页表，然后再去管理其他的内存数据。
所以，是操作系统给页表设置了一个特殊的“镜子”地址，这样即使你要找页表，它也能让你找到。
PDT:0xc0300000</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>创建2个进程，以页为代码拆分0-4G线性地址</p>
<p>结果：</p>
<ol>
<li>低2G（<code>0-7FFFFFFF</code>）几乎不同</li>
<li>高2G（<code>80000000-FFFFFFFF</code>）几乎相同</li>
<li><code>0-7FFFFFFF</code>的前<code>64K</code>和后<code>64k</code>都是没有映射的</li>
</ol>
</li>
</ul>
<h4>PDT_PTT基址<span class="hx-absolute -hx-mt-20" id="pdt_ptt基址"></span>
    <a href="#pdt_ptt%e5%9f%ba%e5%9d%80" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><p>逆向分析<code>MmIsAddressValid</code>函数</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f46</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bff</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>,<span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f48</span> <span style="color:#ae81ff">55</span>              <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebp</span>    <span style="color:#75715e">;保护现场
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f49</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bec</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebp</span>,<span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f4b</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b4d08</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]    <span style="color:#75715e">;取一个栈上的值做参数(VirtualAddress)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f4e</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bc1</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">ecx</span>    <span style="color:#75715e">;eax=VirtualAddress
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f50</span> <span style="color:#66d9ef">c1e814</span>          <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">14</span><span style="color:#66d9ef">h</span>    <span style="color:#75715e">;eax右移20位，保留高12位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f53</span> <span style="color:#66d9ef">bafc0f0000</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>,<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFCh</span>    <span style="color:#75715e">;edx=0xffc(1111 1111 1100)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f58</span> <span style="color:#ae81ff">23</span><span style="color:#66d9ef">c2</span>            <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">edx</span>    <span style="color:#75715e">;不要低两位，也就是第一个10
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f5a</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">d0000d03f</span>      <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">eax</span>,-<span style="color:#ae81ff">0</span><span style="color:#66d9ef">C0300000h</span>    <span style="color:#75715e">;eax+0xC0300000，页目录表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f5f</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b00</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span>]    <span style="color:#75715e">;取eax地址的值。也就是PDE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f61</span> <span style="color:#66d9ef">a801</span>            <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">al</span>,<span style="color:#ae81ff">1</span>    <span style="color:#75715e">;判断p位是否为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f63</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f844e3e0100</span>    <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x4f</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">f6db7</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f69</span> <span style="color:#ae81ff">84</span><span style="color:#66d9ef">c0</span>            <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">al</span>,<span style="color:#66d9ef">al</span>    <span style="color:#75715e">;判断ps位,是否为大页(因为第7位为1时会被认为负数)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f6b</span> <span style="color:#ae81ff">7824</span>            <span style="color:#66d9ef">js</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x53</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">e2f91</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f6d</span> <span style="color:#66d9ef">c1e90a</span>          <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ah</span>    <span style="color:#75715e">;ecx右移10位,保留高20位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f70</span> <span style="color:#ae81ff">81</span><span style="color:#66d9ef">e1fcff3f00</span>    <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#ae81ff">3</span><span style="color:#66d9ef">FFFFCh</span>    <span style="color:#75715e">;去高两位与低两位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f76</span> <span style="color:#ae81ff">81</span><span style="color:#66d9ef">e900000040</span>    <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">ecx</span>,-<span style="color:#ae81ff">0</span><span style="color:#66d9ef">C0000000h</span>    <span style="color:#75715e">;eax+0xC0000000，页表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f7c</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bc1</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f7e</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b08</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span>]    <span style="color:#75715e">;取eax地址的值。也就是PTE
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f80</span> <span style="color:#66d9ef">f6c101</span>          <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">cl</span>,<span style="color:#ae81ff">1</span>    <span style="color:#75715e">;判断p位是否为1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f83</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f842e3e0100</span>    <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x4f</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">f6db7</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f89</span> <span style="color:#ae81ff">84</span><span style="color:#66d9ef">c9</span>            <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">cl</span>,<span style="color:#66d9ef">cl</span>    <span style="color:#75715e">;判断PAT位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f8b</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">f88d5410400</span>    <span style="color:#66d9ef">js</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x3f</span> (<span style="color:#ae81ff">80527166</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f91</span> <span style="color:#66d9ef">b001</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">al</span>,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f93</span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">d</span>              <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">804</span><span style="color:#a6e22e">e2f94</span> <span style="color:#66d9ef">c20400</span>          <span style="color:#66d9ef">ret</span>     <span style="color:#ae81ff">4</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h4>2-9-9-12分页<span class="hx-absolute -hx-mt-20" id="2-9-9-12分页"></span>
    <a href="#2-9-9-12%e5%88%86%e9%a1%b5" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>在2-9-9-12分页模式下进行线性地址到物理地址的转换</p>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argu[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> a<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>a);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,a);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0x0012ff7c
0000 0000 00|01 0010 1111 f7c
1:0
2:12f*8（一定注意）
3:f7c</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>过程如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">VadRoot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a316be0</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">017</span><span style="color:#66d9ef">c</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffda000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">0584</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">aac0380</span>  <span style="color:#66d9ef">ObjectTable</span>: <span style="color:#66d9ef">e272aec0</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">12</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#960050;background-color:#1e0010">111</span><span style="color:#a6e22e">.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">aac0380</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aac0380 225ad801 00000000 226ee801 00000000（这个就是PDPTE，不是只有4个吗？）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac0390 227af801 00000000 2236c801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03a0 bae713c0 00000000 21da9801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03b0 21bea801 00000000 21ca7801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03c0 bae713e0 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03d0 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03e0 bae71400 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03f0 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">225</span><span style="color:#66d9ef">ad000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad000 22471867 00000000 227d4867 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad010 225f0867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad040 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#225ad070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">22471000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">12</span><span style="color:#66d9ef">f</span>*<span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#22471978 2270d867 80000000 16fff025 80000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#22471988 17400025 80000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#22471998 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#224719a8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#224719b8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#224719c8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#224719d8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#224719e8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">2270</span><span style="color:#66d9ef">d000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">f7c</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#2270df7c 0000000a 0012ffc0 00401299 00000001
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270df8c 00380d60 00380df8 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270df9c 7ffda000 00000001 00000001 0012ff94
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfac b13f8d08 0012ffe0 00404440 00423130
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfbc 00000000 0012fff0 7c817067 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfcc 00000000 7ffda000 8054c6ed 0012ffc8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfdc 8a162980 ffffffff 7c839ac0 7c817070
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfec 00000000 00000000 00000000 004011b0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">2270</span><span style="color:#66d9ef">df7c</span> <span style="color:#ae81ff">9</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">2270</span><span style="color:#66d9ef">d000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">f7c</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#2270df7c 00000009 0012ffc0 00401299 00000001
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270df8c 00380d60 00380df8 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270df9c 7ffda000 00000001 00000001 0012ff94
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfac b13f8d08 0012ffe0 00404440 00423130
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfbc 00000000 0012fff0 7c817067 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfcc 00000000 7ffda000 8054c6ed 0012ffc8
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#2270dfdc 8a162980 ffffffff 7c839ac0 7c817070
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">#2270</span><span style="color:#a6e22e">dfec</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">00000000</span> <span style="color:#ae81ff">004011</span><span style="color:#66d9ef">b0</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>给0线性地址挂上物理页。</p>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;Windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argu[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> <span style="color:#f92672">*</span>a<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">int</span> b <span style="color:#f92672">=</span> <span style="color:#ae81ff">8888</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">&amp;</span>b);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,<span style="color:#f92672">*</span>a);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>0x12ff78
0000 0000 0001 0010 1111 f78
1:0
2:12f*8
3:f78</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>过程如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#a6e22e">Failed</span> <span style="color:#66d9ef">to</span> <span style="color:#66d9ef">get</span> <span style="color:#66d9ef">VadRoot</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">PROCESS</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a3f68d8</span>  <span style="color:#66d9ef">SessionId</span>: <span style="color:#ae81ff">0</span>  <span style="color:#66d9ef">Cid</span>: <span style="color:#ae81ff">0210</span>    <span style="color:#66d9ef">Peb</span>: <span style="color:#ae81ff">7</span><span style="color:#66d9ef">ffd3000</span>  <span style="color:#66d9ef">ParentCid</span>: <span style="color:#ae81ff">06</span><span style="color:#66d9ef">fc</span>
</span></span><span style="display:flex;"><span>    DirBase: <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">aac03a0</span>  <span style="color:#66d9ef">ObjectTable</span>: <span style="color:#66d9ef">e1396468</span>  <span style="color:#66d9ef">HandleCount</span>:  <span style="color:#ae81ff">12</span>.
</span></span><span style="display:flex;"><span>    Image: <span style="color:#960050;background-color:#1e0010">111</span><span style="color:#a6e22e">.exe</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">aac03a0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03a0 3071b801 00000000 3095c801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03b0 3075d801 00000000 3085a801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03c0 bae713e0 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03d0 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03e0 bae71400 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03f0 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac0400 bae71420 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac0410 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">3071</span><span style="color:#66d9ef">b000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b000 3079d867 00000000 30a69867 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b010 3099c867 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b040 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3071b070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">3079</span><span style="color:#66d9ef">d000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">12</span><span style="color:#66d9ef">f</span>*<span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d978 307e2867 80000000 16cae025 80000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d988 16caf025 80000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d998 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d9a8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d9b8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d9c8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d9d8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d9e8 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">307</span><span style="color:#66d9ef">e2000</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">f78</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2f78 000022b8 00000000 0012ffc0 004012a9
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2f88 00000001 00380d60 00380df8 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2f98 00000000 7ffd3000 00000001 00000001
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2fa8 0012ff94 b1de6d08 0012ffe0 00404450
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2fb8 00423130 00000000 0012fff0 7c817067
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2fc8 00000000 00000000 7ffd3000 8054c6ed
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2fd8 0012ffc8 8a402da8 ffffffff 7c839ac0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#307e2fe8 7c817070 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">aac03a0</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03a0 3071b801 00000000 3095c801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03b0 3075d801 00000000 3085a801 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03c0 bae713e0 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03d0 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03e0 bae71400 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac03f0 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac0400 bae71420 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"># aac0410 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">dd</span> <span style="color:#ae81ff">3079</span><span style="color:#66d9ef">d000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d000 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d010 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d020 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d030 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d040 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d050 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d060 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#3079d070 00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">kd</span><span style="color:#960050;background-color:#1e0010">&gt;</span> !<span style="color:#66d9ef">ed</span> <span style="color:#ae81ff">3079</span><span style="color:#66d9ef">d000</span> <span style="color:#ae81ff">307</span><span style="color:#66d9ef">e2867</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>逆向分析MmisAddressValid函数，找到PAE分页模式下页目录表、页表基址。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514928</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">bff</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>,<span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051492</span><span style="color:#a6e22e">a</span> <span style="color:#ae81ff">55</span>              <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051492</span><span style="color:#a6e22e">b</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bec</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebp</span>,<span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051492</span><span style="color:#a6e22e">d</span> <span style="color:#ae81ff">51</span>              <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051492</span><span style="color:#a6e22e">e</span> <span style="color:#ae81ff">51</span>              <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051492</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b4d08</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">8</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514932</span> <span style="color:#960050;background-color:#1e0010">56</span>              <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514933</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">bc1</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514935</span> <span style="color:#a6e22e">c1e812</span>          <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">12</span><span style="color:#66d9ef">h</span>    <span style="color:#75715e">#右移18位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514938</span> <span style="color:#a6e22e">bef83f0000</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">esi</span>,<span style="color:#ae81ff">3</span><span style="color:#66d9ef">FF8h</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051493</span><span style="color:#a6e22e">d</span> <span style="color:#ae81ff">23</span><span style="color:#66d9ef">c6</span>            <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">esi</span>    <span style="color:#75715e">#进行与运算，0011 1111 1111 1000 剩11位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">8051493</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">2</span><span style="color:#66d9ef">d0000a03f</span>      <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">3</span><span style="color:#66d9ef">FA00000h</span>    <span style="color:#75715e">#eax+0xC0600000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514944</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">b10</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span>]    <span style="color:#75715e">#取PDE低四字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514946</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">b4004</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>]    <span style="color:#75715e">#取PDE高四字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514949</span> <span style="color:#960050;background-color:#1e0010">8945</span><span style="color:#a6e22e">fc</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp-4</span>],<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051494</span><span style="color:#a6e22e">c</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bc2</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051494</span><span style="color:#a6e22e">e</span> <span style="color:#ae81ff">57</span>              <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051494</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">83</span><span style="color:#66d9ef">e001</span>          <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514952</span> <span style="color:#960050;background-color:#1e0010">33</span><span style="color:#a6e22e">ff</span>            <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">edi</span>,<span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514954</span> <span style="color:#960050;background-color:#1e0010">0</span><span style="color:#a6e22e">bc7</span>            <span style="color:#66d9ef">or</span>      <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514956</span> <span style="color:#960050;background-color:#1e0010">7461</span>            <span style="color:#a6e22e">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x91</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">b9</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514958</span> <span style="color:#a6e22e">bf80000000</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>,<span style="color:#ae81ff">80</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051495</span><span style="color:#a6e22e">d</span> <span style="color:#ae81ff">23</span><span style="color:#66d9ef">d7</span>            <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">edx</span>,<span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051495</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>            <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514961</span> <span style="color:#960050;background-color:#1e0010">8955</span><span style="color:#a6e22e">f8</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp-8</span>],<span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514964</span> <span style="color:#960050;background-color:#1e0010">58</span>              <span style="color:#a6e22e">pop</span>     <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514965</span> <span style="color:#960050;background-color:#1e0010">7404</span>            <span style="color:#a6e22e">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x43</span> (<span style="color:#ae81ff">8051496</span><span style="color:#66d9ef">b</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514967</span> <span style="color:#960050;background-color:#1e0010">85</span><span style="color:#a6e22e">c0</span>            <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514969</span> <span style="color:#960050;background-color:#1e0010">7452</span>            <span style="color:#a6e22e">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x95</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">bd</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051496</span><span style="color:#a6e22e">b</span> <span style="color:#66d9ef">c1e909</span>          <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#ae81ff">9</span>    <span style="color:#75715e">#右移9位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">8051496</span><span style="color:#a6e22e">e</span> <span style="color:#ae81ff">81</span><span style="color:#66d9ef">e1f8ff7f00</span>    <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#ae81ff">7</span><span style="color:#66d9ef">FFFF8h</span>    <span style="color:#75715e">#进行与运算，0111 1111 1111 1111 1111 1000 剩20位
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514974</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">b81040000c0</span>    <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ecx-3FFFFFFCh</span>]    <span style="color:#75715e">#mov eax, [ecx+0xC0000004]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">8051497</span><span style="color:#a6e22e">a</span> <span style="color:#ae81ff">81</span><span style="color:#66d9ef">e900000040</span>    <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#ae81ff">40000000</span><span style="color:#66d9ef">h</span>    <span style="color:#75715e">#ecx+0xC0000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514980</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">b11</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ecx</span>]    <span style="color:#75715e">#取PTE低四字节
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514982</span> <span style="color:#960050;background-color:#1e0010">8945</span><span style="color:#a6e22e">fc</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp-4</span>],<span style="color:#66d9ef">eax</span>    <span style="color:#75715e">#高4位在栈上
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#960050;background-color:#1e0010">80514985</span> <span style="color:#960050;background-color:#1e0010">53</span>              <span style="color:#a6e22e">push</span>    <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514986</span> <span style="color:#960050;background-color:#1e0010">8</span><span style="color:#a6e22e">bc2</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514988</span> <span style="color:#960050;background-color:#1e0010">33</span><span style="color:#a6e22e">db</span>            <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">ebx</span>,<span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051498</span><span style="color:#a6e22e">a</span> <span style="color:#ae81ff">83</span><span style="color:#66d9ef">e001</span>          <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051498</span><span style="color:#a6e22e">d</span> <span style="color:#ae81ff">0</span><span style="color:#66d9ef">bc3</span>            <span style="color:#66d9ef">or</span>      <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051498</span><span style="color:#a6e22e">f</span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">b</span>              <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514990</span> <span style="color:#960050;background-color:#1e0010">7427</span>            <span style="color:#a6e22e">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x91</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">b9</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514992</span> <span style="color:#960050;background-color:#1e0010">23</span><span style="color:#a6e22e">d7</span>            <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">edx</span>,<span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514994</span> <span style="color:#960050;background-color:#1e0010">6</span><span style="color:#a6e22e">a00</span>            <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514996</span> <span style="color:#960050;background-color:#1e0010">8955</span><span style="color:#a6e22e">f8</span>          <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ebp-8</span>],<span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">80514999</span> <span style="color:#960050;background-color:#1e0010">58</span>              <span style="color:#a6e22e">pop</span>     <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051499</span><span style="color:#a6e22e">a</span> <span style="color:#ae81ff">7421</span>            <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x95</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">bd</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051499</span><span style="color:#a6e22e">c</span> <span style="color:#ae81ff">85</span><span style="color:#66d9ef">c0</span>            <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">eax</span>,<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">8051499</span><span style="color:#a6e22e">e</span> <span style="color:#ae81ff">751</span><span style="color:#66d9ef">d</span>            <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x95</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">bd</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">a0</span> <span style="color:#ae81ff">23</span><span style="color:#66d9ef">ce</span>            <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">a2</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b89000060c0</span>    <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">ecx-3FA00000h</span>]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">a8</span> <span style="color:#66d9ef">b881000000</span>      <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>,<span style="color:#ae81ff">81</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">ad</span> <span style="color:#ae81ff">23</span><span style="color:#66d9ef">c8</span>            <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">af</span> <span style="color:#ae81ff">33</span><span style="color:#66d9ef">d2</span>            <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">edx</span>,<span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">b1</span> <span style="color:#ae81ff">3</span><span style="color:#66d9ef">bc8</span>            <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">ecx</span>,<span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">b3</span> <span style="color:#ae81ff">7508</span>            <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x95</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">bd</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">b5</span> <span style="color:#ae81ff">85</span><span style="color:#66d9ef">d2</span>            <span style="color:#66d9ef">test</span>    <span style="color:#66d9ef">edx</span>,<span style="color:#66d9ef">edx</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">b7</span> <span style="color:#ae81ff">7504</span>            <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x95</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">bd</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">b9</span> <span style="color:#ae81ff">32</span><span style="color:#66d9ef">c0</span>            <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">al</span>,<span style="color:#66d9ef">al</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">bb</span> <span style="color:#66d9ef">eb02</span>            <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">nt</span>!<span style="color:#66d9ef">MmIsAddressValid</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x97</span> (<span style="color:#ae81ff">805149</span><span style="color:#66d9ef">bf</span>)
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">bd</span> <span style="color:#66d9ef">b001</span>            <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">al</span>,<span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">bf</span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">f</span>              <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">edi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">c0</span> <span style="color:#ae81ff">5</span><span style="color:#66d9ef">e</span>              <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">esi</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">c1</span> <span style="color:#66d9ef">c9</span>              <span style="color:#66d9ef">leave</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">805149</span><span style="color:#a6e22e">c2</span> <span style="color:#66d9ef">c20400</span>          <span style="color:#66d9ef">ret</span>     <span style="color:#ae81ff">4</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>修改页属性，实现应用层读写高2G内存地址。</p>
<p>测试代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">char</span> buf[<span style="color:#ae81ff">6</span>]<span style="color:#f92672">=</span>{<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x48</span>,<span style="color:#ae81ff">0</span>};
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#f92672">*</span><span style="color:#a6e22e">GetPDE</span>(DWORD addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//return (DWORD *)(0xc0600000 + ((addr &gt;&gt; 18) &amp; 0x3ff8));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD PDPTI <span style="color:#f92672">=</span> addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>    DWORD PDI <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">21</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x000001FF</span>;
</span></span><span style="display:flex;"><span>    DWORD PTI <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x000001FF</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (DWORD <span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0xC0600000</span> <span style="color:#f92672">+</span> PDPTI <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">+</span> PDI <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD <span style="color:#f92672">*</span><span style="color:#a6e22e">GetPTE</span>(DWORD addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//return (DWORD *)(0xc0000000 + ((addr &gt;&gt; 9) &amp; 0x7ffff8));
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    DWORD PDPTI <span style="color:#f92672">=</span> addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">30</span>;
</span></span><span style="display:flex;"><span>    DWORD PDI <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">21</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x000001FF</span>;
</span></span><span style="display:flex;"><span>    DWORD PTI <span style="color:#f92672">=</span> (addr <span style="color:#f92672">&gt;&gt;</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">&amp;</span> <span style="color:#ae81ff">0x000001FF</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (DWORD <span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0xC0000000</span> <span style="color:#f92672">+</span> PDPTI <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x200000</span> <span style="color:#f92672">+</span> PDI <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x1000</span> <span style="color:#f92672">+</span> PTI <span style="color:#f92672">*</span> <span style="color:#ae81ff">8</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        pushad
</span></span><span style="display:flex;"><span>        pushfd
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">GetPDE</span>(<span style="color:#ae81ff">0x8003f048</span>) <span style="color:#f92672">|=</span><span style="color:#ae81ff">0x00000004</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">GetPTE</span>(<span style="color:#ae81ff">0x8003f048</span>) <span style="color:#f92672">|=</span><span style="color:#ae81ff">0x00000004</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">GetPTE</span>(<span style="color:#ae81ff">0x8003f048</span>) <span style="color:#f92672">&amp;=</span> <span style="color:#ae81ff">0xFFFFFEFF</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        popad
</span></span><span style="display:flex;"><span>        popfd
</span></span><span style="display:flex;"><span>        iretd
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x&#34;</span>,(DWORD)func);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span> <span style="color:#66d9ef">int</span> <span style="color:#ae81ff">0x20</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;0x8003f048 U/S,G位修改成功.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;*(PDWORD)0x8003f048 = %08x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(PDWORD)<span style="color:#ae81ff">0x8003f048</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span>(PDWORD)<span style="color:#ae81ff">0x8003f048</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;*(PDWORD)0x8003f048 = %08x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">*</span>(PDWORD)<span style="color:#ae81ff">0x8003f048</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>TLB<span class="hx-absolute -hx-mt-20" id="tlb"></span>
    <a href="#tlb" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>测试这个结构</p>
<p>代码如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">//10-10-12下的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DWORD TempFnAddress;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#a6e22e">Proc</span>()<span style="color:#75715e">//401030
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>{
</span></span><span style="display:flex;"><span>    _asm
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mov dword ptr ds:[<span style="color:#ae81ff">0xc0000000</span>],<span style="color:#ae81ff">0x1234967</span>
</span></span><span style="display:flex;"><span>        mov dword ptr ds:[<span style="color:#ae81ff">0</span>],<span style="color:#ae81ff">0x12345876</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//INVLPG dword ptr ds:[0]
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">//mov eax,cr3
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#75715e">//mov cr3,eax
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        mov dword ptr ds:[<span style="color:#ae81ff">0xc0000000</span>],<span style="color:#ae81ff">0x0234567</span>
</span></span><span style="display:flex;"><span>        mov eax,dword ptr ds:[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span>        mov TempFnAddress,eax
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        retf
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>; <span style="color:#75715e">// EIP, 废弃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>; <span style="color:#75715e">// 段选择子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	_asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]<span style="color:#75715e">//eq 8003f048 0040EC00`00081030
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,TempFnAddress);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>中断与异常<span class="hx-absolute -hx-mt-20" id="中断与异常"></span>
    <a href="#%e4%b8%ad%e6%96%ad%e4%b8%8e%e5%bc%82%e5%b8%b8" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>kd&gt; dq idtr
8003f400  804d8e00`0008f50e 804d8e00`0008f68d
8003f410  00008500`0058113e 804dee00`0008faa1
8003f420  804dee00`0008fc24 804d8e00`0008fd89
8003f430  804d8e00`0008ff0a 804e8e00`00080583
8003f440  00008500`00501198 804e8e00`00080988
8003f450  804e8e00`00080aa6 804e8e00`00080be3
8003f460  804e8e00`00080e40 804e8e00`0008113c
8003f470  804e8e00`00081867 804e8e00`00081b9c
kd&gt; dq gdtr
8003f000  00000000`00000000 00cf9b00`0000ffff
8003f010  00cf9300`0000ffff 00cffb00`0000ffff
8003f020  00cff300`0000ffff 80008b04`200020ab
8003f030  ffc093df`f0000001 7f40f3fd`f0000fff
8003f040  0000f200`0400ffff 0040ec00`00081020
8003f050  80008955`87000068 80008b55`87680068
8003f060  00009302`2f40ffff 0000920b`80003fff
8003f070  ff0092ff`700003ff 80009a40`0000ffff</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<p>师傅说这个<code>FS</code>寄存器里面有一个结构体如下：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>dt _KPCR ffdff000
</span></span><span style="display:flex;"><span>nt<span style="color:#f92672">!</span>_KPCR
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x000</span> NtTib            : _NT_TIB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x01c</span> SelfPcr          : <span style="color:#ae81ff">0xffdff000</span> _KPCR
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x020</span> Prcb             : <span style="color:#ae81ff">0xffdff120</span> _KPRCB
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x024</span> Irql             : <span style="color:#ae81ff">0x1c</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x028</span> IRR              : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x02c</span> IrrActive        : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x030</span> IDR              : <span style="color:#ae81ff">0xffff20f8</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x034</span> KdVersionBlock   : <span style="color:#ae81ff">0x80546ab8</span> Void
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x038</span> IDT              : <span style="color:#ae81ff">0x8003f400</span> _KIDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x03c</span> GDT              : <span style="color:#ae81ff">0x8003f000</span> _KGDTENTRY
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x040</span> TSS              : <span style="color:#ae81ff">0x80042000</span> _KTSS
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x044</span> MajorVersion     : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x046</span> MinorVersion     : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x048</span> SetMember        : <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x04c</span> StallScaleFactor : <span style="color:#ae81ff">0x64</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x050</span> DebugActive      : <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x051</span> Number           : <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x052</span> Spare0           : <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x053</span> SecondLevelCacheAssociativity : <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x054</span> VdmAlert         : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x058</span> KernelReserved   : [<span style="color:#ae81ff">14</span>] <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x090</span> SecondLevelCacheSize : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x094</span> HalReserved      : [<span style="color:#ae81ff">16</span>] <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d4</span> InterruptMode    : <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0d8</span> Spare1           : <span style="color:#ae81ff">0</span> <span style="color:#960050;background-color:#1e0010">&#39;&#39;</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x0dc</span> KernelReserved2  : [<span style="color:#ae81ff">17</span>] <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>   <span style="color:#f92672">+</span><span style="color:#ae81ff">0x120</span> PrcbData         : _KPRCB</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<ul>
<li>
<p>分析<code>IDT</code>表中<code>0x2</code>号中断的执行流程。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>00008500`0058113e
58 = 0101 1 000
index = 11(找gdt表的索引)
80008b55`87680068    address = 80558768
kd&gt; dd 80558768
80558768  00000028 80555700 00000010 00000000
80558778  00000000 00000000 00000000 00039000
80558788  804df780 00000000 00000000 00000000
80558798  00000000 00000000 80555700 00000000
805587a8  00000000 00000000 00000023 00000008
805587b8  00000010 00000023 00000030 00000000
805587c8  00000000 20ac0000 00000000 00000000
805587d8  80555668 00000000 00000001 0000000a
这个是个任务段，找到在TSS里面的eip，那么eip = 804df780，在反汇编窗口看一下地址</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>    <span style="color:#a6e22e">nt</span>!<span style="color:#66d9ef">KiTrap02</span>:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df780</span> <span style="color:#66d9ef">fa</span>                     <span style="color:#66d9ef">cli</span>    <span style="color:#75715e">;屏蔽可屏蔽中断
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df781</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">ff3540000000</span>         <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>]    <span style="color:#75715e">;TSS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df788</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">a13c000000</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">0000003</span><span style="color:#66d9ef">Ch</span>]    <span style="color:#75715e">;GDT
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df78e</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a685f</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ch</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span><span style="color:#66d9ef">Fh</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df791</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a485c</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">cl</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df794</span> <span style="color:#66d9ef">c1e110</span>                 <span style="color:#66d9ef">shl</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">10</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df797</span> <span style="color:#ae81ff">668</span><span style="color:#66d9ef">b485a</span>               <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">cx</span>, <span style="color:#66d9ef">word</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span><span style="color:#66d9ef">Ah</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df79b</span> <span style="color:#ae81ff">64890</span><span style="color:#66d9ef">d40000000</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">ecx</span>    <span style="color:#75715e">;改TSS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7a2</span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">c</span>                     <span style="color:#66d9ef">pushfd</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7a3</span> <span style="color:#ae81ff">812424</span><span style="color:#66d9ef">ffbfffff</span>         <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esp</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFFFBFFFh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7aa</span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">d</span>                     <span style="color:#66d9ef">popfd</span>   
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7ab</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">b0d3c000000</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7b2</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">d4158</span>                 <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">58</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7b5</span> <span style="color:#66d9ef">c6400589</span>               <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span>], <span style="color:#ae81ff">89</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7b9</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">b0424</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esp</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7bc</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7be</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7c0</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7c2</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7c4</span> <span style="color:#66d9ef">ff7050</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">50</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7c7</span> <span style="color:#66d9ef">ff7038</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">38</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7ca</span> <span style="color:#66d9ef">ff7024</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">24</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7cd</span> <span style="color:#66d9ef">ff704c</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7d0</span> <span style="color:#66d9ef">ff7020</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">20</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7d3</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7d5</span> <span style="color:#66d9ef">ff703c</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7d8</span> <span style="color:#66d9ef">ff7034</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">34</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7db</span> <span style="color:#66d9ef">ff7040</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7de</span> <span style="color:#66d9ef">ff7044</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7e1</span> <span style="color:#66d9ef">ff7058</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">58</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7e4</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">ff3500000000</span>         <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">0</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7eb</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">aff</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFFFFFFFh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7ed</span> <span style="color:#66d9ef">ff7028</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">28</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7f0</span> <span style="color:#66d9ef">ff702c</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">2</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7f3</span> <span style="color:#66d9ef">ff7030</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">30</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7f6</span> <span style="color:#66d9ef">ff7054</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">54</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7f9</span> <span style="color:#66d9ef">ff7048</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">48</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7fc</span> <span style="color:#66d9ef">ff705c</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df7ff</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df801</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df803</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df805</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df807</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df809</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df80b</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df80d</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df80f</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df811</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df813</span> <span style="color:#66d9ef">ff7020</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">20</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df816</span> <span style="color:#66d9ef">ff703c</span>                 <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df819</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bec</span>                   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebp</span>, <span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df81b</span> <span style="color:#ae81ff">33</span><span style="color:#66d9ef">db</span>                   <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df81d</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">a1d51000000</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">bl</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">51</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df824</span> <span style="color:#ae81ff">391</span><span style="color:#66d9ef">ddc875580</span>           <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">DCh</span>], <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df82a</span> <span style="color:#ae81ff">7414</span>                   <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xc0</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df840</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df82c</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">d05d8875580</span>           <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">D8h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df832</span> <span style="color:#ae81ff">50</span>                     <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df833</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df835</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bcc</span>                   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df837</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bd5</span>                   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">ebp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df839</span> <span style="color:#66d9ef">e8979f0500</span>             <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#66d9ef">KiAcquireQueuedSpinLockCheckForFreeze@8</span> (<span style="color:#ae81ff">805397</span><span style="color:#66d9ef">d5</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df83e</span> <span style="color:#66d9ef">eb24</span>                   <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xe4</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df864</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df840</span> <span style="color:#ae81ff">833</span><span style="color:#66d9ef">de087558008</span>         <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">E0h</span>], <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df847</span> <span style="color:#ae81ff">721</span><span style="color:#66d9ef">b</span>                   <span style="color:#66d9ef">jb</span>      <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xe4</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df864</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df849</span> <span style="color:#ae81ff">7517</span>                   <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xe2</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df862</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df84b</span> <span style="color:#ae81ff">803</span><span style="color:#66d9ef">d40ca558000</span>         <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">8055</span><span style="color:#66d9ef">CA40h</span>], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df852</span> <span style="color:#ae81ff">750</span><span style="color:#66d9ef">e</span>                   <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xe2</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df862</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df854</span> <span style="color:#ae81ff">803</span><span style="color:#66d9ef">d41ca558000</span>         <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">8055</span><span style="color:#66d9ef">CA41h</span>], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df85b</span> <span style="color:#ae81ff">7405</span>                   <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xe2</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df862</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df85d</span> <span style="color:#66d9ef">e8c17f0500</span>             <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KeEnterKernelDebugger@0</span> (<span style="color:#ae81ff">80537823</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df862</span> <span style="color:#66d9ef">ebfe</span>                   <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0xe2</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df862</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df864</span> <span style="color:#ae81ff">891</span><span style="color:#66d9ef">ddc875580</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">DCh</span>], <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df86a</span> <span style="color:#66d9ef">ff05e0875580</span>           <span style="color:#66d9ef">inc</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">E0h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df870</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>                   <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df872</span> <span style="color:#66d9ef">ff158c904d80</span>           <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">804</span><span style="color:#66d9ef">D908Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df878</span> <span style="color:#66d9ef">ff0de0875580</span>           <span style="color:#66d9ef">dec</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">E0h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df87e</span> <span style="color:#ae81ff">754</span><span style="color:#66d9ef">a</span>                   <span style="color:#66d9ef">jne</span>     <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x14a</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8ca</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df880</span> <span style="color:#66d9ef">c705dc875580ffffffff</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:[<span style="color:#ae81ff">805587</span><span style="color:#66d9ef">DCh</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFFFFFFFh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df88a</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">bcc</span>                   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">esp</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df88c</span> <span style="color:#66d9ef">e8933c0000</span>             <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#960050;background-color:#1e0010">@</span><span style="color:#66d9ef">KeReleaseQueuedSpinLockFromDpcLevel@4</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">e3524</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df891</span> <span style="color:#ae81ff">83</span><span style="color:#66d9ef">c408</span>                 <span style="color:#66d9ef">add</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df894</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">a140000000</span>           <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">00000040</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df89a</span> <span style="color:#ae81ff">66833858</span>               <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">word</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span>], <span style="color:#ae81ff">58</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df89e</span> <span style="color:#ae81ff">742</span><span style="color:#66d9ef">a</span>                   <span style="color:#66d9ef">je</span>      <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap02</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x14a</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8ca</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8a0</span> <span style="color:#ae81ff">81</span><span style="color:#66d9ef">c48c000000</span>           <span style="color:#66d9ef">add</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#ae81ff">8</span><span style="color:#66d9ef">Ch</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8a6</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">f0540000000</span>         <span style="color:#66d9ef">pop</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8ad</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">b0d3c000000</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8b4</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">d4128</span>                 <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">28</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8b7</span> <span style="color:#66d9ef">c640058b</span>               <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span>], <span style="color:#ae81ff">8</span><span style="color:#66d9ef">Bh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8bb</span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">c</span>                     <span style="color:#66d9ef">pushfd</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8bc</span> <span style="color:#ae81ff">810</span><span style="color:#66d9ef">c2400400000</span>         <span style="color:#66d9ef">or</span>      <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esp</span>], <span style="color:#ae81ff">4000</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8c3</span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">d</span>                     <span style="color:#66d9ef">popfd</span>   
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">df8c4</span> <span style="color:#66d9ef">cf</span>                     <span style="color:#66d9ef">iretd</span>   </span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>分析<code>IDT</code>表中<code>0x8</code>号中断的执行流程。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>kd&gt; dd 80558700
ReadVirtual: 80558700 not properly sign extended
80558700  00000000 80555700 00000010 00000000
80558710  00000000 00000000 00000000 00039000
80558720  804e0891 00000000 00000000 00000000
80558730  00000000 00000000 80555700 00000000
80558740  00000000 00000000 00000023 00000008
80558750  00000010 00000023 00000030 00000000
80558760  00000000 20ac0000 00000028 80555700
80558770  00000010 00000000 00000000 00000000
eip = 804e0891</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>    <span style="color:#a6e22e">nt</span>!<span style="color:#66d9ef">KiTrap08</span>:
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e0891</span> <span style="color:#66d9ef">fa</span>             <span style="color:#66d9ef">cli</span>    <span style="color:#75715e">;屏蔽可屏蔽中断
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e0892</span> <span style="color:#ae81ff">648</span><span style="color:#66d9ef">b0d3c000000</span> <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">3</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e0899</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">d4150</span>         <span style="color:#66d9ef">lea</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">50</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e089c</span> <span style="color:#66d9ef">c6400589</span>       <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">5</span>], <span style="color:#ae81ff">89</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08a0</span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">c</span>             <span style="color:#66d9ef">pushfd</span>  
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08a1</span> <span style="color:#ae81ff">812424</span><span style="color:#66d9ef">ffbfffff</span> <span style="color:#66d9ef">and</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">esp</span>], <span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFFFBFFFh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08a8</span> <span style="color:#ae81ff">9</span><span style="color:#66d9ef">d</span>             <span style="color:#66d9ef">popfd</span>   
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08a9</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">a13c000000</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">0000003</span><span style="color:#66d9ef">Ch</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08af</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a6857</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ch</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">57</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08b2</span> <span style="color:#ae81ff">8</span><span style="color:#66d9ef">a4854</span>         <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">cl</span>, <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">54</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08b5</span> <span style="color:#66d9ef">c1e110</span>         <span style="color:#66d9ef">shl</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">10</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08b8</span> <span style="color:#ae81ff">668</span><span style="color:#66d9ef">b4852</span>       <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">cx</span>, <span style="color:#66d9ef">word</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">52</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08bc</span> <span style="color:#ae81ff">64</span><span style="color:#66d9ef">a140000000</span>   <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">00000040</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08c2</span> <span style="color:#ae81ff">64890</span><span style="color:#66d9ef">d40000000</span> <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">fs</span>:[<span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">ecx</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08c9</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>           <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08cb</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>           <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08cd</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a00</span>           <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08cf</span> <span style="color:#ae81ff">50</span>             <span style="color:#66d9ef">push</span>    <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08d0</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a08</span>           <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">8</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08d2</span> <span style="color:#ae81ff">6</span><span style="color:#66d9ef">a7f</span>           <span style="color:#66d9ef">push</span>    <span style="color:#ae81ff">7</span><span style="color:#66d9ef">Fh</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08d4</span> <span style="color:#66d9ef">e811720500</span>     <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KeBugCheck2@24</span> (<span style="color:#ae81ff">80537</span><span style="color:#66d9ef">aea</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08d9</span> <span style="color:#66d9ef">ebee</span>           <span style="color:#66d9ef">jmp</span>     <span style="color:#66d9ef">ntkrnlmp</span>!<span style="color:#66d9ef">_KiTrap08</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0x38</span> (<span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08c9</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ffffffff</span><span style="color:#960050;background-color:#1e0010">`</span><span style="color:#ae81ff">804</span><span style="color:#66d9ef">e08db</span> <span style="color:#ae81ff">90</span>             <span style="color:#66d9ef">nop</span>     </span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>阶段测试<span class="hx-absolute -hx-mt-20" id="阶段测试"></span>
    <a href="#%e9%98%b6%e6%ae%b5%e6%b5%8b%e8%af%95" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>给定一个线性地址，和长度，读取内容；</p>
<p><code>int ReadMemory(OUT BYTE* buffer，IN DWORD dwAddr，IN DWORD dwLeght)</code></p>
<p>要求：</p>
<ol>
<li>可以自己指定分页方式。</li>
<li>页不存在，要提示，不能报错。</li>
<li>可以正确读取数据。</li>
</ol>
</li>
<li>
<p>申请长度为<code>100</code>的<code>DWORD</code>的数组，且每项用该项的地址初始化；</p>
<p>把这个数组所在的物理页挂到<code>0x1000</code>的地址上；定义一个指针，指向<code>0x1000</code>这个页里的数组所在的地址，用<code>0x1000</code>这个页的线性地址打印出这数组的值；</p>
<p>要求：数组所在的物理页，是同一个页</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span><span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;stdio.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>DWORD<span style="color:#f92672">*</span> arr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD<span style="color:#f92672">*</span> <span style="color:#a6e22e">GetPDE</span>(DWORD addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (DWORD<span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0xc0600000</span><span style="color:#f92672">+</span>((addr<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">18</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x3ff8</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>DWORD<span style="color:#f92672">*</span> <span style="color:#a6e22e">GetPTE</span>(DWORD addr)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> (DWORD<span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0xc0000000</span><span style="color:#f92672">+</span>((addr<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">9</span>)<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x7ffff8</span>));
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">func</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        pushad
</span></span><span style="display:flex;"><span>        pushfd
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">GetPTE</span>(<span style="color:#ae81ff">0x1000</span>)<span style="color:#f92672">|=*</span><span style="color:#a6e22e">GetPTE</span>((DWORD)arr);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        popfd
</span></span><span style="display:flex;"><span>        popad
</span></span><span style="display:flex;"><span>        iretd
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(<span style="color:#66d9ef">int</span> argc, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> argv[])
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">long</span><span style="color:#f92672">*</span> p;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> buff[<span style="color:#ae81ff">6</span>];
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">0</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x12345678</span>; <span style="color:#75715e">// EIP, 废弃
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#f92672">*</span>(WORD<span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>buff[<span style="color:#ae81ff">4</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x48</span>; <span style="color:#75715e">// 段选择子
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    arr<span style="color:#f92672">=</span>(DWORD<span style="color:#f92672">*</span>)<span style="color:#a6e22e">VirtualAlloc</span>(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0x1000</span>,MEM_COMMIT,PAGE_READWRITE);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (arr <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;Memory allocation failed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">100</span>;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        arr[i]<span style="color:#f92672">=</span>(DWORD)(arr);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;eq 8003f500 %04xee00`0008%04x&#34;</span>,(DWORD)func<span style="color:#f92672">&gt;&gt;</span><span style="color:#ae81ff">16</span>,(DWORD)func<span style="color:#f92672">&amp;</span><span style="color:#ae81ff">0x0000ffff</span>);<span style="color:#75715e">//调用门描述符为：0000EC00`00080000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//__asm int 0x20
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	_asm {
</span></span><span style="display:flex;"><span>		call far fword ptr[buff]
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">=</span>(DWORD<span style="color:#f92672">*</span>)(<span style="color:#ae81ff">0x1000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//printf(&#34;%x\n&#34;,p);
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span>(i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">100</span>;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">printf</span>(<span style="color:#e6db74">&#34;%x:%x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,i,p[i]);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">getchar</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h3>驱动<span class="hx-absolute -hx-mt-20" id="驱动"></span>
    <a href="#%e9%a9%b1%e5%8a%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h4>01<span class="hx-absolute -hx-mt-20" id="01"></span>
    <a href="#01" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>申请一块内存，并在内存中存储<code>GDT</code>，<code>IDT</code>的所有数据。然后在<code>debugview</code>中显示出来，最后释放内存。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ntddk.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//卸载函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">DriverUnload</span>(PDRIVER_OBJECT driver)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;驱动程序停止运行了</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//入口函数，相当于main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NTSTATUS <span style="color:#a6e22e">DriverEntry</span>(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//驱动程序入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//内核开辟空间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PULONG AddrTemp <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	ULONG StartAddr <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x8003F000</span>;
</span></span><span style="display:flex;"><span>	ULONG i<span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	PULONG Addr <span style="color:#f92672">=</span> (PULONG)<span style="color:#a6e22e">ExAllocatePool</span>(NonPagedPool,<span style="color:#ae81ff">0x10000</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//初始化
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RtlFillMemory</span>(Addr,<span style="color:#ae81ff">0x10000</span>,<span style="color:#ae81ff">0</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//从GDT和IDT拷贝数据
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#75715e">//GDT 0x8003F000 0x3FF 0x8003F000 0x7FF
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">RtlMoveMemory</span>(Addr,(CONST VOID UNALIGNED<span style="color:#f92672">*</span>)StartAddr,<span style="color:#ae81ff">0xBFE</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	AddrTemp <span style="color:#f92672">=</span> (PULONG)Addr;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x40</span>;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;%08X  %08X %08X %08X %08X&#34;</span>,StartAddr,<span style="color:#f92672">*</span>(AddrTemp<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>),<span style="color:#f92672">*</span>AddrTemp,<span style="color:#f92672">*</span>(AddrTemp<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>),<span style="color:#f92672">*</span>(AddrTemp<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>));	
</span></span><span style="display:flex;"><span>		AddrTemp<span style="color:#f92672">+=</span><span style="color:#ae81ff">4</span>; <span style="color:#75715e">//为什么1和3在前面? 为了和windbg显示一样，换了一下次序
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		StartAddr<span style="color:#f92672">+=</span><span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;GDT表打印完毕&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> (i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>;i<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">0x80</span>;i<span style="color:#f92672">++</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;%08X  %08X %08X %08X %08X&#34;</span>,StartAddr,<span style="color:#f92672">*</span>(AddrTemp<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>),<span style="color:#f92672">*</span>AddrTemp,<span style="color:#f92672">*</span>(AddrTemp<span style="color:#f92672">+</span><span style="color:#ae81ff">3</span>),<span style="color:#f92672">*</span>(AddrTemp<span style="color:#f92672">+</span><span style="color:#ae81ff">2</span>));
</span></span><span style="display:flex;"><span>		AddrTemp<span style="color:#f92672">+=</span><span style="color:#ae81ff">4</span>;
</span></span><span style="display:flex;"><span>		StartAddr<span style="color:#f92672">+=</span><span style="color:#ae81ff">0x10</span>;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;IDT表打印完毕&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//free释放
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ExFreePool</span>(Addr);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//设置一个卸载函数，便于退出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	driver<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> DriverUnload;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>编写代码，实现如下功能：</p>
<ol>
<li>初始化一个字符串</li>
<li>拷贝一个字符串</li>
<li>比较两个字符串是否相等</li>
<li><code>ANSI_STRING</code>与<code>UNICODE_STRING</code>字符串相互转换</li>
</ol>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ntddk.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//卸载函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">DriverUnload</span>(PDRIVER_OBJECT driver)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;驱动程序停止运行了&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//入口函数，相当于main
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NTSTATUS <span style="color:#a6e22e">DriverEntry</span>(PDRIVER_OBJECT driver, PUNICODE_STRING reg_path)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	ANSI_STRING ANString1;
</span></span><span style="display:flex;"><span>	ANSI_STRING ANString2;
</span></span><span style="display:flex;"><span>	UNICODE_STRING StrUnicode;
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RtlInitAnsiString</span>(<span style="color:#f92672">&amp;</span>ANString1,<span style="color:#e6db74">&#34;ANString1&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RtlInitAnsiString</span>(<span style="color:#f92672">&amp;</span>ANString2,<span style="color:#e6db74">&#34;ANString2&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RtlInitUnicodeString</span>(<span style="color:#f92672">&amp;</span>StrUnicode,<span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;StrUnicode&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString1 = %Z</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>ANString1);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString2 = %Z</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>ANString2);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;StrUnicode = %wZ</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>StrUnicode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">RtlCompareString</span>(<span style="color:#f92672">&amp;</span>ANString1,<span style="color:#f92672">&amp;</span>ANString2,TRUE) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString1 = ANString2&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;字符串不相等.</span><span style="color:#ae81ff">\r\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RtlCopyString</span>(<span style="color:#f92672">&amp;</span>ANString2,<span style="color:#f92672">&amp;</span>ANString1);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString1 = %Z</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>ANString1);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString2 = %Z</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>ANString2);
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;StrUnicode = %wZ</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>StrUnicode);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">RtlAnsiStringToUnicodeString</span>(<span style="color:#f92672">&amp;</span>StrUnicode,<span style="color:#f92672">&amp;</span>ANString1,TRUE) <span style="color:#f92672">==</span> STATUS_SUCCESS)
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString1 = %Z</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>ANString1);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;ANString2 = %Z</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>ANString2);
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;StrUnicode = %wZ</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>,<span style="color:#f92672">&amp;</span>StrUnicode);
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	driver<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> DriverUnload;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h4>02<span class="hx-absolute -hx-mt-20" id="02"></span>
    <a href="#02" class="subheading-anchor" aria-label="Permalink for this section"></a></h4><ul>
<li>
<p>遍历内核模块，输出模块名称，基址以及大小。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ntddk.h&gt;    //驱动程序必备头文件</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">UnloadDriver</span>(PDRIVER_OBJECT DriverObject)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;Unloaded Successfully!&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">DriverEntry</span>(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LIST_ENTRY<span style="color:#f92672">*</span> list <span style="color:#f92672">=</span> (LIST_ENTRY<span style="color:#f92672">*</span>)DriverObject<span style="color:#f92672">-&gt;</span>DriverSection;
</span></span><span style="display:flex;"><span>    LIST_ENTRY<span style="color:#f92672">*</span> item <span style="color:#f92672">=</span> list;
</span></span><span style="display:flex;"><span>    DRIVER_OBJECT obj;
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        PUNICODE_STRING name <span style="color:#f92672">=</span> (PUNICODE_STRING)(((UINT32)item) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2c</span>);
</span></span><span style="display:flex;"><span>        UINT32 DllBase <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(UINT32<span style="color:#f92672">*</span>)(((UINT32)item) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>);
</span></span><span style="display:flex;"><span>        UINT32 ImgSize<span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(UINT32<span style="color:#f92672">*</span>)(((UINT32)item) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;DriverName : %wZ</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">DllBase : %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">ImgSize : %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">======</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, name, DllBase, ImgSize);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        item <span style="color:#f92672">=</span> item<span style="color:#f92672">-&gt;</span>Blink;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (item <span style="color:#f92672">==</span> list)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DriverObject<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> UnloadDriver;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>编写一个函数，通过特征码搜索一个未导出的函数，并调用。</p>
<p>例子:找到<code>PspTerminateProcess</code>，通过调用这个函数结束记事本进程。（注意<code>10-10-12</code>分页是<code>ntoskrnl.exe</code>，<code>2-9-9-12</code>是<code>ntkrnlpa.exe</code>）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ntddk.h&gt;    //驱动程序必备头文件</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;wdm.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">UnloadDriver</span>(PDRIVER_OBJECT DriverObject)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">DbgPrint</span>(<span style="color:#e6db74">&#34;Unloaded Successfully!&#34;</span>);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>PVOID <span style="color:#a6e22e">Search</span>( PVOID featureCode,  UINT32 featureCodeeLen,  PVOID BeginAddress,  PVOID EndAddress)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     PVOID pCur <span style="color:#f92672">=</span> BeginAddress;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">while</span> (pCur <span style="color:#f92672">!=</span> EndAddress)
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">RtlCompareMemory</span>(featureCode, pCur, featureCodeeLen) <span style="color:#f92672">==</span> featureCodeeLen)
</span></span><span style="display:flex;"><span>         {
</span></span><span style="display:flex;"><span>             <span style="color:#75715e">// 指向函数首地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>             <span style="color:#66d9ef">return</span> ( PUINT32 )(( UINT32 )pCur <span style="color:#f92672">-</span> <span style="color:#ae81ff">6</span>);
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>		 (<span style="color:#f92672">*</span>(UINT32<span style="color:#f92672">*</span>)pCur)<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">NTSTATUS</span>(<span style="color:#f92672">*</span>_PspTerminateProcess)(PEPROCESS pEprocess, NTSTATUS ExitCode);
</span></span><span style="display:flex;"><span>_PspTerminateProcess PspTerminateProcess;
</span></span><span style="display:flex;"><span>PEPROCESS <span style="color:#a6e22e">GetPROCESS</span>( PCHAR processName)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>     PEPROCESS pEprocess, pCurProcess;
</span></span><span style="display:flex;"><span>     PCHAR ImageFileName;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// 获取当前进程的EPROCESS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         mov eax, fs: [<span style="color:#ae81ff">0x124</span>] ;       <span style="color:#75715e">// 获取指向 _KTHREAD 的指针
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         mov eax, [eax <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x44</span>];       <span style="color:#75715e">// 获取指向 _KPROCESS 的指针， 即EPROCESS 的首地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         mov pEprocess, eax;
</span></span><span style="display:flex;"><span>     }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     pCurProcess <span style="color:#f92672">=</span> pEprocess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#75715e">// 遍历EPROCESS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>     <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>     {
</span></span><span style="display:flex;"><span>         ImageFileName <span style="color:#f92672">=</span> ( PCHAR )pCurProcess <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x174</span>;      <span style="color:#75715e">// 进程名
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>         <span style="color:#66d9ef">if</span> ( <span style="color:#a6e22e">strcmp</span> (ImageFileName, processName) <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>         {   
</span></span><span style="display:flex;"><span>             <span style="color:#66d9ef">return</span> pCurProcess;
</span></span><span style="display:flex;"><span>         }
</span></span><span style="display:flex;"><span>         pCurProcess <span style="color:#f92672">=</span> (PEPROCESS)(<span style="color:#f92672">*</span>( PULONG )(( ULONG )pCurProcess <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x88</span>) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x88</span>);   <span style="color:#75715e">// 更新进程
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>     }  <span style="color:#66d9ef">while</span> (pEprocess <span style="color:#f92672">!=</span> pCurProcess);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">DriverEntry</span>(PDRIVER_OBJECT DriverObject, PUNICODE_STRING RegistryPath)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    LIST_ENTRY<span style="color:#f92672">*</span> lethis <span style="color:#f92672">=</span> (LIST_ENTRY<span style="color:#f92672">*</span>)DriverObject<span style="color:#f92672">-&gt;</span>DriverSection;
</span></span><span style="display:flex;"><span>    LIST_ENTRY<span style="color:#f92672">*</span> item <span style="color:#f92672">=</span> lethis;
</span></span><span style="display:flex;"><span>	UINT32 DllBase <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	UINT32 ImgSize <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>	UNICODE_STRING krnl;
</span></span><span style="display:flex;"><span>	PEPROCESS Extprocess;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">RtlInitUnicodeString</span>(<span style="color:#f92672">&amp;</span>krnl, <span style="color:#e6db74">L</span><span style="color:#e6db74">&#34;ntoskrnl.exe&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">while</span> (<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        PUNICODE_STRING name <span style="color:#f92672">=</span> (PUNICODE_STRING)(((UINT32)item) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x2c</span>);
</span></span><span style="display:flex;"><span>        UINT32 ImgSize<span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(UINT32<span style="color:#f92672">*</span>)(((UINT32)item) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span><span style="color:#a6e22e">RtlCompareUnicodeString</span>(name,<span style="color:#f92672">&amp;</span>krnl,FALSE))
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>            DllBase <span style="color:#f92672">=</span> <span style="color:#f92672">*</span>(UINT32<span style="color:#f92672">*</span>)(((UINT32)item) <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x18</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        item <span style="color:#f92672">=</span> item<span style="color:#f92672">-&gt;</span>Blink;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (item <span style="color:#f92672">==</span> lethis)
</span></span><span style="display:flex;"><span>        {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">DbgPrint</span>( <span style="color:#e6db74">&#34;not found</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	Extprocess <span style="color:#f92672">=</span> <span style="color:#a6e22e">GetPROCESS</span>( <span style="color:#e6db74">&#34;notepad.exe&#34;</span> );
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">DbgPrint</span>( <span style="color:#e6db74">&#34;process：%p.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> , Extprocess);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (Extprocess <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">DbgPrint</span>( <span style="color:#e6db74">&#34;error</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>		DriverObject<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> (PDRIVER_UNLOAD)UnloadDriver;
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> (DllBase)
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        PspTerminateProcess <span style="color:#f92672">=</span> (_PspTerminateProcess)(DllBase <span style="color:#f92672">+</span> <span style="color:#ae81ff">0xF1DA4</span>);    <span style="color:#75715e">//0xF1DA4 就是偏移
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#a6e22e">PspTerminateProcess</span>(Extprocess, <span style="color:#ae81ff">0</span>); 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">DbgPrint</span>( <span style="color:#e6db74">&#34;关了</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    DriverObject<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> (PDRIVER_UNLOAD)UnloadDriver;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h3>系统调用<span class="hx-absolute -hx-mt-20" id="系统调用"></span>
    <a href="#%e7%b3%bb%e7%bb%9f%e8%b0%83%e7%94%a8" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>01<span class="hx-absolute -hx-mt-20" id="01-1"></span>
    <a href="#01-1" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>自己编写<code>WriteProcessMemory</code>函数（不使用任何<code>DLL</code>，直接调用0环函数）并在代码中使用。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#66d9ef">__stdcall</span> WriteProcMemmmm(DWORD handle,DWORD addr,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer,DWORD len,DWORD sizewrite)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _asm
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mov eax, <span style="color:#ae81ff">115</span>h ;
</span></span><span style="display:flex;"><span>        mov edx, <span style="color:#ae81ff">7FF</span>E0300h;
</span></span><span style="display:flex;"><span>        call dword ptr [edx];
</span></span><span style="display:flex;"><span>        retn <span style="color:#ae81ff">14</span>h;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h6>02<span class="hx-absolute -hx-mt-20" id="02-1"></span>
    <a href="#02-1" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>自己实现通过中断门直接调用内核函数</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span>BOOL <span style="color:#a6e22e">__declspec</span>(<span style="color:#66d9ef">naked</span>) <span style="color:#66d9ef">__stdcall</span> VirtualAllocMY(DWORD handle,DWORD addr,<span style="color:#66d9ef">unsigned</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> buffer,DWORD len,DWORD sizewrite)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    _asm
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        mov eax, <span style="color:#ae81ff">11</span>h ;
</span></span><span style="display:flex;"><span>        mov edx, <span style="color:#ae81ff">7FF</span>E0300h;
</span></span><span style="display:flex;"><span>        lea edx, [esp<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>];
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> <span style="color:#ae81ff">2</span>Eh;
</span></span><span style="display:flex;"><span>        retn;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h6>03<span class="hx-absolute -hx-mt-20" id="03"></span>
    <a href="#03" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>从<code>Kernel32.dll</code>中打开某个函数分析执行流程（怎么找到对应的内核函数，怎么找到参数，如何将参数传到0环的）</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span><span style="color:#75715e">;virtualAlloc() -&gt; VirtualAllocEx() -&gt; NtAllocateVirtualMemory()
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;-------------------Ntdll.dll------------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF50</span> <span style="color:#75715e">; __stdcall NtAllocateVirtualMemory(x, x, x, x, x, x)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF50</span>                 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">_NtAllocateVirtualMemory@24</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF50</span> <span style="color:#66d9ef">_NtAllocateVirtualMemory@24</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>   <span style="color:#75715e">; CODE XREF: RtlAllocateHeap(x,x,x)+1126↓p
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF50</span>                                         <span style="color:#75715e">; RtlpFindAndCommitPages(x,x,x,x)+93↓p ...
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF50</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, <span style="color:#ae81ff">10001</span><span style="color:#66d9ef">b</span>     <span style="color:#75715e">; NtAllocateVirtualMemory服务号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF55</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#ae81ff">7</span><span style="color:#66d9ef">FFE0300h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF5A</span>                 <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">edx</span>] <span style="color:#75715e">; 调用共享区对应的SystemCall函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF5C</span>                 <span style="color:#66d9ef">retn</span>    <span style="color:#ae81ff">18</span><span style="color:#66d9ef">h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92CF5C</span> <span style="color:#66d9ef">_NtAllocateVirtualMemory@24</span> <span style="color:#66d9ef">endp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;在windbg中我u不到，但是可以从一下看到
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">kd&gt; dd 7FFE0300
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0300  7c92e4f0 7c92e4f4 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0310  00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0320  00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0330  ff9d665a 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0340  00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0350  00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0360  00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">7ffe0370  00000000 00000000 00000000 00000000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">kd&gt; ln 7c92e4f0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Browse module
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Set bu breakpoint
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">(7c92e4f0)   ntdll!KiFastSystemCall   |  (7c92e4f4)   ntdll!KiFastSystemCallRet
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">Exact matches:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">    ntdll!KiFastSystemCall (_KiFastSystemCall@0)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F0</span>                 <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">_KiFastSystemCall@0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F0</span> <span style="color:#66d9ef">_KiFastSystemCall@0</span> <span style="color:#66d9ef">proc</span> <span style="color:#66d9ef">near</span>           <span style="color:#75715e">; DATA XREF: .text:off_7C923428↑o
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edx</span>, <span style="color:#66d9ef">esp</span>     <span style="color:#75715e">;保存esp
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F2</span>                 <span style="color:#66d9ef">sysenter</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">7</span><span style="color:#a6e22e">C92E4F2</span> <span style="color:#66d9ef">_KiFastSystemCall@0</span> <span style="color:#66d9ef">endp</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;-------------------------------ntoskrnl.exe------------------------------
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;KiFastCallEntry
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;找到对应的内核函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">A1</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">10000</span><span style="color:#66d9ef">b</span>     <span style="color:#75715e">; 比较之前的那个第12位是否是1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">A4</span>                 <span style="color:#66d9ef">jnz</span>     <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_4077C0</span> <span style="color:#75715e">; 查找第一个系统服务表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">A6</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF018h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">AC</span>                 <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">ebx</span>, <span style="color:#66d9ef">ebx</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C0</span>                 <span style="color:#66d9ef">inc</span>     <span style="color:#66d9ef">dword</span> <span style="color:#66d9ef">ptr</span> <span style="color:#66d9ef">ds</span>:<span style="color:#ae81ff">0</span><span style="color:#66d9ef">FFDFF638h</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C6</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">esi</span>, <span style="color:#66d9ef">edx</span>        <span style="color:#75715e">; esi = edx（三环参数的指针（lea edx, [esp+arg_4]））
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">C8</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">0</span><span style="color:#66d9ef">Ch</span>]  <span style="color:#75715e">; ebx = _SYSTEM_SERVICE_TABLE.ArgmentTable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">CB</span>                 <span style="color:#66d9ef">xor</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#66d9ef">ecx</span>        <span style="color:#75715e">; 清空ecx
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">CD</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">cl</span>, [<span style="color:#66d9ef">eax</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">ebx</span>]   <span style="color:#75715e">; cl = 这个系统调用对应的参数的字节大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D0</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, [<span style="color:#66d9ef">edi</span>]      <span style="color:#75715e">; edi = _SYSTEM_SERVICE_TABLE.ServiecTable（函数地址表）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D2</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ebx</span>, [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#66d9ef">eax</span>*<span style="color:#ae81ff">4</span>] <span style="color:#75715e">; ebx = 0环函数的地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">;找到参数,并将参数传到0环的
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D5</span>                 <span style="color:#66d9ef">sub</span>     <span style="color:#66d9ef">esp</span>, <span style="color:#66d9ef">ecx</span>        <span style="color:#75715e">; 提升对应的参数个数个堆栈（这里的ecx是要执行的参数的字节大小）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">D7</span>                 <span style="color:#66d9ef">shr</span>     <span style="color:#66d9ef">ecx</span>, <span style="color:#ae81ff">2</span>          <span style="color:#75715e">; 参数长度/4 = 参数个数（四字节），一次拷贝4字节，这是拷贝的次数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">DA</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">edi</span>, <span style="color:#66d9ef">esp</span>        <span style="color:#75715e">; edi指向函数参数的位置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">E8</span>                 <span style="color:#66d9ef">rep</span> <span style="color:#66d9ef">movsd</span>               <span style="color:#75715e">; 循环拷贝
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">004077</span><span style="color:#a6e22e">EA</span>                 <span style="color:#66d9ef">call</span>    <span style="color:#66d9ef">ebx</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
</ul>
<h6>04<span class="hx-absolute -hx-mt-20" id="04"></span>
    <a href="#04" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>写代码保护指定进程（比如记事本），防止别人关闭它，而自己关闭正常退出</li>
</ul>
<p>模板：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ntddk.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;ntstatus.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 类型声明                                                             */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 系统服务表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_KSYSTEM_SERVICE_TABLE</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PULONG ServiceTableBase;			<span style="color:#75715e">// 函数地址表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PULONG ServiceCounterTableBase;		<span style="color:#75715e">// SSDT 函数被调用的次数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	ULONG NumberOfService;				<span style="color:#75715e">// 函数个数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	PULONG ParamTableBase;				<span style="color:#75715e">// 函数参数表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>} KSYSTEM_SERVICE_TABLE, <span style="color:#f92672">*</span>PKSYSTEM_SERVICE_TABLE;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SSDT表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">_KSERVICE_TABLE_DESCRIPTOR</span>
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	KSYSTEM_SERVICE_TABLE ntoskrnl;		<span style="color:#75715e">// 内核函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	KSYSTEM_SERVICE_TABLE win32k;		<span style="color:#75715e">// win32k.sys 函数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	KSYSTEM_SERVICE_TABLE unUsed1;
</span></span><span style="display:flex;"><span>	KSYSTEM_SERVICE_TABLE unUsed2;
</span></span><span style="display:flex;"><span>} KSERVICE_TABLE_DESCRIPTOR, <span style="color:#f92672">*</span>PKSERVICE_TABLE_DESCRIPTOR;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// NTOPENPROCESS
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">typedef</span> <span style="color:#a6e22e">NTSTATUS</span> (<span style="color:#f92672">*</span>NTOPENPROCESS) (PHANDLE ProcessHandle, ACCESS_MASK DesiredAccess, POBJECT_ATTRIBUTES ObjectAttributes, PCLIENT_ID ClientId);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 函数声明                                                             */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">DriverUnload</span>(PDRIVER_OBJECT pDriver);
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">DriverEntry</span>(PDRIVER_OBJECT pDriver, PUNICODE_STRING reg_path);
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">PageProtectOff</span>();
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">PageProtectOn</span>();
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">HookNtOpenProcess</span>();
</span></span><span style="display:flex;"><span>VOID <span style="color:#a6e22e">UnHookNtOpenProcess</span>();
</span></span><span style="display:flex;"><span>NTSTATUS <span style="color:#a6e22e">HbgNtOpenProcess</span>(PHANDLE  ProcessHandle, ACCESS_MASK  DesiredAccess, POBJECT_ATTRIBUTES  ObjectAttributes, PCLIENT_ID  ClientId);
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 全局变量                                                             */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">extern</span> PKSERVICE_TABLE_DESCRIPTOR KeServiceDescriptorTable; <span style="color:#75715e">// ntoskrnl.exe 导出的全局变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>ULONG uOldNtOpenProcess; <span style="color:#75715e">// 旧的函数地址
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> 
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* 函数定义                                                             */</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/************************************************************************/</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 驱动入口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NTSTATUS <span style="color:#a6e22e">DriverEntry</span>(PDRIVER_OBJECT pDriver, PUNICODE_STRING reg_path)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// HOOK
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	HookNtOpenProcess();
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	pDriver<span style="color:#f92672">-&gt;</span>DriverUnload <span style="color:#f92672">=</span> DriverUnload;
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> STATUS_SUCCESS;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 卸载驱动
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">DriverUnload</span>(PDRIVER_OBJECT pDriver)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	UnHookNtOpenProcess();
</span></span><span style="display:flex;"><span>	DbgPrint(<span style="color:#e6db74">&#34;Driver unloaded.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 关闭页保护
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">PageProtectOff</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		cli; <span style="color:#75715e">// 关闭中断
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		mov eax, cr0;
</span></span><span style="display:flex;"><span>		and eax, not <span style="color:#ae81ff">0x10000</span>; <span style="color:#75715e">// WP位置0
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		mov cr0, eax;
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 开启页保护
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">PageProtectOn</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">__asm</span>
</span></span><span style="display:flex;"><span>	{
</span></span><span style="display:flex;"><span>		mov eax, cr0;
</span></span><span style="display:flex;"><span>		or eax, <span style="color:#ae81ff">0x10000</span>; <span style="color:#75715e">// WP位置1
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		mov cr0, eax;
</span></span><span style="display:flex;"><span>		sti; <span style="color:#75715e">// 恢复中断
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// HOOK NtOpenProcess
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">HookNtOpenProcess</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PageProtectOff();
</span></span><span style="display:flex;"><span>	uOldNtOpenProcess <span style="color:#f92672">=</span> KeServiceDescriptorTable<span style="color:#f92672">-&gt;</span>ntoskrnl.ServiceTableBase[<span style="color:#ae81ff">0x7A</span>];
</span></span><span style="display:flex;"><span>	KeServiceDescriptorTable<span style="color:#f92672">-&gt;</span>ntoskrnl.ServiceTableBase[<span style="color:#ae81ff">0x7A</span>] <span style="color:#f92672">=</span> (ULONG)HbgNtOpenProcess;
</span></span><span style="display:flex;"><span>	PageProtectOn();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// UnHOOK NtOpenProcess
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>VOID <span style="color:#a6e22e">UnHookNtOpenProcess</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	PageProtectOff();
</span></span><span style="display:flex;"><span>	KeServiceDescriptorTable<span style="color:#f92672">-&gt;</span>ntoskrnl.ServiceTableBase[<span style="color:#ae81ff">0x7A</span>] <span style="color:#f92672">=</span> uOldNtOpenProcess;
</span></span><span style="display:flex;"><span>	PageProtectOn();
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 被修改的 NtOpenProcess 函数，简单打印参数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>NTSTATUS <span style="color:#a6e22e">HbgNtOpenProcess</span>(PHANDLE  ProcessHandle, ACCESS_MASK  DesiredAccess, POBJECT_ATTRIBUTES  ObjectAttributes, PCLIENT_ID  ClientId)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>	DbgPrint(<span style="color:#e6db74">&#34;%x %x %x %x</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ProcessHandle, DesiredAccess, ObjectAttributes, ClientId);
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> ((NTOPENPROCESS)uOldNtOpenProcess)(ProcessHandle, DesiredAccess, ObjectAttributes, ClientId);
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span> 
</span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
<h3>进程与线程<span class="hx-absolute -hx-mt-20" id="进程与线程"></span>
    <a href="#%e8%bf%9b%e7%a8%8b%e4%b8%8e%e7%ba%bf%e7%a8%8b" class="subheading-anchor" aria-label="Permalink for this section"></a></h3><h6>01<span class="hx-absolute -hx-mt-20" id="01-2"></span>
    <a href="#01-2" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>断链进程结构体，实现隐藏，并思考为什么断链进程为什么还能够执行。</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><pre><code>Failed to get VadRoot
PROCESS 89512978  SessionId: 0  Cid: 0684    Peb: 7ffd5000  ParentCid: 0580
    DirBase: 10240220  ObjectTable: e1778238  HandleCount:  85.
    Image: ctfmon.exe

Failed to get VadRoot
PROCESS 8944d640  SessionId: 0  Cid: 0710    Peb: 7ffdb000  ParentCid: 0580
    DirBase: 10240260  ObjectTable: e26f6560  HandleCount:  50.
    Image: notepad.exe

Failed to get VadRoot
PROCESS 897d36e8  SessionId: 0  Cid: 07a8    Peb: 7ffdb000  ParentCid: 0298
    DirBase: 102401a0  ObjectTable: e22ba310  HandleCount:  60.
    Image: VGAuthService.exe</code></pre></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>使用<code>DebugPort</code>清零实现反调试。</p>
</li>
</ul>
<h6>05<span class="hx-absolute -hx-mt-20" id="05"></span>
    <a href="#05" class="subheading-anchor" aria-label="Permalink for this section"></a></h6><ul>
<li>
<p>分析<code>KiSwapContext</code>函数：</p>
<ol>
<li>
<p><code>SwapContext</code>有几个参数，分别是什么？</p>
<p>三个，<code>int *a1@&lt;ebx&gt;, int a2@&lt;edi&gt;, int a3@&lt;esi&gt;</code></p>
</li>
<li>
<p><code>SwapContext</code>在哪里实现了线程切换？</p>
<p>切换<code>esp</code>就是切换线程了：</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040498</span><span style="color:#a6e22e">F</span> <span style="color:#66d9ef">loc_40498F</span>:                             <span style="color:#75715e">; CODE XREF: SwapContext+66↑j
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>.text:<span style="color:#960050;background-color:#1e0010">0040498</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">ecx</span>, [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">40</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00404992</span>                 <span style="color:#a6e22e">mov</span>     [<span style="color:#66d9ef">ecx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">4</span>], <span style="color:#66d9ef">eax</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00404995</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">esp</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">28</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">00404998</span>                 <span style="color:#a6e22e">mov</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">20</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040499</span><span style="color:#a6e22e">B</span>                 <span style="color:#66d9ef">mov</span>     [<span style="color:#66d9ef">ebx</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">18</span><span style="color:#66d9ef">h</span>], <span style="color:#66d9ef">eax</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>线程切换的时候，会切换<code>Cr3</code>吗？切换<code>Cr3</code>的条件是什么？</p>
<div class="hextra-code-block hx-relative hx-mt-6 first:hx-mt-0 hx-group/code">

<div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-asm" data-lang="asm"><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">0040499</span><span style="color:#a6e22e">F</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">A2</span>                 <span style="color:#66d9ef">cmp</span>     <span style="color:#66d9ef">eax</span>, [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>]
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">A5</span>                 <span style="color:#66d9ef">mov</span>     <span style="color:#66d9ef">byte</span> <span style="color:#66d9ef">ptr</span> [<span style="color:#66d9ef">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">50</span><span style="color:#66d9ef">h</span>], <span style="color:#ae81ff">0</span>
</span></span><span style="display:flex;"><span>.text:<span style="color:#960050;background-color:#1e0010">004049</span><span style="color:#a6e22e">A9</span>                 <span style="color:#66d9ef">jz</span>      <span style="color:#66d9ef">short</span> <span style="color:#66d9ef">loc_4049D7</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">如果[</span><span style="color:#a6e22e">edi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>] !<span style="color:#960050;background-color:#1e0010">=</span> [<span style="color:#66d9ef">esi</span><span style="color:#960050;background-color:#1e0010">+</span><span style="color:#ae81ff">44</span><span style="color:#66d9ef">h</span>]<span style="color:#960050;background-color:#1e0010">就切换</span><span style="color:#66d9ef">cr3</span></span></span></code></pre></div></div><div class="hextra-code-copy-btn-container hx-opacity-0 hx-transition group-hover/code:hx-opacity-100 hx-flex hx-gap-1 hx-absolute hx-m-[11px] hx-right-0 hx-top-0">
  <button
    class="hextra-code-copy-btn hx-group/copybtn hx-transition-all active:hx-opacity-50 hx-bg-primary-700/5 hx-border hx-border-black/5 hx-text-gray-600 hover:hx-text-gray-900 hx-rounded-md hx-p-1.5 dark:hx-bg-primary-300/10 dark:hx-border-white/10 dark:hx-text-gray-400 dark:hover:hx-text-gray-50"
    title="Copy code"
  >
    <div class="copy-icon group-[.copied]/copybtn:hx-hidden hx-pointer-events-none hx-h-4 hx-w-4"></div>
    <div class="success-icon hx-hidden group-[.copied]/copybtn:hx-block hx-pointer-events-none hx-h-4 hx-w-4"></div>
  </button>
</div>
</div>
</li>
<li>
<p>中断门提权时，<code>CPU</code>会从<code>TSS</code>得到<code>ESP0</code>和<code>SS0</code>，<code>TSS</code>中存储的一定是当前线程的<code>ESP0</code>和<code>SS0</code>吗？如何做到的？</p>
</li>
<li>
<p><code>FS:[0]</code>在3环时指向<code>TEB</code>但是线程有很多，<code>FS:[0]</code>指向的是哪个线程的<code>TEB</code>如何做到的？</p>
</li>
<li>
<p>0环的<code>ExceptionList</code>在哪里备份的?</p>
</li>
<li>
<p><code>IdleThread</code>是什么？什么时候执行？如何找到这个函数？</p>
</li>
<li>
<p>分析<code>KiFindReadyThread</code>，查看是怎样查找就绪线程的。</p>
</li>
<li>
<p>模拟线程切换与<code>Windows</code>的线程切换有哪些区别?</p>
</li>
<li>
<p>走一遍时钟中断流程，分析<code>KeUpdateRunTine</code>函数。</p>
</li>
</ol>
</li>
</ul>

        </div>
        <div class="hx-mt-16"></div>
        <div class="hx-mb-8 hx-flex hx-items-center hx-border-t hx-pt-8 dark:hx-border-neutral-800 contrast-more:hx-border-neutral-400 dark:contrast-more:hx-border-neutral-400 print:hx-hidden"><a
        href="/docs/windows/homeworkbas/"
        title="HomeworkBAS"
        class="hx-flex hx-max-w-[50%] hx-items-center hx-gap-1 hx-py-4 hx-text-base hx-font-medium hx-text-gray-600 hx-transition-colors [word-break:break-word] hover:hx-text-primary-600 dark:hx-text-gray-300 md:hx-text-lg ltr:hx-ml-auto ltr:hx-pl-4 ltr:hx-text-right rtl:hx-mr-auto rtl:hx-pr-4 rtl:hx-text-left"
      >HomeworkBAS<svg class="hx-inline hx-h-5 hx-shrink-0 rtl:-hx-rotate-180" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg></a></div>
        
      </main>
    </article>
  </div>

      <footer class="hextra-footer hx-bg-gray-100 hx-pb-[env(safe-area-inset-bottom)] dark:hx-bg-neutral-900 print:hx-bg-transparent"><div
      class="hextra-custom-footer hx-max-w-screen-xl hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400"
    ></div><div
        class="hx-max-w-screen-xl hx-mx-auto hx-flex hx-justify-center hx-py-12 hx-pl-[max(env(safe-area-inset-left),1.5rem)] hx-pr-[max(env(safe-area-inset-right),1.5rem)] hx-text-gray-600 dark:hx-text-gray-400 md:hx-justify-start"
      >
        <div class="hx-flex hx-w-full hx-flex-col hx-items-center sm:hx-items-start"><div class="hx-font-semibold"><a class="hx-flex hx-text-sm hx-items-center hx-gap-1 hx-text-current" target="_blank" rel="noopener noreferrer" title="Hextra GitHub Homepage" href="https://github.com/imfing/hextra">
    <span>Powered by Hextra<svg height=1em class="hx-inline-block ltr:hx-ml-1 rtl:hx-mr-1 hx-align-[-2.5px]" viewBox="0 0 180 180" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path fill-rule="evenodd" clip-rule="evenodd" d="m 105.50024,22.224647 c -9.59169,-5.537563 -21.40871,-5.537563 -31.000093,0 L 39.054693,42.689119 C 29.463353,48.226675 23.55484,58.460531 23.55484,69.535642 v 40.928918 c 0,11.07542 5.908513,21.3092 15.499853,26.84652 l 35.445453,20.46446 c 9.591313,5.53732 21.408404,5.53732 31.000094,0 l 35.44507,-20.46446 c 9.59131,-5.53732 15.49985,-15.7711 15.49985,-26.84652 V 69.535642 c 0,-11.075111 -5.90854,-21.308967 -15.49985,-26.846523 z M 34.112797,85.737639 c -1.384445,2.397827 -1.384445,5.352099 0,7.749927 l 24.781554,42.922974 c 1.38437,2.39783 3.942853,3.87496 6.711592,3.87496 h 49.563107 c 2.76905,0 5.3273,-1.47713 6.71144,-3.87496 l 24.78194,-42.922974 c 1.38414,-2.397828 1.38414,-5.3521 0,-7.749927 L 121.88049,42.814746 c -1.38414,-2.397828 -3.94239,-3.874964 -6.71144,-3.874964 H 65.605944 c -2.768739,0 -5.327223,1.477059 -6.711592,3.874964 z" style="stroke-width:0.774993" /></svg></span>
  </a></div></div>
      </div></footer>
    
    <script defer src="/js/main.js" integrity=""></script>
<script defer src="/lib/flexsearch/flexsearch.bundle.min.0425860527cc9968f9f049421c7a56b39327d475e2e3a8f550416be3a9134327.js" integrity="sha256-BCWGBSfMmWj58ElCHHpWs5Mn1HXi46j1UEFr46kTQyc="></script>
    <script defer src="/en.search.js" integrity=""></script>
  </body>
</html>
